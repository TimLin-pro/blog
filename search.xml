<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[ã€è¯‘ã€‘Binder å’Œ WindowToken]]></title>
      <url>https://timlin-pro.github.io/blog/2020/06/13/%E3%80%90%E8%AF%91%E3%80%91Binders-%E5%92%8C-Window%20Tokens/</url>
      <content type="html"><![CDATA[<blockquote>
<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://www.androiddesignpatterns.com/2013/07/binders-window-tokens.html" target="_blank" rel="noopener">https://www.androiddesignpatterns.com/2013/07/binders-window-tokens.html</a></p>
</blockquote>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul>
<li>Android ç³»ç»Ÿçš„æ ¸å¿ƒè®¾è®¡ç›®æ ‡ä¹‹ä¸€æ˜¯æä¾›ä¸€ä¸ªå¼€æ”¾å¹³å°ï¼Œè¿™ä¸ªå¹³å°ä¸ä¾èµ–ä¸­å¤®æœºæ„æ¥éªŒè¯åº”ç”¨ç¨‹åºæ˜¯ä¸æ˜¯çœŸåƒå®ƒä»¬å¯¹å¤–å®£ç§°çš„é‚£æ ·è¿è¡Œã€‚ ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼ŒAndroid ä½¿ç”¨åº”ç”¨ç¨‹åº<strong>æ²™ç®±</strong>ä»¥åŠ <strong>Linux è¿›ç¨‹éš”ç¦»</strong> æ¥é˜²æ­¢åº”ç”¨ç¨‹åºä»¥ä¸å—æ§åˆ¶æˆ–è€…ä¸å®‰å…¨çš„æ–¹å¼è®¿é—®ç³»ç»Ÿæˆ–å…¶ä»–åº”ç”¨ç¨‹åº ã€‚ é€‰æ‹©è¯¥ä½“ç³»ç»“æ„æ—¶è¦åŒæ—¶è€ƒè™‘å¼€å‘äººå‘˜å’Œè®¾å¤‡ç”¨æˆ·ï¼šåŒæ–¹éƒ½ä¸éœ€è¦ä¸ºæ­¤é‡‡ç”¨é¢å¤–çš„æ­¥éª¤æ¥ ä¿æŠ¤è®¾å¤‡å…å—æ¶æ„åº”ç”¨ç¨‹åºçš„ä¾µå®³ã€‚ ç³»ç»Ÿåº”è¯¥å¸®æˆ‘ä»¬è‡ªåŠ¨å¤„ç†å¥½è¿™ä¸€åˆ‡ã€‚<a id="more"></a></li>
<li>å¾ˆé•¿æ—¶é—´ä»¥æ¥ï¼Œæˆ‘ä¸€ç›´å°†è¿™ç§å®‰å…¨çœ‹æˆæ˜¯ç†æ‰€å½“ç„¶çš„ï¼Œè€Œæ²¡æœ‰å®Œå…¨äº†è§£å®ƒçš„å®é™…è¿è¡Œæ–¹å¼ã€‚ ä½†æ˜¯æœ€è¿‘æˆ‘å˜å¾—å¥½å¥‡äº†ã€‚ å“ªç§æœºåˆ¶èƒ½å¤Ÿé˜»æ­¢æˆ‘å¹²ä¸‹é¢è¿™äº›åäº‹å‘¢ã€‚ä¾‹å¦‚ï¼Œæ¬ºéª—ç³»ç»Ÿè®©å®ƒé‡Šæ”¾å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºè·å–çš„å”¤é†’é”ï¼Œæˆ–è€…æ˜¯æŠŠå¦ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„ Window ä»å±å¹•éšè—æ‰ï¼Ÿ æ›´æ™®éåœ°ï¼ŒAndroid çš„æ ¸å¿ƒç³»ç»ŸæœåŠ¡ æ˜¯æ€ä¹ˆå®ç°æ—¢é«˜æ•ˆåˆå®‰å…¨åœ°å“åº”ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºå‘å‡ºçš„è¯·æ±‚çš„ï¼Ÿ</li>
<li>è®©æˆ‘åƒæƒŠçš„æ˜¯ï¼Œå‡ ä¹æ‰€æœ‰é—®é¢˜çš„ç­”æ¡ˆéƒ½éå¸¸ç®€å•ï¼šBinderã€‚ Binders æ˜¯ Android ä½“ç³»ç»“æ„çš„åŸºçŸ³ï¼› ä»–ä»¬ä»å¼€å‘äººå‘˜é‚£é‡ŒæŠ½è±¡ IPC çš„åº•å±‚ç»†èŠ‚ï¼Œè®©åº”ç”¨ç¨‹åºå¯ä»¥å¾ˆç®€å•åœ°è·Ÿç³»ç»ŸæœåŠ¡ ä»¥åŠå…¶ä»–è¿œç¨‹æœåŠ¡ç»„ä»¶è¿›è¡Œé€šä¿¡ã€‚ ä½†æ˜¯ Binders è¿˜æœ‰è®¸å¤šå…¶ä»–å¾ˆé…·çš„ç‰¹æ€§ï¼Œå®ƒä»¬ä»¥å„ç§å·§å¦™çš„æ–¹å¼åœ¨æ•´ä¸ªç³»ç»Ÿä¸­å¾—åˆ°äº†å¹¿æ³›ä½¿ç”¨ï¼Œä½¿æ¡†æ¶èƒ½å¤Ÿæ›´å®¹æ˜“è§£å†³å®‰å…¨é—®é¢˜ã€‚ è¿™ç¯‡æ–‡ç« ä¸»è¦è¯¦ç»†ä»‹ç»å…¶ä¸­çš„ä¸€ä¸ªç‰¹éœ€ç‰¹æ€§â€”â€”Binder Tokens</li>
</ul>
<h2 id="Binder-Tokens"><a href="#Binder-Tokens" class="headerlink" title="Binder Tokens"></a>Binder Tokens</h2><ul>
<li>Binder å¯¹è±¡çš„ä¸€ä¸ªæœ‰è¶£ç‰¹æ€§æ˜¯ï¼Œæ¯ä¸ª binder å®ä¾‹åœ¨ç³»ç»Ÿä¸­<strong>æ‰€æœ‰è¿›ç¨‹ä¹‹é—´éƒ½ä¿æŒå”¯ä¸€çš„èº«ä»½</strong>ï¼Œæ— è®ºå®ƒè·¨è¶Šå¤šå°‘è¿›ç¨‹è¾¹ç•Œæˆ–åˆ°è¾¾ä½•å¤„ã€‚ è¿™ä¸ªåŠŸèƒ½æ˜¯ Binder å†…æ ¸é©±åŠ¨ç¨‹åºæä¾›çš„ï¼Œè¿™ä¸ªé©±åŠ¨ç¨‹åºåˆ†ææ¯ä¸ª Binder äº‹åŠ¡çš„å†…å®¹ï¼Œå¹¶ä¸ºå…¶çœ‹åˆ°çš„æ¯ä¸ª Binder å¯¹è±¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ 32 ä½æ•´æ•°å€¼ã€‚ ä¸ºäº†ç¡®ä¿ Java çš„==è¿ç®—ç¬¦éµå®ˆ Binder å”¯ä¸€çš„ï¼Œè·¨è¿›ç¨‹çš„å¯¹è±¡æ ‡è¯†åå®šï¼Œå¯¹ Binder çš„å¯¹è±¡å¼•ç”¨çš„å¯¹å¾…ä¸å…¶ä»–å¯¹è±¡çš„å¯¹å¾…æœ‰æ‰€ä¸åŒã€‚ å…·ä½“æ¥è¯´ï¼Œæ¯ä¸ª Binder çš„å¯¹è±¡å¼•ç”¨éƒ½è¢«åˆ†é…äº†<ul>
<li>1ã€æŒ‡å‘åŒä¸€è¿›ç¨‹ä¸­çš„ Binder å¯¹è±¡çš„è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œæˆ–è€…</li>
<li>2ã€å”¯ä¸€çš„ 32 ä½å¥æŸ„ï¼ˆç”± Binder å†…æ ¸é©±åŠ¨ç¨‹åºåˆ†é…ï¼‰ï¼Œåœ¨ä¸åŒçš„è¿‡ç¨‹ä¸­æŒ‡å‘ Binder çš„è™šæ‹Ÿå†…å­˜åœ°å€ã€‚</li>
</ul>
</li>
<li>Binder å†…æ ¸é©±åŠ¨ç¨‹åºä¼šä¸ºå…¶çœ‹åˆ°çš„æ¯ä¸ª Binder ç»´æŠ¤æœ¬åœ°åœ°å€åˆ°è¿œç¨‹ Binder å¥æŸ„çš„æ˜ å°„ï¼ˆåä¹‹äº¦ç„¶ï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸ª Binder çš„å¯¹è±¡å¼•ç”¨åˆ†é…é€‚å½“çš„å€¼ï¼Œä»¥ç¡®ä¿å³ä½¿åœ¨è¿œç¨‹è¿›ç¨‹ä¸­ï¼Œequals æ–¹æ³•çš„è¡Œä¸ºèƒ½å¤Ÿç¬¦åˆé¢„æœŸ</li>
<li>Binder æ‹¥æœ‰å”¯ä¸€å¯¹è±¡èº«ä»½ã€‚è¿™ä¸€æ¡è§„åˆ™ä½¿å¾—å®ƒä»¬å¯ä»¥ç”¨äºç‰¹æ®Šç›®çš„ï¼š<strong>ä½œä¸ºå…±äº«çš„å®‰å…¨è®¿é—®ä»¤ç‰Œã€‚</strong><ul>
<li>Binder æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œè¿™æ„å‘³ç€å¦‚æœåˆ›å»ºä¸€ä¸ª Binder å¯¹è±¡ï¼Œåˆ™æ²¡æœ‰å…¶ä»–äººå¯ä»¥åˆ›å»ºä¸å®ƒç›¸ç­‰çš„ä¸€ä¸ªå¯¹è±¡ï¼Œï¼ˆä¸–ç•Œä¸Šæ²¡æœ‰å®Œå…¨ç›¸åŒçš„ä¸¤ç‰‡å¶å­ï¼Œä¹Ÿæ²¡æœ‰å®Œå…¨ç›¸åŒçš„ä¸¤ä¸ª Binder å¯¹è±¡ï¼‰ã€‚ å› æ­¤ï¼Œapp framework å¹¿æ³›ä½¿ç”¨ Binder tokenï¼Œä»¥ç¡®ä¿åä½œè¿›ç¨‹ä¹‹é—´çš„å®‰å…¨äº¤äº’ï¼šå®¢æˆ·ç«¯å¯ä»¥åˆ›å»ºä¸€ä¸ª Binder å¯¹è±¡ä½œä¸ºè·Ÿ server è¿›ç¨‹å…±äº«çš„ä»¤ç‰Œï¼Œå¹¶ä¸” server è¿›ç¨‹å¯ä»¥ç”¨å®ƒæ¥éªŒè¯ å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè€Œä¸ä¼šè¢«å…¶ä»–äººæ¬ºéª—</li>
</ul>
</li>
</ul>
<h2 id="WindowToken"><a href="#WindowToken" class="headerlink" title="WindowToken"></a>WindowToken</h2><ul>
<li>å¦‚æœä½ ä¹‹å‰çœ‹ Android ä¸­ View ç±»çš„å®˜æ–¹æ–‡æ¡£ï¼Œä½ å¯èƒ½å¶ç„¶å‘ç°äº† getWindowToken æ–¹æ³•ï¼Œå¹¶ä¸”ä¼šå¥½å¥‡å®ƒçš„å«ä¹‰æ˜¯ä»€ä¹ˆã€‚ é¡¾åæ€ä¹‰ï¼Œwindow token æ˜¯ Binder tokens çš„ä¸€ç§ç‰¹æ®Šç±»å‹ï¼ŒWindow Manager ä½¿ç”¨å®ƒæ¥å”¯ä¸€åœ°æ ‡è¯†ç³»ç»Ÿä¸­çš„ Window ã€‚ window token å¯¹äºå®‰å…¨æ€§å¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒä»¬ä½¿æ¶æ„åº”ç”¨ç¨‹åºæ— æ³•åœ¨å…¶ä»–åº”ç”¨ç¨‹åºçš„çª—å£ä¸Šç»˜åˆ¶ã€‚ window Manager é€šè¿‡è¦æ±‚åº”ç”¨ç¨‹åºå°†å®ƒçš„ window token ä½œä¸ºæ¯ä¸ªæ·»åŠ æˆ–åˆ é™¤çª—å£çš„è¯·æ±‚çš„å‚æ•°æ¥ä¿è¯ ä¸Šè¿°é—®é¢˜ä¸ä¼šå‘ç”Ÿã€‚å¦‚æœ token ä¸åŒ¹é…ï¼Œåˆ™ window manager ä¼šæ‹’ç»è¯¥è¯·æ±‚å¹¶æŠ›å‡º BadTokenException å¼‚å¸¸ã€‚ å¦‚æœæ²¡æœ‰ window token ï¼Œåˆ™æ— æ³•æ‰§è¡Œæ­¤å¿…è¦çš„è¯†åˆ«æ­¥éª¤ï¼Œå¹¶ä¸” window manager å°†æ— æ³•ä¿æŠ¤è‡ªå·±å…å—æ¶æ„åº”ç”¨ç¨‹åºçš„æ”»å‡»</li>
<li>çœ‹åˆ°è¿™ï¼Œä½ å¯èƒ½ä¼šæƒ³çŸ¥é“ï¼Œå®é™…å¼€å‘ä¸­æœ‰å“ªäº›åœºæ™¯éœ€è¦ç”¨åˆ° window tokenã€‚ä¸‹é¢ä¸¾å‡ ä¸ªä¾‹å­ ğŸ‘‡<ul>
<li>1ã€å½“åº”ç”¨ç¨‹åºé¦–æ¬¡å¯åŠ¨æ—¶ï¼ŒAMS ä¼šåˆ›å»ºä¸€ç§ç‰¹æ®Šçš„çª—å£ä»¤ç‰Œï¼Œç§°ä¸ºåº”ç”¨ç¨‹åºçª—å£ä»¤ç‰Œï¼Œå®ƒå”¯ä¸€åœ°æ ‡è¯†åº”ç”¨ç¨‹åºçš„é¡¶çº§å®¹å™¨çª—å£ã€‚AMS å°†æ­¤ä»¤ç‰ŒåŒæ—¶æä¾›ç»™ app å’Œ WMSï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºæ¯æ¬¡è¦å‘å±å¹•æ·»åŠ æ–°çª—å£æ—¶ï¼Œéƒ½ä¼šå°† token å‘é€ç»™ WMS ã€‚ è¿™æ ·å¯ä»¥ç¡®ä¿åº”ç”¨ç¨‹åºå’Œ WMS ä¹‹é—´çš„å®‰å…¨äº¤äº’ï¼ˆè®©å®ƒæ— æ³•åœ¨å…¶ä»–åº”ç”¨ç¨‹åºä¹‹ä¸Šæ·»åŠ çª—å£ï¼‰ï¼Œå¹¶ä½¿ AMS å¯ä»¥è½»æ¾åœ°ç›´æ¥å‘ WMS å‘å‡ºè¯·æ±‚ã€‚ ä¾‹å¦‚ï¼ŒAMS å¯ä»¥è¯´â€œéšè—æ­¤ä»¤ç‰Œçš„æ‰€æœ‰çª—å£â€ï¼Œç„¶å WMS å°†èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«åº”å…³é—­çš„ä¸€ç»„çª—å£ã€‚</li>
<li>2ã€å®ç°è‡ªå·±çš„è‡ªå®šä¹‰ launcher çš„å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡è°ƒç”¨ sendWallpaperCommandï¼ˆIBinder windowTokenï¼ŒString actionï¼Œint xï¼Œint yï¼Œint zï¼ŒBundle extrasï¼‰æ–¹æ³•ä¸ä½äºå…¶åæ–¹çš„åŠ¨æ€å£çº¸çª—å£è¿›è¡Œäº¤äº’ã€‚ ä¸ºç¡®ä¿ launcher ä»¥å¤–çš„å…¶ä»–åº”ç”¨ç¨‹åºæ— æ³•ä¸åŠ¨æ€å£çº¸è¿›è¡Œäº¤äº’ï¼Œè¯¥æ¡†æ¶è¦æ±‚å¼€å‘äººå‘˜å°† window token ä½œä¸ºè¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ã€‚ å¦‚æœ window token æœªæ ‡è¯†ä½äºå¢™çº¸é¡¶éƒ¨çš„å½“å‰å‰æ™¯æ´»åŠ¨çª—å£ï¼Œåˆ™å°†å¿½ç•¥è¯¥å‘½ä»¤å¹¶æ‰“å°è­¦å‘Š</li>
<li>3ã€åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ hideSoftInputFromWindowï¼ˆIBinder windowTokenï¼Œint flagsï¼‰æ–¹æ³•æ¥è¦æ±‚ InputMethodManager éšè—è½¯é”®ç›˜ï¼Œä½†æ˜¯å¿…é¡»æä¾›çª—å£ä»¤ç‰Œä½œä¸ºè¯·æ±‚çš„ä¸€éƒ¨åˆ†ã€‚ å¦‚æœä»¤ç‰Œä¸å½“å‰æ¥å—è¾“å…¥çš„çª—å£æ‰€å±çš„çª—å£ä»¤ç‰Œä¸åŒ¹é…ï¼Œåˆ™ InputMethodManager å°†æ‹’ç»è¯¥è¯·æ±‚ã€‚ è¿™ä½¿å¾—æ¶æ„åº”ç”¨ç¨‹åºæ— æ³•å¼ºåˆ¶å…³é—­ç”±å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºæ‰“å¼€çš„è½¯é”®ç›˜</li>
<li>4ã€æ‰‹åŠ¨å°†æ–° window æ·»åŠ åˆ°å±å¹•ä¸Šçš„åº”ç”¨ç¨‹åºï¼ˆä¹Ÿå°±æ˜¯è°ƒç”¨ addView(Viewï¼ŒWindowManager.LayoutParams) æ–¹æ³•ï¼‰å¯èƒ½éœ€è¦é€šè¿‡è®¾ç½® WindowManager.LayoutParams.token å­—æ®µæ¥æŒ‡å®šå…¶åº”ç”¨ç¨‹åºçš„ window tokenã€‚ å› ä¸º getWindowManager() æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª WindowManagerï¼Œå®ƒå°†è‡ªåŠ¨ä¸ºæ‚¨è®¾ç½®ä»¤ç‰Œçš„å€¼ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æ™®é€šçš„åº”ç”¨ç¨‹åºéƒ½ä¸å¤ªå¯èƒ½ä¼šè¿™æ ·åšã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå°†æ¥åœ¨æŸä¸ªæ—¶å€™é‡åˆ°éœ€è¦ä»åå°æœåŠ¡å‘å±å¹•æ·»åŠ  panel window çš„åœºæ™¯ï¼Œéœ€è¦é€šè¿‡åº”ç”¨ç¨‹åº window token æ‰‹åŠ¨ç­¾ç½²è¯·æ±‚æ‰èƒ½å®ç°<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2></li>
</ul>
</li>
</ul>
<p>å°½ç®¡ Binder Tokens çš„å­˜åœ¨å¯¹å¼€å‘äººå‘˜æ¥è¯´å‡ ä¹æ˜¯é€æ˜çš„ï¼Œä½†æ˜¯ä¸ºäº†ä¿éšœå®‰å…¨ï¼Œ Binder Token åœ¨ç³»ç»Ÿä¸­è¢«å¹¿æ³›åº”ç”¨ã€‚ Android æ˜¯ä¸€ä¸ªå¤§è§„æ¨¡çš„åä½œè¿›ç¨‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå®ƒä¾èµ–äº Binder å¯¹è±¡åœ¨è®¾å¤‡ä¸Šæ‰€æœ‰è¿›ç¨‹ä¹‹é—´éƒ½æ˜¯å”¯ä¸€çš„ã€‚ Binder Tokens æ˜¯æ¡†æ¶ä¸­å„ç§äº¤äº’ èƒŒåçš„é©±åŠ¨åŠ›ï¼Œå¦‚æœæ²¡æœ‰å®ƒä»¬ï¼Œé‚£ä¹ˆ app è¿›ç¨‹ä¸ç³»ç»Ÿè¿›ç¨‹ä¹‹é—´çš„å®‰å…¨é€šä¿¡å°†å¾ˆéš¾å®ç°ã€‚</p>
<h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><ul>
<li>1ã€è¿™ä¸ªæ–‡æ¡£å®é™…ä¸Šæš—ç¤ºäº† Binders å¯ä»¥è¿™ä¹ˆç”¨ï¼šâ€œåªéœ€ç›´æ¥å®ä¾‹åŒ–ä¸€ä¸ªåŸå§‹çš„ Binder å¯¹è±¡ï¼Œå°±å¯ä»¥æŠŠå®ƒç”¨ä½œå¯åœ¨å„ä¸ªè¿›ç¨‹ä¹‹é—´å…±äº«çš„ä»¤ç‰Œã€‚â€<br><a href="https://developer.android.com/reference/android/os/Binder.html" target="_blank" rel="noopener">https://developer.android.com/reference/android/os/Binder.html</a></li>
<li>2ã€åœ¨ frameworks/base/services/java/com/android/server ç›®å½•ä¸‹ éšæœºé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¾ˆæœ‰å¯èƒ½ä¼šä»¥æŸç§å½¢å¼ä½¿ç”¨ Binder tokenã€‚å¦ä¸€ä¸ªå¾ˆé…·çš„ä¾‹å­æ¶‰åŠçŠ¶æ€æ ã€é€šçŸ¥ç®¡ç†å™¨å’Œç³»ç»Ÿ UIã€‚å…·ä½“è€Œè¨€ï¼ŒStatusBarManagerService ç»´æŠ¤ä¸€ä¸ª binder token åˆ° Notification çš„å…¨å±€æ˜ å°„ã€‚å½“ NotificationManagerService å‘çŠ¶æ€æ ç®¡ç†å™¨ï¼ˆ status bar managerï¼‰è¯·æ±‚å‘çŠ¶æ€æ æ·»åŠ é€šçŸ¥æ—¶ï¼ŒçŠ¶æ€æ ç®¡ç†å™¨ä¼šåˆ›å»ºä¸€ä¸ªèƒ½å¤ŸæƒŸä¸€æ ‡è¯†è¿™ä¸ª é€šçŸ¥ çš„ binder token ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™é€šçŸ¥ç®¡ç†å™¨å’Œ SystemUIã€‚ç”±äºè¿™ä¸‰ä¸ªè§’è‰²éƒ½çŸ¥é“é€šçŸ¥çš„ binder token ï¼Œå› æ­¤ä»é‚£ä¹‹åï¼Œå¯¹é€šçŸ¥çš„ä»»ä½•æ›´æ”¹(ä¾‹å¦‚é€šçŸ¥ç®¡ç†å™¨å–æ¶ˆé€šçŸ¥ï¼Œæˆ–è€… SystemUI æ£€æµ‹åˆ°ç”¨æˆ·ä»å±å¹•ä¸Šæ»‘åŠ¨äº†ä¸€ä¸ªé€šçŸ¥)éƒ½å°†é¦–å…ˆç»è¿‡ çŠ¶æ€æ ç®¡ç†å™¨ã€‚è¿™ä½¿å¾—ä¸‰ä¸ªç³»ç»ŸæœåŠ¡æ›´å®¹æ˜“ä¿æŒåŒæ­¥: çŠ¶æ€æ ç®¡ç†å™¨å¯ä»¥è´Ÿè´£é›†ä¸­æ‰€æœ‰å…³äºå½“å‰åº”è¯¥æ˜¾ç¤ºå“ªäº›é€šçŸ¥çš„ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦ SystemUI å’Œ notification manager ä¹‹é—´ç›´æ¥è¿›è¡Œäº¤äº’</li>
<li>3ã€æ‹¥æœ‰ android.permission.SYSTEM_ALERT_WINDOW æƒé™ï¼ˆåˆç§°â€œä»å…¶ä»–åº”ç”¨ä¸Šç»˜å›¾â€æƒé™ï¼‰çš„åº”ç”¨ç¨‹åºæ˜¯æ­¤è§„åˆ™çš„æ˜æ˜¾ä¾‹å¤–ã€‚ Facebook Messenger å’Œ DicePlayer æ˜¯ä¸¤ä¸ªæµè¡Œçš„åº”ç”¨ç¨‹åºï¼Œéœ€è¦æ­¤æƒé™ï¼Œå¹¶ä½¿ç”¨å®ƒåœ¨åå°æœåŠ¡çš„å…¶ä»–åº”ç”¨ç¨‹åºä¹‹ä¸Šæ·»åŠ çª—å£ã€‚Facebook Messenger å’Œ DicePlayer æ˜¯ä¸¤ä¸ªæµè¡Œçš„åº”ç”¨ç¨‹åºï¼Œéœ€è¦æ­¤æƒé™ï¼Œå¹¶ä½¿ç”¨å®ƒåœ¨åå°æœåŠ¡çš„å…¶ä»–åº”ç”¨ç¨‹åºä¹‹ä¸Šæ·»åŠ çª—å£</li>
<li>4 ã€‚ActivityManagerService æ˜¯å…¨å±€ç³»ç»ŸæœåŠ¡ï¼ˆåœ¨ System Server è¿›ç¨‹ä¸­è¿è¡Œï¼‰ï¼Œå®ƒè´Ÿè´£å¯åŠ¨ï¼ˆå’Œç®¡ç†ï¼‰æ–°ç»„ä»¶ï¼Œä¾‹å¦‚â€œActivity å’Œ Serviceâ€ã€‚ å®ƒè¿˜æ¶‰åŠ ç»´æŠ¤å†…æ ¸ä¸­ low-memory handler ä½¿ç”¨çš„ OOM è°ƒæ•´ï¼Œæƒé™ï¼Œä»»åŠ¡ç®¡ç†ç­‰</li>
<li>5ã€ä½ å¯ä»¥é€šè¿‡è°ƒç”¨ getApplicationWindowToken() æ¥è·å¾—ä¸€ä¸ªå¼•ç”¨<br><a href="https://developer.android.com/reference/android/view/View#getApplicationWindowToken(" target="_blank" rel="noopener">https://developer.android.com/reference/android/view/View#getApplicationWindowToken(</a>)</li>
<li>6ã€è¿™ä¸ªè§£é‡Šä»…ä»…è§¦åŠè¡¨é¢ã€‚æœ‰å…³ SurfaceFlingerã€WindowManager å’Œåº”ç”¨ç¨‹åºä¹‹é—´å¦‚ä½•äº¤äº’çš„æ›´è¯¦ç»†çš„è§£é‡Šï¼Œè¯·å‚é˜…æœ¬æ–‡ã€‚ã€ŒSurfaceFlinger å’Œ Hardware Composerã€ä¸€èŠ‚çš„ç¬¬ä¸‰æ®µç®€è¦åœ°æåˆ°äº†ä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„ Binder åº”ç”¨ç¨‹åº window tokenã€‚<br><a href="http://source.android.com/devices/graphics/architecture.htm" target="_blank" rel="noopener">http://source.android.com/devices/graphics/architecture.htm</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> Androidç³»ç»Ÿæœºåˆ¶ </category>
            
        </categories>
        
        
    </entry>
    
    <entry>
      <title><![CDATA[Message å¼•å‘çš„ DialogFragment å†…å­˜æ³„æ¼åˆ†æä¸è§£å†³æ–¹æ¡ˆ]]></title>
      <url>https://timlin-pro.github.io/blog/2020/06/12/Message-%E5%BC%95%E5%8F%91%E7%9A%84-DialogFragment-%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
      <content type="html"><![CDATA[<blockquote>
<p>Q:å’‹å›äº‹ï¼Ÿæ­£å¸¸ä½¿ç”¨ Dialog å’Œ DialogFragment ä¹Ÿæœ‰å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Ÿ<br>A: â€¦.æ˜¯çš„ï¼Œè¯´æ¥è¯é•¿ã€‚</p>
</blockquote>
<p>é•¿è¯çŸ­è¯´ï¼š</p>
<ol>
<li>æŸä¸€ä¸ª HandlerThread çš„ Looper#loop æ–¹æ³•ï¼Œä¸€ç›´ç­‰å¾… queue#next æ–¹æ³•è¿”å›ï¼Œä½†æ˜¯å®ƒçš„ msg å±€éƒ¨å˜é‡è¿˜å¼•ç”¨ç€ä¸Šä¸€ä¸ªå¾ªç¯ä¸­å·²ç»è¢«æ”¾åˆ° Message Pool ä¸­ Messageï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º MessageAã€‚</li>
<li>DialogFragment#onActivityCreated æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ Dialog#setOnCancelListener æ–¹æ³•ï¼Œå°†è‡ªèº«çš„å¼•ç”¨ä½œä¸º listener  å‚æ•°ä¼ é€’ç»™è¯¥æ–¹æ³•</li>
<li>Dialog#setOnCancelListener æ–¹æ³•å†…éƒ¨ï¼Œä¼šå°è¯•ä» Message Pool ä¸­è·å–ä¸€ä¸ª Messageï¼Œå–å‡ºçš„ Message åˆšå¥½æ˜¯ MessageAï¼Œç„¶åå°†ä¼ å…¥çš„ Listener å®ä¾‹èµ‹å€¼ç»™ MessageA#objã€‚</li>
<li>å¤–éƒ¨è°ƒç”¨ cancel çš„æ—¶å€™ï¼ŒDialog å†…éƒ¨ä¼šå°† MessageA <strong>æ‹·è´</strong>ä¸€ä»½ï¼Œæˆ‘ä»¬ç§°å®ƒä¸º MessageBï¼Œç„¶åå°† MessageB å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚</li>
<li>DialogFragment æ”¶åˆ° onDestory å›è°ƒä¹‹åï¼ŒLeakCanary å¼€å§‹ç›‘å¬è¿™ä¸ª DialogFragment æ˜¯å¦æ­£å¸¸è¢«å›æ”¶ï¼Œå‘ç°è¿™ä¸ªå®ä¾‹ä¸€ç›´å­˜åœ¨ï¼Œdump å†…å­˜ï¼Œåˆ†æå¼•ç”¨é“¾ï¼ŒæŠ¥å‘Šå†…å­˜æ³„æ¼é—®é¢˜ã€‚</li>
</ol>
<a id="more"></a>
<p>å…·ä½“ç»†èŠ‚ä»‹ç»è§ä¸‹æ–‡ğŸ‘‡</p>
<h2 id="1ã€é—®é¢˜"><a href="#1ã€é—®é¢˜" class="headerlink" title="1ã€é—®é¢˜"></a>1ã€é—®é¢˜</h2><p>å¼€å‘çš„æ—¶å€™ï¼Œ LeakCanary æŠ¥å‘Šäº†ä¸€ä¸ªè¯¡å¼‚çš„å†…å­˜æ³„æ¼é“¾ã€‚</p>
<p>æ“ä½œè·¯å¾„ï¼šapp æ˜¾ç¤º DialogFragment ç„¶åç‚¹å‡»å¤–éƒ¨ä½¿å…¶æ¶ˆå¤±ï¼Œä¹‹å LeakCanary å°±æŠ¥äº†å¦‚ä¸‹é—®é¢˜ï¼š<br><img src="https://raw.githubusercontent.com/TimLin1024/Graph/master/markdown/LeakCanary å†…å­˜æ³„æ¼.png" alt="LeakCanary æŠ¥å‘Šçš„å¼‚å¸¸"></p>
<p>ä»ä¸Šé¢çš„æˆªå›¾ ğŸ‘† å¯ä»¥çœ‹å‡ºï¼šGCRoot æ˜¯ HandlerThread æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•ä¸­çš„ä¸€ä¸ªå±€éƒ¨å˜é‡ã€‚è¿™ä¸ªå±€éƒ¨å˜é‡å¼ºå¼•ç”¨äº†ä¸€ä¸ª Message å¯¹è±¡ï¼Œmessage çš„ obj å­—æ®µåˆå¼ºå¼•ç”¨äº† NormalDialogFragment ï¼Œå¯¼è‡´å…¶è°ƒç”¨äº† onDestory æ–¹æ³•ä¹‹åï¼Œä¹Ÿæ— æ³•è¢«å›æ”¶ã€‚</p>
<h2 id="2ã€åˆ†æ"><a href="#2ã€åˆ†æ" class="headerlink" title="2ã€åˆ†æ"></a>2ã€åˆ†æ</h2><p>æ³¨ï¼šæœ¬æ–‡ä¸­çš„ã€ŒHandlerThreadã€æ³›æŒ‡é‚£äº›å¸¦æœ‰ Looper å¹¶ä¸”å¼€å¯äº†æ¶ˆæ¯å¾ªç¯ï¼ˆè°ƒç”¨äº† Looper#loopï¼‰çš„çº¿ç¨‹</p>
<p>DialogFragment ä¸ºå•¥ä¼šè¢«ä¸€ä¸ª Message çš„ obj å­—æ®µå¼ºå¼•ç”¨ï¼Ÿè€Œä¸”é‚£è¿˜æ˜¯ä¸€ä¸ªè¢« HandlerThread å¼•ç”¨ç€çš„ Messageã€‚</p>
<p>å›é¡¾ä¸€ä¸‹æˆ‘ä»¬æ­£å¸¸æ˜¾ç¤º DialogFragment çš„æµç¨‹ï¼š1ã€å®ä¾‹åŒ– DialogFragmentï¼Œ2ã€è°ƒç”¨ DialogFragment#show æ–¹æ³•è®©å…¶æ˜¾ç¤ºå‡ºæ¥ã€‚è¿™ä¸ªæµç¨‹ä¸­æœ‰å¯èƒ½å¯¼è‡´ Fragment è¢« Message å¼ºå¼•ç”¨å—ï¼Ÿ</p>
<ul>
<li>é¦–å…ˆçœ‹ DialogFragment çš„æ„é€ æ–¹æ³•æ˜¯ä¸€ä¸ªç©ºå®ç°ã€‚æ’é™¤ã€‚</li>
<li>å…¶æ¬¡çœ‹ DialogFragment show æ–¹æ³•é€»è¾‘å¦‚ ğŸ‘‡ï¼Œä¹Ÿæ˜¯æ­£å¸¸çš„ Fragment æ˜¾ç¤ºé€»è¾‘ã€‚æ’é™¤ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(@NonNull FragmentManager manager, @Nullable String tag)</span> </span>&#123;</div><div class="line">  mDismissed = <span class="keyword">false</span>;</div><div class="line">  mShownByMe = <span class="keyword">true</span>;</div><div class="line">  FragmentTransaction ft = manager.beginTransaction();</div><div class="line">  ft.add(<span class="keyword">this</span>, tag);</div><div class="line">  ft.commit();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>éš¾é“æ˜¯ show è¿‡ç¨‹çš„æŸä¸ªæ­¥éª¤ä¸­å»è·å–äº† Messageï¼Ÿ åœ¨ DialogFragment#onActivityCreated æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">  <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</div><div class="line">  <span class="keyword">if</span> (!mShowsDialog) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">  mDialog.setCancelable(mCancelable);</div><div class="line">  mDialog.setOnCancelListener(<span class="keyword">this</span>);<span class="comment">//è®¾ç½® cancel ç›‘å¬å™¨</span></div><div class="line">  mDialog.setOnDismissListener(<span class="keyword">this</span>);<span class="comment">//è®¾ç½® dismiss ç›‘å¬å™¨</span></div><div class="line">  <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»¥ Dialog#setOnCancelListener æ–¹æ³•ä¸ºä¾‹ ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnCancelListener</span><span class="params">(@Nullable OnCancelListener listener)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (mCancelAndDismissTaken != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">        <span class="string">"OnCancelListener is already taken by "</span></div><div class="line">        + mCancelAndDismissTaken + <span class="string">" and can not be replaced."</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="comment">//Listener ä¸ä¸º nullï¼Œå–å‡ºä¸€æ¡ messageï¼ˆä¼šå°è¯•å…ˆä» pool ä¸­è·å–ï¼Œå¦‚æœæ²¡æœ‰æ¶ˆæ¯æ‰ä¼š new ä¸€ä¸ªæ–°çš„ï¼‰  è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„ç‚¹ï¼Œåç»­ä¼šè®²åˆ°</span></div><div class="line">    mCancelMessage = mListenersHandler.obtainMessage(CANCEL, listener);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    mCancelMessage = <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒDialog#setOnCancelListener æ–¹æ³•ä¼šä»æ¶ˆæ¯æ± ä¸­è·å–ä¸€æ¡ messageï¼Œå¹¶èµ‹å€¼ç»™ Dialog çš„ mCancelMessage æˆå‘˜å˜é‡ã€‚</p>
<p>è¿™ä¸ª message ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°ï¼Ÿå½“ cancel æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ã€‚ä¸‹é¢çœ‹ä¸‹ Dialog#cancel æ–¹æ³•</p>
<p>Dialog#cancel æ–¹æ³• ğŸ‘‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!mCanceled &amp;&amp; mCancelMessage != <span class="keyword">null</span>) &#123;</div><div class="line">    mCanceled = <span class="keyword">true</span>;</div><div class="line">    <span class="comment">// Obtain a new message so this dialog can be re-used</span></div><div class="line">     <span class="comment">//å¤åˆ¶ä¸€ä»½ï¼Œç„¶åå‘é€ã€‚è¿™é‡Œä¸ºå•¥éœ€è¦å¤åˆ¶è€Œä¸æ˜¯ç”¨åŸæ¥çš„æ¶ˆæ¯ï¼Ÿçœ‹å®˜æ–¹çš„æ³¨é‡Šè¯´ï¼Œæ˜¯ä¸ºäº† Dialog èƒ½å¤Ÿè¢«å¤ç”¨ã€‚ï¼ˆæ‰€è°“ã€Œå¤ç”¨ã€åº”è¯¥æ˜¯æŒ‡ï¼ŒDialog cancel ä¹‹åï¼Œå†è°ƒç”¨ show è¿˜å¯ä»¥æ˜¾ç¤ºå‡ºæ¥, å¹¶ä¸”ä¹‹å‰è®¾ç½®çš„ç›‘å¬éƒ½è¿˜æœ‰æ•ˆï¼‰</span></div><div class="line">    Message.obtain(mCancelMessage).sendToTarget();</div><div class="line">  &#125;</div><div class="line">  dismiss();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é‡ç‚¹ ğŸ‘‡ğŸ‘‡ğŸ‘‡</p>
<blockquote>
<p><strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è°ƒç”¨ Dialog#setOnCancelListener æ–¹æ³•ä»æ¶ˆæ¯æ± è·å–åˆ°çš„ Message æœ€ç»ˆæ˜¯ä¸ä¼šè¢«å‘é€å‡ºå»çš„ã€‚å› æ­¤ Message#recycleUnchecked æ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ã€‚</strong></p>
</blockquote>
<p>ä½†æ˜¯å³ä½¿æ²¡æœ‰å‘é€å‡ºå»ï¼Œä¹Ÿåªæ˜¯ Dialog çš„ä¸€ä¸ªæˆå‘˜å˜é‡å‘€ï¼ŒDialog é”€æ¯çš„æ—¶å€™ï¼Œè¿™ä¸ª message åº”è¯¥ä¹Ÿèƒ½è¢«å›æ”¶ï¼Œä¸è‡³äºå¯¼è‡´å†…å­˜æ³„æ¼å§ï¼Ÿ</p>
<p>å†çœ‹å›å‰é¢ LeakCanary æŠ¥å‡ºæ¥çš„å¼•ç”¨é“¾ï¼ŒGCRoot æ˜¯ä¸€ä¸ª HandlerThread ä¸­çš„å±€éƒ¨å˜é‡ã€‚</p>
<p><strong>Q:å›é¡¾ä¸€ä¸‹ Android çš„æ¶ˆæ¯æœºåˆ¶ä¸­ï¼ŒMessage æ˜¯å¦‚ä½•è¢«ä½¿ç”¨çš„ï¼Ÿ</strong></p>
<p>A:æˆ‘ä»¬é€šè¿‡ Handler#postDelayed() æˆ–è€…æ˜¯ Message#sendToTarget æ–¹æ³•å‘é€çš„æ¶ˆæ¯ï¼Œæœ€ç»ˆéƒ½ä¼šè¿›å…¥åˆ° å½“å‰çº¿ç¨‹çš„ MessageQueue ä¸­ï¼Œç„¶å Looper#loop æ–¹æ³•ä¸æ–­åœ°ä»é˜Ÿåˆ—ä¸­å–å‡º Messageï¼Œæ´¾å‘æ‰§è¡Œã€‚å½“æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œå°±ä¼šä¼‘çœ ã€‚ç­‰åˆ°æœ‰æ–°çš„ message å¯ä»¥å–å‡ºçš„æ—¶å€™ï¼Œé‡æ–°å”¤é†’ã€‚</p>
<p>Looper#loop æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> Looper me = myLooper();</div><div class="line">  <span class="keyword">final</span> MessageQueue queue = me.mQueue;</div><div class="line">   <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">  <span class="keyword">for</span> (;;) &#123;</div><div class="line">    Message msg = queue.next(); <span class="comment">// might block</span></div><div class="line">    <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">    msg.target.dispatchMessage(msg);</div><div class="line">     <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">    msg.recycleUnchecked();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œmsg æ´¾å‘åˆ°ç›®æ ‡å¯¹è±¡ä¹‹åï¼Œéƒ½ä¼šè°ƒç”¨ msg.recycleUnchecked() æ–¹æ³•å®Œæˆé‡ç½®ï¼Œæ”¾å…¥æ¶ˆæ¯æ± ã€‚</p>
<p>éš¾é“<strong>æ‰§è¡Œ for å¾ªç¯ä½“ä¸­çš„ä¸€æ¬¡è¿­ä»£ä¹‹åï¼Œmsg å±€éƒ¨å˜é‡è¿˜æ˜¯æŒæœ‰ä¸Šä¸€ä¸ªè¿­ä»£ä¸­çš„ Message çš„å¼ºå¼•ç”¨ï¼Ÿ</strong></p>
<p>å¦‚æœè¿™ä¸ªå‡è®¾æˆç«‹ï¼Œé‚£ä¹ˆä¸Šé¢çš„æ³„æ¼å°±è¯´å¾—é€šäº†ã€‚</p>
<h3 id="2-1ã€-éªŒè¯"><a href="#2-1ã€-éªŒè¯" class="headerlink" title="2.1ã€ éªŒè¯"></a>2.1ã€ éªŒè¯</h3><p>å’±ä»¬å¯ä»¥å†™ä¸€æ®µç±»ä¼¼çš„ä»£ç ï¼Œç„¶åç”¨ javap å‘½ä»¤æŸ¥çœ‹å­—èŠ‚ç éªŒè¯ä¸€ä¸‹ã€‚</p>
<p>æ–°å»ºä¸€ä¸ª Test.java æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">(BlockingQueue&lt;String&gt; blockingQueue)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">      String msg = blockingQueue.take();</div><div class="line">      System.out.println(msg);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<blockquote>
<p>javac Test.java<br>javap -v Test</p>
</blockquote>
<p>loop æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç å¦‚ä¸‹ ğŸ‘‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">static void loop(java.util.concurrent.BlockingQueue&lt;java.lang.String&gt;) throws java.lang.InterruptedException;</div><div class="line"> descriptor: (Ljava/util/concurrent/BlockingQueue;)V</div><div class="line"> flags: ACC_STATIC</div><div class="line"> Code:</div><div class="line">  stack=2, locals=2, args_size=1</div><div class="line">    0: aload_0  #åŠ è½½ slot0 çš„å‚æ•°  å°†ç¬¬0ä¸ªå¼•ç”¨ç±»å‹æœ¬åœ°å˜é‡æ¨é€è‡³æ ˆé¡¶ï¼Œå› ä¸ºæ˜¯é™æ€æ–¹æ³•ï¼Œæ²¡æœ‰ thisï¼Œå› æ­¤ï¼Œæ˜¯æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯åŠ è½½ BlockingQueue</div><div class="line">    1: invokeinterface #2,  1       // InterfaceMethod java/util/concurrent/BlockingQueue.take:()Ljava/lang/Object;</div><div class="line">    6: checkcast   #3          // class java/lang/String</div><div class="line">    9: astore_1  #å°† blockingQueue.take(); æ‰§è¡Œçš„ç»“æœï¼ˆä¸€ä¸ª String ç±»å‹çš„å€¼ï¼‰å­˜åˆ°ç¬¬ä¸€ä¸ª slot</div><div class="line">   10: getstatic   #4          // Field java/lang/System.out:Ljava/io/PrintStream;</div><div class="line">   13: aload_1  #  å°†ç¬¬1ä¸ªå¼•ç”¨ç±»å‹æœ¬åœ°å˜é‡æ¨é€è‡³æ ˆé¡¶</div><div class="line">   14: invokevirtual #5          // Method java/io/PrintStream.println:(Ljava/lang/String;)V</div><div class="line">   17: goto      0  #æ— æ¡ä»¶è·³è½¬åˆ°ç¬¬ 0 è¡Œ</div><div class="line">  LineNumberTable:</div><div class="line">   line 6: 0</div><div class="line">   line 7: 10</div><div class="line">   line 8: 17</div><div class="line">  StackMapTable: number_of_entries = 1</div><div class="line">   frame_type = 0 /* same */</div><div class="line"> Exceptions:</div><div class="line">  throws java.lang.InterruptedException</div><div class="line"> Signature: #18              // (Ljava/util/concurrent/BlockingQueue&lt;Ljava/lang/String;&gt;;)V</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„å­—èŠ‚ç å¯ä»¥çœ‹å‡ºï¼Œå½“ä¸€ä¸ªè¿­ä»£æ‰§è¡Œç»“æŸä¹‹åï¼Œé¦–å…ˆä¼šè·³è½¬ä¼šå¾ªç¯ä½“çš„ç¬¬ä¸€è¡Œï¼Œä¸Šé¢çš„ä¾‹å­ä¸­å¯¹åº”çš„å°±æ˜¯ blockingQueue#take è¿™è¡Œä»£ç ã€‚æ­¤æ—¶ï¼Œå±€éƒ¨å˜é‡ä¸­çš„ slot1ï¼Œè¿˜æ˜¯æŒ‡å‘ä¸Šä¸€æ¬¡è¿­ä»£ä¸­çš„ String å˜é‡ã€‚å¦‚æœ blockingQueue ä¸­å·²ç»æ²¡æœ‰å…ƒç´ äº†ï¼Œè¿™æ—¶å°±ä¼šä¸€ç›´ç­‰å¾…ä¸‹ä¸€ä¸ªå…ƒç´ æ’å…¥ï¼Œè€Œä¸Šä¸€æ¬¡è¿­ä»£ä¸­çš„ String å˜é‡è™½ç„¶å·²ç»æ²¡æœ‰ç”¨äº†ï¼Œä½†æ˜¯å› ä¸ºè¢«å±€éƒ¨å˜é‡è¡¨å¼•ç”¨ç€ï¼Œæ— æ³•è¢« GCã€‚</p>
<p>é‡ç‚¹ ğŸ‘‡ğŸ‘‡ğŸ‘‡</p>
<blockquote>
<p>å›åˆ°æˆ‘ä»¬çš„ä¸»çº¿ï¼Œ Looper#loop æ–¹æ³•ä¸­ for å¾ªç¯ä½“ä¸­çš„ç¬¬ä¸€è¡Œï¼Œqueue.next(); æ–¹æ³•ï¼Œå½“æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿™ä¸ªè°ƒç”¨ä¼šä¸€ç›´é˜»å¡åœ¨é‚£é‡Œã€‚æ­¤æ—¶ msg æ²¡æœ‰è¢«é‡æ–°èµ‹å€¼ã€‚å› æ­¤ï¼Œloop æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ä¸­è¿˜æ˜¯æŒæœ‰å¯¹ä¸Šä¸€ä¸ªè¿­ä»£ä¸­ message å®ä¾‹çš„å¼•ç”¨ã€‚</p>
<p>è™½ç„¶ loop æ–¹æ³•ç»“å°¾æ‰§è¡Œäº† msg.recycleUnchecked(); æ–¹æ³•ï¼Œä¼šå°† message ä¸­çš„å­—æ®µéƒ½ç½®ä¸ºç©ºå€¼ï¼Œä½†æ˜¯ï¼Œä¸æ­¤åŒæ—¶ï¼Œå®ƒä¼šå°†è¿™ä¸ª message æ”¾å…¥åˆ° pool ä¸­ã€‚è¿™ä¸ªæ—¶å€™ï¼Œmessage å·²ç»å¼€å§‹ã€Œæ³„æ¼ã€äº†ã€‚</p>
<p>å†å›åˆ°å‰é¢ï¼ŒDialogFragment#onActivityCreated æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ Dialog#setOnCancelListener æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨åˆä¼šå°è¯•ä»æ¶ˆæ¯æ± ä¸­å–ä¸€ä¸ª messageã€‚å¦‚æœåˆšå¥½å–åˆ°çš„ message æ˜¯è¢«æŸä¸ª MessageQueue ä¸ºç©ºçš„ handlerThread çš„ loop æ–¹æ³• ï¼ˆå¯¹åº”çš„æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ï¼‰æ‰€å¼•ç”¨ç€çš„ï¼Œé‚£ä¹ˆ DialogFragment é”€æ¯çš„æ—¶å€™ï¼ŒLeakCanary å°±ä¼šæŠ¥å‘Šè¯´å†…å­˜æ³„æ¼äº§ç”Ÿäº†ã€‚</p>
</blockquote>
<p>é‡ç‚¹ ğŸ‘†ğŸ‘†ğŸ‘†</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/TimLin1024/Graph/master/markdown/DialogFragment%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F.png" alt="DialogFragmentå†…å­˜æ³„æ¼"></p>
<h3 id="2-2ã€å¤ç°"><a href="#2-2ã€å¤ç°" class="headerlink" title="2.2ã€å¤ç°"></a>2.2ã€å¤ç°</h3><p>Q:çœ‹ä¸Šé¢çš„æè¿°ï¼Œè¿™ä¸ªå†…å­˜æ³„æ¼è¦è§¦å‘çš„æ¡ä»¶è¿˜æ˜¯æ¯”è¾ƒä¸¥è‹›çš„ï¼Œæœ‰ä»€ä¹ˆå¤ç°è·¯å¾„å—ï¼Ÿ</p>
<p>A:å› ä¸ºè¿™ä¸ªæ³„æ¼è·Ÿ message å¤ç”¨æœ‰å¾ˆå¤§å…³ç³»ã€‚è¦å¤ç°è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆçœ‹ä¸‹æ¶ˆæ¯æ± ä¸­çš„ message message#recycleUnchecked æ–¹æ³•ä»¥åŠ Message#obtain æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">recycleUnchecked</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">  <span class="keyword">synchronized</span> (sPoolSync) &#123;</div><div class="line">    <span class="keyword">if</span> (sPoolSize &lt; MAX_POOL_SIZE) &#123;</div><div class="line">      next = sPool;</div><div class="line">      <span class="comment">//ç›¸å½“äºæ’å…¥é˜Ÿå¤´</span></div><div class="line">      sPool = <span class="keyword">this</span>;</div><div class="line">      sPoolSize++;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title">obtain</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">synchronized</span> (sPoolSync) &#123;</div><div class="line">    <span class="keyword">if</span> (sPool != <span class="keyword">null</span>) &#123;</div><div class="line">     <span class="comment">//å–å‡ºé˜Ÿé¦–çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span></div><div class="line">      Message m = sPool;</div><div class="line">      sPool = m.next;</div><div class="line">      m.next = <span class="keyword">null</span>;</div><div class="line">      m.flags = <span class="number">0</span>; <span class="comment">// clear in-use flag</span></div><div class="line">      sPoolSize--;</div><div class="line">      <span class="keyword">return</span> m;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Message();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä» ğŸ‘† ä¸¤ä¸ªæ–¹æ³•å¯ä»¥çœ‹å‡ºï¼š</p>
<ol>
<li>Message å›æ”¶çš„æ—¶å€™ï¼Œä¼šæ’å…¥å›æ”¶æ± åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ </li>
<li>Message é‡ç”¨çš„æ—¶å€™ï¼Œä¼šå–å‡ºå›æ”¶æ± é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ </li>
</ol>
<p><strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œå–å‡ºçš„ message ä¸€èˆ¬æ˜¯æœ€æ–°æ’å…¥çš„ã€‚</strong>å› æ­¤ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œå¤ç°ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</div><div class="line">  <span class="comment">//æ–°å»ºä¸€ä¸ªåä¸º BackgroundThread çš„HandlerThread</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">val</span> background = HandlerThread(<span class="string">"BackgroundThread"</span>)</div><div class="line">    .apply &#123;</div><div class="line">      start()</div><div class="line">    &#125;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">val</span> backgroundHandler = Handler(background.looper)</div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</div><div class="line">    setContentView(R.layout.activity_main)</div><div class="line">    mBtnShowNormalDialogFragment.setOnClickListener &#123;</div><div class="line">      <span class="comment">//å¾€ é€šè¿‡ backgroundHandler å¾€ background HandlerThread ä¸­çš„ MessageQueue æ’å…¥ä¸€æ¡ msg</span></div><div class="line">      backgroundHandler.post(Runnable &#123;</div><div class="line">       <span class="comment">//è°ƒç”¨ runOnUiThreadï¼Œå¾€ä¸»çº¿ç¨‹çš„ MessageQueue æ’å…¥ä¸€æ¡ msgã€‚å› ä¸ºå½“å‰çº¿ç¨‹å¹¶éä¸»çº¿ç¨‹ï¼Œå› æ­¤ä¼šå¾€ä¸»çº¿ç¨‹é˜Ÿåˆ—ä¸­ post ä¸€ä¸ª Message(è¿™ä¸ª message å›å…ˆå°è¯•ä» pool ä¸­å–ï¼Œå¤§æ¦‚ç‡ä¼šå–åˆ° backgroundHandler åˆšåˆšæ‰§è¡Œå®Œè¢«å›æ”¶çš„ message ï¼‰</span></div><div class="line">        runOnUiThread &#123;</div><div class="line">          <span class="keyword">val</span> fragment = NormalDialogFragment()</div><div class="line">          fragment.apply &#123;</div><div class="line">            show(supportFragmentManager, <span class="string">"NormalFragment"</span>)</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œä¹‹åï¼Œç‚¹å‡»ä½¿ DialogFragment æ¶ˆå¤±ï¼Œç­‰å¾… 10s å·¦å³ï¼ŒLeakCanary å¯èƒ½å°±ä¼šæŠ¥å‘Šå†…å­˜æ³„æ¼é—®é¢˜äº†ã€‚</p>
<h3 id="2-3ã€message-å†…å­˜æ³„æ¼çš„å½±å“"><a href="#2-3ã€message-å†…å­˜æ³„æ¼çš„å½±å“" class="headerlink" title="2.3ã€message å†…å­˜æ³„æ¼çš„å½±å“"></a>2.3ã€message å†…å­˜æ³„æ¼çš„å½±å“</h3><p>Qï¼šæ³„æ¼çš„å†…å­˜æ˜¯å¦ä¼šä¸æ–­å¢é•¿ï¼Ÿæ˜¯çŸ­æš‚æ³„æ¼è¿˜æ˜¯é•¿æ—¶é—´çš„æ³„æ¼ï¼Ÿ</p>
<ul>
<li><p>å­˜åœ¨å¢é•¿çš„å¯èƒ½æ€§ï¼Œä½†æ˜¯æ˜¯æœ‰ä¸Šé™çš„ã€‚ - å¢é•¿çš„ä¸Šé™ä¸»è¦çœ‹ åº”ç”¨ä¸­æœ‰å¤šå°‘ä¸ªä¹‹å‰æ‰§è¡Œè¿‡ Message ä½†æ˜¯ç›®å‰é˜Ÿåˆ—ä¸ºç©ºçš„å¸¦æœ‰ Looper çš„ Threadï¼Œè¿™ç§ç±»å‹çš„ Thread æ•°ç›®è¶Šå¤šï¼ŒMessage æ³„æ¼çš„æ¦‚ç‡å°±è¶Šé«˜ã€‚ - å¿½ç•¥é‚£äº›ä¸æ˜¯é€šè¿‡ç»§æ‰¿ HandlerThread å®ç°çš„ å¸¦ Looper çš„ Threadã€‚TODO app å¸¸é©»çš„</p>
</li>
<li><p>ä¸»è¦å½±å“çš„æ˜¯ç±»ä¼¼äº Dialog è¿™ç§ä»æ¶ˆæ¯æ± ä¸­è·å–äº† Message ä½†æ˜¯ä¸€ç›´æ²¡æœ‰è°ƒç”¨ Message#recycle æ–¹æ³•çš„æƒ…å†µã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦ç­‰å¾…ç›¸åº”çš„çº¿ç¨‹æœ‰æ–°çš„ Message å…¥é˜Ÿåˆ—å¹¶ä¸”è¢«å–å‡ºä¹‹åï¼Œæ‰ä¼šé‡Šæ”¾ã€‚ - å¦‚æœæœ‰è°ƒç”¨ recycleï¼Œå³ä½¿ message ä¸€ç›´è¢«å¦ä¸€ä¸ªçº¿ç¨‹çš„ Looper#loop æ–¹æ³• å±€éƒ¨å¼•ç”¨ç€ï¼ŒçœŸæ­£ç”¨åˆ°è¿™æ¡ message è¢«æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šè°ƒç”¨ Message#recycleUnchecked æ–¹æ³•å°† æ¶ˆæ¯çš„å†…å®¹æ¸…é™¤æ‰ã€‚</p>
</li>
</ul>
<h2 id="3ã€è§£å†³æ–¹æ¡ˆ"><a href="#3ã€è§£å†³æ–¹æ¡ˆ" class="headerlink" title="3ã€è§£å†³æ–¹æ¡ˆ"></a>3ã€è§£å†³æ–¹æ¡ˆ</h2><h3 id="3-1ã€ç³»ç»Ÿä¾§"><a href="#3-1ã€ç³»ç»Ÿä¾§" class="headerlink" title="3.1ã€ç³»ç»Ÿä¾§"></a>3.1ã€ç³»ç»Ÿä¾§</h3><ul>
<li>Android å®˜æ–¹æ¶ˆæ¯æœºåˆ¶ä¸­ï¼Œ Java å±‚çš„ä»£ç ä¸­åº”è¯¥åœ¨ Looper#loop æ–¹æ³•çš„æœ«å°¾ï¼Œå°† msg å˜é‡ç½®ä¸º nullã€‚</li>
<li>ARTã€Dalvik ä¸­å½“å¼•ç”¨å˜é‡æ— æ•ˆæ—¶ï¼Œå¯ä»¥å°†å¯¹åº”çš„ slot ç½®ä¸º null</li>
</ul>
<h3 id="3-2ã€App-ä¾§"><a href="#3-2ã€App-ä¾§" class="headerlink" title="3.2ã€App ä¾§"></a>3.2ã€App ä¾§</h3><p>ç›¸å¯¹é€šç”¨çš„è§£å†³æ–¹æ¡ˆ</p>
<ol>
<li>å¦‚æœæ˜¯ library çš„å¼€å‘è€…ï¼Œè‡ªå·±å¼€å‘çš„ library ä½¿ç”¨åˆ°äº† HandlerThreadï¼Œæƒ³é˜²æ­¢è‡ªå·±çš„åº“ä¸­çš„ HandlerThread å¼•å‘ç±»ä¼¼çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œå¯ä»¥å°† handlerThread çš„ looper ä¼ é€’ç»™ä¸‹é¢çš„ flushStackLocalLeaks æ–¹æ³•ã€‚</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * æ¥æ”¶ handlerThread çš„ looper</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">fun</span> <span class="title">flushStackLocalLeaks</span><span class="params">(looper: <span class="type">Looper</span>)</span></span> &#123;</div><div class="line">  <span class="keyword">val</span> handler = Handler(looper)</div><div class="line">  handler.post &#123;</div><div class="line">    <span class="comment">//å½“é˜Ÿåˆ—é—²ç½®çš„æ—¶å€™ï¼Œå°±ç»™å®ƒå‘é€ç©ºçš„ messageï¼Œä»¥ç¡®ä¿ä¸ä¼šå‘ç”Ÿ message å†…å­˜æ³„æ¼</span></div><div class="line">    Looper.myQueue().addIdleHandler &#123;</div><div class="line">      handler.sendMessageDelayed(handler.obtainMessage(), <span class="number">1000</span>)</div><div class="line">      <span class="comment">//è¿”å› trueï¼Œä¸ä¼šè‡ªåŠ¨ç§»é™¤</span></div><div class="line">      <span class="keyword">return</span><span class="symbol">@addIdleHandler</span> <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>é’ˆå¯¹ appï¼Œå¯ä»¥é€šè¿‡ Thread.getAllStackTraces().keys æ–¹æ³•è·å–æ‰€æœ‰çš„çº¿ç¨‹ã€‚è¿­ä»£éå†ï¼Œåˆ¤æ–­çº¿ç¨‹æ˜¯å¦ä¸º HandlerThreadï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ä¸Šé¢çš„ flushStackLocalLeaks æ–¹æ³•ã€‚é‡‡ç”¨è¿™ç§æ–¹æ¡ˆè¦æ³¨æ„çš„ç‚¹æ˜¯ï¼Œè¦æ³¨æ„è°ƒç”¨æ—¶æœºï¼Œç¡®ä¿è°ƒç”¨çš„æ—¶å€™æ‰€æœ‰çš„ HandlerThread éƒ½å·²ç»å¯åŠ¨äº†ï¼Œä¸ç„¶ä¼šæœ‰é—æ¼çš„æƒ…å†µã€‚</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Thread.getAllStackTraces().keys.*forEach* &#123; thread -&gt;</div><div class="line">  <span class="keyword">if</span> (thread <span class="keyword">is</span> HandlerThread &amp;&amp; thread.isAlive) &#123;</div><div class="line">    <span class="comment">//æ·»åŠ  IdleHandler</span></div><div class="line">    flushStackLocalLeaks(thread.looper)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯è¿™ç§æ–¹æ¡ˆä¹Ÿå­˜åœ¨ä¸è¶³çš„åœ°æ–¹ï¼š</p>
<ul>
<li>App ä¸­å¯èƒ½å­˜åœ¨å¸¦æœ‰ Looper å’Œ MessageQueue çš„ Thread ä½†åˆä¸æ˜¯é€šè¿‡ç»§æ‰¿ HandlerThread æ¥å®ç°çš„ï¼Œéœ€è¦ç”¨æ›´é€šç”¨çš„åˆ¤æ–­æ–¹å¼ã€‚ Looper æ˜¯å­˜åœ¨ Thread çš„ threadLocalMap é‡Œé¢çš„ï¼Œä»…é€šè¿‡çº¿ç¨‹å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸æ˜¯å¾ˆå¥½è·å–ã€‚</li>
<li>ç³»ç»Ÿç‰ˆæœ¬é™åˆ¶ã€‚ Looper#getQueue æ–¹æ³•æ˜¯ API Level 23 æ‰æ·»åŠ çš„ ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç›´æ¥ç”¨è¿™ç§æ–¹å¼æ— æ³•æ¶µç›– &lt;= Android 5.1 ç‰ˆæœ¬çš„ç³»ç»Ÿã€‚<ul>
<li>Looper#myQueue æ–¹æ³•æ²¡æœ‰ API é™åˆ¶ï¼Œä½†æ˜¯å®ƒåªèƒ½æ‹¿åˆ°å½“å‰çº¿ç¨‹çš„ queueï¼Œæ²¡æ³•é€šè¿‡çº¿ç¨‹å®ä¾‹å»è·å– queue</li>
<li>é’ˆå¯¹ç‰ˆæœ¬ &lt; 6.0 çš„æ‰‹æœºï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡åå°„è·å– Looper#mQueue å­—æ®µè§£å†³</li>
</ul>
</li>
</ul>
<p>åªé’ˆå¯¹ Dialog/DialogFragment æ³„æ¼çš„è§£å†³æ–¹æ¡ˆï¼š</p>
<p>åœ¨ä¿è¯ Dialog åŸæœ‰çš„å¤ç”¨åŠŸèƒ½æ­£å¸¸è¿è¡Œçš„å‰æä¸‹ï¼šæœ‰ä¸¤ä¸ªæ€è·¯ï¼š</p>
<ol>
<li><p>æ€è·¯ï¼šä» pool ä¸­å–å‡ºçš„ message æœ‰å¯èƒ½æ˜¯è¢«å…¶ä»–æŸä¸ª HandlerThread å¼•ç”¨ç€çš„ï¼Œé‚£æˆ‘ä»¬ä¸è¦ä» pool ä¸­å–æ¶ˆæ¯ï¼Œè€Œæ˜¯ç›´æ¥ new Message ä¸å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜äº†å—ï¼Ÿ</p>
<ul>
<li>æŸ¥çœ‹ Dialog æºç  mCancelMessage mDismissMessage mShowMessage è®¿é—®æƒé™éƒ½æ˜¯ private çš„ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡ç»§æ‰¿é‡å†™ setOnXxxListener æ–¹æ³•ï¼Œä½†æ˜¯ä¸ä½¿ç”¨åå°„çš„è¯ï¼Œæ— æ³•ä¸º mCancelMessage èµ‹å€¼ã€‚<ul>
<li>åå°„æœ‰ç‚¹ hackï¼Œæˆ‘ä»¬ä¼˜å…ˆçœ‹çœ‹æ˜¯å¦æœ‰åˆ«çš„æ–¹æ¡ˆã€‚</li>
<li>Dialog ä¸­è¿˜æœ‰ Dialog#setCancelMessageã€ä»¥åŠ setDismissMessage æ–¹æ³•ï¼Œå¯ä»¥å®ç°å¯¹ cancelMessage å’Œ dismissMessage èµ‹å€¼ï¼Œä½†æ˜¯æ²¡æœ‰ setShowMessage è¿™æ ·çš„æ–¹æ³•ã€‚è¿™ç§æ–¹å¼è¦†ç›–ä¸å…¨é¢ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>å¦ä¸€ç§æ€è·¯ï¼Œåˆ‡æ–­å¼•ç”¨é“¾</p>
<ul>
<li>å®šä¹‰ä¸€ä¸ªç»§æ‰¿è‡ª Dialog çš„ AvoidLeakDialog é‡å†™ setOnDismissListener setOnShowListener setOnCancelListener æ–¹æ³•ï¼Œå°†ä¼ å…¥çš„ Listener åŒ…è£…ä¸€å±‚ã€‚åŒæ—¶ä¸ºäº†é¿å… Listener å˜é‡å› ä¸ºä»…è¢«å¼±å¼•ç”¨è€…ï¼Œå¯¼è‡´åœ¨ GC çš„æ—¶å€™è¢«æå‰å›æ”¶ï¼Œè¿˜åº”è¯¥æ·»åŠ åœ¨ é‡å†™çš„ Dialog ä¸­æ·»åŠ ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼Œå­˜å‚¨å¯¹åº” Listener çš„å€¼ã€‚ç„¶åå®šä¹‰ä¸€ä¸ª DialogFragment çš„å­ç±»ï¼ŒAvoidfLeakDialogFragmentï¼Œé‡å†™ onCreateDialog æ–¹æ³•ï¼Œè¿”å›è‡ªå®šä¹‰çš„ Dialogã€‚</li>
</ul>
</li>
</ol>
<p>ä»¥ setOnShowListener æ–¹æ³•ä¸ºä¾‹ï¼ŒåŒ…è£…ç±»å¦‚ä¸‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WrappedShowListener</span></span>(delegate: DialogInterface.OnShowListener?) :</div><div class="line">  DialogInterface.OnShowListener &#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">var</span> weakRef = WeakReference(delegate)</div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onShow</span><span class="params">(dialog: <span class="type">DialogInterface</span>?)</span></span> &#123;</div><div class="line">    weakRef.<span class="keyword">get</span>()?.onShow(dialog)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/TimLin1024/MessageMemoryLeakSample/blob/master/app/src/main/java/com/timlin/messagememoryleaksample/AvoidLeakDialog.kt" target="_blank" rel="noopener">AvoidLeakDialog</a></li>
<li><a href="https://github.com/TimLin1024/MessageMemoryLeakSample/blob/master/app/src/main/java/com/timlin/messagememoryleaksample/AvoidLeakedDialogFragment.kt" target="_blank" rel="noopener">AvoidLeakFragment</a></li>
</ul>
<p><strong>é™„ï¼šå…¶ä»–è§£å†³æ–¹æ¡ˆ</strong></p>
<p>square ä»¥åŠå…¶ä»–ç½‘ä¸Šçš„æ–‡ç« ä¸­ï¼Œæœ‰ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ˜¯å°†è®¾ç½®ç»™ Dialog çš„ Listener åŒ…è£…ä¸€å±‚ä¸º ClearOnDetachListener ï¼Œç„¶åä¸šåŠ¡æ–¹è°ƒç”¨ Dialog#show æ–¹æ³•ä¹‹åï¼Œå†å»æ‰‹åŠ¨ clearOnDetach æ–¹æ³•ã€‚</p>
<p>è¿™ç§æ–¹æ³•ç¡®å®å¯ä»¥è§£å†³å†…å­˜æ³„æ¼é—®é¢˜ã€‚ä½†æ˜¯å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼šåœ¨ dialog è°ƒç”¨ dimiss æ–¹æ³•ä¹‹åï¼Œå†è°ƒç”¨ show æ–¹æ³•çš„è¯ï¼ŒåŸæ¥è®¾ç½®çš„ Listener å°±å¤±æ•ˆäº†ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * https://medium.com/square-corner-blog/a-small-leak-will-sink-a-great-ship-efbae00f9a0f</div><div class="line"> * square çš„è§£å†³æ–¹æ¡ˆã€‚View detach çš„æ—¶å€™å°±å°†å¼•ç”¨ç½®ä¸º null äº†ï¼Œ</div><div class="line"> * ä¼šå¯¼è‡´ Dialog é‡æ–°æ˜¾ç¤ºçš„æ—¶å€™ï¼ŒåŸæ¥è®¾ç½®çš„ Listener æ”¶ä¸åˆ°å›è°ƒ</div><div class="line"> *</div><div class="line"> * åœ¨ show ä¹‹åï¼Œè°ƒç”¨ clearOnDetach</div><div class="line"> * */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClearOnDetachListener</span></span>(<span class="keyword">private</span> <span class="keyword">var</span> delegate: DialogInterface.OnClickListener?) :</div><div class="line">  DialogInterface.OnClickListener &#123;</div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(dialog: <span class="type">DialogInterface</span>?, which: <span class="type">Int</span>)</span></span> &#123;</div><div class="line">    delegate?.onClick(dialog, which)</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">clearOnDetach</span><span class="params">(dialog: <span class="type">Dialog</span>)</span></span> &#123;</div><div class="line">    dialog.*window*?.*decorView*?.*viewTreeObserver*?.addOnWindowAttachListener(<span class="keyword">object</span> :</div><div class="line">      ViewTreeObserver.OnWindowAttachListener &#123;</div><div class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onWindowDetached</span><span class="params">()</span></span> &#123;</div><div class="line">        Log.d(*TAG*, <span class="string">"onWindowDetached: "</span>)</div><div class="line">        delegate = <span class="literal">null</span></div><div class="line">      &#125;</div><div class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onWindowAttached</span><span class="params">()</span></span> &#123;</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ–¹å¼</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> clearOnDetachListener =</div><div class="line">  ClearOnDetachListener(DialogInterface.OnClickListener **&#123;** dialog, which **-&gt; &#123;&#125; &#125;**)</div><div class="line"><span class="keyword">val</span> dialog = AlertDialog.Builder(<span class="keyword">this</span>)</div><div class="line">  .setPositiveButton(<span class="string">"sure"</span>, clearOnDetachListener)</div><div class="line">  .show()</div><div class="line">clearOnDetachListener.clearOnDetach(dialog)</div></pre></td></tr></table></figure>
<h2 id="4ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#4ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="4ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>4ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://medium.com/square-corner-blog/a-small-leak-will-sink-a-great-ship-efbae00f9a0f" target="_blank" rel="noopener">https://medium.com/square-corner-blog/a-small-leak-will-sink-a-great-ship-efbae00f9a0f</a></li>
<li>ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹</li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> å†…å­˜æ³„æ¼ </tag>
            
            <tag> æºç åˆ†æ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨ç»†ç²’åº¦çš„é€šçŸ¥æ–¹æ³•æ›´æ–° RecyclerViewï¼Ÿ]]></title>
      <url>https://timlin-pro.github.io/blog/2020/05/29/%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E5%88%86%E6%9E%90%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%E7%BB%86%E7%B2%92%E5%BA%A6%E7%9A%84%E9%80%9A%E7%9F%A5%E6%96%B9%E6%B3%95%E6%9B%B4%E6%96%B0RecyclerView%EF%BC%9F/</url>
      <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨æœ‰æ•°æ®åˆ·æ–°çš„æ—¶å€™æ¨èå¤§å®¶ä½¿ç”¨ notifyItemXxxChanged ç­‰æ–¹æ³•è€Œä¸æ˜¯ä½¿ç”¨ notifyDataSetChanged æ–¹æ³•å‘¢ï¼Ÿ<br>å› ä¸º</p>
<ul>
<li>åœ¨è°ƒç”¨ notifyDataSetChanged æ–¹æ³•åï¼Œæ‰€æœ‰çš„å­ view ï¼ˆæ— è®ºæ˜¯å¦çœŸçš„éœ€è¦æ›´æ–°ï¼‰éƒ½ä¼šè¢«æ·»åŠ ä¸€ä¸ªæ ‡è®°ï¼Œ<strong>è¿™ä¸ªæ ‡è®°å¯¼è‡´å®ƒä»¬æœ€åéƒ½è¢«ç¼“å­˜åˆ° RecyclerPool ä¸­</strong>ï¼Œç„¶åé‡æ–°ç»‘å®šæ•°æ®ã€‚å¹¶ä¸”<strong>ç”±äº RecyclerPool æœ‰å®¹é‡é™åˆ¶ï¼Œå¦‚æœä¸å¤Ÿæœ€åå°±è¦é‡æ–°åˆ›å»ºæ–°çš„è§†å›¾äº†</strong>ã€‚</li>
<li>ä½†æ˜¯ä½¿ç”¨ notifyItemXxxChanged ç­‰æ–¹æ³•ä¼šå°† ViewHolder ç¼“å­˜åˆ° mChangedScrap å’Œ mAttachedScrap ä¸­ï¼Œè¿™ä¸¤ä¸ªç¼“å­˜æ˜¯æ²¡æœ‰å®¹é‡é™åˆ¶çš„ï¼Œæ‰€ä»¥åŸæœ‰çš„ ViewHolder å¯ä»¥å¾—åˆ°æœ€å¤§ç¨‹åº¦çš„å¤ç”¨ï¼ŒåŸºæœ¬ä¸éœ€è¦é‡æ–°åˆ›å»ºæ–°çš„ ViewHolderï¼Œåªæ˜¯ mChangedScrap ä¸­çš„è§†å›¾éœ€è¦é‡æ–°æ‰§è¡Œ bindã€‚<a id="more"></a>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="1ã€RecyclerView-ä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼"><a href="#1ã€RecyclerView-ä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="1ã€RecyclerView ä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼"></a>1ã€RecyclerView ä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼</h3>ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯è°ƒç”¨ Adapter#notifyXxx æ–¹æ³•é€šçŸ¥æ•°æ®å˜æ›´ï¼Œç„¶å RecyclerView ä¼šåˆ·æ–°ï¼Œè¿™ç§æœºåˆ¶çœ‹ä¸Šå»æ˜¯ä¸æ˜¯æœ‰ç‚¹çœ¼ç†Ÿï¼Ÿæ˜¯çš„ï¼ŒRecyclerView ä¸­ä½¿ç”¨åˆ°äº†æˆ‘ä»¬å¸¸è§çš„è§‚å¯Ÿè€…æ¨¡å¼ã€‚<br>å¦‚ä¸‹æ—¶åºå›¾æ‰€ç¤ºï¼š<br><img src="https://raw.githubusercontent.com/TimLin1024/Graph/master/markdown/RecyclerView%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F%E6%97%B6%E5%BA%8F%E5%9B%BE.png" alt="RecyclerViewè§‚å¯Ÿè€…æ¨¡å¼æ—¶åºå›¾"><br>è¯´æ˜</li>
<li>Adapter ä¸­çš„æ•°æ®æ˜¯è¢«è§‚å¯Ÿè€…ï¼Œä¹Ÿå°±æ˜¯ä¸Šå›¾ä¸­çš„ AdapterDataObservableã€‚</li>
<li>RecyclerViewDataObserver æ˜¯è§‚å¯Ÿè€…ï¼Œåœ¨æ•°æ®é›†å˜åŒ–æ—¶åšå‡ºå¯¹åº”çš„å“åº”ã€‚RecyclerView é€šè¿‡ç»„åˆçš„æ–¹å¼ä½¿ç”¨åˆ°è¿™ä¸ªç±»ã€‚</li>
<li>æ³¨å†Œè¿‡ç¨‹ï¼šå¤–éƒ¨è°ƒç”¨ RecyclerView#setAdapter æ–¹æ³•çš„æ—¶å€™ï¼ŒRecyclerView ä¼šå°†è‡ªèº«çš„ä¸€ä¸ª RecyclerViewDataObserver å®ä¾‹æ³¨å†Œä¸ºç›‘å¬è€…ã€‚</li>
<li>é€šçŸ¥è¿‡ç¨‹ï¼šå¤–éƒ¨è°ƒç”¨ Adapter#notifyXxxChanged æ–¹æ³•æ—¶ï¼Œä¼šè§¦å‘ AdapterDataObservable#notifyXxxChangedï¼Œæœ€ç»ˆé€šçŸ¥åˆ°ä¸Šé¢æ³¨å†Œçš„ RecyclerViewDataObserver å¯¹åº”çš„æ–¹æ³•ã€‚<h3 id="2ã€notifyDataSetChanged"><a href="#2ã€notifyDataSetChanged" class="headerlink" title="2ã€notifyDataSetChanged"></a>2ã€notifyDataSetChanged</h3>ä»¥ notifyDataSetChanged æ–¹æ³•ä¸ºä¾‹ï¼Œè¯¥æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ° RecyclerViewDataObserver#onChanged æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå¤„ç†ç»“æ„æ€§å˜åŒ– ã€‚å…·ä½“å®ç°ä½äº processDataSetCompletelyChange æ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨<code>RecyclerView#markKnownViewsInvalid</code>  <strong>å°† ViewHolder æ ‡è®°ä¸º invalid</strong>ã€‚<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">markKnownViewsInvalid</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = mChildHelper.getUnfilteredChildCount();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">        <span class="keyword">final</span> ViewHolder holder = getChildViewHolderInt(mChildHelper.getUnfilteredChildAt(i));</div><div class="line">        <span class="keyword">if</span> (holder != <span class="keyword">null</span> &amp;&amp; !holder.shouldIgnore()) &#123;</div><div class="line">            <span class="comment">//å°†å½“å‰ RecyclerView çš„æ‰€æœ‰å­ ViewHolder æ·»åŠ  FLAG_UPDATE å’Œ FLAG_INVALID æ ‡è®°</span></div><div class="line">            holder.addFlags(ViewHolder.FLAG_UPDATE | ViewHolder.FLAG_INVALID);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    markItemDecorInsetsDirty();</div><div class="line">	  <span class="comment">//å¯¹ mCachedView ä¸­çš„å­ ViewHolder æ·»åŠ  FLAG_UPDATE å’Œ FLAG_INVALID æ ‡è®°</span></div><div class="line">    mRecycler.markKnownViewsInvalid();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>è¿™ä¸¤ä¸ªæ ‡è®°ï¼ˆFLAG_UPDATEã€FLAG_INVALIDï¼‰ä¸åç»­çš„æ›´æ–°ä»¥åŠç¼“å­˜æœ‰å¾ˆå¤§çš„å…³ç³»ï¼ˆåœ¨åé¢å†…å®¹ä¼šè¯´æ˜ï¼‰<br>é‡ç‚¹ğŸ‘†ğŸ‘†ğŸ‘†<br>å‡è®¾æ­¤æ—¶æ²¡æœ‰ pendingUpdateï¼ˆæ³¨ï¼šAdapterHelper#mPendingUpdates ä¸­å­˜å‚¨ç€å¤–éƒ¨è°ƒç”¨ notifyXxx æ–¹æ³•è§¦å‘çš„ UpdateOpï¼Œä¸€ä¸ª UpdateOp å¯¹åº”ä¸€æ¬¡æ›´æ–°æ“ä½œï¼‰ ï¼Œä¼šè§¦å‘ requestLayoutã€‚ æœ€ç»ˆè°ƒç”¨åˆ° ViewRootImpl#requestLayoutï¼Œè§¦å‘ scheduleTraversalsï¼Œç­‰ä¸‹ä¸€æ¬¡å‚ç›´ä¿¡å·è¿‡æ¥çš„æ—¶å€™ï¼Œè§¦å‘ performTraversalï¼Œé‡æ–°è¿›è¡Œå¸ƒå±€ã€‚<br>ä¹Ÿå°±æ˜¯è¯´ä¼šè°ƒç”¨åˆ° RecyclerView#dispatchLayout æ–¹æ³•ï¼Œç„¶åè§¦å‘ dispatchLayoutStep1ã€2ã€3ã€‚æ­¥éª¤ 2 ä¼šè§¦å‘ LayoutManager#onLayoutChildren ï¼ˆå¼€å¯é¢„æµ‹åŠ¨ç”»çš„æƒ…å†µä¸‹ï¼Œæ­¥éª¤ 1 ä¹Ÿä¼šè§¦å‘ onLayoutChildrenï¼‰<br>ä»¥ LinearLayoutManager ä¸ºä¾‹ï¼ŒonLayoutChildren æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ detachAndScrapAttachedViews æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detachAndScrapAttachedViews</span><span class="params">(@NonNull Recycler recycler)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">final</span> View v = getChildAt(i);</div><div class="line">        scrapOrRecycleView(recycler, i, v);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrapOrRecycleView</span><span class="params">(Recycler recycler, <span class="keyword">int</span> index, View view)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ViewHolder viewHolder = getChildViewHolderInt(view);</div><div class="line">    <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">  <span class="comment">//å‰é¢çš„æ ‡å¿—ä½ï¼Œåœ¨è¿™ç”¨åˆ°äº†ã€‚</span></div><div class="line">  <span class="comment">//å¦‚æœä¸º invalid å¹¶ä¸”æ²¡æœ‰è¢« removed å¹¶ä¸” æ²¡æœ‰stableIdï¼ˆé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¸ä¼šè®¾ç½® stableIdï¼‰ï¼Œå› æ­¤ï¼Œè°ƒç”¨ notifyDatasetChange æ–¹æ³•ï¼Œä¼šèµ°åˆ°ğŸ‘‡è¿™ä¸ª if åˆ†æ”¯ï¼Œå°† ViewHolder æ·»åŠ åˆ° RecyclerViewPool ä¸­ã€‚</span></div><div class="line">    <span class="keyword">if</span> (viewHolder.isInvalid() &amp;&amp; !viewHolder.isRemoved()</div><div class="line">            &amp;&amp; !mRecyclerView.mAdapter.hasStableIds()) &#123;</div><div class="line">        removeViewAt(index);</div><div class="line">        recycler.recycleViewHolderInternal(viewHolder);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        detachViewAt(index);</div><div class="line">        recycler.scrapView(view);</div><div class="line">        mRecyclerView.mViewInfoStore.onViewDetached(viewHolder);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ²¡æœ‰ç»™ Adapter è®¾ç½® hasStableId çš„æƒ…å†µä¸‹ï¼ŒnotifyDataSetChange æ–¹æ³•è§¦å‘çš„æ›´æ–°ï¼Œä¼šä½¿ ViewHolder è¢«æ”¾åˆ° RecycledViewPool ä¸­ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒRecycledViewPool ä¸­æ¯ç§ itemType çš„ ViewHolder ç¼“å­˜ä¸Šé™ä¸º 5 ä¸ªï¼Œå¦‚æœå±å¹•æ˜¾ç¤ºçš„ViewHolder å¯¹åº”çš„ itemType æ¯”è¾ƒå•ä¸€ï¼Œå¹¶ä¸”æ˜¾ç¤ºçš„ä¸ªæ•°è¶…è¿‡ 5 ä¸ªï¼Œå‡è®¾å±å¹•ä¸­æ˜¾ç¤ºçš„ç›¸åŒ itemType çš„ ViewHolder ä¸ªæ•°ä¸º nï¼Œé‚£ä¹ˆå°†ä¼šæœ‰ n-5 ä¸ª ViewHolder å› ä¸ºç¼“å­˜æ»¡äº†ï¼Œè€Œæ— æ³•æ”¾å…¥ RecyclerViewPoolï¼Œä¹Ÿå°±ä¸èƒ½å¤ç”¨äº†ï¼Œè¿™å°†å¯¼è‡´åç»­éœ€è¦é‡æ–°åˆ›å»ºç›¸åº”çš„ ViewHolderã€‚</p>
<blockquote>
<p>ğŸ‘†ğŸ‘†ğŸ‘† åˆ’é‡ç‚¹ï¼</p>
<h3 id="3ã€notifyItemXxxChange"><a href="#3ã€notifyItemXxxChange" class="headerlink" title="3ã€notifyItemXxxChange"></a>3ã€notifyItemXxxChange</h3><p>ç»†ç²’åº¦çš„æ›´æ–°æ–¹æ³•ï¼Œæ•´ä½“æ€è·¯ï¼ŒæŸä¸€ä¸ª/å¤šä¸ª item å˜åŒ–äº†ï¼Œé‚£ä¹ˆé€šçŸ¥å¯¹åº”çš„ item ï¼Œè¯¶ï¼Œè€é“ï¼Œæ•°æ®æ›´æ–°äº†ï¼Œä½ å¾—é‡æ–°æ‰§è¡Œä¸€æ¬¡ bindViewHolderã€‚<br>å†æ¥çœ‹çœ‹ notifyItemChangeï¼Œæœ€ç»ˆä¹Ÿä¼šè°ƒç”¨åˆ° RecyclerViewDataObserver#onItemRangeChanged ï¼Œé¦–å…ˆè§¦å‘ AdapterHelper#onItemRangeChangedï¼Œå¾€é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ª update æ“ä½œã€‚å¦‚æœ mPendingUpdates é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ª itemï¼Œé‚£ä¹ˆç›´æ¥è°ƒç”¨ RecyclerView#requestLayout ï¼Œç›‘å¬ä¸‹ä¸€ä¸ªå‚ç›´åŒæ­¥ä¿¡å·ï¼Œè¿›è¡Œåˆ·æ–°<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AdapterHelper#onItemRangeChanged</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">onItemRangeChanged</span><span class="params">(<span class="keyword">int</span> positionStart, <span class="keyword">int</span> itemCount, Object payload)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (itemCount &lt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    mPendingUpdates.add(obtainUpdateOp(UpdateOp.UPDATE, positionStart, itemCount, payload));</div><div class="line">    mExistingUpdateTypes |= UpdateOp.UPDATE;</div><div class="line">    <span class="keyword">return</span> mPendingUpdates.size() == <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>Q:å¯ä»¥çœ‹åˆ°ä¸Šé¢è¿™ä¸ªæ–¹æ³•å¾€é˜Ÿåˆ—ä¸­æ·»åŠ äº†ä¸€ä¸ª UpdateOpï¼Œåœ¨å“ªé‡Œå–å‡ºæ¥æ‰§è¡Œå‘¢ï¼Ÿ<br>A: ä¼šä» AdapterHelper#consumePostponedUpdates æ–¹æ³•ä¸­å–å‡ºé€šçŸ¥ Callback å»æ‰§è¡Œã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumeUpdatesInOnePass</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// we still consume postponed updates (if there is) in case there was a pre-process call</span></div><div class="line">    <span class="comment">// w/o a matching consumePostponedUpdates.</span></div><div class="line">    consumePostponedUpdates();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = mPendingUpdates.size();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        UpdateOp op = mPendingUpdates.get(i);</div><div class="line">        <span class="keyword">switch</span> (op.cmd) &#123;</div><div class="line">            <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">            <span class="keyword">case</span> UpdateOp.UPDATE:</div><div class="line">                mCallback.onDispatchSecondPass(op);</div><div class="line">                mCallback.markViewHoldersUpdated(op.positionStart, op.itemCount, op.payload);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">						<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mOnItemProcessedCallback != <span class="keyword">null</span>) &#123;</div><div class="line">            mOnItemProcessedCallback.run();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ª AdapterHelper#mCallback è¿™ä¸ªæˆå‘˜å˜é‡æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™èµ‹å€¼çš„ï¼Ÿå¯ä»¥çœ‹åˆ°AdapterHelper æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ª Callback å‚æ•°ã€‚å½“ RecyclerView åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ RecyclerView#initAdapterManagerï¼Œåˆ›å»ºä¸€ä¸ª AdapterHelperï¼Œæ­¤æ—¶ä¼šé€šè¿‡åˆ›å»ºåŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼æ„é€ ä¸€ä¸ª Callback å®ä¾‹ï¼Œä¼ é€’ç»™ AdapterHelperï¼ŒAdapterHelper åœ¨æ¶ˆè´¹æ“ä½œåºåˆ—çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ Callback ç›¸åº”çš„æ–¹æ³•ã€‚<br>å›å½’ä¸»çº¿ï¼Œæˆ‘ä»¬è°ƒç”¨äº† notifyItemChange æ–¹æ³•ï¼Œä¼šè§¦å‘ CallBack çš„ onDispatchSecondPass å’Œ  markViewHoldersUpdatedã€‚è·Ÿä¸Šé¢çš„ notifyDataSetChange æ–¹æ³•ç±»ä¼¼ï¼Œè¿™é‡Œæœ€ç»ˆä¹Ÿè§¦å‘äº†ä¸€ä¸ª viewHolder çš„æ ‡è®°è¡Œä¸ºï¼Œè¿™ä¸ªæ ‡è®°æ˜¯é€šè¿‡è°ƒç”¨ RecyclerView#viewRangeUpdate å®Œæˆçš„ã€‚åªä¸è¿‡<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RecyclerView#viewRangeUpdate</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">viewRangeUpdate</span><span class="params">(<span class="keyword">int</span> positionStart, <span class="keyword">int</span> itemCount, Object payload)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = mChildHelper.getUnfilteredChildCount();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> positionEnd = positionStart + itemCount;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">        <span class="keyword">final</span> View child = mChildHelper.getUnfilteredChildAt(i);</div><div class="line">        <span class="keyword">final</span> ViewHolder holder = getChildViewHolderInt(child);</div><div class="line">        <span class="keyword">if</span> (holder == <span class="keyword">null</span> || holder.shouldIgnore()) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (holder.mPosition &gt;= positionStart &amp;&amp; holder.mPosition &lt; positionEnd) &#123;</div><div class="line">            <span class="comment">//æ ‡è®°ä¸º FLAG_UPDATE</span></div><div class="line">            holder.addFlags(ViewHolder.FLAG_UPDATE);</div><div class="line">				 <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//  åŒæ—¶ä¹Ÿä¼šç»™ RecyclerView.Recycler#mCachedViews ä¸­çš„ä½äºåŒºé—´å†…çš„ ViewHolder åŠ ä¸Š ViewHolder.FLAG_UPDATE æ ‡è®°ï¼Œ</span></div><div class="line">    mRecycler.viewRangeUpdate(positionStart, itemCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç»†ç²’åº¦é€šçŸ¥çš„æ–¹æ³•ï¼Œä¹Ÿä¼šç»™ ViewHolder æ‰“ä¸Šä¸€ä¸ª flagï¼Œåªæ˜¯è¿™ä¸ª flag çš„å€¼è·Ÿ notifyDataSetChange æ–¹æ³•é€šçŸ¥æ›´æ–°æ—¶ä¸åŒã€‚<br>è¿™ä¸ª flag å•¥æ—¶å€™ä¼šæ´¾ä¸Šç”¨åœºå‘¢ï¼Ÿ<br>ç»†ç²’åº¦é€šçŸ¥åŒæ ·ä¼šè§¦å‘å¸ƒå±€ï¼Œè°ƒç”¨åˆ° onLayoutChildren æ–¹æ³•ï¼Œæœ€ç»ˆä¹Ÿä¼šè§¦å‘å‰é¢æåˆ°çš„ scrapOrRecycleView<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrapOrRecycleView</span><span class="params">(Recycler recycler, <span class="keyword">int</span> index, View view)</span> </span>&#123;</div><div class="line">  	<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">    <span class="keyword">if</span> (viewHolder.isInvalid() &amp;&amp; !viewHolder.isRemoved()</div><div class="line">            &amp;&amp; !mRecyclerView.mAdapter.hasStableIds()) &#123;</div><div class="line">        removeViewAt(index);</div><div class="line">        recycler.recycleViewHolderInternal(viewHolder);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">//å› ä¸ºæ·»åŠ çš„ flag æ˜¯ FLAG_UPDATE ï¼Œä¼šèµ°åˆ°è¿™ä¸ªé€»è¾‘åˆ†æ”¯</span></div><div class="line">        detachViewAt(index);</div><div class="line">        recycler.scrapView(view);</div><div class="line">        mRecyclerView.mViewInfoStore.onViewDetached(viewHolder);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é¦–å…ˆè°ƒç”¨ detachViewAt æ–¹æ³•å°† ViewHolder å¯¹åº”çš„ view ä¸­ recyclerView ä¸­ç§»é™¤ï¼Œæ³¨æ„ï¼Œè·Ÿ removeView ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•åªæ˜¯å°† view ä» parent çš„ mChildren æ•°ç»„ä¸­ç§»é™¤ï¼Œå°† view çš„ parent ç½®ä¸º nullï¼Œä½†æ˜¯å¹¶éçœŸæ­£çš„ç§»é™¤ï¼Œå› æ­¤ä¸ä¼šè§¦å‘requestLayout å’Œ invalidateã€‚ä½†æ˜¯è¿™ç§çŠ¶æ€ä¹Ÿåªæ˜¯æš‚æ—¶çš„ï¼Œä¸€èˆ¬ä¼šå¾ˆå¿«è§¦å‘ attachViewToParent æˆ–è€…æ˜¯ removeDetachedViewã€‚<br>å…·ä½“çœ‹ä¸‹ RecyclerView.Recycler#scrapView æ–¹æ³•ï¼Œç»™ FLAG_UPDATE çš„ ViewHolder ä¼šè¢«æ·»åŠ åˆ°  mChangedScrap ä¸­ï¼Œåç»­é‡æ–°æ‰§è¡Œ bindã€‚ç„¶åå…¶ä»–viewï¼Œä¼šè¢«æ”¾åˆ° mAttachedScrap ä¸­ã€‚æ— è®ºæ˜¯ mAttachedScrap è¿˜æ˜¯ mChangedScrap ï¼Œéƒ½æ²¡æœ‰å®¹é‡é™åˆ¶ï¼Œå› æ­¤ï¼Œå±å¹•ä¸Šçš„ ViewHolder åç»­èƒ½å¤Ÿå¾—åˆ°æ›´å¤§ç¨‹åº¦çš„å¤ç”¨ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">scrapView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ViewHolder holder = getChildViewHolderInt(view);</div><div class="line">    <span class="keyword">if</span> (holder.hasAnyOfTheFlags(ViewHolder.FLAG_REMOVED | ViewHolder.FLAG_INVALID)</div><div class="line">            || !holder.isUpdated() || canReuseUpdatedViewHolder(holder)) &#123;</div><div class="line">			<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">        holder.setScrapContainer(<span class="keyword">this</span>, <span class="keyword">false</span>);</div><div class="line">        mAttachedScrap.add(holder);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mChangedScrap == <span class="keyword">null</span>) &#123;</div><div class="line">            mChangedScrap = <span class="keyword">new</span> ArrayList&lt;ViewHolder&gt;();</div><div class="line">        &#125;</div><div class="line">        holder.setScrapContainer(<span class="keyword">this</span>, <span class="keyword">true</span>);</div><div class="line">        mChangedScrap.add(holder);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
            <category> æºç åˆ†æ </category>
            
        </categories>
        
        
    </entry>
    
    <entry>
      <title><![CDATA[æ·±å…¥ç†è§£ RecyclerView ç¼“å­˜æœºåˆ¶]]></title>
      <url>https://timlin-pro.github.io/blog/2020/05/02/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3RecyclerView%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/</url>
      <content type="html"><![CDATA[<p>ä½¿ç”¨ ScrollView çš„æ—¶å€™ï¼Œå®ƒçš„æ‰€æœ‰å­ view éƒ½ä¼šä¸€æ¬¡æ€§è¢«åŠ è½½å‡ºæ¥ã€‚è€Œæ­£ç¡®ä½¿ç”¨ RecyclerView å¯ä»¥åšåˆ°æŒ‰éœ€åŠ è½½ï¼ŒæŒ‰éœ€ç»‘å®šï¼Œå¹¶å®ç°å¤ç”¨ã€‚æœ¬æ–‡ä¸»è¦åˆ†æ RecyclerView ç¼“å­˜å¤ç”¨çš„åŸç†ã€‚</p>
<a id="more"></a>
<h2 id="ä»ç¼“å­˜è·å–-ViewHolder-æµç¨‹æ¦‚è§ˆ"><a href="#ä»ç¼“å­˜è·å–-ViewHolder-æµç¨‹æ¦‚è§ˆ" class="headerlink" title="ä»ç¼“å­˜è·å– ViewHolder æµç¨‹æ¦‚è§ˆ"></a>ä»ç¼“å­˜è·å– ViewHolder æµç¨‹æ¦‚è§ˆ</h2><p>ä»ç¼“å­˜è·å–çš„å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/image-RecyclerView.png" alt="ç¼“å­˜è·å–æµç¨‹"></p>
<p>è¯´æ˜ï¼š</p>
<p>åœ¨åˆ›å»º ViewHolder ä¹‹å‰ï¼ŒRecyclerView ä¼šå…ˆä»ç¼“å­˜ä¸­å°è¯•è·å–æ˜¯å¦æœ‰ç¬¦åˆè¦æ±‚çš„ ViewHolderï¼Œè¯¦è§ <code>Recycler#tryGetViewHolderForPositionByDeadline</code> æ–¹æ³•</p>
<ul>
<li>ç¬¬ä¸€æ¬¡ï¼Œå°è¯•ä» mChangedScrap ä¸­è·å–ã€‚<ul>
<li>åªæœ‰åœ¨ mState.isPreLayout() ä¸º true æ—¶ï¼Œä¹Ÿå°±æ˜¯é¢„å¸ƒå±€é˜¶æ®µï¼Œæ‰ä¼šåšè¿™æ¬¡å°è¯•ã€‚</li>
<li>ã€Œé¢„å¸ƒå±€ã€çš„æ¦‚å¿µä¼šåœ¨åé¢ä»‹ç»ã€‚</li>
</ul>
</li>
<li>ç¬¬äºŒæ¬¡ï¼ŒgetScrapOrHiddenOrCachedHolderForPosition() è·å¾— ViewHolderã€‚<ul>
<li>å°è¯•ä» 1. mAttachedScrap 2.mHiddenViews 3.mCachedViews ä¸­æŸ¥æ‰¾ ViewHolder<ul>
<li>å…¶ä¸­ mAttachedScrap å’Œ mCachedViews éƒ½æ˜¯ Recycler çš„æˆå‘˜å˜é‡</li>
<li>å¦‚æœæˆåŠŸè·å¾— ViewHolder åˆ™æ£€éªŒå…¶æœ‰æ•ˆæ€§ï¼Œ<ul>
<li>è‹¥<strong>æ£€éªŒå¤±è´¥åˆ™å°†å…¶å›æ”¶</strong>åˆ° RecyclerViewPool ä¸­</li>
<li>æ£€éªŒæˆåŠŸå¯ä»¥ç›´æ¥ä½¿ç”¨</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ä¸‰æ¬¡ï¼Œå¦‚æœç»™ Adapter è®¾ç½®äº† stableIdï¼Œè°ƒç”¨ getScrapOrCachedViewForId å°è¯•è·å– ViewHolderã€‚<ul>
<li>è·Ÿç¬¬äºŒæ¬¡çš„åŒºåˆ«åœ¨äºï¼Œä¹‹å‰æ˜¯æ ¹æ® position æŸ¥æ‰¾ï¼Œç°åœ¨æ˜¯æ ¹æ® id æŸ¥æ‰¾</li>
</ul>
</li>
<li>ç¬¬å››æ¬¡ï¼ŒmViewCacheExtension ä¸ä¸ºç©ºçš„è¯ï¼Œåˆ™è°ƒç”¨ ViewCacheExtension#getViewForPositionAndType æ–¹æ³•å°è¯•è·å– <strong>View</strong><ul>
<li>æ³¨ï¼šViewCacheExtension æ˜¯ç”±å¼€å‘è€…è®¾ç½®çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºç©ºï¼Œä¸€èˆ¬æˆ‘ä»¬ä¹Ÿä¸ä¼šè®¾ç½®ã€‚è¿™å±‚ç¼“å­˜å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯ä»¥å¿½ç•¥ã€‚</li>
</ul>
</li>
<li>ç¬¬äº”æ¬¡ã€‚å°è¯•ä» RecyclerViewPool ä¸­è·å–ï¼Œç›¸æ¯”è¾ƒäº mCachedViewsï¼Œä» mRecyclerPool ä¸­æˆåŠŸè·å– ViewHolder å¯¹è±¡åå¹¶æ²¡æœ‰åšåˆæ³•æ€§å’Œ item ä½ç½®æ ¡éªŒï¼Œåªæ£€éªŒ viewType æ˜¯å¦ä¸€è‡´ã€‚<ul>
<li>ä» RecyclerViewPool ä¸­å–å‡ºæ¥çš„ ViewHolder éœ€è¦é‡æ–°æ‰§è¡Œ bind æ‰èƒ½ä½¿ç”¨ã€‚</li>
</ul>
</li>
<li>å¦‚æœä¸Šé¢äº”æ¬¡å°è¯•éƒ½å¤±è´¥äº†ï¼Œè°ƒç”¨ RecyclerView.Adapter#createViewHolder åˆ›å»ºä¸€ä¸ªæ–°çš„ ViewHolder</li>
<li>æœ€åæ ¹æ® ViewHolder çš„çŠ¶æ€ï¼Œç¡®å®šæ˜¯å¦éœ€è¦è°ƒç”¨ bindViewHolder è¿›è¡Œæ•°æ®ç»‘å®šã€‚</li>
</ul>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><h3 id="é¢„å¸ƒå±€ã€é¢„æµ‹åŠ¨ç”»æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#é¢„å¸ƒå±€ã€é¢„æµ‹åŠ¨ç”»æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="é¢„å¸ƒå±€ã€é¢„æµ‹åŠ¨ç”»æ˜¯ä»€ä¹ˆï¼Ÿ"></a>é¢„å¸ƒå±€ã€é¢„æµ‹åŠ¨ç”»æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>ç†è§£ã€Œé¢„å¸ƒå±€ã€éœ€è¦å…ˆäº†è§£ã€Œé¢„æµ‹åŠ¨ç”»ã€ã€‚è€ƒè™‘è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š</p>
<p>ç”¨æˆ·æœ‰ Aã€Bã€C ä¸‰ä¸ª itemï¼ŒAï¼ŒB åˆšå¥½æ˜¾ç¤ºåœ¨å±å¹•ä¸­ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œç”¨æˆ·æŠŠ B åˆ é™¤äº†ï¼Œé‚£ä¹ˆæœ€ç»ˆ C ä¼šæ˜¾ç¤ºåœ¨ B åŸæ¥çš„ä½ç½®</p>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/image-é¢„æµ‹åŠ¨ç”»é—®é¢˜.png" alt=""></p>
<p>å¦‚æœ C ä»åº•éƒ¨å¹³æ»‘åœ°æ»‘åŠ¨åˆ°ä¹‹å‰ B çš„ä½ç½®å°†ä¼šæ›´ç¬¦åˆç›´è§‰ã€‚ä½†æ˜¯è¦åšåˆ°è¿™ç‚¹å®é™…ä¸Šæ²¡é‚£ä¹ˆç®€å•ã€‚å› ä¸ºæˆ‘ä»¬åªçŸ¥é“ C æœ€ç»ˆçš„ä½ç½®ï¼Œä½†æ˜¯ä¸çŸ¥é“ C çš„èµ·å§‹ä½ç½®åœ¨å“ªé‡Œï¼Œæ— æ³•ç¡®å®š C åº”è¯¥ä»å“ªé‡Œæ»‘åŠ¨è¿‡æ¥ã€‚å¦‚æœæ ¹æ®æœ€ç»ˆçš„çŠ¶æ€ï¼Œå°±æ–­å®š C åº”è¯¥è¦ä»åº•éƒ¨æ»‘åŠ¨è¿‡æ¥çš„è¯ï¼Œå¾ˆå¯èƒ½æ˜¯æœ‰é—®é¢˜çš„ã€‚å› ä¸ºåœ¨å…¶ä»–ç±»å‹çš„ LayoutManager ä¸­ï¼Œå®ƒå¯èƒ½æ˜¯ä»ä¾§é¢æˆ–è€…æ˜¯å…¶ä»–åœ°æ–¹æ»‘åŠ¨è¿‡æ¥çš„ã€‚</p>
<p>é‚£æ ¹æ®åŸçŠ¶æ€ä¸æœ€ç»ˆçŠ¶æ€ä¹‹é—´çš„å·®å¼‚ï¼Œèƒ½ä¸èƒ½å¾—å‡ºæˆ‘ä»¬åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ ·çš„åˆ‡æ¢åŠ¨ç”»å‘¢ï¼Ÿç­”æ¡ˆä¾ç„¶æ˜¯ noã€‚å› ä¸ºåœ¨åŸçŠ¶æ€ä¸­ï¼ŒC æ ¹æœ¬å°±ä¸å­˜åœ¨ã€‚ï¼ˆè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ï¼ŒB è¦è¢«åˆ é™¤äº†ï¼Œå¦‚æœæŠŠ C ç»™åŠ è½½å‡ºæ¥ï¼Œå¾ˆå¯èƒ½æ˜¯ä¸€ç§èµ„æºæµªè´¹ã€‚ï¼‰</p>
<p>è®¾è®¡ RecyclerView çš„å·¥ç¨‹å¸ˆæ˜¯è¿™ä¹ˆè§£å†³çš„ã€‚å½“ Adapter å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼ŒRecyclerView ä¼šè®© LayoutManager è¿›è¡Œä¸¤æ¬¡å¸ƒå±€ã€‚</p>
<ul>
<li>ç¬¬ä¸€æ¬¡æ˜¯<strong>é¢„å¸ƒå±€</strong>ã€‚å°†ä¹‹å‰åŸçŠ¶æ€ ä¸‹çš„ item éƒ½å¸ƒå±€å‡ºæ¥ã€‚å¹¶ä¸”æ ¹æ® Adapter çš„ notify ä¿¡æ¯ï¼Œæˆ‘ä»¬çŸ¥é“å“ªäº› item å³å°†å˜åŒ–äº†ï¼Œæ‰€ä»¥å¯ä»¥<strong>åŠ è½½å‡ºå¦å¤–çš„ View</strong>ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œå› ä¸ºçŸ¥é“ B å·²ç»è¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥å¯ä»¥<strong>æŠŠå±å¹•ä¹‹å¤–çš„ C ä¹ŸåŠ è½½å‡ºæ¥</strong>ã€‚</li>
<li>ç¬¬äºŒä¸ªï¼Œæœ€ç»ˆçš„å¸ƒå±€ï¼Œä¹Ÿå°±æ˜¯å˜åŒ–å®Œæˆä¹‹åçš„å¸ƒå±€ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/image-é¢„å¸ƒå±€.png" alt="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/image-%E9%A2%84%E5%B8%83%E5%B1%80.png"></p>
<p>è¿™æ ·åªè¦æ¯”è¾ƒå‰åå¸ƒå±€çš„å˜åŒ–ï¼Œå°±èƒ½å¾—å‡ºåº”è¯¥æ‰§è¡Œä»€ä¹ˆåŠ¨ç”»äº†ã€‚</p>
<p>è¿™ç§è´Ÿè´£æ‰§è¡ŒåŠ¨ç”»çš„ view åœ¨åŸå¸ƒå±€æˆ–æ–°å¸ƒå±€ä¸­ä¸å­˜åœ¨çš„åŠ¨ç”»ï¼Œå°±ç§°ä¸º<strong>é¢„æµ‹åŠ¨ç”»</strong>ã€‚</p>
<p><strong>é¢„å¸ƒå±€</strong>æ˜¯å®ç°é¢„æµ‹åŠ¨ç”»çš„ä¸€ä¸ªæ­¥éª¤ã€‚</p>
<p>ä¸‹é¢ä¸¤ä¸ªåŠ¨å›¾å±•ç¤ºäº†æ™®é€šåŠ¨ç”»ä¸é¢„æµ‹åŠ¨ç”»æ•ˆæœçš„åŒºåˆ«ï¼š</p>
<p>æ™®é€šåŠ¨ç”» ğŸ‘‡</p>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/remove_itemwithou.gif" alt=""></p>
<p>é¢„æµ‹åŠ¨ç”» ğŸ‘‡</p>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/remove_item_predictive-20200502223349463.gif" alt=""></p>
<p>å…³äºé¢„æµ‹åŠ¨ç”»ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è¿›ä¸€æ­¥é˜…è¯»<a href="http://frogermcs.github.io/recyclerview-animations-androiddevsummit-write-up/" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>
<h3 id="å…³äº-Scrap"><a href="#å…³äº-Scrap" class="headerlink" title="å…³äº Scrap"></a>å…³äº Scrap</h3><p>Scrap ç¼“å­˜åˆ—è¡¨ï¼ˆmChangedScrapã€mAttachedScrapï¼‰æ˜¯ RecyclerView æœ€å…ˆæŸ¥æ‰¾ ViewHolder åœ°æ–¹ï¼Œå®ƒè·Ÿ RecyclerViewPool æˆ–è€… ViewCache æœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚</p>
<p>mChangedScrap å’Œ mAttachedScrap åªåœ¨å¸ƒå±€é˜¶æ®µä½¿ç”¨ã€‚å…¶ä»–æ—¶å€™å®ƒä»¬æ˜¯ç©ºçš„ã€‚å¸ƒå±€å®Œæˆä¹‹åï¼Œè¿™ä¸¤ä¸ªç¼“å­˜ä¸­çš„ viewHolderï¼Œä¼šç§»åˆ° mCacheView æˆ–è€… RecyclerViewPool ä¸­ã€‚</p>
<p>å½“ LayoutManager å¼€å§‹å¸ƒå±€çš„æ—¶å€™ï¼ˆé¢„å¸ƒå±€æˆ–è€…æ˜¯æœ€ç»ˆå¸ƒå±€ï¼‰ï¼Œå½“å‰å¸ƒå±€ä¸­çš„æ‰€æœ‰ viewï¼Œéƒ½ä¼šè¢« dump åˆ° scrap ä¸­ï¼ˆå…·ä½“å®ç°å¯è§ <code>LinearLayoutManager#onLayoutChildren() æ–¹æ³•ä¸­è°ƒç”¨äº† detachAndScrapAttachedViews()</code> ï¼‰ï¼Œç„¶å LayoutManager æŒ¨ä¸ªåœ°å–å› viewï¼Œé™¤é view å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–ï¼Œå¦åˆ™å®ƒä¼šé©¬ä¸Šä» scrap ä¸­å›åˆ°åŸæ¥çš„ä½ç½®ã€‚</p>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/scrap-example-.png" alt="img"></p>
<p>ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œæˆ‘ä»¬åˆ é™¤æ‰ bï¼Œè°ƒç”¨ notifyItemRemove æ–¹æ³•ï¼Œè§¦å‘é‡æ–°å¸ƒå±€ï¼Œè¿™æ—¶ a,b,c éƒ½ä¼šè¢« dump åˆ° scrap ä¸­ï¼Œç„¶å LayoutManager  ä¼šä» scrap ä¸­å–å›  a å’Œ cã€‚</p>
<p>åä¸ªé¢˜ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œb å»å“ªäº†ï¼Ÿ RecyclerView çœ‹åˆ° b æ²¡æœ‰å‡ºç°åœ¨æœ€ç»ˆçš„å¸ƒå±€ä¸­ï¼Œä¼š unscrap å®ƒï¼Œè®©å®ƒæ‰§è¡Œä¸€ä¸ªæ¶ˆå¤±çš„åŠ¨ç”»ç„¶åéšè—ã€‚åŠ¨ç”»æ‰§è¡Œå®Œä¹‹åï¼Œb è¢«æ”¾åˆ° RecyclerViewPool ä¸­ã€‚</p>
<p>ä¸ºä»€ä¹ˆ LayoutManager éœ€è¦å…ˆæ‰§è¡Œ detachï¼Œç„¶åå†é‡æ–° attach è¿™äº› viewï¼Œè€Œä¸æ˜¯åªç§»é™¤å“ªäº›å˜åŒ–çš„å­ view å‘¢ï¼ŸScrap ç¼“å­˜åˆ—è¡¨çš„å­˜åœ¨ï¼Œæ˜¯ä¸ºäº†éš”ç¦» LayoutManager å’Œ RecyclerView.Recycler ä¹‹é—´çš„å…³æ³¨ç‚¹/èŒè´£ã€‚LayoutManager ä¸éœ€è¦çŸ¥é“å“ªä¸€ä¸ªå­ view åº”è¯¥ä¿ç•™ æˆ–è€…æ˜¯ åº”è¯¥è¢«å›æ”¶åˆ° pool äº¦æˆ–è€…å…¶ä»–ä»€ä¹ˆåœ°æ–¹ã€‚è¿™æ˜¯ Recycler çš„èŒè´£ã€‚</p>
<p>é™¤äº†åœ¨å¸ƒå±€æ—¶ä¸ä¸ºç©ºå¤–ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªä¸ scrap æœ‰å…³çš„è§„å¾‹ï¼šæ‰€æœ‰ scrap çš„ view éƒ½ä¼šè·Ÿ RecyclerView åˆ†ç¦»ã€‚ViewGroup ä¸­çš„ attachView å’Œ detachView æ–¹æ³•è·Ÿ addView å’Œ removeView æ–¹æ³•å¾ˆåƒï¼Œä½†æ˜¯ä¸ä¼šè§¦å‘è¯·æ±‚å¸ƒå±€ä¼šé‡ç»˜çš„äº‹ä»¶ã€‚å®ƒä»¬åªæ˜¯ä» ViewGroup çš„å­ view åˆ—è¡¨ä¸­åˆ é™¤å¯¹åº”çš„å­ viewï¼Œå¹¶å°†è¯¥å­ view çš„ parent è®¾ç½®ä¸º nullã€‚detached çŠ¶æ€å¿…é¡»æ˜¯ä¸´æ—¶ï¼Œåé¢ç´§éšç€ attach æˆ–è€… remove äº‹ä»¶</p>
<p>å¦‚æœåœ¨è®¡ç®—ä¸€ä¸ªæ–°å¸ƒå±€çš„æ—¶å€™ï¼Œå·²ç»æ·»åŠ äº†ä¸€å †å­ viewï¼Œå¯ä»¥æ”¾å¿ƒçš„å°†å®ƒä»¬å…¨éƒ¨ detach ï¼ŒRecyclerview å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚</p>
<h3 id="Attached-vs-Changed-scrap"><a href="#Attached-vs-Changed-scrap" class="headerlink" title="Attached vs Changed scrap"></a>Attached vs Changed scrap</h3><p>Recycler ç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå•ç‹¬çš„ scrap å®¹å™¨: mAttachedScrap å’Œ mChangedScrapã€‚ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªå‘¢ï¼Ÿ</p>
<p>ViewHolder åªæœ‰åœ¨æ»¡è¶³ä¸‹é¢æƒ…å†µæ‰ä¼šè¢«æ·»åŠ åˆ° mChangedScrapï¼šå½“å®ƒå…³è”çš„ item å‘ç”Ÿäº†å˜åŒ–ï¼ˆnotifyItemChanged æˆ–è€… notifyItemRangeChanged è¢«è°ƒç”¨ï¼‰ï¼Œå¹¶ä¸” ItemAnimator è°ƒç”¨ ViewHolder#canReuseUpdatedViewHolder æ–¹æ³•æ—¶ï¼Œè¿”å›äº† falseã€‚å¦åˆ™ï¼ŒViewHolder ä¼šè¢«æ·»åŠ åˆ°AttachedScrap ä¸­ã€‚</p>
<p>canReuseUpdatedViewHolder è¿”å› â€œfalseâ€ è¡¨ç¤ºæˆ‘ä»¬è¦æ‰§è¡Œç”¨ä¸€ä¸ª view æ›¿æ¢å¦ä¸€ä¸ª view çš„åŠ¨ç”»ï¼Œä¾‹å¦‚æ·¡å…¥æ·¡å‡ºåŠ¨ç”»ã€‚ â€œtrueâ€è¡¨ç¤ºåŠ¨ç”»åœ¨ view å†…éƒ¨å‘ç”Ÿã€‚</p>
<p>mAttachedScrap åœ¨ æ•´ä¸ªå¸ƒå±€è¿‡ç¨‹ä¸­éƒ½èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯ changed scrap â€” åªèƒ½åœ¨é¢„å¸ƒå±€é˜¶æ®µä½¿ç”¨ã€‚</p>
<p>è¿™æ˜¯æœ‰é“ç†çš„ï¼šåœ¨å¸ƒå±€åï¼Œæ–°çš„ ViewHolder åº”è¯¥æ›¿æ¢æ‰â€œæ”¹å˜äº†çš„â€è§†å›¾ï¼Œå› æ­¤ AttachedScrap åœ¨å¸ƒå±€åæ˜¯æ²¡æœ‰ç”¨çš„ã€‚ æ›´æ”¹åŠ¨ç”»æ‰§è¡Œå®Œæˆåï¼Œchange scrap å°†æŒ‰é¢„æœŸæ–¹å¼è½¬å­˜åˆ° pool ä¸­</p>
<p>é»˜è®¤çš„ ItemAnimator å¯ä»¥åœ¨ 3 ç§æƒ…å†µä¸‹é‡ç”¨æ›´æ–°çš„ ViewHolderï¼š</p>
<ul>
<li>è°ƒç”¨äº† setSupportsChangeAnimations(false)ã€‚</li>
<li>è°ƒç”¨äº† notifyDataSetChanged è€Œä¸æ˜¯ notifyItemChanged æˆ– notifyItemRangeChanged ã€‚</li>
<li>æä¾›äº†è¿™æ ·çš„æ›´æ”¹ payloadï¼šadapter.notifyItemChanged(indexï¼ŒanyObject)ã€‚</li>
</ul>
<p>æœ€åä¸€ç§æƒ…å†µæ˜¾ç¤ºäº†ä¸€ç§å¾ˆå¥½çš„æ–¹æ³•ï¼Œå½“åªæƒ³æ›´æ”¹ä¸€äº›å†…éƒ¨å…ƒç´ æ—¶ï¼Œå¯ä»¥é¿å…åˆ›å»º/ç»‘å®šæ–°çš„ ViewHolderã€‚</p>
<h3 id="Hidden-Views-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Hidden-Views-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Hidden Views æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Hidden Views æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>å‰é¢æåˆ°åœ¨ç¬¬äºŒæ¬¡å°è¯•è·å– ViewHolder çš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªå­æ­¥éª¤ä¼šä» hidden view ä¸­æœç´¢ï¼Œè¿™é‡Œçš„ hidden view æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿã€Œhidden viewã€æŒ‡çš„æ˜¯é‚£äº›æ­£åœ¨ä» RecyclerView è¾¹ç•Œä¸­è„±ç¦»çš„ viewã€‚ä¸ºäº†è®©è¿™äº› view æ­£ç¡®åœ°æ‰§è¡Œå¯¹åº”çš„åˆ†ç¦»åŠ¨ç”»ï¼Œå®ƒä»¬ä»ç„¶ä½œä¸º RecyclerView çš„å­ view è¢«ä¿ç•™ä¸‹æ¥ã€‚</p>
<p>ç«™åœ¨ LayoutManager çš„è§’åº¦ï¼Œè¿™äº› view å·²ç»ä¸å­˜åœ¨äº†ï¼Œå› æ­¤ä¸åº”è¯¥è¢«åŒ…å«åœ¨è®¡ç®—é‡Œé¢ã€‚æ¯”å¦‚ åœ¨éƒ¨åˆ† view æ­£åœ¨æ‰§è¡Œæ¶ˆå¤±åŠ¨ç”»çš„è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ LayoutManager#getChildAt æ–¹æ³•ï¼Œè¿™äº› view ä¸ç®—åœ¨ä¸‹æ ‡é‡Œé¢ã€‚æ¥è‡ª LayoutManager çš„æ‰€æœ‰å¯¹ getChildAt()ã€getChildCount()ã€addView() ç­‰çš„æ–¹æ³•è°ƒç”¨ åœ¨åº”ç”¨åˆ°å®é™…çš„å¯å›æ”¶view ä¹‹å‰ï¼Œéƒ½è¦é€šè¿‡ ChildHelper å¤„ç†ï¼ŒChildHelper çš„èŒè´£æ˜¯é‡æ–°è®¡ç®—ééšè—çš„å­ view åˆ—è¡¨å’Œå®Œæ•´çš„å­ view åˆ—è¡¨ä¹‹é—´çš„ç´¢å¼•ã€‚</p>
<p>è¯·è®°ä½ï¼Œæˆ‘ä»¬æ­£åœ¨æœç´¢è¦æä¾›ç»™ LayoutManager çš„è§†å›¾ï¼Œ<strong>ä½†æ˜¯ LayoutManager ä¸åº”äº†è§£éšè— View</strong>ï¼</p>
<p>ä¸¾ä¸€ä¸ªå®é™…çš„ğŸŒ°ï¼šè¿™ç§è®©äººè´¹è§£çš„â€œä»éšè—çš„ view å¼¹è·³â€ï¼ˆbouncing from hidden viewsï¼‰æœºåˆ¶å¯¹äºå¤„ç†ä¸‹é¢è¿™ç§æƒ…å†µè€Œè¨€æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ è€ƒè™‘è¿™ç§åœºæ™¯ï¼Œæˆ‘ä»¬æ’å…¥ä¸€ä¸ª item ï¼Œç„¶ååœ¨æ’å…¥åŠ¨ç”»å®Œæˆä¹‹å‰ï¼Œé©¬ä¸Šåˆ é™¤è¯¥ itemï¼š</p>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/hiddenview.png" alt="img"></p>
<p>æˆ‘ä»¬æƒ³è¦çœ‹åˆ°çš„æ˜¯ b ä» c ç§»é™¤æ—¶çš„ä½ç½®å¼€å§‹å‘ä¸Šå¹³ç§»ã€‚ ä½†æ˜¯åœ¨é‚£ä¸ªæ—¶å€™ï¼Œb æ˜¯ä¸€ä¸ªéšè—çš„ viewï¼ å¦‚æœæˆ‘ä»¬å¿½ç•¥äº†å®ƒï¼ˆâ€œéšè—â€çš„ bï¼‰ï¼Œé‚£ä¼šå¯¼è‡´åœ¨ç°æœ‰ b ä¸‹é¢åˆ›å»ºä¸€ä¸ªæ–°çš„ bã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ª view ä¼šé‡å ï¼Œå› ä¸º æ–°çš„ b ä¼šå¾€ä¸Šï¼Œæ—§çš„ b ä¼šå¾€ä¸‹ã€‚ ä¸ºäº†é¿å…è¿™ç§é”™è¯¯ï¼Œåœ¨æœç´¢ ViewHolder çš„è¾ƒæ—©æ­¥éª¤ä¹‹ä¸€ä¸­ï¼ŒRecyclerView ä¼šè¯¢é—® ChildHelper æ˜¯å¦å…·æœ‰åˆé€‚çš„ hidden viewã€‚ æ‰€è°“ã€Œåˆé€‚ã€ï¼Œè¡¨ç¤ºè¿™ä¸ª view è·Ÿæˆ‘ä»¬éœ€è¦çš„ä½ç½®ç›¸å…³è”ï¼Œå¹¶å…·æœ‰æ­£ç¡®çš„ view typeï¼Œå¹¶ä¸”è¿™ä¸ª view çš„è¢«éšè—çš„åŸå› ä¸æ˜¯ä¸ºäº†ç§»é™¤æ‰å®ƒï¼ˆæˆ‘ä»¬ä¸åº”è¯¥è®©è¢«ç§»é™¤çš„ view å¤æ´»ï¼‰</p>
<p>å¦‚æœæœ‰è¿™æ ·çš„ view ï¼ŒRecyclerView ä¼šå°†å…¶è¿”å›åˆ° LayoutManager å¹¶å°†å…¶æ·»åŠ åˆ° preLayout ä¸­ä»¥æ ‡è®°åº”ä»å…¶è¿›è¡ŒåŠ¨ç”»å¤„ç†çš„ä½ç½®ï¼ˆè¯¦è§ recordAnimationInfoIfBouncedHiddenView æ–¹æ³•ï¼‰ã€‚ </p>
<p>ä»€ä¹ˆï¼Ÿåœ¨ å¸ƒå±€å‰å æ·»åŠ å†…å®¹ä¸åº”è¯¥æ˜¯ LayoutManager çš„èŒè´£å—ï¼Ÿæ€ä¹ˆç°åœ¨ RecyclerView ä¹Ÿåœ¨å¾€ preLayout ä¸­æ·»åŠ viewï¼Ÿ  æ˜¯çš„ï¼Œè¿™ç§æœºåˆ¶çœ‹èµ·æ¥æœ‰ç‚¹èŒè´£éƒ¨åˆ†ï¼Œä½†è¿™æ˜¯ä¹Ÿè¯´æ˜æˆ‘ä»¬æœ‰å¿…è¦äº†è§£å®ƒã€‚</p>
<h3 id="Stable-Id-çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Stable-Id-çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Stable Id çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Stable Id çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>ç†è§£ stable Id ç‰¹æ€§çš„æœ€é‡è¦çš„ä¸€ä¸ªç‚¹æ˜¯ï¼Œå®ƒåªä¼šåœ¨è°ƒç”¨ notifyDataSetChanged æ–¹æ³•ä¹‹åï¼Œå½±å“ RecyclerView çš„è¡Œä¸ºã€‚</p>
<p>å¦‚æœè°ƒç”¨ notifyDataSetChanged çš„æ—¶å€™ï¼ŒAdapter å¹¶æ²¡æœ‰è®¾ç½® hasStableIdï¼ŒRecyclerView ä¸çŸ¥é“ å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå“ªä¸€äº›ä¸œè¥¿å˜åŒ–äº†ï¼Œæ‰€ä»¥ï¼Œå®ƒå‡è®¾æ‰€æœ‰çš„ä¸œè¥¿éƒ½å˜äº†ï¼Œæ¯ä¸€ä¸ª ViewHolder éƒ½æ˜¯æ— æ•ˆçš„ï¼Œå› æ­¤åº”è¯¥æŠŠå®ƒä»¬æ”¾åˆ° RecyclerViewPool è€Œä¸æ˜¯ scrap ä¸­ã€‚</p>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/stable.png" alt="img"></p>
<p>å¦‚æœæœ‰ Stable Idï¼Œé‚£é‚£å°†ä¼šæ˜¯åƒä¸‹é¢è¿™æ ·ï¼š</p>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/hasstableid.png" alt="img"></p>
<p>ViewHolder ä¼šè¿›å…¥ scrap è€Œä¸æ˜¯ pool ä¸­ã€‚ç„¶åä¼šé€šè¿‡ç‰¹å®šçš„ Idï¼ˆAdapter ä¸­çš„ getItemId è·å–åˆ°çš„ idï¼‰è€Œä¸æ˜¯ postion åˆ° scrap ä¸­æŸ¥æ‰¾ ViewHolderã€‚</p>
<p>å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ol>
<li>ä¸ä¼šå¯¼è‡´ RecyclerViewPool æº¢å‡ºï¼Œå› æ­¤éå¿…é¡»æƒ…å†µä¸‹ï¼Œä¸éœ€è¦åˆ›å»ºæ–°çš„ ViewHolderã€‚ä¹‹å‰çš„ ViewHolder ä¼šé‡æ–°ç»‘å®šï¼Œå› ä¸º Id æ²¡æœ‰å˜åŒ–ä¸ä»£è¡¨å†…å®¹æ²¡æœ‰å˜åŒ–</li>
<li>æœ€å¤§å¥½å¤„çš„å¥½å¤„æ˜¯ æ”¯æŒåŠ¨ç”»ã€‚ä¸Šé¢ç§»åŠ¨ item4 åˆ° item6 çš„ä½ç½®ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ notifyItemMoved(4,6) æ‰èƒ½å¾—åˆ°ä¸€ä¸ªç§»åŠ¨åŠ¨ç”»ã€‚ä½†æ˜¯é€šè¿‡ stable idï¼Œè°ƒç”¨ notifyDataSetChanged ä¹Ÿèƒ½æ”¯æŒè¿™ä¸€ç‚¹ã€‚å› ä¸º RecyclerView å¯ä»¥çœ‹åˆ°ç‰¹å®š id çš„ view åœ¨æ–°æ—§å¸ƒå±€çš„ä¸Šçš„ä½ç½®ï¼Œ<ul>
<li>è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„åŠ¨ç”»åªæ”¯æŒç®€å•çš„åŠ¨ç”»ï¼Œé¢„æµ‹åŠ¨ç”»æ— æ³•æ”¯æŒã€‚ å¦‚æœæˆ‘ä»¬åœ¨æ–°å¸ƒå±€ä¸­çœ‹åˆ°ä¸€äº› IDï¼Œè€Œåœ¨æ—§å¸ƒå±€ä¸­æ²¡æœ‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•çŸ¥é“å®ƒæ˜¯æ–°æ’å…¥çš„ item è¿˜æ˜¯ä»æŸå¤„ç§»å…¥çš„ itemï¼Œåœ¨åä¸€ç§æƒ…å†µä¸‹å®ƒç©¶ç«Ÿæ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ é€šå¸¸ï¼Œè¿™äº›é—®é¢˜çš„ç­”æ¡ˆä¼šåœ¨é¢„å¸ƒå±€ä¸­æ‰¾åˆ°ï¼Œæ ¹æ®é€‚é…å™¨çš„æ›´æ”¹ï¼Œè¯¥å¸ƒå±€å·²è¶…å‡º RecyclerView çš„èŒƒå›´ï¼Œä½†ç°åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ æˆ‘ä»¬ä¸çŸ¥é“è¿™äº›æ›´æ”¹å…·ä½“æ˜¯ä»€ä¹ˆ</li>
</ul>
</li>
</ol>
<p>æ€»ä½“è€Œè¨€ï¼Œstable id çš„ä½¿ç”¨åœºæ™¯ä¼¼ä¹æ¯”è¾ƒæœ‰é™ã€‚ ä¸è¿‡ï¼Œè¿˜æ˜¯æœ‰è¿™æ ·ä¸€ä¸ªä½¿ç”¨åœºæ™¯ï¼šå¦‚æœæ˜¯ä» ListView è¿ç§»åˆ° RecyclerViewï¼Œå°†æ‰€æœ‰ notifyDataSetChanged è°ƒç”¨ï¼Œéƒ½è½¬æ¢ä¸ºç‰¹å®šæ›´æ”¹çš„é€šçŸ¥å¯èƒ½ä¼šå¾ˆç—›è‹¦ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œstable id å¯ä»¥æä¾›ç»™ä½ æä¾›ç®€å•çš„ RecyclerView åŠ¨ç”»ã€‚</p>
<h2 id="ç¼“å­˜ä¼˜åŒ–å®è·µ"><a href="#ç¼“å­˜ä¼˜åŒ–å®è·µ" class="headerlink" title="ç¼“å­˜ä¼˜åŒ–å®è·µ"></a>ç¼“å­˜ä¼˜åŒ–å®è·µ</h2><ul>
<li><p>å°½é‡ä½¿ç”¨ notifyItemXxx æ–¹æ³•è¿›è¡Œç»†ç²’åº¦çš„é€šçŸ¥æ›´æ–°ï¼Œè€Œä¸æ˜¯ notifyDatasetChanged</p>
<ul>
<li>å¦‚æœå˜æ›´å‰åæ˜¯ä¸¤ä¸ªæ•°æ®é›†ï¼Œæ— æ³•ç¡®å®šå…·ä½“å“ªä¸€äº›æ•°æ®é¡¹å˜åŒ–äº†ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/recyclerview/widget/DiffUtil" target="_blank" rel="noopener">DiffUtil</a> ã€‚</li>
<li>å¦‚æœæ•°æ®é›†è¾ƒå¤§ï¼Œå»ºè®®ç»“åˆä½¿ç”¨ <a href="https://developer.android.google.cn/reference/androidx/recyclerview/widget/AsyncListDiffer" target="_blank" rel="noopener">AsyncListDiffer</a> åœ¨å­çº¿ç¨‹åš diff è¿ç®—ã€‚</li>
</ul>
</li>
<li><p>å¦‚æœç‰¹å®š viewType çš„ item åªæœ‰ä¸€ä¸ªï¼Œå¯ä»¥é€šè¿‡ <code>RecyclerView#getRecycledViewPool()#setMaxRecycledViews(viewType,1);</code> æ¥è°ƒæ•´ç¼“å­˜åŒºçš„å¤§å°ï¼Œå‡å°‘å†…å­˜å ç”¨</p>
</li>
<li><p>å¦‚æœç‰¹å®š viewType çš„ item ç‰¹åˆ«å¤šï¼Œä½†æ˜¯ä¸å¾—ä¸é€šè¿‡ notifyDataSetChange æ–¹æ³•æ›´æ–°æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢è¿™ç§æ–¹å¼ï¼Œåœ¨å˜æ›´å‰è°ƒå¤§ç¼“å­˜ï¼Œå˜æ›´å®Œæˆåï¼Œè°ƒå°ç¼“å­˜ã€‚è¿™æ ·å¸ƒå±€å˜åŒ–ä¹Ÿå¯ä»¥æœ€å¤§ç¨‹åº¦åœ°å¤ç”¨å·²æœ‰çš„ ViewHolderã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mRecyclerView.getRecycledViewPool().setMaxRecycledViews(<span class="number">0</span>, å±å¹•æ˜¾ç¤ºçš„itemæ€»æ•°+<span class="number">7</span> );</div><div class="line">mAdapter.notifyDataSetChanged();</div><div class="line"><span class="keyword">new</span> Handler().post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        mRecyclerView.getRecycledViewPool()</div><div class="line">                .setMaxRecycledViews(<span class="number">0</span>, <span class="number">5</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>å¦‚æœ RecyclerView ä¸­çš„æ¯ä¸ª item éƒ½æ˜¯ä¸€ä¸ª RecyclerViewï¼Œ å¹¶ä¸”å­ RecyclerView çš„ item type ç›¸åŒå¯ä»¥é€šè¿‡ RecyclerView#setRecycledViewPool(); æ–¹æ³•ï¼Œå®ç°ç¼“å­˜æ± çš„å¤ç”¨ã€‚<img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/image-RecyclerViewpool-reuse.png" alt=""></p>
</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://android.jlelse.eu/anatomy-of-recyclerview-part-1-a-search-for-a-viewholder-404ba3453714" target="_blank" rel="noopener">https://android.jlelse.eu/anatomy-of-recyclerview-part-1-a-search-for-a-viewholder-404ba3453714</a></li>
<li><a href="http://www.programmersought.com/article/4558924504/" target="_blank" rel="noopener">http://www.programmersought.com/article/4558924504/</a></li>
<li><a href="https://juejin.im/post/5b79a0b851882542b13d204b" target="_blank" rel="noopener">https://juejin.im/post/5b79a0b851882542b13d204b</a></li>
<li><a href="https://juejin.im/post/5c696ba9e51d457f136d24ff" target="_blank" rel="noopener">https://juejin.im/post/5c696ba9e51d457f136d24ff</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[Android ä¸­æ›´æ–° UI çš„çº¿ç¨‹é™åˆ¶é—®é¢˜æ¢ç©¶]]></title>
      <url>https://timlin-pro.github.io/blog/2020/04/18/Android%20%E4%B8%AD%E6%9B%B4%E6%96%B0%20UI%20%E7%9A%84%E7%BA%BF%E7%A8%8B%E9%99%90%E5%88%B6%E9%97%AE%E9%A2%98%E6%8E%A2%E7%A9%B6/</url>
      <content type="html"><![CDATA[<h2 id="Android-ä¸­å­çº¿ç¨‹çœŸçš„ä¸èƒ½æ›´æ–°-UI-å—ï¼Ÿ"><a href="#Android-ä¸­å­çº¿ç¨‹çœŸçš„ä¸èƒ½æ›´æ–°-UI-å—ï¼Ÿ" class="headerlink" title="Android ä¸­å­çº¿ç¨‹çœŸçš„ä¸èƒ½æ›´æ–° UI å—ï¼Ÿ"></a>Android ä¸­å­çº¿ç¨‹çœŸçš„ä¸èƒ½æ›´æ–° UI å—ï¼Ÿ</h2><p>å…ˆè¯´ç»“è®ºï¼šAndroid ä¸­å­çº¿ç¨‹åœ¨æ»¡è¶³ä¸€å®šçš„æ¡ä»¶ä¸‹å¯ä»¥æ›´æ–° UIã€‚</p>
<ul>
<li>åœ¨ ViewRootImpl è¿˜æ²¡åˆ›å»ºå‡ºæ¥ä¹‹å‰<ul>
<li>UI ä¿®æ”¹çš„æ“ä½œæ²¡æœ‰çº¿ç¨‹é™åˆ¶ã€‚</li>
</ul>
</li>
<li>åœ¨ ViewRootImpl åˆ›å»ºå®Œæˆä¹‹å<ol>
<li>ä¿è¯ã€Œåˆ›å»º ViewRootImpl çš„æ“ä½œã€å’Œã€Œæ‰§è¡Œä¿®æ”¹ UI çš„æ“ä½œã€åœ¨åŒä¸€ä¸ªçº¿ç¨‹å³å¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ ViewManager#addView å’Œ ViewManager#updateViewLayout çš„æ–¹æ³•ã€‚<ul>
<li>æ³¨ï¼šViewManager æ˜¯ä¸€ä¸ªæ¥å£ï¼ŒWindowManger æ¥å£ç»§æ‰¿äº†è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½æ˜¯é€šè¿‡ WindowMangerï¼ˆå…·ä½“å®ç°ä¸º WindowMangerImplï¼‰ è¿›è¡Œ view çš„ add remove update æ“ä½œçš„ã€‚</li>
</ul>
</li>
<li>å¯¹åº”çš„çº¿ç¨‹éœ€è¦åˆ›å»º Looper å¹¶ä¸”è°ƒç”¨ Looper#loop æ–¹æ³•ï¼Œå¼€å¯æ¶ˆæ¯å¾ªç¯ã€‚</li>
</ol>
</li>
</ul>
<a id="more"></a>
<h2 id="ä¸€ä¸ªæ —å­ï¼š"><a href="#ä¸€ä¸ªæ —å­ï¼š" class="headerlink" title="ä¸€ä¸ªæ —å­ï¼š"></a>ä¸€ä¸ªæ —å­ï¼š</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ImageView mImageView;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">      	mImageView = (ImageView)findViewById(R.id.iv);</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				mImageView.setImageResource(R.drawable.ic_book);<span class="comment">//æ›´æ–° ui</span></div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚ä¸Šåœ¨ onCreate æ–¹æ³•ä¸­æ–°å»ºä¸€ä¸ªçº¿ç¨‹å¯¹ mImageView è¿›è¡Œäº†æ“ä½œï¼ŒæˆåŠŸä»å­çº¿ç¨‹æ›´æ–°äº† uiã€‚</p>
<p>ä½†æ˜¯å¦‚æœè®©çº¿ç¨‹ sleep ä¸€æ®µæ—¶é—´ï¼ˆæ¯”å¦‚ 300msï¼‰ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Thread.sleep(<span class="number">300</span>);<span class="comment">//ç¡çœ  300 ms</span></div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        mImageView.setImageResource(R.drawable.ic_book);<span class="comment">//æ›´æ–° ui</span></div><div class="line">    &#125;</div><div class="line">&#125;).start();</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå°±å¾ˆå¯èƒ½ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š(å¦‚æœ 300ms ä¸æŠ¥é”™ï¼Œå¯å°†å…¶æ”¹ä¸º 1000ms)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">android.view.ViewRootImpl$CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views.</div><div class="line">    at android.view.ViewRootImpl.checkThread(ViewRootImpl.java:<span class="number">7194</span>)</div><div class="line">    at android.view.ViewRootImpl.invalidateChildInParent(ViewRootImpl.java:<span class="number">1111</span>)</div><div class="line">    at android.view.ViewGroup.invalidateChild(ViewGroup.java:<span class="number">4833</span>)</div><div class="line">    at android.view.View.invalidateInternal(View.java:<span class="number">12102</span>)</div><div class="line">    at android.view.View.invalidate(View.java:<span class="number">12062</span>)</div><div class="line">    at android.view.View.invalidate(View.java:<span class="number">12046</span>)</div><div class="line">    at android.widget.ImageView.setImageDrawable(ImageView.java:<span class="number">456</span>)</div><div class="line">    at android.support.v7.widget.AppCompatImageView.setImageDrawable(AppCompatImageView.java:<span class="number">100</span>)</div><div class="line">    at android.support.v7.widget.AppCompatImageHelper.setImageResource(AppCompatImageHelper.java:<span class="number">89</span>)</div><div class="line">    at android.support.v7.widget.AppCompatImageView.setImageResource(AppCompatImageView.java:<span class="number">94</span>)</div><div class="line">    at com.android.rdc.librarysystem.MainActivity$<span class="number">1</span>.run(MainActivity.java:<span class="number">52</span>)</div><div class="line">    at java.lang.Thread.run(Thread.java:<span class="number">818</span>)</div></pre></td></tr></table></figure>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>è¯¥å¼‚å¸¸æ˜¯ä»å“ªé‡ŒæŠ›å‡ºçš„ï¼Ÿ   </p>
<p>ä»å‡ºé”™çš„å †æ ˆä¿¡æ¯ä¸­å¯ä»¥å¼‚å¸¸çœ‹åˆ°æ˜¯ <code>ViewRootImpl#checkThread()</code> æ–¹æ³•ä¸­æŠ›å‡ºçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CalledFromWrongThreadException(</div><div class="line">                <span class="string">"Only the original thread that created a view hierarchy can touch its views."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“è®¿é—® UI æ—¶ï¼ŒViewRootImpl ä¼šè°ƒç”¨ checkThread æ–¹æ³•å»æ£€æŸ¥å½“å‰è®¿é—® UI çš„çº¿ç¨‹æ˜¯å¦ä¸ºåˆ›å»º UI çš„é‚£ä¸ªçº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯ã€‚åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ä½†æ˜¯<strong>ä¸ºä»€ä¹ˆä¸€å¼€å§‹åœ¨ MainActivity çš„ onCreate æ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹è®¿é—® UIï¼Œç¨‹åºè¿˜æ˜¯æ­£å¸¸èƒ½è·‘èµ·æ¥å‘¢</strong>ï¼Ÿ    </p>
<blockquote>
<p>  ä¸Šè¿°ä¾‹å­ä¸­çš„ Thread æ‰§è¡Œæ—¶ï¼ŒViewRootImpl è¿˜æ²¡åˆ›å»ºï¼ŒViewRootImpl æ— æ³•å¯¹ view tree çš„æ ¹èŠ‚ç‚¹ DecorView æ‰§è¡Œ performTraversalsï¼Œview tree é‡Œçš„æ‰€æœ‰ View éƒ½æ²¡æœ‰è¢«èµ‹å€¼ mAttachInfoï¼ˆæ³¨ï¼šAttachInfo ä¸­å­˜å‚¨äº†ä¸€ç»„ä¿¡æ¯ã€‚å½“ View è¢«è¿æ¥åˆ°å®ƒçš„çˆ¶èŠ‚ç‚¹æ—¶ï¼Œä¼šç»™è¿™ä¸ª View çš„ AttachInfo èµ‹å€¼ï¼‰ã€‚</p>
<p>  åœ¨ onCreate å®Œæˆæ—¶ï¼ŒActivity å¹¶æ²¡æœ‰å®Œæˆåˆå§‹åŒ– view treeã€‚<strong>view tree çš„åˆå§‹åŒ–æ˜¯ä» ViewRootImpl æ‰§è¡Œ performTraversals å¼€å§‹</strong>ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå¯¹ view tree è¿›è¡Œä»æ ¹èŠ‚ç‚¹ DecorView å¼€å§‹çš„éå†ï¼Œå¯¹æ‰€æœ‰è§†å›¾å®Œæˆåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–åŒ…æ‹¬è§†å›¾çš„å¤§å°å¸ƒå±€ï¼Œä»¥åŠ AttachInfoï¼ŒViewParent ç­‰å±æ€§åŸŸçš„åˆå§‹åŒ–ã€‚</p>
</blockquote>
<p><code>ImageView#setImageResource</code>è§¦å‘çš„è°ƒç”¨æµç¨‹ </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">ImageView#setImageResource </div><div class="line">  --&gt;  å¦‚æœæœ€æ–°èµ„æºçš„å®½åº¦æˆ–è€…é«˜åº¦è·Ÿå·²æœ‰çš„ä¸åŒï¼Œ</div><div class="line">  	--&gt; View#requestLayout</div><div class="line">  		--&gt; æ»¡è¶³æ¡ä»¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ ViewRootImpl#requestLayout</div><div class="line">	--&gt;  View#invalidate </div><div class="line">		--&gt;  View#invalidate(boolean)</div><div class="line">      		--&gt;  View#invalidateInternal //å¦‚æœ </div><div class="line">  			if mAttachInfo ä»¥åŠ mParent éƒ½ä¸ä¸ºç©º</div><div class="line">      			--&gt; ViewGroup#invalidateChild</div><div class="line">      				//è¿™é‡Œä¼šä¸æ–­å¾ªç¯å»å–ä¸Šä¸€ä¸ªç»“ç‚¹çš„ mParent,ä¸€ç›´åˆ° mParent == null ä¹Ÿå°±æ˜¯åˆ°è¾¾é¡¶éƒ¨ View ä¸ºæ­¢</div><div class="line">                        --&gt;  ViewRootImpl#invalidateChildInParent // æ³¨æ„ DecorView çš„ mParent æ˜¯ ViewRootImpl</div><div class="line">                            --&gt;  ViewRootImpl#checkThread //åœ¨è¿™é‡Œæ‰§è¡Œ checkThreadï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯åˆ›å»º UI çš„çº¿ç¨‹åˆ™æŠ›å‡ºå¼‚å¸¸</div><div class="line">             else</div><div class="line">        </div><div class="line">----------------------------------------------------------------------</div><div class="line">//View#invalidateInternal </div><div class="line"></div><div class="line">final AttachInfo ai = mAttachInfo;</div><div class="line">final ViewParent p = mParent;</div><div class="line">//åªæœ‰å½“ mAttachInfo ä»¥åŠ mParent éƒ½ä¸ä¸ºç©ºæ—¶ï¼Œæ‰ä¼šè§¦å‘é‡ç»˜</div><div class="line">if (p != null &amp;&amp; ai != null &amp;&amp; l &lt; r &amp;&amp; t &lt; b) &#123;</div><div class="line">    //....</div><div class="line">    p.invalidateChild(this, damage);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šè¿°æµç¨‹å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰åœ¨ mAttachInfo ä»¥åŠ mParent éƒ½ä¸ä¸ºç©ºæ—¶ï¼Œ <code>ViewGroup#invalidateChild</code> æ‰ä¼šè¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•æœ€ç»ˆä¼šè§¦å‘ checkThreadï¼Œè€Œå‘ä¸Šé¢æ‰€æåˆ°çš„ï¼Œ onCreate æ–¹æ³•è°ƒç”¨æ—¶ ViewRootImpl è¿˜æœªåˆ›å»ºï¼Œ mAttachInfo ä»¥åŠ mParent å‡ä¸º nullï¼Œæ‰€ä»¥åœ¨å­çº¿ç¨‹ä¿®æ”¹ UI ä¸ä¼šæŠ¥é”™ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªæ—¶å€™å¯¹ View çš„ä¿®æ”¹æ˜¯æœ‰æ•ˆæœçš„ã€‚é‚£ä¹ˆï¼ŒViewRootImpl åˆ›å»ºä¹‹å‰çš„ï¼Œç¨‹åºå¯¹ UI çš„æ›´æ–°æ“ä½œæ˜¯å¦‚ä½•è¿›è¡Œçš„å‘¢ï¼Ÿåœ¨æœ€åˆçš„<code>ImageView#setImageResource</code> æ–¹æ³•ä¸­å·²ç»å°†è¦å›¾ç‰‡èµ„æº id èµ‹ç»™äº†ImageView çš„ä¸€ä¸ªå±æ€§ mResource ï¼Œç­‰åˆ° ViewRootImpl  åˆ›å»ºå®Œæ¯•ä¹‹åå°±å¯ä»¥å¾—åˆ°æ›´æ–°äº†ã€‚</p>
<h3 id="ViewRootImpl-ä½•æ—¶è¢«åˆ›å»ºï¼Ÿ"><a href="#ViewRootImpl-ä½•æ—¶è¢«åˆ›å»ºï¼Ÿ" class="headerlink" title="ViewRootImpl ä½•æ—¶è¢«åˆ›å»ºï¼Ÿ"></a>ViewRootImpl ä½•æ—¶è¢«åˆ›å»ºï¼Ÿ</h3><p>å›è¿‡å¤´çœ‹ï¼ŒæŠ›å¼‚å¸¸çš„æ–¹æ³•æ—¢ç„¶æ˜¯ ViewRootImpl ä¸­çš„æ–¹æ³•ï¼Œé‚£é¦–å…ˆåº”è¯¥å»çœ‹çœ‹ ViewRootImpl æ˜¯åœ¨å“ªé‡Œã€åœ¨ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºçš„ã€‚</p>
<p>å¦‚æœä½ å¯¹ Activity çš„å¯åŠ¨æµç¨‹æœ‰æ‰€äº†è§£ï¼Œåº”è¯¥çŸ¥é“ï¼ŒActivity çš„å¯åŠ¨ä¸ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯ç”± ActivityThread ç›¸åº”çš„æ–¹æ³•è§¦å‘çš„ã€‚æˆ‘ä»¬çŸ¥é“æ¯ä¸€ä¸ª Activity éƒ½æœ‰ä¸€ä¸ªé¡¶çº§ View â€”â€”DecorViewï¼Œå½“ Activity ä¸­çš„è§†å›¾æ˜¾ç¤ºå‡ºæ¥çš„æ—¶å€™ DecorView è‚¯å®šå·²ç»åˆ›å»ºå®Œæ¯•äº†ã€‚è€Œ ViewRootImpl ä½œä¸º DecorView ä¸ WindowManager ä¹‹é—´çš„ã€Œæ¡¥æ¢ã€ï¼Œåº”è¯¥ä¹Ÿæ˜¯åœ¨è§†å›¾å˜å¾—å¯è§ä¹‹å‰è¢«åˆ›å»ºå‡ºæ¥çš„ã€‚è¯´åˆ°è§†å›¾å¯è§ä¸å¦ï¼Œä¸€èˆ¬éƒ½ä¼šæƒ³èµ· onResumeï¼ˆå®é™…ä¸Š onResume è°ƒç”¨æ—¶ï¼ŒActivity çš„è§†å›¾ä¹Ÿä¸ä¸€å®šå¯è§ï¼‰ã€‚</p>
<p>ä»<code>ActivityThread#handleLaunchActivity</code> æ–¹æ³•å‡ºå‘ï¼ŒæŸ¥çœ‹å…¶è°ƒç”¨æµç¨‹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ActivityThread#handleLaunchActivity</div><div class="line">	--&gt; performLaunchActivity //åˆ›å»º Activity </div><div class="line">    *--&gt; handleResumeActivity</div><div class="line">        --&gt; performResumeActivity//å›è°ƒ onResume</div><div class="line">            --&gt;  Activity#performResume();</div><div class="line">                --&gt; Instrumentation#callActivityOnResume</div><div class="line">                    --&gt; Activity#onResume();//å›è°ƒ onResume </div><div class="line">      **--&gt; Activity#makeVisible();</div><div class="line">            --&gt; WindowManagerGlobal#addView()</div><div class="line">                --&gt; root = new ViewRootImpl(view.getContext(), display);//åˆ›å»º ViewRootImpl</div><div class="line">                --&gt; ViewRootImpl#setView</div></pre></td></tr></table></figure>
<p>ä»ä¸Šè¿°æµç¨‹å¯ä»¥çœ‹å‡ºï¼ŒViewRootImpl æ˜¯åœ¨ WindowManagerGlobal#addView() æ–¹æ³•ä¸­è¢«åˆ›å»ºå‡ºæ¥çš„ã€‚å¹¶ä¸”æ˜¯åœ¨ Activity#onResume æ–¹æ³•è°ƒç”¨ä¹‹åæ‰è¢«åˆ›å»ºã€‚å› æ­¤æˆ‘ä»¬å¦‚æœåœ¨ onResume æ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹å»ä¿®æ”¹ UIï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ä¹Ÿæ˜¯å¯ä»¥æˆåŠŸçš„ã€‚</p>
<h2 id="ä¸€ä¸ªåœ¨å­çº¿ç¨‹æ›´æ–°-UI-çš„æ —å­ï¼š"><a href="#ä¸€ä¸ªåœ¨å­çº¿ç¨‹æ›´æ–°-UI-çš„æ —å­ï¼š" class="headerlink" title="ä¸€ä¸ªåœ¨å­çº¿ç¨‹æ›´æ–° UI çš„æ —å­ï¼š"></a>ä¸€ä¸ªåœ¨å­çº¿ç¨‹æ›´æ–° UI çš„æ —å­ï¼š</h2><p>åˆ›å»ºä¸€ä¸ª handlerThreadå¹¶è°ƒç”¨å®ƒçš„ start æ–¹æ³•ï¼Œè·å–handlerThread ä¸­çš„ looper æ„é€ ä¸€ä¸ª  Handlerã€‚åœ¨è¯¥ Handlerçš„ handleMessageæ–¹æ³•ï¼ˆè¿è¡Œåœ¨å­çº¿ç¨‹ï¼‰ ä¸­å°† view æ·»åŠ åˆ° WindowMangeré‡Œé¢ï¼Œå¹¶æ”¯æŒè¿›è¡Œæ›´æ–°æ“ä½œã€‚</p>
<p><a href="https://github.com/TimLin-pro/UpdateUiOnSubThread/blob/master/app/src/main/java/com/timlin/updateuionsubthread/ManageUiOnHandlerThreadActivity.java" target="_blank" rel="noopener">ç¤ºä¾‹ä»£ç åœ°å€</a></p>
<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>ViewRootImpl çš„åˆ›å»ºåœ¨ onResume æ–¹æ³•å›è°ƒä¹‹åï¼Œè€Œæˆ‘ä»¬ä¸€å¼€ç¯‡æ˜¯åœ¨ onCreate æ–¹æ³•ä¸­åˆ›å»ºäº†å­çº¿ç¨‹å¹¶è®¿é—® UIï¼Œåœ¨é‚£ä¸ªæ—¶åˆ»ï¼ŒViewRootImpl è¿˜æ²¡æœ‰åˆ›å»ºï¼Œæˆ‘ä»¬åœ¨å­çº¿ç¨‹è°ƒç”¨ äº† ImageView#setImageResourceï¼Œè™½ç„¶å¯èƒ½ä¼šè§¦å‘ View#requestLayout å’Œ View#invalidate() ï¼Œä½†æ˜¯ç”±äº ViewRootImplè¿˜æœªåˆ›å»ºå‡ºæ¥ï¼Œå› æ­¤ ViewRootImpl#checkThread æ²¡æœ‰è¢«è°ƒç”¨åˆ°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯åˆ›å»ºçš„ UI é‚£ä¸ªçº¿ç¨‹ çš„é€»è¾‘æ²¡æœ‰æ‰§è¡Œåˆ°ï¼Œæ‰€ä»¥ç¨‹åºæ²¡æœ‰å´©æºƒä¸€æ ·èƒ½è·‘èµ·æ¥ã€‚è€Œä¹‹åä¿®æ”¹äº†ç¨‹åºï¼Œè®©çº¿ç¨‹ä¼‘çœ äº† 300 æ¯«ç§’åï¼Œç¨‹åºå°±å´©äº†ã€‚å¾ˆæ˜æ˜¾ 300 æ¯«ç§’å ViewRootImpl å·²ç»åˆ›å»ºäº†ï¼Œå¯ä»¥æ‰§è¡Œ checkThread æ–¹æ³•æ£€æŸ¥å½“å‰çº¿ç¨‹ã€‚</p>
<p>å¼€ç¯‡çš„ä¾‹å­ä¸­æˆ‘ä»¬åœ¨ onCreate æ–¹æ³•ä¸­åˆ›å»ºçš„å­çº¿ç¨‹è®¿é—® UI æ˜¯ä¸€ç§æç«¯çš„æƒ…å†µã€‚å®é™…å¼€å‘ä¸­ä¸ä¼šè¿™ä¹ˆåšã€‚</p>
<h4 id="ä¸‹æ¬¡å¦‚æœæœ‰äººé—®ä½ -Android-ä¸­å­çº¿ç¨‹çœŸçš„ä¸èƒ½æ›´æ–°-UI-å—ï¼Ÿ-ä½ å¯ä»¥è¿™ä¹ˆå›ç­”ï¼š"><a href="#ä¸‹æ¬¡å¦‚æœæœ‰äººé—®ä½ -Android-ä¸­å­çº¿ç¨‹çœŸçš„ä¸èƒ½æ›´æ–°-UI-å—ï¼Ÿ-ä½ å¯ä»¥è¿™ä¹ˆå›ç­”ï¼š" class="headerlink" title="ä¸‹æ¬¡å¦‚æœæœ‰äººé—®ä½  Android ä¸­å­çº¿ç¨‹çœŸçš„ä¸èƒ½æ›´æ–° UI å—ï¼Ÿ ä½ å¯ä»¥è¿™ä¹ˆå›ç­”ï¼š"></a>ä¸‹æ¬¡å¦‚æœæœ‰äººé—®ä½  Android ä¸­å­çº¿ç¨‹çœŸçš„ä¸èƒ½æ›´æ–° UI å—ï¼Ÿ ä½ å¯ä»¥è¿™ä¹ˆå›ç­”ï¼š</h4><p>ä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥æ›´æ–°è‡ªå·±åˆ›å»ºçš„ UIã€‚åªè¦ä¿è¯æ»¡è¶³ä¸‹é¢å‡ ä¸ªæ¡ä»¶å°±å¥½äº†</p>
<ul>
<li><p>åœ¨ ViewRootImpl è¿˜æ²¡åˆ›å»ºå‡ºæ¥ä¹‹å‰</p>
<ul>
<li>UI ä¿®æ”¹çš„æ“ä½œæ²¡æœ‰çº¿ç¨‹é™åˆ¶ã€‚</li>
</ul>
</li>
<li><p>åœ¨ ViewRootImpl åˆ›å»ºå®Œæˆä¹‹å</p>
<ol>
<li><p>ä¿è¯ã€Œåˆ›å»º ViewRootImpl çš„æ“ä½œã€å’Œã€Œæ‰§è¡Œä¿®æ”¹ UI çš„æ“ä½œã€åœ¨åŒä¸€ä¸ªçº¿ç¨‹å³å¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ ViewManager#addView å’Œ ViewManager#updateViewLayout çš„æ–¹æ³•ã€‚</p>
<ul>
<li>æ³¨ï¼šViewManager æ˜¯ä¸€ä¸ªæ¥å£ï¼ŒWindowManger æ¥å£ç»§æ‰¿äº†è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½æ˜¯é€šè¿‡ WindowMangerï¼ˆå…·ä½“å®ç°ä¸º WindowMangerImplï¼‰ è¿›è¡Œ view çš„ add remove update æ“ä½œçš„ã€‚</li>
</ul>
</li>
<li><p>å¯¹åº”çš„çº¿ç¨‹éœ€è¦åˆ›å»º Looper å¹¶ä¸”è°ƒç”¨ Looper#loop æ–¹æ³•ï¼Œå¼€å¯æ¶ˆæ¯å¾ªç¯ã€‚</p>
</li>
</ol>
</li>
</ul>
<h4 id="æœ‰åŒå­¦å¯èƒ½ä¼šé—®ï¼Œä¿è¯ä¸Šè¿°æ¡ä»¶-1-æˆç«‹ï¼Œä¸å°±å¯ä»¥é¿å…-checkThread-æ—¶å€™æŠ›å‡ºå¼‚å¸¸äº†å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜éœ€è¦å¼€å¯æ¶ˆæ¯å¾ªåï¼Ÿ"><a href="#æœ‰åŒå­¦å¯èƒ½ä¼šé—®ï¼Œä¿è¯ä¸Šè¿°æ¡ä»¶-1-æˆç«‹ï¼Œä¸å°±å¯ä»¥é¿å…-checkThread-æ—¶å€™æŠ›å‡ºå¼‚å¸¸äº†å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜éœ€è¦å¼€å¯æ¶ˆæ¯å¾ªåï¼Ÿ" class="headerlink" title="æœ‰åŒå­¦å¯èƒ½ä¼šé—®ï¼Œä¿è¯ä¸Šè¿°æ¡ä»¶ 1 æˆç«‹ï¼Œä¸å°±å¯ä»¥é¿å… checkThread æ—¶å€™æŠ›å‡ºå¼‚å¸¸äº†å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜éœ€è¦å¼€å¯æ¶ˆæ¯å¾ªåï¼Ÿ"></a>æœ‰åŒå­¦å¯èƒ½ä¼šé—®ï¼Œä¿è¯ä¸Šè¿°æ¡ä»¶ 1 æˆç«‹ï¼Œä¸å°±å¯ä»¥é¿å… checkThread æ—¶å€™æŠ›å‡ºå¼‚å¸¸äº†å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜éœ€è¦å¼€å¯æ¶ˆæ¯å¾ªåï¼Ÿ</h4><ul>
<li>æ¡ä»¶ 1 å¯ä»¥é¿å…æ£€æŸ¥å¼‚å¸¸ï¼Œä½†æ˜¯æ— æ³•ä¿è¯ UI å¯ä»¥è¢«ç»˜åˆ¶å‡ºæ¥ã€‚</li>
<li>æ¡ä»¶ 2 å¯ä»¥è®©æ›´æ–°çš„ UI æ•ˆæœå‘ˆç°å‡ºæ¥<ul>
<li>WindowManger#addView æœ€ç»ˆä¼šè°ƒç”¨ WindowManageGlobal#addView æ–¹æ³•ï¼Œè¿›è€Œè§¦å‘ViewRootImpl#setView æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ ViewRootImpl#requestLayout æ–¹æ³•ã€‚</li>
<li>äº†è§£è¿‡ UI ç»˜åˆ¶åŸç†çš„åŒå­¦åº”è¯¥çŸ¥é“ ä¸‹ä¸€æ­¥å°±æ˜¯ scheduleTraversals äº†ï¼Œè¯¥æ–¹æ³•ä¼šå¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’å…¥ä¸€æ¡æ¶ˆæ¯å±éšœï¼Œç„¶åè°ƒç”¨ Choreographer#postCallback æ–¹æ³•ï¼Œå¾€ looper ä¸­æ’å…¥ä¸€æ¡å¼‚æ­¥çš„ MSG_DO_SCHEDULE_CALLBACK æ¶ˆæ¯ã€‚ç­‰å¾…å‚ç›´åŒæ­¥ä¿¡å·å›æ¥ä¹‹åæ‰§è¡Œã€‚<ul>
<li>æ³¨ï¼šViewRootImpl æœ‰ä¸€ä¸ª Choreographer  æˆå‘˜å˜é‡ï¼ŒViewRootImpl çš„æ„é€ å‡½æ•°ä¸­ä¼šè°ƒç”¨ Choreographer#getInstance(); æ–¹æ³•ï¼Œè·å–ä¸€ä¸ªå½“å‰çº¿ç¨‹çš„ Choreographer å±€éƒ¨å®ä¾‹ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ä½¿ç”¨å­çº¿ç¨‹æ›´æ–°-UI-æœ‰å®é™…åº”ç”¨åœºæ™¯å—ï¼Ÿ"><a href="#ä½¿ç”¨å­çº¿ç¨‹æ›´æ–°-UI-æœ‰å®é™…åº”ç”¨åœºæ™¯å—ï¼Ÿ" class="headerlink" title="ä½¿ç”¨å­çº¿ç¨‹æ›´æ–° UI æœ‰å®é™…åº”ç”¨åœºæ™¯å—ï¼Ÿ"></a>ä½¿ç”¨å­çº¿ç¨‹æ›´æ–° UI æœ‰å®é™…åº”ç”¨åœºæ™¯å—ï¼Ÿ</h4><p>Android ä¸­çš„  SurfaceView é€šå¸¸ä¼šé€šè¿‡ä¸€ä¸ªå­çº¿ç¨‹æ¥è¿›è¡Œé¡µé¢çš„åˆ·æ–°ã€‚å¦‚æœæˆ‘ä»¬çš„è‡ªå®šä¹‰ View éœ€è¦é¢‘ç¹åˆ·æ–°ï¼Œæˆ–è€…åˆ·æ–°æ—¶æ•°æ®å¤„ç†é‡æ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ SurfaceView æ¥å–ä»£ Viewã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://blog.csdn.net/xyh269/article/details/52728861" target="_blank" rel="noopener">Android ä¸­å­çº¿ç¨‹çœŸçš„ä¸èƒ½æ›´æ–° UI å—ï¼Ÿ</a></li>
<li><a href="http://blog.csdn.net/u010198148/article/details/51779567" target="_blank" rel="noopener">å¤šçº¿ç¨‹å­¦ä¹ ä¹‹â€“çœŸçš„ä¸èƒ½åœ¨å­çº¿ç¨‹é‡Œæ›´æ–° UI å—ï¼Ÿ</a></li>
<li><a href="https://www.zybuluo.com/natsumi/note/736165" target="_blank" rel="noopener">äº’è”ç½‘ç¬”è®° Android ä¸­å­çº¿ç¨‹çœŸçš„ä¸èƒ½æ›´æ–° UI å—ï¼Ÿ</a></li>
<li><a href="https://www.zhihu.com/question/24764972/answer/36053366" target="_blank" rel="noopener">Android åªåœ¨ UI ä¸»çº¿ç¨‹ä¿®æ”¹ UIï¼Œæ˜¯ä¸ªè°è¨€å—ï¼Ÿ ä¸ºä»€ä¹ˆè¿™æ®µä»£ç èƒ½å®Œç¾è¿è¡Œï¼Ÿ</a></li>
</ul>
<p>2020/04/18  åœ¨ 2017/08/16 çš„å†…å®¹åŸºç¡€ä¸Šæ–°å¢äº†ä¸€ä¸ªç¤ºä¾‹ï¼Œä»¥åŠæ€»ç»“ã€‚</p>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®æ¬¢è¿åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè¯·å¯¹é—®é¢˜æè¿°å°½é‡è¯¦ç»†ï¼Œä»¥å¸®åŠ©æˆ‘å¯ä»¥å¿«é€Ÿæ‰¾åˆ°é—®é¢˜æ ¹æºã€‚è°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> åŸç†åˆ†æ </category>
            
            <category> æ¢ç©¶ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> æ¢ç©¶ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[RxJavaä¸­switchMapå’ŒflapMap æœ‰ä½•åŒºåˆ«ï¼Ÿ]]></title>
      <url>https://timlin-pro.github.io/blog/2020/03/20/RxJava%E4%B8%ADswitchMap%E5%92%8CflapMap-%E6%9C%89%E4%BD%95%E5%8C%BA%E5%88%AB%EF%BC%9F/</url>
      <content type="html"><![CDATA[<p>flapMap å’Œ switchMap éƒ½æ˜¯ RxJava ä¸­çš„è½¬æ¢æ“ä½œç¬¦ï¼Œéƒ½å¯ä»¥å°†ä¸Šæ¸¸çš„è¾“å…¥è½¬æ¢ä¸ºä¸€ä¸ªæ•°æ®æºï¼ˆæ¯”å¦‚ Observableï¼‰è¾“å‡ºç»™ä¸‹æ¸¸ã€‚</p>
<a id="more"></a>
<h2 id="switchMap-çš„ä½¿ç”¨åœºæ™¯"><a href="#switchMap-çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="switchMap çš„ä½¿ç”¨åœºæ™¯"></a>switchMap çš„ä½¿ç”¨åœºæ™¯</h2><ul>
<li><p>switchMap çš„ä½¿ç”¨åœºæ™¯ï¼šç›‘å¬ç”¨æˆ·åœ¨è¾“å…¥æ¡†è¾“å…¥çš„å†…å®¹ï¼Œå®šæ—¶è§¦å‘æœç´¢å¹¶å±•ç¤ºç»“æœ</p>
<ol>
<li><p>åˆ›å»ºä¸€ä¸ª <code>PublishSubject&lt;String&gt;</code></p>
</li>
<li><p>è¾“å…¥æ¡†ä¸­çš„æ–‡å­—å˜åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨ onNext æ–¹æ³•å‘å¸ƒå˜æ›´</p>
</li>
<li><p>ä½¿ç”¨ debounce å»æŠ–åŠ¨ï¼Œé¿å…é¢‘ç¹è§¦å‘</p>
</li>
<li><p>ä½¿ç”¨ switchMap åˆ‡æ¢åˆ°æœç´¢ç½‘ç»œè¯·æ±‚</p>
</li>
<li><p>subscribe å¤„ç†æœç´¢ç»“æœï¼ˆä¹Ÿå¯ä»¥åŠ ä¸€ä¸ª map æ“ä½œï¼‰ï¼Œå¹¶æ›´æ–° UI</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">mExecSearchDisposable = searchObservable</div><div class="line">    <span class="comment">//é˜²æŠ–</span></div><div class="line">    .debounce(<span class="number">100</span>, TimeUnit.MILLISECONDS, BearSchedulers.mainThread())</div><div class="line">    <span class="comment">//æœ‰å˜åŒ–æ‰å¾€ä¸‹æ¸¸å‘é€</span></div><div class="line">    .distinctUntilChanged()</div><div class="line">    .toFlowable(BackpressureStrategy.LATEST)</div><div class="line">    <span class="comment">//å¯¹ä¸Šæ¸¸çš„è¾“å…¥ï¼ˆç”¨æˆ·è¾“å…¥çš„æœç´¢å…³é”®å­—ï¼‰è¿›è¡ŒæŸ¥è¯¢ï¼›å¦‚æœæœ‰æ–°çš„è¾“å…¥ï¼Œæ—§çš„è¾“å…¥è¿˜æœªæ‹¿åˆ°æŸ¥è¯¢ç»“æœï¼Œåˆ™æ—§çš„æŸ¥è¯¢ç»“æœä¼šç›´æ¥ä¸¢å¼ƒã€‚</span></div><div class="line">    .switchMap &#123; s -&gt;</div><div class="line">			<span class="comment">//å¦‚æœè¾“å…¥ä¸ºç©ºä¸²ï¼Œåˆ™å±•ç¤ºç©ºé¡µé¢</span></div><div class="line">      <span class="keyword">if</span> (s.isEmpty()) &#123;</div><div class="line">            Flowable.just(Notification.createOnError(EmptySearchException()))</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">//æ˜¾ç¤º loading</span></div><div class="line">            view.loading()</div><div class="line">              <span class="comment">//æ„å»ºæœç´¢å‚æ•°</span></div><div class="line">            val params = buildSearchParams(s)</div><div class="line">              <span class="comment">//æœ‰ç½‘ç»œï¼Œæ‰§è¡Œç½‘ç»œæŸ¥è¯¢ï¼Œæ— ç½‘ç»œï¼Œæ‰§è¡Œæœ¬åœ°æ•°æ®åº“æŸ¥è¯¢</span></div><div class="line">            val searchFlowable = <span class="keyword">if</span> (connectionService.networkState.isConnected) &#123;</div><div class="line">                mSearchDataRepository.searchFromNet(params)</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mSearchDataRepository.searchFromDb(params)</div><div class="line">            &#125;</div><div class="line">            searchFlowable.observeOn(BearSchedulers.computation())</div><div class="line">                    .map &#123;</div><div class="line">                        val resultList = resolveResponse(it)</div><div class="line">                        Notification.createOnNext(resultList)</div><div class="line">                    &#125;</div><div class="line">                    .onErrorReturn &#123; Notification.createOnError(it) &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    .observeOn(BearSchedulers.mainThread())</div><div class="line">    .subscribe &#123; notification -&gt;</div><div class="line">        <span class="keyword">if</span> (notification.isOnNext) &#123;</div><div class="line">          <span class="comment">//åˆ·æ–° UI</span></div><div class="line">            view.refreshUi(notification.value, <span class="keyword">false</span>)</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (notification.isOnError) &#123;</div><div class="line">            <span class="keyword">if</span> (notification.error is EmptySearchException) &#123;</div><div class="line">                view.refreshUi(Collections.emptyList(), <span class="keyword">true</span>)</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                view.onError(notification.error?.message)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<ul>
<li><p>å¦‚æœä½¿ç”¨ flatMapï¼Œåˆ™æœç´¢ç»“æœæœ‰å¯èƒ½æ˜¯è¿‡æ—¶çš„ï¼Œå› ä¸ºå®¢æˆ·ç«¯æ‹¿åˆ°çš„æœç´¢ç»“æœ é¡ºåºæœ‰å¯èƒ½æ˜¯ä¹±åºçš„ã€‚ï¼ˆç½‘ç»œè¯·æ±‚çš„æ—¶å»¶ä¸å¯æ§ï¼‰</p>
<ul>
<li>ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ switchMapï¼Œå› ä¸ºswitchMap ä¿è¯æ–°çš„ Observable æä¾›çš„æ—¶å€™ï¼Œ æ—§çš„ Observable ä¼šè¢«å–æ¶ˆæ‰ã€‚</li>
</ul>
</li>
</ul>
<h2 id="å¤§ç†çŸ³å›¾"><a href="#å¤§ç†çŸ³å›¾" class="headerlink" title="å¤§ç†çŸ³å›¾"></a>å¤§ç†çŸ³å›¾</h2><ul>
<li><p>switchMap ï¼›å› ä¸ºåœ¨å‘å‡ºç¬¬äºŒä¸ªç»¿è‰²æ–¹å—ä¹‹å‰ï¼Œä¸Šæ¸¸è¾“å…¥ä¸€ä¸ª æ·±è“è‰²ç å­ï¼Œå› æ­¤ç¬¬äºŒä¸ªç»¿è‰²æ–¹å—ä¹‹å‰è¢«ä¸¢å¼ƒ</p>
<p><img src="https://raw.githubusercontent.com/TimLin1024/Graph/master/markdown/switchMap" alt="img"></p>
</li>
<li><p>flatMapï¼Œè™½ç„¶æ·±è“è‰²çš„ç å­ç´§éšç»¿è‰²ç å­ï¼Œä½†æ˜¯ï¼Œç¬¬äºŒä¸ªç»¿è‰²æ–¹å—ä¹Ÿæ­£å¸¸å‘é€äº†å‡ºå»ï¼Œåªä¸è¿‡ï¼Œé¡ºåºä¹±äº†ï¼ˆè¿™é‡Œçš„ ã€Œä¹±ã€æŒ‡çš„æ˜¯ï¼Œç¬¬äºŒä¸ªç»¿è‰²æ–¹å—æ²¡æœ‰åœ¨è“è‰²çš„ç¬¬ä¸€ä¸ªæ–¹å—ä¹‹å‰å‘å‡ºï¼‰</p>
<p><img src="https://raw.githubusercontent.com/TimLin1024/Graph/master/markdown/FlapMap" alt="img"></p>
</li>
</ul>
<h2 id="å°ç»“ï¼š"><a href="#å°ç»“ï¼š" class="headerlink" title="å°ç»“ï¼š"></a>å°ç»“ï¼š</h2><ul>
<li>flatMap é€‚ç”¨äºå„ä¸ªç»“æœéƒ½æœ‰ç”¨ï¼Œä¸ç®¡å®ƒä»¬çš„å…ˆåæ—¶é—´</li>
<li>switchMapå°±åƒflatMapï¼Œ<strong>ä½†å®ƒä»…ä¿ç•™æœ€æ–°çš„è§‚å¯Ÿåˆ°ç»“æœã€‚è¿‡æ—¶çš„äº‹ä»¶ä¼šè¢«ä¸¢å¼ƒæ‰ã€‚</strong><ul>
<li>æ€ä¹ˆæ ·ç®—è¿‡æœŸï¼Ÿ<ul>
<li>å‡è®¾ Observable1 äº‹ä»¶è¿˜æ²¡å‘é€å®Œï¼Œæ­¤æ—¶æœ‰äº†æ–°çš„ Observable2 ï¼Œåˆ™Observable1 æœªå‘å¸ƒçš„/æœªè½¬æ¢å®Œçš„äº‹ä»¶å°±ä¸ä¼šå‘é€å‡ºå»äº†ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://lorentzos.com/improving-ux-with-rxjava-4440a13b157f" target="_blank" rel="noopener">https://lorentzos.com/improving-ux-with-rxjava-4440a13b157f</a></li>
<li><a href="https://www.jianshu.com/p/33c548bce571" target="_blank" rel="noopener">https://www.jianshu.com/p/33c548bce571</a></li>
<li><a href="https://stackoverflow.com/questions/28175702/what-is-the-difference-between-flatmap-and-switchmap-in-rxjava" target="_blank" rel="noopener">https://stackoverflow.com/questions/28175702/what-is-the-difference-between-flatmap-and-switchmap-in-rxjava</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> RxJava </category>
            
        </categories>
        
        
        <tags>
            
            <tag> RxJava </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[å…³äºEditTextå‡ ä¸ªå°Tips]]></title>
      <url>https://timlin-pro.github.io/blog/2019/10/31/%E5%85%B3%E4%BA%8EEditText%E5%87%A0%E4%B8%AA%E5%B0%8FTips/</url>
      <content type="html"><![CDATA[<h3 id="1-æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®"><a href="#1-æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®" class="headerlink" title="1.æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®"></a>1.æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®</h3><p>æœ€ç®€ä¾¿çš„æ–¹å¼ï¼šåˆ©ç”¨ kotlin æ‹“å±•å‡½æ•°ï¼Œé€šè¿‡ TextView#setCompoundDrawablesWithIntrinsicBounds æ–¹æ³•å®ç°</p>
<a id="more"></a>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">fun</span> EditText.<span class="title">setupClearButtonWithAction</span><span class="params">()</span></span> &#123;</div><div class="line"></div><div class="line">    addTextChangedListener(<span class="keyword">object</span> : TextWatcher &#123;</div><div class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">afterTextChanged</span><span class="params">(editable: <span class="type">Editable</span>?)</span></span> &#123;</div><div class="line">            <span class="keyword">val</span> clearIcon = <span class="keyword">if</span> (editable?.isNotEmpty() == <span class="literal">true</span>) R.drawable.ic_clear <span class="keyword">else</span> <span class="number">0</span></div><div class="line">            setCompoundDrawablesWithIntrinsicBounds(<span class="number">0</span>, <span class="number">0</span>, clearIcon, <span class="number">0</span>)</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">beforeTextChanged</span><span class="params">(s: <span class="type">CharSequence</span>?, start: <span class="type">Int</span>, count: <span class="type">Int</span>, after: <span class="type">Int</span>)</span></span> = <span class="built_in">Unit</span></div><div class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTextChanged</span><span class="params">(s: <span class="type">CharSequence</span>?, start: <span class="type">Int</span>, before: <span class="type">Int</span>, count: <span class="type">Int</span>)</span></span> = <span class="built_in">Unit</span></div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    setOnTouchListener(View.OnTouchListener &#123; _, event -&gt;</div><div class="line">        <span class="keyword">if</span> (event.action == MotionEvent.ACTION_UP) &#123;</div><div class="line">            <span class="keyword">if</span> (event.rawX &gt;= (<span class="keyword">this</span>.right - <span class="keyword">this</span>.compoundPaddingRight)) &#123;</div><div class="line">                <span class="keyword">this</span>.setText(<span class="string">""</span>)</div><div class="line">                <span class="keyword">return</span><span class="symbol">@OnTouchListener</span> <span class="literal">true</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span><span class="symbol">@OnTouchListener</span> <span class="literal">false</span></div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-ç¦æ­¢å¤åˆ¶ç²˜è´´"><a href="#2-ç¦æ­¢å¤åˆ¶ç²˜è´´" class="headerlink" title="2.ç¦æ­¢å¤åˆ¶ç²˜è´´"></a>2.ç¦æ­¢å¤åˆ¶ç²˜è´´</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">fun</span> TextView.<span class="title">disableCopyPaste</span><span class="params">()</span></span> &#123;</div><div class="line">    isLongClickable = <span class="literal">false</span></div><div class="line">    setTextIsSelectable(<span class="literal">false</span>)</div><div class="line">    customSelectionActionModeCallback = <span class="keyword">object</span> : ActionMode.Callback &#123;</div><div class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateActionMode</span><span class="params">(mode: <span class="type">ActionMode</span>?, menu: <span class="type">Menu</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPrepareActionMode</span><span class="params">(mode: <span class="type">ActionMode</span>?, menu: <span class="type">Menu</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActionItemClicked</span><span class="params">(mode: <span class="type">ActionMode</span>?, item: <span class="type">MenuItem</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroyActionMode</span><span class="params">(mode: <span class="type">ActionMode</span>?)</span></span> &#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-ä»…æ”¯æŒè¾“å…¥å¯æ‰“å°çš„-ASCII-å€¼"><a href="#3-ä»…æ”¯æŒè¾“å…¥å¯æ‰“å°çš„-ASCII-å€¼" class="headerlink" title="3.ä»…æ”¯æŒè¾“å…¥å¯æ‰“å°çš„ ASCII å€¼"></a>3.ä»…æ”¯æŒè¾“å…¥å¯æ‰“å°çš„ ASCII å€¼</h3><p>å¯æ‰“å°çš„ ASCII å­—ç¬¦ï¼Œå¯ä»¥é€šè¿‡éå† 1~128 ï¼Œå°†å…¶å¼ºè½¬ä¸º char ç±»å‹å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">128</span>; i++) &#123;</div><div class="line">     System.out.print((<span class="keyword">char</span>) i);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœ</p>
<blockquote>
<p>!â€#$%&amp;â€™()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~</p>
</blockquote>
<p>å› ä¸º â€œ ã€å›è½¦ã€ ç©ºæ ¼ã€â€™ã€ &amp;ã€&lt; ã€&gt; éœ€è¦è¿›è¡Œè½¬ä¹‰ï¼Œæ‰èƒ½åœ¨ android çš„ xml ä¸­ä½¿ç”¨ã€‚å¯¹ç…§å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&amp;#34; æˆ– &amp;quot;   			&quot;		</div><div class="line">\n										å›è½¦</div><div class="line">&amp;#160;								ç©ºæ ¼</div><div class="line">&amp;#39; æˆ– &amp;apos; 				&apos;</div><div class="line">&amp;#38; æˆ– &amp;amp;					&amp;</div><div class="line">&amp;#60; æˆ– &amp;lt;					&lt;</div><div class="line">&amp;#62; æˆ– &amp;gt;					&gt;</div></pre></td></tr></table></figure>
<p>è‹¥ç›´æ¥ä½¿ç”¨å­—ç¬¦ï¼Œæ¯”å¦‚ &lt;ï¼Œä¼šæŠ¥é”™ï¼š</p>
<blockquote>
<p>The value of attribute â€œandroid:digitsâ€ associated with an element type â€œEditTextâ€ must not contain the â€˜&lt;â€™ character.</p>
</blockquote>
<p>å› æ­¤ï¼Œåœ¨ xml æ–‡ä»¶ä¸­ç»™ EditText æŒ‡æ˜ digits å±æ€§ä¸ºå³å¯</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:digits="!#$%&amp;amp;'()*+,-./0123456789:;&amp;lt;=&amp;gt;@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz&#123;|&#125;~&amp;#34;"</div></pre></td></tr></table></figure>
<p><a href="https://developer.android.com/reference/android/view/inputmethod/EditorInfo.html#IME_FLAG_FORCE_ASCII" target="_blank" rel="noopener">å¦ä¸€ç§æ–¹å¼</a>ï¼Œå¯ä»¥æ”¹å˜é”®ç›˜çš„<strong>åˆå§‹çŠ¶æ€</strong>ï¼šimeOptions=â€flagForceAsciiâ€ </p>
<p>ä¹Ÿå¯ä»¥åœ¨ä»£ç ä¸­ï¼Œé€šè¿‡ setTextFilter æ¥å®ç°ã€‚</p>
<p>åˆ¤æ–­æ˜¯å¦ä¸º ASCII</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isASCII</span><span class="params">(String s)</span>  </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.length(); i++) </div><div class="line">        <span class="keyword">if</span> (s.charAt(i) &gt; <span class="number">127</span>) </div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[è¿ç§»åˆ°AndroidX]]></title>
      <url>https://timlin-pro.github.io/blog/2019/10/27/%E5%BF%AB%E9%80%9F%E8%BF%81%E7%A7%BB%E5%88%B0%20AndroidX/</url>
      <content type="html"><![CDATA[<p>Android Studio æä¾›çš„ Migrate to AndroidX åŠŸèƒ½ä¸æ˜¯ç‰¹åˆ«å®Œå–„ï¼Œå¾ˆå¤šæ–‡ä»¶çš„åŒ…åæ›¿æ¢ä¸å®Œæ•´ã€‚å¯ä»¥é€šè¿‡è‡ªå®šä¹‰è„šæœ¬æ¥å¤„ç†è¿™ä¸ªæµç¨‹ã€‚</p>
<a id="more"></a>
<p>åŒ…åæ˜ å°„æ–‡ä»¶ä¸‹è½½åœ°å€ï¼š <code>https://developer.android.com/topic/libraries/support-library/downloads/androidx-class-mapping.csv</code></p>
<p>è„šæœ¬æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env bash</div><div class="line"></div><div class="line">MAPPING_FILE=csvæ–‡ä»¶è·¯å¾„</div><div class="line">PROJECT_DIR=é¡¹ç›®ç›®å½•</div><div class="line"></div><div class="line">replace=&quot;&quot;</div><div class="line">while IFS=, read -r from to</div><div class="line">do</div><div class="line">	replace+=&quot;; s/$from/$to/g&quot;</div><div class="line">done &lt;&lt;&lt; &quot;$(cat $MAPPING_FILE)&quot;</div><div class="line">fd . $PROJECT_DIR -e kt -e java -e xml --print0 | xargs -0 gsed -i &quot;$replace&quot;</div></pre></td></tr></table></figure>
<p>æ³¨ï¼šmac éœ€è¦å®‰è£… fd å’Œ gnu-sed</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">brew install fd # fd æ˜¯ find å‘½ä»¤çš„æ›¿ä»£å“</div><div class="line">brew install gnu-sed</div></pre></td></tr></table></figure>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://gist.github.com/dlew/5db1b780896bbc6f542e7c00a11db6a0" target="_blank" rel="noopener">https://gist.github.com/dlew/5db1b780896bbc6f542e7c00a11db6a0</a></li>
<li><a href="https://gist.github.com/dudeinthemirror/cb4942e0ee5c3df0fcb678d1798e1d4d" target="_blank" rel="noopener">https://gist.github.com/dudeinthemirror/cb4942e0ee5c3df0fcb678d1798e1d4d</a></li>
<li><a href="https://developer.android.com/jetpack/androidx/migrate" target="_blank" rel="noopener">è¿ç§»åˆ° AndroidX</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ä¿é™©åŸºç¡€çŸ¥è¯†]]></title>
      <url>https://timlin-pro.github.io/blog/2019/05/26/%E4%BF%9D%E9%99%A9%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
      <content type="html"><![CDATA[<h2 id="1ã€ä¸ºä»€ä¹ˆè¦ä¹°ä¿é™©ï¼Ÿ"><a href="#1ã€ä¸ºä»€ä¹ˆè¦ä¹°ä¿é™©ï¼Ÿ" class="headerlink" title="1ã€ä¸ºä»€ä¹ˆè¦ä¹°ä¿é™©ï¼Ÿ"></a>1ã€ä¸ºä»€ä¹ˆè¦ä¹°ä¿é™©ï¼Ÿ</h2><p>è´­ä¹°ä¿é™©æ˜¯ä¸ºäº†å‡å°‘é¢„æœŸä»¥å¤–çš„äº‹ä»¶å¯¹è¢«ä¿é™©äººçš„è´¢åŠ¡çŠ¶å†µé€ æˆå†²å‡»ï¼Œä¸ºå—ç›Šäººæä¾›ç»æµè¡¥å¿å‡è½»è´Ÿæ‹…ã€‚<strong>ç”¨ç»æµå­¦åŸç†æ¥è§£é‡Šå°±æ˜¯è¢«ä¿é™©äººé€šè¿‡ç¼´çº³ä¿è´¹æ¢å–æœªæ¥è´¢åŠ¡çŠ¶å†µæ›´å¤§çš„ç¡®å®šæ€§</strong>ã€‚</p>
<a id="more"></a>
<blockquote>
<p>å‡è®¾æ²¡ä¹°ä¿é™©å‰ï¼Œä½ æœªæ¥è´¢å¯Œç°å€¼çš„èŒƒå›´æ˜¯ [-50 ä¸‡å…ƒï¼Œ200 ä¸‡å…ƒ]ï¼Œæœ‰è´Ÿå€¼çš„åŸå› å¯èƒ½æ˜¯å„ç§è´¢å¯ŒæŸå¤±ï¼Œæ¯”å¦‚å®¶é‡Œå¤§ç«ï¼Œæ¯”å¦‚æ²»ç—…è¿‡ç¨‹ä¸­æ”¯ä»˜çš„é«˜é¢åŒ»ç–—è´¹ç”¨ï¼›è€Œé€šè¿‡è´­ä¹°ä¿é™©ï¼Œä½ çš„æœªæ¥è´¢å¯Œç°å€¼çš„èŒƒå›´å¯èƒ½å˜æˆ [80 ä¸‡ï¼Œ190 ä¸‡]ï¼Œè™½ç„¶æœ€å¤§å€¼å› ä¸ºè¦äº¤ä¿è´¹è€Œå˜å°äº†ï¼Œä½†æ˜¯æ³¢åŠ¨èŒƒå›´æ›´åŠ ç¡®å®šäº†ï¼ˆè¿™ä¸ªä¾‹å­ä¸­æ³¢åŠ¨èŒƒå›´ä» 250 ä¸‡ç¼©å°åˆ° 110 ä¸‡ï¼Œæ‰€ä»¥æœªæ¥æ›´ç¡®å®šäº†)ã€‚</p>
</blockquote>
<p><strong>50w ä¿é¢ 20 å¹´åå¾ˆå¯èƒ½å°±ä¸å€¼é’±äº†ï¼Œä¹°ä¿é™©è¿˜æœ‰æ„ä¹‰å—</strong>ï¼Ÿ</p>
<blockquote>
<p>ä¹°ä¿é™©å…¶å®ä¹°çš„æ˜¯ä¿éšœã€‚å‡è®¾ä½ ä¹°ä¸€ä¸ª 50w ä¿é¢çš„é‡ç–¾é™©ï¼Œç¼´è´¹æœŸä¸º 30 å¹´ã€‚ç„¶åè´­ä¹°ä¹‹åç¼´äº†1 å¹´å°±å‡ºé™©äº†ï¼Œä½ ç«‹åˆ»å°±èƒ½æ‹¿åˆ° <strong>50w</strong>ï¼Œè€Œä¸”åé¢çš„ä¿è´¹éƒ½ä»æ­¤ä¸ç”¨ç¼´äº†ã€‚å¦‚æœä¹°çš„æ˜¯å¤šæ¬¡èµ”ä»˜é‡ç–¾ï¼Œé™¤äº†è¿™æ¬¡å‡ºé™©èµ”ä»˜çš„ç–¾ç—…å¤–ï¼Œåé¢å¦‚æœå¾—äº†å…¶ä»–æ»¡è¶³èµ”ä»˜æ¡ä»¶çš„å…¶ä»–ç–¾ç—…ï¼Œè¿˜èƒ½å†æ¬¡å¾—åˆ°èµ”ä»˜ã€‚</p>
</blockquote>
<p>å…¶å®é€šèƒ€å¯¹æ‰€æœ‰èµ„äº§ç±»å‹éƒ½æœ‰å½±å“ã€‚</p>
<p>æ— è®ºæ˜¯ç°é‡‘ã€å­˜æ¬¾ã€è‚¡ç¥¨ã€æˆ¿äº§ï¼Œéƒ½æˆ–å¤šæˆ–å°‘ä¼šå—åˆ°é€šè´§è†¨èƒ€çš„å½±å“ã€‚é™¤éä½ é©¬ä¸Šã€ç«‹åˆ»ã€å½“ä¸‹ã€å°±æŠŠè¿™é’±èŠ±äº†ã€‚é€šè´§è†¨èƒ€æ‰€å¸¦æ¥çš„ä¿é¢ç¼©æ°´ï¼Œç¡®å®æ˜¯ä¸€ä¸ªå®¢è§‚å­˜åœ¨çš„äº‹å®ï¼Œä½†å®ƒæ˜¯èµ„äº§æ•´ä½“çš„å˜åŒ–ï¼Œè€Œä¸æ˜¯ä¿é™©æœ¬èº«å¸¦æ¥çš„é—®é¢˜ã€‚çŸ­æœŸå†…çš„é€šè´§è†¨èƒ€å¯¹æˆ‘ä»¬çš„å½±å“å…¶å®å¾ˆå°ï¼Œä½†æ˜¯ä¿é™©äº¤å®Œé©¬ä¸Šæœ‰ä¿éšœï¼ˆç­‰å¾…æœŸç»“æŸä¹‹åï¼‰ã€‚</p>
<blockquote>
<p><strong>åˆ«ç”¨çœ‹ç†è´¢äº§å“çš„çœ¼å…‰ï¼Œå»è¦æ±‚ä¸€ç§é£é™©ç®¡ç†å·¥å…·ã€‚</strong></p>
<p><strong>æœ€å¥½çš„æŠ—é€šèƒ€å·¥å…·ï¼Œæ˜¯ä½ çš„èµšé’±èƒ½åŠ›ã€‚</strong></p>
</blockquote>
<p><strong>å¤šæ•°äººçš„é‡ç–¾ä¿éšœæ˜¯ä¸è¶³çš„</strong>ã€‚</p>
<p>å¾ˆå¤šäººé™¤äº†å›½å®¶å¼ºåˆ¶ç¼´çº³çš„äº”é™©ä¹‹å¤–ï¼Œæ²¡æœ‰ç»™è‡ªå·±è´­ä¹°å…¶ä»–ä¿é™©ã€‚è€Œäº”é™©å¹¶æ²¡æœ‰ä¿éšœé‡ç–¾ã€‚å¯èƒ½éƒ¨åˆ†ä¼ä¸šä¸ºå‘˜å·¥æŠ•ä¿äº†å‘˜å·¥ä¿é™©ç¦åˆ©è®¡åˆ’ï¼Œä¹Ÿå°±æ˜¯å•†ä¸šæ€§å›¢ä½“ä¿é™©ã€‚å¦‚æœå°±èŒæ‰€åœ¨å…¬å¸æˆ–å•ä½å·²ä¸ºå‘˜å·¥è´­ä¹°äº†å•†ä¸šå›¢ä½“ä¿é™©ï¼Œå¯ä»¥è¿›ä¸€æ­¥çœ‹ä¸€ä¸‹ä¿éšœè®¡åˆ’ç»„åˆå†…æ˜¯å¦æœ‰æä¾›ç›¸å…³çš„é‡ç–¾ä¿éšœã€‚</p>
<p>ä½†æ˜¯ï¼Œå…¬å¸ç»™å‘˜å·¥ä¹°çš„ä¿é™©ï¼Œé€šå¸¸éƒ½æ˜¯ä¸€å¹´æœŸçš„çŸ­æœŸé™©ï¼Œå½“å‘˜å·¥ç¦»èŒä¹‹åä¹Ÿå°±ä¸å†ä¿éšœäº†ã€‚æ‰€ä»¥ï¼Œæ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯è‡ªå·±è´­ä¹°ä¸€ä»½é•¿æœŸçš„ä¿é™©æ¯”è¾ƒç¨³å¦¥ã€‚</p>
<h2 id="2ã€ä¿é™©çš„åˆ†ç±»"><a href="#2ã€ä¿é™©çš„åˆ†ç±»" class="headerlink" title="2ã€ä¿é™©çš„åˆ†ç±»"></a>2ã€ä¿é™©çš„åˆ†ç±»</h2><p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/%E4%BF%9D%E9%99%A9%E5%88%86%E7%B1%BB.jpg" alt=""></p>
<h3 id="ä¸€ã€è´¢äº§ä¿é™©"><a href="#ä¸€ã€è´¢äº§ä¿é™©" class="headerlink" title="ä¸€ã€è´¢äº§ä¿é™©"></a>ä¸€ã€è´¢äº§ä¿é™©</h3><p>è´¢äº§ä¿é™©ï¼Œåˆç§°äº§ç‰©ä¿é™©ï¼Œæ˜¯ä»¥å„ç§è´¢äº§åŠå…¶ç›¸å…³åˆ©ç›Šä¸ºä¿é™©æ ‡çš„çš„ä¿é™©ã€‚è´¢äº§ä¿é™©æ˜¯ä¸€ç§ç¤¾ä¼šåŒ–çš„ç»æµè¡¥å¿åˆ¶åº¦ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯è¡¥å¿æŠ•ä¿äººæˆ–è€…è¢«ä¿é™©äººçš„ç»æµæŸå¤±ã€‚</p>
<p>å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„æœºåŠ¨è½¦è¾†ä¿é™©ä¹Ÿç§°æ±½è½¦ä¿é™©æˆ–è½¦é™©ï¼Œæ˜¯è´¢äº§ä¿é™©çš„ä¸€ç§ï¼Œ ä»¥è½¦è¾†æœ¬èº«åŠç¬¬ä¸‰è€…è´£ä»»ä¸ºä¿é™©æ ‡çš„ã€‚ä¸»è¦ä¿éšœå› è½¦ç¥¸æˆ–è€…è‡ªç„¶ç¾å®³å¯¼è‡´çš„æŸå¤±ã€‚å…¶ä¿é™©æ ‡çš„ï¼Œä¸»è¦æ˜¯è½¦è¾†ã€‚</p>
<h3 id="äºŒã€äººèº«é™©"><a href="#äºŒã€äººèº«é™©" class="headerlink" title="äºŒã€äººèº«é™©"></a>äºŒã€äººèº«é™©</h3><p>äººèº«é™©ï¼Œæ˜¯ä»¥äººçš„å¯¿å‘½å’Œèº«ä½“ä½œä¸ºæŠ•ä¿æ ‡çš„ä¿é™©ã€‚åœ¨ä¸­å›½ï¼Œäººèº«é™©åˆåˆ†ä¸ºç¤¾ä¼šå¼ºåˆ¶ä¿é™©å’Œå•†ä¸šä¿é™©ä¸¤å¤§ç±»ã€‚</p>
<p>æˆ‘ä»¬æ—¥å¸¸ä¸­å¸¸è¯´ã€Œäº”é™©ä¸€é‡‘ã€ï¼š</p>
<ul>
<li>ã€Œäº”é™©ã€å…¶å®å°±æ˜¯æŒ‡ã€Œç¤¾ä¼šä¿é™©ã€ï¼Œç®€ç§°ç¤¾ä¿ï¼ŒåŒ…æ‹¬å…»è€ä¿é™©ã€åŒ»ç–—ä¿é™©ã€ç”Ÿè‚²ä¿é™©ã€å·¥ä¼¤ä¿é™©ã€å¤±ä¸šä¿é™©ã€‚</li>
<li>ã€Œä¸€é‡‘ã€æŒ‡çš„æ˜¯ä½æˆ¿å…¬ç§¯é‡‘ã€‚</li>
</ul>
<p><strong>äººå¯¿ä¿é™©ã€æ„å¤–é™©ã€é‡ç–¾é™©è¿™å‡ ä¸ªé™©ç§æ˜¯ç›¸äº’è¡¥å……çš„å…³ç³»</strong>ã€‚</p>
<p><strong>ä¹°äº†é‡ç–¾é™©å°±ä¸ç”¨ä¹°å¯¿é™©</strong>ï¼Ÿ<strong>éä¹Ÿ</strong>ã€‚é‡ç–¾é™©çš„èº«æ•…è´£ä»»æ˜¯å’Œé‡ç–¾å…±äº«ä¿é¢çš„ã€‚å°±æ˜¯è¯´ï¼Œå¦‚æœå°æ˜æ‚£äº†é‡ç–¾ï¼Œç„¶åä¿é™©å…¬å¸å°±æŠŠé’±èµ”ç»™ä»–ï¼Œèº«æ•…ä¿éšœè´£ä»»å°±å®Œå…¨ç»ˆæ­¢äº†ã€‚å¦‚æœå°æ˜é‡ç–¾ä¸æ²»è€Œäº¡ï¼Œä¿é™©å…¬å¸å°±ä¸ä¼šèµ”ä»–èº«æ•…è´¹ç”¨ã€‚è€Œä¸”é‡ç–¾é™©çš„æ²»ç–—è´¹ç”¨é«˜æ˜‚ï¼Œå¦‚æœä½ ä¹°äº† 30/50 ä¸‡çš„ä¿é¢ï¼Œé’±å¾ˆå®¹æ˜“å°±èŠ±å…‰äº†ï¼Œå¯¿é™©è´£ä»»åˆ™æ˜æ˜¾ä¸è¶³ã€‚</p>
<p><strong>ä¹°äº†æ„å¤–é™©å°±ä¸ç”¨ä¹°å¯¿é™©</strong>ï¼Ÿ<strong>éä¹Ÿ</strong>ã€‚ä¸¾ä¸ªæ —å­ï¼Œæ„å¤–é™©ä¸€èˆ¬æ˜¯ä¸ä¿çŒæ­»é£é™©çš„ã€‚çŒæ­»çš„å†…æ¶µå¯ä»¥æ¦‚æ‹¬ä¸º â€œå› ç—…çªç„¶æ­»äº¡â€ã€‚è€Œæ„å¤–é™©æ˜¯ä¸ä¿å› ç—…è€Œä¼¤æ®‹å’Œæ­»äº¡çš„ã€‚æ‰€ä»¥è¿™ä¸ªåªèƒ½åœ¨é‡ç–¾é™©å’Œå¯¿é™©é‡Œé¢èµ”ä»˜ã€‚ç›¸å¯¹è€Œè¨€ï¼Œå¯¿é™©çš„èŒƒå›´è¦å¹¿å¾ˆå¤šã€‚</p>
<p><strong>ä¹°äº†é‡ç–¾é™©å°±ä¸ç”¨ä¹°æ„å¤–é™©ï¼Ÿéä¹Ÿã€‚</strong>ä¸¾ä¸ªæ —å­æ¥è¯´æ˜ä¸€ä¸‹ï½A å…ˆç”Ÿè´­ä¹°äº†ä¸€ä»½ 100 ä¸‡ä¿é¢çš„é‡ç–¾é™©ï¼Œæ²¡è´­ä¹°æ„å¤–é™©ã€‚åœ¨æŸæ¬¡é©¾è½¦è¿‡ç¨‹ä¸­ï¼Œä¸å°å¿ƒå‘ç”Ÿäº†è½¦ç¥¸ï¼Œé€ æˆå·¦æ‰‹ä¸­æŒ‡åŠŸèƒ½ä¸§å¤±ã€æ— åæŒ‡å’Œé£ŸæŒ‡ç¼ºå¤±ã€‚ä¸ç¬¦åˆä¿é™©åˆåŒçº¦å®šçš„ç–¾ç—…å®šä¹‰ï¼Œæ— æ³•è·å¾—èµ”ä»˜ã€‚</p>
<p><strong>å¤§éƒ¨åˆ†å•†ä¸šä¿é™©ä¸»è¦ä¸ºä»¥ä¸‹ä¸‰ç§ç±»å‹</strong>ï¼š</p>
<ol>
<li>ç»™ä»˜å‹ï¼šå³å‘ç”Ÿä¿é™©äº‹æ•…æˆ–ç¬¦åˆç†èµ”æ¡ä»¶æ—¶ï¼Œä¿é™©å…¬å¸æŒ‰ç…§åˆåŒçº¦å®šçš„é‡‘é¢ä¸€æ¬¡æ€§æˆ–åˆ†å›ºå®šçš„å¤šæ¬¡å°†ä¿é¢æ”¯ä»˜ç»™è¢«ä¿é™©äººã€‚æ¯”å¦‚é‡ç–¾é™©ã€‚</li>
<li>æŠ¥é”€å‹/è¡¥å¿å‹ï¼šå³å‘ç”Ÿä¿é™©äº‹æ•…æˆ–ç¬¦åˆç†èµ”æ¡ä»¶æ—¶ï¼Œä¿é™©å…¬å¸å°†è¢«ä¿é™©äººå› ä¸ºå‡ºé™©äº‹ä»¶å®é™…æ”¯å‡ºæˆ–å®é™…æŸå¤±ï¼Œå°†åœ¨ä¿é¢èŒƒå›´å†…çš„é‡‘é¢æ”¯ä»˜ç»™è¢«ä¿é™©äººã€‚ç±»ä¼¼äºäºŒæ¬¡æŠ¥é”€çš„é˜²ç™Œé™©ã€‚æ¯”å¦‚äºŒæ¬¡æŠ¥é”€å‹çš„åŒ»ç–—ä¿é™©ã€‚</li>
<li>æ´¥è´´å‹ï¼šä¸»è¦ç”¨äºå‘ç”Ÿä¿é™©äº‹æ•…æ—¶ï¼Œè¢«ä¿é™©äººä¸èƒ½å‚åŠ å·¥ä½œé€ æˆçš„æ”¶å…¥æŸå¤±ï¼Œä»¥åŠå› ä¸ºä½é™¢æ²»ç–—äº§ç”Ÿçš„å¿…è¦é—´æ¥è´¹ç”¨ç­‰çš„æŸå¤±çš„èµ”ä»˜ï¼Œä¸€èˆ¬æ˜¯æŒ‰ä¿é™©åˆåŒçº¦å®šçš„é‡‘é¢æ”¯ä»˜ã€‚</li>
</ol>
<h4 id="äººèº«ä¿é™©çš„ç±»å‹"><a href="#äººèº«ä¿é™©çš„ç±»å‹" class="headerlink" title="äººèº«ä¿é™©çš„ç±»å‹"></a>äººèº«ä¿é™©çš„ç±»å‹</h4><p>æ¯ä¸ªå›½å®¶çš„ä¿é™©åˆ’åˆ†éƒ½æ˜¯ä¸åŒçš„ã€‚åœ¨ä¸­å›½ï¼Œäººèº«ä¿é™©æ˜¯æŒ‡ä»¥äººçš„å¯¿å‘½å’Œèº«ä½“ä¸ºä¿é™©æ ‡çš„çš„ä¸€ç§ä¿é™©ï¼Œåˆ†ä¸ºä¸‰ç§ï¼šå¯¿é™©ã€å¥åº·é™©å’Œæ„å¤–é™©ã€‚</p>
<p>åœ¨å¸‚é¢ä¸Šå•ç‹¬é”€å”®çš„å¯¿é™©ï¼Œæœ€é•¿åªä¼šä¿éšœåˆ° 70 å‘¨å²ã€‚</p>
<ul>
<li>äººå¯¿ä¿é™©ï¼šæ˜¯ä¸€ç§ä»¥äººçš„ç”Ÿæ­»ä¸ºä¿é™©å¯¹è±¡çš„ä¿é™©ï¼Œæ˜¯è¢«ä¿é™©äººåœ¨ä¿é™©è´£ä»»æœŸå†…ç”Ÿå­˜æˆ–æ­»äº¡ï¼Œç”±ä¿é™©äººæ ¹æ®å¥‘çº¦è§„å®šç»™ä»˜ä¿é™©é‡‘çš„ä¸€ç§ä¿é™©ã€‚åœ¨ä¸­å›½äººå¯¿ä¿é™©çš„ä¸šåŠ¡èŒƒå›´åŒ…æ‹¬ç”Ÿå­˜ä¿é™©ã€æ­»äº¡ä¿é™©ã€ä¸¤å…¨ä¿é™©ã€‚</li>
<li>å¥åº·ä¿é™©ï¼šæ˜¯ä»¥éæ„å¤–ä¼¤å®³è€Œç”±è¢«ä¿é™©äººæœ¬èº«ç–¾ç—…å¯¼è‡´çš„ä¼¤æ®‹ã€æ­»äº¡ä¸ºä¿é™©æ¡ä»¶çš„ä¿é™©ã€‚</li>
<li>æ„å¤–ä¼¤å®³ä¿é™©ï¼šæ˜¯ä»¥äººçš„èº«ä½“é­å—æ„å¤–ä¼¤å®³ä¸ºä¿é™©æ¡ä»¶çš„ä¿é™©ã€‚</li>
</ul>
<p><strong>ä»€ä¹ˆæ˜¯é•¿æœŸé™©å’ŒçŸ­æœŸé™©</strong>ï¼Ÿ</p>
<p>é•¿æœŸé™©ï¼šä¿é™©æœŸä¸ºä¸€å¹´ä»¥ä¸Šçš„ä¿é™©ï¼Œå¤šæ•°æ˜¯å¯¿é™©ï¼ˆåŒ…æ‹¬ä¸¤å…¨ã€å®šæœŸå¯¿é™©å’Œç»ˆèº«å¯¿é™©ï¼Œåˆ†çº¢å‹æˆ–éåˆ†çº¢å‹ï¼‰å’Œå¥åº·é™©ä¸­çš„é‡ç–¾é™©</p>
<p>çŸ­æœŸé™©ï¼šä¿é™©æœŸä¸ºä¸€å¹´åŠä»¥ä¸‹çš„ä¿é™©ï¼Œå¤šæ•°æ˜¯æ„å¤–é™©ï¼ˆå½“ç„¶ç°åœ¨é•¿æœŸæ„å¤–é™©ä¹Ÿä¸å°‘è§äº†ï¼‰å’Œå¥åº·é™©ä¸­çš„åŒ»ç–—é™©ï¼Œå› ä¸ºè¿™äº›äº§å“ç†èµ”ç»éªŒæ³¢åŠ¨å¾ˆå¤§ï¼ŒåšæˆçŸ­æœŸé™©æ–¹ä¾¿è°ƒæ•´è´¹ç‡æˆ–ç»ˆæ­¢é”€å”®ã€‚</p>
<p>å¯¹äºäººèº«é™©ï¼Œå¦‚æœæœ‰é•¿æœŸäº§å“è´­ä¹°å°±è´­ä¹°é•¿æœŸçš„ï¼Œä¸æ¨èè´­ä¹°çŸ­æœŸäº§å“ï¼Œæ­£æ˜¯å› ä¸ºä¸€èˆ¬ä¸ä¿è¯ä¸‹ä¸€å¹´èƒ½ç»­ä¿ï¼Œé€šå¸¸ä¹Ÿä¸ä¿è¯è´¹ç‡çš„å› ç´ ã€‚</p>
<p><strong>ç†è´¢å‹ vs ä¿éšœå‹ä¿é™©</strong></p>
<p>ç†è´¢å‹ä¿é™©ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸€ç§ç†è´¢å…¼é¡¾ä¿é™©ä½œç”¨çš„äº§å“ã€‚ä¿è´¹åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¿è´¹ç”¨æ¥æä¾›ä¿é™©ä¿éšœï¼ˆä¾‹å¦‚èº«æ•…è¿”è¿˜ç­‰ï¼‰ï¼Œè€Œå¦ä¸€éƒ¨åˆ†ç”¨æ¥æŠ•èµ„ã€‚</p>
<p>ç²¾ç®—å¸ˆè®¤ä¸ºï¼Œ<strong>å¯¹äºç†è´¢å‹ä¿é™©ï¼Œåº”æ›´å¤šçš„å°†å…¶è§†ä¸ºç†è´¢äº§å“è€Œéä¿é™©</strong>ï¼Œå¦‚æœéœ€è¦çš„æ˜¯é£é™©ä¿éšœï¼Œé‚£ä¹ˆè¿˜æ˜¯è´­ä¹°ä¼ ç»Ÿä¿éšœå‹äº§å“æ›´åˆé€‚ã€‚</p>
<p>é€šå¸¸ï¼Œç†è´¢å‹ä¿é™©çš„ä¿éšœä¸è¶³ï¼Œç†è´¢çš„æ”¶ç›Šä¹Ÿä¸é«˜ï¼Œæ‰€ä»¥ï¼Œä¸€èˆ¬å»ºè®®å¦‚æœéœ€è¦çš„æ˜¯é£é™©ä¿éšœï¼Œé‚£ä¹ˆè¿˜æ˜¯è´­ä¹°ä¼ ç»Ÿä¿éšœå‹äº§å“æ›´åˆé€‚ã€‚å¦‚æœéœ€è¦ç†è´¢ï¼Œé‚£ä¹ˆè´­ä¹°ä¸“ä¸šçš„ç†è´¢äº§å“æ”¶ç›Šç‡ä¼šæ›´åŠ å¯è§‚ã€‚</p>
<h2 id="3ã€é‡ç–¾"><a href="#3ã€é‡ç–¾" class="headerlink" title="3ã€é‡ç–¾"></a>3ã€é‡ç–¾</h2><p>ä»€ä¹ˆæ˜¯é‡ç–¾ä¿éšœï¼Ÿä¿é™©äº§å“ä¸­çš„é‡ç–¾å®šä¹‰æ˜¯æœ‰ä¸¥æ ¼è§„å®šçš„ã€‚ç®€å•æ¥è¯´æ ¹æ®ä¸­å›½ä¿é™©ç›‘ç£ç®¡ç†å§”å‘˜ä¼šï¼ˆç®€ç§°ã€Œä¿ç›‘ä¼šã€ï¼‰äº§å“ç›‘ç®¡è¦æ±‚ï¼Œèƒ½å† åé‡ç–¾äº§å“çš„ä¿é™©äº§å“å¿…é¡»æŒ‰ä¸­å›½ä¿é™©è¡Œä¸šåä¼šä¸ä¸­å›½åŒ»å¸ˆåä¼šçš„é‡ç–¾å®šä¹‰æä¾›ä»¥ä¸‹ 6 ç§ä¿éšœï¼š<strong>æ¶æ€§è‚¿ç˜¤ã€æ€¥æ€§å¿ƒè‚Œæ¢—å¡ã€è„‘ä¸­é£åé—ç—‡ã€é‡å¤§å™¨å®˜ç§»æ¤æœ¯æˆ–é€ è¡€å¹²ç»†èƒç§»æ¤æœ¯ã€å† çŠ¶åŠ¨è„‰æ­æ¡¥æœ¯å’Œç»ˆæœ«æœŸè‚¾ç—…</strong>ã€‚åªæœ‰ä¿éšœäº†è¿™ 6 ç§æ ¸å¿ƒé‡ç–¾çš„äº§å“æ‰èƒ½è¢«å‘½åä¸º â€œXX é‡å¤§ç–¾ç—…ä¿é™©â€ï¼Œè¿™6ç§é‡ç–¾å·²ç»å åˆ°ä¸€èˆ¬äººç¾¤æ‰€æœ‰é‡ç–¾å‘ç—…çš„  80%-85%ã€‚</p>
<p>é‡ç–¾é™©å±äºç»™ä»˜å‹çš„å¥åº·é™©ã€‚ç»å¤§å¤šæ•°<strong>é‡ç–¾é™©æŒ‰ç»™ä»˜æ–¹å¼åªåˆ†ä¸ºä¸¤ç§</strong>ï¼š</p>
<ol>
<li><strong>æå‰ç»™ä»˜å‹</strong>ï¼šé‡å¤§ç–¾ç—…ä¿é™©é‡‘ä¸äº§å“æˆ–äº§å“ç»„åˆé‡ŒåŒ…å«çš„ä»»ä½•èº«æ•…ä¿é™©é‡‘è´£ä»»å…±ç”¨ä¿é¢ï¼Œä¹Ÿå°±æ˜¯èº«æ•…æˆ–é‡ç–¾å“ªä¸ªå…ˆå‘ç”Ÿå°±å…ˆèµ”ä¿é¢ï¼Œä½†<strong>åªèµ”ä»˜ä¸€æ¬¡</strong>ï¼Œèµ”ä»˜å®Œä¹‹åï¼Œä¿å•å³ç»ˆæ­¢å¤±æ•ˆï¼Œå› æ­¤äº§å“ä»·æ ¼è¾ƒé¢å¤–ç»™ä»˜çš„äº§å“ä¾¿å®œã€‚</li>
<li><strong>é¢å¤–ç»™ä»˜å‹</strong>ï¼šåªè¦å‘ç”Ÿé‡ç–¾å°±ç»™ä»˜é‡å¤§ç–¾ç—…ä¿é™©é‡‘ä¿é¢ï¼Œä¿å•ç»§ç»­æœ‰æ•ˆï¼Œåç»­å¦‚æœèº«æ•…å¹¶ä¸”äº§å“æˆ–äº§å“ç»„åˆé‡Œæœ‰æä¾›èº«æ•…è´£ä»»çš„ç›¸å…³ä¿é™©ï¼Œå†ç»™ä»˜ä¸€æ¬¡èº«æ•…ä¿é™©é‡‘ï¼Œå¾ˆæ˜æ˜¾ç”±äºå®ƒæœ‰<strong>å¯èƒ½èµ”ä»˜ä¸¤æ¬¡</strong>ï¼ˆå…ˆé‡ç–¾ä¸€æ¬¡ã€èº«æ•…å†èµ”ä¸€æ¬¡ï¼‰ï¼Œæ‰€ä»¥å®ƒçš„ä»·æ ¼è¦æ¯”æå‰ç»™ä»˜å‹äº§å“è¦è´µã€‚</li>
</ol>
<h3 id="3-1-é‡ç–¾ä¿éšœçš„ç—…ç§æ•°ç›®è¶Šå¤§è¶Šå¥½å—ï¼Ÿ"><a href="#3-1-é‡ç–¾ä¿éšœçš„ç—…ç§æ•°ç›®è¶Šå¤§è¶Šå¥½å—ï¼Ÿ" class="headerlink" title="3.1 é‡ç–¾ä¿éšœçš„ç—…ç§æ•°ç›®è¶Šå¤§è¶Šå¥½å—ï¼Ÿ"></a>3.1 é‡ç–¾ä¿éšœçš„ç—…ç§æ•°ç›®è¶Šå¤§è¶Šå¥½å—ï¼Ÿ</h3><p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/%E9%87%8D%E7%96%BE%E5%8F%91%E7%97%85%E7%8E%87.jpg" alt=""></p>
<p>æˆªæ­¢ 2016 å¹´ä¿ç›‘ä¼šæœ€æ–°å®šä¹‰çš„è¡Œä¸šæ ‡å‡†é‡å¤§ç–¾ç—…æ˜¯ 25 ç§ï¼Œæˆ‘ä»¬å¯ä»¥ç®€ç§°ä¸º <strong>â€œè¡Œæ ‡ 25 ç§ï¼Œå¿…å¤‡ 6 ç§â€</strong>ã€‚è¿™ 6+19 ç§ä¸€å…± 25 ç§é‡ç–¾å·²ç»å åˆ°äº†æ‰€æœ‰é‡ç–¾å‘ç”Ÿæ¦‚ç‡çš„ 95%ã€‚ç›®å‰æ— è®ºä¿éšœèŒƒå›´æ˜¯ 80 ç§é‡ç–¾ï¼Œè¿˜æ˜¯ 100 ç§é‡ç–¾ï¼Œå‰ 6 ç§ç—…ç§å„å®¶ä¿é™©å…¬å¸å®šä¹‰éƒ½æ˜¯ç›¸åŒçš„ï¼Œ19 ç§æ˜¯å¦‚æœæœ‰ï¼Œéœ€è¦è·Ÿæ ‡å‡†ä¸­è§„å®šçš„ä¸€è‡´ã€‚</p>
<p><strong>æ‰€ä»¥ï¼Œç—…ç§æ•°é‡ä¸ä»£è¡¨ä»€ä¹ˆ</strong>ã€‚å¯¹äº 99% çš„å›½äººæ¥è¯´ï¼Œé‡åˆ°è¡Œä¸š 25 ç§é‡ç–¾ä¹‹å¤–çš„å…¶ä»–é‡ç–¾æ¦‚ç‡å®åœ¨æ˜¯å¾®ä¹å…¶å¾®ã€‚ </p>
<h3 id="3-2-ä»€ä¹ˆæ˜¯é‡ç–¾åˆ†ç»„ï¼Ÿï¼Ÿ"><a href="#3-2-ä»€ä¹ˆæ˜¯é‡ç–¾åˆ†ç»„ï¼Ÿï¼Ÿ" class="headerlink" title="3.2 ä»€ä¹ˆæ˜¯é‡ç–¾åˆ†ç»„ï¼Ÿï¼Ÿ"></a>3.2 ä»€ä¹ˆæ˜¯é‡ç–¾åˆ†ç»„ï¼Ÿï¼Ÿ</h3><p><strong>ç»å¸¸çœ‹åˆ° â€œé‡ç–¾åˆ†ç»„â€ è¿™ä¸ªè¯ï¼Œæ˜¯ä»€ä¹ˆæ„æ€</strong>ï¼Ÿ</p>
<p>è§£ç­”ï¼šæŸé‡ç–¾é™©åˆ† ABCD å››ä¸ªç»„ï¼Œå‡è®¾æŸäººå¾—äº† B ç»„ä¸­çš„ç–¾ç—… B1ï¼Œä¿é™©å…¬å¸ç†èµ”è¿‡äº†ï¼Œä»¥ååªç®¡ ACD ç»„é‡Œçš„ç–¾ç—…ï¼Œå†å¾— B ç»„é‡Œçš„ä»»ä½•ç–¾ç—…éƒ½ä¸èµ”ä»˜ï¼Œè¿™æ˜¯é‡ç–¾åˆ†ç»„çš„æ¶µä¹‰ã€‚åˆ†ç»„åœ¨æœ¬è´¨ä¸Šæ˜¯ä¿é™©å…¬å¸åœ¨å›é¿è‡ªå·±çš„é£é™©ï¼Œå› ä¸º<strong>åˆ†ç»„ååŒä¸€ç»„åˆ«åªèµ”ä»˜ä¸€æ¬¡</strong>ã€‚</p>
<p>å¯¹äºå¤šæ¬¡èµ”ä»˜çš„é‡ç–¾ï¼Œç›´è§‚åœ°çœ‹æ˜¯ä¸åˆ†ç»„è‡ªç„¶æ¯”åˆ†ç»„çš„å¥½ï¼Œä½†é‡ç–¾é™©ä¸åˆ†ç»„æ„å‘³ç€ä¿é™©å…¬å¸èµ”ä»˜çš„æ¦‚ç‡æ›´å¤§ã€é£é™©æ›´é«˜ã€‚æ‰€ä»¥å¸‚é¢ä¸Šå¤šæ¬¡èµ”ä»˜çš„é‡ç–¾é™©ï¼Œä¸åˆ†ç»„çš„æ¯”è¾ƒå°‘ï¼Œä»·æ ¼ä¹Ÿå¾ˆé«˜ã€‚</p>
<p><strong>è´­ä¹°é‡ç–¾åˆ†ç»„çš„äº§å“åº”è¯¥æ€ä¹ˆé€‰</strong>ï¼Ÿ</p>
<ol>
<li>ç™Œç—‡ï¼ˆæ¶æ€§è‚¿ç˜¤ï¼‰å•ç‹¬åˆ†ç»„çš„å¥½è¿‡ç™Œç—‡ä¸å•ç‹¬åˆ†ç»„ï¼Œæ²¡æœ‰å•ç‹¬åˆ†ç»„ä½†åŒç»„ç–¾ç—…çš„æ•°é‡å°‘æˆ–è€…æ²¡æœ‰é‚£ä¹ˆé«˜å‘ä¹Ÿæ˜¯æ¯”è¾ƒå¥½çš„æƒ…å†µã€‚</li>
<li>åˆ†ç»„å¤šã€é«˜å‘ç–¾ç—…è¶Šåˆ†æ•£è¶Šå¥½ã€‚</li>
</ol>
<p>å¯¹äºé‡ç–¾å¤šæ¬¡èµ”ä»˜çš„äº§å“ï¼Œæˆ‘ä»¬è®¤ä¸ºç™Œç—‡å¤šæ¬¡èµ”ä»˜ &gt; é‡ç–¾ä¸åˆ†ç»„ &gt; é‡ç–¾åˆ†ç»„åˆç† &gt; é‡ç–¾åˆ†ç»„ä¸åˆç†ï¼Œæœ€å¥½çš„æ˜¯ç™Œç—‡å¤šæ¬¡èµ”ä»˜çš„ã€‚</p>
<h4 id="3-2-1åˆ†ç»„è·Ÿä¸åˆ†ç»„çš„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#3-2-1åˆ†ç»„è·Ÿä¸åˆ†ç»„çš„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="3.2.1åˆ†ç»„è·Ÿä¸åˆ†ç»„çš„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>3.2.1åˆ†ç»„è·Ÿä¸åˆ†ç»„çš„æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h4><p>å…¶å®é‡ç–¾é™©ä¸­æœ€ä¼˜çš„é€‰æ‹©æ˜¯é‡ç–¾ä¸åˆ†ç»„ä¸”èµ”ä»˜å¤šæ¬¡çš„ï¼Œæ¯”å¦‚é•¿ç”Ÿç¦ä¼˜åŠ ï¼Œå®ƒæ˜¯ 100 ç§é‡ç–¾ä¸åˆ†ç»„ï¼Œæœ€é«˜èµ”ä»˜ 2 æ¬¡çš„ã€‚å½“ç„¶ä»·æ ¼ä¹Ÿä¼šæ¯”è¾ƒè´µï¼Œä¸åˆ†ç»„çš„å¤šæ¬¡èµ”ä»˜é‡ç–¾é™©ä¼šæ¯”åˆ†ç»„çš„å¤šæ¬¡èµ”ä»˜é‡ç–¾é™©è´¹ç‡è¦è´µå¾ˆå¤šï¼Œè¦æ¸…æ¥šè‡ªå·±çš„é¢„ç®—ã€‚</p>
<p><strong>é•¿ç”Ÿç¦ä¼˜åŠ  &gt; åº·ä¹ä¸€ç”ŸåŠ å€ä¿ &gt; å¸¸é’æ ‘åŠ å€ç‰ˆ &gt; å¼˜åº·å¤šå•¦ A ä¿</strong>ã€‚</p>
<h4 id="3-2-2åˆ†ç»„çš„é€‰æ‹©åŸåˆ™"><a href="#3-2-2åˆ†ç»„çš„é€‰æ‹©åŸåˆ™" class="headerlink" title="3.2.2åˆ†ç»„çš„é€‰æ‹©åŸåˆ™"></a>3.2.2åˆ†ç»„çš„é€‰æ‹©åŸåˆ™</h4><p>1ã€æ¶æ€§è‚¿ç˜¤æœ€å¥½å•ç‹¬åˆ†ç»„ï¼Œè¿™ä¸ªæœ€é‡è¦ã€‚<br>2ã€æ¶æ€§è‚¿ç˜¤ã€ç»ˆæœ«æœŸè‚¾ç—…ã€é‡å¤§ç–¾å™¨å®˜ç§»æ¤æœ¯æˆ–é€ è¡€å¹²ç»†èƒç§»æ¤æœ¯ï¼Œè¿™ä¸‰ç±»é‡ç–¾çš„å†…åœ¨å…³è”æ€§è¾ƒå¼ºï¼Œæœ€å¥½å¯ä»¥æŠŠå®ƒä»¬åˆ†é…åˆ°ä¸åŒç»„åˆ«ã€‚<br>3ã€æ€¥æ€§å¿ƒæ¢—åè¦é©¬ä¸Šå®æ–½å† çŠ¶åŠ¨è„‰æ­æ¡¥æ‰‹æœ¯ï¼Œæ—¶é—´é—´éš”éå¸¸çŸ­ï¼Œå¦‚æœåˆ†ç»„äº†ï¼Œè¦æ³¨æ„é—´éš”æœŸã€‚</p>
<h3 id="3-3èµ”ä»˜å¤šå°‘æ¬¡çš„æœ€ä½³ï¼Ÿ"><a href="#3-3èµ”ä»˜å¤šå°‘æ¬¡çš„æœ€ä½³ï¼Ÿ" class="headerlink" title="3.3èµ”ä»˜å¤šå°‘æ¬¡çš„æœ€ä½³ï¼Ÿ"></a>3.3èµ”ä»˜å¤šå°‘æ¬¡çš„æœ€ä½³ï¼Ÿ</h3><p>å…¶æ¬¡ä¹°é‡ç–¾é™©ï¼Œèµ”ä»˜æ¬¡æ•° 2~4 æ¬¡æœ€ä½³ï¼Œè™½ç„¶å¸‚é¢ä¸Šç°åœ¨å‡ºç°äº†å¾ˆå¤šå¯èµ”ä»˜ 5 æ¬¡ã€6 æ¬¡ï¼Œç”šè‡³ 7 æ¬¡çš„é‡ç–¾é™©ï¼Œä½†è¿™å…¶å®æ˜¯ä¿é™©å…¬å¸ä¸ºäº†é™ä½èµ”ä»˜ç‡ä»è€Œåšå‡ºçš„é€‰æ‹©ã€‚</p>
<p>å…¶å®é‡ç–¾èµ”ä»˜ 2 æ¬¡ï¼Œè½»ç—‡ 3 æ¬¡åŸºæœ¬å·²ç»è¶³å¤Ÿäº†ï¼Œæ¬¡æ•°å¤ªå¤šå¹¶æ— å¤ªå¤§çš„å®è´¨æ„ä¹‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œèµ”ä»˜é—´éš” 90 å¤©ï½180 å¤©æœ€ä½³ï¼Œ1 å¹´é—´éš”æœŸå¤ªé•¿ï¼Œä¸å»ºè®®é€‰è´­ã€‚</p>
<h2 id="4ã€ä¸­ç—‡"><a href="#4ã€ä¸­ç—‡" class="headerlink" title="4ã€ä¸­ç—‡"></a>4ã€ä¸­ç—‡</h2><p>ä¸­ç—‡å°±æ˜¯å¤„äºè½»ç—‡å’Œé‡ç–¾é™©ä¹‹é—´çš„æƒ…å†µï¼Œæ¯”è½»ç—‡ä¸¥é‡ä¸€ç‚¹ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è¾¾åˆ°é‡ç–¾çš„ä¸¥é‡ç¨‹åº¦ï¼Œä½†æ˜¯ç†èµ”çš„é‡‘é¢ä¹Ÿæ¯”è½»ç—‡ä¼šæ›´å¤šä¸€äº›ã€‚</p>
<h2 id="5ã€è½»ç—‡"><a href="#5ã€è½»ç—‡" class="headerlink" title="5ã€è½»ç—‡"></a>5ã€è½»ç—‡</h2><p>è½»ç—‡åˆå«åš<strong>è½»åº¦é‡ç–¾</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç—…ä¹Ÿæ˜¯ç—…ï¼Œä½†æ²¡æœ‰é‡ç–¾ã€ä¸­ç—‡é‚£ä¹ˆä¸¥é‡ï¼Œä¸è¿‡å¦‚æœæ²¡æœ‰å¾—åˆ°åŠæ—¶çš„å‘ç°æˆ–è€…æ²»ç–—ï¼Œä»»ç”±å…¶å‘å±•ï¼Œé‚£ä¹ˆå¾ˆå¤§æ¦‚ç‡ä¼šé€ æˆé‡ç–¾ã€‚æ¯”å¦‚è¯´ç™Œç—‡çš„å‰æœŸè¡¨ç°å°±æ˜¯åŸä½ç™Œï¼Œè„‘ç‚åé—ç—‡çš„å‰æœŸå°±æ˜¯è„‘ç‚ï¼Œè„‘ä¸­é£åé—ç—‡çš„å‰æœŸæ˜¯è½»å¾®è„‘ä¸­é£ç­‰ç­‰ã€‚</p>
<h2 id="6ã€å°ä¿é™©å…¬å¸é è°±å—ï¼Ÿæˆ‘ä¹°çš„ä¿å•å®‰ä¸å®‰å…¨ï¼Œæœ€åèƒ½ä¸èƒ½èµ”ï¼Ÿ"><a href="#6ã€å°ä¿é™©å…¬å¸é è°±å—ï¼Ÿæˆ‘ä¹°çš„ä¿å•å®‰ä¸å®‰å…¨ï¼Œæœ€åèƒ½ä¸èƒ½èµ”ï¼Ÿ" class="headerlink" title="6ã€å°ä¿é™©å…¬å¸é è°±å—ï¼Ÿæˆ‘ä¹°çš„ä¿å•å®‰ä¸å®‰å…¨ï¼Œæœ€åèƒ½ä¸èƒ½èµ”ï¼Ÿ"></a>6ã€å°ä¿é™©å…¬å¸é è°±å—ï¼Ÿæˆ‘ä¹°çš„ä¿å•å®‰ä¸å®‰å…¨ï¼Œæœ€åèƒ½ä¸èƒ½èµ”ï¼Ÿ</h2><p>åœ¨ä¸­å›½å¦‚æœæŸä¸ªå…¬å¸è¦ç»è¥ä¿é™©ä¸šåŠ¡ï¼Œè¦å–ä¿å•ç»™è‡ªç„¶äººæˆ–ä¼ä¸šï¼Œæ ¹æ®ä¿é™©æ³•ï¼Œ<strong>è¿™ä¸ªå…¬å¸å¿…é¡»æŒæœ‰ä¿ç›‘ä¼šæ‰¹å‡†çš„ä¿é™©ä¸šåŠ¡ç»è¥è®¸å¯ç‰Œç…§ï¼Œå¹¶æ¥å—å¿ä»˜èƒ½åŠ›ç›‘ç®¡</strong>ã€‚<strong>è€Œä¿é™©å…¬å¸ç‰Œç…§æ˜¯ç¨€ç¼ºèµ„æº</strong>ã€‚æ®è¯´å„ç§åœ¨ä¿ç›‘ä¼šæ’é˜Ÿç­‰æ‰¹ç‰Œç…§çš„å…¬å¸ç›®å‰è¶…è¿‡äº† 100 å®¶ã€‚</p>
<p><strong>ä»å¯¹ä¿é™©å…¬å¸å¿ä»˜èƒ½åŠ›ç›‘ç®¡æ¥çœ‹ï¼Œä¸­å›½æ˜¯ç›®å‰ä¸–ç•Œä¸Šä¿é™©ä¸šç›‘ç®¡æ°´å¹³æœ€å…¨é¢æœ€å…ˆè¿›çš„å›½å®¶ä¹‹ä¸€</strong>ã€‚</p>
<p>ä¸­å›½ä¿é™©ä¸šçš„å¿ä»˜èƒ½åŠ›äºŒä»£ç›‘ç®¡è§„åˆ™ï¼Œä¸šå†…ç®€ç§° C-ROSSï¼Œæ˜¯ä»¥é£é™©ä¸ºå¯¼å‘çš„æ–°ä¸€ä»£å¿ä»˜èƒ½åŠ›ç›‘ç®¡è§„åˆ™ã€‚å…·ä½“æ€ä¹ˆè®¡ç®—å®åœ¨å¤ªä¸“ä¸šäº†ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚ç®€å•æ¥è¯´ï¼Œæ ¹æ®ç›‘ç®¡è¦æ±‚å’ŒæŒ‡å¼•ï¼Œåœ¨æ¯å­£æœ«ã€æ¯å¹´æœ«ä¿é™©å…¬å¸ä¼šé€šè¿‡å»ºç«‹è¯¦å°½çš„æ•°å­¦æ¨¡å‹å’Œå‹åŠ›æµ‹è¯•åèƒ½ç¡®ä¿<strong>è‡ªå·±æœ‰èƒ½åŠ›åœ¨ 99.5% çš„æ¦‚ç‡ä¸‹æ— è®ºå‘ç”Ÿä»€ä¹ˆäº‹ä»¶éƒ½ä¸ä¼šå€’é—­</strong>ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸­å›½ä¹°ä¿é™©ä¸ç”¨çœ‹å…¬å¸å¤§å°ï¼Œå› ä¸ºé—¨æ§›é«˜ï¼Œç›‘ç®¡ä¸¥ï¼Œå³ä½¿çœŸç ´äº§äº† zf ä¹Ÿä¼šå…œåº•ï¼Œæ‰€ä»¥ä¸»è¦çœ‹äº§å“çš„æ€§ä»·æ¯”ã€‚</p>
<p>ä¸€ä¸ªæ•…äº‹ï¼š</p>
<blockquote>
<p>2008å¹´é‡‘èå±æœºçš„æ—¶å€™ï¼Œå¤§å¤šæ•°äººåªçŸ¥é“é›·æ›¼å…„å¼Ÿç ´äº§ï¼Œå´ä¸çŸ¥é“å½“æ—¶è¿˜æœ‰ä¸€å®¶è§„æ¨¡ç±»ä¼¼çš„å…¬å¸ä¹Ÿæ¿’ä¸´ç ´äº§çš„è¾¹ç¼˜ã€‚å®ƒå°±æ˜¯å‹é‚¦ä¿é™© AIA çš„æ¯å…¬å¸ AIG â€”â€” ç¾å›½å›½é™…é›†å›¢ã€‚<br>AIG ä»å¤§å®¶ç†Ÿæ‚‰çš„ç¾äºšè´¢é™©èµ·å®¶ï¼Œ1919 å¹´æˆç«‹äºä¸Šæµ·ï¼Œå¯ä»¥è¯´å’Œä¸­å›½æœ‰ç€å¾ˆæ·±çš„è”ç³»ã€‚åˆ°ç°åœ¨ï¼ŒAIG æ——ä¸‹çš„å‹é‚¦ä¿é™© AIAï¼Œä»æ˜¯å›½å†…å”¯ä¸€ä¸€å®¶ç‹¬èµ„çš„å¤–èµ„ä¿é™©å…¬å¸ã€‚åœ¨ç¾å›½ï¼ŒAIG ä¹Ÿæ˜¯å·¥å•†é“¶è¡Œæœ€å¤§çš„åŒ…é”€å•†ã€‚<br>é‡‘èå±æœºåˆ°æ¥çš„æ—¶å€™ï¼ŒAIG ä¹Ÿé¢ä¸´äº†ä¸¥é‡çš„æµåŠ¨æ€§å±æœºã€‚<br>ç¾å›½æ”¿åºœåœ¨å¯¹å¾…ä¸¤å®¶å…¬å¸çš„æ€åº¦ä¸Šï¼Œå¯ä»¥è¯´æ˜¯å¤©å£¤ä¹‹åˆ«ã€‚ä¸€è¾¹çœ¼çççš„çœ‹ç€é›·æ›¼å…„å¼Ÿç ´äº§ï¼Œä¸€è¾¹å°±åœ¨é›·æ›¼ç ´äº§çš„ç¬¬äºŒå¤©ï¼Œä¸º AIG æä¾›äº† 850 äº¿ç¾é‡‘çš„è´·æ¬¾ï¼Œå‰å‰ååä¸€å…±èŠ±äº† 1820 äº¿ç¾é‡‘æ•‘æ´ AIG ï¼Œå‡ ä¹ç›¸å½“äºæŠŠ AIG å›½æœ‰åŒ–äº†ã€‚ï¼ˆå½“ç„¶ï¼Œæˆ‘ä¼°è®¡è¿˜æ˜¯ç¾å›½æ”¿åºœå¤ªç©·ï¼Œæ²¡é’±ï¼Œæ•‘ä¸èµ·ä¸¤å®¶å…¬å¸ã€‚å“ˆå“ˆå“ˆã€‚ï¼‰<br>è¿™æ˜¯ç¾å›½å†å²ä¸Šæœ€å¤§è§„æ¨¡çš„ä¸€æ¬¡æ”¿åºœå¯¹ä¼ä¸šèµ„é‡‘æ´åŠ©çš„è¡Œä¸ºã€‚</p>
<p>æµ…å±‚çš„ç†è§£ï¼Œé›·æ›¼å…„å¼Ÿæ˜¯å®¶æŠ•èµ„é“¶è¡Œï¼ŒæŠ•èµ„çš„é’±å˜›ï¼ŒåŸºæœ¬ç®—æ˜¯é—²ä½™èµ„é‡‘ï¼ŒæŠ•èµ„è¿™ä»¶äº‹ï¼Œæœ¬èº«å°±æ˜¯è¦æ‰¿æ‹…é£é™©çš„ï¼Œèµ”äº†ä¹Ÿåªèƒ½è®¤å‘½ã€‚AIG å…¬å¸é‡Œèººç€ç¾å›½æ— æ•°è€ç™¾å§“çš„å…»è€é‡‘ï¼Œè¿™è¦æ˜¯æ‰“äº†æ°´æ¼‚ï¼Œç¤¾ä¼šç¨³å®šéƒ½æˆé—®é¢˜ã€‚æ‰€ä»¥ç¾å›½æ”¿åºœèˆã€Œé›·æ›¼ã€ä¿ã€ŒAIGã€ï¼Œæ˜¯ä¸ºäº†ä¿æŒç¤¾ä¼šç¨³å®šï¼Œé™ä½åŠ¨è¡çš„å¯èƒ½æ€§ã€‚</p>
<p>æ›´æ·±å±‚æ¬¡çš„åŸå› ï¼Œç»æµå­¦ä¸Šæœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œã€Œå¤§åˆ°ä¸èƒ½å€’ã€ï¼ˆToo Big to Failï¼Œç¼©å†™ TBTFï¼‰ï¼ŒæŒ‡å½“ä¸€äº›è§„æ¨¡æå¤§æˆ–åœ¨äº§ä¸šä¸­å…·æœ‰å…³é”®æ€§é‡è¦åœ°ä½çš„ä¼ä¸šæ¿’ä¸´ç ´äº§æ—¶ï¼Œæ”¿åºœä¸èƒ½ç­‰é—²è§†ä¹‹ï¼Œç”šè‡³è¦ä¸æƒœæŠ•å…¥å…¬å¸‘ç›¸æ•‘ï¼Œä»¥é¿å…é‚£äº›ä¼ä¸šå€’é—­åæ‰€æ€èµ·çš„å·¨å¤§è¿é”ååº”é€ æˆç¤¾ä¼šæ•´ä½“æ›´ä¸¥é‡çš„ä¼¤å®³ï¼Œè¿™ç§æƒ…å†µç§°ä¸º ã€Œå¤§åˆ°ä¸èƒ½å€’ã€ã€‚<br>ä¸æ˜¯åªå¤§å°±è¡Œï¼Œå¿…é¡»æ˜¯å€’é—­äº†ä¼šäº§ç”Ÿå¯¹ç¤¾ä¼šç»æµæœ‰å·¨å¤§å½±å“çš„ç³»ç»Ÿæ€§é£é™©ã€‚</p>
</blockquote>
<h2 id="7ã€å¸‚é¢ä¸Šå‡ æ¬¾é‡ç–¾ä¿é™©äº§å“"><a href="#7ã€å¸‚é¢ä¸Šå‡ æ¬¾é‡ç–¾ä¿é™©äº§å“" class="headerlink" title="7ã€å¸‚é¢ä¸Šå‡ æ¬¾é‡ç–¾ä¿é™©äº§å“"></a>7ã€å¸‚é¢ä¸Šå‡ æ¬¾é‡ç–¾ä¿é™©äº§å“</h2><p>æŒ‰ç…§èµ”ä»˜æ¬¡æ•°åˆ†ï¼Œé‡ç–¾ä¿é™©äº§å“å¯åˆ†ä¸ºå•æ¬¡å’Œå¤šæ¬¡ã€‚å¤šæ¬¡èµ”ä»˜çš„äº§å“ä¸­æ ¹æ®åˆ†ç»„ä¸å¦åˆåˆ†ä¸ºä¸¤ç±»ã€‚ä¸‹å›¾ä¸­åˆ—ä¸¾äº†ä¸åŒç±»å‹çš„é‡ç–¾é™©ã€‚å…·ä½“è¯„æµ‹è¯·è‡ªè¡Œ google/baidu :smiley: ã€‚</p>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/%E9%87%8D%E7%96%BE%E9%99%A9%E5%88%86%E7%B1%BB.png" alt=""></p>
<h2 id="8ã€å…¶ä»–"><a href="#8ã€å…¶ä»–" class="headerlink" title="8ã€å…¶ä»–"></a>8ã€å…¶ä»–</h2><p><strong>å¯¿é™©ä¿éšœæœŸé™é€‰æ‹©</strong></p>
<p>ä¸ªäººå€¾å‘äºé€‰æ‹©ä¿ 20 å¹´ï¼Œæˆ–è€…ä¿éšœåˆ° 70 å²ã€‚å‰è€…æ˜¯å› ä¸ºä¿é™©æœŸé—´é€‚ä¸­ï¼Œåè€…æ˜¯å› ä¸ºåˆ° 70 å²ï¼Œå­å¥³å·®ä¸å¤šæˆå¹´å¹¶å·¥ä½œä¸€æ®µæ—¶é—´ç»æµå¾ˆå¯èƒ½å·²ç»ç‹¬ç«‹ï¼Œé‚£æ—¶å€™ä¸‡ä¸€æœ‰äº‹ä¹Ÿä¸ä¼šå¯¹å­å¥³é€ æˆå¤ªå¤§å½±å“</p>
<p><strong>ç¼´è´¹æœŸé™çš„é€‰æ‹©</strong></p>
<p>ç¼´è´¹æœŸé™é€‰æ‹©ï¼Œå¤§éƒ¨åˆ†äººå»ºè®®æ˜¯èƒ½ç¼´å¤šé•¿å°±ç¼´å¤šé•¿ï¼Œä¸»è¦åŸå› ä»–ä»¬è®¤ä¸ºæ˜¯æœªæ¥å¾ˆé•¿ä¸€æ®µæ—¶é—´å›½å†…å°†ä¼šæ˜¯ä½åˆ©ç‡æ—¶ä»£ï¼ˆç›®å‰ä¸€å¹´æœŸå­˜æ¬¾åˆ©ç‡ä»… 1.5%ï¼Œå›½å¤–ç¾å›½æ¬§å…ƒåŒºæ—¥æœ¬è¿™äº›å°±æ›´ä½äº†ï¼‰ï¼Œè€Œä¿é™©äº§å“ç›®å‰å®šä»·åˆ©ç‡ä¸€èˆ¬éƒ½åœ¨ 3.5%ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸é”™çš„ ã€Œæ”¶ç›Šã€ã€‚</p>
<p><strong>ç­‰å¾…æœŸï¼š</strong>è®¾ç½®çš„åˆè¡·æ˜¯ä¸ºäº†é˜²æ­¢æœ¬èº«æ‚£ç—…çš„äººéª—ä¿ï¼Œå³æ‰€è°“ â€œé€†å‘é€‰æ‹©â€ã€‚ä½†æ˜¯æ™®é€šäººå¦‚æœä¸æ³¨æ„è¿™ä¸ªæ—¶é—´ï¼Œå¯èƒ½å‘ç”Ÿæ‚£ç—…æ— æ³•ç†èµ”çš„æƒ…å†µã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå°½é‡é€‰æ‹©ç­‰å¾…æœŸçŸ­çš„äº§å“ã€‚<br><strong>å…è´£ï¼š</strong>å¾ˆå¤šä¿é™©äº§å“çš„ â€œé™·é˜±â€ ä¼šè®¾ç½®åœ¨è¿™é‡Œã€‚<br><strong>è±å…ï¼š</strong>ä¸»è¦å®šä¹‰äº†ä¸€äº›å¯ä»¥å…äº¤æˆ–å°‘äº¤ä¿è´¹çš„æƒ…å†µã€‚ä¸€æ—¦æ„å¤–å‘ç”Ÿï¼Œè±å…æ¡æ¬¾å¯ä»¥å‡è½»ç»æµè´Ÿæ‹…ã€‚</p>
<p><strong>ä¸»é™©å’Œé™„åŠ é™©æœ‰ä»€ä¹ˆåŒºåˆ«</strong>ï¼Ÿ</p>
<p>åœ¨ä¸ªé™©äº§å“èŒƒç•´ï¼Œä¸»é™©é€šå¸¸å•ä»¶ä¿è´¹è¾ƒé«˜ï¼Œèƒ½æ”¯æ’‘ä¸šåŠ¡å¼€å±•æˆæœ¬ï¼Œä¿è´¹ä¸­æ‰€å«çš„è´¹ç”¨å¯ä»¥æ‰“çš„æ¯”è¾ƒé«˜ï¼Œå¯ä»¥å•ç‹¬é”€å”®ã€‚é™„åŠ é™©ä¿è´¹é€šå¸¸æ¯”è¾ƒä½ï¼Œå¦‚æœå•ç‹¬é”€å”®ä¸å¤ªèƒ½æ”¯æ’‘ä¸šåŠ¡å¼€å±•æˆæœ¬ï¼Œå› æ­¤é€šå¸¸é‡‡ç”¨ä¸ä¸»é™©æ­å”®çš„å½¢å¼ã€‚</p>
<p><strong>æˆ‘å›½ä¿é™©äº§å“æ˜¯æœ‰å‘½åè§„åˆ™çš„ï¼Œå¤§è‡´ä¸ºï¼šä¿é™©å…¬å¸åç§° + å¯é€‰çš„å‰åº†åå­— + å…·ä½“ä¿é™©ç±»å‹</strong>ã€‚</p>
<p>æ¯”å¦‚å¤æ˜Ÿè”åˆä¼˜é€‰é‡å¤§ç–¾ç—…ä¿é™© B æ¬¾ï¼Œ</p>
<ul>
<li>ã€Œå¤æ˜Ÿã€æ˜¯ä¿é™©å…¬å¸çš„çš„åç§°</li>
<li>ã€Œè”åˆä¼˜é€‰ã€æ˜¯ä»£è¡¨å‰åº†åå­—</li>
<li>ã€Œé‡å¤§ç–¾ç—…ä¿é™© B æ¬¾ã€ä»£è¡¨è¿™äº§å“ä¸ºä¸ªäººå¯¿é™©ä¸­çš„ç»ˆèº«å¯¿é™©ã€‚</li>
</ul>
<p>é€šå¸¸ä¿é™©äº§å“ä¹Ÿä¼šå–ä¸€ä¸ªç¾¤ä¼—å–œé—»ä¹è§çš„åˆ«åï¼Œæ¯”å¦‚ã€Œå“†å•¦ A ä¿ã€ã€ã€Œé˜¿ç«¥æœ¨ã€ç­‰ç­‰ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://www.zhihu.com/question/22316395/answer/100909780?from=profile_answer_card" target="_blank" rel="noopener">å¦‚ä½•ç”¨ä¿é™©ä¿éšœè‡ªå·±çš„ä¸€ç”Ÿï¼Ÿ</a></li>
<li><a href="https://www.zhihu.com/question/20745287/answer/22304813" target="_blank" rel="noopener">æ€ä¹ˆè´­ä¹°ä¸€ä»½åˆé€‚çš„é‡ç–¾é™©ç»„åˆï¼Ÿ</a></li>
<li>ä¿ç›‘ä¼šå®˜æ–¹è¿è¥çš„å…¬ä¼—æ•™è‚²å¾®ä¿¡å·ï¼šã€Œä¿ç›‘å¾®è¯¾å ‚ã€</li>
<li><a href="https://www.zhihu.com/question/33180934/answer/55997947" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆäººèº«ä¿é™©ä¸€èˆ¬åˆ†ä¸ºå¯¿é™©ã€å¥åº·é™©ã€æ„å¤–é™©ï¼Ÿ</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢</p>
]]></content>
      
        <categories>
            
            <category> æŠ€æœ¯ä¹‹å¤– </category>
            
        </categories>
        
        
        <tags>
            
            <tag> æŠ€æœ¯ä¹‹å¤– </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æµ…è°ˆé‡æ„]]></title>
      <url>https://timlin-pro.github.io/blog/2018/11/14/%E6%B5%85%E8%B0%88%E9%87%8D%E6%9E%84/</url>
      <content type="html"><![CDATA[<h2 id="1-ä½•è°“é‡æ„"><a href="#1-ä½•è°“é‡æ„" class="headerlink" title="1.ä½•è°“é‡æ„"></a>1.ä½•è°“é‡æ„</h2><p>ã€Œé‡æ„ã€æœ‰ä¸¤ç§ä¸åŒå«ä¹‰ï¼š</p>
<ul>
<li>ä½œä¸ºåè¯æ—¶çš„å«ä¹‰ï¼šè½¯ä»¶å†…éƒ¨ç»“æ„çš„ä¸€ç§è°ƒæ•´ï¼Œç›®çš„æ˜¯åœ¨ä¸æ”¹å˜ã€Œè½¯ä»¶çš„å¯è§†è¡Œä¸ºã€å‰æä¸‹ï¼Œæé«˜å®ƒçš„å¯æ‹“å±•æ€§ï¼Œé™ä½ä¿®æ”¹æˆæœ¬ã€‚</li>
<li>ä½œä¸ºåŠ¨è¯æ—¶çš„å«ä¹‰ï¼šä½¿ç”¨ä¸€ç³»åˆ—é‡æ„çš„å‡†åˆ™ï¼Œåœ¨ä¸æ”¹å˜ã€Œè½¯ä»¶çš„å¯è§†è¡Œä¸ºã€å‰æä¸‹ï¼Œè°ƒæ•´å…¶ç»“æ„ã€‚</li>
</ul>
<a id="more"></a>
<p>æ³¨ï¼šã€Œè½¯ä»¶çš„å¯è§†è¡Œä¸ºã€çš„æŒ‡çš„æ˜¯ç¨‹åºè¿è¡Œæ—¶è¡¨ç°ã€‚</p>
<h3 id="å‡ ä¸ªå¸¸è§çš„é—®é¢˜ï¼š"><a href="#å‡ ä¸ªå¸¸è§çš„é—®é¢˜ï¼š" class="headerlink" title="å‡ ä¸ªå¸¸è§çš„é—®é¢˜ï¼š"></a>å‡ ä¸ªå¸¸è§çš„é—®é¢˜ï¼š</h3><h4 id="ã€Œé‡æ„ã€åªæ˜¯æ•´ç†ä»£ç å—ï¼Ÿ"><a href="#ã€Œé‡æ„ã€åªæ˜¯æ•´ç†ä»£ç å—ï¼Ÿ" class="headerlink" title="ã€Œé‡æ„ã€åªæ˜¯æ•´ç†ä»£ç å—ï¼Ÿ"></a>ã€Œé‡æ„ã€åªæ˜¯æ•´ç†ä»£ç å—ï¼Ÿ</h4><p>ä»æŸç§è§’åº¦è€Œè¨€ï¼Œæ˜¯çš„ã€‚</p>
<ul>
<li>é‡æ„ï¼ˆåŒ…å«çš„å„ç§åŸåˆ™ï¼‰æ˜¯æ•´ç†ä»£ç çš„ä¸€å¥—æ–¹æ³•è®ºã€‚æŒæ¡ä¹‹åï¼Œå¯ä»¥å§å¸®åŠ©æˆ‘ä»¬æ›´é«˜æ•ˆå¹¶ä¸”å¯æ§åœ°æ•´ç†å¥½ä»£ç ã€‚</li>
</ul>
<h4 id="ã€Œé‡æ„ã€ä¸ã€Œæ€§èƒ½ä¼˜åŒ–ã€çš„åŒºåˆ«"><a href="#ã€Œé‡æ„ã€ä¸ã€Œæ€§èƒ½ä¼˜åŒ–ã€çš„åŒºåˆ«" class="headerlink" title="ã€Œé‡æ„ã€ä¸ã€Œæ€§èƒ½ä¼˜åŒ–ã€çš„åŒºåˆ«"></a>ã€Œé‡æ„ã€ä¸ã€Œæ€§èƒ½ä¼˜åŒ–ã€çš„åŒºåˆ«</h4><p>å’Œé‡æ„ä¸€æ ·ï¼Œæ€§èƒ½ä¼˜åŒ–é€šå¸¸ä¸ä¼šæ”¹å˜ç»„ä»¶çš„è¡Œä¸ºï¼ˆé™¤äº†æ‰§è¡Œé€Ÿåº¦ï¼‰ï¼Œåªä¼šæ”¹å˜å…¶å†…éƒ¨ç»“æ„ã€‚ä½†æ˜¯<strong>ä¸¤è€…å‡ºå‘ç‚¹ä¸åŒ</strong>ï¼š</p>
<p>æ€§èƒ½ä¼˜åŒ–å¾€å¾€ä½¿ä»£ç è¾ƒéš¾ç†è§£ï¼Œä½†ä¸ºäº†å¾—åˆ°æ‰€éœ€çš„æ€§èƒ½ä½ ä¸å¾—ä¸é‚£ä¹ˆåšã€‚</p>
<p>æˆ‘è¦å¼ºè°ƒçš„ç¬¬äºŒç‚¹æ˜¯ï¼šé‡æ„ä¸ä¼šæ”¹å˜è½¯ä»¶ã€Œå¯å—è§‚å¯Ÿä¹‹è¡Œä¸ºã€â€”â€”é‡æ„ä¹‹åè½¯ä»¶åŠŸèƒ½ä¸€å¦‚ä»¥å¾€ã€‚</p>
<h4 id="ã€Œæ·»åŠ æ–°åŠŸèƒ½ã€å’Œã€Œé‡æ„ã€çš„åŒºåˆ«"><a href="#ã€Œæ·»åŠ æ–°åŠŸèƒ½ã€å’Œã€Œé‡æ„ã€çš„åŒºåˆ«" class="headerlink" title="ã€Œæ·»åŠ æ–°åŠŸèƒ½ã€å’Œã€Œé‡æ„ã€çš„åŒºåˆ«"></a>ã€Œæ·»åŠ æ–°åŠŸèƒ½ã€å’Œã€Œé‡æ„ã€çš„åŒºåˆ«</h4><ul>
<li>æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œä½ ä¸åº”è¯¥ä¿®æ”¹æ—¢æœ‰ä»£ç ï¼Œåªç®¡æ·»åŠ æ–°åŠŸèƒ½ã€‚é€šè¿‡æµ‹è¯•ï¼ˆå¹¶è®©æµ‹è¯•æ­£å¸¸è¿è¡Œã€‰ï¼Œä½ å¯ä»¥è¡¡é‡è‡ªå·±çš„å·¥ä½œè¿›åº¦ã€‚</li>
<li>é‡æ„æ—¶ä½ å°±ä¸èƒ½å†æ·»åŠ åŠŸèƒ½ï¼Œåªç®¡æ”¹è¿›ç¨‹åºç»“æ„ã€‚æ­¤æ—¶ä½ ä¸åº”è¯¥æ·»åŠ ä»»ä½•æµ‹è¯•ï¼ˆé™¤éå‘ç°å…ˆå‰é—æ¼çš„ä»»ä½•ä¸œè¥¿ï¼‰ï¼Œåªåœ¨ç»å¯¹å¿…è¦ï¼ˆç”¨ä»¥å¤„ç†æ¥å£å˜åŒ–ã€•æ—¶æ‰ä¿®æ”¹æµ‹è¯•ã€‚</li>
</ul>
<p>æ— è®ºä½•æ—¶éƒ½åº”è¯¥æ¸…æ¥šè‡ªå·±å½“å‰åœ¨åšä»€ä¹ˆï¼Œæ˜¯ã€Œæ·»åŠ æ–°åŠŸèƒ½ã€è¿˜æ˜¯åœ¨ã€Œé‡æ„ã€ã€‚</p>
<h2 id="2-ä¸ºä½•é‡æ„"><a href="#2-ä¸ºä½•é‡æ„" class="headerlink" title="2.ä¸ºä½•é‡æ„"></a>2.ä¸ºä½•é‡æ„</h2><ol>
<li>æ”¹è¿›è½¯ä»¶è®¾è®¡ã€‚æ¯”å¦‚æ¶ˆé™¤é‡å¤ä»£ç ã€‚ä»£ç æ•°é‡å‡å°‘å°†ä½¿æœªæ¥å¯èƒ½çš„ç¨‹åºä¿®æ”¹åŠ¨ä½œå®¹æ˜“å¾—å¤šã€‚ç¡®å®šä»£ç å°†æ‰€æœ‰äº‹ç‰©å’Œè¡Œä¸ºéƒ½åªè¡¨è¿°ä¸€æ¬¡ã€‚</li>
<li>æé«˜å¯è¯»æ€§ï¼Œé™ä½ç»´æŠ¤æˆæœ¬ <ul>
<li>æˆ‘ä»¬å†™ä¸‹çš„æºç æœ‰ä¸¤ä¸ªè¯»è€…â€”â€”è®¡ç®—æœº å’Œ å¦ä¸€äº›ç¨‹åºå‘˜ã€‚è®©åè€…èƒ½å¤Ÿè¯»æ‡‚ä½ çš„ä»£ç æ‰æ˜¯æœ€é‡è¦çš„ã€‚ï¼ˆä¸šåŠ¡éœ€æ±‚æ€»æ˜¯æ”¹å˜çš„ï¼Œå¯èƒ½åå¤©åå°±ä¼šæœ‰æ–°åŒäº‹éœ€è¦å°è¯•è¯»æ‡‚ä½ çš„ä»£ç ï¼Œå¹¶åšä¸€äº›ä¿®æ”¹ï¼‰</li>
<li>å½“ä½ åŠªåŠ›è®©ç¨‹åºè¿è½¬çš„æ—¶å€™ï¼Œä½ ä¸ä¼šæƒ³åˆ°æœªæ¥å‡ºç°çš„é‚£ä¸ªå¼€å‘è€…ã€‚å…¶å®å¾ˆå¤šæ—¶å€™ï¼Œé‚£ä¸ªã€Œæœªæ¥çš„å¼€å‘è€…ã€å°±æ˜¯ä½ è‡ªå·±ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé‡æ„å¯ä»¥å¸®åŠ©ä½ å®Œæˆè¿™äº›</li>
<li>åˆ©ç”¨é‡æ„æ¥ååŠ©æˆ‘ç†è§£ä¸ç†Ÿæ‚‰çš„ä»£ç </li>
</ul>
</li>
<li>å¸®åŠ©æ‰¾åˆ° bugã€‚<ul>
<li>å¯¹ä»£ç è¿›è¡Œé‡æ„ï¼Œæˆ‘å°±å¯ä»¥æ·±å…¥ç†è§£ä»£ç çš„ä½œä¸ºï¼Œå¹¶æ°åˆ°å¥½å¤„åœ°æŠŠæ–°çš„ç†è§£åé¦ˆå›å»ã€‚ææ¸…æ¥šç¨‹åºç»“æ„çš„åŒæ—¶ï¼Œæˆ‘ä¹Ÿæ¸…æ¥šäº†è‡ªå·±æ‰€åšçš„ä¸€äº›å‡è®¾</li>
</ul>
</li>
<li>å¸®åŠ©æé«˜ç¼–ç¨‹é€Ÿåº¦ã€‚å¦‚æœè®¾è®¡ä¸åˆç†ã€‚æˆ–è®¸æŸä¸€æ®µæ—¶é—´å†…ä½ çš„è¿›å±•è¿…é€Ÿï¼Œä½†<strong>æ¶åŠ£çš„è®¾è®¡å¾ˆå¿«å°±è®©ä½ çš„é€Ÿåº¦æ…¢ä¸‹æ¥</strong>ã€‚ä½ ä¼šæŠŠæ—¶é—´èŠ±åœ¨è°ƒè¯•ä¸Šé¢ï¼Œæ— æ³•æ·»åŠ æ–°åŠŸèƒ½ã€‚ä¿®æ”¹æ—¶é—´æ„ˆæ¥æ„ˆé•¿ï¼Œå› ä¸ºä½ å¿…é¡»èŠ±æ„ˆæ¥æ„ˆå¤šçš„æ—¶é—´å»ç†è§£ç³»ç»Ÿã€å¯»æ‰¾é‡å¤ä»£ç ã€‚</li>
</ol>
<h2 id="3-ä½•æ—¶é‡æ„"><a href="#3-ä½•æ—¶é‡æ„" class="headerlink" title="3.ä½•æ—¶é‡æ„"></a>3.ä½•æ—¶é‡æ„</h2><p>é‡æ„æœ¬æ¥å°±ä¸æ˜¯ä¸€ä»¶ã€Œç‰¹åˆ«æ‹¨å‡ºæ—¶é—´åšã€çš„äº‹æƒ…ï¼Œ<strong>é‡æ„åº”è¯¥éšæ—¶éšåœ°è¿›è¡Œ</strong>ã€‚ä½ ä¸åº”è¯¥ä¸ºé‡æ„è€Œé‡æ„ï¼Œä½ <strong>ä¹‹æ‰€ä»¥é‡æ„ï¼Œæ˜¯å› ä¸ºä½ æƒ³åšåˆ«çš„ä»€ä¹ˆäº‹ï¼Œè€Œé‡æ„å¯ä»¥å¸®åŠ©ä½ æŠŠé‚£äº›äº‹åšå¥½</strong>ã€‚</p>
<p>å‡ ä¸ªå…¸å‹çš„é‡æ„æ—¶æœºï¼š</p>
<ul>
<li>æ·»åŠ åŠŸèƒ½æ—¶ä¸€å¹¶é‡æ„</li>
<li>ä¿®è¡¥é”™è¯¯æ—¶ä¸€å¹¶é‡æ„</li>
<li>code review æ—¶ä¸€å¹¶é‡æ„</li>
</ul>
<h2 id="4-å°ç»“"><a href="#4-å°ç»“" class="headerlink" title="4.å°ç»“"></a>4.å°ç»“</h2><p>åå‘³é“çš„ä»£ç ç¼–å†™è€Œæˆçš„ç¨‹åºï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹å¾ï¼š</p>
<ul>
<li>éš¾ä»¥é˜…è¯»çš„ç¨‹åºï¼Œéš¾ä»¥ä¿®æ”¹ã€‚</li>
<li>é€»è¾‘é‡å¤ï¼ˆduplicated logicï¼‰çš„ç¨‹åºï¼Œéš¾ä»¥ä¿®æ”¹ã€‚</li>
<li>æ·»åŠ æ–°è¡Œä¸ºæ—¶éœ€è¦ä¿®æ”¹æ—¢æœ‰ä»£ç çš„ç¨‹åºï¼Œéš¾ä»¥ä¿®æ”¹ã€‚</li>
<li>å¸¦å¤æ‚æ¡ä»¶é€»è¾‘ï¼ˆcomplex conditional logicï¼‰çš„ç¨‹åºï¼Œéš¾ä»¥ä¿®æ”¹ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å¸Œæœ›ç¨‹åºï¼š</p>
<ol>
<li>å®¹æ˜“ç†è§£ï¼›</li>
<li>æ‰€æœ‰é€»è¾‘éƒ½åªåœ¨å”¯ä¸€ä¸€å¤„æŒ‡å®šï¼›</li>
<li>æ–°çš„æ”¹åŠ¨ä¸ä¼šå±åŠç°æœ‰è¡Œä¸ºï¼›</li>
<li>å°½å¯èƒ½ç®€å•è¡¨è¾¾æ¡ä»¶é€»è¾‘ï¼ˆconditional logicï¼‰ã€‚</li>
</ol>
<p>é‡æ„æ˜¯è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ï¼šå®ƒåœ¨ä¸€ä¸ªç›®å‰å¯è¿è¡Œçš„ç¨‹åºä¸Šè¿›è¡Œï¼Œä¼å›¾åœ¨ã€Œä¸æ”¹å˜ç¨‹åºè¡Œä¸ºã€çš„æƒ…å†µä¸‹èµ‹äºˆä¸Šè¿°ç¾å¥½æ€§è´¨ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿç»§ç»­ä¿æŒé«˜é€Ÿå¼€å‘ï¼Œä»è€Œå¢åŠ ç¨‹åºçš„ä»·å€¼ã€‚</p>
<h2 id="5-å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#5-å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="5.å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>5.å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li>ã€Šé‡æ„ï¼Œæ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ã€‹</li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        
        <tags>
            
            <tag> ä»£ç è´¨é‡ </tag>
            
            <tag> ç¼–ç è§„èŒƒ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Skeleton å·¥ä½œåŸç†]]></title>
      <url>https://timlin-pro.github.io/blog/2018/11/07/Skeleton-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1.ç®€ä»‹"></a>1.ç®€ä»‹</h2><p>Skeleton Screenï¼ˆåŠ è½½å ä½å›¾ï¼‰æ˜¯è¿‘å¹´æµè¡Œçš„åŠ è½½æ§ä»¶ï¼Œé€šå¸¸è¡¨ç°å½¢å¼æ˜¯åœ¨ç•Œé¢ä¸Šå¾…åŠ è½½åŒºåŸŸå¡«å……ç°è‰²çš„å ä½å›¾ï¼Œä¸çº¿æ¡†å›¾çš„æ•ˆæœéå¸¸ç›¸ä¼¼ã€‚Skeleton Screen æœ¬è´¨ä¸Šæ˜¯ç•Œé¢åŠ è½½è¿‡ç¨‹ä¸­çš„è¿‡æ¸¡æ•ˆæœã€‚</p>
<a id="more"></a>
<p>ä½¿ç”¨ Skeleton çš„æ•ˆæœå›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fwyt63fc6bj30fz0sgwes.jpg" alt=""></p>
<h2 id="2-å·¥ä½œåŸç†"><a href="#2-å·¥ä½œåŸç†" class="headerlink" title="2.å·¥ä½œåŸç†"></a>2.å·¥ä½œåŸç†</h2><p>ä»ä¸Šé¢çš„æ•ˆæœå›¾ï¼Œä¸éš¾çœ‹å‡ºï¼Œã€ŒSkeletonã€æœ‰ä¸€ä¸ªæ˜¾ç¤ºå’Œéšè—çš„è¿‡ç¨‹ã€‚ä¸‹é¢é’ˆå¯¹æ™®é€šçš„ view å’Œ RecyclerView åˆ†åˆ«è¯´æ˜å…¶ä¸­çš„æ˜¾ç¤º/éšè—çš„è¿‡ç¨‹ã€‚</p>
<h3 id="2-1-å¯¹äºæ™®é€šçš„-View"><a href="#2-1-å¯¹äºæ™®é€šçš„-View" class="headerlink" title="2.1 å¯¹äºæ™®é€šçš„ View"></a>2.1 å¯¹äºæ™®é€šçš„ View</h3><p>ä»å¸¸è§„çš„ä½¿ç”¨æ–¹æ³•çœ‹èµ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mTvSkeletonScreen = Skeleton.bind(textView)</div><div class="line">        .load(R.layout.share_skeleton_text_view)</div><div class="line">        .show();</div></pre></td></tr></table></figure>
<p>é¦–å…ˆè°ƒç”¨äº† <code>Skeleton.bind();</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> ViewSkeletonScreen.<span class="function">Builder <span class="title">bind</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ViewSkeletonScreen.Builder(view);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>bind æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª ViewSkeletonScreen.Builder</p>
<p>ä¹Ÿå°±æ˜¯ä¸€ä¸ªå»ºé€ å™¨ï¼Œå…¶ä¸­æä¾›äº†å„ç§é…ç½®æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> View mView;<span class="comment">//ä¾é™„çš„ view</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSkeletonLayoutResID;<span class="comment">//å¤–éƒ¨æ³¨å…¥çš„ id</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mShimmer = <span class="keyword">true</span>;<span class="comment">//æ˜¯å¦é—ªçƒ</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mShimmerColor;<span class="comment">//é—ªçƒçš„é¢œè‰²</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mShimmerDuration = <span class="number">1000</span>;<span class="comment">//é—ªçƒæ—¶é—´ï¼Œé»˜è®¤æ˜¯ 1000ms</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mShimmerAngle = <span class="number">20</span>;<span class="comment">//é—ªçƒçš„è§’åº¦</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mView = view;<span class="comment">//ä»å¤–éƒ¨æ³¨å…¥çš„ç›®æ ‡ view</span></div><div class="line">        <span class="keyword">this</span>.mShimmerColor = ContextCompat.getColor(mView.getContext(), R.color.shimmer_color);<span class="comment">//é»˜è®¤çš„ shimmer é¢œè‰²</span></div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> ViewSkeletonScreen <span class="title">show</span><span class="params">()</span> </span>&#123;</div><div class="line">        ViewSkeletonScreen skeletonScreen = <span class="keyword">new</span> ViewSkeletonScreen(<span class="keyword">this</span>);</div><div class="line">        skeletonScreen.show();</div><div class="line">        <span class="keyword">return</span> skeletonScreen;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®¾ç½®å¥½ä¹‹åï¼Œè°ƒç”¨ showï¼Œå³å¯å°† Skeleton æ˜¾ç¤º å‡ºæ¥</p>
<p>ViewSkeletonScreen.Builder#show</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ViewSkeletonScreen <span class="title">show</span><span class="params">()</span> </span>&#123;</div><div class="line">    ViewSkeletonScreen skeletonScreen = <span class="keyword">new</span> ViewSkeletonScreen(<span class="keyword">this</span>);<span class="comment">//æ ¹æ®å½“å‰ builder åˆ›å»ºä¸€ä¸ª ViewSkeletonScreen</span></div><div class="line">    skeletonScreen.show();<span class="comment">//æ˜¾ç¤º</span></div><div class="line">    <span class="keyword">return</span> skeletonScreen;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Builder#show æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª ViewSkeletonScreen å¯¹è±¡ã€‚</p>
<p>ViewSkeletonScreen å®ç°äº† SkeletonScreen æ¥å£ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SkeletonScreen</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hide</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-1-1-æ˜¾ç¤º"><a href="#2-1-1-æ˜¾ç¤º" class="headerlink" title="2.1.1 æ˜¾ç¤º"></a>2.1.1 æ˜¾ç¤º</h4><h5 id="ViewSkeletonScreen-show"><a href="#ViewSkeletonScreen-show" class="headerlink" title="ViewSkeletonScreen#show()"></a>ViewSkeletonScreen#show()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</div><div class="line">    View skeletonLoadingView = generateSkeletonLoadingView();<span class="comment">//ç”Ÿæˆ loading view</span></div><div class="line">    <span class="keyword">if</span> (skeletonLoadingView != <span class="keyword">null</span>) &#123;</div><div class="line">        mViewReplacer.replace(skeletonLoadingView);<span class="comment">//å°† bind è¿›æ¥çš„ view æ›¿æ¢ä¸º loadingview</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="1-ç”Ÿæˆ-loadingView"><a href="#1-ç”Ÿæˆ-loadingView" class="headerlink" title="1.ç”Ÿæˆ loadingView"></a>1.ç”Ÿæˆ loadingView</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">generateSkeletonLoadingView</span><span class="params">()</span> </span>&#123;</div><div class="line">    ViewParent viewParent = mActualView.getParent();<span class="comment">//è·å–å®é™… view çš„ parent</span></div><div class="line">    <span class="keyword">if</span> (viewParent == <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœæ²¡æœ‰çˆ¶ view</span></div><div class="line">        Log.e(TAG, <span class="string">"the source view have not attach to any view"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    ViewGroup parentView = (ViewGroup) viewParent;</div><div class="line">    <span class="keyword">if</span> (mShimmer) &#123;</div><div class="line">        <span class="keyword">return</span> generateShimmerContainerLayout(parentView);<span class="comment">//ç”Ÿæˆ shimmer layoutã€‚åœ¨ç°æœ‰çš„ view ä¸Šé¢åŒ…è£…ä¸€å±‚ï¼Œå½“ view å…³è”åˆ° window çš„æ—¶å€™ï¼Œå¼€å§‹æ’­æ”¾åŠ¨ç”»ï¼›å½“ view ä» window ä¸­åˆ†ç¦»çš„æ—¶å€™åœæ­¢æ’­æ”¾åŠ¨ç”»ã€‚ </span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> LayoutInflater.from(mActualView.getContext()).inflate(mSkeletonResID, parentView, <span class="keyword">false</span>);<span class="comment">//æ¸²æŸ“å‡º view</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="2-æ˜¾ç¤º"><a href="#2-æ˜¾ç¤º" class="headerlink" title="2.æ˜¾ç¤º"></a>2.æ˜¾ç¤º</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replace</span><span class="params">(View targetView)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mCurrentView == targetView) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (targetView.getParent() != <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœ loadingview çš„ parent ä¸ä¸º nullï¼Œå°†å®ƒä»çˆ¶å®¹å™¨ä¸­ç§»é™¤</span></div><div class="line">        ((ViewGroup) targetView.getParent()).removeView(targetView);<span class="comment">//ç§»é™¤ view</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (init()) &#123;<span class="comment">//åˆå§‹åŒ–</span></div><div class="line">        mTargetView = targetView;</div><div class="line">        mSourceParentView.removeView(mCurrentView);<span class="comment">//ç§»é™¤æ‰æº view</span></div><div class="line">        mTargetView.setId(mSourceViewId);<span class="comment">//è®¾ç½® idï¼Œ</span></div><div class="line">        mSourceParentView.addView(mTargetView, mSourceViewIndexInParent, mSourceViewLayoutParams);<span class="comment">//æ·»åŠ åˆ°çˆ¶ view ä¸­</span></div><div class="line">        mCurrentView = mTargetView;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ¤æ–­æ¡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mSourceParentView == <span class="keyword">null</span>) &#123;<span class="comment">//</span></div><div class="line">        mSourceParentView = (ViewGroup) mSourceView.getParent();<span class="comment">//è·å– bind è¿›æ¥çš„ view çš„çˆ¶å®¹å™¨</span></div><div class="line">        <span class="keyword">if</span> (mSourceParentView == <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœçˆ¶å®¹å™¨ä¸ºç©ºï¼Œè¯´æ˜æœªå…³è”åˆ°ä»»ä½• viewï¼Œç›´æ¥è¿”å›</span></div><div class="line">            Log.e(TAG, <span class="string">"the source view have not attach to any view"</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//éå†è·å–å½“å‰ view åœ¨çˆ¶å®¹å™¨ä¸­ä¸‹æ ‡</span></div><div class="line">        <span class="keyword">int</span> count = mSourceParentView.getChildCount();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; count; index++) &#123;</div><div class="line">            <span class="keyword">if</span> (mSourceView == mSourceParentView.getChildAt(index)) &#123;</div><div class="line">                mSourceViewIndexInParent = index;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-1-2-éšè—"><a href="#2-1-2-éšè—" class="headerlink" title="2.1.2 éšè—"></a>2.1.2 éšè—</h4><p>com.ethanhua.skeleton.ViewSkeletonScreen#hide</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hide</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mViewReplacer.getTargetView() <span class="keyword">instanceof</span> ShimmerLayout) &#123;</div><div class="line">        ((ShimmerLayout) mViewReplacer.getTargetView()).stopShimmerAnimation();</div><div class="line">    &#125;</div><div class="line">    mViewReplacer.restore();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>com.ethanhua.skeleton.ViewReplacer#restore </p>
<p>å…¶å®å°±æ˜¯ replace æ–¹æ³•çš„é€†å‘ã€‚å°† ã€Œloading view ã€ä»çˆ¶ view ä¸­ç§»é™¤æ‰ï¼Œå°†ã€ŒåŸ viewã€ï¼ˆbind è¿›æ¥çš„ viewï¼‰ï¼Œæ·»åŠ åˆ°çˆ¶ viewã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restore</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mSourceParentView != <span class="keyword">null</span>) &#123;</div><div class="line">        mSourceParentView.removeView(mCurrentView);<span class="comment">//ç§»é™¤æ‰å½“å‰çš„ viewã€‚</span></div><div class="line">        mSourceParentView.addView(mSourceView, mSourceViewIndexInParent, mSourceViewLayoutParams);</div><div class="line">        mCurrentView = mSourceView;</div><div class="line">        mTargetView = <span class="keyword">null</span>;</div><div class="line">        mTargetViewResID = -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2-å¯¹äº-RecyclerView"><a href="#2-2-å¯¹äº-RecyclerView" class="headerlink" title="2.2 å¯¹äº RecyclerView"></a>2.2 å¯¹äº RecyclerView</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> RecyclerViewSkeletonScreen.<span class="function">Builder <span class="title">bind</span><span class="params">(RecyclerView recyclerView)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RecyclerViewSkeletonScreen.Builder(recyclerView);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> RecyclerView.Adapter mActualAdapter;<span class="comment">//é€‚é…å™¨</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RecyclerView mRecyclerView;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mShimmer = <span class="keyword">true</span>;<span class="comment">//é»˜è®¤æ”¯æŒ shimmer </span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mItemCount = <span class="number">10</span>;<span class="comment">//é»˜è®¤ä¸º 10</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mItemResID = R.layout.layout_default_item_skeleton;<span class="comment">//é»˜è®¤çš„åˆ—è¡¨é¡¹å¸ƒå±€</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mShimmerColor;<span class="comment">//é¢œè‰²</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mShimmerDuration = <span class="number">1000</span>;<span class="comment">//</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mShimmerAngle = <span class="number">20</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mFrozen = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(RecyclerView recyclerView)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mRecyclerView = recyclerView;</div><div class="line">        <span class="keyword">this</span>.mShimmerColor = ContextCompat.getColor(recyclerView.getContext(), R.color.shimmer_color);<span class="comment">//é»˜è®¤çš„é—ªçƒé¢œè‰²</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> adapter the target recyclerView actual adapter</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">adapter</span><span class="params">(RecyclerView.Adapter adapter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mActualAdapter = adapter;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> itemCount the child item count in recyclerView</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">count</span><span class="params">(<span class="keyword">int</span> itemCount)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mItemCount = itemCount;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> frozen whether frozen recyclerView during skeleton showing</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">frozen</span><span class="params">(<span class="keyword">boolean</span> frozen)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mFrozen = frozen;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> RecyclerViewSkeletonScreen <span class="title">show</span><span class="params">()</span> </span>&#123;</div><div class="line">        RecyclerViewSkeletonScreen recyclerViewSkeleton = <span class="keyword">new</span> RecyclerViewSkeletonScreen(<span class="keyword">this</span>);</div><div class="line">        recyclerViewSkeleton.show();</div><div class="line">        <span class="keyword">return</span> recyclerViewSkeleton;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸æ™®é€š view ä¸åŒï¼Œ recyclerview çš„ Skeleton Builder æä¾›äº†å¤šä¸ª  adapter æ–¹æ³•æ¥è®¾ç½®é€‚é…å™¨ï¼Œcount æ–¹æ³•ç”¨äºè®¾ç½® åˆ—è¡¨é¡¹æ•°ç›®ï¼Œfrozen æ§åˆ¶ Skeleton æ˜¾ç¤ºæœŸé—´æ˜¯å¦å†»ç»“ RecyclerViewã€‚</p>
<p>ä¸Šé¢çš„ RecyclerViewSkeletonScreen.Builder#show æ–¹æ³•ï¼Œé¦–å…ˆåˆ›å»ºäº† ä¸€ä¸ª RecyclerViewSkeletonScreen ï¼Œç„¶åè°ƒç”¨å®ƒçš„ show æ–¹æ³•</p>
<p>RecyclerViewSkeletonScreen#RecyclerViewSkeletonScreen </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">RecyclerViewSkeletonScreen</span><span class="params">(Builder builder)</span> </span>&#123;</div><div class="line">    mRecyclerView = builder.mRecyclerView;</div><div class="line">    mActualAdapter = builder.mActualAdapter;<span class="comment">//çœŸæ­£çš„é€‚é…å™¨ï¼Œéšè— Skeleton ä¹‹åï¼Œæ˜¾ç¤ºçœŸå®çš„ view æ—¶éœ€è¦ç”¨åˆ°</span></div><div class="line">    mSkeletonAdapter = <span class="keyword">new</span> SkeletonAdapter();<span class="comment">//åˆ›å»º adapter</span></div><div class="line">    mSkeletonAdapter.setItemCount(builder.mItemCount);<span class="comment">//åˆ—è¡¨çš„æ€»é¡¹æ•°</span></div><div class="line">    mSkeletonAdapter.setLayoutReference(builder.mItemResID);<span class="comment">//åˆ—è¡¨é¡¹çš„ id</span></div><div class="line">    mSkeletonAdapter.shimmer(builder.mShimmer);<span class="comment">//æ˜¯å¦é—ªçƒ</span></div><div class="line">    mSkeletonAdapter.setShimmerColor(builder.mShimmerColor);<span class="comment">//é—ªçƒçš„é¢œè‰²</span></div><div class="line">    mSkeletonAdapter.setShimmerAngle(builder.mShimmerAngle);<span class="comment">//é—ªçƒçš„è§’åº¦</span></div><div class="line">    mSkeletonAdapter.setShimmerDuration(builder.mShimmerDuration);<span class="comment">//é—ªçƒæ—¶é•¿</span></div><div class="line">    mRecyclerViewFrozen = builder.mFrozen;<span class="comment">//æ˜¯å¦å†»ç»“</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-1-æ˜¾ç¤º"><a href="#2-2-1-æ˜¾ç¤º" class="headerlink" title="2.2.1 æ˜¾ç¤º"></a>2.2.1 æ˜¾ç¤º</h4><p>RecyclerViewSkeletonScreen#show</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</div><div class="line">    mRecyclerView.setAdapter(mSkeletonAdapter);</div><div class="line">    <span class="keyword">if</span> (!mRecyclerView.isComputingLayout() &amp;&amp; mRecyclerViewFrozen) &#123;<span class="comment">//å¦‚æœä¸æ˜¯æ­£åœ¨è®¡ç®—å¸ƒå±€ï¼Œå¹¶ä¸”è®¾ç½®äº†å†»ç»“ï¼Œåˆ™å°† Recyclerview å†»ç»“</span></div><div class="line">        mRecyclerView.setLayoutFrozen(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-2-éšè—"><a href="#2-2-2-éšè—" class="headerlink" title="2.2.2 éšè—"></a>2.2.2 éšè—</h4><p>RecyclerViewSkeletonScreen#hide</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hide</span><span class="params">()</span> </span>&#123;</div><div class="line">    mRecyclerView.setAdapter(mActualAdapter);<span class="comment">//å°†çœŸå®çš„ adapter è®¾ç½®å›å»ã€‚å†…éƒ¨ä¼šè§¦å‘åˆ·æ–°ï¼Œè¿›è€Œæ˜¾ç¤ºå‡º</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SkeletonAdapter çš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SkeletonAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">RecyclerView</span>.<span class="title">ViewHolder</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> RecyclerView.<span class="function">ViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">        LayoutInflater inflater = LayoutInflater.from(parent.getContext());</div><div class="line">        <span class="keyword">if</span> (mShimmer) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ShimmerViewHolder(inflater, parent, mLayoutReference);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RecyclerView.ViewHolder(inflater.inflate(mLayoutReference, parent, <span class="keyword">false</span>)) &#123;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(RecyclerView.ViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mShimmer) &#123;</div><div class="line">            ShimmerLayout layout = (ShimmerLayout) holder.itemView;</div><div class="line">            layout.setShimmerAnimationDuration(mShimmerDuration);</div><div class="line">            layout.setShimmerAngle(mShimmerAngle);</div><div class="line">            layout.setShimmerColor(mColor);</div><div class="line">            layout.startShimmerAnimation();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//ä»£ç çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿˜æ˜¯è·Ÿæ™®é€šçš„ view ä¸€ä¸ªå¥—è·¯ï¼Œä¸é—ªçƒçš„è¯ï¼Œç›´æ¥å°†åˆ—è¡¨é¡¹æ¸²æŸ“å‡ºæ¥å°±å®Œäº‹ã€‚å¦‚æœè®¾ç½®äº†é—ªçƒï¼Œåˆ™éœ€è¦åŒ…è£…åˆ°ä¸€ä¸ª ShimmerLayout ä¸­ï¼Œå¹¶æ ¹æ®å‚æ•°è¿›ä¸€æ­¥è®¾ç½®ã€‚</p>
<h2 id="3-æ€»ç»“"><a href="#3-æ€»ç»“" class="headerlink" title="3.æ€»ç»“"></a>3.æ€»ç»“</h2><p>æ™®é€š viewï¼Œ æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼Œåˆ©ç”¨ ViewGroup#addViewï¼ŒViewGroup#removeView å¯¹ view è¿›è¡Œæ›¿æ¢ã€‚</p>
<p>æ˜¾ç¤º Skeleton çš„æ—¶å€™ï¼Œå°†åŸæ¥çš„ view æ›¿æ¢ä¸º loadingView</p>
<p>éšè— Skeleton çš„æ—¶å€™ï¼Œå°†ã€Œloadingviewã€æ›¿æ¢ä¸º sourceViewã€‚</p>
<p>å¯¹äº RecyclerViewï¼Œåœ¨æ˜¾ç¤ºæœŸé—´ï¼Œé€šè¿‡ SkeletonAdapter å·å¤©æ¢æ—¥ï¼Œå°† loading æ˜¾ç¤ºå‡ºæ¥ã€‚</p>
<p>éšè—çš„æ—¶å€™ï¼Œå°†çœŸæ­£çš„ adapter è®¾ç½®å›å»ã€‚</p>
<h2 id="4-å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#4-å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="4.å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>4.å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/26014116" target="_blank" rel="noopener">è¿™ä¸ªæ§ä»¶å«ï¼šSkeleton Screen/åŠ è½½å ä½å›¾</a></li>
<li><a href="https://github.com/ethanhua/Skeleton" target="_blank" rel="noopener">Skeleton</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> æ¡†æ¶åŸç† </category>
            
        </categories>
        
        
    </entry>
    
    <entry>
      <title><![CDATA[RxJava è®¢é˜…åŸç†]]></title>
      <url>https://timlin-pro.github.io/blog/2018/06/24/RxJava-%E8%AE%A2%E9%98%85%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>RxJava æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ ¹æ®<code>RxJava</code>åœ¨<code>GitHub</code>ä¸Šç»™å‡ºçš„æè¿° RxJava â€“ Reactive Extensions for the JVM â€“ a library for composing asynchronous and event-based programs using observable sequences for the Java å¤§è‡´æ„æ€æ˜¯ï¼šä¸€ä¸ªå¯ä»¥åœ¨ JVMä¸Š ä½¿ç”¨çš„ï¼Œæ˜¯ç”±å¼‚æ­¥çš„åŸºäºäº‹ä»¶ç¼–å†™çš„é€šè¿‡ä½¿ç”¨å¯è§‚å¯Ÿåºåˆ—æ„æˆçš„ä¸€ä¸ªåº“ã€‚ </p>
<p>å…³é”®è¯ï¼š<code>å¼‚æ­¥</code>ï¼Œ<code>åŸºäºäº‹ä»¶</code>ï¼Œ<code>å¯è§‚å¯Ÿåºåˆ—</code></p>
<p>æœ¬æ–‡ä¸»è¦è®²è¿° RxJava çš„è®¢é˜…åŸç†ã€‚</p>
<a id="more"></a>
<h2 id="ç¤ºä¾‹ï¼šHelloRxJava"><a href="#ç¤ºä¾‹ï¼šHelloRxJava" class="headerlink" title="ç¤ºä¾‹ï¼šHelloRxJava"></a>ç¤ºä¾‹ï¼šHelloRxJava</h2><p>ä¸€èˆ¬å­¦ä¸€é—¨æ–°çš„ç¼–ç¨‹è¯­è¨€éƒ½æ˜¯å…ˆä»æ‰“å°çš„ã€Œhello wordã€å¼€å§‹ï¼Œæˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ç”¨ Rxjava æ‰“å°å‡ºã€ŒHello RxJavaã€ å¹¶ä»¥ä¹‹ä½œä¸ºåˆ†æçš„å®ä¾‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//åˆ›å»º Observable</span></div><div class="line">Observable&lt;String&gt; observable = Observable.create(<span class="keyword">new</span> ObservableOnSubscribe&lt;String&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;String&gt; emitter)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        emitter.onNext(<span class="string">"Hello RxJava"</span>);</div><div class="line">        emitter.onComplete();</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"><span class="comment">//è®¢é˜…</span></div><div class="line">observable.subscribe(<span class="keyword">new</span> Observer&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"onSubsribe call"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">		System.out.println(s);<span class="comment">//æ‰“å°æ”¶åˆ°çš„æ–‡å­—ï¼Œè¿™é‡Œæ˜¯ Hello RxJava</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">		e.printStackTrace();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"onComplete call"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="Observerable-æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ"><a href="#Observerable-æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ" class="headerlink" title="Observerable æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ"></a>Observerable æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ</h2><p>é¦–å…ˆ new äº†ä¸€ä¸ª ObservableOnSubscribe å¯¹è±¡ï¼Œå¹¶å®ç°å…¶ä¸­çš„ subscribe æ–¹æ³•ã€‚è¯¥å¯¹è±¡è¢«ä¼ é€’ç»™äº† Observable#create æ–¹æ³•ä»¥åˆ›å»º Observableï¼ˆå½“ç„¶ä¹Ÿæœ‰å…¶ä»–æ–¹æ³•å¯ä»¥åˆ›å»º Observable ï¼Œä½†æ˜¯åŸç†å¤§åŒå°å¼‚ï¼‰ã€‚</p>
<p><code>io.reactivex.Observable#create</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@CheckReturnValue</span></div><div class="line"><span class="meta">@SchedulerSupport</span>(SchedulerSupport.NONE)</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">create</span><span class="params">(ObservableOnSubscribe&lt;T&gt; source)</span> </span>&#123;</div><div class="line">    ObjectHelper.requireNonNull(source, <span class="string">"source is null"</span>);<span class="comment">//ä¸å¯ä¸ºç©º</span></div><div class="line">    <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableCreate&lt;T&gt;(source));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>create æ–¹æ³•ä¼ é€’è¿›æ¥çš„ Observable åˆä¼ é€’ç»™äº† Observable æ„é€ æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> ObservableOnSubscribe&lt;T&gt; source;<span class="comment">//ä¿å­˜æˆå‘˜å˜é‡</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ObservableCreate</span><span class="params">(ObservableOnSubscribe&lt;T&gt; source)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.source = source;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>io.reactivex.plugins.RxJavaPlugins#onAssembly(io.reactivex.Observable<t>)</t></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Calls the associated hook function.</div><div class="line"> * <span class="doctag">@param</span> &lt;T&gt; the value type</div><div class="line"> * <span class="doctag">@param</span> source the hook's input value</div><div class="line"> * <span class="doctag">@return</span> the value returned by the hook</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(&#123; <span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span> &#125;)</div><div class="line"><span class="meta">@NonNull</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">onAssembly</span><span class="params">(@NonNull Observable&lt;T&gt; source)</span> </span>&#123;</div><div class="line">    Function&lt;? <span class="keyword">super</span> Observable, ? extends Observable&gt; f = onObservableAssembly;</div><div class="line">    <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> apply(f, source);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> source;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>io.reactivex.plugins.RxJavaPlugins#onAssembly æ–¹æ³•ä¸­åªæ˜¯è°ƒç”¨äº†ç›¸å…³çš„ hook å‡½æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œç„¶åè¿”å›åŸå¯¹è±¡ã€‚</p>
<p>åˆ›å»ºçš„ç»“æœï¼šObservableOnSubsribe å¤–é¢åŒ…è£…äº†ä¸€å±‚ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/TimLin1024/Graph/master/markdown/Observable%20%E5%8C%85%E8%A3%85.jpg" alt="Observable åŒ…è£…"></p>
<h2 id="è®¢é˜…è¿‡ç¨‹"><a href="#è®¢é˜…è¿‡ç¨‹" class="headerlink" title="è®¢é˜…è¿‡ç¨‹"></a>è®¢é˜…è¿‡ç¨‹</h2><p>å®ä¾‹ä»£ç ä¸­åœ¨è®¢é˜…ä¹‹å‰æˆ‘ä»¬å…ˆåˆ›å»ºäº†ä¸€ä¸ª <code>observer</code> å¯¹è±¡ã€‚</p>
<p>ç„¶åè°ƒç”¨ <code>Observable#subscribe</code> æ–¹æ³•ï¼Œå°† <code>observer</code> ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¯¥æ–¹æ³•ã€‚</p>
<p>ç‚¹å¼€çœ‹çœ‹ <code>Observable#subscribe</code> æ–¹æ³•çš„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</div><div class="line">    ObjectHelper.requireNonNull(observer, <span class="string">"observer is null"</span>);<span class="comment">//éç©ºæ£€æŸ¥</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        observer = RxJavaPlugins.onSubscribe(<span class="keyword">this</span>, observer);</div><div class="line"></div><div class="line">        ObjectHelper.requireNonNull(observer, <span class="string">"Plugin returned null Observer"</span>);<span class="comment">//éç©ºæ£€æŸ¥</span></div><div class="line"></div><div class="line">        subscribeActual(observer);<span class="comment">//è°ƒç”¨çœŸæ­£çš„è®¢é˜…æ–¹æ³•ã€‚</span></div><div class="line">    &#125; <span class="keyword">catch</span> (NullPointerException e) &#123; <span class="comment">// NOPMD</span></div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">        Exceptions.throwIfFatal(e);</div><div class="line">        <span class="comment">// can't call onError because no way to know if a Disposable has been set or not</span></div><div class="line">        <span class="comment">// can't call onSubscribe because the call might have set a Subscription already</span></div><div class="line">        RxJavaPlugins.onError(e);<span class="comment">//</span></div><div class="line"></div><div class="line">        NullPointerException npe = <span class="keyword">new</span> NullPointerException(<span class="string">"Actually not, but can't throw other exceptions due to RS"</span>);</div><div class="line">        npe.initCause(e);</div><div class="line">        <span class="keyword">throw</span> npe;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢ try å—ä¸­çš„ç¬¬ä¸€è¡Œä»£ç è°ƒç”¨äº† <code>RxJavaPlugins#onSubscribe</code> ã€‚ç‚¹å¼€çœ‹çœ‹å®ƒå…·ä½“åšäº†å•¥ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(&#123; <span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span> &#125;)</div><div class="line"><span class="meta">@NonNull</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Observer&lt;? <span class="keyword">super</span> T&gt; onSubscribe(<span class="meta">@NonNull</span> Observable&lt;T&gt; source, <span class="meta">@NonNull</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</div><div class="line">    BiFunction&lt;? <span class="keyword">super</span> Observable, ? <span class="keyword">super</span> Observer, ? extends Observer&gt; f = onObservableSubscribe;</div><div class="line">    <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> apply(f, source, observer);<span class="comment">//è°ƒç”¨ç›¸åº”çš„ hook å‡½æ•°(å¦‚æœæœ‰çš„è¯)</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> observer;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è®¢é˜…çš„å®é™…å¯¹è±¡æ˜¯ <code>ObserverableCreate</code>ï¼Œå› æ­¤ç‚¹è¿›å»çœ‹çœ‹å…¶ä¸­çš„ <code>subscribeActual</code> æ–¹æ³•å®ç°ï¼š</p>
<p><code>ObservableCreate#subscribeActual</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</div><div class="line">    CreateEmitter&lt;T&gt; parent = <span class="keyword">new</span> CreateEmitter&lt;T&gt;(observer);<span class="comment">//ä»¥ observer ä½œä¸ºå‚æ•°æ„é€ ä¸€ä¸ª CreateEmitter</span></div><div class="line">    observer.onSubscribe(parent);<span class="comment">//å›è°ƒ Observer#onSubsribe æ–¹æ³•</span></div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        source.subscribe(parent);<span class="comment">//è°ƒç”¨æºè®¢é˜…æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°çš„åœ¨å…¶ä¸­å‘é€æ•°æ®çš„æ–¹æ³•</span></div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">        Exceptions.throwIfFatal(ex);</div><div class="line">        parent.onError(ex);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>source#subcribe</code> ä¹Ÿå°±æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(ObservableEmitter&lt;String&gt; emitter)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    emitter.onNext(<span class="string">"hello rxJava"</span>);<span class="comment">//è°ƒç”¨ å‘é€æ•°æ®</span></div><div class="line">    emitter.onComplete();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®¢é˜…æ˜¯ä»ä¸‹æ¸¸ä¼ é€’åˆ°ä¸Šæ¸¸ã€‚ä¼ é€’åˆ°æºå¤´ä¹‹åï¼Œä¼šè§¦å‘è°ƒç”¨ <code>Emitter#onXxx</code> æ–¹æ³•ï¼Œå°†æ•°æ®ä»ä¸Šæ¸¸å‘é€åˆ°ä¸‹æ¸¸ã€‚</p>
<h3 id="emitter-æ˜¯å¦‚ä½•å°†æ•°æ®å‘å°„ç»™-observer-çš„å‘¢ï¼Ÿ"><a href="#emitter-æ˜¯å¦‚ä½•å°†æ•°æ®å‘å°„ç»™-observer-çš„å‘¢ï¼Ÿ" class="headerlink" title="emitter æ˜¯å¦‚ä½•å°†æ•°æ®å‘å°„ç»™ observer çš„å‘¢ï¼Ÿ"></a>emitter æ˜¯å¦‚ä½•å°†æ•°æ®å‘å°„ç»™ observer çš„å‘¢ï¼Ÿ</h3><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ <strong>emitter æ˜¯ä»€ä¹ˆ</strong>ï¼Ÿ</p>
<p>ä¸Šé¢çš„ emitter çš„å®é™…ç±»å‹æ˜¯ CreateEmitter</p>
<p>å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateEmitter</span>&lt;<span class="title">T</span>&gt;</span></div><div class="line"><span class="keyword">extends</span> <span class="title">AtomicReference</span>&lt;<span class="title">Disposable</span>&gt;</div><div class="line"><span class="keyword">implements</span> <span class="title">ObservableEmitter</span>&lt;<span class="title">T</span>&gt;, <span class="title">Disposable</span> &#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3434801548987643227L</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer;</div><div class="line"></div><div class="line">    CreateEmitter(Observer&lt;? <span class="keyword">super</span> T&gt; observer) &#123;</div><div class="line">        <span class="keyword">this</span>.observer = observer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;<span class="comment">//åˆ¤ç©º</span></div><div class="line">            onError(<span class="keyword">new</span> NullPointerException(<span class="string">"onNext called with null. Null values are generally not allowed in 2.x operators and sources."</span>));</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!isDisposed()) &#123;<span class="comment">//å¦‚æœå½“å‰çŠ¶æ€ä¸æ˜¯ dispose</span></div><div class="line">            observer.onNext(t);<span class="comment">//è°ƒç”¨ observer#onNext</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!tryOnError(t)) &#123;</div><div class="line">            RxJavaPlugins.onError(t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryOnError</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</div><div class="line">            t = <span class="keyword">new</span> NullPointerException(<span class="string">"onError called with null. Null values are generally not allowed in 2.x operators and sources."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!isDisposed()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                observer.onError(t);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                dispose();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isDisposed()) &#123;<span class="comment">//ä¸æ˜¯å‡ºäº disposed çŠ¶æ€</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                observer.onComplete();<span class="comment">//è°ƒç”¨</span></div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                dispose();<span class="comment">//onComplete åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œè°ƒç”¨å®Œæˆä¹‹åï¼ŒçŠ¶æ€å˜ä¸º dispose</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CreateEmitter</code> æ˜¯ <code>ObservableCreate</code>çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œç»§æ‰¿è‡ª<code>AtomicReference&lt;Disposable&gt;</code>, å®ç°äº†ä¸¤ä¸ªæ¥å£ <code>ObservableEmitter&lt;T&gt;</code> å’Œ <code>Disposable</code> ã€‚ </p>
<p>å¯ä»¥çœ‹åˆ° <code>CreateEmitter</code> å¯¹ <code>observer</code> è¿›è¡Œäº†åŒ…è£…ï¼ˆobserver ä¾èµ–é€šè¿‡æ„é€ å‡½æ•°å‚æ•°æ³¨å…¥ï¼‰ã€‚å®ƒåœ¨è°ƒç”¨ observer çš„ç›¸åº”æ–¹æ³•çš„å‰åå¯¹çŠ¶æ€è¿›è¡Œåˆ¤æ–­å’Œæ›´æ–°ã€‚</p>
<h3 id="CreateEmitter-åˆæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„å‘¢ï¼Ÿ"><a href="#CreateEmitter-åˆæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„å‘¢ï¼Ÿ" class="headerlink" title="CreateEmitter åˆæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„å‘¢ï¼Ÿ"></a><code>CreateEmitter</code> åˆæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„å‘¢ï¼Ÿ</h3><p>åœ¨è®¢é˜…è¿‡ç¨‹ä¸­è°ƒç”¨åˆ° <code>ObservableCreate#subscribeActual</code> ï¼Œè¯¥æ–¹æ³•ä¼šåˆ©ç”¨ observer æ„é€ ä¸€ä¸ª <code>CreateEmmiter</code>ï¼Œ ç„¶åæŠŠå®ƒä½œä¸ºå‚æ•°å»è°ƒç”¨ <code>source#subcribe</code> æ–¹æ³•ã€‚</p>
<p><code>source</code> ä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ <code>ObservableOnSubscribe</code> åŒ¿åå†…éƒ¨ç±»ã€‚<code>CreateEmmiter</code> å°±æ˜¯é€šè¿‡è¿™æ ·çš„æ–¹å¼ä½œä¸ºå‚æ•°ä¼ é€’ç»™äº†æˆ‘ä»¬è‡ªå·±å®ç°çš„ <code>subscribe</code> æ–¹æ³•ã€‚</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>è®¢é˜…æ˜¯ä»ä¸‹æ¸¸ä¼ é€’åˆ°ä¸Šæ¸¸ã€‚ä¼ é€’åˆ°æºå¤´ä¹‹åï¼Œä¼šè§¦å‘è°ƒç”¨ <code>Emitter#onXxx</code> æ–¹æ³•ï¼Œå°†æ•°æ®ä»ä¸Šæ¸¸å‘é€åˆ°ä¸‹æ¸¸ã€‚</p>
<p>ä¸Šæ¸¸å¯¹æ•°æ®æµçš„æ§åˆ¶æ˜¯é€šè¿‡ <code>CreateEmitter</code> å®ç°çš„ã€‚</p>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> æ¡†æ¶ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> æ¡†æ¶ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[gradle ä¸­ api provided compile implementation ä¹‹é—´çš„åŒºåˆ«]]></title>
      <url>https://timlin-pro.github.io/blog/2018/06/24/gradle-%E4%B8%ADapi-provided-compile-implementation-%E4%B9%8B%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
      <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p><code>apiã€providedã€compileã€implementation</code> éƒ½æ˜¯ gradle æ·»åŠ ä¾èµ–æ—¶çš„é€‰é¡¹ï¼Œä¸åŒçš„é€‰é¡¹è¡¨ç¤ºä¸åŒçš„ä¾èµ–å…³ç³»ã€‚</p>
<p>å…¶ä¸­ apiã€implementation æ˜¯ Gradle 3.4 å¼•å…¥çš„æ–°çš„ä¾èµ–é…ç½®ï¼Œç”¨æ¥ä»£æ›¿ <code>compile</code> ä¾èµ–é…ç½®ã€‚å…¶ä¸­ <code>api</code> å’Œä»¥å‰çš„ <code>compile</code> ä¾èµ–é…ç½®æ˜¯ä¸€æ ·çš„ã€‚ä½¿ç”¨ api/compile çš„ä¾èµ–æ–¹å¼ï¼Œä¼šå‘å¤–ç•Œæš´éœ²æœ¬æ¨¡å—æ‰€ä¾èµ–çš„åº“çš„æ¥å£ï¼Œä½¿ç”¨ implementation åˆ™ä¸ä¼šã€‚</p>
<a id="more"></a>
<h2 id="è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ"><a href="#è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ" class="headerlink" title="è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ"></a>è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h2><p>ä¸ºä»€ä¹ˆè¦åšè¿™æ ·çš„ä¿®æ”¹å‘¢ï¼Ÿä½¿ç”¨ <code>implementation</code> ä¾èµ–é…ç½®ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘æ„å»ºçš„æ—¶é—´ã€‚</p>
<p>è€ƒè™‘è¿™æ ·çš„åœºæ™¯ï¼Œæœ‰å¦‚ä¸‹å…­ä¸ªæ¨¡å—ï¼š</p>
<p><img src="https://raw.githubusercontent.com/TimLin-pro/Graph/master/markdown/gradle%20%E6%A8%A1%E5%9D%97%E4%BE%9D%E8%B5%96%E7%A4%BA%E4%BE%8B.jpg" alt=""></p>
<p>Dã€Eã€F ä¸‰ä¸ªæ¨¡å—éƒ½ä¾èµ–äº† Lib åº“ã€‚</p>
<p>å‡è®¾ Dã€Eã€F ä¸‰ä¸ªæ¨¡å—éƒ½ä»¥ <code>implementation</code> çš„æ–¹å¼å¼•ç”¨ Lib åº“ï¼Œé‚£ä¹ˆä¸Šå±‚çš„ Aï¼ŒBï¼ŒC ä¸‰ä¸ªæ¨¡å—<strong>åœ¨ç¼–è¯‘æœŸ</strong>éƒ½æ— æ³•å¼•ç”¨åˆ° Lib åº“ä¸­çš„å†…å®¹ã€‚å› æ­¤å½“ Lib å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œåªæœ‰ D E F è¿™ä¸‰ä¸ªæ¨¡å—éœ€è¦é‡æ–°ç¼–è¯‘ï¼ŒA,B,C åˆ™ä¸éœ€è¦ï¼ˆå› ä¸º DEF ä¸‰ä¸ªæ¨¡å—å¯¹å¤–çš„æ¥å£éƒ½æ²¡æœ‰æ”¹å˜ï¼‰ã€‚</p>
<p>å‡è®¾ Dã€Eã€F ä¸‰ä¸ªæ¨¡å—éƒ½ä»¥ <code>compile/api</code>  çš„æ–¹å¼å¼•ç”¨ Lib åº“ï¼ˆå¯¹å¤–æš´éœ²äº†è‡ªå·±å¼•ç”¨çš„åº“çš„æ¥å£ï¼‰ï¼Œé‚£ä¹ˆæ— è®ºä¸Šå±‚çš„ Aï¼ŒBï¼ŒC ä¸‰ä¸ªæ¨¡å—å¯¹ Dã€Eã€F æ¨¡å—çš„ä¾èµ–æ˜¯ compileã€api æ–¹å¼è¿˜æ˜¯ implementation æ–¹å¼ï¼Œå®ƒä»¬ï¼ˆAã€Bã€Cï¼‰éƒ½å¯ä»¥å¼•ç”¨åˆ° Lib åº“ä¸­çš„å†…å®¹ã€‚è¿™ç§æƒ…å†µä¸‹å½“ Lib å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼ŒA B C D E F è¿™ä¸‰ä¸ªæ¨¡å—éƒ½éœ€è¦é‡æ–°ç¼–è¯‘ã€‚</p>
<p>Public å¯ä»¥</p>
<h2 id="å…¶å®ƒå˜åŒ–"><a href="#å…¶å®ƒå˜åŒ–" class="headerlink" title="å…¶å®ƒå˜åŒ–"></a>å…¶å®ƒå˜åŒ–</h2><p>åœ¨è¯¥ç‰ˆæœ¬ä¸­ï¼Œå®˜æ–¹å›¢é˜Ÿä¹ŸæŠŠä¹‹å‰å‘½åçš„ä¸è§„èŒƒçš„åœ°æ–¹ä¿®æ”¹äº†ï¼Œprovided æ”¹æˆäº† compileOnlyï¼Œapk æ”¹ä¸ºäº† runtimeOnlyã€‚æ”¹å˜çš„åªæ˜¯åç§°ï¼ŒåŠŸèƒ½æ²¡å˜ã€‚</p>
<h3 id="compileOnly-çš„ä½¿ç”¨åœºæ™¯"><a href="#compileOnly-çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="compileOnly çš„ä½¿ç”¨åœºæ™¯"></a>compileOnly çš„ä½¿ç”¨åœºæ™¯</h3><p>åŒ…æ‹¬ä½†æ˜¯ä¸é™äºä¸‹é¢çš„ä¸¤ç§ï¼š</p>
<ol>
<li>ç¼–è¯‘æ—¶æ‰€éœ€çš„ä¾èµ–æ€§ï¼Œä½†åœ¨è¿è¡Œæ—¶ä»ä¸éœ€è¦ï¼Œä¾‹å¦‚çº¯æºæ³¨é‡Šæˆ–æ³¨é‡Šå¤„ç†å™¨;</li>
<li>API åœ¨ç¼–è¯‘æ—¶éœ€è¦ï¼Œä½†å…¶å®ç°ç”±æ¶ˆè´¹åº“ï¼Œåº”ç”¨ç¨‹åºæˆ–è¿è¡Œæ—¶ç¯å¢ƒæä¾›çš„ä¾èµ–é¡¹ã€‚</li>
</ol>
<h3 id="runtimeOnly-çš„ä½¿ç”¨åœºæ™¯"><a href="#runtimeOnly-çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="runtimeOnly çš„ä½¿ç”¨åœºæ™¯"></a>runtimeOnly çš„ä½¿ç”¨åœºæ™¯</h3><p>ä¾èµ–é¡¹ä»…åœ¨è¿è¡Œæ—¶å¯¹æ¨¡å—åŠå…¶æ¶ˆè´¹è€…å¯ç”¨ã€‚</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><table>
<thead>
<tr>
<th>æ–°é…ç½®</th>
<th>å·²å¼ƒç”¨é…ç½®</th>
<th>è¡Œä¸º</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>implementation</code></td>
<td><code>compile</code></td>
<td>ä¾èµ–é¡¹åœ¨ç¼–è¯‘æ—¶å¯¹æ¨¡å—å¯ç”¨ï¼Œå¹¶ä¸”ä»…åœ¨è¿è¡Œæ—¶å¯¹æ¨¡å—çš„æ¶ˆè´¹è€…å¯ç”¨ã€‚ å¯¹äºå¤§å‹å¤šé¡¹ç›®æ„å»ºï¼Œä½¿ç”¨ <code>implementation</code> è€Œä¸æ˜¯ <code>api</code>/<code>compile</code> å¯ä»¥<strong>æ˜¾è‘—ç¼©çŸ­æ„å»ºæ—¶é—´</strong>ï¼Œå› ä¸ºå®ƒå¯ä»¥å‡å°‘æ„å»ºç³»ç»Ÿéœ€è¦é‡æ–°ç¼–è¯‘çš„é¡¹ç›®é‡ã€‚ å¤§å¤šæ•°åº”ç”¨å’Œæµ‹è¯•æ¨¡å—éƒ½åº”ä½¿ç”¨æ­¤é…ç½®ã€‚</td>
</tr>
<tr>
<td><code>api</code></td>
<td><code>compile</code></td>
<td>ä¾èµ–é¡¹åœ¨ç¼–è¯‘æ—¶å¯¹æ¨¡å—å¯ç”¨ï¼Œå¹¶ä¸”åœ¨ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶è¿˜å¯¹æ¨¡å—çš„æ¶ˆè´¹è€…å¯ç”¨ã€‚ æ­¤é…ç½®çš„è¡Œä¸ºç±»ä¼¼äº <code>compile</code>ï¼ˆç°åœ¨å·²å¼ƒç”¨ï¼‰ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ‚¨åº”å½“ä»…åœ¨åº“æ¨¡å—ä¸­ä½¿ç”¨å®ƒã€‚ åº”ç”¨æ¨¡å—åº”ä½¿ç”¨ <code>implementation</code>ï¼Œé™¤éæ‚¨æƒ³è¦å°†å…¶ API å…¬å¼€ç»™å•ç‹¬çš„æµ‹è¯•æ¨¡å—ã€‚</td>
</tr>
<tr>
<td><code>compileOnly</code></td>
<td><code>provided</code></td>
<td>ä¾èµ–é¡¹ä»…åœ¨ç¼–è¯‘æ—¶å¯¹æ¨¡å—å¯ç”¨ï¼Œå¹¶ä¸”åœ¨ç¼–è¯‘æˆ–è¿è¡Œæ—¶å¯¹å…¶æ¶ˆè´¹è€…ä¸å¯ç”¨ã€‚ æ­¤é…ç½®çš„è¡Œä¸ºç±»ä¼¼äº <code>provided</code>ï¼ˆç°åœ¨å·²å¼ƒç”¨ï¼‰ã€‚</td>
</tr>
<tr>
<td><code>runtimeOnly</code></td>
<td><code>apk</code></td>
<td>ä¾èµ–é¡¹ä»…åœ¨è¿è¡Œæ—¶å¯¹æ¨¡å—åŠå…¶æ¶ˆè´¹è€…å¯ç”¨ã€‚ æ­¤é…ç½®çš„è¡Œä¸ºç±»ä¼¼äº <code>apk</code>ï¼ˆç°åœ¨å·²å¼ƒç”¨ï¼‰ã€‚</td>
</tr>
</tbody>
</table>
<blockquote>
<p> <strong>æ³¨</strong>ï¼š<code>compile</code>ã€<code>provided</code> å’Œ <code>apk</code> ç›®å‰ä»ç„¶å¯ç”¨ã€‚ ä¸è¿‡ï¼Œå®ƒä»¬å°†åœ¨ä¸‹ä¸€ä¸ªä¸»è¦ç‰ˆæœ¬çš„ Android æ’ä»¶ä¸­æ¶ˆå¤±ã€‚</p>
</blockquote>
<p>æ—¥å¸¸å¼€å‘ä¸­ä¸€èˆ¬éƒ½æ˜¯ç”¨ implementationï¼Œéƒ¨åˆ†æƒ…å†µä¸‹ä¼šç”¨åˆ° apiï¼Œå…¶ä»–çš„ä¾èµ–æ–¹å¼ä¸€èˆ¬ä¸æ€ä¹ˆç”¨åˆ°ã€‚è®°ä½ compileã€api ä¾èµ–æ–¹å¼æ˜¯ã€Œä¼ é€’æ€§çš„ã€ï¼Œè€Œ implementation ä¾èµ–æ–¹å¼çš„æ˜¯ã€Œéä¼ é€’æ€§ã€çš„ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><p><a href="https://developer.android.com/studio/build/gradle-plugin-3-0-0-migration" target="_blank" rel="noopener">è¿ç§»åˆ° Android Plugin for Gradle 3.0.0</a></p>
</li>
<li><p><a href="https://jeroenmols.com/blog/2017/06/14/androidstudio3/" target="_blank" rel="noopener">Implementation vs API dependency</a></p>
</li>
<li><p><a href="https://blog.csdn.net/yuzhiqiang_1993/article/details/78366985" target="_blank" rel="noopener">Android Studio3.x æ–°çš„ä¾èµ–æ–¹å¼ï¼ˆimplementationã€apiã€compileOnlyï¼‰</a></p>
</li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> Gradle </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Gradle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Fragment Note]]></title>
      <url>https://timlin-pro.github.io/blog/2018/06/02/Fragment%20Note/</url>
      <content type="html"><![CDATA[<p>ç¬”è®°è‡ªç”¨ï¼Œéƒ¨åˆ†å†…å®¹å¾…å®Œå–„ã€‚</p>
<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>å½“æ‚¨å°†ç‰‡æ®µä½œä¸º Activity å¸ƒå±€çš„ä¸€éƒ¨åˆ†æ·»åŠ æ—¶ï¼Œå®ƒå­˜åœ¨äº Activity è§†å›¾å±‚æ¬¡ç»“æ„çš„æŸä¸ª <code>ViewGroup</code> å†…éƒ¨ï¼Œå¹¶ä¸”<strong>ç‰‡æ®µä¼šå®šä¹‰å…¶è‡ªå·±çš„è§†å›¾å¸ƒå±€</strong>ã€‚æ‚¨å¯ä»¥é€šè¿‡åœ¨ Activity çš„<strong>å¸ƒå±€æ–‡ä»¶ä¸­å£°æ˜ç‰‡æ®µ</strong>ï¼Œå°†å…¶ä½œä¸º <code>&lt;fragment&gt;</code> å…ƒç´ æ’å…¥æ‚¨çš„ Activity å¸ƒå±€ä¸­ï¼Œæˆ–è€…é€šè¿‡å°†å…¶æ·»åŠ åˆ°æŸä¸ªç°æœ‰ <code>ViewGroup</code>ï¼Œåˆ©ç”¨åº”ç”¨ä»£ç è¿›è¡Œæ’å…¥ã€‚ä¸è¿‡ï¼Œç‰‡æ®µ<strong>å¹¶éå¿…é¡»æˆä¸º Activity å¸ƒå±€çš„ä¸€éƒ¨åˆ†</strong>ï¼›æ‚¨è¿˜å¯ä»¥å°†æ²¡æœ‰è‡ªå·± UI çš„ç‰‡æ®µç”¨ä½œ Activity çš„ä¸å¯è§å·¥ä½œçº¿ç¨‹ã€‚</p>
<a id="more"></a>
<h3 id="Fragment-è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ"><a href="#Fragment-è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ" class="headerlink" title="Fragment è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ"></a>Fragment è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h3><p>ä¸èƒ½ç›´æ¥ç”¨ View æ›¿ä»£å—ï¼Ÿ</p>
<p>ç›¸å¯¹äº view è€Œè¨€ï¼Œå®ƒçš„ä¼˜åŠ¿åœ¨å“ªï¼Ÿ</p>
<p> Android 3.0ï¼ˆAPI çº§åˆ« 11ï¼‰ä¸­å¼•å…¥äº†ç‰‡æ®µï¼Œä¸»è¦æ˜¯ä¸ºäº†ç»™å¤§å±å¹•ï¼ˆå¦‚å¹³æ¿ç”µè„‘ï¼‰ä¸Šæ›´åŠ åŠ¨æ€å’Œçµæ´»çš„ UI è®¾è®¡æä¾›æ”¯æŒã€‚ç”±äºå¹³æ¿ç”µè„‘çš„å±å¹•æ¯”æ‰‹æœºå±å¹•å¤§å¾—å¤šï¼Œå› æ­¤å¯ç”¨äºç»„åˆå’Œäº¤æ¢ UI ç»„ä»¶çš„ç©ºé—´æ›´å¤§ã€‚åˆ©ç”¨ç‰‡æ®µå®ç°æ­¤ç±»è®¾è®¡æ—¶ï¼Œæ‚¨<strong>æ— éœ€ç®¡ç†å¯¹è§†å›¾å±‚æ¬¡ç»“æ„çš„å¤æ‚æ›´æ”¹</strong>ã€‚ </p>
<p>æ‚¨åº”è¯¥å°†æ¯ä¸ªç‰‡æ®µéƒ½è®¾è®¡ä¸º<strong>å¯é‡å¤ä½¿ç”¨çš„æ¨¡å—åŒ– Activity ç»„ä»¶</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”±äºæ¯ä¸ªç‰‡æ®µéƒ½ä¼šé€šè¿‡å„è‡ªçš„ç”Ÿå‘½å‘¨æœŸå›è°ƒæ¥å®šä¹‰å…¶è‡ªå·±çš„å¸ƒå±€å’Œè¡Œä¸ºï¼Œæ‚¨å¯ä»¥<strong>å°†ä¸€ä¸ªç‰‡æ®µåŠ å…¥å¤šä¸ª Activity</strong>ï¼Œå› æ­¤ï¼Œæ‚¨<strong>åº”è¯¥é‡‡ç”¨å¯å¤ç”¨å¼è®¾è®¡ï¼Œé¿å…ç›´æ¥ä»æŸä¸ªç‰‡æ®µç›´æ¥æ“çºµå¦ä¸€ä¸ªç‰‡æ®µ</strong>ã€‚ è¿™ç‰¹åˆ«é‡è¦ï¼Œå› ä¸º<strong>æ¨¡å—åŒ–ç‰‡æ®µè®©æ‚¨å¯ä»¥é€šè¿‡æ›´æ”¹ç‰‡æ®µçš„ç»„åˆæ–¹å¼æ¥é€‚åº”ä¸åŒçš„å±å¹•å°ºå¯¸</strong>ã€‚ åœ¨è®¾è®¡å¯åŒæ—¶æ”¯æŒå¹³æ¿ç”µè„‘å’Œæ‰‹æœºçš„åº”ç”¨æ—¶ï¼Œæ‚¨å¯ä»¥åœ¨ä¸åŒçš„å¸ƒå±€é…ç½®ä¸­é‡å¤ä½¿ç”¨æ‚¨çš„ç‰‡æ®µï¼Œä»¥æ ¹æ®å¯ç”¨çš„å±å¹•ç©ºé—´ä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚ </p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>é€šå¸¸è‡³å°‘éœ€è¦å®ç°ä»¥ä¸‹å‡ ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼š</p>
<ul>
<li><p>onCreateï¼ˆï¼‰</p>
<ul>
<li>åœ¨æ­¤æ–¹æ³•ä¸­åˆå§‹åŒ–é‚£äº›ä½ å¸Œæœ›åœ¨fragment å¤„äº paused or stopped, then resumedçŠ¶æ€çš„æ—¶å€™ä»ç„¶è¢«ä¿ç•™çš„ç»„ä»¶</li>
</ul>
</li>
<li><p>onCreateView()</p>
<ul>
<li>è¿™ä¸ªæ–¹æ³•å¿…é¡»è¿”å› è¿™ä¸ªfragmentçš„å¸ƒå±€çš„æ ¹Viewï¼Œä¹Ÿå¦‚æœæ­¤fragmentä¸æä¾›ä¸€ä¸ªUIçš„è¯ï¼Œå¯ä»¥è¿”å›ç©º</li>
</ul>
</li>
<li><p>onPause()</p>
<ul>
<li>è¿™ä¸ªæ–¹æ³•ä¸­ä½ åº”è¯¥<strong>æäº¤ä½ çš„fragmentä¸­çš„é‚£äº›éœ€è¦è¢«ä¿å­˜çš„æ•°æ®</strong>ã€‚</li>
</ul>
</li>
</ul>
<h3 id="å‚æ•°ä¼ é€’"><a href="#å‚æ•°ä¼ é€’" class="headerlink" title="å‚æ•°ä¼ é€’"></a>å‚æ•°ä¼ é€’</h3><p>ä½¿ç”¨ setArgument çš„æ–¹å¼ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ä¼ é€’å‚æ•°ï¼Œå¦‚æœé…ç½®å‘ç”Ÿæ›´æ”¹ï¼Œé€šè¿‡<code>Fragment.setArguments(Bundle bundle)</code>æ–¹æ³•è®¾ç½®çš„bundleä¼šä¿ç•™ä¸‹æ¥ã€‚</p>
<p>å¦‚æœæ˜¯é€šè¿‡ç›´æ¥èµ‹å€¼çš„æ–¹å¼ï¼Œåˆ™éœ€è¦å®ç° onSaveInstance å’Œ onRestoreIntanceState æ–¹æ³•ï¼ˆæˆ–è€… åœ¨ onCreate æ–¹æ³•è¿›è¡Œé…ç½®ï¼‰æ‰èƒ½åº”å¯¹é…ç½®æ›´æ”¹ã€‚</p>
<p>è¦æ³¨æ„çš„é—®é¢˜å°±æ˜¯ setArgument æ–¹æ³•è¦åœ¨ Fragment ä¸ Activity å…³è”ä¹‹å‰è°ƒç”¨ã€‚</p>
<h3 id="å¯ä»¥è¢«ç»§æ‰¿çš„FragmentåŸºç±»"><a href="#å¯ä»¥è¢«ç»§æ‰¿çš„FragmentåŸºç±»" class="headerlink" title="å¯ä»¥è¢«ç»§æ‰¿çš„FragmentåŸºç±»"></a>å¯ä»¥è¢«ç»§æ‰¿çš„FragmentåŸºç±»</h3><ul>
<li>DialogFragment</li>
</ul>
<blockquote>
<p>Displays a floating dialog. Using this class to create a dialog is a good alternative to using the dialog helper methods in the Activity class, because you can incorporate(åŒ…å«) a fragment dialog into the back stack of fragments managed by the activity, allowing the user to return to a dismissed fragment.</p>
</blockquote>
<p>ç›¸æ¯”äº Dialog çš„å¥½å¤„ï¼š</p>
<ol>
<li>ç”Ÿå‘½å‘¨æœŸä¾¿äºç®¡ç†ï¼›</li>
<li>æ¯” Dialog æ›´åŠ åœ°å¼ºå¤§ã€‚ã€ŒDialogFragmentä¹Ÿå…è®¸å¼€å‘è€…æŠŠDialogä½œä¸ºå†…åµŒçš„ç»„ä»¶è¿›è¡Œé‡ç”¨ã€</li>
</ol>
<p>é‡å†™ onCreateView æˆ–è€…  onCreateDialog </p>
<ul>
<li>ListFragment</li>
</ul>
<blockquote>
<p>Displays a list of items that are managed by an adapter (such as a SimpleCursorAdapter), similar to ListActivity. It provides several methods for managing a list view, such as the onListItemClick() callback to handle click events.</p>
</blockquote>
<p>ç±»ä¼¼äºListActivity</p>
<ul>
<li>PreferenceFragment</li>
</ul>
<blockquote>
<p>Displays a hierarchy of Preference objects as a list, similar to PreferenceActivity. This is useful when creating a â€œsettingsâ€ activity for your application.</p>
</blockquote>
<p>å¯¹äºâ€œè®¾ç½®â€ç•Œé¢è€Œè¨€å¾ˆæœ‰ç”¨</p>
<h3 id="ç‰¹æ®Šç”¨é€”"><a href="#ç‰¹æ®Šç”¨é€”" class="headerlink" title="ç‰¹æ®Šç”¨é€”"></a>ç‰¹æ®Šç”¨é€”</h3><p>è°ƒç”¨ <code>setRetainInstance(true);</code>ï¼Œä¼šåœ¨é…ç½®å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ä¿å­˜å½“å‰Fragment ä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Control whether a fragment instance is retained across Activity</div><div class="line"> * re-creation (such as from a configuration change).  This can only</div><div class="line"> * be used with fragments not in the back stack.  If set, the fragment</div><div class="line"> * lifecycle will be slightly different when an activity is recreated:</div><div class="line"> * &lt;ul&gt;</div><div class="line"> * &lt;li&gt; &#123;<span class="doctag">@link</span> #onDestroy()&#125; will not be called (but &#123;<span class="doctag">@link</span> #onDetach()&#125; still</div><div class="line"> * will be, because the fragment is being detached from its current activity).</div><div class="line"> * &lt;li&gt; &#123;<span class="doctag">@link</span> #onCreate(Bundle)&#125; will not be called since the fragment</div><div class="line"> * is not being re-created.</div><div class="line"> * &lt;li&gt; &#123;<span class="doctag">@link</span> #onAttach(Activity)&#125; and &#123;<span class="doctag">@link</span> #onActivityCreated(Bundle)&#125; &lt;b&gt;will&lt;/b&gt;</div><div class="line"> * still be called.</div><div class="line"> * &lt;/ul&gt;</div><div class="line"> */</div><div class="line">è¯¥æ–¹æ³•æ§åˆ¶ Fragment çš„å®ä¾‹æ˜¯å¦åœ¨Activityé‡æ–°åˆ›å»ºçš„æ—¶å€™ä¿ç•™ã€‚</div><div class="line">å®ƒåªèƒ½ç”¨äºé‚£äº›ä¸å¤„åœ¨å›é€€æ ˆä¸­çš„Fragment èº«ä¸Šã€‚</div><div class="line">æ³¨æ„ï¼Œå¦‚æœä¿ç•™å®ä¾‹çš„è¯ï¼ŒFragment çš„ç”Ÿå‘½å‘¨æœŸå°†ä¼šæœ‰ä¸€äº›ä¸åŒ</div><div class="line">- onDestory æ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ï¼Œä½†æ˜¯ onDetach æ–¹æ³•ä»ç„¶ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸º Fragment ä»å½“å‰ Activity ä¸­å‰¥ç¦»äº†ã€‚</div><div class="line">- onCreate æ–¹æ³•ä¹Ÿä¸ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸º Fragment å¹¶æ²¡æœ‰é‡æ–°åˆ›å»º</div><div class="line">- onAttach å’Œ onActivityCreated æ–¹æ³•ä¾ç„¶ä¼šè¢«è°ƒç”¨ã€‚</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRetainInstance</span><span class="params">(<span class="keyword">boolean</span> retain)</span> </span>&#123;</div><div class="line">    mRetainInstance = retain;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”¨äºä¿å­˜æ•°æ®ã€‚</p>
<h2 id="åˆ›å»º-æ¸²æŸ“ç”¨æˆ·ç•Œé¢"><a href="#åˆ›å»º-æ¸²æŸ“ç”¨æˆ·ç•Œé¢" class="headerlink" title="åˆ›å»º/æ¸²æŸ“ç”¨æˆ·ç•Œé¢"></a>åˆ›å»º/æ¸²æŸ“ç”¨æˆ·ç•Œé¢</h2><p>ä¸ºäº†æä¾›ä¸€ä¸ªå¸ƒå±€ç»™fragmentï¼Œä½ å¿…é¡»å®ç°onCreateView()æ–¹æ³•,è¿™ä¸ªæ–¹æ³•ä¼šåœ¨åˆ°è¿™ä¸ªFragment ç»˜å‡ºå®ƒçš„å¸ƒå±€çš„æ—¶å€™ è¢«å®‰å“ç³»ç»Ÿè°ƒç”¨ã€‚<br>æ­¤å¤–ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­å¿…é¡» return a View that is the root of your fragmentâ€™s layout</p>
<blockquote>
<p>Note: If your fragment is a subclass of ListFragment, the default implementation returns a ListView from onCreateView(), so you donâ€™t need to implement it.</p>
</blockquote>
<p><code>inflate()</code> æ–¹æ³•å¸¦æœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>æ‚¨æƒ³è¦inflateçš„å¸ƒå±€çš„èµ„æº IDï¼›</li>
<li>å°†ä½œä¸ºinflateå¸ƒå±€çˆ¶é¡¹çš„ <code>ViewGroup</code>ã€‚ä¼ é€’ <code>container</code> å¯¹ç³»ç»Ÿå‘inflateå¸ƒå±€çš„æ ¹è§†å›¾ï¼ˆç”±å…¶æ‰€å±çš„çˆ¶è§†å›¾æŒ‡å®šï¼‰åº”ç”¨å¸ƒå±€å‚æ•°å…·æœ‰é‡è¦æ„ä¹‰ï¼›</li>
<li>æŒ‡ç¤ºæ˜¯å¦åº”è¯¥åœ¨inflateæœŸé—´å°†inflateå¸ƒå±€é™„åŠ è‡³ <code>ViewGroup</code>ï¼ˆç¬¬äºŒä¸ªå‚æ•°ï¼‰çš„å¸ƒå°”å€¼ã€‚ï¼ˆåœ¨æœ¬ä¾‹ä¸­ï¼Œå…¶å€¼ä¸º falseï¼Œå› ä¸ºç³»ç»Ÿå·²ç»å°†inflateå¸ƒå±€æ’å…¥ <code>container</code> â€” ä¼ é€’ true å€¼ä¼šåœ¨æœ€ç»ˆå¸ƒå±€ä¸­åˆ›å»ºä¸€ä¸ªå¤šä½™çš„è§†å›¾ç»„ã€‚ï¼‰</li>
</ul>
<p>ç³»ç»Ÿä¼šå¸®æˆ‘ä»¬ addViewï¼Œæ‰€ä»¥ attachToRoot ä¸º falseï¼›</p>
<p><code>android.support.v4.app.FragmentManagerImpl#moveToState(android.support.v4.app.Fragment, int, int, int, boolean)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(container != <span class="keyword">null</span>) &#123;</div><div class="line">    container.addView(f.mView);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ¨èç”¨ä¸‹è¾¹è¿™ç§æ–¹å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">inflater.inflate(R.layout.item, parent, false);</div></pre></td></tr></table></figure>
<p>æµ‹é‡çš„æ—¶å€™ä¾èµ– parentï¼Œä½†æ˜¯æ·»åŠ éœ€è¦æ‰‹åŠ¨è¿›è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(XmlPullParser parser, @Nullable ViewGroup root, <span class="keyword">boolean</span> attachToRoot)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (mConstructorArgs) &#123;</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"inflate"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Context inflaterContext = mContext;</div><div class="line">        <span class="keyword">final</span> AttributeSet attrs = Xml.asAttributeSet(parser);</div><div class="line">        Context lastContext = (Context) mConstructorArgs[<span class="number">0</span>];</div><div class="line">        mConstructorArgs[<span class="number">0</span>] = inflaterContext;</div><div class="line">        View result = root;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Look for the root node.</span></div><div class="line">            <span class="keyword">int</span> type;</div><div class="line">            <span class="keyword">final</span> String name = parser.getName();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (TAG_MERGE.equals(name)) &#123;</div><div class="line">                <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;merge /&gt; can be used only with a valid "</span></div><div class="line">                            + <span class="string">"ViewGroup root and attachToRoot=true"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                rInflate(parser, root, inflaterContext, attrs, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Temp is the root view that was found in the xml</span></div><div class="line">                <span class="keyword">final</span> View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line"></div><div class="line">                ViewGroup.LayoutParams params = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (root != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</div><div class="line">                        System.out.println(<span class="string">"Creating params from root: "</span> +</div><div class="line">                                root);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// Create layout params that match root, if supplied</span></div><div class="line">                    <span class="comment">//åˆ›å»º æ ¹å¸ƒå±€çš„ layout params</span></div><div class="line">                    params = root.generateLayoutParams(attrs);</div><div class="line">                    <span class="keyword">if</span> (!attachToRoot) &#123;</div><div class="line">                        <span class="comment">// Set the layout params for temp if we are not</span></div><div class="line">                        <span class="comment">// attaching. (If we are, we use addView, below)</span></div><div class="line">                        temp.setLayoutParams(params);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (DEBUG) &#123;</div><div class="line">                    System.out.println(<span class="string">"-----&gt; start inflating children"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Inflate all children under temp against its context.</span></div><div class="line">                rInflateChildren(parser, temp, attrs, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (DEBUG) &#123;</div><div class="line">                    System.out.println(<span class="string">"-----&gt; done inflating children"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line"></div><div class="line">                <span class="comment">//æ ¹å¸ƒå±€å­˜åœ¨ å¹¶ä¸” å¾…æ¸²æŸ“çš„å¸ƒå±€éœ€è¦å…³è”åˆ° rootï¼Œé‚£å°±è°ƒç”¨ addView æ–¹æ³•å°†å®ƒæ·»åŠ è¿›å»</span></div><div class="line">                <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; attachToRoot) &#123;</div><div class="line">                    root.addView(temp, params);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">//ç¡®å®šè¿”å›å€¼æ˜¯ root è¿˜æ˜¯  xml æ–‡ä»¶ä¸­çš„æ ¹å¸ƒå±€</span></div><div class="line">                <span class="comment">//root ä¸º null æˆ–è€… ä¸å…³è”åˆ°æ ¹å¸ƒå±€ï¼Œè¿”å›çš„å°±æ˜¯ xml æ–‡ä»¶ä¸­çš„æ ¹å¸ƒå±€</span></div><div class="line">                <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">                    result = temp;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</div><div class="line">            <span class="comment">//â€¦â€¦</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å°†-Fragment-æ·»åŠ åˆ°-Activity-çš„ä¸¤ç§æ–¹å¼"><a href="#å°†-Fragment-æ·»åŠ åˆ°-Activity-çš„ä¸¤ç§æ–¹å¼" class="headerlink" title="å°† Fragment æ·»åŠ åˆ° Activity çš„ä¸¤ç§æ–¹å¼"></a>å°† Fragment æ·»åŠ åˆ° Activity çš„ä¸¤ç§æ–¹å¼</h2><h3 id="1-åœ¨-Activity-çš„å¸ƒå±€æ–‡ä»¶å†…å£°æ˜ç‰‡æ®µ"><a href="#1-åœ¨-Activity-çš„å¸ƒå±€æ–‡ä»¶å†…å£°æ˜ç‰‡æ®µ" class="headerlink" title="1.åœ¨ Activity çš„å¸ƒå±€æ–‡ä»¶å†…å£°æ˜ç‰‡æ®µ"></a>1.åœ¨ Activity çš„å¸ƒå±€æ–‡ä»¶å†…å£°æ˜ç‰‡æ®µ</h3><ul>
<li>å½“ç³»ç»Ÿåˆ›å»ºæ­¤ Activity å¸ƒå±€æ—¶ï¼Œä¼š<strong>å®ä¾‹åŒ–åœ¨å¸ƒå±€ä¸­æŒ‡å®šçš„æ¯ä¸ªç‰‡æ®µ</strong>ï¼Œå¹¶ä¸ºæ¯ä¸ªç‰‡æ®µè°ƒç”¨ <code>onCreateView()</code> æ–¹æ³•ï¼Œä»¥æ£€ç´¢æ¯ä¸ªç‰‡æ®µçš„å¸ƒå±€ã€‚<strong>ç³»ç»Ÿä¼šç›´æ¥æ’å…¥ç‰‡æ®µè¿”å›çš„ <code>View</code> æ¥æ›¿ä»£ <code>&lt;fragment&gt;</code> å…ƒç´ </strong>ã€‚</li>
</ul>
<p><code>&lt;fragment&gt;</code> å…ƒç´ ä¸­å¯ä»¥é€šè¿‡ <code>class = â€œ â€</code> ä¹Ÿå¯ä»¥é€šè¿‡ <code>android:name=&quot;&quot;</code> æ¥æŒ‡å®š è¦åŠ å…¥çš„Fragmentã€‚</p>
<p>class çš„æ€§èƒ½ä¼šé«˜ä¸€ç‚¹ç‚¹ã€‚</p>
<p>å› ä¸ºï¼šandroid.support.v4.app.FragmentManagerImpl#onCreateView(android.view.View, java.lang.String, android.content.Context, android.util.AttributeSet)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(View parent, String name, Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!<span class="string">"fragment"</span>.equals(name)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//é€šè¿‡ class è·å– Fragment åå­—</span></div><div class="line">    String fname = attrs.getAttributeValue(<span class="keyword">null</span>, <span class="string">"class"</span>);</div><div class="line">    TypedArray a =  context.obtainStyledAttributes(attrs, FragmentTag.Fragment);</div><div class="line">    <span class="keyword">if</span> (fname == <span class="keyword">null</span>) &#123;<span class="comment">//ç”¨ class æ‰¾ä¸åˆ°ï¼Œé€šè¿‡ android:name å»æŸ¥æ‰¾</span></div><div class="line">        fname = a.getString(FragmentTag.Fragment_name);</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//â€¦â€¦</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>æ³¨</strong>ï¼šæ¯ä¸ªç‰‡æ®µéƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œé‡å¯ Activity æ—¶ï¼Œç³»ç»Ÿå¯ä»¥ä½¿ç”¨è¯¥æ ‡è¯†ç¬¦æ¥æ¢å¤ç‰‡æ®µï¼ˆæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨è¯¥æ ‡è¯†ç¬¦æ¥æ•è·ç‰‡æ®µä»¥æ‰§è¡ŒæŸäº›äº‹åŠ¡ï¼Œå¦‚å°†å…¶ç§»é™¤ï¼‰ã€‚ å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼ä¸ºç‰‡æ®µæä¾› IDï¼š</p>
<ul>
<li>ä¸º <code>android:id</code> å±æ€§æä¾›å”¯ä¸€ IDã€‚</li>
<li>ä¸º <code>android:tag</code> å±æ€§æä¾›å”¯ä¸€å­—ç¬¦ä¸²ã€‚</li>
<li>å¦‚æœæ‚¨æœªç»™ä»¥ä¸Šä¸¤ä¸ªå±æ€§æä¾›å€¼ï¼Œç³»ç»Ÿä¼šä½¿ç”¨å®¹å™¨è§†å›¾çš„ IDã€‚</li>
</ul>
<h3 id="2-é€šè¿‡java-ä»£ç å°†ç‰‡æ®µæ·»åŠ åˆ°æŸä¸ªç°æœ‰-ViewGroup"><a href="#2-é€šè¿‡java-ä»£ç å°†ç‰‡æ®µæ·»åŠ åˆ°æŸä¸ªç°æœ‰-ViewGroup" class="headerlink" title="2.é€šè¿‡java ä»£ç å°†ç‰‡æ®µæ·»åŠ åˆ°æŸä¸ªç°æœ‰ ViewGroup"></a>2.é€šè¿‡java ä»£ç å°†ç‰‡æ®µæ·»åŠ åˆ°æŸä¸ªç°æœ‰ ViewGroup</h3><p>æ‚¨å¯ä»¥åœ¨ Activity è¿è¡ŒæœŸé—´éšæ—¶å°†ç‰‡æ®µæ·»åŠ åˆ° Activity å¸ƒå±€ä¸­ã€‚æ‚¨åªéœ€æŒ‡å®šè¦å°†ç‰‡æ®µæ”¾å…¥å“ªä¸ª <code>ViewGroup</code>ã€‚</p>
<p>æ‚¨å¿…é¡»ä½¿ç”¨ <code>FragmentTransaction</code> ä¸­çš„ API,æ‰èƒ½åœ¨ Activity ä¸­æ‰§è¡Œç‰‡æ®µäº‹åŠ¡ï¼ˆå¦‚æ·»åŠ ã€ç§»é™¤æˆ–æ›¿æ¢ç‰‡æ®µï¼‰ã€‚æ‚¨å¯ä»¥åƒä¸‹é¢è¿™æ ·ä» <code>Activity</code> è·å–ä¸€ä¸ª <code>FragmentTransaction</code> å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">FragmentManager fragmentManager = getFragmentManager();</div><div class="line">FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();</div></pre></td></tr></table></figure>
<p>ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>add()</code> æ–¹æ³•æ·»åŠ ä¸€ä¸ªç‰‡æ®µï¼Œ<strong>æŒ‡å®šè¦æ·»åŠ çš„ç‰‡æ®µä»¥åŠå°†å…¶æ’å…¥å“ªä¸ªè§†å›¾</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ExampleFragment fragment = <span class="keyword">new</span> ExampleFragment();</div><div class="line">fragmentTransaction.add(R.id.fragment_container, fragment);<span class="comment">//å°†è¦æ·»åŠ çš„ç‰‡æ®µ</span></div><div class="line">fragmentTransaction.commit();</div></pre></td></tr></table></figure>
<p><strong>ä¼ é€’åˆ° <code>add()</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ <code>ViewGroup</code>ï¼Œå³åº”è¯¥æ”¾ç½®ç‰‡æ®µçš„ä½ç½®ï¼Œç”±èµ„æº ID æŒ‡å®šï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦æ·»åŠ çš„ç‰‡æ®µ</strong>ã€‚</p>
<p>ä¸€æ—¦æ‚¨é€šè¿‡ <code>FragmentTransaction</code> åšå‡ºäº†æ›´æ”¹ï¼Œå°±å¿…é¡»è°ƒç”¨ <code>commit()</code> ä»¥ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚</p>
<h4 id="æ·»åŠ æ²¡æœ‰-UI-çš„ç‰‡æ®µ"><a href="#æ·»åŠ æ²¡æœ‰-UI-çš„ç‰‡æ®µ" class="headerlink" title="æ·»åŠ æ²¡æœ‰ UI çš„ç‰‡æ®µ"></a>æ·»åŠ æ²¡æœ‰ UI çš„ç‰‡æ®µ</h4><p>å¯ä»¥ä½¿ç”¨ç‰‡æ®µä¸º Activity æä¾›åå°è¡Œä¸ºï¼Œè€Œä¸æ˜¾ç¤ºé¢å¤– UIã€‚</p>
<p>è¦æƒ³æ·»åŠ æ²¡æœ‰ UI çš„ç‰‡æ®µï¼Œè¯·ä½¿ç”¨ <code>add(Fragment, String)</code> ä» Activity æ·»åŠ ç‰‡æ®µï¼ˆä¸ºç‰‡æ®µæä¾›ä¸€ä¸ªå”¯ä¸€çš„å­—ç¬¦ä¸²â€œæ ‡è®°â€ï¼Œè€Œä¸æ˜¯è§†å›¾ IDï¼‰ã€‚ è¿™ä¼šæ·»åŠ ç‰‡æ®µï¼Œä½†<strong>ç”±äºå®ƒå¹¶ä¸ä¸ Activity å¸ƒå±€ä¸­çš„è§†å›¾å…³è”ï¼Œå› æ­¤ä¸ä¼šæ”¶åˆ°å¯¹<code>onCreateView()</code> çš„è°ƒç”¨</strong>ã€‚å› æ­¤ï¼Œæ‚¨ä¸éœ€è¦å®ç° <code>onCreateView()</code>æ–¹æ³•ã€‚</p>
<p>å¦‚æœç‰‡æ®µæ²¡æœ‰ UIï¼Œåˆ™å­—ç¬¦ä¸²æ ‡è®°å°†æ˜¯æ ‡è¯†å®ƒçš„å”¯ä¸€æ–¹å¼ã€‚</p>
<h3 id="ç®¡ç†ç‰‡æ®µ"><a href="#ç®¡ç†ç‰‡æ®µ" class="headerlink" title="ç®¡ç†ç‰‡æ®µ"></a>ç®¡ç†ç‰‡æ®µ</h3><p>è¦æƒ³ç®¡ç†æ‚¨çš„ Activity ä¸­çš„ç‰‡æ®µï¼Œæ‚¨éœ€è¦ä½¿ç”¨ <code>FragmentManager</code>ã€‚è¦æƒ³è·å–å®ƒï¼Œè¯·ä»æ‚¨çš„ Activity è°ƒç”¨ <code>getFragmentManager()</code>ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ <code>FragmentManager</code> æ‰§è¡Œçš„æ“ä½œåŒ…æ‹¬ï¼š</p>
<ul>
<li>é€šè¿‡ <code>findFragmentById()</code>ï¼ˆå¯¹äºåœ¨ Activity å¸ƒå±€ä¸­æä¾› UI çš„ç‰‡æ®µï¼‰æˆ– <code>findFragmentByTag()</code>ï¼ˆå¯¹äºæä¾›æˆ–ä¸æä¾› UI çš„ç‰‡æ®µï¼‰è·å– Activity ä¸­å­˜åœ¨çš„ç‰‡æ®µã€‚</li>
<li>é€šè¿‡ <code>popBackStack()</code>ï¼ˆæ¨¡æ‹Ÿç”¨æˆ·å‘å‡ºçš„<em>è¿”å›</em>å‘½ä»¤ï¼‰å°†ç‰‡æ®µä»è¿”å›æ ˆä¸­å¼¹å‡ºã€‚</li>
<li>é€šè¿‡ <code>addOnBackStackChangedListener()</code> æ³¨å†Œä¸€ä¸ªç›‘å¬è¿”å›æ ˆå˜åŒ–çš„ä¾¦å¬å™¨ã€‚</li>
</ul>
<p>å¦‚éœ€äº†è§£æœ‰å…³è¿™äº›æ–¹æ³•ä»¥åŠå…¶ä»–æ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… <code>FragmentManager</code> ç±»æ–‡æ¡£ã€‚</p>
<p>å¦‚ä¸Šæ–‡æ‰€ç¤ºï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>FragmentManager</code> æ‰“å¼€ä¸€ä¸ª <code>FragmentTransaction</code>ï¼Œé€šè¿‡å®ƒæ¥æ‰§è¡ŒæŸäº›äº‹åŠ¡ï¼Œå¦‚æ·»åŠ å’Œç§»é™¤ç‰‡æ®µã€‚</p>
<h2 id="æ‰§è¡Œç‰‡æ®µäº‹åŠ¡"><a href="#æ‰§è¡Œç‰‡æ®µäº‹åŠ¡" class="headerlink" title="æ‰§è¡Œç‰‡æ®µäº‹åŠ¡"></a>æ‰§è¡Œç‰‡æ®µäº‹åŠ¡</h2><p>åœ¨ Activity ä¸­ä½¿ç”¨ç‰‡æ®µçš„ä¸€å¤§ä¼˜ç‚¹æ˜¯ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·è¡Œä¸ºé€šè¿‡å®ƒä»¬æ‰§è¡Œæ·»åŠ ã€ç§»é™¤ã€æ›¿æ¢ä»¥åŠå…¶ä»–æ“ä½œã€‚ æ‚¨<strong>æäº¤ç»™ Activity çš„<em>æ¯ç»„æ›´æ”¹éƒ½ç§°ä¸ºäº‹åŠ¡</em></strong>ï¼Œæ‚¨<strong>å¯ä»¥ä½¿ç”¨ <code>FragmentTransaction</code> ä¸­çš„ API æ¥æ‰§è¡Œä¸€é¡¹äº‹åŠ¡</strong>ã€‚æ‚¨ä¹Ÿå¯ä»¥å°†æ¯ä¸ªäº‹åŠ¡ä¿å­˜åˆ°ç”± Activity ç®¡ç†çš„è¿”å›æ ˆå†…ï¼Œä»è€Œè®©ç”¨æˆ·èƒ½å¤Ÿå›é€€ç‰‡æ®µæ›´æ”¹ï¼ˆç±»ä¼¼äºå›é€€ Activityï¼‰ã€‚</p>
<p>å¯ä»¥ä» <code>FragmentManager</code> è·å–ä¸€ä¸ª <code>FragmentTransaction</code> å®ä¾‹ã€‚</p>
<p><strong>æ¯ä¸ªäº‹åŠ¡</strong>ï¼ˆä»FragmentTransaction# begin åˆ° commit ä¹‹é—´çš„ä¸€ç»„ã€Œæ·»åŠ ï¼Œåˆ é™¤ï¼Œéšè—ï¼Œæ˜¾ç¤ºã€æ“ä½œï¼‰éƒ½æ˜¯æ‚¨æƒ³è¦åŒæ—¶æ‰§è¡Œçš„<strong>ä¸€ç»„æ›´æ”¹</strong>ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ <code>add()</code>ã€<code>remove()</code> å’Œ <code>replace()</code> ç­‰æ–¹æ³•ä¸ºç»™å®šäº‹åŠ¡è®¾ç½®æ‚¨æƒ³è¦æ‰§è¡Œçš„æ‰€æœ‰æ›´æ”¹ã€‚ç„¶åï¼Œè¦æƒ³å°†äº‹åŠ¡åº”ç”¨åˆ° Activityï¼Œæ‚¨å¿…é¡»è°ƒç”¨ <code>commit()</code>ã€‚</p>
<p>ä¸è¿‡ï¼Œåœ¨æ‚¨è°ƒç”¨ <code>commit()</code> ä¹‹å‰ï¼Œæ‚¨å¯èƒ½æƒ³<strong>è°ƒç”¨ <code>addToBackStack()</code>ï¼Œä»¥å°†äº‹åŠ¡æ·»åŠ åˆ°ç‰‡æ®µäº‹åŠ¡è¿”å›æ ˆ</strong>ã€‚ è¯¥è¿”å›æ ˆç”± Activity ç®¡ç†ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡æŒ‰<em>è¿”å›</em>æŒ‰é’®è¿”å›ä¸Šä¸€ç‰‡æ®µçŠ¶æ€ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ç¤ºä¾‹è¯´æ˜äº†å¦‚ä½•å°†ä¸€ä¸ªç‰‡æ®µæ›¿æ¢æˆå¦ä¸€ä¸ªç‰‡æ®µï¼Œä»¥åŠå¦‚ä½•åœ¨è¿”å›æ ˆä¸­ä¿ç•™å…ˆå‰çŠ¶æ€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create new fragment and transaction</span></div><div class="line">Fragment newFragment = <span class="keyword">new</span> ExampleFragment();</div><div class="line">FragmentTransaction transaction = getFragmentManager().beginTransaction();</div><div class="line"></div><div class="line"><span class="comment">// Replace whatever is in the fragment_container view with this fragment,</span></div><div class="line"><span class="comment">// and add the transaction to the back stack</span></div><div class="line">transaction.replace(R.id.fragment_container, newFragment);</div><div class="line">transaction.addToBackStack(<span class="keyword">null</span>);</div><div class="line"></div><div class="line"><span class="comment">// Commit the transaction</span></div><div class="line">transaction.commit();</div></pre></td></tr></table></figure>
<p>åœ¨ä¸Šä¾‹ä¸­ï¼Œ<code>newFragment</code> ä¼šæ›¿æ¢ç›®å‰åœ¨ <code>R.id.fragment_container</code> ID æ‰€æ ‡è¯†çš„å¸ƒå±€å®¹å™¨ä¸­çš„ä»»ä½•ç‰‡æ®µï¼ˆå¦‚æœ‰ï¼‰ã€‚é€šè¿‡<strong>è°ƒç”¨ <code>addToBackStack()</code> å¯å°†æ›¿æ¢äº‹åŠ¡ä¿å­˜åˆ°è¿”å›æ ˆ</strong>ï¼Œä»¥ä¾¿ç”¨æˆ·èƒ½å¤Ÿé€šè¿‡æŒ‰<em>è¿”å›</em>æŒ‰é’®æ’¤æ¶ˆäº‹åŠ¡å¹¶å›é€€åˆ°ä¸Šä¸€ç‰‡æ®µã€‚</p>
<ul>
<li>æ›¿æ¢äº‹åŠ¡ æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ</li>
</ul>
<p>å¦‚æœæ‚¨å‘äº‹åŠ¡æ·»åŠ äº†å¤šä¸ªæ›´æ”¹ï¼ˆå¦‚åˆä¸€ä¸ª <code>add()</code> æˆ– <code>remove()</code>ï¼‰ï¼Œå¹¶ä¸”è°ƒç”¨äº† <code>addToBackStack()</code>ï¼Œåˆ™åœ¨è°ƒç”¨ <code>commit()</code> å‰åº”ç”¨çš„<strong>æ‰€æœ‰æ›´æ”¹éƒ½å°†ä½œä¸ºå•ä¸€äº‹åŠ¡</strong>æ·»åŠ åˆ°è¿”å›æ ˆï¼Œå¹¶ä¸”<em>è¿”å›</em>æŒ‰é’®ä¼šå°†å®ƒä»¬ä¸€å¹¶æ’¤æ¶ˆã€‚</p>
<p>å‘ <code>FragmentTransaction</code> æ·»åŠ æ›´æ”¹çš„é¡ºåºæ— å…³ç´§è¦ï¼Œä¸è¿‡ï¼š</p>
<ul>
<li>æ‚¨å¿…é¡»æœ€åè°ƒç”¨ <code>commit()</code></li>
<li>å¦‚æœæ‚¨è¦å‘åŒä¸€å®¹å™¨æ·»åŠ å¤šä¸ªç‰‡æ®µï¼Œåˆ™æ‚¨æ·»åŠ ç‰‡æ®µçš„é¡ºåºå°†å†³å®šå®ƒä»¬åœ¨è§†å›¾å±‚æ¬¡ç»“æ„ä¸­çš„å‡ºç°é¡ºåº</li>
</ul>
<p>å¦‚æœæ‚¨<strong>æ²¡æœ‰åœ¨æ‰§è¡Œç§»é™¤ç‰‡æ®µçš„äº‹åŠ¡æ—¶è°ƒç”¨ <code>addToBackStack()</code>ï¼Œåˆ™äº‹åŠ¡æäº¤æ—¶è¯¥ç‰‡æ®µä¼šè¢«é”€æ¯</strong>ï¼Œç”¨æˆ·å°†æ— æ³•å›é€€åˆ°è¯¥ç‰‡æ®µã€‚ ä¸è¿‡ï¼Œå¦‚æœæ‚¨åœ¨åˆ é™¤ç‰‡æ®µæ—¶è°ƒç”¨äº† <code>addToBackStack()</code>ï¼Œåˆ™ç³»ç»Ÿä¼š<em>åœæ­¢</em>è¯¥ç‰‡æ®µï¼Œå¹¶åœ¨ç”¨æˆ·å›é€€æ—¶å°†å…¶æ¢å¤ã€‚</p>
<p><strong>æç¤º</strong>ï¼šå¯¹äºæ¯ä¸ªç‰‡æ®µäº‹åŠ¡ï¼Œæ‚¨éƒ½å¯ä»¥é€šè¿‡<strong>åœ¨æäº¤å‰è°ƒç”¨ <code>setTransition()</code> æ¥åº”ç”¨è¿‡æ¸¡åŠ¨ç”»</strong>ã€‚</p>
<p>è°ƒç”¨ <code>commit()</code> <strong>ä¸ä¼šç«‹å³æ‰§è¡Œäº‹åŠ¡</strong>ï¼Œè€Œæ˜¯åœ¨ Activity çš„ UI çº¿ç¨‹ï¼ˆâ€œä¸»â€çº¿ç¨‹ï¼‰å¯ä»¥æ‰§è¡Œè¯¥æ“ä½œæ—¶å†å®‰æ’å…¶åœ¨çº¿ç¨‹ä¸Šè¿è¡Œã€‚ä¸è¿‡ï¼Œå¦‚æœ‰å¿…è¦ï¼Œæ‚¨<strong>ä¹Ÿå¯ä»¥ä» UI çº¿ç¨‹è°ƒç”¨ <code>executePendingTransactions()</code> ä»¥ç«‹å³æ‰§è¡Œ <code>commit()</code> æäº¤çš„äº‹åŠ¡</strong>ã€‚é€šå¸¸ä¸å¿…è¿™æ ·åšï¼Œé™¤éå…¶ä»–çº¿ç¨‹ä¸­çš„ä½œä¸šä¾èµ–è¯¥äº‹åŠ¡ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šæ‚¨åªèƒ½åœ¨ Activity ä¿å­˜å…¶çŠ¶æ€ï¼ˆç”¨æˆ·ç¦»å¼€ Activityï¼‰ä¹‹å‰ä½¿ç”¨ <code>commit()</code> æäº¤äº‹åŠ¡ã€‚å¦‚æœæ‚¨è¯•å›¾åœ¨è¯¥æ—¶é—´ç‚¹åæäº¤ï¼Œåˆ™ä¼šå¼•å‘å¼‚å¸¸ã€‚ è¿™æ˜¯å› ä¸ºå¦‚éœ€æ¢å¤ Activityï¼Œåˆ™æäº¤åçš„çŠ¶æ€å¯èƒ½ä¼šä¸¢å¤±ã€‚ å¯¹äºä¸¢å¤±æäº¤æ— å…³ç´§è¦çš„æƒ…å†µï¼Œè¯·ä½¿ç”¨ <code>commitAllowingStateLoss()</code>ã€‚</p>
<h3 id="FragmentTransaction-commit-vs-FragmentTransaction-commitAllowingStateLoss"><a href="#FragmentTransaction-commit-vs-FragmentTransaction-commitAllowingStateLoss" class="headerlink" title="FragmentTransaction#commit vs  FragmentTransaction#commitAllowingStateLoss"></a>FragmentTransaction#commit vs  FragmentTransaction#commitAllowingStateLoss</h3><h3 id="å›é€€æ ˆ"><a href="#å›é€€æ ˆ" class="headerlink" title="å›é€€æ ˆ"></a>å›é€€æ ˆ</h3><p>FragmentTransaction æ˜¯åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­å­˜å‚¨äº†ä¸€æ¬¡äº‹åŠ¡ä¸­çš„æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Add this transaction to the back stack.  This means that the transaction</div><div class="line"> * will be remembered after it is committed, and will reverse its operation</div><div class="line"> * when later popped off the stack.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> name An optional name for this back stack state, or null.</div><div class="line"> */</div><div class="line"><span class="comment">//æ·»åŠ ã€Œäº‹åŠ¡ã€æ³¨æ„ä¸æ˜¯æŸä¸€ä¸ª Fragmentåˆ°å›é€€æ ˆä¸­ã€‚è¿™æ„å‘³ç€è¿™ä¸ªäº‹åŠ¡ä¼šåœ¨æäº¤åè¢«ã€Œè®°ä½ã€</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> FragmentTransaction <span class="title">addToBackStack</span><span class="params">(@Nullable String name)</span></span>;</div></pre></td></tr></table></figure>
<p>BackStackRecod æœ¬èº«è¿˜æ˜¯å®ç°äº† Runnabled æ¥å£ï¼Œæ˜¯ä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„å¯¹è±¡ã€‚æ·»åŠ å®Œæ¯•ä¹‹åï¼Œä¼šè°ƒç”¨ FragmentHostCallback ä¸­æä¾›çš„ getHandler æ–¹æ³•ï¼Œè·å–åˆ° Handler æ–¹æ³•ï¼Œç„¶åå‘ä¸»çº¿ç¨‹çš„ MessageQueue ä¸­å‘é€ä¸€ä¸ª mExecCommit å¯æ‰§è¡Œå¯¹è±¡</p>
<h3 id="å¤„ç†ç‰‡æ®µç”Ÿå‘½å‘¨æœŸ"><a href="#å¤„ç†ç‰‡æ®µç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="å¤„ç†ç‰‡æ®µç”Ÿå‘½å‘¨æœŸ"></a>å¤„ç†ç‰‡æ®µç”Ÿå‘½å‘¨æœŸ</h3><p><img src="http://androiddoc.qiniudn.com/images/fragment_lifecycle.png" alt="image"></p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fpze8kvyyuj309g0irdgj.jpg" alt="activity_fragment_lifecycle"></p>
<p>Activity ç”Ÿå‘½å‘¨æœŸä¸ç‰‡æ®µç”Ÿå‘½å‘¨æœŸä¹‹é—´çš„æœ€æ˜¾è‘—å·®å¼‚åœ¨äºå®ƒä»¬åœ¨å…¶<strong>å„è‡ªè¿”å›æ ˆä¸­çš„å­˜å‚¨æ–¹å¼</strong>ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒActivity åœæ­¢æ—¶ä¼šè¢«æ”¾å…¥<strong>ç”±<em>ç³»ç»Ÿç®¡ç†çš„ Activity è¿”å›æ ˆ</em></strong>ï¼ˆä»¥ä¾¿ç”¨æˆ·é€šè¿‡<em>è¿”å›</em>æŒ‰é’®å›é€€åˆ° Activityï¼Œ<a href="https://developer.android.com/guide/components/tasks-and-back-stack.html" target="_blank" rel="noopener">ä»»åŠ¡å’Œè¿”å›æ ˆ</a>å¯¹æ­¤åšäº†é˜è¿°ï¼‰ã€‚ä¸è¿‡ï¼Œ<strong>ä»…å½“åœ¨ç§»é™¤ç‰‡æ®µçš„äº‹åŠ¡æ‰§è¡ŒæœŸé—´é€šè¿‡è°ƒç”¨ <code>addToBackStack()</code> æ˜¾å¼è¯·æ±‚ä¿å­˜å®ä¾‹æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šå°†ç‰‡æ®µæ”¾å…¥ç”±<em>å®¿ä¸» Activity ç®¡ç†çš„è¿”å›æ ˆ</em></strong>ã€‚</p>
<p><strong>åœ¨å…¶ä»–æ–¹é¢ï¼Œç®¡ç†ç‰‡æ®µç”Ÿå‘½å‘¨æœŸä¸ç®¡ç† Activity ç”Ÿå‘½å‘¨æœŸéå¸¸ç›¸ä¼¼</strong>ã€‚ å› æ­¤ï¼Œ<a href="https://developer.android.com/guide/components/activities.html#Lifecycle" target="_blank" rel="noopener">ç®¡ç† Activity ç”Ÿå‘½å‘¨æœŸ</a>çš„åšæ³•åŒæ ·é€‚ç”¨äºç‰‡æ®µã€‚ </p>
<p><strong>æ³¨æ„</strong>ï¼šå¦‚æœéœ€è¦ Context çš„è¯ï¼Œå¯ä»¥è°ƒç”¨ <code>getActivity()</code>ã€‚ä½†è¦æ³¨æ„ï¼Œè¯·ä»…åœ¨ç‰‡æ®µé™„åŠ åˆ° Activity æ—¶è°ƒç”¨ <code>getActivity()</code>ã€‚å¦‚æœç‰‡æ®µå°šæœªé™„åŠ ï¼Œæˆ–åœ¨å…¶ç”Ÿå‘½å‘¨æœŸç»“æŸæœŸé—´åˆ†ç¦»ï¼Œåˆ™ <code>getActivity()</code> å°†è¿”å› nullã€‚</p>
<p>ä¸è¿‡ï¼Œç‰‡æ®µè¿˜æœ‰å‡ ä¸ªé¢å¤–çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œç”¨äºå¤„ç†ä¸ Activity çš„å”¯ä¸€äº¤äº’ï¼Œä»¥æ‰§è¡Œæ„å»ºå’Œé”€æ¯ç‰‡æ®µ UI ç­‰æ“ä½œã€‚ è¿™äº›<strong>é¢å¤–çš„å›è°ƒæ–¹æ³•</strong>æ˜¯ï¼š</p>
<ul>
<li><p><code>onAttach()</code></p>
<p>åœ¨ç‰‡æ®µå·²ä¸ Activity å…³è”æ—¶è°ƒç”¨ï¼ˆ<code>Activity</code> ä¼ é€’åˆ°æ­¤æ–¹æ³•å†…ï¼‰ã€‚</p>
</li>
<li><p><code>onCreateView()</code></p>
<p>è°ƒç”¨å®ƒå¯åˆ›å»ºä¸ç‰‡æ®µå…³è”çš„è§†å›¾å±‚æ¬¡ç»“æ„ã€‚</p>
</li>
<li><p><code>onActivityCreated()</code></p>
<p>åœ¨ Activity çš„ <code>onCreate()</code> æ–¹æ³•å·²è¿”å›æ—¶è°ƒç”¨ã€‚</p>
</li>
<li><p><code>onDestroyView()</code></p>
<p>åœ¨ç§»é™¤ä¸ç‰‡æ®µå…³è”çš„è§†å›¾å±‚æ¬¡ç»“æ„æ—¶è°ƒç”¨ã€‚</p>
</li>
<li><p><code>onDetach()</code></p>
<p>åœ¨<strong>å–æ¶ˆç‰‡æ®µä¸ Activity çš„å…³è”æ—¶</strong>è°ƒç”¨ã€‚</p>
</li>
</ul>
<p>ä¸€æ—¦ Activity è¾¾åˆ° resume çŠ¶æ€ï¼Œæ‚¨å°±å¯ä»¥éšæ„å‘ Activity æ·»åŠ ç‰‡æ®µå’Œç§»é™¤å…¶ä¸­çš„ç‰‡æ®µã€‚ å› æ­¤ï¼Œ<strong>åªæœ‰å½“ Activity å¤„äº resume çŠ¶æ€æ—¶ï¼Œç‰‡æ®µçš„ç”Ÿå‘½å‘¨æœŸæ‰èƒ½ç‹¬ç«‹å˜åŒ–</strong>ã€‚</p>
<p>Activity å¤„äºresume çŠ¶æ€ä¸‹æ—¶ï¼Œåˆ›å»ºä¸€ä¸ª Fragment ï¼Œè¿™ä¸ªFragment å‰é¢çš„ç”Ÿå‘½å‘¨æœŸä¼šå¿«é€Ÿèµ°å®Œï¼Œç›´åˆ° resume</p>
<p>ä¸è¿‡ï¼Œå½“ Activity ç¦»å¼€ resume çŠ¶æ€æ—¶ï¼Œç‰‡æ®µä¼šåœ¨ Activity çš„æ¨åŠ¨ä¸‹å†æ¬¡ç»å†å…¶ç”Ÿå‘½å‘¨æœŸã€‚</p>
<h2 id="ä¸-Activity-å¯¹æ¯”"><a href="#ä¸-Activity-å¯¹æ¯”" class="headerlink" title="ä¸ Activity å¯¹æ¯”"></a>ä¸ Activity å¯¹æ¯”</h2><h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><p>æ™®é€šå¼€å‘è€…æ— æƒä½¿ç”¨ Activity çš„æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œä¸èƒ½é€šè¿‡æ„é€ æ–¹æ³•ä»å¤–éƒ¨æ³¨å…¥ä¾èµ–ã€‚</p>
<p>Fragment çš„æ„é€ æ–¹æ³•å¯ä»¥ä¼ å‚è¿›æ¥</p>
<p>Activity ä¸€èˆ¬æ˜¯é€šè¿‡ intentã€‚Fragment ä¼šç”¨ setArgument ä¼ ä¸€ä¸ª Bundle è¿›æ¥ã€‚</p>
<h3 id="è®¾ç½®å¸ƒå±€-amp-åˆå§‹åŒ–æ§ä»¶çš„æ—¶æœºä¸åŒ"><a href="#è®¾ç½®å¸ƒå±€-amp-åˆå§‹åŒ–æ§ä»¶çš„æ—¶æœºä¸åŒ" class="headerlink" title="è®¾ç½®å¸ƒå±€&amp;åˆå§‹åŒ–æ§ä»¶çš„æ—¶æœºä¸åŒ"></a>è®¾ç½®å¸ƒå±€&amp;åˆå§‹åŒ–æ§ä»¶çš„æ—¶æœºä¸åŒ</h3><p><code>Activity#onCreate</code></p>
<p><code>Fragment#onCreateView</code></p>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><ul>
<li>æ³¨: FragmentManagerImpl å®šä¹‰åœ¨ FragmentManagerçš„ç±»æ–‡ä»¶é‡Œé¢ï¼Œç›´æ¥æœåªèƒ½çœ‹åˆ° .class,æ‰¾ä¸åˆ° .java æ–‡ä»¶</li>
</ul>
<p>èµ·å§‹ï¼šæŸ¥æ‰¾æŸä¸€ä¸ªç±»åªçœ‹åˆ° .classæ–‡ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆçœ‹çœ‹ .class ï¼Œå®ƒç»§æ‰¿/å®ç°äº†å“ªäº›ç±»ï¼Œç„¶ååˆ°çˆ¶ç±»é‚£é‡Œå»æ‰¾ï¼Œä¸€èˆ¬éƒ½å¯ä»¥æ‰¾åˆ°</p>
<p>æˆ‘ä»¬å¸¸çœ‹åˆ°è¯´ Fragment çš„ç”Ÿå‘½å‘¨æœŸä¼šä¸å®¿ä¸»Activity ä¿æŒä¸€è‡´ï¼Œé‡Œé¢ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p>
<p>Fragment çš„ç”Ÿå‘½å‘¨æœŸä¼šåœ¨ FragmentActivity é‡Œé¢çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œå›è°ƒ</p>
<h3 id="ç”Ÿå‘½å‘¨æœŸ"><a href="#ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h3><p>å› ä¸º Fragment ä¾é™„äº Activityï¼ˆç”Ÿå‘½å‘¨æœŸçŠ¶æ€ç”± Activity æ§åˆ¶ï¼‰ï¼Œæ‰€ä»¥Fragment çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ˜¯åœ¨ Activity çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¹‹åæ‰è°ƒç”¨çš„ã€‚</p>
<p>android.app.FragmentManagerImpl#onCreateView()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(View parent, String name, Context context, AttributeSet attrs)</span> </span>&#123;    </div><div class="line">    <span class="comment">//â€¦â€¦</span></div><div class="line">    </div><div class="line">    <span class="comment">// If we haven't finished entering the CREATED state ourselves yet,</span></div><div class="line">    <span class="comment">// push the inflated child fragment along. This will ensureInflatedFragmentView</span></div><div class="line">    <span class="comment">// at the right phase of the lifecycle so that we will have mView populated</span></div><div class="line">    <span class="comment">// for compliant fragments below.</span></div><div class="line">    <span class="keyword">if</span> (mCurState &lt; Fragment.CREATED &amp;&amp; fragment.mFromLayout) &#123;</div><div class="line">        moveToState(fragment, Fragment.CREATED, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">false</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        moveToState(fragment);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//â€¦â€¦</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æäº¤äº‹åŠ¡"><a href="#æäº¤äº‹åŠ¡" class="headerlink" title="æäº¤äº‹åŠ¡"></a>æäº¤äº‹åŠ¡</h3><h4 id="add-hide-show-replace"><a href="#add-hide-show-replace" class="headerlink" title="add hide show replace"></a>add hide show replace</h4><p>å½“ç„¶æˆ‘ä»¬æ³¨æ„åˆ° hide å’Œ showï¼Œå®ƒä»¬å†…éƒ¨å®é™…ä¸Šä¸ä¼šè°ƒç”¨ moveToState, å› ä¸º <strong>hideFragment å®é™…ä¸Šå°±åšäº†ä¸‰ä»¶äº‹è¯·</strong>ï¼Œ</p>
<ul>
<li>è®¾ç½® mHidden ä¸º true</li>
<li>fragment.mView.setVisibility(View.GONE); éšè— fragment çš„ view</li>
<li>fragment.onHiddenChanged(true); è°ƒç”¨ onHiddenChange</li>
</ul>
<p>showFragment ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œåªä¸è¿‡è¡Œä¸ºæ­£å¥½ç›¸åã€‚</p>
<h4 id="addFragment"><a href="#addFragment" class="headerlink" title="addFragment"></a>addFragment</h4><p>addFragment ä¼šå°† fragment æ·»åŠ åˆ° mAdded å’Œ mActive è¿™ä¸¤ä¸ªé›†åˆå½“ä¸­ï¼Œè¿™ä¸¤ä¸ªé›†åˆç»´æŠ¤äº†å½“å‰ activity ä¸­ç»´æŠ¤çš„å·²ç»æ·»åŠ çš„ fragment åˆ—è¡¨å’Œå½“å‰å¤„äºæ´»è·ƒçŠ¶æ€çš„ fragment åˆ—è¡¨ï¼Œå¦‚æœ fragment ä½äº mActive ä¸­ï¼Œé‚£ä¹ˆå½“ activity çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œfragment ä¹Ÿä¼šè·Ÿéšç€å‘ç”Ÿå˜åŒ–ã€‚FragmentManger å¦‚ä½•å¼•å¯¼ fragment çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–å‘¢ï¼Ÿ</p>
<h4 id="Fragment-çŠ¶æ€å˜è¿ï¼šmoveToState"><a href="#Fragment-çŠ¶æ€å˜è¿ï¼šmoveToState" class="headerlink" title="Fragment çŠ¶æ€å˜è¿ï¼šmoveToState"></a>Fragment çŠ¶æ€å˜è¿ï¼šmoveToState</h4><p>Fragment çŠ¶æ€å˜è¿å‘ç”Ÿåœ¨ç”¨æˆ·ä¸»åŠ¨å‘èµ· transactionï¼Œæˆ–è€… fragment è¢« add åˆ° activity ä¹‹åè·Ÿéš activity çš„ç”Ÿå‘½å‘¨æœŸå˜åŒ–ä¸€èµ·å‘ç”Ÿæ”¹å˜ã€‚æ¯æ¬¡çŠ¶æ€å˜è¿æœ€ç»ˆéƒ½ä¼šèµ°åˆ°å‡½æ•° moveToStateï¼Œå­—é¢æ„æ€æ˜¯å°† fragment è¿ç§»åˆ°æ–°çš„çŠ¶æ€</p>
<p>fragment çš„ state å–å€¼ï¼Œä¸ºå‰é¢æåˆ°çš„ä¸ƒç§çŠ¶æ€ï¼Œå…¶ä¸­æœ€ä½å€¼æ˜¯ INITIALIZING çŠ¶æ€ï¼Œä»£è¡¨ fragment <strong>åˆšåˆ›å»ºï¼Œè¿˜æœªè¢« add</strong>ï¼Œ æœ€é«˜çŠ¶æ€å€¼æ˜¯ RESUMED, ä»£è¡¨ fragment å¤„äºå‰å°ã€‚ æ‰€ä»¥ moveToState å†…éƒ¨åˆ†ä¸¤æ¡çº¿ï¼ŒçŠ¶æ€è·ƒå‡ï¼Œå’ŒçŠ¶æ€é™ä½ï¼Œé‡Œé¢å„æœ‰ä¸€ä¸ª switch åˆ¤æ–­ï¼Œæ³¨æ„åˆ° <strong>switch é‡Œæ¯ä¸ª case éƒ½æ²¡æœ‰ breakï¼Œè¿™æ„å‘³ç€ï¼ŒçŠ¶æ€å¯ä»¥æŒç»­å˜è¿</strong>ï¼Œæ¯”å¦‚ä» INITIALIZINGï¼Œä¸€ç›´è·ƒå‡åˆ° RESUMEDï¼Œå°†æ¯ä¸ª case éƒ½èµ°ä¸€éï¼Œæ¯æ¬¡ case è¯­å¥å†…ï¼Œéƒ½ä¼šæ”¹å˜ state çš„å€¼ã€‚</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1008428-c0809de4a37a0d74.jpg" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mManager.moveToState(mManager.mCurState, transition, transitionStyle, true);</div></pre></td></tr></table></figure>
<p>å°±æ˜¯å°† fragment è¿ç§»åˆ° FragmentManager å½“å‰çš„çŠ¶æ€ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“ç”¨æˆ·ä»€ä¹ˆæ—¶å€™ add fragmentï¼Œå› æ­¤ fragment è¢« add ä¹‹åï¼Œå°±å°†å…¶çŠ¶æ€è¿ç§»åˆ° FragmentManager å½“å‰çš„çŠ¶æ€ï¼Œç„¶åè·Ÿéš FragmentManager ä¸€èµ·å‘ç”ŸçŠ¶æ€å˜è¿ï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨ removeFragment å°†å…¶ä» mActive åˆ—è¡¨ä¸­ç§»é™¤ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">getSupportFragmentManager()</div><div class="line">                        .beginTransaction()</div><div class="line">                        .add(,)</div><div class="line">                        .commit();</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">FragmentManagerImpl#beginTransaction //åˆ›å»ºä¸€ä¸ª  BackStackRecord;</div><div class="line">	--&gt; BackStackRecord#add(Fragment, String)</div><div class="line">		--&gt; BackStackRecord#doAddOp</div><div class="line">			--&gt; //è¿›è¡Œè®¿é—®æ§åˆ¶æ£€æŸ¥ï¼Œå¦‚æœ Fragment æ˜¯ä¸€ä¸ªæˆå‘˜ç±»ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»æ˜¯ public static çš„ï¼Œè¿™æ ·æ‰èƒ½æ­£ç¡®åœ°ä»å®ä¾‹çŠ¶æ€ä¸­é‡æ–°åˆ›å»ºå‡ºæ¥</div><div class="line">				ç»™ mFragmentManagerã€ mTag ã€mContainerId  èµ‹å€¼</div><div class="line">				åˆ›å»º Op å¯¹è±¡å¹¶æ·»åŠ åˆ° Ops ï¼ˆä¸€ä¸ª ArrayListï¼‰ ä¸­ 				</div><div class="line">			--&gt; BackStackRecord#commit</div><div class="line">			--&gt; BackStackRecord#commitInternal</div><div class="line">				if mAddToBackStack //æ·»åŠ åˆ°å›é€€æ ˆä¸­</div><div class="line">                      mIndex = mManager.allocBackStackIndex(this);//åˆ†é…å›é€€æ ˆä¸‹æ ‡</div><div class="line">						--&gt; ä¸»è¦å¯¹ä¸‹é¢ä¸¤ä¸ªåˆ—è¡¨è¿›è¡Œæ“ä½œ</div><div class="line">						ArrayList&lt;BackStackRecord&gt; mBackStackIndices;</div><div class="line">    					ArrayList&lt;Integer&gt; mAvailBackStackIndices;</div><div class="line">                  else </div><div class="line">                      mIndex = -1;</div><div class="line">                  </div><div class="line">					--&gt; FragmentManagerImpl#enqueueAction//åœ¨ç­‰å¾…æ“ä½œçš„é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªæ“ä½œã€‚</div><div class="line">                      	--&gt;  mPendingActions.add(action);//æ·»åŠ åˆ°ã€Œé˜Ÿåˆ—ä¸­ã€ ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ª ArrayListï¼‰</div><div class="line">            		    --&gt; scheduleCommit();//å®‰æ’ commit</div><div class="line">							--&gt; å†…éƒ¨é€šè¿‡ Handler æ¥å®ç°</div><div class="line">								æ‰§è¡Œçš„æ˜¯ mExecCommit ï¼ˆä¸€ä¸ª Runnableï¼‰</div><div class="line">								--&gt; FragmentManagerImpl#execPendingActions</div></pre></td></tr></table></figure>
<p>FragmentManagerImpl#execPendingActions //åªèƒ½ä»ä¸»çº¿ç¨‹è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execPendingActions</span><span class="params">()</span> </span>&#123;</div><div class="line">    ensureExecReady(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">while</span> (generateOpsForPendingActions(mTmpRecords, mTmpIsPop)) &#123;</div><div class="line">        mExecutingActions = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            optimizeAndExecuteOps(mTmpRecords, mTmpIsPop);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            cleanupExec();</div><div class="line">        &#125;</div><div class="line">        didSomething = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    doPendingDeferredStart();</div><div class="line">    burpActive();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> didSomething;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å›è°ƒ"><a href="#ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å›è°ƒ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å›è°ƒ"></a>ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å›è°ƒ</h3><p>Fragment çš„å„ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•å›è°ƒéƒ½æ˜¯é€šè¿‡fragment.app.FragmentManagerImpl#moveToState æ–¹æ³•åˆ†å‘å‡ºæ¥çš„ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"ReferenceEquality"</span>)</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(Fragment f, <span class="keyword">int</span> newState, <span class="keyword">int</span> transit, <span class="keyword">int</span> transitionStyle,</span></span></div><div class="line">        <span class="keyword">boolean</span> keepActive) &#123;</div><div class="line">    <span class="comment">// Fragments that are not currently added will sit in the onCreate() state.</span></div><div class="line">    <span class="keyword">if</span> ((!f.mAdded || f.mDetached) &amp;&amp; newState &gt; Fragment.CREATED) &#123;</div><div class="line">        newState = Fragment.CREATED;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (f.mRemoving &amp;&amp; newState &gt; f.mState) &#123;</div><div class="line">        <span class="keyword">if</span> (f.mState == Fragment.INITIALIZING &amp;&amp; f.isInBackStack()) &#123;</div><div class="line">            <span class="comment">// Allow the fragment to be created so that it can be saved later.</span></div><div class="line">            newState = Fragment.CREATED;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// While removing a fragment, we can't change it to a higher state.</span></div><div class="line">            newState = f.mState;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Defer start if requested; don't allow it to move to STARTED or higher</span></div><div class="line">    <span class="comment">// if it's not already started.</span></div><div class="line">    <span class="keyword">if</span> (f.mDeferStart &amp;&amp; f.mState &lt; Fragment.STARTED &amp;&amp; newState &gt; Fragment.ACTIVITY_CREATED) &#123;</div><div class="line">        newState = Fragment.ACTIVITY_CREATED;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (f.mState &lt;= newState) &#123;</div><div class="line">        <span class="comment">// For fragments that are created from a layout, when restoring from</span></div><div class="line">        <span class="comment">// state we don't want to allow them to be created until they are</span></div><div class="line">        <span class="comment">// being reloaded from the layout.</span></div><div class="line">        <span class="keyword">if</span> (f.mFromLayout &amp;&amp; !f.mInLayout) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (f.getAnimatingAway() != <span class="keyword">null</span> || f.getAnimator() != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// The fragment is currently being animated...  but!  Now we</span></div><div class="line">            <span class="comment">// want to move our state back up.  Give up on waiting for the</span></div><div class="line">            <span class="comment">// animation, move to whatever the final state should be once</span></div><div class="line">            <span class="comment">// the animation is done, and then we can proceed from there.</span></div><div class="line">            f.setAnimatingAway(<span class="keyword">null</span>);</div><div class="line">            f.setAnimator(<span class="keyword">null</span>);</div><div class="line">            moveToState(f, f.getStateAfterAnimating(), <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">switch</span> (f.mState) &#123;</div><div class="line">            <span class="keyword">case</span> Fragment.INITIALIZING:</div><div class="line">	            	<span class="comment">//æ–°çŠ¶æ€å¤§äº åˆå§‹åŒ–çŠ¶æ€</span></div><div class="line">                <span class="keyword">if</span> (newState &gt; Fragment.INITIALIZING) &#123;</div><div class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"moveto CREATED: "</span> + f);</div><div class="line">                    <span class="keyword">if</span> (f.mSavedFragmentState != <span class="keyword">null</span>) &#123;</div><div class="line">                        f.mSavedFragmentState.setClassLoader(mHost.getContext()</div><div class="line">                                .getClassLoader());</div><div class="line">                        f.mSavedViewState = f.mSavedFragmentState.getSparseParcelableArray(</div><div class="line">                                FragmentManagerImpl.VIEW_STATE_TAG);</div><div class="line">                        f.mTarget = getFragment(f.mSavedFragmentState,</div><div class="line">                                FragmentManagerImpl.TARGET_STATE_TAG);</div><div class="line">                        <span class="keyword">if</span> (f.mTarget != <span class="keyword">null</span>) &#123;</div><div class="line">                            f.mTargetRequestCode = f.mSavedFragmentState.getInt(</div><div class="line">                                    FragmentManagerImpl.TARGET_REQUEST_CODE_STATE_TAG, <span class="number">0</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (f.mSavedUserVisibleHint != <span class="keyword">null</span>) &#123;</div><div class="line">                            f.mUserVisibleHint = f.mSavedUserVisibleHint;</div><div class="line">                            f.mSavedUserVisibleHint = <span class="keyword">null</span>;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            f.mUserVisibleHint = f.mSavedFragmentState.getBoolean(</div><div class="line">                                    FragmentManagerImpl.USER_VISIBLE_HINT_TAG, <span class="keyword">true</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (!f.mUserVisibleHint) &#123;</div><div class="line">                            f.mDeferStart = <span class="keyword">true</span>;</div><div class="line">                            <span class="keyword">if</span> (newState &gt; Fragment.ACTIVITY_CREATED) &#123;</div><div class="line">                                newState = Fragment.ACTIVITY_CREATED;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    f.mHost = mHost;</div><div class="line">                    f.mParentFragment = mParent;</div><div class="line">                    f.mFragmentManager = mParent != <span class="keyword">null</span></div><div class="line">                            ? mParent.mChildFragmentManager : mHost.getFragmentManagerImpl();</div><div class="line"></div><div class="line">                    <span class="comment">// If we have a target fragment, push it along to at least CREATED</span></div><div class="line">                    <span class="comment">// so that this one can rely on it as an initialized dependency.</span></div><div class="line">                    <span class="keyword">if</span> (f.mTarget != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (mActive.get(f.mTarget.mIndex) != f.mTarget) &#123;</div><div class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fragment "</span> + f</div><div class="line">                                    + <span class="string">" declared target fragment "</span> + f.mTarget</div><div class="line">                                    + <span class="string">" that does not belong to this FragmentManager!"</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (f.mTarget.mState &lt; Fragment.CREATED) &#123;</div><div class="line">                            moveToState(f.mTarget, Fragment.CREATED, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    dispatchOnFragmentPreAttached(f, mHost.getContext(), <span class="keyword">false</span>);</div><div class="line">                    f.mCalled = <span class="keyword">false</span>;</div><div class="line">                  	<span class="comment">//å›è°ƒ onAttach æ–¹æ³•</span></div><div class="line">                    f.onAttach(mHost.getContext());</div><div class="line">                    <span class="keyword">if</span> (!f.mCalled) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(<span class="string">"Fragment "</span> + f</div><div class="line">                                + <span class="string">" did not call through to super.onAttach()"</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (f.mParentFragment == <span class="keyword">null</span>) &#123;</div><div class="line">                        mHost.onAttachFragment(f);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        f.mParentFragment.onAttachFragment(f);</div><div class="line">                    &#125;</div><div class="line">	                  <span class="comment">//</span></div><div class="line">                    dispatchOnFragmentAttached(f, mHost.getContext(), <span class="keyword">false</span>);</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (!f.mIsCreated) &#123;</div><div class="line">                        dispatchOnFragmentPreCreated(f, f.mSavedFragmentState, <span class="keyword">false</span>);</div><div class="line">                      	<span class="comment">//å›è°ƒ Fragment#onCreate</span></div><div class="line">                        f.performCreate(f.mSavedFragmentState);</div><div class="line">                        dispatchOnFragmentCreated(f, f.mSavedFragmentState, <span class="keyword">false</span>);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">	                      <span class="comment">//æ¢å¤çŠ¶æ€</span></div><div class="line">                        f.restoreChildFragmentState(f.mSavedFragmentState);</div><div class="line">                        f.mState = Fragment.CREATED;</div><div class="line">                    &#125;</div><div class="line">                    f.mRetaining = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// fall through</span></div><div class="line">            <span class="keyword">case</span> Fragment.CREATED:</div><div class="line">                <span class="comment">// This is outside the if statement below on purpose; we want this to run</span></div><div class="line">                <span class="comment">// even if we do a moveToState from CREATED =&gt; *, CREATED =&gt; CREATED, and</span></div><div class="line">                <span class="comment">// * =&gt; CREATED as part of the case fallthrough above.</span></div><div class="line">                ensureInflatedFragmentView(f);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (newState &gt; Fragment.CREATED) &#123;</div><div class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"moveto ACTIVITY_CREATED: "</span> + f);</div><div class="line">                    <span class="keyword">if</span> (!f.mFromLayout) &#123;</div><div class="line">                        ViewGroup container = <span class="keyword">null</span>;</div><div class="line">                        <span class="keyword">if</span> (f.mContainerId != <span class="number">0</span>) &#123;</div><div class="line">                            <span class="keyword">if</span> (f.mContainerId == View.NO_ID) &#123;</div><div class="line">                                throwException(<span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                                        <span class="string">"Cannot create fragment "</span></div><div class="line">                                                + f</div><div class="line">                                                + <span class="string">" for a container view with no id"</span>));</div><div class="line">                            &#125;</div><div class="line">                          	<span class="comment">//æŸ¥æ‰¾ container å®ä¾‹</span></div><div class="line">                            container = (ViewGroup) mContainer.onFindViewById(f.mContainerId);</div><div class="line">                            <span class="keyword">if</span> (container == <span class="keyword">null</span> &amp;&amp; !f.mRestored) &#123;</div><div class="line">                                String resName;</div><div class="line">                                <span class="keyword">try</span> &#123;</div><div class="line">                                    resName = f.getResources().getResourceName(f.mContainerId);</div><div class="line">                                &#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</div><div class="line">                                    resName = <span class="string">"unknown"</span>;</div><div class="line">                                &#125;</div><div class="line">                                throwException(<span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                                        <span class="string">"No view found for id 0x"</span></div><div class="line">                                        + Integer.toHexString(f.mContainerId) + <span class="string">" ("</span></div><div class="line">                                        + resName</div><div class="line">                                        + <span class="string">") for fragment "</span> + f));</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        f.mContainer = container;</div><div class="line">                      	<span class="comment">//å›è°ƒ onCreateViewï¼ŒåŒæ—¶ä¸º Fragment#mView æˆå‘˜å˜é‡èµ‹å€¼</span></div><div class="line">                        f.performCreateView(f.performGetLayoutInflater(</div><div class="line">                                f.mSavedFragmentState), container, f.mSavedFragmentState);</div><div class="line">                        <span class="keyword">if</span> (f.mView != <span class="keyword">null</span>) &#123;</div><div class="line">                            f.mInnerView = f.mView;</div><div class="line">                            f.mView.setSaveFromParentEnabled(<span class="keyword">false</span>);</div><div class="line">                            <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</div><div class="line">                                container.addView(f.mView);</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">if</span> (f.mHidden) &#123;</div><div class="line">                                f.mView.setVisibility(View.GONE);</div><div class="line">                            &#125;</div><div class="line">                          	<span class="comment">//å›è°ƒ fragment#onViewCreated</span></div><div class="line">                            f.onViewCreated(f.mView, f.mSavedFragmentState);</div><div class="line">                            dispatchOnFragmentViewCreated(f, f.mView, f.mSavedFragmentState,</div><div class="line">                                    <span class="keyword">false</span>);</div><div class="line">                            <span class="comment">// Only animate the view if it is visible. This is done after</span></div><div class="line">                            <span class="comment">// dispatchOnFragmentViewCreated in case visibility is changed</span></div><div class="line">                            f.mIsNewlyAdded = (f.mView.getVisibility() == View.VISIBLE)</div><div class="line">                                    &amp;&amp; f.mContainer != <span class="keyword">null</span>;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            f.mInnerView = <span class="keyword">null</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    f.performActivityCreated(f.mSavedFragmentState);</div><div class="line">                    dispatchOnFragmentActivityCreated(f, f.mSavedFragmentState, <span class="keyword">false</span>);</div><div class="line">                    <span class="keyword">if</span> (f.mView != <span class="keyword">null</span>) &#123;</div><div class="line">                        f.restoreViewState(f.mSavedFragmentState);</div><div class="line">                    &#125;</div><div class="line">                    f.mSavedFragmentState = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// fall through</span></div><div class="line">            <span class="keyword">case</span> Fragment.ACTIVITY_CREATED:</div><div class="line">                <span class="keyword">if</span> (newState &gt; Fragment.ACTIVITY_CREATED) &#123;</div><div class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"moveto STARTED: "</span> + f);</div><div class="line">                    f.performStart();</div><div class="line">                    dispatchOnFragmentStarted(f, <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// fall through</span></div><div class="line">            <span class="keyword">case</span> Fragment.STARTED:</div><div class="line">                <span class="keyword">if</span> (newState &gt; Fragment.STARTED) &#123;</div><div class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"moveto RESUMED: "</span> + f);</div><div class="line">                    f.performResume();</div><div class="line">                    dispatchOnFragmentResumed(f, <span class="keyword">false</span>);</div><div class="line">                    f.mSavedFragmentState = <span class="keyword">null</span>;</div><div class="line">                    f.mSavedViewState = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.mState &gt; newState) &#123;</div><div class="line">        <span class="keyword">switch</span> (f.mState) &#123;</div><div class="line">            <span class="keyword">case</span> Fragment.RESUMED:</div><div class="line">                <span class="keyword">if</span> (newState &lt; Fragment.RESUMED) &#123;</div><div class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"movefrom RESUMED: "</span> + f);</div><div class="line">                    f.performPause();</div><div class="line">                    dispatchOnFragmentPaused(f, <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// fall through</span></div><div class="line">            <span class="keyword">case</span> Fragment.STARTED:</div><div class="line">                <span class="keyword">if</span> (newState &lt; Fragment.STARTED) &#123;</div><div class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"movefrom STARTED: "</span> + f);</div><div class="line">                    f.performStop();</div><div class="line">                    dispatchOnFragmentStopped(f, <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// fall through</span></div><div class="line">            <span class="keyword">case</span> Fragment.ACTIVITY_CREATED:</div><div class="line">                <span class="keyword">if</span> (newState &lt; Fragment.ACTIVITY_CREATED) &#123;</div><div class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"movefrom ACTIVITY_CREATED: "</span> + f);</div><div class="line">                    <span class="keyword">if</span> (f.mView != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// Need to save the current view state if not</span></div><div class="line">                        <span class="comment">// done already.</span></div><div class="line">                        <span class="keyword">if</span> (mHost.onShouldSaveFragmentState(f) &amp;&amp; f.mSavedViewState == <span class="keyword">null</span>) &#123;</div><div class="line">                            saveFragmentViewState(f);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    f.performDestroyView();</div><div class="line">                    dispatchOnFragmentViewDestroyed(f, <span class="keyword">false</span>);</div><div class="line">                    <span class="keyword">if</span> (f.mView != <span class="keyword">null</span> &amp;&amp; f.mContainer != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// Stop any current animations:</span></div><div class="line">                        f.mContainer.endViewTransition(f.mView);</div><div class="line">                        f.mView.clearAnimation();</div><div class="line">                        AnimationOrAnimator anim = <span class="keyword">null</span>;</div><div class="line">                        <span class="keyword">if</span> (mCurState &gt; Fragment.INITIALIZING &amp;&amp; !mDestroyed</div><div class="line">                                &amp;&amp; f.mView.getVisibility() == View.VISIBLE</div><div class="line">                                &amp;&amp; f.mPostponedAlpha &gt;= <span class="number">0</span>) &#123;</div><div class="line">                            anim = loadAnimation(f, transit, <span class="keyword">false</span>,</div><div class="line">                                    transitionStyle);</div><div class="line">                        &#125;</div><div class="line">                        f.mPostponedAlpha = <span class="number">0</span>;</div><div class="line">                        <span class="keyword">if</span> (anim != <span class="keyword">null</span>) &#123;</div><div class="line">                            animateRemoveFragment(f, anim, newState);</div><div class="line">                        &#125;</div><div class="line">                        f.mContainer.removeView(f.mView);</div><div class="line">                    &#125;</div><div class="line">                    f.mContainer = <span class="keyword">null</span>;</div><div class="line">                    f.mView = <span class="keyword">null</span>;</div><div class="line">                    <span class="comment">// Set here to ensure that Observers are called after</span></div><div class="line">                    <span class="comment">// the Fragment's view is set to null</span></div><div class="line">                    f.mViewLifecycleOwner = <span class="keyword">null</span>;</div><div class="line">                    f.mViewLifecycleOwnerLiveData.setValue(<span class="keyword">null</span>);</div><div class="line">                    f.mInnerView = <span class="keyword">null</span>;</div><div class="line">                    f.mInLayout = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// fall through</span></div><div class="line">            <span class="keyword">case</span> Fragment.CREATED:</div><div class="line">                <span class="keyword">if</span> (newState &lt; Fragment.CREATED) &#123;</div><div class="line">                    <span class="keyword">if</span> (mDestroyed) &#123;</div><div class="line">                        <span class="comment">// The fragment's containing activity is</span></div><div class="line">                        <span class="comment">// being destroyed, but this fragment is</span></div><div class="line">                        <span class="comment">// currently animating away.  Stop the</span></div><div class="line">                        <span class="comment">// animation right now -- it is not needed,</span></div><div class="line">                        <span class="comment">// and we can't wait any more on destroying</span></div><div class="line">                        <span class="comment">// the fragment.</span></div><div class="line">                        <span class="keyword">if</span> (f.getAnimatingAway() != <span class="keyword">null</span>) &#123;</div><div class="line">                            View v = f.getAnimatingAway();</div><div class="line">                            f.setAnimatingAway(<span class="keyword">null</span>);</div><div class="line">                            v.clearAnimation();</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getAnimator() != <span class="keyword">null</span>) &#123;</div><div class="line">                            Animator animator = f.getAnimator();</div><div class="line">                            f.setAnimator(<span class="keyword">null</span>);</div><div class="line">                            animator.cancel();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (f.getAnimatingAway() != <span class="keyword">null</span> || f.getAnimator() != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// We are waiting for the fragment's view to finish</span></div><div class="line">                        <span class="comment">// animating away.  Just make a note of the state</span></div><div class="line">                        <span class="comment">// the fragment now should move to once the animation</span></div><div class="line">                        <span class="comment">// is done.</span></div><div class="line">                        f.setStateAfterAnimating(newState);</div><div class="line">                        newState = Fragment.CREATED;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"movefrom CREATED: "</span> + f);</div><div class="line">                        <span class="keyword">if</span> (!f.mRetaining) &#123;</div><div class="line">                            f.performDestroy();</div><div class="line">                            dispatchOnFragmentDestroyed(f, <span class="keyword">false</span>);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            f.mState = Fragment.INITIALIZING;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        f.performDetach();</div><div class="line">                        dispatchOnFragmentDetached(f, <span class="keyword">false</span>);</div><div class="line">                        <span class="keyword">if</span> (!keepActive) &#123;</div><div class="line">                            <span class="keyword">if</span> (!f.mRetaining) &#123;</div><div class="line">                                makeInactive(f);</div><div class="line">                            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                f.mHost = <span class="keyword">null</span>;</div><div class="line">                                f.mParentFragment = <span class="keyword">null</span>;</div><div class="line">                                f.mFragmentManager = <span class="keyword">null</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (f.mState != newState) &#123;</div><div class="line">        Log.w(TAG, <span class="string">"moveToState: Fragment state for "</span> + f + <span class="string">" not updated inline; "</span></div><div class="line">                + <span class="string">"expected state "</span> + newState + <span class="string">" found "</span> + f.mState);</div><div class="line">        f.mState = newState;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="getChildFragmentManager"><a href="#getChildFragmentManager" class="headerlink" title="getChildFragmentManager"></a>getChildFragmentManager</h3><p>mChildFragmentManager çš„å®é™…ç±»å‹ä¹Ÿæ˜¯ä¸€ä¸ª FragmentManager ï¼Œ</p>
<p>attachController çš„æ—¶å€™ï¼Œä¼šå°† å½“å‰ Fragment ä¼ é€’ç»™ parent å‚æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public void attachController(FragmentHostCallback host,</div><div class="line">        FragmentContainer container, Fragment parent) &#123;</div><div class="line">    if (mHost != null) throw new IllegalStateException(&quot;Already attached&quot;);</div><div class="line">    mHost = host;</div><div class="line">    mContainer = container;</div><div class="line">    mParent = parent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><p><a href="https://www.jianshu.com/p/180d2cc0feb5" target="_blank" rel="noopener">https://www.jianshu.com/p/180d2cc0feb5</a></p>
</li>
<li><p><a href="https://developer.android.com/reference/android/app/Fragment" target="_blank" rel="noopener">Fragment | Android Developers</a></p>
</li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> Android </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Http å¤´éƒ¨å­—æ®µ]]></title>
      <url>https://timlin-pro.github.io/blog/2018/03/02/Http-%E5%A4%B4%E9%83%A8%E5%AD%97%E6%AE%B5/</url>
      <content type="html"><![CDATA[<h2 id="HTTP-æŠ¥æ–‡æ ¼å¼"><a href="#HTTP-æŠ¥æ–‡æ ¼å¼" class="headerlink" title="HTTP æŠ¥æ–‡æ ¼å¼"></a>HTTP æŠ¥æ–‡æ ¼å¼</h2><p><img src="https://user-images.githubusercontent.com/16668676/44859151-2465cc80-aca6-11e8-9374-e7af115b58b1.png" alt="image"></p>
<h3 id="HTTP-è¯·æ±‚æŠ¥æ–‡"><a href="#HTTP-è¯·æ±‚æŠ¥æ–‡" class="headerlink" title="HTTP è¯·æ±‚æŠ¥æ–‡"></a>HTTP è¯·æ±‚æŠ¥æ–‡</h3><p>åœ¨è¯·æ±‚ä¸­ï¼ŒHTTP æŠ¥æ–‡ç”±<strong>æ–¹æ³•ã€URIã€HTTP ç‰ˆæœ¬ã€HTTP é¦–éƒ¨å­—æ®µ</strong>ç­‰éƒ¨åˆ†æ„æˆã€‚</p>
<p>ä½¿ç”¨é¦–éƒ¨å­—æ®µæ˜¯ä¸ºäº†ç»™æµè§ˆå™¨å’ŒæœåŠ¡å™¨æä¾›æŠ¥æ–‡ä¸»ä½“å¤§å°ã€æ‰€ä½¿ç”¨çš„è¯­è¨€ã€è®¤è¯ä¿¡æ¯ç­‰å†…å®¹ã€‚</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fqj12dx3guj30wy0acq7h.jpg" alt=""></p>
<h3 id="HTTP-å“åº”æŠ¥æ–‡"><a href="#HTTP-å“åº”æŠ¥æ–‡" class="headerlink" title="HTTP å“åº”æŠ¥æ–‡"></a>HTTP å“åº”æŠ¥æ–‡</h3><p>åœ¨å“åº”ä¸­ï¼ŒHTTP æŠ¥æ–‡ç”± HTTP ç‰ˆæœ¬ã€çŠ¶æ€ç ï¼ˆæ•°å­—å’ŒåŸå› çŸ­è¯­ï¼‰ã€<br>HTTP é¦–éƒ¨å­—æ®µ 3 éƒ¨åˆ†æ„æˆã€‚</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fqj174ztg9j30ws08wgq2.jpg" alt=""></p>
<h2 id="HTTP-é¦–éƒ¨å­—æ®µ"><a href="#HTTP-é¦–éƒ¨å­—æ®µ" class="headerlink" title="HTTP é¦–éƒ¨å­—æ®µ"></a>HTTP é¦–éƒ¨å­—æ®µ</h2><p>é¦–éƒ¨å’Œæ–¹æ³•é…åˆå·¥ä½œï¼Œå…±åŒå†³å®šäº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨èƒ½åšä»€ä¹ˆäº‹æƒ…ã€‚    </p>
<p>åœ¨è¯·æ±‚å’Œå“åº”æŠ¥æ–‡ä¸­éƒ½å¯ä»¥<strong>ç”¨é¦–éƒ¨æ¥æä¾›ä¿¡æ¯</strong>ï¼Œæœ‰äº›é¦–éƒ¨æ˜¯æŸç§æŠ¥æ–‡ä¸“ç”¨çš„ï¼Œæœ‰äº›é¦–éƒ¨åˆ™æ›´é€šç”¨ä¸€äº›ã€‚å¯ä»¥å°†é¦–éƒ¨åˆ†ä¸ºäº”ä¸ªä¸»è¦çš„ç±»å‹ã€‚</p>
<h3 id="é€šç”¨é¦–éƒ¨å­—æ®µ"><a href="#é€šç”¨é¦–éƒ¨å­—æ®µ" class="headerlink" title="é€šç”¨é¦–éƒ¨å­—æ®µ"></a>é€šç”¨é¦–éƒ¨å­—æ®µ</h3><p>é€šç”¨é¦–éƒ¨å­—æ®µæ˜¯æŒ‡ï¼Œ<strong>è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡åŒæ–¹éƒ½ä¼šä½¿ç”¨çš„é¦–éƒ¨</strong>ã€‚</p>
<table>
<thead>
<tr>
<th>é¦–éƒ¨å­—æ®µå</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Cache-Control</strong></td>
<td>æ§åˆ¶ç¼“å­˜çš„è¡Œä¸º</td>
</tr>
<tr>
<td>Connection</td>
<td>é€è·³é¦–éƒ¨ã€è¿æ¥çš„ç®¡ç†</td>
</tr>
<tr>
<td>Date</td>
<td>åˆ›å»ºæŠ¥æ–‡çš„æ—¥æœŸæ—¶é—´</td>
</tr>
<tr>
<td>Pragma</td>
<td>æŠ¥æ–‡æŒ‡ä»¤</td>
</tr>
<tr>
<td>Trailer</td>
<td>æŠ¥æ–‡æœ«ç«¯çš„é¦–éƒ¨ä¸€è§ˆ</td>
</tr>
<tr>
<td>Transfer-Encoding</td>
<td>æŒ‡å®šæŠ¥æ–‡ä¸»ä½“çš„ä¼ è¾“ç¼–ç æ–¹å¼</td>
</tr>
<tr>
<td><strong>Upgrade</strong></td>
<td>å‡çº§ä¸ºå…¶ä»–åè®®</td>
</tr>
<tr>
<td>Via</td>
<td>ä»£ç†æœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯</td>
</tr>
<tr>
<td>Warning</td>
<td>é”™è¯¯é€šçŸ¥</td>
</tr>
</tbody>
</table>
<h4 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache-Control"></a>Cache-Control</h4><p>é€šè¿‡æŒ‡å®šé¦–éƒ¨å­—æ®µ Cache-Control çš„æŒ‡ä»¤ï¼Œå°±èƒ½æ“ä½œç¼“å­˜çš„å·¥ä½œæœºåˆ¶ã€‚</p>
<p><code>Cache-Control: private, max-age=0, no-cache</code></p>
<p>æŒ‡ä»¤çš„å‚æ•°æ˜¯å¯é€‰çš„ï¼Œå¤šä¸ªæŒ‡ä»¤ä¹‹é—´é€šè¿‡â€œ,â€åˆ†éš”ã€‚é¦–éƒ¨å­—æ®µ CacheControl çš„æŒ‡ä»¤å¯ç”¨äºè¯·æ±‚åŠå“åº”æ—¶ã€‚</p>
<h5 id="ç¼“å­˜è¯·æ±‚æŒ‡ä»¤"><a href="#ç¼“å­˜è¯·æ±‚æŒ‡ä»¤" class="headerlink" title="ç¼“å­˜è¯·æ±‚æŒ‡ä»¤"></a>ç¼“å­˜è¯·æ±‚æŒ‡ä»¤</h5><table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>no-cache</td>
<td>æ— </td>
<td>å¼ºåˆ¶å‘æºæœåŠ¡å™¨å†æ¬¡éªŒè¯</td>
</tr>
<tr>
<td>no-store</td>
<td>æ— </td>
<td>ä¸ç¼“å­˜è¯·æ±‚æˆ–å“åº”çš„ä»»ä½•å†…å®¹</td>
</tr>
<tr>
<td>max-age = [ ç§’]</td>
<td>å¿…éœ€</td>
<td>å“åº”çš„æœ€å¤§Ageå€¼</td>
</tr>
<tr>
<td>max-stale( = [ ç§’])</td>
<td>å¯çœç•¥</td>
<td>æ¥æ”¶å·²è¿‡æœŸçš„å“åº”</td>
</tr>
<tr>
<td>min-fresh = [ ç§’]</td>
<td>å¿…éœ€</td>
<td>æœŸæœ›åœ¨æŒ‡å®šæ—¶é—´å†…çš„å“åº”ä»æœ‰æ•ˆ</td>
</tr>
<tr>
<td>no-transform</td>
<td>æ— </td>
<td>ä»£ç†ä¸å¯æ›´æ”¹åª’ä½“ç±»å‹</td>
</tr>
<tr>
<td>only-if-cached</td>
<td>æ— </td>
<td>ä»ç¼“å­˜è·å–èµ„æº</td>
</tr>
<tr>
<td>cache-extension</td>
<td>-</td>
<td>æ–°æŒ‡ä»¤æ ‡è®°ï¼ˆtokenï¼‰</td>
</tr>
</tbody>
</table>
<p>æ¢è¨€ä¹‹ï¼Œæ— å‚æ•°å€¼çš„é¦–éƒ¨å­—æ®µå¯ä»¥ä½¿ç”¨ç¼“å­˜ã€‚</p>
<blockquote>
<p>ä»å­—é¢æ„æ€ä¸Šå¾ˆå®¹æ˜“æŠŠ no-cache è¯¯è§£æˆä¸ºä¸ç¼“å­˜ï¼Œä½†äº‹å®ä¸Š no-cache ä»£è¡¨<strong>ä¸ç¼“å­˜<em>è¿‡æœŸ</em>çš„èµ„æº</strong>ï¼Œç¼“å­˜ä¼šå‘æºæœåŠ¡å™¨è¿›è¡Œæœ‰æ•ˆæœŸç¡®è®¤åå¤„ç†èµ„æºï¼Œä¹Ÿè®¸ç§°ä¸º <code>do-notserve-from-cache-without-revalidation</code>æ›´åˆé€‚ã€‚<strong><code>no-store</code>æ‰æ˜¯çœŸæ­£åœ°ä¸è¿›è¡Œç¼“å­˜</strong>ï¼Œ</p>
</blockquote>
<h5 id="max-age"><a href="#max-age" class="headerlink" title="max-age"></a>max-age</h5><p>ä½¿ç”¨ HTTP/1.1 ç‰ˆæœ¬çš„ç¼“å­˜æœåŠ¡å™¨é‡åˆ°åŒæ—¶å­˜åœ¨ Expires é¦–éƒ¨å­—æ®µçš„æƒ…å†µæ—¶ï¼Œä¼š<strong>ä¼˜å…ˆå¤„ç† max-age æŒ‡ä»¤</strong>ï¼Œè€Œ<strong>å¿½ç•¥æ‰ Expires é¦–éƒ¨å­—</strong>æ®µã€‚<br>è€ŒHTTP/1.0 ç‰ˆæœ¬çš„ç¼“å­˜æœåŠ¡å™¨çš„æƒ…å†µå´ç›¸åï¼Œmax-age æŒ‡ä»¤ä¼šè¢«å¿½ç•¥æ‰</p>
<h5 id="only-if-cached-æŒ‡ä»¤"><a href="#only-if-cached-æŒ‡ä»¤" class="headerlink" title="only-if-cached æŒ‡ä»¤"></a>only-if-cached æŒ‡ä»¤</h5><p><code>Cache-Control: only-if-cached</code><br>ä½¿ç”¨ only-if-cached æŒ‡ä»¤è¡¨ç¤ºå®¢æˆ·ç«¯ä»…åœ¨ç¼“å­˜æœåŠ¡å™¨æœ¬åœ°ç¼“å­˜ç›®æ ‡èµ„æºçš„æƒ…å†µä¸‹æ‰ä¼šè¦æ±‚å…¶è¿”å›ã€‚æ¢è¨€ä¹‹ï¼Œè¯¥æŒ‡ä»¤<strong>è¦æ±‚ç¼“å­˜æœåŠ¡å™¨ä¸é‡æ–°åŠ è½½å“åº”ï¼Œä¹Ÿä¸ä¼šå†æ¬¡ç¡®è®¤èµ„æºæœ‰æ•ˆæ€§</strong>ã€‚è‹¥å‘ç”Ÿè¯·æ±‚ç¼“å­˜æœåŠ¡å™¨çš„æœ¬åœ°ç¼“å­˜æ— å“åº”ï¼Œåˆ™è¿”å›çŠ¶æ€ç  504 Gateway Timeoutã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">This field&apos;s name &quot;only-if-cached&quot; is misleading. It actually means &quot;do not use the network&quot;. It is set by a client who only wants to make a request if it can be fully satisfied by the cache. Cached responses that would require validation (ie. conditional gets) are not permitted if this header is set.</div><div class="line"></div><div class="line">è¯¥å­—æ®µåæœ‰è¯¯å¯¼æ€§ã€‚å®é™…æ„ä¹‰æ˜¯ã€Œä¸è¦ä½¿ç”¨ç½‘ç»œã€ã€‚å®ƒç”±ä¸€ä¸ªåªæœ‰åœ¨ç¼“å­˜èƒ½å¤Ÿå®Œå…¨æ»¡è¶³éœ€æ±‚çš„æƒ…å†µä¸‹æ‰æƒ³å‘å‡ºè¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚å¦‚æœè®¾ç½®äº†è¯¥ headerï¼Œåˆ™ä¸å…è®¸ä½¿ç”¨éœ€è¦éªŒè¯çš„ç¼“å­˜å“åº”ï¼ˆ æ¯”å¦‚ã€‚æ¡ä»¶ get è¯·æ±‚ï¼‰ã€‚</div></pre></td></tr></table></figure>
<h3 id="è¯·æ±‚é¦–éƒ¨å­—æ®µ"><a href="#è¯·æ±‚é¦–éƒ¨å­—æ®µ" class="headerlink" title="è¯·æ±‚é¦–éƒ¨å­—æ®µ"></a>è¯·æ±‚é¦–éƒ¨å­—æ®µ</h3><table>
<thead>
<tr>
<th>é¦–éƒ¨å­—æ®µå</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Accept</td>
<td>ç”¨æˆ·ä»£ç†å¯å¤„ç†çš„åª’ä½“ç±»å‹</td>
</tr>
<tr>
<td>Accept-Charset</td>
<td>ä¼˜å…ˆçš„å­—ç¬¦é›†</td>
</tr>
<tr>
<td>Accept-Encoding</td>
<td>ä¼˜å…ˆçš„å†…å®¹ç¼–ç </td>
</tr>
<tr>
<td>Accept-Language</td>
<td>ä¼˜å…ˆçš„è¯­è¨€ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰</td>
</tr>
<tr>
<td>Authorization</td>
<td>Webè®¤è¯ä¿¡æ¯</td>
</tr>
<tr>
<td>Expect</td>
<td>æœŸå¾…æœåŠ¡å™¨çš„ç‰¹å®šè¡Œä¸º</td>
</tr>
<tr>
<td>From</td>
<td>ç”¨æˆ·çš„ç”µå­é‚®ç®±åœ°å€</td>
</tr>
<tr>
<td>Host</td>
<td>è¯·æ±‚èµ„æºæ‰€åœ¨æœåŠ¡å™¨</td>
</tr>
<tr>
<td>If-Match</td>
<td>æ¯”è¾ƒå®ä½“æ ‡è®°ï¼ˆETagï¼‰</td>
</tr>
<tr>
<td><strong>If-Modified-Since</strong></td>
<td>æ¯”è¾ƒèµ„æºçš„æ›´æ–°æ—¶é—´</td>
</tr>
<tr>
<td>If-None-Match</td>
<td>æ¯”è¾ƒå®ä½“æ ‡è®°ï¼ˆä¸ If-Match ç›¸åï¼‰</td>
</tr>
<tr>
<td>If-Range</td>
<td>èµ„æºæœªæ›´æ–°æ—¶å‘é€å®ä½“ Byte çš„èŒƒå›´è¯·æ±‚</td>
</tr>
<tr>
<td>If-Unmodified-Since</td>
<td>æ¯”è¾ƒèµ„æºçš„æ›´æ–°æ—¶é—´ï¼ˆä¸If-Modified-Sinceç›¸åï¼‰</td>
</tr>
<tr>
<td>Max-Forwards</td>
<td>æœ€å¤§ä¼ è¾“é€è·³æ•°</td>
</tr>
<tr>
<td>Proxy-Authorization</td>
<td>ä»£ç†æœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯çš„è®¤è¯ä¿¡æ¯</td>
</tr>
<tr>
<td>Range</td>
<td>å®ä½“çš„å­—èŠ‚èŒƒå›´è¯·æ±‚</td>
</tr>
<tr>
<td>Referer</td>
<td>å¯¹è¯·æ±‚ä¸­ URI çš„åŸå§‹è·å–æ–¹</td>
</tr>
<tr>
<td>TE</td>
<td>ä¼ è¾“ç¼–ç çš„ä¼˜å…ˆçº§</td>
</tr>
<tr>
<td>User-Agent HTTP</td>
<td>å®¢æˆ·ç«¯ç¨‹åºçš„ä¿¡æ¯</td>
</tr>
</tbody>
</table>
<h3 id="å“åº”é¦–éƒ¨å­—æ®µ"><a href="#å“åº”é¦–éƒ¨å­—æ®µ" class="headerlink" title="å“åº”é¦–éƒ¨å­—æ®µ"></a>å“åº”é¦–éƒ¨å­—æ®µ</h3><table>
<thead>
<tr>
<th>é¦–éƒ¨å­—æ®µå</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Accept-Ranges</td>
<td>æ˜¯å¦æ¥å—å­—èŠ‚èŒƒå›´è¯·æ±‚</td>
</tr>
<tr>
<td>Age</td>
<td>æ¨ç®—èµ„æºåˆ›å»ºç»è¿‡æ—¶é—´</td>
</tr>
<tr>
<td>ETag</td>
<td>èµ„æºçš„åŒ¹é…ä¿¡æ¯</td>
</tr>
<tr>
<td>Location</td>
<td>ä»¤å®¢æˆ·ç«¯é‡å®šå‘è‡³æŒ‡å®šURI</td>
</tr>
<tr>
<td>Proxy-Authenticate</td>
<td>ä»£ç†æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ä¿¡æ¯</td>
</tr>
<tr>
<td>Retry-After</td>
<td>å¯¹å†æ¬¡å‘èµ·è¯·æ±‚çš„æ—¶æœºè¦æ±‚</td>
</tr>
<tr>
<td>Server</td>
<td>HTTPæœåŠ¡å™¨çš„å®‰è£…ä¿¡æ¯</td>
</tr>
<tr>
<td>Vary</td>
<td>ä»£ç†æœåŠ¡å™¨ç¼“å­˜çš„ç®¡ç†ä¿¡æ¯</td>
</tr>
<tr>
<td>WWW-Authenticate</td>
<td>æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ä¿¡æ¯</td>
</tr>
</tbody>
</table>
<h3 id="vary"><a href="#vary" class="headerlink" title="vary"></a>vary</h3><ul>
<li>é¦–éƒ¨å­—æ®µ Vary å¯å¯¹ç¼“å­˜è¿›è¡Œæ§åˆ¶ã€‚æºæœåŠ¡å™¨ä¼šå‘ä»£ç†æœåŠ¡å™¨ä¼ è¾¾å…³äºæœ¬åœ°ç¼“å­˜ä½¿ç”¨æ–¹æ³•çš„å‘½ä»¤ã€‚</li>
<li>ä»ä»£ç†æœåŠ¡å™¨æ¥æ”¶åˆ°æºæœåŠ¡å™¨è¿”å›åŒ…å« Vary æŒ‡å®šé¡¹çš„å“åº”ä¹‹åï¼Œè‹¥å†è¦è¿›è¡Œç¼“å­˜ï¼Œä»…å¯¹è¯·æ±‚ä¸­å«æœ‰ç›¸åŒ Vary æŒ‡å®šé¦–éƒ¨å­—æ®µçš„è¯·æ±‚è¿”å›ç¼“å­˜ã€‚å³ä½¿å¯¹ç›¸åŒèµ„æºå‘èµ·è¯·æ±‚ï¼Œä½†ç”±äº Vary æŒ‡å®šçš„é¦–éƒ¨å­—æ®µä¸ç›¸åŒï¼Œå› æ­¤å¿…é¡»è¦ä»æºæœåŠ¡å™¨é‡æ–°è·å–èµ„æºã€‚</li>
</ul>
<h3 id="å®ä½“é¦–éƒ¨å­—æ®µ"><a href="#å®ä½“é¦–éƒ¨å­—æ®µ" class="headerlink" title="å®ä½“é¦–éƒ¨å­—æ®µ"></a>å®ä½“é¦–éƒ¨å­—æ®µ</h3><p>å®ä½“é¦–éƒ¨å­—æ®µæ˜¯åŒ…å«åœ¨è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡ä¸­çš„<strong>å®ä½“éƒ¨åˆ†æ‰€ä½¿ç”¨çš„é¦–éƒ¨</strong>ï¼Œç”¨äºè¡¥å……å†…å®¹çš„æ›´æ–°æ—¶é—´ç­‰ä¸å®ä½“ç›¸å…³çš„ä¿¡æ¯ã€‚</p>
<p>æœ‰å¾ˆå¤šé¦–éƒ¨å¯ä»¥ç”¨æ¥<strong>æè¿° HTTP æŠ¥æ–‡çš„è´Ÿè·</strong>ã€‚</p>
<p>å®ä½“é¦–éƒ¨æä¾›äº†<strong>æœ‰å…³å®ä½“åŠå…¶å†…å®¹çš„å¤§é‡ä¿¡æ¯</strong>ï¼Œä»æœ‰å…³<strong>å¯¹è±¡ç±»å‹çš„ä¿¡æ¯</strong>ï¼Œåˆ°èƒ½å¤Ÿ<strong>å¯¹èµ„æºä½¿ç”¨çš„å„ç§æœ‰æ•ˆçš„è¯·æ±‚æ–¹æ³•</strong>ã€‚æ€»ä¹‹ï¼Œ<strong>å®ä½“é¦–éƒ¨å¯ä»¥å‘ŠçŸ¥æŠ¥æ–‡çš„æ¥æ”¶è€…å®ƒåœ¨å¯¹ä»€ä¹ˆè¿›è¡Œå¤„ç†</strong>ã€‚ä¸‹è¡¨ä¸­ åˆ—å‡ºäº†å®ä½“çš„ä¿¡æ¯æ€§é¦–éƒ¨ã€‚</p>
<table>
<thead>
<tr>
<th>é¦–éƒ¨å­—æ®µå</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Allow</td>
<td>èµ„æº<strong>å¯æ”¯æŒçš„HTTPæ–¹æ³•</strong></td>
</tr>
<tr>
<td>Content-Encoding</td>
<td>å®ä½“ä¸»ä½“é€‚ç”¨çš„ç¼–ç æ–¹å¼</td>
</tr>
<tr>
<td>Content-Language</td>
<td>å®ä½“ä¸»ä½“çš„è‡ªç„¶è¯­è¨€</td>
</tr>
<tr>
<td><strong>Content-Length</strong></td>
<td><strong>å®ä½“ä¸»ä½“çš„å¤§å°</strong>ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰</td>
</tr>
<tr>
<td>Content-Location</td>
<td>æ›¿ä»£å¯¹åº”èµ„æºçš„URI</td>
</tr>
<tr>
<td><strong>Content-MD5</strong></td>
<td>å®ä½“ä¸»ä½“çš„æŠ¥æ–‡æ‘˜è¦</td>
</tr>
<tr>
<td><strong>Content-Range</strong></td>
<td>å®ä½“ä¸»ä½“çš„ä½ç½®èŒƒå›´</td>
</tr>
<tr>
<td><strong>Content-Type</strong></td>
<td>å®ä½“ä¸»ä½“çš„<strong>åª’ä½“ç±»å‹</strong></td>
</tr>
<tr>
<td><strong>Expires</strong></td>
<td>å®ä½“ä¸»ä½“<strong>è¿‡æœŸçš„æ—¥æœŸæ—¶é—´</strong></td>
</tr>
<tr>
<td><strong>Last-Modified</strong></td>
<td>èµ„æºçš„<strong>æœ€åä¿®æ”¹æ—¥æœŸæ—¶é—´</strong></td>
</tr>
</tbody>
</table>
<h3 id="æ‰©å±•é¦–éƒ¨"><a href="#æ‰©å±•é¦–éƒ¨" class="headerlink" title="æ‰©å±•é¦–éƒ¨"></a>æ‰©å±•é¦–éƒ¨</h3><p>æ‰©å±•é¦–éƒ¨æ˜¯éæ ‡å‡†çš„é¦–éƒ¨ï¼Œç”±åº”ç”¨ç¨‹åºå¼€å‘è€…åˆ›å»ºï¼Œä½†è¿˜æœªæ·»åŠ åˆ°å·²æ‰¹å‡†çš„ HTTP è§„èŒƒä¸­å»ã€‚å³ä½¿ä¸çŸ¥é“è¿™äº›æ‰©å±•é¦–éƒ¨çš„å«ä¹‰ï¼ŒHTTP ç¨‹åºä¹Ÿè¦æ¥å—å®ƒä»¬å¹¶å¯¹å…¶è¿›è¡Œè½¬å‘ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li>ã€Šå›¾è§£ HTTPã€‹</li>
<li>ã€ŠHTTP æƒå¨æŒ‡å—ã€‹</li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> è®¡ç®—æœºç½‘ç»œ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> è®¡ç®—æœºç½‘ç»œ </tag>
            
            <tag> Http </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æ‹†è½®å­ç³»åˆ—â€”â€”LeakCanaryå·¥ä½œåŸç†]]></title>
      <url>https://timlin-pro.github.io/blog/2017/12/15/%E6%8B%86%E8%BD%AE%E5%AD%90%E7%B3%BB%E5%88%97%E2%80%94%E2%80%94LeakCanary%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h2><p>LeakCanary æ˜¯ä¸€ä¸ªå†…å­˜æ³„æ¼çš„è‡ªåŠ¨åŒ–ç›‘æµ‹å·¥å…·ã€‚</p>
<h3 id="1-1ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ"><a href="#1-1ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ" class="headerlink" title="1.1ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ"></a>1.1ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ</h3><p>å†…å­˜æ³„æ¼æŒ‡çš„æ˜¯åº”è¯¥è¢«é‡Šæ”¾çš„å†…å­˜çš„æ²¡æœ‰è¢«é‡Šæ”¾ã€‚åŸå› ï¼Ÿé•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æŒæœ‰çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„å¼•ç”¨ã€‚</p>
<h3 id="1-2å“ªäº›å¯¹è±¡åº”è¯¥è¢«å›æ”¶ï¼Ÿ"><a href="#1-2å“ªäº›å¯¹è±¡åº”è¯¥è¢«å›æ”¶ï¼Ÿ" class="headerlink" title="1.2å“ªäº›å¯¹è±¡åº”è¯¥è¢«å›æ”¶ï¼Ÿ"></a>1.2å“ªäº›å¯¹è±¡åº”è¯¥è¢«å›æ”¶ï¼Ÿ</h3><p>é¦–å…ˆè¦æ‰¾å‡ºå“ªäº›å¯¹è±¡æ˜¯<strong>åº”è¯¥è¢«å›æ”¶</strong>çš„ï¼ŸAndroid ä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„æ˜¯ Activity å’Œ Fragment äº†ã€‚ä»–ä»¬éƒ½æœ‰ onDestory æ–¹æ³•ï¼Œå½“å®ƒä»¬çš„ <strong>onDestroy æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±å¯ä»¥æŠŠå®ƒä»¬åˆ—ä¸º ã€Œåº”è¯¥è¢«å›æ”¶çš„å¯¹è±¡</strong>ã€ï¼Œå¯åœ¨ onDestory  æ–¹æ³•ä¸­å»ºç«‹<strong>æ£€æµ‹ç‚¹</strong>ã€‚</p>
<a id="more"></a>
<p>æ³¨ï¼š</p>
<ol>
<li><code>Application#dispatchActivityDestroyed</code> æ˜¯åœ¨ <code>Activity#onDestroy</code> æ–¹æ³•æ‰§è¡Œåå›è°ƒçš„ã€‚</li>
</ol>
<h3 id="1-3å¦‚ä½•çŸ¥é“å¯¹è±¡æ˜¯å¦è¢«å›æ”¶äº†ï¼Ÿ"><a href="#1-3å¦‚ä½•çŸ¥é“å¯¹è±¡æ˜¯å¦è¢«å›æ”¶äº†ï¼Ÿ" class="headerlink" title="1.3å¦‚ä½•çŸ¥é“å¯¹è±¡æ˜¯å¦è¢«å›æ”¶äº†ï¼Ÿ"></a>1.3å¦‚ä½•çŸ¥é“å¯¹è±¡æ˜¯å¦è¢«å›æ”¶äº†ï¼Ÿ</h3><p>æ‰‹åŠ¨ GC +ReferenceQueue + WeakReference</p>
<blockquote>
<p>  WeakReference åˆ›å»ºæ—¶ï¼Œä¼ å…¥ä¸€ä¸ª ReferenceQueue å¯¹è±¡ã€‚å½“è¢« WeakReference å¼•ç”¨çš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œä¸€æ—¦è¢« GC æ£€æŸ¥åˆ°ï¼ŒGC å°†ä¼šæŠŠè¯¥å¯¹è±¡æ·»åŠ åˆ° ReferenceQueue ä¸­ï¼Œå¾… ReferenceQueue å¤„ç†ã€‚å½“ GC è¿‡åå¯¹è±¡ä¸€ç›´ä¸è¢«åŠ å…¥ ReferenceQueueï¼Œè¯´æ˜å®ƒå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ã€‚</p>
</blockquote>
<p>è¿™é‡Œå…¶å®æœ‰ä¸€ä¸ªé»˜è®¤çš„å‰æå°±æ˜¯ï¼Œå½“ä¸€ä¸ªå¯¹è±¡å­˜åœ¨å¼ºå¼•ç”¨çš„æ—¶å€™ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸ä¼šè¢«å›æ”¶çš„ï¼Œæ‰€ä»¥ GC å‰åï¼Œå¯è¾¾æ€§å¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¹Ÿå°±ä¸ä¼šè¢«åŠ å…¥åˆ° referenceQueue ä¸­ã€‚è€Œå¦‚æœä¸€ä¸ªå¯¹è±¡åªå«æœ‰å¼±å¼•ç”¨çš„æ—¶å€™ï¼ŒGC å‰åå¯è¾¾æ€§ä¼šå‘ç”Ÿæ”¹å˜â€”â€”GC ä¹‹å‰å¼±å¯è¾¾ï¼ŒGC ä¹‹åå˜ä¸å¯è¾¾ã€‚</p>
<p>ä»€ä¹ˆæ ·çš„å¯¹è±¡ä¼šè¿›å…¥ReferenceQueueï¼Ÿ</p>
<blockquote>
<p>åˆ›å»º Reference çš„æ—¶å€™æŒ‡å®šäº† ReferenceQueueï¼Œå¹¶ä¸”å¯¹è±¡çš„å¯è¾¾æ€§å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
</blockquote>
<p>å…·ä½“åŠ å…¥çš„æ—¶é—´æ˜¯åœ¨ GCå‰è¿˜æ˜¯ GCå å¹¶ä¸æ˜¯å¾ˆé‡è¦ï¼Œé‡è¦çš„æ˜¯ï¼Œ<strong>ä¸€æ—¦è¢«æ·»åŠ åˆ° ReferenceQueue ä¸­ï¼Œå¯¹åº”çš„å¯¹è±¡ä¸€å®šä¼šè¢«å›æ”¶</strong> (åŠæ—¶è¢«å›æ”¶äº†è‡ªç„¶ä¹Ÿå°±æ²¡æœ‰å†…å­˜æ³„æ¼é—®é¢˜äº†ï¼Œæ‰€ä»¥ LeakCanary æŠŠåŠ å…¥ ReferenceQueue ä½œä¸ºå†…å­˜æ³„æ¼æ£€æµ‹çš„åˆæ­¥åˆ¤æ–­æ ‡å‡†)</p>
<p>å‡è®¾æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼ŒActivity ä»…è¢«æˆ‘ä»¬åˆ›å»ºçš„ KeyedWeakReference å¼±å¼•ç”¨äº†ã€‚æˆ‘ä»¬ç¬¬ä¸€æ¬¡æ‰‹åŠ¨ GC çš„æ—¶å€™ï¼Œå®ƒå°±ä¼šè¿›å…¥å¼•ç”¨é˜Ÿåˆ—ã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥å°†å®ƒä» retainkeys ä¸­ç§»é™¤ã€‚</p>
<p>å¯¹è±¡ä¸€æ—¦åªå­˜åœ¨å¼±å¼•ç”¨ï¼Œä¼š ReferenceHandler çº¿ç¨‹ç›‘å¬åˆ°ï¼Œè¯¥çº¿ç¨‹ä¼šå°†è¯¥å¯¹è±¡çš„å¼•ç”¨åŠ å…¥ ReferenceQueue ä¸­ï¼Œè¿™å‘ç”Ÿåœ¨ finalization æˆ–è€… gc ä¹‹å‰ã€‚</p>
<p>LeakCanary åˆ¤æ–­æ˜¯å¦å‘ç”Ÿå†…å­˜çš„æ³„æ¼çš„æ ‡å‡†ï¼šå¯¹è±¡çš„å¼•ç”¨æ˜¯å¦åœ¨<code>Set&lt;String&gt; retainedKeys</code> ä¸­ã€‚</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªè·Ÿè¸ªå¯¹è±¡ï¼Œå°†å®ƒçš„ key å­˜å‚¨åœ¨ä¸€ä¸ª retainedKeys ä¸­ã€‚å½“å¯¹è±¡å‡ºç°åœ¨å¼•ç”¨é˜Ÿåˆ—é‡Œé¢çš„æ—¶å€™ï¼Œå°†å®ƒä» set ä¸­ç§»é™¤ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ä¸åœ¨retainKeys ä¸­ï¼Œè¯´æ˜æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚å¦‚æœåœ¨ï¼Œåˆ™è¯´æ˜å¯èƒ½å‘ç”Ÿäº†å†…å­˜æ³„æ¼ã€‚</li>
</ul>
<h3 id="1-4æœªè¢«å›æ”¶-å†…å­˜æ³„æ¼ï¼Ÿ"><a href="#1-4æœªè¢«å›æ”¶-å†…å­˜æ³„æ¼ï¼Ÿ" class="headerlink" title="1.4æœªè¢«å›æ”¶==å†…å­˜æ³„æ¼ï¼Ÿ"></a>1.4æœªè¢«å›æ”¶==å†…å­˜æ³„æ¼ï¼Ÿ</h3><h4 id="æ²¡è¢«å›æ”¶çš„åŸå› ï¼šè¢«æŒæœ‰å¼ºå¼•ç”¨äº†å—ï¼Ÿ"><a href="#æ²¡è¢«å›æ”¶çš„åŸå› ï¼šè¢«æŒæœ‰å¼ºå¼•ç”¨äº†å—ï¼Ÿ" class="headerlink" title="æ²¡è¢«å›æ”¶çš„åŸå› ï¼šè¢«æŒæœ‰å¼ºå¼•ç”¨äº†å—ï¼Ÿ"></a>æ²¡è¢«å›æ”¶çš„åŸå› ï¼šè¢«æŒæœ‰å¼ºå¼•ç”¨äº†å—ï¼Ÿ</h4><p>æœªè¢«å›æ”¶çš„å¯¹è±¡ï¼Œæ˜¯å¦è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Ÿæ‰¾å‡º<strong>å…¶æœ€çŸ­å¼•ç”¨é“¾</strong>ã€‚<code>VMDebug</code> + <code>HAHA</code> å®Œæˆéœ€æ±‚ã€‚</p>
<p>VMDebugã€HAHAã€‚</p>
<blockquote>
<p>  VM ä¼šæœ‰å †å†…å„ä¸ªå¯¹è±¡çš„å¼•ç”¨æƒ…å†µï¼Œå¹¶èƒ½ä»¥<code>hprof</code>æ–‡ä»¶å¯¼å‡ºã€‚HAHA æ˜¯ä¸€ä¸ªç”± square å¼€æºçš„ Android å †åˆ†æåº“ï¼Œåˆ†æ <code>hprof</code> æ–‡ä»¶ç”Ÿæˆ<code>Snapshot</code>å¯¹è±¡ã€‚<code>Snapshot</code>ç”¨ä»¥æŸ¥è¯¢å¯¹è±¡çš„æœ€çŸ­å¼•ç”¨é“¾ã€‚</p>
</blockquote>
<p>æ‰¾åˆ°æœ€çŸ­å¼•ç”¨é“¾åï¼Œå®šä½é—®é¢˜ï¼Œæ’æŸ¥ä»£ç å°†ä¼šäº‹åŠåŠŸå€ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ€»ä½“æµç¨‹å›¾ï¼šï¼ˆæµç¨‹å›¾å‚è€ƒè‡ª<a href="http://www.jianshu.com/p/3f1a1cc1e964" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ï¼‰</p>
<p><img src="http://upload-images.jianshu.io/upload_images/737949-cff06b0079bf09c4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2" alt=""></p>
<p>å¦‚æœè¯»è€…è¿˜æ²¡çœ‹è¿‡ LeakCanary çš„æºç ï¼Œå»ºè®®ç…§ç€ä¸Šé¢çš„è°ƒç”¨æµç¨‹å›¾è¿‡ä¸€éï¼Œè¿™æ ·æ•ˆæœä¼šå¥½å¾ˆå¤šã€‚whyï¼Ÿ<a href="https://juejin.im/post/5a137248f265da43333e0418" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆæºç åˆ†æå‘³åŒåš¼èœ¡ï¼Ÿæµ…ææŠ€æœ¯å†™ä½œä¸­çš„æ€ç»´è¯¯åŒº</a></p>
<h2 id="äºŒã€å…·ä½“æµç¨‹"><a href="#äºŒã€å…·ä½“æµç¨‹" class="headerlink" title="äºŒã€å…·ä½“æµç¨‹"></a>äºŒã€å…·ä½“æµç¨‹</h2><p>å‰é¢è®²äº†å¤§ä½“æµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å†…éƒ¨çš„å®ç°ã€‚</p>
<p>é€šå¸¸ä¼šåœ¨ Applcation#onCreate ä¸­å¯¹ LeakCanary è¿›è¡Œåˆå§‹åŒ–,ä¹Ÿå°±æ˜¯è°ƒç”¨ä¸‹é¢çš„ setupLeakCanary æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> RefWatcher <span class="title">setupLeakCanary</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (LeakCanary.isInAnalyzerProcess(<span class="keyword">this</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> RefWatcher.DISABLED;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> LeakCanary.install(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-1LeakCanary-install-è°ƒç”¨æµç¨‹"><a href="#2-1LeakCanary-install-è°ƒç”¨æµç¨‹" class="headerlink" title="2.1LeakCanary#install è°ƒç”¨æµç¨‹"></a>2.1LeakCanary#install è°ƒç”¨æµç¨‹</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">--&gt; â‘  LeakCanary#install</div><div class="line">	--&gt; â‘¡ refWatcher</div><div class="line">		--&gt; â‘¢ AndroidRefWatcherBuilder#listenerServiceClass	//ç›‘å¬æœåŠ¡ç±»</div><div class="line">			--&gt; â‘£ AndroidExcludedRefs#createAppDefaults//åˆ›å»ºé»˜è®¤çš„å¿½ç•¥åˆ—è¡¨</div><div class="line">				--&gt; â‘¤ ExcludedRefs.Builder#build</div><div class="line">			--&gt; â‘¥ RefWatcherBuilder#excludedRefs//æ’é™¤ä¸€äº›å¼•ç”¨</div><div class="line">			--&gt; â‘¦ AndroidRefWatcherBuilder#buildAndInstall//æ„é€ ä¸€ä¸ª RefWatcher </div><div class="line">				--&gt; â‘§ RefWatcherBuilder#build</div><div class="line">				--&gt; â‘¨ ActivityRefWatcher#install</div><div class="line">					--&gt; â‘© new ActivityRefWatcher</div><div class="line">						--&gt; â‘ª ActivityRefWatcher#watchActivities</div><div class="line">						--&gt; â‘« stopWatchingActivities();//é˜²æ­¢è£…è½½ä¸¤æ¬¡ï¼Œ</div><div class="line">							--&gt; â‘¬ Application.unregisterActivityLifecycleCallbacks(lifecycleCallbacks);//è§£æ³¨å†Œ</div><div class="line">						--&gt; â‘­    </div><div class="line">              Application#registerActivityLifecycleCallbacks(lifecycleCallbacks);//æ³¨å†Œç”Ÿå‘½å‘¨æœŸå›è°ƒ</div><div class="line">							--&gt; â‘®1mActivityLifecycleCallbacks.add(callback);//æ·»åŠ åˆ°ç›‘å¬è€…åˆ—è¡¨ä¸­</div></pre></td></tr></table></figure>
<p>æ³¨ï¼šç›‘å¬å›è°ƒè¿›è¡Œä»…ä»…å®ç°äº† </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityDestroyed</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">  ActivityRefWatcher.<span class="keyword">this</span>.onActivityDestroyed(activity);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºåœ¨é»˜è®¤æƒ…å†µä¸‹åªç›‘å¬ Activity çš„ <code>onDestory</code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´åªæ˜¯æ£€æµ‹ Activity æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ã€‚</p>
<h4 id="å¦‚æœè¦æ£€æµ‹-Fragment-çš„å†…å­˜æ³„æ¼ï¼Œåº”è¯¥å¦‚ä½•å®ç°ï¼Ÿ"><a href="#å¦‚æœè¦æ£€æµ‹-Fragment-çš„å†…å­˜æ³„æ¼ï¼Œåº”è¯¥å¦‚ä½•å®ç°ï¼Ÿ" class="headerlink" title="å¦‚æœè¦æ£€æµ‹ Fragment çš„å†…å­˜æ³„æ¼ï¼Œåº”è¯¥å¦‚ä½•å®ç°ï¼Ÿ"></a>å¦‚æœè¦æ£€æµ‹ Fragment çš„å†…å­˜æ³„æ¼ï¼Œåº”è¯¥å¦‚ä½•å®ç°ï¼Ÿ</h4><p>å› ä¸º Android ä¸­åªæä¾›äº† Activity çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„å›è°ƒï¼Œè€Œæ²¡æœ‰æä¾› Fragment ç”Ÿå‘½å‘¨æœŸå›è°ƒçš„ç›‘å¬ã€‚ å¦‚æœè¦å¯¹ Fragment çš„å†…å­˜æ³„æ¼è¿›è¡Œæ£€æµ‹ï¼Œé‚£ä¹ˆéœ€è¦è‡ªå·±åœ¨ <code>Fragment#onDestroy</code> æ–¹æ³•ä¸­æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª RefWatcher ï¼Œç„¶åè°ƒç”¨ <code>refWatcher#watch(this)</code>ï¼Œæœ€å¥½æ˜¯å®šä¹‰ä¸€ä¸ª Fragment åŸºç±»ï¼Œåœ¨å…¶ä¸­çš„ onDestroy æ–¹æ³•ä¸­å®šä¹‰ç›¸åº”çš„æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroy();</div><div class="line">    RefWatcher refWatcher = ExampleApplication.getRefWatcher(getActivity());</div><div class="line">    refWatcher.watch(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2å½“ç›‘å¬äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œåˆ‡æ¢åˆ°åå°æ‰§è¡Œ"><a href="#2-2å½“ç›‘å¬äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œåˆ‡æ¢åˆ°åå°æ‰§è¡Œ" class="headerlink" title="2.2å½“ç›‘å¬äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œåˆ‡æ¢åˆ°åå°æ‰§è¡Œ"></a>2.2å½“ç›‘å¬äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œåˆ‡æ¢åˆ°åå°æ‰§è¡Œ</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">--&gt; â‘  ActivityLifecycleCallbacks#onActivityDestroyed</div><div class="line">	--&gt;â‘¡ ActivityRefWatcher#onActivityDestroyed</div><div class="line">		--&gt;â‘¢ RefWatcher#watch(Object)</div><div class="line">			--&gt;â‘£ RefWatcher#watch(Object, String)    å†…éƒ¨æœ‰ä¸€ä¸ª ReferenceQueue&lt;Object&gt; queue;</div><div class="line">				--&gt;â‘¤ new KeyedWeakReference(watchedReference, key, referenceName, queue)//åˆ›å»º KeyedWeakReference</div><div class="line">  					//ä¸¤ä¸ª Handler,mainHandler ã€backgroundHandler</div><div class="line">  				--&gt;â‘¥ RefWatcher#ensureGoneAsync</div><div class="line">  					--&gt;â‘¦ WatchExecutor#execute </div><div class="line"> 						if å½“å‰çº¿ç¨‹ä¸ºä¸»çº¿ç¨‹</div><div class="line"> 							==&gt; â‘§AndroidWatchExecutor#waitForIdle// ç­‰å¾… MainLooper ç©ºé—²æ—¶å‘é€</div><div class="line"> 							</div><div class="line">								--&gt; â‘¨MessageQueue#addIdleHandler//å½“ Looper å³å°†é—²ç½®æ—¶å‘é€</div><div class="line">									--&gt; â‘©AndroidWatchExecutor#postToBackgroundWithDelay</div><div class="line">										--&gt; â‘ªbackgroundHandler#postDelayed//å·¥ä½œçº¿ç¨‹ Handler å»¶è¿Ÿå‘é€</div><div class="line">											--&gt; â‘«Retryable</div><div class="line">											--&gt; if (result == RETRY) </div><div class="line">         										 â‘¬postWaitForIdle(retryable, failedAttempts + 1);</div><div class="line"> 						else â‘§å½“å‰çº¿ç¨‹æ˜¯å·¥ä½œçº¿ç¨‹ï¼Œéœ€è¦å…ˆåˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ï¼Œå†ä»ä¸»çº¿ç¨‹åˆ‡æ¢åˆ° HandlerThread çº¿ç¨‹</div><div class="line">  							--&gt; â‘¨AndroidWatchExecutor#postWaitForIdle</div><div class="line">                          	   		--&gt; â‘©mainHandler#post//é€šè¿‡ä¸»çº¿ç¨‹ Handler åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œ	</div><div class="line">                          	   			==&gt; â‘ªAndroidWatchExecutor#waitForIdle//ç­‰å¾…ç©ºé—²æ—¶å‘é€</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° <code>Retryable#run</code> åœ¨å·¥ä½œçº¿ç¨‹æ‰§è¡Œã€‚<code>AndroidWatchExecutor</code> å†…åˆ›å»ºäº†ä¸€ä¸ª HandlerThread ï¼Œé€šè¿‡å®ƒåˆ›å»ºäº†ä¸€ä¸ª Handlerã€‚å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹ï¼Œç›´æ¥è°ƒç”¨ä¸»çº¿ç¨‹çš„  <code>Message#addIdleHandler</code> è¿›è¡Œå¤„ç†ï¼Œç»™å·¥ä½œçº¿ç¨‹å‘é€å»¶æ—¶ä»»åŠ¡ã€‚å¦åˆ™ï¼Œéœ€è¦å…ˆè°ƒç”¨ <code>mainHandler#post</code> æ–¹æ³•ï¼Œ åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ï¼Œç„¶åå†è°ƒç”¨ <code>AndroidWatchExecutor#waitForIdle</code>ã€‚ä¹‹æ‰€ä»¥è¦åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ï¼Œä¸»è¦æ˜¯ä¸ºäº†ä½¿ç”¨ä¸»çº¿ç¨‹çš„ <code>MessageQueue#addIdleHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HandlerThread handlerThread = <span class="keyword">new</span> HandlerThread(LEAK_CANARY_THREAD_NAME);</div><div class="line">handlerThread.start();</div><div class="line">backgroundHandler = <span class="keyword">new</span> Handler(handlerThread.getLooper());</div></pre></td></tr></table></figure>
<p>å‰é¢æ‰€è°ˆéƒ½æ˜¯æ‰§è¡Œçº¿ç¨‹çš„åˆ‡æ¢ï¼Œä¸‹é¢å¼€å§‹å†…å­˜åˆ†æä»»åŠ¡å…·ä½“æ˜¯å¦‚ä½•è¿›è¡Œçš„ã€‚</p>
<h3 id="2-3å†…å­˜æ³„æ¼åˆ†æ"><a href="#2-3å†…å­˜æ³„æ¼åˆ†æ" class="headerlink" title="2.3å†…å­˜æ³„æ¼åˆ†æ"></a>2.3å†…å­˜æ³„æ¼åˆ†æ</h3><h4 id="2-3-1å·¥ä½œæœºåˆ¶"><a href="#2-3-1å·¥ä½œæœºåˆ¶" class="headerlink" title="2.3.1å·¥ä½œæœºåˆ¶"></a>2.3.1å·¥ä½œæœºåˆ¶</h4><ol>
<li>åœ¨åå°çº¿ç¨‹æ£€æŸ¥å¼•ç”¨æ˜¯å¦è¢«æ¸…é™¤ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè°ƒç”¨ GCã€‚</li>
<li>å¦‚æœå¼•ç”¨è¿˜æ˜¯æœªè¢«æ¸…é™¤ï¼ŒæŠŠ heap å†…å­˜ dump åˆ° APP å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ª <code>.hprof</code> æ–‡ä»¶ä¸­ã€‚</li>
<li>åœ¨å¦å¤–ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ <code>HeapAnalyzerService</code> æœ‰ä¸€ä¸ª <code>HeapAnalyzer</code> ä½¿ç”¨<a href="https://github.com/square/haha" target="_blank" rel="noopener">HAHA</a> è§£æè¿™ä¸ªæ–‡ä»¶ã€‚</li>
<li>å¾—ç›Šäºå”¯ä¸€çš„ reference key, <code>HeapAnalyzer</code> æ‰¾åˆ° <code>KeyedWeakReference</code>ï¼Œå®šä½å†…å­˜æ³„æ¼ã€‚</li>
<li><code>HeapAnalyzer</code> è®¡ç®— <em>åˆ° GC roots çš„æœ€çŸ­å¼ºå¼•ç”¨è·¯å¾„</em>ï¼Œå¹¶ç¡®å®šæ˜¯å¦æ˜¯æ³„æ¼ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œå»ºç«‹å¯¼è‡´æ³„æ¼çš„å¼•ç”¨é“¾ã€‚</li>
<li>å¼•ç”¨é“¾ä¼ é€’åˆ° APP è¿›ç¨‹ä¸­çš„ <code>DisplayLeakService</code>ï¼Œ å¹¶ä»¥é€šçŸ¥çš„å½¢å¼å±•ç¤ºå‡ºæ¥ã€‚</li>
</ol>
<h4 id="2-3-2RefWatcher-ensureGone"><a href="#2-3-2RefWatcher-ensureGone" class="headerlink" title="2.3.2RefWatcher#ensureGone"></a>2.3.2RefWatcher#ensureGone</h4><p>åœ¨å‰é¢çš„çº¿ç¨‹åˆ‡æ¢åˆ°ç›®æ ‡å·¥ä½œçº¿ç¨‹ä¹‹åå°±è°ƒç”¨è¯¥æ–¹æ³•ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">RefWatcher#ensureGone</div><div class="line">	--&gt; â‘  RefWatcher#removeWeaklyReachableReferences//ç§»é™¤æ‰€æœ‰ã€Œå¼±å¯è¾¾å¼•ç”¨ã€</div><div class="line">	if (debuggerControl.isDebuggerAttached())</div><div class="line">      	--&gt; return RETRY;//è°ƒè¯•æ¨¡å¼æ§åˆ¶</div><div class="line">	if (gone(reference)) //åˆ¤æ–­ç±»åæ˜¯å¦ä¸åœ¨ Set&lt;String&gt; retainedKeys ä¸­ï¼Œè‹¥ä¸åœ¨ï¼Œè¯´æ˜å†…å­˜åˆ†æå®Œæ¯•</div><div class="line">    	  return DONE; </div><div class="line">    --&gt; gcTrigger.runGc();//è§¦å‘ gcï¼Œè°ƒç”¨çš„æ˜¯  Runtime.getRuntime().gc();</div><div class="line">	--&gt; â‘¡ RefWatcher#removeWeaklyReachableReferences//å†æ¬¡ç§»é™¤æ‰€æœ‰ã€Œå¼±å¯è¾¾å¼•ç”¨ã€</div><div class="line">	if !gone(reference)//å¦‚æœè¯¥å¼•ç”¨å¯¹åº”çš„é”®ä»ç„¶åœ¨ retainKeys ä¸­ï¼Œè¯´æ˜å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œè¿›è¡Œ dump ç„¶ååˆ†æ</div><div class="line">      	--&gt; File heapDumpFile = heapDumper.dumpHeap();// dump å †å†…å­˜ï¼Œä¼šè§¦å‘ stop the world</div><div class="line">	    if heapDumpFile == RETRY_LATER //ç°åœ¨æ— æ³•è§¦å‘ gc ï¼Œå…ˆè¿”å›ã€‚ç¨å€™é‡è¯•</div><div class="line">            --&gt; return RETRY;</div><div class="line">        --&gt; new HeapDump</div><div class="line">        --&gt; ServiceHeapDumpListener#analyze</div><div class="line">        	--&gt; HeapAnalyzerService#runAnalysis</div><div class="line">        		--&gt; startService //å¼€å¯ HeapAnalyzerService æœåŠ¡ï¼Œéœ€è¦ HeapDump ä»¥åŠæ¥æ”¶åˆ†æç»“æœçš„å›è°ƒç±»çš„ç±»å</div></pre></td></tr></table></figure>
<h4 id="2-3-3RefWatcher-removeWeaklyReachableReferences"><a href="#2-3-3RefWatcher-removeWeaklyReachableReferences" class="headerlink" title="2.3.3RefWatcher#removeWeaklyReachableReferences"></a>2.3.3RefWatcher#removeWeaklyReachableReferences</h4><p>ç§»é™¤åœ¨ retainedKeys ä¸­çš„æ‰€æœ‰å¼±å¯è¾¾çš„å¯¹è±¡å¯¹åº”çš„ keyã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; retainedKeys;</div><div class="line">ReferenceQueue&lt;Object&gt; queue;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeWeaklyReachableReferences</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// å¯¹è±¡ä¸€æ—¦åªå­˜åœ¨å¼±å¼•ç”¨ï¼Œé©¬ä¸Šå°±ä¼šè¢«åŠ å…¥ ReferenceQueue ä¸­ï¼Œè¿™å‘ç”Ÿåœ¨ finalization æˆ–è€… gc ä¹‹å‰</span></div><div class="line">  KeyedWeakReference ref;</div><div class="line">  <span class="keyword">while</span> ((ref = (KeyedWeakReference) queue.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">    retainedKeys.remove(ref.key);<span class="comment">//ç§»é™¤å¼±å¼•ç”¨å¯¹åº”çš„ key</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-3-4KeyedWeakReference"><a href="#2-3-4KeyedWeakReference" class="headerlink" title="2.3.4KeyedWeakReference"></a>2.3.4KeyedWeakReference</h4><p>ä¸Šé¢ä½¿ç”¨åˆ°äº†ä¸€ä¸ª KeyedWeakReference ç±»å‹çš„å¯¹è±¡ï¼ŒKeyedWeakReference æ„ä¸ºã€Œå¸¦é”®çš„å¼±å¼•ç”¨ã€ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyedWeakReference</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">final</span> String key;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">final</span> String name;</div><div class="line"></div><div class="line">  KeyedWeakReference(Object referent, String key, String name,</div><div class="line">      ReferenceQueue&lt;Object&gt; referenceQueue) &#123;</div><div class="line">    <span class="keyword">super</span>(checkNotNull(referent, <span class="string">"referent"</span>), checkNotNull(referenceQueue, <span class="string">"referenceQueue"</span>));</div><div class="line">    <span class="keyword">this</span>.key = checkNotNull(key, <span class="string">"key"</span>);</div><div class="line">    <span class="keyword">this</span>.name = checkNotNull(name, <span class="string">"name"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å”¯ä¸€åˆ›å»ºäº† KeyedReference çš„åœ°æ–¹ï¼š</p>
<p><code>RefWatcher#watch(Object, String)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">watch</span><span class="params">(Object watchedReference, String referenceName)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span> == DISABLED) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  checkNotNull(watchedReference, <span class="string">"watchedReference"</span>);</div><div class="line">  checkNotNull(referenceName, <span class="string">"referenceName"</span>);</div><div class="line">  <span class="keyword">final</span> <span class="keyword">long</span> watchStartNanoTime = System.nanoTime();</div><div class="line">  String key = UUID.randomUUID().toString();<span class="comment">//åˆ›å»ºä¸€ä¸ªç‹¬ä¸€æ— äºŒ key</span></div><div class="line">  retainedKeys.add(key);<span class="comment">//æ·»åŠ åˆ° retainedKeys ä¸­ </span></div><div class="line">  <span class="keyword">final</span> KeyedWeakReference reference =</div><div class="line">      <span class="keyword">new</span> KeyedWeakReference(watchedReference, key, referenceName, queue);<span class="comment">//åˆ›å»ºä¸€ä¸ª ã€Œå¸¦é”®çš„å¼±å¼•ç”¨ã€</span></div><div class="line"></div><div class="line">  ensureGoneAsync(watchStartNanoTime, reference);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-3-5retainedKeys"><a href="#2-3-5retainedKeys" class="headerlink" title="2.3.5retainedKeys"></a>2.3.5retainedKeys</h4><p><code>retainedKeys</code> ç±»å‹ä¸ºä¸€ä¸ª <code>Set&lt;String&gt;</code>ï¼Œä¸»è¦ç”¨äºåˆ¤æ–­å¯¹è±¡æ˜¯å¦è¢«å›æ”¶ã€‚</p>
<p>retainedKeys çš„æ·»åŠ ä¸åˆ é™¤</p>
<h5 id="æ·»åŠ ï¼š"><a href="#æ·»åŠ ï¼š" class="headerlink" title="æ·»åŠ ï¼š"></a>æ·»åŠ ï¼š</h5><p>ä¸€ä¸ªå¸¦é”®çš„å¼±å¼•ç”¨ï¼ˆKeyedWeakReferenceï¼‰è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œå…¶ä¸­çš„é”®ä¼šè¢«åŠ å…¥ retainedKeys ä¸­ã€‚</p>
<h5 id="åˆ é™¤ï¼š"><a href="#åˆ é™¤ï¼š" class="headerlink" title="åˆ é™¤ï¼š"></a>åˆ é™¤ï¼š</h5><p>é€šè¿‡ RefWatcher#removeWeaklyReachableReferences æ–¹æ³• å¯ä»¥åˆ é™¤ retainedKeys ä¸­é‚£äº›ä»…å«æœ‰å¼±å¼•ç”¨çš„ KeyedWeakReference å¯¹åº”çš„ keyã€‚</p>
<p>å¦‚æœä¸åœ¨ retainedKeys ä¸­è¯´æ˜è¯¥å¯¹è±¡å·²ç»è¢«å›æ”¶äº†ã€‚</p>
<h4 id="2-3-6HeapAnalyzerService"><a href="#2-3-6HeapAnalyzerService" class="headerlink" title="2.3.6HeapAnalyzerService"></a>2.3.6HeapAnalyzerService</h4><p>HeapAnalyzerService æ˜¯ä¸€ä¸ª IntentServiceï¼Œå®ƒä¼šåœ¨  onHandleIntent æ–¹æ³•ä¸­å¯¹å †è¿›è¡Œåˆ†æã€‚</p>
<p>HeapAnalyzerService#onHandleIntent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (intent == <span class="keyword">null</span>) &#123;<span class="comment">// intent ä¸ºç©ºç›´æ¥è¿”å›</span></div><div class="line">    CanaryLog.d(<span class="string">"HeapAnalyzerService received a null intent, ignoring."</span>);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  String listenerClassName = intent.getStringExtra(LISTENER_CLASS_EXTRA);<span class="comment">//è·å–å›è°ƒç±»çš„ç±»å</span></div><div class="line">  HeapDump heapDump = (HeapDump) intent.getSerializableExtra(HEAPDUMP_EXTRA);<span class="comment">//è·å– HeapDump </span></div><div class="line"></div><div class="line">  HeapAnalyzer heapAnalyzer = <span class="keyword">new</span> HeapAnalyzer(heapDump.excludedRefs);<span class="comment">//åˆ›å»º HeapAnalyzer</span></div><div class="line"></div><div class="line">  AnalysisResult result = heapAnalyzer.checkForLeak(heapDump.heapDumpFile, heapDump.referenceKey);<span class="comment">//æ£€æŸ¥æ³„æ¼ï¼ˆé€šè¿‡ HAHA æ¥å®Œæˆï¼‰ï¼Œå¹¶è·å–ç»“æœ</span></div><div class="line">  AbstractAnalysisResultService.sendResultToListener(<span class="keyword">this</span>, listenerClassName, heapDump, result);<span class="comment">//å°†åˆ†æç»“æœå‘é€ç»™ç›‘å¬å™¨</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒonHandleIntent æ–¹æ³•ä¸­ï¼Œä¼šä» Intent ä¸­è·å– HeapDump ä»¥åŠ listenerClassNameï¼ˆç›‘å¬å™¨ç±»åï¼‰ï¼Œç„¶åå°†ç›¸åº”çš„æ•°æ®äº¤ç»™ HAHA åº“ä¸­çš„ HeapAnalyzer è¿›è¡Œåˆ†æï¼Œæœ€åå°†ç»“æœå‘å›ç»™ç›‘å¬å™¨</p>
<p>æ³¨ï¼šåœ¨åˆ›å»ºå¯¹åˆ†æå™¨çš„æ—¶å€™ ä¼šä½¿ç”¨åˆ° heapDump.excludedRefsï¼ŒexcludedRefs  å®é™…ç±»å‹ä¸º AndroidExcludedRefs ï¼Œå®ƒæ˜¯ä¸€ä¸ªæšä¸¾ç±»ï¼Œå…¶ä¸­è®¾ç½®äº†ä¸€äº›ç”±äºç‰¹å®šåˆ¶é€ å•†çš„å®ç°å¼•èµ·å†…å­˜æ³„æ¼çš„ç±»ã€‚å¦‚æœå†…å­˜æ³„æ¼æ˜¯ç”±è¯¥æšä¸¾ç±»å«æœ‰çš„ç±»é”å¼•èµ·ï¼Œé‚£ä¹ˆå†…å­˜æ³„æ¼é—®é¢˜ä¼šè¢«å¿½ç•¥ã€‚</p>
<p>å¯¹äºå¤§éƒ¨åˆ†åº”ç”¨å¼€å‘è€…è€Œè¨€éƒ½åº”è¯¥ä½¿ç”¨ createAppDefaults æ–¹æ³•ï¼Œä¸è¿‡ä¹Ÿå¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ª EnumSet ï¼Œåœ¨å…¶ä¸­æŒ‡å®šè‡ªå·±è¦å¿½ç•¥çš„å†…å­˜æ³„æ¼ç±»ï¼Œå¹¶é€šè¿‡ <code>AndroidExcludedRefs#createBuilder(EnumSet)</code>æ–¹æ³•è¿›è¡Œè®¾ç½®ã€‚</p>
<h4 id="2-3-7HeapAnalyzer-checkForLeak-æ£€æµ‹å†…å­˜æ³„æ¼"><a href="#2-3-7HeapAnalyzer-checkForLeak-æ£€æµ‹å†…å­˜æ³„æ¼" class="headerlink" title="2.3.7HeapAnalyzer#checkForLeak æ£€æµ‹å†…å­˜æ³„æ¼"></a>2.3.7HeapAnalyzer#checkForLeak æ£€æµ‹å†…å­˜æ³„æ¼</h4><p>é™äºç¯‡å¹…ï¼Œä»…å¯¹ HAHA è¿›è¡Œç®€å•ä»‹ç»</p>
<p>HAHA æ˜¯ä¸€ä¸ª Java åº“ï¼Œå¯ä»¥è‡ªåŠ¨å®Œæˆå¯¹ Android å †è½¬å‚¨æ–‡ä»¶çš„åˆ†æã€‚</p>
<p>è¿™ä¸ªé¡¹ç›®å®é™…ä¸Šæ˜¯å¯¹å…¶ä»–äººçš„å·¥ä½œçš„é‡æ–°æ‰“åŒ…ï¼Œä»¥ä½¿å…¶æˆä¸ºä¸€ä¸ªå°å‹çš„ Maven ä¾èµ–é¡¹ã€‚</p>
<p>HAHA  å¯è¾¾æ€§åˆ†æç®—æ³• </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> AnalysisResult <span class="title">checkForLeak</span><span class="params">(File heapDumpFile, String referenceKey)</span> </span>&#123;</div><div class="line">  <span class="keyword">long</span> analysisStartNanoTime = System.nanoTime();</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!heapDumpFile.exists()) &#123;</div><div class="line">    Exception exception = <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File does not exist: "</span> + heapDumpFile);</div><div class="line">    <span class="keyword">return</span> failure(exception, since(analysisStartNanoTime));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    HprofBuffer buffer = <span class="keyword">new</span> MemoryMappedFileBuffer(heapDumpFile);<span class="comment">//é€šè¿‡å †è½¬å‚¨æ–‡ä»¶æ„é€ ä¸€ä¸ª MemoryMappedFileBuffer</span></div><div class="line">    HprofParser parser = <span class="keyword">new</span> HprofParser(buffer);<span class="comment">//åˆ›å»ºä¸€ä¸ª Hprof æ–‡ä»¶è§£æå™¨</span></div><div class="line">    Snapshot snapshot = parser.parse();<span class="comment">//è§£æï¼Œå°†ç»“æœèµ‹ç»™ Snapshot </span></div><div class="line">    deduplicateGcRoots(snapshot);<span class="comment">//åˆ é™¤é‡å¤çš„ GC Root </span></div><div class="line"></div><div class="line">    Instance leakingRef = findLeakingReference(referenceKey, snapshot);<span class="comment">//åˆ©ç”¨ referenceKey å’Œ  snapshot å¯»æ‰¾å‘ç”Ÿæ³„æ¼çš„å¼•ç”¨</span></div><div class="line"></div><div class="line">    <span class="comment">// False alarm, weak reference was cleared in between key check and heap dump.</span></div><div class="line">    <span class="keyword">if</span> (leakingRef == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> noLeak(since(analysisStartNanoTime));<span class="comment">//æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„æ¼</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> findLeakTrace(analysisStartNanoTime, snapshot, leakingRef);<span class="comment">//å‘ç°å†…å­˜æ³„æ¼</span></div><div class="line">  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">    <span class="keyword">return</span> failure(e, since(analysisStartNanoTime));<span class="comment">//</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>å¾—ç›Šäºå”¯ä¸€çš„ reference key, <code>HeapAnalyzer</code> æ‰¾åˆ° <code>KeyedWeakReference</code>ï¼Œå®šä½å†…å­˜æ³„æ¼ã€‚</li>
<li><code>HeapAnalyzer</code> è®¡ç®— <em>åˆ° GC roots çš„æœ€çŸ­å¼ºå¼•ç”¨è·¯å¾„</em>ï¼Œå¹¶ç¡®å®šæ˜¯å¦æ˜¯æ³„æ¼ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œå»ºç«‹å¯¼è‡´æ³„æ¼çš„å¼•ç”¨é“¾ã€‚</li>
</ol>
<h2 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h2><p>å†…å­˜æ³„æ¼çš„æœ¬è´¨æ˜¯é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æŒæœ‰çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œå¯¼è‡´çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ä½¿ç”¨å®Œäº†ä¹‹åæ— æ³•è¢«å›æ”¶ã€‚ä¹Ÿå°±æ˜¯åº”è¯¥è¢«å›æ”¶çš„å¯¹è±¡æ²¡æœ‰è¢«å›æ”¶ã€‚<br>é‚£ä¹ˆé—®é¢˜å°±å˜æˆäº†ä»€ä¹ˆå¯¹è±¡æ˜¯åº”è¯¥è¢«å›æ”¶çš„å¯¹è±¡å‘¢ï¼Ÿå¯¹äº Activity è€Œè¨€ï¼Œæ‰§è¡Œå®Œ onDestroy æ–¹æ³•ä¹‹åï¼Œå°±æ˜¯åº”è¯¥è¢«å›æ”¶äº†ã€‚å› æ­¤å¯ä»¥å°† Activity#ondestroy æ–¹æ³•ä½œä¸ºä¸€ä¸ªæ£€æµ‹ç‚¹ã€‚Application ä¸­æä¾›äº†å„ä¸ª Activity çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•çš„ç›‘å¬ï¼ŒLeakCanary å°±æ˜¯é€šè¿‡æ³¨å†Œ  <code>ActivityLifecycleCallbacks</code> ï¼Œç›‘å¬ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„å›è°ƒï¼Œä½œä¸ºæ•´ä¸ªå†…å­˜æ³„æ¼åˆ†æçš„å…¥å£ã€‚</p>
<p>æ¯æ¬¡ <code>onActivityDestroyed(Activity activity)</code> æ–¹æ³•è¢«å›è°ƒä¹‹å,éƒ½ä¼šåˆ›å»ºä¸€ä¸ª <code>KeyedWeakReference</code> å¯¹ç›¸åº” Activity çš„çŠ¶æ€è¿›è¡Œè·Ÿè¸ªï¼Œæ‰‹åŠ¨è°ƒç”¨ gcï¼Œåå°çº¿ç¨‹ï¼ˆHandlerThread ï¼‰æ£€æŸ¥å¼•ç”¨æ˜¯å¦è¢«æ¸…é™¤ï¼Œå¦‚æœæ²¡æœ‰å°±æ‰‹åŠ¨è°ƒç”¨ä¸€æ¬¡ gcï¼Œå¦‚æœè¿™æ—¶è¿˜æ˜¯æ²¡æœ‰è¢«æ¸…é™¤ï¼ŒæŠŠ heap å†…å­˜ dump åˆ° APP å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ª <code>.hprof</code> æ–‡ä»¶ä¸­ã€‚åœ¨å¦ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ <code>HeapAnalyzerService</code>  ä¸­ï¼Œ  HeapAnalyzer ä¼šé€šè¿‡ haha å¼€æºåº“å¯¹æ–‡ä»¶è¿›è¡Œåˆ†æã€‚    å¾—ç›Šäºå”¯ä¸€çš„ reference key,  <code>HeapAnalyzer</code>  æ‰¾åˆ° <code>KeyedWeakReference</code>ï¼Œå®šä½å†…å­˜æ³„æ¼ã€‚<code>HeapAnalyzer</code> è®¡ç®— <em>åˆ° GC roots çš„<strong>æœ€çŸ­å¼ºå¼•ç”¨è·¯å¾„</strong></em>ï¼Œå¹¶ç¡®å®šæ˜¯å¦æ˜¯æ³„æ¼ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œå»ºç«‹å¯¼è‡´æ³„æ¼çš„å¼•ç”¨é“¾ã€‚å¼•ç”¨é“¾ä¼ é€’åˆ° APP è¿›ç¨‹ä¸­çš„ <code>DisplayLeakService</code>ï¼Œ å¹¶ä»¥é€šçŸ¥çš„å½¢å¼å±•ç¤ºå‡ºæ¥ã€‚</p>
<h3 id="è¿›é˜¶ä½¿ç”¨ï¼š"><a href="#è¿›é˜¶ä½¿ç”¨ï¼š" class="headerlink" title="è¿›é˜¶ä½¿ç”¨ï¼š"></a>è¿›é˜¶ä½¿ç”¨ï¼š</h3><p>äº†è§£ LeakCanary çš„åŸç†ä¹‹åï¼Œå‘ç°å…¶å®å®ƒå°±æ˜¯åœ¨å¯¹è±¡ä¸å¯ç”¨çš„æ—¶å€™å»åˆ¤æ–­å¯¹è±¡æ˜¯å¦è¢«å›æ”¶äº†ï¼Œä½† LeakCanary åªæ£€æŸ¥äº† Activityï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥æ£€æŸ¥å…¶ä»–å¯¹è±¡å‘¢ï¼Œæ¯•ç«Ÿ Activity æ³„æ¼åªæ˜¯å†…å­˜æ³„æ¼çš„ä¸€ç§ï¼Œç­”æ¡ˆå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬åªè¦éœ€è¦è¿›è¡Œå¦‚ä¸‹æ“ä½œ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LeakCanary.install(app).watch(object)</div></pre></td></tr></table></figure>
<p>ä½†æˆ‘ä»¬åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™<strong>éœ€è¦ç¡®å®šè¿™ä¸ª object å·²ç»ä¸éœ€è¦äº†ï¼Œå¯ä»¥è¢«å›æ”¶äº†</strong>ã€‚é€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å°±å¯ä»¥<strong>å¯¹ä»»ä½•å¯¹è±¡éƒ½è¿›è¡Œæ£€æµ‹</strong>äº†ã€‚</p>
<h2 id="å››ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å››ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å››ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å››ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="www.jianshu.com/p/3f1a1cc1e964">LeakCanary åŸç†æµ…æ</a></li>
<li><a href="https://www.liaohuqiu.net/cn/posts/leak-canary-read-me/" target="_blank" rel="noopener">LeakCanary ä¸­æ–‡ä½¿ç”¨è¯´æ˜</a></li>
<li><a href="https://hongjiang.info/java-referencequeue/" target="_blank" rel="noopener">è¯è¯´ ReferenceQueue</a></li>
<li><a href="https://www.jianshu.com/p/f86d3a43eec5" target="_blank" rel="noopener">Reference ã€ReferenceQueue è¯¦è§£</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®æ¬¢è¿åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè¯·å¯¹é—®é¢˜æè¿°å°½é‡è¯¦ç»†ï¼Œä»¥å¸®åŠ©æˆ‘å¯ä»¥å¿«é€Ÿæ‰¾åˆ°é—®é¢˜æ ¹æºã€‚è°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> æºç åˆ†æ </category>
            
            <category> æ¡†æ¶åŸç† </category>
            
        </categories>
        
        
        <tags>
            
            <tag> æºç åˆ†æ </tag>
            
            <tag> æ¡†æ¶åŸç† </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æ‹†è½®å­ç³»åˆ—â€”â€”LitePal åŸç†è§£æ]]></title>
      <url>https://timlin-pro.github.io/blog/2017/12/03/%E6%8B%86%E8%BD%AE%E5%AD%90%E7%B3%BB%E5%88%97%E2%80%94%E2%80%94litepal-%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/</url>
      <content type="html"><![CDATA[<h2 id="LitePal-è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ"><a href="#LitePal-è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ" class="headerlink" title="LitePal è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ"></a>LitePal è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h2><blockquote>
<p>  LitePal é‡‡å–çš„æ˜¯å¯¹è±¡å…³ç³»æ˜ å°„(ORM)çš„æ¨¡å¼ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯å¯¹è±¡å…³ç³»æ˜ å°„å‘¢ï¼Ÿç®€å•ç‚¹è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€æ˜¯é¢å‘å¯¹è±¡è¯­è¨€ï¼Œè€Œæˆ‘ä»¬ä½¿ç”¨çš„æ•°æ®åº“åˆ™æ˜¯å…³ç³»å‹æ•°æ®åº“ï¼Œé‚£ä¹ˆå°†é¢å‘å¯¹è±¡çš„è¯­è¨€å’Œé¢å‘å…³ç³»çš„æ•°æ®åº“ä¹‹é—´å»ºç«‹ä¸€ç§æ˜ å°„å…³ç³»ï¼Œè¿™å°±æ˜¯å¯¹è±¡å…³ç³»æ˜ å°„äº†ã€‚</p>
<p>  ä½†æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¯¹è±¡å…³ç³»æ˜ å°„æ¨¡å¼å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯å› ä¸ºå¤§å¤šæ•°çš„ç¨‹åºå‘˜éƒ½å¾ˆæ“…é•¿é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œä½†å…¶ä¸­åªæœ‰å°‘éƒ¨åˆ†çš„äººæ‰æ¯”è¾ƒç²¾é€šå…³ç³»å‹æ•°æ®åº“ã€‚è€Œä¸”æ•°æ®åº“çš„ SQL è¯­è¨€æ™¦æ¶©éš¾æ‡‚ï¼Œå°±ç®—ä½ å¾ˆç²¾é€šå®ƒï¼Œææ€•ä¹Ÿä¸å–œæ¬¢ç»å¸¸åœ¨ä»£ç ä¸­å»å†™å®ƒå§ï¼Ÿè€Œå¯¹è±¡å…³ç³»æ˜ å°„æ¨¡å¼åˆ™å¾ˆå¥½åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ¥æ“ä½œæ•°æ®åº“ï¼Œä»è€Œå¯ä»¥ä»æ™¦æ¶©éš¾æ‡‚çš„ SQL è¯­è¨€ä¸­è§£è„±å‡ºæ¥ã€‚</p>
</blockquote>
<a id="more"></a>
<p>Android å·²ç»ä¸ºæˆ‘ä»¬æä¾›äº† SQLiteOpenHelper ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆæ•°æ®åº“çš„åˆ›å»ºã€è¡¨çš„åˆ›å»ºã€ä»¥åŠæ•°æ®çš„ CRUD æ“ä½œã€‚ä½†æ˜¯ä½¿ç”¨èµ·æ¥è¿˜æ˜¯ä¸å¤Ÿæ–¹ä¾¿ã€‚å»ºç«‹æ•°æ®åº“éœ€è¦ç»§æ‰¿ SQLiteOpenHelper é‡å†™ç›¸åº”çš„æ–¹æ³•ï¼ŒåŒæ—¶ä¸ºäº†æ–¹ä¾¿åç»­çš„æ“ä½œï¼Œæˆ‘ä»¬æ¯åˆ›å»ºä¸€å¼ è¡¨ï¼Œéƒ½è¦ä¸€ä¸ªç›¸åº”çš„ DAO ç±»ï¼Œå®Œæˆç›¸åº”è¡¨çš„ CRUD æ“ä½œã€‚åŠ åœ¨ä¸€èµ·å·¥ä½œé‡çœŸçš„ä¸å°ã€‚</p>
<p>å¦‚æœä½¿ç”¨ LitePalï¼Œåªéœ€è¦å»ºç«‹ä¸€ä¸ª xml é…ç½®æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­æŒ‡å®šæ•°æ®åº“åç§°ã€ç‰ˆæœ¬å·ï¼Œä»¥åŠéœ€è¦è¿›è¡Œæ˜ å°„çš„ç±»åï¼Œç„¶åè®© App çš„ Application ç±»ç»§æ‰¿ LitePalApplication è¿›è¡Œåˆå§‹åŒ–ï¼Œå°±å¯ä»¥å®Œæˆæ•°æ®åº“ã€è¡¨çš„åˆ›å»ºå·¥ä½œã€‚åŒæ—¶ï¼Œæ•°æ®çš„ CRUD æ“ä½œåªéœ€è¦é€šè¿‡ DataSupport çš„ç›¸åº”æ–¹æ³•å°±èƒ½å®Œæˆã€‚è¿™æ ·å·¥ä½œé‡æ˜¯ä¸æ˜¯å°‘äº†å¾ˆå¤šã€‚</p>
<h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><p>æ–‡æ¡£ä¸­å»ºè®®é€šè¿‡å°†åœ¨ Manifest æ–‡ä»¶ä¸­æŒ‡å®š application ä¸º LitePalApplication  æˆ–è€…é€šè¿‡ç»§æ‰¿ LitePalApplication æ¥å®ç°åˆå§‹åŒ–ã€‚åˆå§‹åŒ–çš„ç›®çš„ä¸ºäº†æ–¹ä¾¿è·å– Context å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LitePalApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line">  </div><div class="line">   <span class="keyword">static</span> Context sContext;</div><div class="line">  </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">LitePalApplication</span><span class="params">()</span> </span>&#123;<span class="comment">//é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œåˆå§‹åŒ– Context é™æ€å˜é‡</span></div><div class="line">      sContext = <span class="keyword">this</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="æ•°æ®åº“çš„åˆ›å»º"><a href="#æ•°æ®åº“çš„åˆ›å»º" class="headerlink" title="æ•°æ®åº“çš„åˆ›å»º"></a>æ•°æ®åº“çš„åˆ›å»º</h2><p>æŸ¥çœ‹æ–‡æ¡£è¯´æ˜ï¼Œæˆ‘ä»¬å‘ç° table çš„åˆ›å»ºå’Œä¿®æ”¹éƒ½æ˜¯è‡ªåŠ¨å®ç°çš„ã€‚å¯¹å¤–å…¬å¼€çš„ä¸»è¦æ˜¯å¯¹æ•°æ®çš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å°±é¡ºç€å¯¹æ•°æ®çš„æ“ä½œæ¥åˆ†æã€‚è€Œè¿›è¡Œæ“ä½œçš„å‰ææ˜¯è¡¨ä¸­æœ‰æ•°æ®ï¼Œæˆ‘ä»¬å°±ä»æ’å…¥æ“ä½œï¼ˆå¯¹åº” save æ–¹æ³•ï¼‰çœ‹èµ·ã€‚</p>
<p><code>DataSupport#save()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">  	  <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">      saveThrows();    </div><div class="line">  	  <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>save ä¼šè°ƒç”¨ saveThrows æ–¹æ³•ï¼Œ</p>
<p><code>DataSupport#saveThrows</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">saveThrows</span><span class="params">()</span> </span>&#123;</div><div class="line">   SQLiteDatabase db = Connector.getDatabase();<span class="comment">//è·å–æ•°æ®åº“</span></div><div class="line"><span class="comment">//ä»£ç çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>saveThrows æ–¹æ³•ä¸­é¦–å…ˆè°ƒç”¨äº† Connector.getDatabase() è·å–æ•°æ®åº“ã€‚</p>
<h3 id="Connector-getDatabase"><a href="#Connector-getDatabase" class="headerlink" title="Connector#getDatabase()"></a>Connector#getDatabase()</h3><p><code>Connector#getDatabase</code>ä¸»è¦è°ƒç”¨æµç¨‹å¦‚ä¸‹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Connector#getDatabase	</div><div class="line">	 --&gt; getWritableDatabase</div><div class="line">	 	--&gt; buildConnection //è·å– LitePalOpenHelper ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ª SQLiteOpenHelperï¼‰</div><div class="line">	 		 --&gt; LitePalAttr.getInstance();//è·å–å•ä¾‹å¯¹è±¡</div><div class="line">	 		 	 --&gt; LitePalAttr = new LitePalAttr();//åˆ›å»º LitePalAttr</div><div class="line">                  --&gt; loadLitePalXMLConfiguration();//åŠ è½½ liepal.xml é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®</div><div class="line">                  	 --&gt; LitePalParser.parseLitePalConfiguration() //é¦–å…ˆè¿›è¡Œè§£æ</div><div class="line">                  	 --&gt; //å°†è§£æåˆ°çš„æ•°æ®ï¼ˆ æ•°æ®åº“åã€æ•°æ®åº“ç‰ˆæœ¬å·ã€éœ€è¦æ˜ å°„ä¸ºè¡¨çš„ç±»åã€æ˜¯å¦å¤§å°å†™æ•æ„Ÿã€å­˜å‚¨è·¯å¾„ ï¼‰èµ‹å€¼ç»™ LitePalAttr ä¸­çš„å­—æ®µ</div><div class="line">			 --&gt; LitePalAttr.checkSelfValid();//å‚æ•°åˆæ³•æ€§æ£€æŸ¥</div><div class="line">			 --&gt; //æ„é€ å­˜å‚¨è·¯å¾„	</div><div class="line">			 --&gt; //åˆ›å»º LitePalOpenHelper</div><div class="line">	 	--&gt; SQLiteOpenHelper#getWritableDatabase</div></pre></td></tr></table></figure>
<p>è™½ç„¶ LitePal å·ç§°é›¶é…ç½®ï¼Œä½†æ˜¯åŸºç¡€çš„å‡†å¤‡å·¥ä½œè¿˜æ˜¯éœ€è¦åšçš„ã€‚æŒ‰ç…§å®˜æ–¹æ•™ç¨‹ï¼Œåœ¨ä½¿ç”¨ LitePal ä¹‹å‰ï¼Œéœ€è¦åœ¨ res ç›®å½•ä¸‹é¢åˆ›å»ºä¸€ä¸ª xml ç›®å½•ï¼Œç„¶ååœ¨è¯¥ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º LitePal çš„ xml æ–‡ä»¶ã€‚ä¸¾ä¸ªæ —å­ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">LitePal</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--æ•°æ®åº“å--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dbname</span> <span class="attr">value</span>=<span class="string">"library"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!--ç‰ˆæœ¬å·--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></div><div class="line">    <span class="comment">&lt;!--æ˜ å°„è¡¨--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapping</span> <span class="attr">class</span>=<span class="string">"com.android.rdc.librarysystem.bean.Book"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapping</span> <span class="attr">class</span>=<span class="string">"com.android.rdc.librarysystem.bean.BookType"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapping</span> <span class="attr">class</span>=<span class="string">"com.android.rdc.librarysystem.bean.Borrow"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">LitePal</span>&gt;</span></div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„ <code>dbname</code> æ ‡ç­¾å°±æ˜¯ç”¨äºæŒ‡å®šæ•°æ®åº“åçš„ã€‚</p>
<p><code>Connector#buildConnection</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> LitePalOpenHelper <span class="title">buildConnection</span><span class="params">()</span> </span>&#123;</div><div class="line">   LitePalAttr LitePalAttr = LitePalAttr.getInstance(); <span class="comment">//è·å–å•ä¾‹å¯¹è±¡â€”â€”LitePalAttr </span></div><div class="line">   LitePalAttr.checkSelfValid();<span class="comment">//å‚æ•°åˆæ³•æ€§æ£€æŸ¥</span></div><div class="line">   <span class="keyword">if</span> (mLitePalHelper == <span class="keyword">null</span>) &#123;</div><div class="line">      String dbName = LitePalAttr.getDbName();<span class="comment">//</span></div><div class="line">    		   <span class="comment">//â€¦â€¦çœç•¥è·¯å¾„å¤„ç†ä»£ç </span></div><div class="line">               dbName = dbPath + <span class="string">"/"</span> + dbName;</div><div class="line">           </div><div class="line">      mLitePalHelper = <span class="keyword">new</span> LitePalOpenHelper(dbName, LitePalAttr.getVersion());<span class="comment">//</span></div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> mLitePalHelper;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–æ¬¡è¿æ¥æ•°æ®åº“æ—¶ï¼ŒLitePal ä¼šé€šè¿‡ <code>LitePalParser#parseLitePalConfiguration();</code>æ–¹æ³•å¯¹ xml é…ç½®æ–‡ä»¶è¿›è¡Œè§£æã€‚å¤§ä½“æµç¨‹å°±æ˜¯ä½¿ç”¨ <code>XmlPullParser</code> å¯¹ xml æ–‡ä»¶çš„è§£æï¼Œè§£æå®Œæˆä¹‹åï¼Œå°±å°†ç»“æœä¿å­˜åœ¨ <code>LitePalConfig</code>ç±»ä¸­ã€‚ LitePalConfig ç±»å­—æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LitePalConfig</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> version;<span class="comment">//æ•°æ®åº“ç‰ˆæœ¬å·</span></div><div class="line">    <span class="keyword">private</span> String dbName;<span class="comment">//æ•°æ®åº“å</span></div><div class="line">    <span class="keyword">private</span> String cases;<span class="comment">//æ•°æ®åº“å¤§å°å†™æ•æ„Ÿæ€§</span></div><div class="line">    <span class="keyword">private</span> String storage;<span class="comment">//æ•°æ®åº“æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„ï¼Œå¯é€‰æ‹©å†…éƒ¨å­˜å‚¨æˆ–è€…å¤–éƒ¨å­˜å‚¨</span></div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; classNames;<span class="comment">//éœ€è¦è¿›è¡Œæ˜ å°„çš„æ¨¡å‹ç±»ï¼Œæ¯ä¸€ä¸ªç±»åéƒ½éœ€è¦ç»™å…¨åï¼ˆåŒ…æ‹¬åŒ…åï¼‰</span></div><div class="line"> 	<span class="comment">//ä»£ç çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æ³¨ï¼šå¤§å°å†™æ•æ„Ÿ"><a href="#æ³¨ï¼šå¤§å°å†™æ•æ„Ÿ" class="headerlink" title="æ³¨ï¼šå¤§å°å†™æ•æ„Ÿ"></a>æ³¨ï¼šå¤§å°å†™æ•æ„Ÿ</h4><p>SQLite æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œå…·ä½“ï¼š</p>
<ol>
<li>åˆ›å»ºè¡¨ã€åˆ—çš„æ—¶å€™ï¼ŒSQL è¯­å¥é‡Œæ˜¯ä»€ä¹ˆå¤§å°å†™ï¼Œè¡¨åã€åˆ—åå°±æ˜¯ä»€ä¹ˆå¤§å°å†™ï¼›</li>
<li>SQL è¯­å¥æ‰§è¡Œçš„æ—¶å€™ï¼š==è¡¨åã€åˆ—åå¤§å°å†™ä¸æ•æ„Ÿï¼Œéƒ½èƒ½è¯†åˆ«==ï¼›</li>
<li>SQL è¯­å¥é‡Œé¢ï¼Œâ€œ=â€è¿˜æ˜¯ LIKE éƒ½æ˜¯å¤§å°å†™æ•æ„Ÿï¼›</li>
</ol>
<h3 id="buildConnection"><a href="#buildConnection" class="headerlink" title="buildConnection"></a>buildConnection</h3><p><code>buildConnection</code> æ–¹æ³•é¦–å…ˆä¼šå»è·å– LitePalAttr å•ä¾‹å¯¹è±¡ï¼ˆé¦–æ¬¡è°ƒç”¨ä¼šè§¦å‘è§£æ LitePal.xml æ–‡ä»¶ï¼‰ï¼Œç„¶åæ£€æŸ¥å‚æ•°åˆæ³•æ€§ï¼Œå¹¶æ ¹æ®è§£æå¾—åˆ°çš„ LitePalAttr  ä¸­çš„å­—æ®µåˆ›å»ºä¸€ä¸ª LitePalOpenHelperã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œæ•°æ®åº“å·²ç»åˆ›å»ºå®Œæˆäº†ã€‚é‚£ä¹ˆæ•°æ®åº“ä¸­çš„<strong>è¡¨æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„</strong>å‘¢ï¼Ÿå›åˆ°å‰é¢çš„ saveThrows æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨è·å–æ•°æ®åº“ä¹‹åå°±å¼€å§‹åšä¿å­˜å·¥ä½œäº†ï¼ˆè¡¨åˆ›å»ºå·¥ä½œä¸åº”è¯¥æ”¾åœ¨ ä¿å­˜å·¥ä½œè¿‡ç¨‹ä¸­ï¼Œå› ä¸ºè¿™æ ·ä¸åˆç†ï¼‰ã€‚å› æ­¤ï¼Œè¡¨å¾ˆå¯èƒ½å°±æ˜¯åœ¨æ•°æ®åº“åˆ›å»ºè¿‡ç¨‹ä¸­é¡ºä¾¿åˆ›å»ºçš„ã€‚å®é™…ä¸Šä¹Ÿç¡®å®å¦‚æ­¤ã€‚</p>
<h3 id="LitePalOpenHelper-onCreate-è°ƒç”¨é“¾"><a href="#LitePalOpenHelper-onCreate-è°ƒç”¨é“¾" class="headerlink" title="LitePalOpenHelper#onCreate è°ƒç”¨é“¾"></a><code>LitePalOpenHelper#onCreate</code> è°ƒç”¨é“¾</h3><p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">LitePalOpenHelper#onCreate//æ•°æ®åº“ onCreate å›è°ƒæ–¹æ³•</div><div class="line">   --&gt; Generator#create()</div><div class="line">  	 	--&gt; create(db, true);</div><div class="line">			 --&gt; new Creator();</div><div class="line">			 --&gt; creator.createOrUpgradeTable(db, force);		</div><div class="line">				 --&gt; è¿­ä»£è°ƒç”¨ createOrUpgradeTable(tableModel, db, force);</div><div class="line">						--&gt; getCreateTableSQLs(tableModel, db, force) //æ‹¼æ¥å»ºè¡¨ sql è¯­å¥ï¼Œå­˜å‚¨åœ¨ ArrayList ä¸­</div><div class="line">						--&gt; execute();	</div><div class="line">							 --&gt; è¿­ä»£è°ƒç”¨ db.execSQL() æ‰§è¡Œ SQL è¯­å¥</div><div class="line">						--&gt; AssociationCreator#giveTableSchemaACopy</div><div class="line">	 	--&gt; addAssociation(db, true);</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çœ‹ä¸‹ getCreateTableSQLs æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå…ˆç”Ÿæˆåˆ é™¤è¡¨çš„è¯­å¥ sqlï¼Œç„¶åå†ç”Ÿæˆåˆ›å»ºè¡¨çš„è¯­å¥ï¼Œå¹¶å°†å®ƒä»¬æŒ‰åºå­˜åœ¨ ArrayList ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡å»ºè¡¨ä¹‹å‰å…ˆå°è¯•åˆ é™¤åŒåçš„è¡¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCreateTableSQLs</span><span class="params">(TableModel tableModel, SQLiteDatabase db, <span class="keyword">boolean</span> force)</span> </span>&#123;</div><div class="line">       List&lt;String&gt; sqls = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">   <span class="keyword">if</span> (force) &#123;</div><div class="line">           sqls.add(generateDropTableSQL(tableModel));</div><div class="line">           sqls.add(generateCreateTableSQL(tableModel));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">if</span> (DBUtility.isTableExists(tableModel.getTableName(), db)) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">               sqls.add(generateCreateTableSQL(tableModel));</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">       <span class="keyword">return</span> sqls;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è‡³æ­¤æ•°æ®åº“å’Œè¡¨åˆ›å»ºå®Œæ¯•ã€‚</p>
<h2 id="dataSupport-save-çš„èƒŒå"><a href="#dataSupport-save-çš„èƒŒå" class="headerlink" title="dataSupport#save() çš„èƒŒå"></a>dataSupport#save() çš„èƒŒå</h2><p>å…ˆçœ‹ä¸‹æ•´ä½“çš„è°ƒç”¨æµç¨‹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">datasupport#save</div><div class="line"> --&gt; saveThrows</div><div class="line"> 	 --&gt; åˆ›å»º SaveHanlder </div><div class="line">	 --&gt; è°ƒç”¨ SaveHanlder#onSave</div><div class="line">	 	 --&gt; getSupportedFields//è·å–æ”¯æŒåŸŸ</div><div class="line">		 --&gt; getSupportedGenericFields//è·å–æ”¯æŒçš„æ³›å‹åŸŸ</div><div class="line">		 --&gt; getAssociationInfo//è·å–å…³è”å…³ç³»</div><div class="line">	 	 --&gt; if(baseObjId &gt; 0)  doUpdateAction//æ‰§è¡Œæ›´æ–°æ“ä½œ</div><div class="line">	 	 --&gt; else doSaveAction</div><div class="line">	 	 	 --&gt; values.clear();//æ¸…ç©º ContentValue</div><div class="line">	 	 	 --&gt; beforeSave();//å­˜æ”¾å€¼ï¼ˆå¯¹è±¡æœ¬èº«çš„å€¼ä¸å¤–é”®ï¼‰</div><div class="line">	 	 	 --&gt; long id = saving();</div><div class="line">				 --&gt; SQLiteDatabase#insert()// å°†è®°å½•æ’å…¥æ•°æ®åº“</div><div class="line">                   	 --&gt; SQLiteDatabase#insertWithOnConflict()//æ‹¼æ¥ sql è¯­å¥ </div><div class="line">			 --&gt; afterSave() 	 	 </div><div class="line"> 	 --&gt; clearAssociatedData();//æ¸…é™¤æ‰€æœ‰çš„å…³è”æ•°æ®</div><div class="line">	 --&gt; SQLiteDatabase#setTransactionSuccessful();//è®¾ç½®äº‹åŠ¡æˆåŠŸ</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      saveThrows();</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LitePal æ–‡æ¡£ä¸­å¯¹ save æ–¹æ³•çš„è¯´æ˜å¦‚ä¸‹:</p>
<blockquote>
<p>  å¦‚æœæ˜¯ä¸€æ¡æ–°è®°å½•ï¼Œåˆ™æ’å…¥ä¸€ä¸ªæ–°çš„è¡Œã€‚å¦‚æœä¿å­˜è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œæ•´ä¸ªæ“ä½œå–æ¶ˆï¼Œç›¸åº”çš„ä¿®æ”¹ä¼šå›æ»šã€‚å¦‚æœæ•°æ®ç±»ä¸­å«æœ‰åä¸º id æˆ–è€… _id å¹¶ä¸”ç±»å‹ä¸º int / long çš„å­—æ®µï¼Œé‚£ä¹ˆåœ¨è¯¥å¯¹è±¡è¢«ä¿å­˜ä¹‹åå®ƒä»¬ä¼šè¢«èµ‹äºˆç›¸åº”çš„  id å€¼ã€‚ï¼ˆä¸ DataSupport ç±»ä¸­çš„ baseObjId ç›¸åŒï¼‰</p>
</blockquote>
<p>ä» synchronized å¯ä»¥çœ‹å‡º save æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚å®ƒåœ¨å†…éƒ¨è°ƒç”¨äº† saveThrows æ–¹æ³•ã€‚å¦‚æœæ•è·åˆ°å¼‚å¸¸å°± return falseï¼›å¦åˆ™ return true è¡¨ç¤ºä¿å­˜æˆåŠŸã€‚</p>
<h3 id="saveThrows"><a href="#saveThrows" class="headerlink" title="saveThrows"></a>saveThrows</h3><p><code>DataSupport#saveThrows</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">saveThrows</span><span class="params">()</span> </span>&#123;</div><div class="line">   SQLiteDatabase db = Connector.getDatabase();<span class="comment">//è·å–æ•°æ®åº“</span></div><div class="line">   db.beginTransaction();<span class="comment">//å¼€å§‹äº‹åŠ¡</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      SaveHandler saveHandler = <span class="keyword">new</span> SaveHandler(db);<span class="comment">//åˆ›å»º SaveHandlerï¼Œæ„é€ æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª ContentValues </span></div><div class="line">      saveHandler.onSave(<span class="keyword">this</span>);<span class="comment">//ä¿å­˜</span></div><div class="line">      clearAssociatedData();<span class="comment">//æ¸…é™¤å…³è”æ•°æ®</span></div><div class="line">      db.setTransactionSuccessful();<span class="comment">//äº‹åŠ¡æˆåŠŸ</span></div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> DataSupportException(e.getMessage(), e);</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      db.endTransaction();<span class="comment">//ç»“æŸäº‹åŠ¡</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>saveThrows æ–¹æ³•ä¸­ä½¿ç”¨äº†äº‹åŠ¡ä¿è¯äº†æ•°æ®çš„åŸå­æ€§ã€‚ä¸è¿‡å®ƒæ²¡æœ‰åšå…·ä½“çš„ä¿å­˜å·¥ä½œï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª SaveHandler ç„¶åå°†è‡ªèº«çš„å¼•ç”¨ä¼ é€’ç»™ onSave æ–¹æ³•ã€‚</p>
<h3 id="SaveHandler"><a href="#SaveHandler" class="headerlink" title="SaveHandler"></a>SaveHandler</h3><p>ç»§æ‰¿ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://user-images.githubusercontent.com/16668676/33593102-d1bd9cb6-d9c8-11e7-94fe-38117ed0ee50.png" alt="image"></p>
<p><strong>DataHandler</strong> æ˜¯ CRUD ç»„ä»¶çš„åŸºç±»ã€‚é‡Œé¢å®šä¹‰äº†ä¸€äº› CRUD æ“ä½œæ‰€éœ€è¦é€šç”¨æ–¹æ³•ã€‚DataHandler ä¸­åˆç»§æ‰¿è‡ª<strong>LitePalBase</strong>ã€‚LitePalBase æ˜¯æ‰€æœ‰ çš„ LitePal ç»„ä»¶çš„åŸºç±»ã€‚ä¸»è¦æ˜¯ç»™æœ‰å¦‚ä¸‹éœ€æ±‚çš„ç»„ä»¶æä¾›è§£å†³æ–¹æ¡ˆï¼šâ‘ éœ€è¦ä¸å…¶ä»–ç»„ä»¶è¿›è¡Œäº¤äº’çš„ç»„ä»¶â‘¡æœ‰é€šç”¨çš„é€»è¾‘ä»£ç çš„ç»„ä»¶ã€‚</p>
<p><strong>SaveHandler</strong> ç»§æ‰¿è‡ª DataHandlerã€‚ä»ç»§æ‰¿å…³ç³»å›¾ä¸­å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ CRUD æ“ä½œéƒ½æœ‰ç›¸åº”çš„ Handler ã€‚è€Œä¸”ä»–ä»¬éƒ½ç»§æ‰¿è‡ª DataHandlerã€‚æ˜¯ DataSupport ä¸‹é¢çš„ä¸€ä¸ªç»„ä»¶ã€‚SaveHandler å¤„ç†ä¿å­˜çš„å·¥ä½œã€‚æ‰€æœ‰çš„å®ç°åŸºäºæ‰€æœ‰çš„å®ç°éƒ½åŸºäº java åå°„ API å’Œ Android SQLiteDatabase APIã€‚å®ƒå¦‚æœå…³è”æ¨¡å‹å·²ç»å­˜å‚¨äº†ï¼Œå®ƒä¼šè‡ªåŠ¨åœ¨å½“å‰æ¨¡å‹ä¸å…³è”æ¨¡å‹ä¹‹é—´å»ºç«‹å…³ç³»ã€‚</p>
<p><code>SaveHandler#onSave</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">onSave</span><span class="params">(DataSupport baseObj)</span> <span class="keyword">throws</span> SecurityException, IllegalArgumentException,</span></div><div class="line">      NoSuchMethodException, IllegalAccessException, InvocationTargetException &#123;</div><div class="line">   String className = baseObj.getClassName();<span class="comment">//è·å–è¦ä¿å­˜å¯¹è±¡çš„ç±»å</span></div><div class="line">   List&lt;Field&gt; supportedFields = getSupportedFields(className);<span class="comment">//è·å–æ”¯æŒçš„å­—æ®µ</span></div><div class="line">       List&lt;Field&gt; supportedGenericFields = getSupportedGenericFields(className);<span class="comment">//è·å–æ”¯æŒçš„æ³›å‹ä¿¡æ¯</span></div><div class="line">   Collection&lt;AssociationsInfo&gt; associationInfos = getAssociationInfo(className);<span class="comment">//è·å–å…³è”ä¿¡æ¯</span></div><div class="line">   <span class="keyword">if</span> (!baseObj.isSaved()) &#123;</div><div class="line">           <span class="keyword">if</span> (!ignoreAssociations) &#123;</div><div class="line">               analyzeAssociatedModels(baseObj, associationInfos);</div><div class="line">           &#125;</div><div class="line">      doSaveAction(baseObj, supportedFields, supportedGenericFields);<span class="comment">//å¯¹ id å€¼&lt;=0 å¯¹è±¡æ‰§è¡Œä¿å­˜æ“ä½œ</span></div><div class="line">           <span class="keyword">if</span> (!ignoreAssociations) &#123;</div><div class="line">               analyzeAssociatedModels(baseObj, associationInfos);</div><div class="line">           &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">if</span> (!ignoreAssociations) &#123;</div><div class="line">               analyzeAssociatedModels(baseObj, associationInfos);</div><div class="line">           &#125;</div><div class="line">      doUpdateAction(baseObj, supportedFields, supportedGenericFields);<span class="comment">//å¯¹è±¡æœ¬èº«å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> onSave æ–¹æ³•ä¼šå…ˆå»æ”¶é›† LitePal æ”¯æŒçš„ç±»å‹å’ŒåŸºç¡€ç±»å‹çš„ Filed å¹¶å°†å®ƒä»¬åˆ†åˆ«å­˜åœ¨ä¸¤ä¸ª List ä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šè·å–å…³è”ä¿¡æ¯ã€‚ç„¶åé€šè¿‡åˆ¤æ–­å¯¹è±¡çš„ baseObjid &gt; 0 æ˜¯å¦æˆç«‹ï¼Œä¸æˆç«‹ï¼Œè¯´æ˜å¯¹è±¡æ˜¯ä¸€ä¸ªæœªä¿å­˜çš„å¯¹è±¡ï¼Œæ‰§è¡Œ doSaveAction æ–¹æ³•ï¼›å¦åˆ™è°ƒç”¨ doUpdateAction æ–¹æ³•ã€‚</p>
<p><code>LitePalBase#getSupportedFields</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> List&lt;Field&gt; <span class="title">getSupportedFields</span><span class="params">(String className)</span> </span>&#123;</div><div class="line">       List&lt;Field&gt; fieldList = classFieldsMap.get(className);<span class="comment">//å°è¯•ä»ç¼“å­˜ä¸­è·å–</span></div><div class="line">       <span class="keyword">if</span> (fieldList == <span class="keyword">null</span>) &#123;<span class="comment">//</span></div><div class="line">           List&lt;Field&gt; supportedFields = <span class="keyword">new</span> ArrayList&lt;Field&gt;();</div><div class="line">           Class&lt;?&gt; clazz;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               clazz = Class.forName(className);<span class="comment">//è·å–ç±»å</span></div><div class="line">           &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> DatabaseGenerateException(DatabaseGenerateException.CLASS_NOT_FOUND + className);</div><div class="line">           &#125;</div><div class="line">           recursiveSupportedFields(clazz, supportedFields);<span class="comment">//é€’å½’ç±»å‹</span></div><div class="line">           classFieldsMap.put(className, supportedFields);<span class="comment">//ç¼“å­˜åˆ° hashMap ä¸­</span></div><div class="line">           <span class="keyword">return</span> supportedFields;<span class="comment">//è¿”å›</span></div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> fieldList;<span class="comment">//ç¼“å­˜å‘½ä¸­</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recursiveSupportedFields</span><span class="params">(Class&lt;?&gt; clazz, List&lt;Field&gt; supportedFields)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (clazz == DataSupport.class || clazz == Object.class) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    Field[] fields = clazz.getDeclaredFields();</div><div class="line">    <span class="keyword">if</span> (fields != <span class="keyword">null</span> &amp;&amp; fields.length &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</div><div class="line">            Column annotation = field.getAnnotation(Column.class);</div><div class="line">            <span class="keyword">if</span> (annotation != <span class="keyword">null</span> &amp;&amp; annotation.ignore()) &#123;<span class="comment">//æœ‰æ³¨è§£ï¼Œä½†æ˜¯æ³¨è§£è®¾ç½®ä¸ºå¿½ç•¥</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">int</span> modifiers = field.getModifiers();<span class="comment">//è·å–ä¿®é¥°ç¬¦</span></div><div class="line">            <span class="keyword">if</span> (!Modifier.isStatic(modifiers)) &#123;<span class="comment">//ä¸æ˜¯é™æ€çš„ </span></div><div class="line">                Class&lt;?&gt; fieldTypeClass = field.getType();<span class="comment">//è·å–å­—æ®µåŸŸç±»å‹</span></div><div class="line">                String fieldType = fieldTypeClass.getName();<span class="comment">//å­—æ®µç±»å‹çš„åç§°</span></div><div class="line">                <span class="keyword">if</span> (BaseUtility.isFieldTypeSupported(fieldType)) &#123;</div><div class="line">                    supportedFields.add(field);<span class="comment">//éé™æ€ã€å¹¶ä¸”å—æ”¯æŒçš„å­—æ®µæ·»åŠ åˆ° List&lt;Filed&gt; ä¸­</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    recursiveSupportedFields(clazz.getSuperclass(), supportedFields);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€’å½’è°ƒç”¨ï¼Œç›´åˆ°æ˜¯ DataSupport æˆ–è€… Object ä¸ºæ­¢ï¼Œé€šè¿‡åå°„å–å¾—æ‰€æœ‰çš„ fieldsï¼Œå½“ä¸éœ€è¦å¿½ç•¥æ—¶ï¼Œä¸æ˜¯é™æ€ï¼Œä¸€äº›åŸºæœ¬æ”¯æŒçš„æ•°æ®ç±»å‹æ—¶ä¼šç›´æ¥åŠ å…¥åˆ°è¿™ä¸ª fieldList é‡Œè¾¹ã€‚</p>
<p>getSupportedGenericFields() æ–¹æ³•ä¸ä¸Šé¢çš„ç±»ä¼¼ï¼Œåªä¸è¿‡å¤„ç†çš„æ˜¯æ³›å‹ã€‚</p>
<h3 id="LitePalBase-getAssociationInfo"><a href="#LitePalBase-getAssociationInfo" class="headerlink" title="LitePalBase#getAssociationInfo"></a>LitePalBase#getAssociationInfo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Collection&lt;AssociationsInfo&gt; mAssociationInfos;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> Collection&lt;AssociationsInfo&gt; <span class="title">getAssociationInfo</span><span class="params">(String className)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (mAssociationInfos == <span class="keyword">null</span>) &#123;</div><div class="line">      mAssociationInfos = <span class="keyword">new</span> HashSet&lt;AssociationsInfo&gt;();</div><div class="line">   &#125;</div><div class="line">   mAssociationInfos.clear();<span class="comment">//æ¸…ç†å…³ç³»é›†</span></div><div class="line">   analyzeClassFields(className, GET_ASSOCIATION_INFO_ACTION);<span class="comment">//åˆ†æç±»çš„å­—æ®µåŸŸ</span></div><div class="line">   <span class="keyword">return</span> mAssociationInfos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ†æç±»å­—æ®µä»¥æ‰¾å‡ºå…³è”å…³ç³»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">analyzeClassFields</span><span class="params">(String className, <span class="keyword">int</span> action)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; dynamicClass = Class.forName(className);<span class="comment">//åŠ è½½ç±»</span></div><div class="line">      Field[] fields = dynamicClass.getDeclaredFields();<span class="comment">//</span></div><div class="line">      <span class="keyword">for</span> (Field field : fields) &#123;</div><div class="line">         <span class="keyword">if</span> (isNonPrimitive(field)) &#123;<span class="comment">//ä¸æ˜¯åŸç”Ÿç±»å‹</span></div><div class="line">            Column annotation = field.getAnnotation(Column.class);<span class="comment">//è·å–æ³¨è§£</span></div><div class="line">            <span class="keyword">if</span> (annotation != <span class="keyword">null</span> &amp;&amp; annotation.ignore()) &#123;</div><div class="line">            	<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">            oneToAnyConditions(className, field, action);<span class="comment">//ä¸€å¯¹ï¼Ÿå…³ç³»</span></div><div class="line">            manyToAnyConditions(className, field, action);<span class="comment">//å¤šå¯¹ï¼Ÿå…³ç³»</span></div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</div><div class="line">		<span class="comment">//ä»£ç çœç•¥</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="LitePalBase-oneToAnyConditions"><a href="#LitePalBase-oneToAnyConditions" class="headerlink" title="LitePalBase#oneToAnyConditions"></a>LitePalBase#oneToAnyConditions</h4><p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®ï¼ŒoneToAnyConditions  æ˜¯åœ¨éå†å¤„ç†ç±»çš„æ‰€æœ‰å­—æ®µçš„è¿‡ç¨‹ä¸­è°ƒç”¨çš„ã€‚å¹¶ä¸”åªæœ‰å½“å­—æ®µç±»å‹æ˜¯éåŸç”Ÿç±»å‹æ—¶æ‰ä¼šè¿›å…¥è¯¥æ–¹æ³•ã€‚</p>
<p>è®¾æœ‰ A å’Œ B ä¸¤ä¸ªç±»ã€‚ç°åœ¨å¯¹ A ä¸­å­˜åœ¨ç±»å‹ä¸º B çš„å­—æ®µã€‚é¦–å…ˆåˆ¤æ–­ B æ˜¯å¦åœ¨é…ç½®æ–‡ä»¶é‡Œè¾¹é…ç½®çš„ã€‚å¦‚æœæ˜¯ï¼Œå°±æ‰¾åˆ°è¿™ä¸ªç±»çš„æ‰€æœ‰å­—æ®µã€‚æ‰¾åˆ°ä¸€ä¸ªå’Œ A ç›¸åŒçš„å­—æ®µï¼Œè¿™ä»£è¡¨ A é‡Œè¾¹æœ‰ä¸€ä¸ª Bï¼ŒB é‡Œè¾¹æœ‰ä¸€ä¸ª Aï¼Œæ˜¯ä¸€å¯¹ä¸€å…³ç³»ï¼›å¦‚æœ B æ‰¾åˆ°çš„å’Œ A ç›¸åŒçš„å­—æ®µæ˜¯ä¸€ä¸ªé›†åˆï¼Œä»£è¡¨ A é‡Œè¾¹æœ‰ä¸€ä¸ª Bï¼ŒB é‡Œè¾¹æœ‰å¤šä¸ª Aï¼Œæ˜¯å¤šå¯¹ä¸€å…³ç³»ã€‚</p>
<p>æœ€åç»Ÿä¸€æŠŠå…³ç³»åŠ å…¥åˆ°ä¸€ä¸ªé›†åˆé‡Œè¾¹æ¥ç®¡ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">oneToAnyConditions</span><span class="params">(String className, Field field, <span class="keyword">int</span> action)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</div><div class="line">   Class&lt;?&gt; fieldTypeClass = field.getType();<span class="comment">//è·å–å­—æ®µçš„ç±»å‹</span></div><div class="line"></div><div class="line">  <span class="comment">//å­—æ®µçš„ç±»å‹åŒ…å«åœ¨ LitePal é…ç½®æ–‡ä»¶æ˜ å°„çš„åˆ—è¡¨ä¸­</span></div><div class="line">   <span class="keyword">if</span> (LitePalAttr.getInstance().getClassNames().contains(fieldTypeClass.getName())) &#123;</div><div class="line">      Class&lt;?&gt; reverseDynamicClass = Class.forName(fieldTypeClass.getName());<span class="comment">//é€šè¿‡ç±»ååŠ è½½å­—æ®µçš„ç±»ï¼ˆç®€ç§°ä¸º Bï¼‰</span></div><div class="line">      Field[] reverseFields = reverseDynamicClass.getDeclaredFields();</div><div class="line">      <span class="keyword">boolean</span> reverseAssociations = <span class="keyword">false</span>;</div><div class="line">      <span class="comment">//  å¼€å§‹æ£€æŸ¥ç±» B ä¸­çš„å±æ€§</span></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; reverseFields.length; i++) &#123;</div><div class="line">         Field reverseField = reverseFields[i];<span class="comment">//</span></div><div class="line">         <span class="keyword">if</span> (!Modifier.isStatic(reverseField.getModifiers())) &#123;</div><div class="line">            Class&lt;?&gt; reverseFieldTypeClass = reverseField.getType();</div><div class="line">            <span class="comment">// B ä¸­ä¹Ÿæœ‰ A çš„å¼•ç”¨ã€‚å› æ­¤æ˜¯ä¸€å¯¹ä¸€çš„åŒå‘å…³ç³»</span></div><div class="line">            <span class="keyword">if</span> (className.equals(reverseFieldTypeClass.getName())) &#123;</div><div class="line">               <span class="keyword">if</span> (action == GET_ASSOCIATIONS_ACTION) &#123;</div><div class="line">                  addIntoAssociationModelCollection(className, fieldTypeClass.getName(),</div><div class="line">                        fieldTypeClass.getName(), Const.Model.ONE_TO_ONE);</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action == GET_ASSOCIATION_INFO_ACTION) &#123;</div><div class="line">                  addIntoAssociationInfoCollection(className, fieldTypeClass.getName(),</div><div class="line">                        fieldTypeClass.getName(), field, reverseField, Const.Model.ONE_TO_ONE);</div><div class="line">               &#125;</div><div class="line">               reverseAssociations = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// B ç±»ä¸­æœ‰å­—æ®µï¼š List&lt;A&gt; è¯´æ˜æ˜¯å¤šå¯¹ä¸€å…³ç³»</span></div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (isCollection(reverseFieldTypeClass)) &#123;</div><div class="line">               String genericTypeName = getGenericTypeName(reverseField);</div><div class="line">               <span class="keyword">if</span> (className.equals(genericTypeName)) &#123;</div><div class="line">                  <span class="keyword">if</span> (action == GET_ASSOCIATIONS_ACTION) &#123;</div><div class="line">                     addIntoAssociationModelCollection(className, fieldTypeClass.getName(),</div><div class="line">                           className, Const.Model.MANY_TO_ONE);</div><div class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action == GET_ASSOCIATION_INFO_ACTION) &#123;</div><div class="line">                     addIntoAssociationInfoCollection(className, fieldTypeClass.getName(),</div><div class="line">                           className, field, reverseField, Const.Model.MANY_TO_ONE);</div><div class="line">                  &#125;</div><div class="line">                  reverseAssociations = <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">            &#125;</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">     	  <span class="comment">// B ä¸­æ²¡æœ‰ A çš„å¼•ç”¨ï¼ŒAB æ˜¯å•å‘çš„ä¸€å¯¹ä¸€å…³ç³»</span></div><div class="line">           <span class="keyword">if</span> (!reverseAssociations) &#123;</div><div class="line">               <span class="keyword">if</span> (action == GET_ASSOCIATIONS_ACTION) &#123;</div><div class="line">                   addIntoAssociationModelCollection(className, fieldTypeClass.getName(),</div><div class="line">                           fieldTypeClass.getName(), Const.Model.ONE_TO_ONE);</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action == GET_ASSOCIATION_INFO_ACTION) &#123;</div><div class="line">                   addIntoAssociationInfoCollection(className, fieldTypeClass.getName(),</div><div class="line">                           fieldTypeClass.getName(), field, <span class="keyword">null</span>, Const.Model.ONE_TO_ONE);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>manyToAnyConditions ä¹Ÿæ˜¯é€šè¿‡ç±»ä¼¼çš„é€»è¾‘è¿›è¡Œåˆ†æå¤„ç†ã€‚</p>
<p>å›åˆ° saveThrows æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°åç»­ä¼šè°ƒç”¨ doSaveActionã€‚</p>
<h3 id="doSaveAction"><a href="#doSaveAction" class="headerlink" title="doSaveAction"></a>doSaveAction</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSaveAction</span><span class="params">(DataSupport baseObj, List&lt;Field&gt; supportedFields, List&lt;Field&gt; supportedGenericFields)</span></span></div><div class="line">      <span class="keyword">throws</span> SecurityException, IllegalArgumentException, NoSuchMethodException,</div><div class="line">      IllegalAccessException, InvocationTargetException &#123;</div><div class="line">   values.clear();<span class="comment">//å…ˆæ¸…é™¤ contentValue ä¸­çš„å€¼</span></div><div class="line">   beforeSave(baseObj, supportedFields, values);</div><div class="line">   <span class="keyword">long</span> id = saving(baseObj, values);<span class="comment">//ä¿å­˜</span></div><div class="line">   afterSave(baseObj, supportedFields, supportedGenericFields, id);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>doSaveAction æ–¹æ³•ä¸­ä¾æ¬¡è°ƒç”¨äº† beforeSave  saving afterSave ä¸‰ä¸ªæ–¹æ³•ã€‚</p>
<ul>
<li>beforeSave æ–¹æ³•ä¼šå°†ç›¸åº”çš„å­—æ®µåˆ—ä¸å€¼ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜æ”¾åˆ° values ä¸­ï¼Œ values å°†ä½œä¸ºåé¢ saving æ–¹æ³•çš„å‚æ•°ã€‚</li>
<li>saving æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ è°ƒç”¨ <code>SQLiteDatabase#insert</code> æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œä¿å­˜ã€‚</li>
<li>afterSave æ‰€åšçš„å·¥ä½œæ˜¯è·å–åˆšåˆšä¿å­˜çš„é‚£æ¡è®°å½•çš„ id ï¼Œç„¶åä»¥åå°„çš„å½¢å¼å°†å®ƒèµ‹ç»™å¯¹è±¡çš„ baseObjId å­—æ®µï¼ŒåŒæ—¶è¿˜ä¼šæ›´æ–°å…³è”è¡¨çš„æ•°æ®</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">saving</span><span class="params">(DataSupport baseObj, ContentValues values)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (values.size() == <span class="number">0</span>) &#123;<span class="comment">//å¦‚æœ contentValue ä¸­çš„å¤§å°ä¸º 0ï¼Œé‚£å°±å­˜å‚¨ä¸€ä¸ªä»…æœ‰ id çš„ç©ºè¡Œ</span></div><div class="line">           values.putNull(<span class="string">"id"</span>);</div><div class="line">       &#125;</div><div class="line">   <span class="keyword">return</span> mDatabase.insert(baseObj.getTableName(), <span class="keyword">null</span>, values);<span class="comment">//ç»ˆäºçœ‹åˆ°äº† SqlLite çš„ä¿å­˜æ“ä½œ</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SQLiteDatabase-insert"><a href="#SQLiteDatabase-insert" class="headerlink" title="SQLiteDatabase#insert"></a>SQLiteDatabase#insert</h3><p>insert æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ SQLiteDatabase#insertWithOnConflict æ–¹æ³•ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•çš„å®ç°æ˜¯å°†ç›¸åº”çš„æ•°æ®ç»“æ„æ‹¼æ¥ä¸ºä¸€ä¸ª SQL æ’å…¥è¯­å¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] CONFLICT_VALUES = <span class="keyword">new</span> String[]</div><div class="line">        &#123;<span class="string">""</span>, <span class="string">" OR ROLLBACK "</span>, <span class="string">" OR ABORT "</span>, <span class="string">" OR FAIL "</span>, <span class="string">" OR IGNORE "</span>, <span class="string">" OR REPLACE "</span>&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">insertWithOnConflict</span><span class="params">(String table, String nullColumnHack,</span></span></div><div class="line">        ContentValues initialValues, <span class="keyword">int</span> conflictAlgorithm) &#123;</div><div class="line">    acquireReference();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        StringBuilder sql = <span class="keyword">new</span> StringBuilder();</div><div class="line">        sql.append(<span class="string">"INSERT"</span>);</div><div class="line">        sql.append(CONFLICT_VALUES[conflictAlgorithm]);</div><div class="line">        sql.append(<span class="string">" INTO "</span>);</div><div class="line">        sql.append(table);<span class="comment">//è¡¨å</span></div><div class="line">        sql.append(<span class="string">'('</span>);</div><div class="line"></div><div class="line">        Object[] bindArgs = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> size = (initialValues != <span class="keyword">null</span> &amp;&amp; !initialValues.isEmpty())</div><div class="line">                ? initialValues.size() : <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</div><div class="line">            bindArgs = <span class="keyword">new</span> Object[size];</div><div class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (String colName : initialValues.keySet()) &#123;</div><div class="line">                sql.append((i &gt; <span class="number">0</span>) ? <span class="string">","</span> : <span class="string">""</span>);</div><div class="line">                sql.append(colName);<span class="comment">//æ·»åŠ åç§°</span></div><div class="line">                bindArgs[i++] = initialValues.get(colName);<span class="comment">//åˆ—åå¯¹åº”çš„å€¼ï¼Œå°†å…¶å­˜åœ¨æ•°ç»„ä¸­</span></div><div class="line">            &#125;</div><div class="line">            sql.append(<span class="string">')'</span>);</div><div class="line">            sql.append(<span class="string">" VALUES ("</span>);</div><div class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">                sql.append((i &gt; <span class="number">0</span>) ? <span class="string">",?"</span> : <span class="string">"?"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            sql.append(nullColumnHack + <span class="string">") VALUES (NULL"</span>);<span class="comment">//ç©ºè¡Œ</span></div><div class="line">        &#125;</div><div class="line">        sql.append(<span class="string">')'</span>);</div><div class="line"></div><div class="line">        SQLiteStatement statement = <span class="keyword">new</span> SQLiteStatement(<span class="keyword">this</span>, sql.toString(), bindArgs);<span class="comment">// åˆ©ç”¨è¡¨åï¼Œä»¥åŠéœ€è¦æ›´æ–°çš„åˆ—åï¼Œè¿˜æœ‰ç›¸åº”çš„åˆ—å‚æ•°ã€ŒbindArgsã€ åˆ›å»ºä¸€ä¸ª SQLiteStatement</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> statement.executeInsert();<span class="comment">//æ‰§è¡Œæ’å…¥æ“ä½œ</span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            statement.close();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        releaseReference();<span class="comment">//é‡Šæ”¾å¼•ç”¨</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œsave è¿‡ç¨‹åˆ†æå®Œæˆã€‚</p>
<h2 id="find-è¿‡ç¨‹æµ…æ"><a href="#find-è¿‡ç¨‹æµ…æ" class="headerlink" title="find è¿‡ç¨‹æµ…æ"></a>find è¿‡ç¨‹æµ…æ</h2><p>DataSupport#find å¤§ä½“æµç¨‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">find()</div><div class="line">  --&gt; find(modelClass, id, false);</div><div class="line">       --&gt; åˆ›å»º QueryHandler </div><div class="line">       --&gt; queryHandler#onFind</div><div class="line">           --&gt; query  //è·å–ç¬¦åˆæ¡ä»¶çš„ list</div><div class="line">             --&gt; DataHandler#query</div><div class="line">                     --&gt; getSupportedFields //è·å–æ”¯æŒçš„å­—æ®µ</div><div class="line">                     --&gt; //è°ƒç”¨ç›¸å…³æ–¹æ³•ã€‚åšä¸€äº›é“ºå«å·¥ä½œ</div><div class="line">                    --&gt; SQLiteDatabase#query  //è°ƒç”¨ SQLiteDataBase#query ï¼ˆè¯¥æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨ buildQueryString æ‹¼æ¥å‡ºå­—ç¬¦ä¸²ï¼‰ã€‚ç„¶åé€šè¿‡ cursor é€è¡Œå–å‡ºæ•°æ®</div><div class="line">                         --&gt; //çœç•¥ä¸€äº›è½¬å‘æ–¹æ³•</div><div class="line">                           --&gt; SQLiteDatabase#queryWithFactory</div><div class="line">                           		--&gt; SQLiteQueryBuilder#buildQueryString//æ‹¼æ¥ sql è¯­å¥</div></pre></td></tr></table></figure>
<h3 id="SQLiteQueryBuilder-buildQueryString"><a href="#SQLiteQueryBuilder-buildQueryString" class="headerlink" title="SQLiteQueryBuilder#buildQueryString"></a>SQLiteQueryBuilder#buildQueryString</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">buildQueryString</span><span class="params">(</span></span></div><div class="line">        <span class="keyword">boolean</span> distinct, String tables, String[] columns, String where,</div><div class="line">        String groupBy, String having, String orderBy, String limit) &#123;</div><div class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(groupBy) &amp;&amp; !TextUtils.isEmpty(having)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                <span class="string">"HAVING clauses are only permitted when using a groupBy clause"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(limit) &amp;&amp; !sLimitPattern.matcher(limit).matches()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalid LIMIT clauses:"</span> + limit);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    StringBuilder query = <span class="keyword">new</span> StringBuilder(<span class="number">120</span>);</div><div class="line"></div><div class="line">    query.append(<span class="string">"SELECT "</span>);</div><div class="line">    <span class="keyword">if</span> (distinct) &#123;</div><div class="line">        query.append(<span class="string">"DISTINCT "</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (columns != <span class="keyword">null</span> &amp;&amp; columns.length != <span class="number">0</span>) &#123;</div><div class="line">        appendColumns(query, columns);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        query.append(<span class="string">"* "</span>);</div><div class="line">    &#125;</div><div class="line">    query.append(<span class="string">"FROM "</span>);</div><div class="line">    query.append(tables);</div><div class="line">    appendClause(query, <span class="string">" WHERE "</span>, where);</div><div class="line">    appendClause(query, <span class="string">" GROUP BY "</span>, groupBy);</div><div class="line">    appendClause(query, <span class="string">" HAVING "</span>, having);</div><div class="line">    appendClause(query, <span class="string">" ORDER BY "</span>, orderBy);</div><div class="line">    appendClause(query, <span class="string">" LIMIT "</span>, limit);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> query.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å°ç»“ï¼šfind å°±æ˜¯é€šè¿‡ç›¸åº”çš„æŸ¥è¯¢æ¡ä»¶æ‹¼æ¥ä¸º SQL æŸ¥è¯¢è¯­å¥ï¼Œç„¶åå°†æŸ¥è¯¢ç»“æœè¿”å›ã€‚</p>
<h2 id="é—®é¢˜ï¼š"><a href="#é—®é¢˜ï¼š" class="headerlink" title="é—®é¢˜ï¼š"></a>é—®é¢˜ï¼š</h2><h3 id="åŒæ­¥-å¼‚æ­¥"><a href="#åŒæ­¥-å¼‚æ­¥" class="headerlink" title="åŒæ­¥/å¼‚æ­¥"></a>åŒæ­¥/å¼‚æ­¥</h3><p>å¯¹äºæ¯ä¸€ä¸ª CRUD æ“ä½œï¼ŒLitePal éƒ½æœ‰åŒæ­¥ä»¥åŠç›¸å¯¹åº”çš„å¼‚æ­¥æ–¹æ³•ã€‚</p>
<h4 id="ä»¥å¼‚æ­¥-save-ä¸ºä¾‹"><a href="#ä»¥å¼‚æ­¥-save-ä¸ºä¾‹" class="headerlink" title="ä»¥å¼‚æ­¥ save ä¸ºä¾‹"></a>ä»¥å¼‚æ­¥ save ä¸ºä¾‹</h4><p>å¼‚æ­¥æ›´æ–°åªæ˜¯æ–°å¼€ä¸€æ¡çº¿ç¨‹æ¥æ‰§è¡Œ save æ–¹æ³•ï¼Œå¹¶åœ¨ä¸»çº¿ç¨‹è¿›è¡Œç»“æœå›è°ƒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> SaveExecutor <span class="title">saveAsync</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> SaveExecutor executor = <span class="keyword">new</span> SaveExecutor();<span class="comment">//å‚åŠ ä¸€ä¸ª SaveExecutor</span></div><div class="line">    Runnable runnable = <span class="keyword">new</span> Runnable() &#123;<span class="comment">//åˆ›å»ºä¸€ä¸ª Runnable åŒ¿åå†…éƒ¨å­ç±»ï¼Œ</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">synchronized</span> (DataSupport.class) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> success = save();<span class="comment">//è°ƒç”¨ä¿å­˜æ–¹æ³•</span></div><div class="line">                <span class="keyword">if</span> (executor.getListener() != <span class="keyword">null</span>) &#123;</div><div class="line">                    LitePal.getHandler().post(<span class="keyword">new</span> Runnable() &#123;<span class="comment">//åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ä¸­å›è°ƒ</span></div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            executor.getListener().onFinish(success);<span class="comment">//å›è°ƒ</span></div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    executor.submit(runnable);</div><div class="line">    <span class="keyword">return</span> executor;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SaveExecutor</span> <span class="keyword">extends</span> <span class="title">AsyncExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> SaveCallback cb;<span class="comment">//å›è°ƒæ¥å£</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ³¨å†Œå›è°ƒæ¥å£ä¹‹åï¼Œé©¬ä¸Šæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(SaveCallback callback)</span> </span>&#123;<span class="comment">//æ³¨å†Œå›è°ƒ</span></div><div class="line">        cb = callback;</div><div class="line">        execute();<span class="comment">//æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> SaveCallback <span class="title">getListener</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span>  cb;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SaveExecutor ç»§æ‰¿è‡ª AsyncExecutorã€‚ç‰¹åˆ«ä¹‹å¤„åœ¨äºå®ƒæ˜¯é€šè¿‡ listen æ–¹æ³•æ¥è§¦å‘å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncExecutor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Runnable pendingTask;<span class="comment">//å»¶æ—¶ä»»åŠ¡</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æäº¤ä»»åŠ¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(Runnable task)</span> </span>&#123;</div><div class="line">        pendingTask = task;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åå°æ‰§è¡Œå»¶æ—¶ä»»åŠ¡</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (pendingTask != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">new</span> Thread(pendingTask).start();<span class="comment">//æ–°å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AsyncExecutor ä¸€ä¸ªç®€å•çš„å¼‚æ­¥æ‰§è¡Œå™¨ï¼Œåœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œä»»åŠ¡ã€‚å®ƒæ˜¯æ‰€æœ‰çš„å¼‚æ­¥æ“ä½œæ‰§è¡Œå™¨çš„åŸºç±»ã€‚</p>
<p><img src="https://user-images.githubusercontent.com/16668676/33612586-0077ccc2-da0d-11e7-80a5-5e093b7e79ba.png" alt="image"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>LitePal éœ€è¦åœ¨ Application ä¸­è¿›è¡Œåˆå§‹åŒ–ã€‚é¦–æ¬¡è·å–æ•°æ®åº“çš„æ—¶ä¼šè§¦å‘æ•°æ®åº“ä»¥åŠè¡¨çš„åˆ›å»ºã€‚åç»­çš„ CRUD æ“ä½œéƒ½æ˜¯é€šè¿‡<strong>åå°„æœºåˆ¶å’Œ Android SQLite API</strong> æ¥å®ç°çš„ã€‚å®ƒä¼šè‡ªåŠ¨åˆ†æè¡¨ä¸è¡¨ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œå¹¶å¸®åŠ©åˆ›å»ºè¡¨ã€è‡ªåŠ¨ç®¡ç†è¡¨ã€‚</p>
<h3 id="ä¼˜ç‚¹ï¼š"><a href="#ä¼˜ç‚¹ï¼š" class="headerlink" title="ä¼˜ç‚¹ï¼š"></a>ä¼˜ç‚¹ï¼š</h3><p><strong>é…ç½®ç®€å•ï¼Œæ“ä½œæ–¹ä¾¿ï¼Œä¸šåŠ¡å¯¹è±¡æ¸…æ™°ï¼ŒLitePal å¾ˆã€Œè½»ã€ï¼Œjar åŒ…åªæœ‰ 100k ä¸åˆ°</strong>ã€‚</p>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ol>
<li>åå°„å½±å“æ€§èƒ½ã€‚</li>
<li>æ— æ³•ç›´æ¥è¿›è¡Œå…³è”æŸ¥è¯¢ã€‚</li>
</ol>
<h3 id="ä¸åŒç±»æ¡†æ¶ï¼ˆGreenDAOï¼‰å¯¹æ¯”ï¼š"><a href="#ä¸åŒç±»æ¡†æ¶ï¼ˆGreenDAOï¼‰å¯¹æ¯”ï¼š" class="headerlink" title="ä¸åŒç±»æ¡†æ¶ï¼ˆGreenDAOï¼‰å¯¹æ¯”ï¼š"></a>ä¸åŒç±»æ¡†æ¶ï¼ˆGreenDAOï¼‰å¯¹æ¯”ï¼š</h3><p>GreetDao ä¸€å¼€å§‹å°±äººå·¥ç”Ÿæˆä¸šåŠ¡éœ€è¦çš„ Model å’Œ DAO æ–‡ä»¶ï¼Œä¸šåŠ¡ä¸­å¯ä»¥ç›´æ¥è°ƒç”¨ç›¸åº”çš„ DAO æ–‡ä»¶è¿›è¡Œæ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œä»è€Œé¿å…äº†å› åå°„å¸¦æ¥çš„æ€§èƒ½æŸè€—å’Œæ•ˆç‡ä½ã€‚å› æ­¤å¤§æ‰¹é‡çš„æ’å…¥ã€æ›´æ–°ã€æŸ¥è¯¢ç­‰æ“ä½œï¼ŒgreenDAO ç”¨æ—¶çŸ­ï¼Œæ‰§è¡Œå¿«æ›´é€‚åˆã€‚ä½†æ˜¯ greenDAO ä½¿ç”¨ä¸æ–¹ä¾¿ï¼Œå­¦ä¹ æˆæœ¬è¾ƒé«˜ã€‚</p>
<p>å¦‚æœåº”ç”¨å¯¹æ€§èƒ½è¦æ±‚ä¸æ˜¯ç‰¹åˆ«è‹›åˆ»å¹¶ä¸”æ•°æ®é‡ä¹Ÿä¸å¤§çš„æƒ…å†µä¸‹ï¼Œè½»é‡çº§çš„ LitePalï¼ŒåŸºæœ¬èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚äº†ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><p><a href="http://www.jianshu.com/p/35c704701638" target="_blank" rel="noopener">æ•°æ®åº“ ORM ä¹‹ LitePal</a></p>
</li>
<li><p><a href="http://blog.csdn.net/column/details/android-database-pro.html" target="_blank" rel="noopener">Android æ•°æ®åº“é«˜æ‰‹ç§˜ç±</a></p>
</li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®æ¬¢è¿åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè¯·å¯¹é—®é¢˜æè¿°å°½é‡è¯¦ç»†ï¼Œä»¥å¸®åŠ©æˆ‘å¯ä»¥å¿«é€Ÿæ‰¾åˆ°é—®é¢˜æ ¹æºï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> æºç åˆ†æ </category>
            
            <category> æ¡†æ¶åŸç† </category>
            
        </categories>
        
        
        <tags>
            
            <tag> æºç åˆ†æ </tag>
            
            <tag> æ¡†æ¶åŸç† </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æ‹†è½®å­ç³»åˆ—â€”â€”EventBus æºç è§£æ]]></title>
      <url>https://timlin-pro.github.io/blog/2017/10/14/%E6%8B%86%E8%BD%AE%E5%AD%90%E7%B3%BB%E5%88%97%E2%80%94%E2%80%94EventBus%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>é¡¹ç›®åœ°å€ï¼š<a href="https://link.jianshu.com/?t=https://github.com/greenrobot/EventBus" target="_blank" rel="noopener">EventBus</a>ï¼Œæœ¬æ–‡åˆ†æç‰ˆæœ¬: 3.1.1</p>
<h2 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h2><p>EventBus æ˜¯ä¸€ä¸ª Android <strong>äº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¡†æ¶</strong>ï¼Œé€šè¿‡<strong>è§£è€¦</strong>å‘å¸ƒè€…å’Œè®¢é˜…è€…ç®€åŒ– Android äº‹ä»¶ä¼ é€’ï¼Œè¿™é‡Œçš„äº‹ä»¶å¯ä»¥ç†è§£ä¸ºæ¶ˆæ¯ï¼Œæœ¬æ–‡ä¸­ç»Ÿä¸€ç§°ä¸ºäº‹ä»¶ã€‚äº‹ä»¶ä¼ é€’æ—¢å¯ç”¨äº Android å››å¤§ç»„ä»¶é—´é€šè®¯ï¼Œä¹Ÿå¯ä»¥ç”¨æˆ·å¼‚æ­¥çº¿ç¨‹å’Œä¸»çº¿ç¨‹é—´é€šè®¯ç­‰ç­‰ã€‚<br>ä¼ ç»Ÿçš„äº‹ä»¶ä¼ é€’æ–¹å¼åŒ…æ‹¬ï¼šHandlerã€BroadCastReceiverã€Interface å›è°ƒï¼Œç›¸æ¯”ä¹‹ä¸‹ EventBus çš„ä¼˜ç‚¹æ˜¯ä»£ç ç®€æ´ï¼Œä½¿ç”¨ç®€å•ï¼Œå¹¶å°†äº‹ä»¶å‘å¸ƒå’Œè®¢é˜…å……åˆ†è§£è€¦ã€‚</p>
<a id="more"></a>
<ul>
<li><strong>äº‹ä»¶(Event)ï¼š</strong>åˆå¯ç§°ä¸ºæ¶ˆæ¯ï¼Œæœ¬æ–‡ä¸­ç»Ÿä¸€ç”¨äº‹ä»¶è¡¨ç¤ºã€‚å…¶å®å°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥æ˜¯ç½‘ç»œè¯·æ±‚è¿”å›çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸä¸ªå¼€å…³çŠ¶æ€ç­‰ç­‰ã€‚<code>äº‹ä»¶ç±»å‹(EventType)</code>æŒ‡äº‹ä»¶æ‰€å±çš„ Classã€‚<ul>
<li>äº‹ä»¶åˆ†ä¸ºä¸€èˆ¬äº‹ä»¶å’Œ Sticky äº‹ä»¶ï¼Œç›¸å¯¹äºä¸€èˆ¬äº‹ä»¶ï¼ŒSticky äº‹ä»¶ä¸åŒä¹‹å¤„åœ¨äºï¼Œå½“äº‹ä»¶å‘å¸ƒåï¼Œå†æœ‰è®¢é˜…è€…å¼€å§‹è®¢é˜…è¯¥ç±»å‹äº‹ä»¶ï¼Œä¾ç„¶èƒ½æ”¶åˆ°è¯¥ç±»å‹äº‹ä»¶<strong>æœ€è¿‘ä¸€ä¸ª</strong> Sticky äº‹ä»¶ï¼ˆæ‰€è°“ã€Œæœ€è¿‘ä¸€ä¸ªã€æŒ‡çš„å°±æ˜¯è¯¥ç±»å‹äº‹ä»¶ã€Œæœ€åä¸€æ¬¡å‘å‡ºã€ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>è®¢é˜…è€…(Subscriber)ï¼š</strong>è®¢é˜…æŸç§äº‹ä»¶ç±»å‹çš„å¯¹è±¡ã€‚å½“æœ‰å‘å¸ƒè€…å‘å¸ƒè¿™ç±»äº‹ä»¶åï¼ŒEventBus ä¼šæ‰§è¡Œè®¢é˜…è€…çš„ onEvent å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å«<code>äº‹ä»¶å“åº”å‡½æ•°</code>ã€‚è®¢é˜…è€…é€šè¿‡ register æ¥å£è®¢é˜…æŸä¸ªäº‹ä»¶ç±»å‹ï¼Œunregister æ¥å£é€€è®¢ã€‚è®¢é˜…è€…å­˜åœ¨ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§é«˜çš„è®¢é˜…è€…å¯ä»¥å–æ¶ˆäº‹ä»¶ç»§ç»­å‘ä¼˜å…ˆçº§ä½çš„è®¢é˜…è€…åˆ†å‘ï¼Œé»˜è®¤æ‰€æœ‰è®¢é˜…è€…ä¼˜å…ˆçº§éƒ½ä¸º 0ã€‚</li>
<li><strong>å‘å¸ƒè€…(Publisher)ï¼š</strong>å‘å¸ƒæŸäº‹ä»¶çš„å¯¹è±¡ï¼Œé€šè¿‡ post æ¥å£å‘å¸ƒäº‹ä»¶ã€‚</li>
</ul>
<h2 id="äºŒã€å¦‚ä½•ä½¿ç”¨"><a href="#äºŒã€å¦‚ä½•ä½¿ç”¨" class="headerlink" title="äºŒã€å¦‚ä½•ä½¿ç”¨"></a>äºŒã€å¦‚ä½•ä½¿ç”¨</h2><h3 id="2-1-æ·»åŠ ä¾èµ–"><a href="#2-1-æ·»åŠ ä¾èµ–" class="headerlink" title="2.1 æ·»åŠ ä¾èµ–"></a>2.1 æ·»åŠ ä¾èµ–</h3><h4 id="æ–¹å¼ä¸€ï¼Œè¿è¡ŒæœŸå¤„ç†æ³¨è§£"><a href="#æ–¹å¼ä¸€ï¼Œè¿è¡ŒæœŸå¤„ç†æ³¨è§£" class="headerlink" title="æ–¹å¼ä¸€ï¼Œè¿è¡ŒæœŸå¤„ç†æ³¨è§£"></a>æ–¹å¼ä¸€ï¼Œè¿è¡ŒæœŸå¤„ç†æ³¨è§£</h4><p>åœ¨app çš„ build.gradle æ–‡ä»¶ä¸­æ·»åŠ ä¾èµ–</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    implementation <span class="string">'org.greenrobot:eventbus:3.1.1'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æ–¹å¼äºŒï¼Œç¼–è¯‘æœŸé¢„å¤„ç†æ³¨è§£"><a href="#æ–¹å¼äºŒï¼Œç¼–è¯‘æœŸé¢„å¤„ç†æ³¨è§£" class="headerlink" title="æ–¹å¼äºŒï¼Œç¼–è¯‘æœŸé¢„å¤„ç†æ³¨è§£"></a>æ–¹å¼äºŒï¼Œç¼–è¯‘æœŸé¢„å¤„ç†æ³¨è§£</h4><p>Android Studio  3.0 åŠä»¥ä¸Š</p>
<p>åœ¨ app çš„ build.gradle æ–‡ä»¶ä¸­æ·»åŠ </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">	<span class="comment">//â€¦â€¦</span></div><div class="line">    defaultConfig &#123;</div><div class="line">        <span class="comment">//â€¦â€¦</span></div><div class="line">        javaCompileOptions &#123;</div><div class="line">            annotationProcessorOptions &#123;</div><div class="line">                arguments = [<span class="string">eventBusIndex:</span> <span class="string">'org.greenrobot.eventbusperf.MyEventBusIndex'</span>]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    implementation <span class="string">'org.greenrobot:eventbus:3.1.1'</span></div><div class="line">    annotationProcessor  <span class="string">'org.greenrobot:eventbus-annotation-processor:3.0.1'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>build ä¹‹åï¼Œä¼šç”Ÿæˆä¸€ä¸ª MyEventBusIndex.javaç±»ã€‚</p>
<p>ç„¶ååœ¨ä½¿ç”¨ EventBus å®ä¾‹ä¹‹å‰ï¼Œåˆæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å°†é…ç½®MyEventBusIndex.javaé…ç½®åˆ°ç±»ä¸­æ˜¯å“Ÿç»ã€‚</p>
<h6 id="æ–¹å¼ä¸€-åœ¨æ„é€ -EventBus-æ—¶ä¼ å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„-EventBusIndexï¼Œ"><a href="#æ–¹å¼ä¸€-åœ¨æ„é€ -EventBus-æ—¶ä¼ å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„-EventBusIndexï¼Œ" class="headerlink" title="æ–¹å¼ä¸€ åœ¨æ„é€  EventBus æ—¶ä¼ å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ EventBusIndexï¼Œ"></a>æ–¹å¼ä¸€ åœ¨æ„é€  EventBus æ—¶ä¼ å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ EventBusIndexï¼Œ</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EventBus mEventBus = EventBus.builder().addIndex(<span class="keyword">new</span> MyEventBusIndex()).build();</div></pre></td></tr></table></figure>
<h6 id="æ–¹å¼äºŒ-å°†ç´¢å¼•åº”ç”¨åˆ°é»˜è®¤çš„å•ä¾‹ä¸­"><a href="#æ–¹å¼äºŒ-å°†ç´¢å¼•åº”ç”¨åˆ°é»˜è®¤çš„å•ä¾‹ä¸­" class="headerlink" title="æ–¹å¼äºŒ å°†ç´¢å¼•åº”ç”¨åˆ°é»˜è®¤çš„å•ä¾‹ä¸­"></a>æ–¹å¼äºŒ å°†ç´¢å¼•åº”ç”¨åˆ°é»˜è®¤çš„å•ä¾‹ä¸­</h6><p>ä½¿ç”¨ EventBus ä¹‹å‰ï¼Œå…ˆè°ƒç”¨ä¸‹é¢çš„ä»£ç åˆå§‹åŒ– EventBusã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EventBus.builder().addIndex(<span class="keyword">new</span> MyEventBusIndex()).installDefaultEventBus();</div></pre></td></tr></table></figure>
<h3 id="2-2-å®šä¹‰äº‹ä»¶ç±»"><a href="#2-2-å®šä¹‰äº‹ä»¶ç±»" class="headerlink" title="2.2 å®šä¹‰äº‹ä»¶ç±»"></a>2.2 å®šä¹‰äº‹ä»¶ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomEvent</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String mEventName;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomEvent</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEventName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mEventName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEventName</span><span class="params">(String eventName)</span> </span>&#123;</div><div class="line">        mEventName = eventName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-3-æ³¨å†Œä¸ºç›‘å¬è€…"><a href="#2-3-æ³¨å†Œä¸ºç›‘å¬è€…" class="headerlink" title="2.3 æ³¨å†Œä¸ºç›‘å¬è€…"></a>2.3 æ³¨å†Œä¸ºç›‘å¬è€…</h3><p>åœ¨åˆé€‚çš„åœ°æ–¹ï¼ˆæ¯”å¦‚ Activity#onCreateã€Fragment#onCreateViewï¼‰é€šè¿‡ä¸‹æ–¹ä»£ç è¿›è¡Œæ³¨å†Œ</p>
<p><code>EventBus.getDefault().register(this);</code></p>
<h3 id="2-4-ç¼–å†™å“åº”äº‹ä»¶çš„è®¢é˜…æ–¹æ³•"><a href="#2-4-ç¼–å†™å“åº”äº‹ä»¶çš„è®¢é˜…æ–¹æ³•" class="headerlink" title="2.4 ç¼–å†™å“åº”äº‹ä»¶çš„è®¢é˜…æ–¹æ³•"></a>2.4 ç¼–å†™å“åº”äº‹ä»¶çš„è®¢é˜…æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.BACKGROUND, sticky = <span class="keyword">true</span>, priority = <span class="number">100</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(CustomEvent event)</span> </span>&#123;</div><div class="line">    Log.d(TAG, <span class="string">"onMessage: "</span> + event.getEventName());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ç¼–è¯‘æœŸæ³¨è§£å¤„ç†çš„æƒ…å†µä¸‹ï¼Œè®¢é˜…æ–¹æ³•çš„è®¿é—®æ§åˆ¶æƒé™å¿…é¡»æ˜¯ é private å¹¶ä¸”é static çš„</p>
<p>ä½¿ç”¨è¿è¡ŒæœŸåå°„å¤„ç†çš„æƒ…å†µä¸‹ï¼Œè®¢é˜…æ–¹æ³•çš„è®¿é—®æ§åˆ¶æƒé™å¿…é¡»æ˜¯ public çš„</p>
<ul>
<li>é€šè¿‡ ThreadMode å¯ä»¥æŒ‡å®šè®¢é˜…æ–¹æ³•åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæœ‰å››ç§é€‰æ‹©<ul>
<li>ThreadMode.MAIN äº‹ä»¶è®¢é˜…æ–¹æ³•ä¼šåœ¨ UI çº¿ç¨‹ä¸­æ‰§è¡Œ<ul>
<li>ä½¿ç”¨æ­¤æ¨¡å¼çš„äº‹ä»¶è®¢é˜…æ–¹æ³•å¿…é¡»å¿«é€Ÿè¿”å›ä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚</li>
</ul>
</li>
<li>ThreadMode.POSTING ï¼ˆé»˜è®¤çš„æ¨¡å¼ï¼‰è¡¨ç¤ºäº‹ä»¶åœ¨å“ªä¸ªçº¿ç¨‹ä¸­å‘å¸ƒå‡ºæ¥çš„ï¼Œäº‹ä»¶è®¢é˜…æ–¹æ³•å°±ä¼šåœ¨è¿™ä¸ªçº¿ç¨‹ä¸­è¿è¡Œï¼›<ul>
<li>è¯¥æ¨¡å¼é¿å…äº†çº¿ç¨‹åˆ‡æ¢ï¼Œé€‚ç”¨äºé‚£äº›åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å®Œæˆçš„ç®€å•ä»»åŠ¡ï¼Œæ— éœ€ä¸»çº¿ç¨‹ã€‚ä½¿ç”¨è¿™ç§æ¨¡å¼çš„äº‹ä»¶è®¢é˜…æ–¹æ³•å¿…é¡»å¿«é€Ÿè¿”å›ä»¥é¿å…é˜»å¡å‘å¸ƒçº¿ç¨‹ï¼ˆå‘å¸ƒçº¿ç¨‹å¯èƒ½æ˜¯ä¸»çº¿ç¨‹ï¼‰ã€‚</li>
</ul>
</li>
<li>ThreadMode.MAIN_ORDERED<ul>
<li>åœ¨ Android ä¸Šï¼Œè®¢é˜…æ–¹æ³•å°†åœ¨ Android çš„ä¸»çº¿ç¨‹ä¸­è¢«è°ƒç”¨ã€‚äº‹ä»¶å°†ä¼šæ’é˜Ÿç­‰å¾…äº¤ä»˜ï¼Œè¿™ç¡®ä¿äº† post è°ƒç”¨æ˜¯éé˜»å¡çš„ã€‚</li>
</ul>
</li>
<li>ThreadMode.BACKGROUND å­çº¿ç¨‹æ‰§è¡Œï¼Œå¦‚æœæœ¬æ¥å°±åœ¨å­çº¿ç¨‹ï¼Œç›´æ¥åœ¨è¯¥å­çº¿ç¨‹æ‰§è¡Œ<ul>
<li>EventBus ä½¿ç”¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œå°†æŒ‰é¡ºåºå‘é€æ‰€æœ‰äº‹ä»¶ã€‚ä½¿ç”¨è¿™ç§æ¨¡å¼çš„è®¢é˜…æ–¹æ³•åº”è¯¥å°½å¿«è¿”å›ä»¥é¿å…é˜»å¡åå°çº¿ç¨‹ã€‚<ul>
<li>æ³¨æ„ï¼šã€Œä¸€ä¸ªåå°çº¿ç¨‹ã€æ‰€æŒ‡çš„å¹¶ä¸æ˜¯ <code>Executors.newSingleThreadPool()</code>ï¼Œè€Œæ˜¯ä½¿ç”¨ EventBus åœ¨å®ä¾‹åŒ–æ—¶åˆ›å»ºçš„ cacheThreadPool ä¸­çš„æŸä¸€ä¸ªçº¿ç¨‹ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ThreadMode.ASYNC æ–°å»ºå­çº¿ç¨‹æ‰§è¡Œã€‚é€‚ç”¨äºè€—æ—¶æ“ä½œ<ul>
<li>å‘å¸ƒäº‹ä»¶æ°¸è¿œä¸ä¼šç­‰å¾…ä½¿ç”¨æ­¤æ¨¡å¼çš„è®¢é˜…æ–¹æ³•ã€‚é€‚ç”¨äºæ¯”è¾ƒè€—æ—¶çš„è®¢é˜…æ–¹æ³•ï¼Œæ¯”å¦‚ç”¨äºç½‘ç»œè¯·æ±‚ã€‚ä½¿ç”¨æ—¶åº”è¯¥é¿å…åŒæ—¶è§¦å‘å¤§é‡é•¿æ—¶é—´è¿è¡Œçš„å¼‚æ­¥è®¢é˜…æ–¹æ³•æ¥é™åˆ¶å¹¶å‘çº¿ç¨‹çš„æ•°é‡ã€‚ EventBus ä½¿ç”¨çº¿ç¨‹æ± æœ‰æ•ˆåœ°é‡ç”¨å·²å®Œæˆçš„å¼‚æ­¥ç”¨æˆ·é€šçŸ¥ä¸­çš„çº¿ç¨‹ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>é€šè¿‡ sticky æŒ‡å®šæ˜¯å¦æ¥æ”¶ç²˜æ€§äº‹ä»¶ï¼Œé»˜è®¤ä¸º false</li>
<li>é€šè¿‡ priority è®¾ç½®æ¥æ”¶è®¢é˜…æ–¹æ³•çš„ä¼˜å…ˆçº§ï¼Œç›¸åŒçš„äº‹ä»¶ï¼Œä¼˜å…ˆçº§è¶Šé«˜çš„è®¢é˜…æ–¹æ³• è¶Šæ—©æ”¶åˆ°äº‹ä»¶</li>
</ul>
<h3 id="2-5-å‘é€äº‹ä»¶"><a href="#2-5-å‘é€äº‹ä»¶" class="headerlink" title="2.5 å‘é€äº‹ä»¶"></a>2.5 å‘é€äº‹ä»¶</h3><p>é€šè¿‡<code>EventBus</code>çš„<code>post()</code>æ–¹æ³•æ¥å‘é€äº‹ä»¶, å‘é€ä¹‹åå°±ä¼šæ‰§è¡Œæ³¨å†Œè¿‡è¿™ä¸ªäº‹ä»¶çš„å¯¹åº”ç±»çš„æ–¹æ³•. æˆ–è€…é€šè¿‡<code>postSticky()</code>æ¥å‘é€ä¸€ä¸ªç²˜æ€§äº‹ä»¶ã€‚</p>
<h3 id="2-6-è§£é™¤æ³¨å†Œ"><a href="#2-6-è§£é™¤æ³¨å†Œ" class="headerlink" title="2.6 è§£é™¤æ³¨å†Œ"></a>2.6 è§£é™¤æ³¨å†Œ</h3><p>åœ¨åˆé€‚çš„åœ°æ–¹ï¼ˆæ¯”å¦‚ Activity#onDestroyï¼‰ä½¿ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œè§£é™¤æ³¨å†Œ <code>EventBus.getDefault().unregister(this);</code></p>
<h3 id="2-7-å°ç»“"><a href="#2-7-å°ç»“" class="headerlink" title="2.7 å°ç»“"></a>2.7 å°ç»“</h3><p>è¦å®ç°è®¢é˜…ï¼Œéœ€è¦è¿›è¡Œæ³¨å†Œï¼Œä»¥åŠè§£æ³¨å†Œï¼Œè®¢é˜…æ–¹æ³•ä»¥ã€Œç›®æ ‡äº‹ä»¶ã€ä½œä¸ºæ–¹æ³•çš„å‚æ•°ï¼Œ ä½¿ç”¨ Subscribe æ³¨è§£ï¼Œå¯ä»¥æŒ‡å®šè®¢é˜…æ–¹æ³•æ‰§è¡Œçš„çº¿ç¨‹ã€æ˜¯å¦æ¥æ”¶ sticky äº‹ä»¶ã€è®¢é˜…æ–¹æ³•çš„ä¼˜å…ˆçº§ã€‚</p>
<p>è‡³äºå‘é€æ–¹ï¼Œåªéœ€è¦åˆ›å»ºç›¸åº”çš„ äº‹ä»¶å®ä¾‹ï¼Œç„¶åè°ƒç”¨ post æˆ–è€… postSticky å°†äº‹ä»¶å‘é€å‡ºå»å³å¯ã€‚</p>
<h2 id="ä¸‰ã€å®ç°"><a href="#ä¸‰ã€å®ç°" class="headerlink" title="ä¸‰ã€å®ç°"></a>ä¸‰ã€å®ç°</h2><h3 id="3-1-åˆå§‹åŒ–-EventBus"><a href="#3-1-åˆå§‹åŒ–-EventBus" class="headerlink" title="3.1 åˆå§‹åŒ– EventBus"></a>3.1 åˆå§‹åŒ– EventBus</h3><p>å¼€å‘è€…é€šå¸¸æ˜¯è°ƒç”¨ EventBus#getDefault æ–¹æ³•è·å– EventBus å®ä¾‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EventBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (EventBus.class) &#123;</div><div class="line">            <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                defaultInstance = <span class="keyword">new</span> EventBus();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> defaultInstance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getDefault é€šè¿‡åŒé‡æ ¡éªŒé”çš„æ–¹å¼æ¥å®ç°å•ä¾‹</p>
<h4 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> EventBusBuilder DEFAULT_BUILDER = <span class="keyword">new</span> EventBusBuilder();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">EventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(DEFAULT_BUILDER);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡ getDefault è·å–çš„ EventBus å¯¹è±¡æ˜¯é€šè¿‡é»˜è®¤çš„ EventBusBuilder æ„é€ è€Œæˆçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ExecutorService DEFAULT_EXECUTOR_SERVICE = Executors.newCachedThreadPool();<span class="comment">//é»˜è®¤ä¸º CachedThreadPoolï¼Œä¸é™åˆ¶çº¿ç¨‹æ•°</span></div><div class="line"></div><div class="line"><span class="keyword">boolean</span> logSubscriberExceptions = <span class="keyword">true</span>;</div><div class="line"><span class="keyword">boolean</span> logNoSubscriberMessages = <span class="keyword">true</span>;</div><div class="line"><span class="keyword">boolean</span> sendSubscriberExceptionEvent = <span class="keyword">true</span>;</div><div class="line"><span class="keyword">boolean</span> sendNoSubscriberEvent = <span class="keyword">true</span>;</div><div class="line"><span class="keyword">boolean</span> throwSubscriberException;</div><div class="line"></div><div class="line"><span class="keyword">boolean</span> strictMethodVerification;<span class="comment">//</span></div><div class="line">ExecutorService executorService = DEFAULT_EXECUTOR_SERVICE;<span class="comment">//é»˜è®¤çš„çº¿ç¨‹æ± </span></div><div class="line">List&lt;Class&lt;?&gt;&gt; skipMethodVerificationForClasses;</div><div class="line">List&lt;SubscriberInfoIndex&gt; subscriberInfoIndexes;</div><div class="line">MainThreadSupport mainThreadSupport;</div><div class="line"></div><div class="line">EventBus(EventBusBuilder builder) &#123;</div><div class="line">	<span class="comment">//â€¦â€¦</span></div><div class="line">    subscriptionsByEventType = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    typesBySubscriber = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    stickyEvents = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">	<span class="comment">//â€¦â€¦</span></div><div class="line">    eventInheritance = builder.eventInheritance;</div><div class="line">    executorService = builder.executorService;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸»è¦çœ‹ä»¥ä¸‹å‡ ä¸ªå•ä¾‹çš„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">boolean</span> eventInheritance = <span class="keyword">true</span>;<span class="comment">//æ˜¯å¦å…è®¸äº‹ä»¶ç»§æ‰¿</span></div><div class="line"><span class="keyword">boolean</span> ignoreGeneratedIndex;<span class="comment">//æ˜¯å¦å¿½ç•¥ ç”Ÿæˆçš„ indexï¼Œé»˜è®¤ä¸º falseï¼Œä¹Ÿå°±æ˜¯ä¼šå…ˆå°è¯•å¯»æ‰¾ç¼–è¯‘æœŸæ³¨è§£ç”Ÿæˆçš„è®¢é˜…æ–¹æ³•ä¿¡æ¯ï¼Œæ‰¾ä¸åˆ°å†ä½¿ç”¨åå°„å»è·å–ã€‚</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; subscriptionsByEventType;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, List&lt;Class&lt;?&gt;&gt;&gt; typesBySubscriber;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; stickyEvents;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> HandlerPoster mainThreadPoster;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> BackgroundPoster backgroundPoster;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AsyncPoster asyncPoster;</div></pre></td></tr></table></figure>
<ul>
<li>subscriptionsByEventType ï¼Œkey æ˜¯äº‹ä»¶ç±»å‹ï¼Œvalue ä¸º è®¢é˜…äº†è¯¥äº‹ä»¶çš„æ–¹æ³•åˆ—è¡¨</li>
<li>typesBySubscriberï¼Œkey ä¸ºè®¢é˜…è€…ï¼Œvalue æŸä¸ªè®¢é˜…è€…è®¢é˜…çš„äº‹ä»¶åˆ—è¡¨</li>
<li>stickyEventsï¼Œkey ä¸ºäº‹ä»¶ç±»å‹ï¼Œvalue ä¸ºå…·ä½“çš„äº‹ä»¶å®ä¾‹</li>
<li>mainThreadPoster ä¸»çº¿ç¨‹åˆ†å‘</li>
<li>backgroundPoster åå°çº¿ç¨‹åˆ†å‘</li>
<li>asyncPoster å¼‚æ­¥çº¿ç¨‹åˆ†å‘</li>
</ul>
<h3 id="3-2-æ³¨å†Œè®¢é˜…"><a href="#3-2-æ³¨å†Œè®¢é˜…" class="headerlink" title="3.2 æ³¨å†Œè®¢é˜…"></a>3.2 æ³¨å†Œè®¢é˜…</h3><p>org.greenrobot.eventbus.EventBus#register</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">    Class&lt;?&gt; subscriberClass = subscriber.getClass();<span class="comment">//è·å–è®¢é˜…è€…çš„ class å¯¹è±¡</span></div><div class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);<span class="comment">//æŸ¥æ‰¾è®¢é˜…è€…ä¸­æ‰€æœ‰çš„è®¢é˜…æ–¹æ³•</span></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="comment">//è¿­ä»£éå†è®¢é˜…è€…ä¸­æ‰€æœ‰çš„è®¢é˜…æ–¹æ³•</span></div><div class="line">        <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</div><div class="line">            subscribe(subscriber, subscriberMethod);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>EventBus#findSubscriberMethods </p>
<p>æ‰¾å‡ºç»™å®š class ä¸­æ‰€æœ‰çš„è®¢é˜…æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, List&lt;SubscriberMethod&gt;&gt; METHOD_CACHE = <span class="keyword">new</span> ConcurrentHashMap();<span class="comment">//ä»¥ class ä¸º keyï¼Œæ–¹æ³•åˆ—è¡¨ä¸º value çš„ï¼ŒMap ä½œä¸ºç¼“å­˜</span></div><div class="line"></div><div class="line"><span class="function">List&lt;SubscriberMethod&gt; <span class="title">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">    List subscriberMethods = (List)METHOD_CACHE.get(subscriberClass);<span class="comment">//ç¼“å­˜ä¸­è·å–</span></div><div class="line">    <span class="keyword">if</span>(subscriberMethods != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> subscriberMethods;<span class="comment">//ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.ignoreGeneratedIndex) &#123;<span class="comment">//å¿½ç•¥ç¼–è¯‘æœŸç”Ÿæˆçš„ è®¢é˜…æ–¹æ³•ä¿¡æ¯</span></div><div class="line">            subscriberMethods = <span class="keyword">this</span>.findUsingReflection(subscriberClass);<span class="comment">//é€šè¿‡åå°„è·å–è®¢é˜…æ–¹æ³•ä¿¡æ¯</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//è·å–ç¼–è¯‘æœŸç”Ÿæˆçš„ è®¢é˜…æ–¹æ³•ä¿¡æ¯</span></div><div class="line">            subscriberMethods = <span class="keyword">this</span>.findUsingInfo(subscriberClass);<span class="comment">//</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(subscriberMethods.isEmpty()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriberClass + <span class="string">" and its super classes have no public methods with the @Subscribe annotation"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            METHOD_CACHE.put(subscriberClass, subscriberMethods);<span class="comment">//æ·»åŠ åˆ°ç¼“å­˜ä¸­</span></div><div class="line">            <span class="keyword">return</span> subscriberMethods;<span class="comment">//è¿”å›</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>EventBus#subscribe()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å¿…é¡»ä»åŒæ­¥å—ä¸­è°ƒç”¨</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> </span>&#123;</div><div class="line">    Class&lt;?&gt; eventType = subscriberMethod.eventType;<span class="comment">//äº‹ä»¶ç±»å‹</span></div><div class="line">    Subscription newSubscription = <span class="keyword">new</span> Subscription(subscriber, subscriberMethod);<span class="comment">//æ–°å»ºä¸€ä¸ª Subscriptionï¼Œå­˜å‚¨è®¢é˜…çš„å¯¹è±¡ä»¥åŠ å“åº”çš„æ–¹æ³•</span></div><div class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);<span class="comment">//Map&lt;Class&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; ä» map ä¸­è·å–ç›¸åº”è®¢é˜…ç±»å‹çš„ åˆ—è¡¨</span></div><div class="line">    <span class="keyword">if</span> (subscriptions == <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœæ²¡æœ‰åˆ™æ–°å»ºä¸€ä¸ª</span></div><div class="line">        subscriptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div><div class="line">        subscriptionsByEventType.put(eventType, subscriptions);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriber.getClass() + <span class="string">" already registered to event "</span></div><div class="line">                    + eventType);<span class="comment">//æ²¡æœ‰åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> size = subscriptions.size();</div><div class="line">    <span class="comment">//éå†ç›‘å¬åˆ—è¡¨ï¼Œå°†æ–°çš„ subscription æ’å…¥åˆ°æ­£ç¡®ä½ç½®ã€‚åˆ—è¡¨æŒ‰ç…§ä¼˜å…ˆçº§é€’å‡çš„é¡ºåºæ’åº</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= size; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</div><div class="line">            subscriptions.add(i, newSubscription);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</div><div class="line">    <span class="keyword">if</span> (subscribedEvents == <span class="keyword">null</span>) &#123;</div><div class="line">        subscribedEvents = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        typesBySubscriber.put(subscriber, subscribedEvents);</div><div class="line">    &#125;</div><div class="line">    subscribedEvents.add(eventType);</div><div class="line">	<span class="comment">//å¦‚æœè§¦å‘çš„æ–¹æ³• è¦æ¥æ”¶ã€Œç²˜æ€§äº‹ä»¶ã€ï¼Œè·å–ç›¸åº”ç±»å‹çš„ Event å¹¶è§¦å‘ç›¸åº”çš„æ–¹æ³•</span></div><div class="line">    <span class="keyword">if</span> (subscriberMethod.sticky) &#123;</div><div class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</div><div class="line">            <span class="comment">// Existing sticky events of all subclasses of eventType have to be considered.</span></div><div class="line">            <span class="comment">// Note: Iterating over all events may be inefficient with lots of sticky events,</span></div><div class="line">            <span class="comment">// thus data structure should be changed to allow a more efficient lookup</span></div><div class="line">            <span class="comment">// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</span></div><div class="line">            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</div><div class="line">                Class&lt;?&gt; candidateEventType = entry.getKey();</div><div class="line">                <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</div><div class="line">                    Object stickyEvent = entry.getValue();</div><div class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Object stickyEvent = stickyEvents.get(eventType);</div><div class="line">            checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•ä¼šå°†ç›¸åº”çš„äº‹ä»¶æ’å…¥å¯¹åº”äº‹ä»¶çš„åˆ—è¡¨ä¸­ã€‚å¦‚æœåœ¨æ–¹æ³•æ³¨è§£ä¸­å£°æ˜äº† stickyï¼Œè¿˜ä¼šé©¬ä¸Šè°ƒç”¨è¯¥æ–¹æ³•ã€‚</p>
<p>æ£€æµ‹ stick äº‹ä»¶ï¼Œå¦‚æœç›¸åº”çš„äº‹ä»¶å®šä¹‰æœ‰å­ç±»çš„è¯ï¼Œä¼šéå†äº‹ä»¶çš„äº‹ä»¶å­ç±»é€ä¸€é€šçŸ¥è¯¥æ–¹æ³•ã€‚</p>
<h4 id="3-2-1-é€šè¿‡åå°„å¤„ç†æ³¨è§£"><a href="#3-2-1-é€šè¿‡åå°„å¤„ç†æ³¨è§£" class="headerlink" title="3.2.1 é€šè¿‡åå°„å¤„ç†æ³¨è§£"></a>3.2.1 é€šè¿‡åå°„å¤„ç†æ³¨è§£</h4><p>SubscriberMethodFinder#findUsingReflection</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingReflection</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">    FindState findState = prepareFindState();</div><div class="line">    findState.initForSubscriber(subscriberClass);</div><div class="line">    <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</div><div class="line">        findUsingReflectionInSingleClass(findState);</div><div class="line">        findState.moveToSuperclass();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> getMethodsAndRelease(findState);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SubscriberMethodFinder#findUsingReflectionInSingleClass</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findUsingReflectionInSingleClass</span><span class="params">(FindState findState)</span> </span>&#123;</div><div class="line">        Method[] methods;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span></div><div class="line">            methods = findState.clazz.getDeclaredMethods();<span class="comment">//è·å–çš„æ˜¯ç±»çš„æ‰€æœ‰å…¬æœ‰æ–¹æ³•ï¼Œè¿™å°±åŒ…æ‹¬è‡ªèº« å’Œä»åŸºç±»ç»§æ‰¿çš„ã€ä»æ¥å£å®ç°çš„æ‰€æœ‰ public æ–¹æ³•ã€‚</span></div><div class="line">            <span class="comment">//getDeclareMethods è¿”å›çš„æ˜¯è¯¥ç±»ä¸­å®šä¹‰çš„ã€Œæ‰€æœ‰æ–¹æ³•ã€ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬ä»çˆ¶ç±»ç»§æ‰¿è€Œæ¥çš„æ–¹æ³•</span></div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">            methods = findState.clazz.getMethods();</div><div class="line">            findState.skipSuperClasses = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (Method method : methods) &#123;<span class="comment">//éå†æ–¹æ³•</span></div><div class="line">            <span class="keyword">int</span> modifiers = method.getModifiers();</div><div class="line">            <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</div><div class="line">                Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</div><div class="line">                <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;<span class="comment">//å‚æ•°åˆ—è¡¨é•¿åº¦ä¸º 0</span></div><div class="line">                    Subscribe subscribeAnnotation = method.getAnnotation(Subscribe.class);</div><div class="line">                    <span class="keyword">if</span> (subscribeAnnotation != <span class="keyword">null</span>) &#123;</div><div class="line">                        Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</div><div class="line">                        <span class="keyword">if</span> (findState.checkAdd(method, eventType)) &#123;</div><div class="line">                            ThreadMode threadMode = subscribeAnnotation.threadMode();</div><div class="line">                            <span class="comment">//å°†è®¢é˜…æ–¹æ³•ä¿¡æ¯æ·»åŠ åˆ° findState ä¸­</span></div><div class="line">                            findState.subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(method, eventType, threadMode,</div><div class="line">                                    subscribeAnnotation.priority(), subscribeAnnotation.sticky()));</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">                    String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"@Subscribe method "</span> + methodName +</div><div class="line">                            <span class="string">"must have exactly 1 parameter but has "</span> + parameterTypes.length);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">                String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(methodName +</div><div class="line">                        <span class="string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h5 id="ignoreGeneratedIndex-æ˜¯ä»€ä¹ˆ"><a href="#ignoreGeneratedIndex-æ˜¯ä»€ä¹ˆ" class="headerlink" title="ignoreGeneratedIndex æ˜¯ä»€ä¹ˆ?"></a>ignoreGeneratedIndex æ˜¯ä»€ä¹ˆ?</h5><p>ç”±äºåå°„æˆæœ¬é«˜,è€Œä¸” EventBus 3.0 å¼•å…¥äº† EventBusAnnotationProcessor,æ•…é»˜è®¤ ignoreGeneratedIndex ä¸º false,<strong>éœ€è¦æ³¨æ„çš„æ˜¯,å¦‚æœè®¾ç½® ignoreGeneratedIndex ä¸º true,åˆ™å‰é¢ä½¿ç”¨çš„ MyEventBusIndex æ— æ•ˆ,è¿˜æ˜¯ä¼šèµ°åå°„è§£æçš„åˆ†æ”¯</strong>ã€‚</p>
<h4 id="3-2-2-ä½¿ç”¨ç¼–è¯‘æœŸç”Ÿæˆçš„è®¢é˜…æ–¹æ³•ä¿¡æ¯"><a href="#3-2-2-ä½¿ç”¨ç¼–è¯‘æœŸç”Ÿæˆçš„è®¢é˜…æ–¹æ³•ä¿¡æ¯" class="headerlink" title="3.2.2 ä½¿ç”¨ç¼–è¯‘æœŸç”Ÿæˆçš„è®¢é˜…æ–¹æ³•ä¿¡æ¯"></a>3.2.2 ä½¿ç”¨ç¼–è¯‘æœŸç”Ÿæˆçš„è®¢é˜…æ–¹æ³•ä¿¡æ¯</h4><p>ç½‘ä¸Šæœ‰å¾ˆå¤šä»‹ç» EventBus çš„æ–‡ç« ,ä½†æ˜¯å‡ ä¹æ²¡æœ‰æåˆ° EventBusAnnotationProcessor çš„ã€‚åœ¨ 3.0 ç‰ˆæœ¬å¼€å§‹ï¼Œ<code>EventBus</code>æä¾›äº†ä¸€ä¸ª<code>EventBusAnnotationProcessor</code>æ³¨è§£å¤„ç†å™¨æ¥åœ¨ç¼–è¯‘æœŸé€šè¿‡è¯»å–<code>@Subscribe()</code>æ³¨è§£å¹¶è§£æ,å¤„ç†å…¶ä¸­æ‰€åŒ…å«çš„ä¿¡æ¯,ç„¶åç”Ÿæˆ<code>java</code>ç±»æ¥ä¿å­˜æ‰€æœ‰è®¢é˜…è€…å…³äºè®¢é˜…çš„ä¿¡æ¯,è¿™æ ·å°±æ¯”åœ¨è¿è¡Œæ—¶ä½¿ç”¨åå°„æ¥è·å¾—è¿™äº›è®¢é˜…è€…çš„ä¿¡æ¯é€Ÿåº¦è¦å¿«.æˆ‘ä»¬å¯ä»¥å‚è€ƒ<code>EventBus</code>é¡¹ç›®é‡Œçš„<a href="https://link.jianshu.com?t=https://github.com/greenrobot/EventBus/tree/master/EventBusPerformance" target="_blank" rel="noopener">EventBusPerformance</a>è¿™ä¸ªä¾‹å­,ç¼–è¯‘åæˆ‘ä»¬å¯ä»¥åœ¨<code>build</code>æ–‡ä»¶å¤¹é‡Œæ‰¾åˆ°è¿™ä¸ªç±»,<a href="https://link.jianshu.com?t=https://github.com/greenrobot/EventBus/blob/master/EventBusPerformance/build.gradle#L27" target="_blank" rel="noopener">MyEventBusIndex</a> ç±»,å½“ç„¶ç±»åæ˜¯å¯ä»¥è‡ªå®šä¹‰çš„.æˆ‘ä»¬å¤§è‡´çœ‹ä¸€ä¸‹ç”Ÿæˆçš„<code>MyEventBusIndex</code>ç±»æ˜¯ä»€ä¹ˆæ ·çš„:</p>
<p>è®¢é˜…è€…ä¸­çš„ è®¢é˜…æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveEventFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="comment">//â€¦â€¦</span></div><div class="line">    </div><div class="line">    <span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN, priority = <span class="number">0</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(MsgEvent event)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onReceive: "</span> + event);</div><div class="line">        mTvMsg.setText(String.format(<span class="string">"msgId:%d\nmsg:%s"</span>, event.msgId, event.msg));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN, priority = <span class="number">10000</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ShowToast</span><span class="params">(MsgEvent event)</span> </span>&#123;</div><div class="line">        Toast.makeText(getActivity(), String.format(<span class="string">"msgId:%d\nmsg:%s"</span>, event.msgId, event.msg), Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** This class is generated by EventBus, do not edit. */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEventBusIndex</span> <span class="keyword">implements</span> <span class="title">SubscriberInfoIndex</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, SubscriberInfo&gt; SUBSCRIBER_INDEX;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        SUBSCRIBER_INDEX = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, SubscriberInfo&gt;();<span class="comment">//ä»¥è®¢é˜…è€…ä¸º keyï¼Œä»¥è®¢é˜…è€…ä¸­çš„ è®¢é˜…æ–¹æ³•åˆ—è¡¨ä¸º value çš„ map</span></div><div class="line">		<span class="comment">//å°† ReceiveEventFragment çš„è®¢é˜…ä¿¡æ¯å­˜å‚¨åˆ° map ä¸­</span></div><div class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(com.test.commentdemo.eventbusdemo.ReceiveEventFragment.class,</div><div class="line">                <span class="keyword">true</span>, <span class="keyword">new</span> SubscriberMethodInfo[] &#123;</div><div class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onReceive"</span>, com.test.commentdemo.eventbusdemo.MsgEvent.class,</div><div class="line">                    ThreadMode.MAIN),</div><div class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"ShowToast"</span>, com.test.commentdemo.eventbusdemo.MsgEvent.class,</div><div class="line">                    ThreadMode.MAIN, <span class="number">10000</span>, <span class="keyword">false</span>),</div><div class="line">        &#125;));<span class="comment">//è®¢é˜…è€…ä¸­æ‰€æœ‰çš„è®¢é˜…æ–¹æ³•</span></div><div class="line">        </div><div class="line">        <span class="comment">//â€¦â€¦ä»£ç çœç•¥ï¼ˆå­˜å‚¨å…¶ä»–è®¢é˜…è€…çš„è®¢é˜…ä¿¡æ¯åˆ° map ä¸­ï¼‰</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putIndex</span><span class="params">(SubscriberInfo info)</span> </span>&#123;</div><div class="line">        SUBSCRIBER_INDEX.put(info.getSubscriberClass(), info);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SubscriberInfo <span class="title">getSubscriberInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">        SubscriberInfo info = SUBSCRIBER_INDEX.get(subscriberClass);<span class="comment">//æ ¹æ®ç±»å‹ä» Map è·å–è®¢é˜…è€…çš„è®¢é˜…ä¿¡æ¯</span></div><div class="line">        <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> info;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»§ç»­å‰é¢ ignoreGeneratedIndex ä¸º false æ—¶ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹åˆ†æ”¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">    FindState findState = prepareFindState();</div><div class="line">    findState.initForSubscriber(subscriberClass);</div><div class="line">    <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</div><div class="line">        findState.subscriberInfo = getSubscriberInfo(findState);</div><div class="line">        <span class="keyword">if</span> (findState.subscriberInfo != <span class="keyword">null</span>) &#123;</div><div class="line">            SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods();<span class="comment">//è·å–è®¢é˜…çš„æ–¹æ³•ä¿¡æ¯</span></div><div class="line">            <span class="keyword">for</span> (SubscriberMethod subscriberMethod : array) &#123;</div><div class="line">                <span class="keyword">if</span> (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) &#123;</div><div class="line">                    findState.subscriberMethods.add(subscriberMethod);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            findUsingReflectionInSingleClass(findState);<span class="comment">//å¦‚æœæ‰¾ä¸åˆ°ç›¸åº”çš„è®¢é˜…æ–¹æ³•ä¿¡æ¯ï¼ˆå¯èƒ½ä½¿ç”¨ EventBus å®ä¾‹ä¹‹å‰ï¼Œæ²¡æœ‰å°†MyEventBusIndex ï¼‰ï¼Œéœ€è¦é€šè¿‡åå°„è·å–è®¢é˜…æ–¹æ³•ä¿¡æ¯</span></div><div class="line">        &#125;</div><div class="line">        findState.moveToSuperclass();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> getMethodsAndRelease(findState);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>findUsingInfo()</code>æ–¹æ³•,å…¶æ— éå°±æ˜¯é€šè¿‡æŸ¥æ‰¾æˆ‘ä»¬å‰é¢æ‰€è¯´çš„<code>MyEventBusIndex</code>ç±»ä¸­çš„ä¿¡æ¯,æ¥è½¬æ¢æˆ<code>List&lt;SubscriberMethod&gt;</code>ä»è€Œè·å¾—è®¢é˜…ç±»çš„ç›¸å…³è®¢é˜…å‡½æ•°çš„å„ç§ä¿¡æ¯</p>
<p>SubscriberMethodFinder#getSubscriberInfo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> SubscriberInfo <span class="title">getSubscriberInfo</span><span class="params">(SubscriberMethodFinder.FindState findState)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(findState.subscriberInfo != <span class="keyword">null</span> &amp;&amp; findState.subscriberInfo.getSuperSubscriberInfo() != <span class="keyword">null</span>) </div><div class="line">        SubscriberInfo superclassInfo = findState.subscriberInfo.getSuperSubscriberInfo();<span class="comment">//è·å–çˆ¶ç±»çš„è®¢é˜…æ–¹æ³•ä¿¡æ¯</span></div><div class="line">        <span class="keyword">if</span>(findState.clazz == superclassInfo.getSubscriberClass()) &#123;<span class="comment">//</span></div><div class="line">            <span class="keyword">return</span> superclassInfo;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.subscriberInfoIndexes != <span class="keyword">null</span>) &#123;</div><div class="line">        Iterator superclassInfo1 = <span class="keyword">this</span>.subscriberInfoIndexes.iterator();</div><div class="line">		<span class="comment">//éå†ï¼Œä» index ä¸­è·å– è®¢é˜…ä¿¡æ¯</span></div><div class="line">        <span class="keyword">while</span>(superclassInfo1.hasNext()) &#123;</div><div class="line">            SubscriberInfoIndex index = (SubscriberInfoIndex)superclassInfo1.next();</div><div class="line">            SubscriberInfo info = index.getSubscriberInfo(findState.clazz);<span class="comment">//ä»è‡ªåŠ¨ç”Ÿæˆçš„ MyEventBusIndex ç±»ä¸­çš„ SUBSCRIBER_INDEX é‡Œé¢è·å–è®¢é˜…æ–¹æ³•ä¿¡æ¯</span></div><div class="line">            <span class="keyword">if</span>(info != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> info;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-3-è§£æ³¨å†Œ"><a href="#3-3-è§£æ³¨å†Œ" class="headerlink" title="3.3 è§£æ³¨å†Œ"></a>3.3 è§£æ³¨å†Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Unregisters the given subscriber from all event classes. */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">    List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber);<span class="comment">//è·å–è®¢é˜…è€…è®¢é˜…çš„äº‹ä»¶åˆ—è¡¨</span></div><div class="line">    <span class="keyword">if</span> (subscribedTypes != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;<span class="comment">//éå†è®¢é˜…è€…æ‰€è®¢é˜…çš„äº‹ä»¶</span></div><div class="line">            <span class="comment">//ä»äº‹ä»¶å¯¹åº”çš„è®¢é˜…åˆ—è¡¨ä¸­ è®¢é˜…è€…çš„è®¢é˜…ä¿¡æ¯</span></div><div class="line">            unsubscribeByEventType(subscriber, eventType);</div><div class="line">        typesBySubscriber.remove(subscriber);<span class="comment">//ç§»é™¤è®¢é˜…è€…</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        logger.log(Level.WARNING, <span class="string">"Subscriber to unregister was not registered before: "</span> + subscriber.getClass());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Only updates subscriptionsByEventType, not typesBySubscriber! Caller must update typesBySubscriber. */</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsubscribeByEventType</span><span class="params">(Object subscriber, Class&lt;?&gt; eventType)</span> </span>&#123;</div><div class="line">    List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</div><div class="line">    <span class="comment">//ä»äº‹ä»¶å¯¹åº”çš„è®¢é˜…åˆ—è¡¨ä¸­ è®¢é˜…è€…çš„è®¢é˜…ä¿¡æ¯</span></div><div class="line">    <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">int</span> size = subscriptions.size();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</div><div class="line">            Subscription subscription = subscriptions.get(i);</div><div class="line">            <span class="keyword">if</span> (subscription.subscriber == subscriber) &#123;</div><div class="line">                subscription.active = <span class="keyword">false</span>;</div><div class="line">                subscriptions.remove(i);</div><div class="line">                i--;</div><div class="line">                size--;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-4-å‘é€äº‹ä»¶"><a href="#3-4-å‘é€äº‹ä»¶" class="headerlink" title="3.4 å‘é€äº‹ä»¶"></a>3.4 å‘é€äº‹ä»¶</h3><p>EventBus#post</p>
<h4 id="1-è·å–è®¢é˜…åˆ—è¡¨"><a href="#1-è·å–è®¢é˜…åˆ—è¡¨" class="headerlink" title="1. è·å–è®¢é˜…åˆ—è¡¨"></a>1. è·å–è®¢é˜…åˆ—è¡¨</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">public class EventBus &#123;</div><div class="line"></div><div class="line">    private final ThreadLocal&lt;EventBus.PostingThreadState&gt; currentPostingThreadState;//çº¿ç¨‹ç§æœ‰å˜é‡â€”â€”å½“å‰å‘å¸ƒçº¿ç¨‹çŠ¶æ€</div><div class="line"></div><div class="line">    public void post(Object event) &#123;</div><div class="line">        EventBus.PostingThreadState postingState = (EventBus.PostingThreadState)this.currentPostingThreadState.get();//è®°å½•å‘å¸ƒçº¿ç¨‹çš„çŠ¶æ€ï¼ˆæ¯”å¦‚æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼‰</div><div class="line">        List eventQueue = postingState.eventQueue;//ä»å‘å¸ƒçŠ¶æ€ä¸­è·å–äº‹ä»¶é˜Ÿåˆ—</div><div class="line">        eventQueue.add(event);//æ·»åŠ è¿›äº‹ä»¶é˜Ÿåˆ—çš„é˜Ÿå°¾</div><div class="line">        if(!postingState.isPosting) &#123;//å½“å‰ä¸æ˜¯å¤„äºåˆ†å‘çŠ¶æ€</div><div class="line">            postingState.isMainThread = this.isMainThread();//æ˜¯å¦åœ¨ä¸»çº¿ç¨‹</div><div class="line">            postingState.isPosting = true;//å°†çŠ¶æ€æ”¹ä¸ºå‘å¸ƒä¸­</div><div class="line">            if(postingState.canceled) &#123;//å–æ¶ˆå‘å¸ƒ</div><div class="line">                throw new EventBusException("Internal error. Abort state was not reset</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            try &#123;</div><div class="line">                while(!eventQueue.isEmpty()) &#123;//åªè¦äº‹ä»¶é˜Ÿåˆ—éç©ºï¼Œå°±ä¸€ç›´å¾€å¤–å–å‡ºäº‹ä»¶å¹¶å‘å¸ƒ</div><div class="line">                    this.postSingleEvent(eventQueue.remove(0), postingState);</div><div class="line">                &#125;</div><div class="line">            &#125; finally &#123;</div><div class="line">                postingState.isPosting = false;</div><div class="line">                postingState.isMainThread = false;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">                                            </div><div class="line">    static final class PostingThreadState &#123;</div><div class="line">        final List&lt;Object&gt; eventQueue = new ArrayList();//äº‹ä»¶é˜Ÿåˆ—</div><div class="line">        boolean isPosting;</div><div class="line">        boolean isMainThread;</div><div class="line">        Subscription subscription;</div><div class="line">        Object event;</div><div class="line">        boolean canceled;</div><div class="line"></div><div class="line">        PostingThreadState() &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;                                                                   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PostingThreadState</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> List&lt;Object&gt; eventQueue = <span class="keyword">new</span> ArrayList&lt;&gt;();<span class="comment">//äº‹ä»¶é˜Ÿåˆ—</span></div><div class="line">    <span class="keyword">boolean</span> isPosting;<span class="comment">//æ˜¯å¦æ­£åœ¨åˆ†å‘ä¸­</span></div><div class="line">    <span class="keyword">boolean</span> isMainThread;<span class="comment">//æ˜¯å¦åœ¨ä¸»çº¿ç¨‹</span></div><div class="line">    Subscription subscription;</div><div class="line">    Object event;<span class="comment">//äº‹ä»¶</span></div><div class="line">    <span class="keyword">boolean</span> canceled;<span class="comment">//å–æ¶ˆ</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;PostingThreadState&gt; currentPostingThreadState = <span class="keyword">new</span> ThreadLocal&lt;PostingThreadState&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> PostingThreadState <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PostingThreadState();</div><div class="line">    &#125;</div><div class="line">&#125;;<span class="comment">//currentPostingThreadState æ˜¯ä¸€ä¸ªçº¿ç¨‹å±€éƒ¨å˜é‡</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/** Posts the given event to the event bus. */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</div><div class="line">    PostingThreadState postingState = currentPostingThreadState.get();<span class="comment">//è·å–å½“å‰çº¿ç¨‹äº‹ä»¶åˆ†å‘çŠ¶æ€</span></div><div class="line">    List&lt;Object&gt; eventQueue = postingState.eventQueue;</div><div class="line">    eventQueue.add(event);<span class="comment">//æ·»åŠ åˆ°äº‹åŠ¡é˜Ÿåˆ—ä¸­</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!postingState.isPosting) &#123;<span class="comment">//å¦‚æœå½“å‰ä¸æ˜¯åœ¨åˆ†å‘çŠ¶æ€,åˆ™è¿›å…¥åˆ†å‘çŠ¶æ€</span></div><div class="line">        postingState.isMainThread = isMainThread();</div><div class="line">        postingState.isPosting = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (postingState.canceled) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Internal error. Abort state was not reset"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//ç¼–è¯‘äº‹ä»¶é˜Ÿåˆ—ï¼Œé€ä¸€è¿›è¡Œåˆ†å‘</span></div><div class="line">            <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123;</div><div class="line">                postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            postingState.isPosting = <span class="keyword">false</span>;</div><div class="line">            postingState.isMainThread = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>EventBus#postSingleEvent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> <span class="keyword">throws</span> Error </span>&#123;</div><div class="line">    Class&lt;?&gt; eventClass = event.getClass();</div><div class="line">    <span class="keyword">boolean</span> subscriptionFound = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (eventInheritance) &#123;<span class="comment">//å¦‚æœäº‹ä»¶æ”¯æŒå­ç±»å‹ï¼ŒæŸ¥æ‰¾è¯¥äº‹ä»¶çš„æ‰€æœ‰å­ç±»å‹</span></div><div class="line">        List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass);</div><div class="line">        <span class="keyword">int</span> countTypes = eventTypes.size();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; countTypes; h++) &#123;</div><div class="line">            Class&lt;?&gt; clazz = eventTypes.get(h);</div><div class="line">            subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!subscriptionFound) &#123;</div><div class="line">        <span class="keyword">if</span> (logNoSubscriberMessages) &#123;</div><div class="line">            logger.log(Level.FINE, <span class="string">"No subscribers registered for event "</span> + eventClass);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sendNoSubscriberEvent &amp;&amp; eventClass != NoSubscriberEvent.class &amp;&amp;</div><div class="line">                eventClass != SubscriberExceptionEvent.class) &#123;</div><div class="line">            post(<span class="keyword">new</span> NoSubscriberEvent(<span class="keyword">this</span>, event));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>EventBus#postSingleEventForEventTypeï¼Œ       </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">//æŸ¥æ‰¾ äº‹ä»¶æ‰€å¯¹åº”çš„è®¢é˜…è€…åˆ—è¡¨ï¼Œç„¶åè¿­ä»£åˆ—è¡¨ï¼Œåˆ‡æ¢åˆ°ç›®æ ‡çº¿ç¨‹æ‰§è¡Œ</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span> </span>&#123;</div><div class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        subscriptions = subscriptionsByEventType.get(eventClass);<span class="comment">//æŸ¥æ‰¾ äº‹ä»¶æ‰€å¯¹åº”çš„è®¢é˜…è€…åˆ—è¡¨</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;</div><div class="line">        <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;</div><div class="line">            postingState.event = event;</div><div class="line">            postingState.subscription = subscription;</div><div class="line">            <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                postToSubscription(subscription, event, postingState.isMainThread);</div><div class="line">                aborted = postingState.canceled;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                postingState.event = <span class="keyword">null</span>;</div><div class="line">                postingState.subscription = <span class="keyword">null</span>;</div><div class="line">                postingState.canceled = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (aborted) &#123;<span class="comment">//äº‹ä»¶å–æ¶ˆäº†</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-åˆ‡æ¢åˆ°æŒ‡å®šçº¿ç¨‹"><a href="#2-åˆ‡æ¢åˆ°æŒ‡å®šçº¿ç¨‹" class="headerlink" title="2.åˆ‡æ¢åˆ°æŒ‡å®šçº¿ç¨‹"></a>2.åˆ‡æ¢åˆ°æŒ‡å®šçº¿ç¨‹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</div><div class="line">        <span class="keyword">case</span> POSTING:<span class="comment">//</span></div><div class="line">            invokeSubscriber(subscription, event);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> MAIN:</div><div class="line">            <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                invokeSubscriber(subscription, event);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mainThreadPoster.enqueue(subscription, event);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> MAIN_ORDERED:</div><div class="line">            <span class="keyword">if</span> (mainThreadPoster != <span class="keyword">null</span>) &#123;</div><div class="line">                mainThreadPoster.enqueue(subscription, event);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// temporary: technically not correct as poster not decoupled from subscriber</span></div><div class="line">                invokeSubscriber(subscription, event);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BACKGROUND:<span class="comment">//åå°çº¿ç¨‹</span></div><div class="line">            <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                backgroundPoster.enqueue(subscription, event);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                invokeSubscriber(subscription, event);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> ASYNC:<span class="comment">//æ–°å»ºä¸€ä¸ªå­çº¿ç¨‹å¤„ç†</span></div><div class="line">            asyncPoster.enqueue(subscription, event);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="BACKGROUND"><a href="#BACKGROUND" class="headerlink" title="BACKGROUND"></a>BACKGROUND</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">    PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);<span class="comment">//åŒ…è£…ä¸ºä¸€ä¸ª PendingPost</span></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;<span class="comment">//åŠ é”ï¼Œè¿›å…¥åŒæ­¥å—</span></div><div class="line">        queue.enqueue(pendingPost);<span class="comment">//æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­</span></div><div class="line">        <span class="keyword">if</span> (!executorRunning) &#123;<span class="comment">//å¦‚æœç°åœ¨æ²¡æœ‰åœ¨æ‰§è¡Œ åå°ä»»åŠ¡ï¼Œåˆ™è·å–ä¸€ä¸ªæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span></div><div class="line">            executorRunning = <span class="keyword">true</span>;</div><div class="line">            eventBus.getExecutorService().execute(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;<span class="comment">//å¾ªç¯ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©º</span></div><div class="line">                PendingPost pendingPost = queue.poll(<span class="number">1000</span>);<span class="comment">//è·å– PendingPostï¼Œæœ€å¤šç­‰åˆ° 1 ç§’</span></div><div class="line"></div><div class="line">                <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">	                <span class="comment">//å‰é¢å–ä¸åˆ° PendingPostï¼Œä¸‹é¢è¿›è¡ŒåŒé‡æ ¡éªŒæ£€æŸ¥</span></div><div class="line">                    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                        <span class="comment">// Check again, this time in synchronized</span></div><div class="line">                        pendingPost = queue.poll();<span class="comment">//</span></div><div class="line">                        <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="comment">//é˜Ÿåˆ—ç¡®å®ä¸ºç©ºï¼Œåœæ­¢è¿è¡Œ</span></div><div class="line">                            executorRunning = <span class="keyword">false</span>;</div><div class="line">                            <span class="keyword">return</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                eventBus.invokeSubscriber(pendingPost);<span class="comment">//é€šè¿‡åå°„è°ƒç”¨ç›¸åº”çš„æ–¹æ³•</span></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            eventBus.getLogger().log(Level.WARNING, Thread.currentThread().getName() + <span class="string">" was interruppted"</span>, e);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        executorRunning = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="MAIN"><a href="#MAIN" class="headerlink" title="MAIN"></a>MAIN</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mainThreadPoster.enqueue(subscription, event);</div></pre></td></tr></table></figure>
<p>HandlerPoster#enqueue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">    PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;<span class="comment">//åŠ é”</span></div><div class="line">        queue.enqueue(pendingPost);<span class="comment">//åŠ å…¥ pendingQueue ä¸­ã€‚è¯¥é˜Ÿåˆ—ä¼šåœ¨ handleMessage æ–¹æ³•ä¸­è°ƒç”¨</span></div><div class="line">        <span class="keyword">if</span> (!handlerActive) &#123;<span class="comment">//å¦‚æœå½“å‰ handler ä¸æ˜¯å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œåˆ™é€€å‡º</span></div><div class="line">            handlerActive = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;<span class="comment">//å‘é€ä¿¡æ¯ï¼Œæç¤º</span></div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not send handler message"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>org.greenrobot.eventbus.HandlerPoster#handleMessage</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> rescheduled = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">long</span> started = SystemClock.uptimeMillis();</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            PendingPost pendingPost = queue.poll();</div><div class="line">            <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                    <span class="comment">// Check again, this time in synchronized</span></div><div class="line">                    pendingPost = queue.poll();</div><div class="line">                    <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                        handlerActive = <span class="keyword">false</span>;</div><div class="line">                        <span class="keyword">return</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            eventBus.invokeSubscriber(pendingPost);</div><div class="line">            <span class="keyword">long</span> timeInMethod = SystemClock.uptimeMillis() - started;</div><div class="line">            <span class="keyword">if</span> (timeInMethod &gt;= maxMillisInsideHandleMessage) &#123;</div><div class="line">                <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not send handler message"</span>);</div><div class="line">                &#125;</div><div class="line">                rescheduled = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        handlerActive = rescheduled;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ handleMessage æ–¹æ³•å†…éƒ¨åœç•™æ—¶é—´ä¸èƒ½å¤§äº 10 æ¯«ç§’ï¼Œä»</p>
<h5 id="MAIN-ORDERED"><a href="#MAIN-ORDERED" class="headerlink" title="MAIN_ORDERED"></a>MAIN_ORDERED</h5><p>æ–°å¢åŠ çš„æ¨¡å¼ï¼Œä½†æ˜¯å½“å‰ç‰ˆæœ¬çš„å®ç°è¿˜ä¸å®Œå–„ã€‚</p>
<h5 id="ASYN"><a href="#ASYN" class="headerlink" title="ASYN"></a>ASYN</h5><p>å°†äº‹ä»¶æ·»åŠ  cachedThreadPool ä¸­æ‰§è¡Œ(å¦‚æœå½“å‰æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™å¤ç”¨ç©ºé—²çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºæ–°çº¿ç¨‹)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">    PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</div><div class="line">    queue.enqueue(pendingPost);</div><div class="line">    eventBus.getExecutorService().execute(<span class="keyword">this</span>);<span class="comment">//æ”¾åˆ°é»˜è®¤çš„ cachedThreaPool ä¸­æ‰§è¡Œ</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    PendingPost pendingPost = queue.poll();</div><div class="line">    <span class="keyword">if</span>(pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No pending post available"</span>);</div><div class="line">    &#125;</div><div class="line">    eventBus.invokeSubscriber(pendingPost);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-åå°„è°ƒç”¨è®¢é˜…æ–¹æ³•"><a href="#3-åå°„è°ƒç”¨è®¢é˜…æ–¹æ³•" class="headerlink" title="3.åå°„è°ƒç”¨è®¢é˜…æ–¹æ³•"></a>3.åå°„è°ƒç”¨è®¢é˜…æ–¹æ³•</h4><p>org.greenrobot.eventbus.EventBus#invokeSubscriber(org.greenrobot.eventbus.PendingPost)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(PendingPost pendingPost)</span> </span>&#123;</div><div class="line">    Object event = pendingPost.event;</div><div class="line">    Subscription subscription = pendingPost.subscription;</div><div class="line">    PendingPost.releasePendingPost(pendingPost);</div><div class="line">    <span class="keyword">if</span> (subscription.active) &#123;</div><div class="line">        invokeSubscriber(subscription, event);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        subscription.subscriberMethod.method.invoke(subscription.subscriber, event);</div><div class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">        handleSubscriberException(subscription, event, e.getCause());</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected exception"</span>, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ‡æ¢åˆ°æŒ‡å®šçº¿ç¨‹ä¹‹åï¼Œé€šè¿‡åå°„çš„æ–¹æ³•ï¼Œè°ƒç”¨è®¢é˜…æ–¹æ³•ã€‚</p>
<h2 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h2><p>EventBus çš„å®ç°åŸç†å¯ä»¥å½’ç»“ä¸ºä»¥ä¸‹ä¸‰ç‚¹</p>
<ul>
<li>æ³¨å†Œâ€”&gt;æ‰«æè®¢é˜…æ–¹æ³•ï¼Œæ·»åŠ åˆ°è®¢é˜…æ–¹æ³•åˆ—è¡¨ä¸­</li>
<li>å‘é€äº‹ä»¶â€”&gt;æ ¹æ®äº‹ä»¶çš„ç±»å‹ï¼Œéå†æ–¹æ³•åˆ—è¡¨ï¼Œåå°„è°ƒç”¨è®¢é˜…æ–¹æ³•</li>
<li>è§£æ³¨å†Œâ€”&gt;ä»è®¢é˜…æ–¹æ³•åˆ—è¡¨ä¸­ç§»é™¤ç›¸åº”çš„è®¢é˜…æ–¹æ³•</li>
</ul>
<p><code>EventBus</code> è™½ç„¶ä¸æ˜¯æ ‡å‡†çš„è§‚å¯Ÿè€…æ¨¡å¼çš„å®ç°, ä½†æ˜¯å®ƒçš„æ•´ä½“å°±æ˜¯ä¸€ä¸ªå‘å¸ƒ / è®¢é˜…æ¡†æ¶, ä¹Ÿæ‹¥æœ‰è§‚å¯Ÿè€…æ¨¡å¼çš„ä¼˜ç‚¹, æ¯”å¦‚: å‘å¸ƒè€…å’Œè®¢é˜…è€…çš„è§£è€¦ã€‚</p>
<h2 id="äº”ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#äº”ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="äº”ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>äº”ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://p.codekk.com/blogs/detail/54cfab086c4761e5001b2538" target="_blank" rel="noopener">EventBus æºç è§£æ</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/22489785" target="_blank" rel="noopener">EventBus é«˜æ•ˆä½¿ç”¨åŠæºç è§£æ-çŸ¥ä¹ä¸“æ </a></li>
<li><a href="https://www.jianshu.com/p/f057c460c77e" target="_blank" rel="noopener">EventBus 3.0 æºç åˆ†æ</a></li>
<li><a href="http://xuchongyang.com/2017/07/17/EventBus-3-0-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BC%96%E8%AF%91%E6%97%B6%E6%B3%A8%E8%A7%A3%E5%92%8C%E8%BF%90%E8%A1%8C%E6%97%B6%E6%B3%A8%E8%A7%A3/" target="_blank" rel="noopener">EventBus 3.0 æºç åˆ†æï¼ˆäºŒï¼‰æ³¨è§£å¤„ç†å™¨çš„ä½¿ç”¨</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®æ¬¢è¿åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ã€‚è°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> æºç åˆ†æ </category>
            
            <category> æ¡†æ¶åŸç† </category>
            
        </categories>
        
        
        <tags>
            
            <tag> æºç åˆ†æ </tag>
            
            <tag> æ¡†æ¶åŸç† </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æ‹†è½®å­ç³»åˆ—â€”â€”ButterKnifeå·¥ä½œåŸç†]]></title>
      <url>https://timlin-pro.github.io/blog/2017/10/07/%E6%8B%86%E8%BD%AE%E5%AD%90%E7%B3%BB%E5%88%97%E2%80%94%E2%80%94ButterKnife%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><p>æœ¬ç¯‡åšå®¢ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†</p>
<ul>
<li>æ—¥å¸¸ä½¿ç”¨ ButterKnife çš„æ–¹å¼ä»¥åŠ ButterKnife çš„ bind æ–¹æ³•</li>
<li>Xxx_ViewBinding ç±»æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ</li>
<li>æ³¨è§£å¤„ç†å™¨æ˜¯æ€ä¹ˆæ³¨å†Œçš„ï¼Ÿ</li>
</ul>
<p>å…¶ä¸­çš„ä»£ç åŸºäº ButterKnife 8.6.0</p>
<p>æœ¬æ–‡å‡è®¾ä½ å·²ç»å¯¹æ³¨è§£æœ‰æ‰€äº†è§£ã€‚ä¸äº†è§£æ³¨è§£çš„åŒå­¦å¯ä»¥å…ˆçœ‹çœ‹<a href="http://a.codekk.com/detail/Android/Trinea/%E5%85%AC%E5%85%B1%E6%8A%80%E6%9C%AF%E7%82%B9%E4%B9%8B%20Java%20%E6%B3%A8%E8%A7%A3%20Annotation" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a> ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ç¼–è¯‘æœŸæ³¨è§£ã€‚</p>
<a id="more"></a>
<h2 id="è¿è¡ŒæœŸ-ButterKnife-bind"><a href="#è¿è¡ŒæœŸ-ButterKnife-bind" class="headerlink" title="è¿è¡ŒæœŸ ButterKnife#bind"></a>è¿è¡ŒæœŸ ButterKnife#bind</h2><p>æˆ‘ä»¬é€šå¸¸éƒ½æ˜¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ä½¿ç”¨ ButterKnife çš„ã€‚å°†è¦ç»‘å®šçš„æ§ä»¶åŠ ä¸Š @BindView æ³¨è§£ï¼Œåœ¨ onCreate æ–¹æ³•    å®Œæˆ <code>setContentView(R.layout.activity_main);</code> ä¹‹åã€‚è°ƒç”¨ <code>ButterKnife.bind(this);</code> å¯¹ç›¸åº”çš„  View è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"MainActivity"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@BindView</span>(R.id.btn)</div><div class="line">    Button mBtn;</div><div class="line">    <span class="meta">@BindView</span>(R.id.radar_view)</div><div class="line">    RadarView mRadarView;</div><div class="line">  </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        ButterKnife.bind(<span class="keyword">this</span>);<span class="comment">//ButterKnife çš„å…¥å£</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>public static Unbinder bind(@NonNull Activity target)</code> ï¼Œåœ¨ Activity ä¸­ä»¥è¯¥æ–¹æ³•ä½œä¸ºå…¥å£ï¼Œé¦–å…ˆè·å– ä¸ Activity ç›¸å…³è”çš„ windowï¼Œç„¶åå†é€šè¿‡ window è·å– DecorViewã€‚æœ€åé€šè¿‡ <code>createBinding</code> æ–¹æ³•åˆ›å»ºç›¸å…³ç»‘å®šã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull Activity target)</span> </span>&#123;</div><div class="line">  View sourceView = target.getWindow().getDecorView();</div><div class="line">  <span class="keyword">return</span> createBinding(target, sourceView);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Unbinder <span class="title">createBinding</span><span class="params">(@NonNull Object target, @NonNull View source)</span> </span>&#123;</div><div class="line">  Class&lt;?&gt; targetClass = target.getClass();</div><div class="line">  <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Looking up binding for "</span> + targetClass.getName());</div><div class="line">  Constructor&lt;? extends Unbinder&gt; constructor = findBindingConstructorForClass(targetClass);<span class="comment">//æŸ¥æ‰¾ç›®æ ‡ç±»çš„æ„é€ å™¨</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">return</span> Unbinder.EMPTY;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">return</span> constructor.newInstance(target, source);<span class="comment">//åˆ©ç”¨åå°„åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œè¿™é‡Œå®é™…ä¸Šè°ƒç”¨äº† Xxx_ViewBinding çš„æ„é€ æ–¹æ³•ï¼ˆç”±æ­¤å¯ä»¥çœ‹åˆ°ï¼ŒButterknife ä¹Ÿæ˜¯æœ‰ç”¨åˆ°ä¸€ç‚¹åå°„çš„ï¼‰</span></div><div class="line">  &#125; </div><div class="line">  <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Constructor&lt;? extends Unbinder&gt;&gt; BINDINGS = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();<span class="comment">//LinkedHashMap ä½œä¸ºç¼“å­˜å®¹å™¨</span></div><div class="line"></div><div class="line"><span class="meta">@Nullable</span> <span class="meta">@CheckResult</span> <span class="meta">@UiThread</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Unbinder&gt; findBindingConstructorForClass(Class&lt;?&gt; cls) &#123;</div><div class="line">  Constructor&lt;? extends Unbinder&gt; bindingCtor = BINDINGS.get(cls);<span class="comment">//å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾</span></div><div class="line">  <span class="keyword">if</span> (bindingCtor != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">return</span> bindingCtor;<span class="comment">//ç¼“å­˜å‘½ä¸­ç›´æ¥è¿”å›</span></div><div class="line">  &#125;</div><div class="line">  String clsName = cls.getName();<span class="comment">//è·å–ç±»å‹</span></div><div class="line">  <span class="comment">//å¦‚æœæ˜¯ Framework å±‚çš„ç±»ï¼Œåˆ™ç›´æ¥è¿”å› null</span></div><div class="line">  <span class="keyword">if</span> (clsName.startsWith(<span class="string">"android."</span>) || clsName.startsWith(<span class="string">"java."</span>)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    Class&lt;?&gt; bindingClass = cls.getClassLoader().loadClass(clsName + <span class="string">"_ViewBinding"</span>);<span class="comment">//åŠ è½½ç±»</span></div><div class="line">    <span class="comment">//noinspection unchecked</span></div><div class="line">    bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.getConstructor(cls, View.class);<span class="comment">//è·å–æ„é€ å™¨</span></div><div class="line">  &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">    bindingCtor = findBindingConstructorForClass(cls.getSuperclass());<span class="comment">//é€’å½’æŸ¥æ‰¾çˆ¶ç±»çš„æ„é€ å™¨</span></div><div class="line">  &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to find binding constructor for "</span> + clsName, e);</div><div class="line">  &#125;</div><div class="line">  BINDINGS.put(cls, bindingCtor);<span class="comment">//åŠ å…¥åˆ°ç¼“å­˜ä¸­</span></div><div class="line">  <span class="keyword">return</span> bindingCtor;<span class="comment">//è¿”å›æ„é€ å™¨</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»¥ä¸‹ä¸ºç¼–è¯‘å™¨ç”Ÿæˆçš„ MainActivity_ViewBinding ç±»ï¼Œè¯¥ç±»åœ¨æ„é€ æ–¹æ³•ä¸­å¯¹é‚£äº›åœ¨ MainActivity ä¸­æ‰“äº†æ³¨è§£ï¼ˆä¾‹å¦‚ï¼š<code>@BindView</code>ï¼‰çš„ View è¿›è¡Œäº†åˆå§‹åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity_ViewBinding</span> <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> MainActivity target;<span class="comment">//ç›®æ ‡ç±»</span></div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2131427444;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2131427442;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2131427443;</div><div class="line"></div><div class="line">  <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MainActivity_ViewBinding</span><span class="params">(MainActivity target)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(target, target.getWindow().getDecorView());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MainActivity_ViewBinding</span><span class="params">(<span class="keyword">final</span> MainActivity target, View source)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.target = target;</div><div class="line"></div><div class="line">    View view;</div><div class="line">    view = Utils.findRequiredView(source, R.id.btn, <span class="string">"field 'mBtn' and method 'onViewClicked'"</span>);<span class="comment">//findViewbyId</span></div><div class="line">    target.mBtn = Utils.castView(view, R.id.btn, <span class="string">"field 'mBtn'"</span>, Button.class);<span class="comment">//å¼ºåˆ¶ç±»å‹è½¬æ¢</span></div><div class="line">    view2131427444 = view;</div><div class="line">    view.setOnClickListener(<span class="keyword">new</span> DebouncingOnClickListener() &#123;<span class="comment">//æ³¨å†Œç›‘å¬å™¨</span></div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClick</span><span class="params">(View p0)</span> </span>&#123;</div><div class="line">        target.onViewClicked(p0);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    target.mRadarView = Utils.findRequiredViewAsType(source, R.id.radar_view, <span class="string">"field 'mRadarView'"</span>, RadarView.class);<span class="comment">//findViewbyId</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæ’ä¸€ä¸ªå°è¯é¢˜ï¼šé€šå¸¸æˆ‘ä»¬éƒ½ä¼šæŠŠä¸éœ€è¦è¢«å¤–éƒ¨ä½¿ç”¨åˆ°çš„æˆå‘˜å˜é‡å£°æ˜ä¸º private çš„ï¼Œä½†æ˜¯å›å¤´çœ‹çœ‹æˆ‘ä»¬ä½¿ç”¨ <code>@BindView</code>çš„ View è®¿é—®æƒé™å‡ä¸º defalut ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä» MainActivity_ViewBinding çš„æ„é€ æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°å¯¹ View è¿›è¡Œèµ‹å€¼æ—¶ç›´æ¥ä½¿ç”¨äº† <code>target.mBtnã€ target.mRadarView</code>ï¼Œå¦‚æœå£°æ˜ä¸º private ï¼Œé‚£å°±éœ€è¦é€šè¿‡åå°„æ‰èƒ½è®¿é—®åˆ°å¯¹åº”çš„ Viewï¼Œè¿™æ ·ä¼šæœ‰æ€§èƒ½ä¸Šçš„æŸå¤±ã€‚</p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>åœ¨è¿è¡Œæ—¶ä»¥ <code>ButterKnife#bind</code> æ–¹æ³•ä½œä¸ºå…¥å£ï¼Œé¦–å…ˆä»¥ç›®æ ‡ class ä¸º key åˆ°ç¼“å­˜ï¼ˆä¸€ä¸ª <code>LinkedHashMap</code>ï¼‰ä¸­æŸ¥æ‰¾ç›¸åº”çš„ binding classï¼Œå¦‚æœå‘½ä¸­ç›´æ¥è¿”å›ã€‚å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™é€šè¿‡ç±»åŠ è½½å™¨åŠ è½½å¯¹åº”çš„ <code>Xxx_ViewBinding</code> ç±»ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°ç¼“å­˜ä¸­ï¼Œç„¶åè¿”å›ã€‚æœ€åè°ƒç”¨ Xxx_ViewBinding ç±»çš„æ„é€ å™¨ï¼ˆé€šè¿‡åå°„ï¼‰åˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚Xxx_ViewBinding ç±»çš„æ„é€ å™¨ä¸­å®Œæˆäº†å¯¹ View çš„ç»‘å®šã€‚æ¯”å¦‚  <code>findViewByIdï¼ŒsetOnClickListener</code></p>
<h2 id="ç¼–è¯‘æœŸç”Ÿæˆä»£ç "><a href="#ç¼–è¯‘æœŸç”Ÿæˆä»£ç " class="headerlink" title="ç¼–è¯‘æœŸç”Ÿæˆä»£ç "></a>ç¼–è¯‘æœŸç”Ÿæˆä»£ç </h2><h3 id="Qï¼šå‰é¢æåˆ°çš„-MainActivity-ViewBinding-ç±»æ˜¯å¦‚ä½•ç”Ÿæˆçš„å‘¢ï¼Ÿ"><a href="#Qï¼šå‰é¢æåˆ°çš„-MainActivity-ViewBinding-ç±»æ˜¯å¦‚ä½•ç”Ÿæˆçš„å‘¢ï¼Ÿ" class="headerlink" title="Qï¼šå‰é¢æåˆ°çš„ MainActivity_ViewBinding  ç±»æ˜¯å¦‚ä½•ç”Ÿæˆçš„å‘¢ï¼Ÿ"></a>Qï¼šå‰é¢æåˆ°çš„ MainActivity_ViewBinding  ç±»æ˜¯å¦‚ä½•ç”Ÿæˆçš„å‘¢ï¼Ÿ</h3><p> Answer: åœ¨ç¼–è¯‘æ—¶å¯¹ç±»ä¸­çš„ Annotation è¿›è¡Œè§£æï¼Œé€šè¿‡ JavaPoet ç”Ÿæˆç›¸åº”çš„ä»£ç ã€‚</p>
<p><code>ç¼–è¯‘æ—¶ Annotation</code> æŒ‡ @Retention ä¸º CLASS çš„ Annotationï¼Œç”±ç¼–è¯‘å™¨è‡ªåŠ¨è§£æã€‚å¼€å‘äººå‘˜éœ€è¦åšçš„<br>a. è‡ªå®šä¹‰ç±»ç»§æ‰¿è‡ª AbstractProcessor<br>b. é‡å†™å…¶ä¸­çš„ process å‡½æ•°<br>c. æ³¨å†Œæ³¨è§£å¤„ç†å™¨ã€‚æ³¨å†Œå®Œæˆåï¼Œ<strong>ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨æŸ¥æ‰¾æ‰€æœ‰ç»§æ‰¿è‡ª AbstractProcessor çš„ç±»ï¼Œç„¶åè°ƒç”¨ä»–ä»¬çš„ process æ–¹æ³•å»å¤„ç†</strong></p>
<h3 id="è‡ªå®šä¹‰-Annotation-ç”¨äºå­˜å‚¨å…ƒæ•°æ®"><a href="#è‡ªå®šä¹‰-Annotation-ç”¨äºå­˜å‚¨å…ƒæ•°æ®" class="headerlink" title="è‡ªå®šä¹‰ Annotation  ç”¨äºå­˜å‚¨å…ƒæ•°æ®"></a>è‡ªå®šä¹‰ Annotation  ç”¨äºå­˜å‚¨å…ƒæ•°æ®</h3><p>ä»¥ BindView æ³¨è§£ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>(CLASS) <span class="meta">@Target</span>(FIELD)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BindView &#123;</div><div class="line">  <span class="comment">/** View ID to which the field will be bound. */</span></div><div class="line">  <span class="meta">@IdRes</span> <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>@Retention(CLASS)</code> ï¼šè¡¨ç¤ºä¿ç•™åˆ°ç¼–è¯‘æœŸ</li>
<li><code>@Target(FIELD)</code>ï¼šè¡¨ç¤ºä½œç”¨åŸŸä¸ºæˆå‘˜å˜é‡</li>
</ul>
<h3 id="æ³¨è§£å¤„ç†å™¨-ButterKnifeProcessor"><a href="#æ³¨è§£å¤„ç†å™¨-ButterKnifeProcessor" class="headerlink" title="æ³¨è§£å¤„ç†å™¨ ButterKnifeProcessor"></a>æ³¨è§£å¤„ç†å™¨ ButterKnifeProcessor</h3><p>ButterKnifeProcessor ç»§æ‰¿è‡ª AbstractProcessor ï¼ŒAbstractProcessor çš„ä¸»è¦æºç å¦‚ä¸‹ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å››ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractProcessor</span> <span class="keyword">implements</span> <span class="title">Processor</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> ProcessingEnvironment processingEnv;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractProcessor</span><span class="params">()</span> </span>&#123;<span class="comment">//é»˜è®¤æ„é€ å™¨</span></div><div class="line">    &#125;</div><div class="line">	<span class="comment">//è·å–æ”¯æŒçš„æ³¨è§£ç±»å‹</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        SupportedAnnotationTypes var1 = (SupportedAnnotationTypes)<span class="keyword">this</span>.getClass().getAnnotation(SupportedAnnotationTypes.class);<span class="comment">//è·å–æ”¯æŒçš„æ³¨è§£ç±»å‹</span></div><div class="line">        <span class="keyword">if</span>(var1 == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.isInitialized()) &#123;<span class="comment">//å¦‚æœå·²ç»åˆå§‹åŒ–äº†ï¼Œæ‰“å°æé†’</span></div><div class="line">                <span class="keyword">this</span>.processingEnv.getMessager().printMessage(Kind.WARNING, <span class="string">"No SupportedAnnotationTypes annotation found on "</span> + <span class="keyword">this</span>.getClass().getName() + <span class="string">", returning an empty set."</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> Collections.emptySet();<span class="comment">//è¿”å›ç©ºé›†</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> arrayToSet(var1.value());<span class="comment">//è¿”å›æ”¯æŒçš„æ³¨è§£é›†åˆ</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;<span class="comment">//è·å–æ”¯æŒçš„æºç ç‰ˆæœ¬</span></div><div class="line">        SupportedSourceVersion var1 = (SupportedSourceVersion)<span class="keyword">this</span>.getClass().getAnnotation(SupportedSourceVersion.class);<span class="comment">//æ”¯æŒçš„æºç ç‰ˆæœ¬</span></div><div class="line">        SourceVersion var2 = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span>(var1 == <span class="keyword">null</span>) &#123;</div><div class="line">            var2 = SourceVersion.RELEASE_6;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.isInitialized()) &#123;</div><div class="line">                <span class="keyword">this</span>.processingEnv.getMessager().printMessage(Kind.WARNING, <span class="string">"No SupportedSourceVersion annotation found on "</span> + <span class="keyword">this</span>.getClass().getName() + <span class="string">", returning "</span> + var2 + <span class="string">"."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            var2 = var1.value();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> var2;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment var1)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.initialized) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot call init more than once."</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Objects.requireNonNull(var1, <span class="string">"Tool provided null ProcessingEnvironment"</span>);</div><div class="line">            <span class="keyword">this</span>.processingEnv = var1;</div><div class="line">            <span class="keyword">this</span>.initialized = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; var1, RoundEnvironment var2)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>init(ProcessingEnvironment env)</code>ï¼šæ¯ä¸ªæ³¨è§£å¤„ç†å™¨éƒ½å¿…é¡»æœ‰ä¸ªç©ºçš„æ„é€ æ–¹æ³•ã€‚ä¸è¿‡ï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ init æ–¹æ³•ï¼Œå®ƒä¼šè¢«æ³¨è§£å¤„ç†å™¨å·¥å…·ä¼ å…¥ä¸€ä¸ª ProcessingEnvironment ä½œä¸ºå‚æ•°æ¥è°ƒç”¨ã€‚ProcessingEnvironment æä¾›äº†ä¸€äº›æœ‰ç”¨çš„å·¥å…·ç±»ï¼Œå¦‚ Elementsï¼ŒTypes å’Œ Filterã€‚æˆ‘ä»¬åé¢ä¼šç”¨åˆ°å®ƒä»¬ã€‚</li>
<li><code>process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment env)</code>ï¼šè¿™ä¸ªæ–¹æ³•å¯ä»¥çœ‹åšæ¯ä¸ªå¤„ç†å™¨çš„ main æ–¹æ³•ã€‚ä½ è¦åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æ‰«æï¼Œåˆ¤æ–­å’Œå¤„ç†æ³¨è§£çš„ä»£ç ï¼Œå¹¶ç”Ÿæˆ java æ–‡ä»¶ã€‚é€šè¿‡ä¼ å…¥çš„ RoundEnvironment å‚æ•°ï¼Œä½ å¯ä»¥<strong>æŸ¥è¯¢ä½¿ç”¨äº†æŸä¸ªç‰¹å®šæ³¨è§£çš„æ‰€æœ‰å…ƒç´ </strong>ï¼Œæˆ‘ä»¬ç¨åä¼šçœ‹åˆ°ã€‚</li>
<li><code>getSupportedAnnotationTypes( )</code>ï¼šè¿™é‡Œä½ éœ€è¦è¯´æ˜è¿™ä¸ªå¤„ç†å™¨éœ€è¦é’ˆå¯¹å“ªäº›æ³¨è§£æ¥æ³¨å†Œã€‚æ³¨æ„è¿”å›ç±»å‹æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„ Setï¼ŒåŒ…å«äº†ä½ è¦ç”¨è¿™ä¸ªå¤„ç†å™¨å¤„ç†çš„æ³¨è§£ç±»å‹çš„å…¨å</li>
<li><code>getSupportedSourceVersion( )</code>ï¼šç”¨äºæŒ‡å®šä½ ä½¿ç”¨çš„ java ç‰ˆæœ¬ã€‚é€šå¸¸ä¼šé€‰æ‹©è¿”å›<code>SourceVersion.latestSupported( )</code>ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šå…·ä½“ java ç‰ˆæœ¬ï¼šæ¯”å¦‚<code>return SourceVersion.RELEASE_7</code>;</li>
</ul>
<p>ButterKnife çš„è§£æå·¥ä½œå°±æ˜¯é€šè¿‡ <code>ButterKnife#process</code> æ–¹æ³•å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Filer filer;<span class="comment">//æˆå‘˜å˜é‡</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</div><div class="line">    Map&lt;TypeElement, BindingSet&gt; bindingMap = findAndParseTargets(env);<span class="comment">//æ‰«æå¹¶è§£æç›®æ ‡ç±»ï¼Œè·å– å­˜å‚¨ç»‘å®šä¿¡æ¯çš„ bindingMapã€‚</span></div><div class="line">  	<span class="comment">//éå†è·å–åˆ°çš„æ³¨è§£</span></div><div class="line">    <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</div><div class="line">      TypeElement typeElement = entry.getKey();</div><div class="line">      BindingSet binding = entry.getValue();</div><div class="line"></div><div class="line">      JavaFile javaFile = binding.brewJava(sdk);<span class="comment">//ä½¿ç”¨ javaPoet ç”Ÿæˆ java æ–‡ä»¶</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        javaFile.writeTo(filer);<span class="comment">//è°ƒç”¨ javaPoet çš„æ–¹æ³•ï¼Œå°†å†…å®¹å†™å…¥æ–‡ä»¶</span></div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        error(typeElement, <span class="string">"Unable to write binding for type %s: %s"</span>, typeElement, e.getMessage());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>process æ–¹æ³•é¦–å…ˆè°ƒç”¨ findAndParseTargets æ–¹æ³•è·å–è§£æçš„ç›®æ ‡ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;TypeElement, BindingSet&gt; <span class="title">findAndParseTargets</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</div><div class="line">   Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">   Set&lt;TypeElement&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">   scanForRClasses(env);</div><div class="line"></div><div class="line">   <span class="comment">// å¤„ç† @BindArray å…ƒç´ .</span></div><div class="line">   <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindArray.class)) &#123;</div><div class="line">     <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">       parseResourceArray(element, builderMap, erasedTargetNames);</div><div class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       logParsingError(element, BindArray.class, e);</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="comment">//ä»£ç çœç•¥</span></div><div class="line">  </div><div class="line">   <span class="comment">// éå†å¤„ç†æ¯ä¸€ä¸ªæ‰“äº† @BindView æ³¨è§£çš„å…ƒç´ </span></div><div class="line">   <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindView.class)) &#123;</div><div class="line">     <span class="comment">// è§£æ BindView æ³¨è§£</span></div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">       parseBindView(element, builderMap, erasedTargetNames);</div><div class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       logParsingError(element, BindView.class, e);</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// å¤„ç†æ¯ä¸€ä¸ªå…³è”æœ‰ç›‘å¬å™¨çš„æ³¨è§£</span></div><div class="line">   <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; listener : LISTENERS) &#123;</div><div class="line">     findAndParseListener(env, listener, builderMap, erasedTargetNames);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// Associate superclass binders with their subclass binders. This is a queue-based tree walk</span></div><div class="line">   <span class="comment">// which starts at the roots (superclasses) and walks to the leafs (subclasses).</span></div><div class="line">   Deque&lt;Map.Entry&lt;TypeElement, BindingSet.Builder&gt;&gt; entries =</div><div class="line">       <span class="keyword">new</span> ArrayDeque&lt;&gt;(builderMap.entrySet());</div><div class="line">   Map&lt;TypeElement, BindingSet&gt; bindingMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">   <span class="keyword">while</span> (!entries.isEmpty()) &#123;</div><div class="line">     Map.Entry&lt;TypeElement, BindingSet.Builder&gt; entry = entries.removeFirst();</div><div class="line"></div><div class="line">     TypeElement type = entry.getKey();</div><div class="line">     BindingSet.Builder builder = entry.getValue();</div><div class="line"></div><div class="line">     TypeElement parentType = findParentType(type, erasedTargetNames);</div><div class="line">     <span class="keyword">if</span> (parentType == <span class="keyword">null</span>) &#123;</div><div class="line">       bindingMap.put(type, builder.build());</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">       BindingSet parentBinding = bindingMap.get(parentType);</div><div class="line">       <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">         builder.setParent(parentBinding);</div><div class="line">         bindingMap.put(type, builder.build());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">         <span class="comment">// Has a superclass binding but we haven't built it yet. Re-enqueue for later.</span></div><div class="line">         entries.addLast(entry);</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> bindingMap;<span class="comment">//è¿”å› bindingMapï¼Œç”¨äºåç»­ javapoet ç”Ÿæˆä»£ç </span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ–¹æ³•æ˜¯ä»¥æ³¨è§£ä¸ºå•ä½ï¼Œå¤„ç†å„ä¸ªä½¿ç”¨äº†æ³¨è§£çš„å±æ€§ï¼Œç„¶åå°†å®ƒä»¬å­˜æ”¾åˆ°ä¸€ä¸ª Map ä¸­ã€‚ï¼ˆè¯¥ Map ä»¥å±æ€§æ‰€åœ¨ç±»ä¸º keyï¼Œä»¥å±æ€§é›† BindingSet.Builder  ä¸º valueï¼‰ã€‚é‚£ä¹ˆå…·ä½“æ˜¯å¦‚ä½•è§£æçš„å‘¢ï¼Ÿ</p>
<p>å¯¹äº ButterKnife æˆ‘ä»¬æœ€å¸¸ç”¨çš„æ˜¯ <code>@BindView</code>ï¼Œé’ˆå¯¹ BindView æˆ‘ä»¬ä¸»è¦çœ‹ <code>parseBindView</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†ä½¿ç”¨äº†<code>@BindView</code> çš„å±æ€§çš„ç»‘å®šä¿¡æ¯ï¼Œå­˜æ”¾åˆ°ä»¥è¯¥å±æ€§æ‰€åœ¨ç±»ä¸º key ï¼Œå€¼ä¸º  <code>BindingSet.Builder</code> çš„Map ä¸­ï¼Œä¾›åç»­ javaPoet ç”Ÿæˆä»£ç ä½¿ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBindView</span><span class="params">(Element element, Map&lt;TypeElement, BindingSet.Builder&gt; builderMap,</span></span></div><div class="line">     Set&lt;TypeElement&gt; erasedTargetNames) &#123;</div><div class="line">   TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();<span class="comment">//è·å–è¯¥å…ƒç´ æ‰€åœ¨çš„ç±»å¯¹åº”çš„å…ƒç´ ã€‚</span></div><div class="line"></div><div class="line">   <span class="comment">// æ£€æŸ¥å¸¸è§çš„ä»£ç ç”Ÿæˆé™åˆ¶</span></div><div class="line">   <span class="keyword">boolean</span> hasError = isInaccessibleViaGeneratedCode(BindView.class, <span class="string">"fields"</span>, element)</div><div class="line">       || isBindingInWrongPackage(BindView.class, element);</div><div class="line"></div><div class="line">   <span class="comment">// æ£€æŸ¥ç›®æ ‡ç±»å‹æ˜¯å¦ç»§æ‰¿è‡ª View</span></div><div class="line">   TypeMirror elementType = element.asType();</div><div class="line">   <span class="keyword">if</span> (elementType.getKind() == TypeKind.TYPEVAR) &#123;</div><div class="line">     TypeVariable typeVariable = (TypeVariable) elementType;</div><div class="line">     elementType = typeVariable.getUpperBound();</div><div class="line">   &#125;</div><div class="line">   Name qualifiedName = enclosingElement.getQualifiedName();<span class="comment">//è·å–å…¨ç§°</span></div><div class="line">   Name simpleName = element.getSimpleName();<span class="comment">//è·å–ç®€å•å</span></div><div class="line"><span class="comment">//ä»£ç çœç•¥â€¦â€¦</span></div><div class="line"><span class="comment">//å¦‚æœä¸æ˜¯æ¥å£è€Œä¸”ä¸æ˜¯ View çš„å­ç±»ï¼Œåˆ™æ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œå°† hasError ç½®ä¸ºtrue</span></div><div class="line">   <span class="keyword">if</span> (hasError) &#123;</div><div class="line">     <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// ä¸‹é¢å¼€å§‹æ‹¼æ¥è¦ç»‘å®šçš„å±æ€§çš„ä¿¡æ¯</span></div><div class="line">  </div><div class="line">   <span class="keyword">int</span> id = element.getAnnotation(BindView.class).value();<span class="comment">//è·å– R.id.xx</span></div><div class="line"></div><div class="line">   BindingSet.Builder builder = builderMap.get(enclosingElement);<span class="comment">//è·å–è¯¥å±æ€§æ‰€åœ¨çš„ç±»çš„ builder</span></div><div class="line">   QualifiedId qualifiedId = elementToQualifiedId(element, id);<span class="comment">//ä»ç»‘å®šè®°å½•ä¸­è·å–ï¼Œå¦‚æœç›¸åº”çš„ id å·²ç»è¢«ç»‘å®šè¿‡äº†ï¼Œåˆ™æŠ¥é”™ï¼Œå¹¶æ‰“å°ç›¸åº”çš„é”™è¯¯ä¿¡æ¯</span></div><div class="line">   <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</div><div class="line">     String existingBindingName = builder.findExistingBindingName(getId(qualifiedId));</div><div class="line">     <span class="keyword">if</span> (existingBindingName != <span class="keyword">null</span>) &#123;</div><div class="line">       error(element, <span class="string">"Attempt to use @%s for an already bound ID %d on '%s'. (%s.%s)"</span>,</div><div class="line">           BindView.class.getSimpleName(), id, existingBindingName,</div><div class="line">           enclosingElement.getQualifiedName(), element.getSimpleName());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">     &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">     <span class="comment">//åˆ›å»ºä¸€ä¸ª BindingBuilder</span></div><div class="line">     builder = getOrCreateBindingBuilder(builderMap, enclosingElement);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   String name = simpleName.toString();<span class="comment">//ç®€å•ç±»å</span></div><div class="line">   TypeName type = TypeName.get(elementType);<span class="comment">//è·å–è¯¥å±æ€§æ‰€åœ¨ç±»çš„ç±»å</span></div><div class="line">   <span class="keyword">boolean</span> required = isFieldRequired(element);</div><div class="line"></div><div class="line">   builder.addField(getId(qualifiedId), <span class="keyword">new</span> FieldViewBinding(name, type, required));<span class="comment">//åˆ›å»º Field å¹¶æ·»åŠ åˆ° BindingSet.Builder çš„ field ä¸­</span></div><div class="line"></div><div class="line">   <span class="comment">// Add the type-erased version to the valid binding targets set.</span></div><div class="line">   erasedTargetNames.add(enclosingElement);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>å‡è®¾æˆ‘ä»¬åœ¨æŸä¸€ä¸ªç±»ä¸­é‡å¤ç»‘å®šäº†ç›¸åŒçš„ idï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­å¯¹ R.id.app_bar_layout è¿›è¡Œäº†ä¸¤æ¬¡ç»‘å®šï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@BindView</span>(R.id.app_bar_layout)</div><div class="line">AppBarLayout mAppBarLayout;</div><div class="line"><span class="meta">@BindView</span>(R.id.app_bar_layout)<span class="comment">//ç»‘å®šäº†ç›¸åŒçš„ idï¼Œä¼šæŠ¥é”™</span></div><div class="line">AppBarLayout mAppBarLayout2;</div></pre></td></tr></table></figure>
<p>åœ¨ç¼–è¯‘æœŸä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p>
<p><code>Error:(36, 18) é”™è¯¯: Attempt to use @BindView for an already bound ID 2131230757 on &#39;mAppBarLayout&#39;. (com.android.rdc.librarysystem.MainActivity.mAppBarLayout2)</code></p>
<h4 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>ButterKnife æ˜¯ä»¥è¿™æ ·çš„æ–¹å¼æ¥å¤„ç†æ³¨è§£çš„ï¼šButterKnife æ”¯æŒå¤šç§æ³¨è§£ï¼ˆæ¯”å¦‚ @BindView ã€@BindColorï¼‰ï¼Œè¿™äº›æ³¨è§£è¢«æŒ‰ç…§ä¸€å®šçš„é¡ºåºå¤„ç†ã€‚è·å–ä½¿ç”¨äº†æŸä¸ªæ³¨è§£çš„æ‰€æœ‰ Elementï¼Œå¯¹è¯¥ Element çš„è¿›è¡Œå¤„ç†ï¼Œç”Ÿæˆç›¸åº”çš„ FieldXxxBinding ç„¶åå°†å®ƒæ·»åŠ åˆ°è¯¥ Element æ‰€åœ¨ç±»çš„ <code>BindingSet.Builder</code> ä¸­ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒButterKnife æ˜¯ä»¥æ³¨è§£ä¸ºå•ä½è¿›è¡Œè§£æï¼Œå¤„ç†å®Œäº†ï¼Œå°±æŠŠå®ƒæ”¾åˆ°ç›¸åº”å±æ€§æ‰€åœ¨ç±»å¯¹åº”çš„ Set é‡Œé¢ï¼ˆè€Œä¸æ˜¯ä¸€æ¬¡æ‰«æä¸€ä¸ªç±»ï¼Œç„¶åå¯¹è¯¥ç±»ä¸­å±æ€§ä½¿ç”¨åˆ°çš„æ³¨è§£è¿›è¡Œå¤„ç†ï¼Œä¸€æ¬¡æ€§ç”ŸæˆæŸä¸ªç±»çš„æ‰€å¯¹åº”çš„ <code>BindingSet.Builder</code> ï¼‰ã€‚</p>
<h4 id="é€šè¿‡-JavaPoet-ç”Ÿæˆ-java-æ–‡ä»¶"><a href="#é€šè¿‡-JavaPoet-ç”Ÿæˆ-java-æ–‡ä»¶" class="headerlink" title="é€šè¿‡ JavaPoet ç”Ÿæˆ java æ–‡ä»¶"></a>é€šè¿‡ JavaPoet ç”Ÿæˆ java æ–‡ä»¶</h4><p>æ­£å¦‚å…¶åï¼Œpoet æŒ‡è¯—äººï¼Œä¹Ÿå°±æ˜¯ä½œè¯—çš„äººã€‚java poet æŒ‡çš„æ˜¯èƒ½å¤Ÿè‡ªåŠ¨å†™ java æºä»£ç çš„åº“ã€‚</p>
<p>javapoet é‡Œé¢å¸¸ç”¨çš„å‡ ä¸ªç±»ï¼š</p>
<ul>
<li><code>TypeName</code> Java ç³»ç»Ÿçš„æ‰€æœ‰ç±»å‹ï¼ŒåŠ ä¸Š void ç±»å‹</li>
<li><code>MethodSpec</code> ä»£è¡¨ä¸€ä¸ªæ„é€ å‡½æ•°æˆ–æ–¹æ³•å£°æ˜ã€‚</li>
<li><code>TypeSpec</code> ä»£è¡¨ä¸€ä¸ªç±»ï¼Œæ¥å£ï¼Œæˆ–è€…æšä¸¾å£°æ˜ã€‚</li>
<li><code>FieldSpec</code> ä»£è¡¨ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œä¸€ä¸ªå­—æ®µå£°æ˜ã€‚</li>
<li><code>JavaFile</code>åŒ…å«ä¸€ä¸ªé¡¶çº§ç±»çš„ Java æ–‡ä»¶ã€‚</li>
</ul>
<p>å›åˆ°å‰é¢çš„ process æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ° <code>JavaFile javaFile = binding.brewJava(sdk);</code> <code>javaFile.writeTo(filer);</code></p>
<p>BindingSet#brewJava ã€‚è¯¥æ–¹æ³•é€šè¿‡ Javapoet ç”Ÿæˆä¸€ä¸ª java æ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function">JavaFile <span class="title">brewJava</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> JavaFile.builder(bindingClassName.packageName(), createType(sdk))</div><div class="line">      .addFileComment(<span class="string">"Generated code from Butter Knife. Do not modify!"</span>)<span class="comment">//æ·»åŠ æ–‡ä»¶æ³¨é‡Š</span></div><div class="line">      .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…³äº javapoet çš„ä»‹ç»è¯¦è§<a href="http://www.jianshu.com/p/95f12f72f69a" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a></p>
<h3 id="æ³¨è§£å¤„ç†å™¨çš„æ³¨å†Œ"><a href="#æ³¨è§£å¤„ç†å™¨çš„æ³¨å†Œ" class="headerlink" title="æ³¨è§£å¤„ç†å™¨çš„æ³¨å†Œ"></a>æ³¨è§£å¤„ç†å™¨çš„æ³¨å†Œ</h3><h4 id="æ–¹æ³•-1ï¼šä½¿ç”¨-google-æä¾›çš„æ³¨å†Œå¤„ç†å™¨åº“"><a href="#æ–¹æ³•-1ï¼šä½¿ç”¨-google-æä¾›çš„æ³¨å†Œå¤„ç†å™¨åº“" class="headerlink" title="æ–¹æ³• 1ï¼šä½¿ç”¨ google æä¾›çš„æ³¨å†Œå¤„ç†å™¨åº“"></a>æ–¹æ³• 1ï¼šä½¿ç”¨ google æä¾›çš„æ³¨å†Œå¤„ç†å™¨åº“</h4><p>æœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ google æä¾›çš„ä¸€ä¸ªæ³¨å†Œå¤„ç†å™¨çš„åº“ã€‚ <code>compile &#39;com.google.auto.service:auto-service:1.0-rc2&#39;</code></p>
<p>ç„¶å<code>@AutoService(Processor.class)</code>:å‘ javac æ³¨å†Œæˆ‘ä»¬è¿™ä¸ªè‡ªå®šä¹‰çš„æ³¨è§£å¤„ç†å™¨ï¼Œè¿™æ ·ï¼Œåœ¨ javac ç¼–è¯‘æ—¶ï¼Œæ‰ä¼šè°ƒç”¨åˆ°æˆ‘ä»¬è¿™ä¸ªè‡ªå®šä¹‰çš„æ³¨è§£å¤„ç†å™¨æ–¹æ³•ã€‚</p>
<p>AutoService è¿™é‡Œä¸»è¦æ˜¯ç”¨æ¥ç”Ÿæˆ<br><code>META-INF/services/javax.annotation.processing.Processor</code>æ–‡ä»¶çš„ã€‚</p>
<h4 id="æ–¹æ³•-2ï¼šæ‰‹åŠ¨æ³¨å†Œ"><a href="#æ–¹æ³•-2ï¼šæ‰‹åŠ¨æ³¨å†Œ" class="headerlink" title="æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ³¨å†Œ"></a>æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ³¨å†Œ</h4><p>å¦‚æœä¸ä½¿ç”¨ä¸Šè¿°å¤„ç†åº“ï¼Œé‚£ä¹ˆï¼Œä½ éœ€è¦è‡ªå·±è¿›è¡Œæ‰‹åŠ¨é…ç½®è¿›è¡Œæ³¨å†Œï¼Œå…·ä½“æ‰‹åŠ¨æ³¨å†Œæ–¹æ³•å¦‚ä¸‹ï¼š<br>1.åˆ›å»ºä¸€ä¸ª<br><code>META-INF/services/javax.annotation.processing.Processor</code> æ–‡ä»¶ï¼Œ<br>å…¶å†…å®¹æ˜¯ä¸€ç³»åˆ—çš„è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨å®Œæ•´æœ‰æ•ˆç±»åé›†åˆï¼Œä»¥æ¢è¡Œåˆ‡å‰²ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">com.example.MyProcessor</div><div class="line">com.foo.OtherProcessor</div><div class="line">net.blabla.SpecialProcessor</div></pre></td></tr></table></figure>
<p>2.å°†è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨å’Œ<br>META-INF/services/javax.annotation.processing.Processor æ‰“åŒ…æˆä¸€ä¸ª.jar æ–‡ä»¶ã€‚æ‰€ä»¥å…¶ç›®å½•ç»“æ„å¤§æ¦‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MyProcessor.jar</div><div class="line">  - com</div><div class="line">      - example</div><div class="line">          - MyProcessor.class</div><div class="line"></div><div class="line">  - META-INF</div><div class="line">      - services</div><div class="line">          - javax.annotation.processing.Processor</div></pre></td></tr></table></figure>
<p>ButterKnife ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹å¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ButterKnifeProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">  <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ButterKnife åœ¨<strong>ç¼–è¯‘çš„æ—¶å€™</strong>å¸®æˆ‘ä»¬<strong>è‡ªåŠ¨ç”Ÿæˆ</strong>äº†ç»‘å®šçš„ä»£ç ï¼Œç„¶ååœ¨<strong>è¿è¡Œçš„æ—¶å€™è°ƒç”¨</strong>å°±è¡Œäº†ã€‚</p>
<ul>
<li>é¦–å…ˆæˆ‘ä»¬åœ¨éœ€è¦ç»‘å®š View çš„ åœ°æ–¹ä½¿ç”¨ @BindView æˆ–è€… ButterKnife æä¾›çš„å…¶ä»–æ³¨è§£ï¼Œæ¯”å¦‚ @BindColor </li>
<li>åœ¨ç¼–è¯‘æœŸ  ButterKnifeProcessor çš„ process å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œåœ¨å…¶ä¸­è·å–ä½¿ç”¨äº†ç›¸åº”æ³¨è§£çš„ç›¸å…³æ–¹æ³•/æˆå‘˜å˜é‡ä¿¡æ¯ï¼Œé€šè¿‡ javapoet ç”Ÿæˆ Xx_ViewBinder å’Œ Xx_ViewBinding ç±»ã€‚</li>
<li>è¿è¡Œæ—¶ï¼ŒonCreate æ–¹æ³•ä¸­é€šå¸¸éœ€è¦ <code>ButterKnife.Bind()</code>æ–¹æ³•ï¼Œä»æ­¤å¤„è¿›å…¥ï¼Œé€šè¿‡ åå°„è°ƒç”¨ Xx_ViewBinding çš„æ„é€ æ–¹æ³•å¯¹ View è¿›è¡Œåˆå§‹åŒ–ã€‚</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://a.codekk.com/detail/Android/Trinea/%E5%85%AC%E5%85%B1%E6%8A%80%E6%9C%AF%E7%82%B9%E4%B9%8B%20Java%20%E6%B3%A8%E8%A7%A3%20Annotation" target="_blank" rel="noopener">å…¬å…±æŠ€æœ¯ç‚¹ä¹‹ Java æ³¨è§£ Annotation</a></li>
<li><a href="http://www.jianshu.com/p/0f3f4f7ca505" target="_blank" rel="noopener">ButterKnife æºç åˆ†æ</a></li>
<li><a href="http://dev.qq.com/topic/578753c0c9da73584b025875#rd" target="_blank" rel="noopener">æ·±å…¥ç†è§£ ButterKnifeï¼Œè®©ä½ çš„ç¨‹åºå­¦ä¼šå†™ä»£ç </a></li>
<li><a href="http://www.jianshu.com/p/95f12f72f69a" target="_blank" rel="noopener">javapoetâ€”â€”è®©ä½ ä»é‡å¤æ— èŠçš„ä»£ç ä¸­è§£æ”¾å‡ºæ¥</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®æ¬¢è¿åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè¯·å¯¹é—®é¢˜æè¿°å°½é‡è¯¦ç»†ï¼Œä»¥å¸®åŠ©æˆ‘å¯ä»¥å¿«é€Ÿæ‰¾åˆ°é—®é¢˜æ ¹æºã€‚è°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> æºç åˆ†æ </category>
            
            <category> æ¡†æ¶åŸç† </category>
            
        </categories>
        
        
        <tags>
            
            <tag> æºç åˆ†æ </tag>
            
            <tag> æ¡†æ¶åŸç† </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[String StringBuilderä¸StringBufferçš„åŒºåˆ«]]></title>
      <url>https://timlin-pro.github.io/blog/2017/09/21/String-StringBuilder%E4%B8%8EStringBuffer%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
      <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p><img src="http://ofucm8avi.bkt.clouddn.com/1.png" alt="image"></p>
<p>CharSequence å°±æ˜¯å­—ç¬¦åºåˆ—ï¼ŒString, StringBuilder å’Œ StringBuffer æœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡å­—ç¬¦æ•°ç»„å®ç°çš„ã€‚</p>
<ol>
<li>String å­—ç¬¦ä¸²<strong>å¸¸é‡</strong>ï¼ˆä¸å¯å˜ï¼‰</li>
<li>StringBuffer å­—ç¬¦ä¸²å˜é‡ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰</li>
<li>StringBuilder å­—ç¬¦ä¸²å˜é‡ï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰</li>
</ol>
<a id="more"></a>
<h2 id="String-ç±»å‹å’Œ-StringBuilder-ç±»å‹çš„ä¸»è¦æ€§èƒ½åŒºåˆ«"><a href="#String-ç±»å‹å’Œ-StringBuilder-ç±»å‹çš„ä¸»è¦æ€§èƒ½åŒºåˆ«" class="headerlink" title="String ç±»å‹å’Œ StringBuilder ç±»å‹çš„ä¸»è¦æ€§èƒ½åŒºåˆ«"></a>String ç±»å‹å’Œ StringBuilder ç±»å‹çš„ä¸»è¦æ€§èƒ½åŒºåˆ«</h2><ol>
<li>String æ˜¯<strong>ä¸å¯å˜çš„å¯¹è±¡</strong>,å› æ­¤åœ¨æ¯æ¬¡å¯¹ String ç±»å‹è¿›è¡Œæ”¹å˜çš„æ—¶å€™å…¶å®éƒ½ç­‰åŒäºç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„ String å¯¹è±¡ï¼Œç„¶åå°†æŒ‡é’ˆæŒ‡å‘æ–°çš„ String å¯¹è±¡ï¼Œæ‰€ä»¥<strong>ç»å¸¸æ”¹å˜å†…å®¹çš„å­—ç¬¦ä¸²æœ€å¥½ä¸è¦ç”¨ String</strong> ï¼Œå› ä¸ºæ¯æ¬¡ç”Ÿæˆå¯¹è±¡éƒ½ä¼šå¯¹ç³»ç»Ÿæ€§èƒ½äº§ç”Ÿå½±å“ï¼Œç‰¹åˆ«å½“å†…å­˜ä¸­æ— å¼•ç”¨å¯¹è±¡å¤šäº†ä»¥åï¼Œ JVM çš„ GC å°±ä¼šå¼€å§‹å·¥ä½œï¼Œä¼šè¿›ä¸€æ­¥æ¶ˆè€—æ€§èƒ½ã€‚</li>
<li>StringBuilder æ˜¯å¯å˜çš„ï¼Œ å¯ä»¥å¯¹ StringBuilder <strong>å¯¹è±¡æœ¬èº«è¿›è¡Œæ“ä½œ</strong>ï¼Œè€Œä¸æ˜¯ç”Ÿæˆæ–°çš„å¯¹è±¡ï¼Œå†æ”¹å˜å¯¹è±¡å¼•ç”¨ã€‚æ‰€ä»¥åœ¨ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æ¨èä½¿ç”¨ StringBuilder ï¼Œç‰¹åˆ«æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ç»å¸¸æ”¹å˜çš„æƒ…å†µä¸‹ã€‚</li>
<li>é€šå¸¸ String å¯¹è±¡çš„å­—ç¬¦ä¸²æ‹¼æ¥å…¶å®æ˜¯è¢« JVM è§£é‡Šæˆäº† StringBuilder å¯¹è±¡çš„æ‹¼æ¥ï¼Œæ‰€ä»¥è¿™äº›æ—¶å€™ String å¯¹è±¡çš„é€Ÿåº¦å¹¶ä¸ä¼šæ¯” StringBuilder å¯¹è±¡æ…¢ã€‚</li>
</ol>
<p>ç‰¹åˆ«æ˜¯ä»¥ä¸‹çš„å­—ç¬¦ä¸²å¯¹è±¡ç”Ÿæˆä¸­ï¼ŒString æ•ˆç‡æ˜¯è¿œè¦æ¯” StringBuffer é«˜çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String S1 = â€œThis is only aâ€ + â€œ simpleâ€ + â€œ testâ€;<span class="comment">//ç›´æ¥æ‹¼æ¥ç°æœ‰å­—ç¬¦ä¸²</span></div><div class="line">StringBuffer Sb = <span class="keyword">new</span> StringBuilder(â€œThis is only aâ€).append(â€œ simpleâ€).append(â€œ testâ€);</div></pre></td></tr></table></figure>
<p>è¿™å…¶å®æ¶‰åŠåˆ°äº†ç¼–è¯‘å™¨çš„ä¼˜åŒ–ã€‚åœ¨ç¼–è¯‘æœŸï¼Œç¼–è¯‘å™¨ä¼šæŠŠ<strong>å­—ç¬¦ä¸²å¸¸é‡</strong>ç›¸åŠ çš„æƒ…å†µç›´æ¥å˜ä¸ºæ‹¼æ¥ä¸ºç›®æ ‡å­—ç¬¦ä¸²ã€‚ä¹Ÿå°±æ˜¯è¯´ç¼–è¯‘ä¹‹åå°±è·å¾—äº†ç›®æ ‡å­—ç¬¦ä¸²ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">String S1 = â€œThis is only aâ€ + â€œ simpleâ€ + â€œtestâ€; </div><div class="line"> <span class="comment">//å…¶å®å°±æ˜¯ï¼š</span></div><div class="line">String S1 = â€œThis is only a simple testâ€;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥å½“ç„¶ä¸éœ€è¦å¤ªå¤šçš„æ—¶é—´äº†ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ çš„å­—ç¬¦ä¸²æ˜¯æ¥è‡ª<strong>å¦å¤–çš„ String å¯¹è±¡</strong>çš„è¯ï¼ˆæ¯”å¦‚ä¸‹é¢æ‰€åˆ—ä¸¾çš„è¿™ä¸ªä¾‹å­ï¼‰ï¼Œç›´æ¥å°† String ç›¸åŠ ï¼Œæ€§èƒ½ä¸Šä¸ä¼šæœ‰ä»€ä¹ˆæå‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">String S2 = â€œThis is only aâ€;</div><div class="line">String S3 = â€œ simpleâ€;</div><div class="line">String S4 = â€œ testâ€;</div><div class="line">String S1 = S2 + S3 + S4;</div></pre></td></tr></table></figure>
<p>è¿™æ—¶å€™ JVM ä¼šè§„è§„çŸ©çŸ©çš„æŒ‰ç…§åŸæ¥çš„æ–¹å¼å»åšâ€”â€”å…ˆåˆ›å»ºä¸€ä¸ª StringBuilder å¯¹è±¡ï¼Œç„¶åå†è¿›è¡Œè°ƒç”¨å®ƒçš„ append æ–¹æ³•å¯¹ å­—ç¬¦ä¸²è¿›è¡Œæ‹¼æ¥ã€‚</p>
<h2 id="StringBuffer"><a href="#StringBuffer" class="headerlink" title="StringBuffer"></a>StringBuffer</h2><p>StringBuffer æ˜¯çº¿ç¨‹å®‰å…¨çš„å¯å˜å­—ç¬¦åºåˆ—ã€‚ä¸€ä¸ªç±»ä¼¼äº String çš„å­—ç¬¦ä¸²ç¼“å†²åŒºï¼Œä½†ä¸èƒ½ä¿®æ”¹ã€‚è™½ç„¶åœ¨ä»»æ„æ—¶é—´ç‚¹ä¸Šå®ƒéƒ½åŒ…å«æŸç§ç‰¹å®šçš„å­—ç¬¦åºåˆ—ï¼Œä½†é€šè¿‡æŸäº›æ–¹æ³•è°ƒç”¨å¯ä»¥æ”¹å˜è¯¥åºåˆ—çš„é•¿åº¦å’Œå†…å®¹ã€‚</p>
<p>å¯å°†å­—ç¬¦ä¸²ç¼“å†²åŒºå®‰å…¨åœ°ç”¨äºå¤šä¸ªçº¿ç¨‹ã€‚å¯ä»¥åœ¨å¿…è¦æ—¶å¯¹è¿™äº›æ–¹æ³•è¿›è¡ŒåŒæ­¥ï¼Œå› æ­¤ä»»æ„ç‰¹å®šå®ä¾‹ä¸Šçš„æ‰€æœ‰æ“ä½œå°±å¥½åƒæ˜¯ä»¥ä¸²è¡Œé¡ºåºå‘ç”Ÿçš„ï¼Œè¯¥é¡ºåºä¸æ‰€æ¶‰åŠçš„æ¯ä¸ªçº¿ç¨‹è¿›è¡Œçš„æ–¹æ³•è°ƒç”¨é¡ºåºä¸€è‡´ã€‚</p>
<h3 id="ä¸»è¦æ“ä½œ"><a href="#ä¸»è¦æ“ä½œ" class="headerlink" title="ä¸»è¦æ“ä½œ:"></a>ä¸»è¦æ“ä½œ:</h3><p>append å’Œ insert æ–¹æ³•ï¼Œå¯é‡è½½è¿™äº›æ–¹æ³•ï¼Œä»¥æ¥å—ä»»æ„ç±»å‹çš„æ•°æ®ã€‚</p>
<p>append æ–¹æ³•å§‹ç»ˆå°†è¿™äº›å­—ç¬¦<strong>æ·»åŠ åˆ°ç¼“å†²åŒºçš„æœ«ç«¯</strong>ã€‚</p>
<p>insert æ–¹æ³•åˆ™åœ¨æŒ‡å®šçš„ç‚¹æ·»åŠ å­—ç¬¦ã€‚</p>
<p>ä¾‹å¦‚:<br>z å¼•ç”¨ä¸€ä¸ªå½“å‰å†…å®¹æ˜¯â€œstartâ€çš„å­—ç¬¦ä¸²ç¼“å†²åŒºå¯¹è±¡ï¼Œ<br>ç”¨ z.append(â€œleâ€) ä¼šä½¿å­—ç¬¦ä¸²ç¼“å†²åŒºåŒ…å«â€œstartleâ€ï¼Œ<br>è€Œ z.insert(4, â€œleâ€) å°†<strong>æ›´æ”¹å­—ç¬¦ä¸²ç¼“å†²åŒº</strong>ï¼Œä½¿ä¹‹åŒ…å«â€œstarletâ€ã€‚</p>
<h2 id="StringBuilder"><a href="#StringBuilder" class="headerlink" title="StringBuilder"></a>StringBuilder</h2><p>StringBuilder æ˜¯ Java5 æ–°å¢çš„ä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„å¯å˜çš„å­—ç¬¦åºåˆ—ã€‚å¯ä»¥æŠŠå®ƒç†è§£ä¸º StringBuffer çš„éçº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ï¼Œå› ä¸ºå®é™…åº”ç”¨ä¸­å¾ˆå°‘æœ‰éœ€è¦å¯¹å­—ç¬¦ä¸²è¿›è¡ŒåŒæ­¥çš„æƒ…å†µï¼Œæ‰€ä»¥é‡‡ç”¨ StringBuilder çš„æ€§èƒ½æ›´åŠ ã€‚åœ¨ä¸éœ€è¦åŒæ­¥ï¼Œä¼˜å…ˆé‡‡ç”¨ StringBuilderã€‚</p>
<p>åˆå§‹é•¿åº¦åˆ†ä¸ºä¸‰ç§æƒ…å†µ:</p>
<p> å¦‚æœæ˜¯è°ƒç”¨çš„æ˜¯æ— å‚æ„é€ å‡½æ•°ï¼Œåˆ™é»˜è®¤å®¹é‡ä¸º 16</p>
<p>å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªå¤§äº 0 çš„ capacityï¼Œåˆ™åˆå§‹å®¹é‡ä¸º æŒ‡å®šçš„ capacity</p>
<p>å¦‚æœä½¿ç”¨äº†å‚æ•°ç±»å‹ä¸º  CharSequence/String çš„æ„é€ å‡½æ•°ï¼Œåˆ™åˆå§‹å®¹é‡ä¸º<code>CharSequenceçš„é•¿åº¦ + 16</code>ã€‚</p>
<h3 id="æ‰©å®¹"><a href="#æ‰©å®¹" class="headerlink" title="æ‰©å®¹"></a>æ‰©å®¹</h3><p>æ¯æ¬¡ append çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨ ensureCapacityInternal ï¼Œå½“å‰é•¿åº¦ + append å†…å®¹æ€»é•¿åº¦ä½œä¸º minimumCapacityï¼Œå¦‚æœ  minimumCapacity è¶…è¿‡äº† value æ•°ç»„çš„é•¿åº¦ï¼Œå°±å°†value æ•°ç»„å¤åˆ¶åˆ°é•¿åº¦ä¸º newCapacity çš„æ–°æ•°ç»„ï¼Œ</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ newCapacity å¤§äº  minimumCapacity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * For positive values of &#123;<span class="doctag">@code</span> minimumCapacity&#125;, this method</div><div class="line"> * behaves like &#123;<span class="doctag">@code</span> ensureCapacity&#125;, however it is never</div><div class="line"> * synchronized.</div><div class="line"> * If &#123;<span class="doctag">@code</span> minimumCapacity&#125; is non positive due to numeric</div><div class="line"> * overflow, this method throws &#123;<span class="doctag">@code</span> OutOfMemoryError&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minimumCapacity)</span> </span>&#123;</div><div class="line">    <span class="comment">// overflow-conscious code</span></div><div class="line">    <span class="keyword">if</span> (minimumCapacity - value.length &gt; <span class="number">0</span>) &#123;</div><div class="line">        value = Arrays.copyOf(value,</div><div class="line">                newCapacity(minimumCapacity));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The maximum size of array to allocate (unless necessary).</div><div class="line"> * Some VMs reserve some header words in an array.</div><div class="line"> * Attempts to allocate larger arrays may result in</div><div class="line"> * OutOfMemoryError: Requested array size exceeds VM limit</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ARRAY_SIZE = Integer.MAX_VALUE - <span class="number">8</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns a capacity at least as large as the given minimum capacity.</div><div class="line"> * Returns the current capacity increased by the same amount + 2 if</div><div class="line"> * that suffices.</div><div class="line"> * Will not return a capacity greater than &#123;<span class="doctag">@code</span> MAX_ARRAY_SIZE&#125;</div><div class="line"> * unless the given minimum capacity is greater than that.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span>  minCapacity the desired minimum capacity</div><div class="line"> * <span class="doctag">@throws</span> OutOfMemoryError if minCapacity is less than zero or</div><div class="line"> *         greater than Integer.MAX_VALUE</div><div class="line"> * è¿”å›ä¸€ä¸ªè‡³å°‘è·Ÿ minCapacity ä¸€æ ·å¤§çš„å€¼ã€‚å¦‚æœç©ºé—´è¶³å¤Ÿçš„è¯ï¼Œå½“å‰çš„å®¹é‡ä¼šå¢é•¿ä¸€å€ +2 ã€‚</div><div class="line"> * é™¤éç»™å®šçš„å€¼è¶…è¿‡MAX_ARRAY_SIZEã€‚å¦åˆ™è¿”å›çš„å®¹é‡ä¸ä¼šè¶…è¿‡ MAX_ARRAY_SIZEã€‚</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">newCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">    <span class="comment">// overflow-conscious codeã€‚é˜²æ­¢æº¢å‡º</span></div><div class="line">    <span class="keyword">int</span> newCapacity = (value.length &lt;&lt; <span class="number">1</span>) + <span class="number">2</span>;<span class="comment">//å½“å‰æ•°ç»„é•¿åº¦ * 2 + 2</span></div><div class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>) &#123;<span class="comment">//å¦‚æœæ–°é•¿åº¦ &lt; minCapacityï¼Œå°†æ–°é•¿åº¦èµ‹å€¼ä¸º minCapacity</span></div><div class="line">        newCapacity = minCapacity;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (newCapacity &lt;= <span class="number">0</span> || MAX_ARRAY_SIZE - newCapacity &lt; <span class="number">0</span>)</div><div class="line">       ? hugeCapacity(minCapacity)<span class="comment">//æ£€æŸ¥æº¢å‡ºã€‚å¦‚æœæº¢å‡ºäº†ï¼ŒæŠ›å‡ºé”™è¯¯ã€‚å¦åˆ™ç½®ä¸º MAX_ARRAY_SIZE</span></div><div class="line">        : newCapacity;<span class="comment">//é•¿åº¦åœ¨æ­£å¸¸èŒƒå›´å†…ï¼Œç›´æ¥ä½¿ç”¨è¯¥é•¿åº¦</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Integer.MAX_VALUE - minCapacity &lt; <span class="number">0</span>) &#123; <span class="comment">// overflow</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE)</div><div class="line">        ? minCapacity : MAX_ARRAY_SIZE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://docs.oracle.com/javase/7/docs/api/java/lang/StringBuilder.html" target="_blank" rel="noopener">Class StringBuilder</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> java åŸºç¡€ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> java åŸºç¡€ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶]]></title>
      <url>https://timlin-pro.github.io/blog/2017/09/19/JVM%20%E4%B9%8B%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/</url>
      <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p><strong>è™šæ‹Ÿæœºçš„ç±»åŠ è½½æœºåˆ¶</strong>ï¼šè™šæ‹ŸæœºæŠŠæè¿°ç±»çš„æ•°æ®ä» Class æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒã€è½¬æ¢è§£æå’Œåˆå§‹åŒ–ï¼Œæœ€ç»ˆå½¢æˆå¯ä»¥è¢«è™šæ‹Ÿæœºç›´æ¥ä½¿ç”¨çš„ Java ç±»å‹ã€‚</p>
<p>ä¸é‚£äº›<strong>åœ¨ç¼–è¯‘æ—¶éœ€è¦è¿›è¡Œè¿æ¥å·¥ä½œçš„è¯­è¨€</strong>ä¸åŒï¼Œåœ¨ Java è¯­è¨€é‡Œé¢ï¼Œç±»å‹çš„åŠ è½½ã€è¿æ¥å’Œåˆå§‹åŒ–è¿‡ç¨‹éƒ½æ˜¯<strong>åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å®Œæˆ</strong>çš„ï¼Œ</p>
<ul>
<li>ç¼ºç‚¹ï¼šè¿™ç§ç­–ç•¥ä¼šä»¤ç±»åŠ è½½æ—¶ç¨å¾®<strong>å¢åŠ ä¸€äº›æ€§èƒ½å¼€é”€</strong></li>
<li>ä¼˜ç‚¹ï¼šä¸º Java åº”ç”¨ç¨‹åº<strong>æä¾›é«˜åº¦çš„çµæ´»æ€§</strong>ï¼ŒJava é‡Œå¤©ç”Ÿå¯ä»¥åŠ¨æ€æ‰©å±•çš„è¯­è¨€ç‰¹æ€§å°±æ˜¯ä¾èµ–<strong>è¿è¡ŒæœŸåŠ¨æ€åŠ è½½</strong>å’Œ<strong>åŠ¨æ€è¿æ¥</strong>è¿™ä¸ªç‰¹ç‚¹å®ç°çš„ã€‚<ul>
<li>ä¾‹å¦‚ï¼Œå¦‚æœç¼–å†™ä¸€ä¸ªé¢å‘æ¥å£çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ç­‰åˆ°è¿è¡Œæ—¶å†æŒ‡å®šå…¶å®é™…çš„å®ç°ç±»ï¼›</li>
</ul>
</li>
</ul>
<p>çº¦å®šï¼š</p>
<ul>
<li>ç¬¬ä¸€ï¼Œåœ¨å®é™…æƒ…å†µä¸­ï¼Œåæ–‡ä¸­ç›´æ¥<strong>å¯¹ã€Œç±»ã€çš„æè¿°éƒ½åŒ…æ‹¬äº†ç±»å’Œæ¥å£çš„å¯èƒ½æ€§</strong>ï¼Œè€Œå¯¹äºç±»å’Œæ¥å£éœ€è¦åˆ†å¼€æè¿°çš„åœºæ™¯ä¼šç‰¹åˆ«æŒ‡æ˜ï¼›</li>
<li>ç¬¬äºŒï¼Œã€ŒClass æ–‡ä»¶ã€å¹¶éç‰¹æŒ‡æŸä¸ªå­˜åœ¨äºå…·ä½“ç£ç›˜ä¸­çš„æ–‡ä»¶ï¼Œè¿™é‡Œ<strong>æ‰€è¯´çš„ã€ŒClass æ–‡ä»¶ã€åº”å½“æ˜¯ä¸€ä¸²äºŒè¿›åˆ¶çš„å­—èŠ‚æµï¼Œæ— è®ºä»¥ä½•ç§å½¢å¼å­˜åœ¨éƒ½å¯ä»¥</strong>ã€‚</li>
</ul>
<a id="more"></a>
<h2 id="ç±»åŠ è½½çš„æ—¶æœº"><a href="#ç±»åŠ è½½çš„æ—¶æœº" class="headerlink" title="ç±»åŠ è½½çš„æ—¶æœº"></a>ç±»åŠ è½½çš„æ—¶æœº</h2><p>ä¸ƒä¸ªé˜¶æ®µï¼šå¦‚ä¸‹æ‰€ç¤º<br><img src="https://user-images.githubusercontent.com/16668676/28912625-9333eabc-7867-11e7-9b7f-6a2d4aa3f7a8.png" alt="default"></p>
<p>ä¸Šå›¾ä¸­ï¼Œ<strong>åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€åˆå§‹åŒ–å’Œå¸è½½</strong>è¿™ 5 ä¸ªé˜¶æ®µçš„é¡ºåºæ˜¯ç¡®å®šçš„ï¼Œç±»çš„åŠ è½½è¿‡ç¨‹å¿…é¡»æŒ‰ç…§è¿™ç§é¡ºåºæŒ‰éƒ¨å°±ç­åœ°<strong>å¼€å§‹</strong>ï¼Œè€Œ==è§£æé˜¶æ®µåˆ™ä¸ä¸€å®š==ï¼šå®ƒåœ¨æŸäº›æƒ…å†µä¸‹<strong>å¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µä¹‹åå†å¼€å§‹</strong>ï¼Œè¿™æ˜¯ä¸ºäº†æ”¯æŒ Java è¯­è¨€çš„è¿è¡Œæ—¶ç»‘å®šï¼ˆä¹Ÿç§°ä¸º<strong>åŠ¨æ€ç»‘å®šæˆ–æ™šæœŸç»‘å®š</strong>ï¼‰ã€‚æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ˜¯æŒ‰éƒ¨å°±ç­åœ°ã€Œå¼€å§‹ã€ï¼Œè¿™äº›é˜¶æ®µé€šå¸¸éƒ½æ˜¯<strong>äº’ç›¸äº¤å‰åœ°æ··åˆå¼è¿›è¡Œçš„</strong>ï¼Œé€šå¸¸ä¼š<strong>åœ¨ä¸€ä¸ªé˜¶æ®µæ‰§è¡Œçš„è¿‡ç¨‹ä¸­è°ƒç”¨</strong>ã€æ¿€æ´»å¦å¤–ä¸€ä¸ªé˜¶æ®µã€‚ä¹Ÿå°±æ˜¯è¯´å¯èƒ½æœ‰äº›é˜¶æ®µæœªå®Œæˆï¼Œä¸‹ä¸€ä¸ªé˜¶æ®µå°±å¼€å§‹äº†ã€‚</p>
<p>ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ä¼šå¼€å§‹åŠ è½½ä¸€ä¸ªç±»ï¼ŸJava è™šæ‹Ÿæœºè§„èŒƒä¸­å¹¶æ²¡æœ‰è¿›è¡Œå¼ºåˆ¶çº¦æŸã€‚<br>ä½†æ˜¯å¯¹äºåˆå§‹åŒ–é˜¶æ®µï¼Œè™šæ‹Ÿæœºè§„èŒƒä¸¥æ ¼è§„å®šäº†<strong>æœ‰ä¸”åªæœ‰ 5 ç§æƒ…å†µå¿…é¡»ç«‹å³å¯¹ç±»è¿›è¡Œã€Œ<em>åˆå§‹åŒ–</em></strong>ã€ï¼ˆè€ŒåŠ è½½ã€éªŒè¯ã€å‡†å¤‡è‡ªç„¶éœ€è¦åœ¨æ­¤ä¹‹å‰å¼€å§‹ï¼‰ï¼š</p>
<ol>
<li>é‡åˆ° <strong>newã€getstaticã€putstatic æˆ– invokestatic</strong> è¿™ 4 æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚</li>
</ol>
<ul>
<li>ç”Ÿæˆè¿™ 4 æ¡æŒ‡ä»¤çš„æœ€å¸¸è§çš„ Java ä»£ç åœºæ™¯æ˜¯ï¼š<ul>
<li>ä½¿ç”¨ new å…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ã€</li>
<li><strong>è¯»å–æˆ–è®¾ç½®ä¸€ä¸ªç±»çš„é™æ€å­—æ®µ</strong>ï¼ˆè¢« final ä¿®é¥°ã€å·²åœ¨ç¼–è¯‘æœŸæŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–ï¼‰çš„æ—¶å€™ï¼Œ</li>
<li>ä»¥åŠ<strong>è°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•</strong>çš„æ—¶å€™ã€‚</li>
</ul>
</li>
</ul>
<ol>
<li>ä½¿ç”¨ <code>java.lang.reflect</code> åŒ…çš„æ–¹æ³•å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚</li>
<li>å½“åˆå§‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ–ã€‚</li>
<li>å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ª<strong>è¦æ‰§è¡Œçš„ä¸»ç±»</strong>ï¼ˆåŒ…å« main()æ–¹æ³•çš„é‚£ä¸ªç±»ï¼‰ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªä¸»ç±»ã€‚</li>
<li>å½“ä½¿ç”¨ JDK  1.7 çš„åŠ¨æ€è¯­è¨€æ”¯æŒæ—¶ï¼Œå¦‚æœä¸€ä¸ª <code>java.lang.invoke.MethodHandle</code> å®ä¾‹æœ€åçš„è§£æç»“æœ <code>REF_getStatic</code>ã€<code>REF_putStatic</code>ã€<code>REF_invokeStatic</code> çš„æ–¹æ³•å¥æŸ„ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•å¥æŸ„<br>æ‰€å¯¹åº”çš„ç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚</li>
</ol>
<ul>
<li><strong>ä¸»åŠ¨å¼•ç”¨</strong>ï¼šä»¥ä¸Š 5 ç§åœºæ™¯ä¸­çš„è¡Œä¸ºç§°ä¸ºå¯¹ä¸€ä¸ªç±»è¿›è¡Œä¸»åŠ¨å¼•ç”¨ã€‚</li>
<li><strong>è¢«åŠ¨å¼•ç”¨</strong>ï¼šé™¤äº†ä»¥ä¸Š 5 ç§åœºæ™¯ä¸­çš„è¡Œä¸ºä»¥å¤–çš„å¯¹ä¸€ä¸ªè¿›è¡Œå¼•ç”¨çš„è¡Œä¸ºã€‚</li>
</ul>
<ol>
<li>å¯¹äºé™æ€å­—æ®µï¼Œåªæœ‰ç›´æ¥å®šä¹‰è¿™ä¸ªå­—æ®µçš„ç±»æ‰ä¼šè¢«åˆå§‹åŒ–ï¼Œæ‰€ä»¥<strong>é€šè¿‡ä¸€ä¸ªç±»çš„å­ç±»æ¥å¼•ç”¨çˆ¶ç±»ä¸­å®šä¹‰çš„é™æ€å˜é‡ï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–ï¼Œè€Œä¸ä¼šè§¦å‘å­ç±»çš„åˆå§‹åŒ–</strong>ã€‚</li>
<li>é€šè¿‡æ•°ç»„å®šä¹‰æ¥å¼•ç”¨ç±»ï¼Œä¸ä¼šè§¦å‘æ­¤ç±»çš„åˆå§‹åŒ–ã€‚</li>
<li>å¸¸é‡å®šä¹‰åœ¨ç¼–è¯‘é˜¶æ®µä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°å®šä¹‰å¸¸é‡çš„ç±»ï¼Œå› æ­¤ä¸ä¼šè§¦å‘å®šä¹‰å¸¸é‡çš„ç±»çš„åˆå§‹åŒ–ã€‚<ul>
<li>åœ¨ç¼–è¯‘é˜¶æ®µé€šè¿‡å¸¸é‡ä¼ æ’­ä¼˜åŒ–å®ç°</li>
</ul>
</li>
</ol>
<p>æ¥å£çš„åŠ è½½è¿‡ç¨‹ä¸ç±»åŠ è½½è¿‡ç¨‹ç¨æœ‰ä¸€äº›ä¸åŒï¼Œ<strong>æ¥å£ä¹Ÿæœ‰åˆå§‹åŒ–è¿‡ç¨‹</strong>ï¼Œè¿™ç‚¹ä¸ç±»æ˜¯ä¸€è‡´çš„ï¼Œè™½ç„¶æ¥å£ä¸­ä¸èƒ½ä½¿ç”¨ <code>static{}</code>è¯­å¥å—ï¼Œä½†ç¼–è¯‘å™¨ä»ç„¶ä¼šä¸ºæ¥å£ç”Ÿæˆ <code>&lt;clinit&gt;()</code>ç±»æ„é€ å™¨ï¼Œ<strong>ç”¨äºåˆå§‹åŒ–æ¥å£ä¸­æ‰€å®šä¹‰çš„æˆå‘˜å˜é‡</strong>ã€‚</p>
<ul>
<li>æ¥å£ä¸ç±»çœŸæ­£æœ‰æ‰€åŒºåˆ«çš„æ˜¯å‰é¢è®²è¿°çš„ 5 ç§ã€Œæœ‰ä¸”ä»…æœ‰ã€éœ€è¦å¼€å§‹åˆå§‹åŒ–åœºæ™¯ä¸­çš„ç¬¬ 3 ç§ï¼š<ul>
<li>å½“ä¸€ä¸ªç±»åœ¨åˆå§‹åŒ–æ—¶ï¼Œè¦æ±‚å…¶çˆ¶ç±»å…¨éƒ¨éƒ½å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œä½†æ˜¯<strong>ä¸€ä¸ªæ¥å£åœ¨åˆå§‹åŒ–æ—¶</strong>ï¼Œå¹¶ä¸è¦æ±‚å…¶çˆ¶æ¥å£å…¨éƒ¨éƒ½å®Œæˆäº†åˆå§‹åŒ–ï¼Œ<strong>åªæœ‰åœ¨çœŸæ­£ä½¿ç”¨åˆ°çˆ¶æ¥å£çš„æ—¶å€™ï¼ˆå¦‚å¼•ç”¨æ¥å£ä¸­å®šä¹‰çš„å¸¸é‡ï¼‰æ‰ä¼šåˆå§‹åŒ–</strong>ã€‚</li>
</ul>
</li>
</ul>
<h2 id="ç±»åŠ è½½çš„è¿‡ç¨‹"><a href="#ç±»åŠ è½½çš„è¿‡ç¨‹" class="headerlink" title="ç±»åŠ è½½çš„è¿‡ç¨‹"></a>ç±»åŠ è½½çš„è¿‡ç¨‹</h2><h3 id="åŠ è½½"><a href="#åŠ è½½" class="headerlink" title="åŠ è½½"></a>åŠ è½½</h3><p>ã€ŒåŠ è½½ã€æ˜¯ã€Œç±»åŠ è½½ã€ï¼ˆClass Loadingï¼‰è¿‡ç¨‹çš„ä¸€ä¸ªé˜¶æ®µã€‚åœ¨åŠ è½½é˜¶æ®µï¼Œè™šæ‹Ÿæœºéœ€è¦å®Œæˆä»¥ä¸‹ 3 ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>é€šè¿‡ä¸€ä¸ªç±»çš„<strong>å…¨é™å®šå</strong>æ¥è·å–<strong>å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ</strong>ã€‚</li>
<li>å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸º<strong>æ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„</strong>ã€‚</li>
<li>åœ¨å†…å­˜ä¸­<strong>ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„ java.lang.Class å¯¹è±¡</strong>ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚</li>
</ol>
<p>è™šæ‹Ÿæœºè§„èŒƒçš„è¿™ 3 ç‚¹è¦æ±‚å…¶å®å¹¶ä¸ç®—å…·ä½“ï¼Œå› æ­¤è™šæ‹Ÿæœºå®ç°ä¸å…·ä½“åº”ç”¨çš„çµæ´»åº¦éƒ½æ˜¯ç›¸å½“å¤§çš„ã€‚</p>
<p>ä¸€ä¸ª<strong>éæ•°ç»„ç±»</strong>çš„åŠ è½½é˜¶æ®µï¼ˆå‡†ç¡®åœ°è¯´ï¼Œæ˜¯åŠ è½½é˜¶æ®µä¸­è·å–ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµçš„åŠ¨ä½œï¼‰æ˜¯å¼€å‘äººå‘˜å¯æ§æ€§æœ€å¼ºçš„ï¼Œå› ä¸ºåŠ è½½é˜¶æ®µæ—¢å¯ä»¥ä½¿ç”¨<strong>ç³»ç»Ÿæä¾›çš„å¼•å¯¼ç±»åŠ è½½å™¨</strong>æ¥å®Œæˆï¼Œä¹Ÿå¯ä»¥ç”±<strong>ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨</strong>å»å®Œæˆï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡<strong>å®šä¹‰è‡ªå·±çš„ç±»åŠ è½½å™¨</strong>å»æ§åˆ¶å­—èŠ‚æµçš„è·å–æ–¹å¼ï¼ˆå³é‡å†™ä¸€ä¸ªç±»åŠ è½½å™¨çš„ loadClass()æ–¹æ³•ï¼‰ã€‚</p>
<p>å¯¹äº<strong>æ•°ç»„ç±»</strong>è€Œè¨€ï¼Œæƒ…å†µå°±æœ‰æ‰€ä¸åŒï¼Œ<strong>æ•°ç»„ç±»æœ¬èº«ä¸é€šè¿‡ç±»åŠ è½½å™¨åˆ›å»ºï¼Œå®ƒæ˜¯==ç”± Java è™šæ‹Ÿæœºç›´æ¥åˆ›å»º==çš„</strong>ã€‚</p>
<ul>
<li>ä¸€ä¸ªæ•°ç»„ç±»ï¼ˆä¸‹é¢ç®€ç§°ä¸º Cï¼‰åˆ›å»ºè¿‡ç¨‹å°±éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š<ul>
<li>å¦‚æœæ•°ç»„çš„ç»„ä»¶ç±»å‹ï¼ˆComponent  Typeï¼ŒæŒ‡çš„æ˜¯æ•°ç»„å»æ‰ä¸€ä¸ªç»´åº¦çš„ç±»å‹ï¼‰æ˜¯<strong>å¼•ç”¨ç±»å‹</strong>ï¼Œé‚£å°±é€’å½’é‡‡ç”¨æœ¬èŠ‚ä¸­å®šä¹‰çš„åŠ è½½è¿‡ç¨‹å»åŠ è½½è¿™ä¸ªç»„ä»¶ç±»å‹ï¼Œæ•°ç»„ C å°†<strong>åœ¨åŠ è½½è¯¥ç»„ä»¶ç±»å‹çš„ç±»åŠ è½½å™¨çš„ç±»åç§°ç©ºé—´ä¸Šè¢«æ ‡è¯†</strong>ï¼ˆä¸€ä¸ªç±»å¿…é¡»ä¸ç±»åŠ è½½å™¨ä¸€èµ·ç¡®å®šå”¯ä¸€æ€§ï¼‰ã€‚</li>
<li>å¦‚æœæ•°ç»„çš„ç»„ä»¶ç±»å‹<strong>ä¸æ˜¯å¼•ç”¨ç±»å‹</strong>ï¼ˆä¾‹å¦‚ int[] æ•°ç»„ï¼‰ï¼ŒJava è™šæ‹Ÿæœºå°†ä¼šæŠŠæ•°ç»„ C <strong>æ ‡è®°ä¸ºä¸å¼•å¯¼ç±»åŠ è½½å™¨å…³è”</strong>ã€‚æ•°ç»„ç±»çš„å¯è§æ€§ä¸å®ƒçš„<strong>ç»„ä»¶ç±»å‹çš„å¯è§æ€§</strong>ä¸€è‡´ï¼Œ<ul>
<li>å¦‚æœç»„ä»¶ç±»å‹ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œé‚£æ•°ç»„ç±»çš„å¯è§æ€§å°†é»˜è®¤ä¸º publicã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>åŠ è½½é˜¶æ®µå®Œæˆåï¼Œè™šæ‹Ÿæœºå¤–éƒ¨çš„äºŒè¿›åˆ¶å­—èŠ‚æµå°±æŒ‰ç…§è™šæ‹Ÿæœºæ‰€éœ€çš„æ ¼å¼<strong>å­˜å‚¨åœ¨æ–¹æ³•åŒºä¹‹ä¸­</strong>ï¼Œ<strong>æ–¹æ³•åŒºä¸­çš„æ•°æ®å­˜å‚¨æ ¼å¼ç”±è™šæ‹Ÿæœºå®ç°è‡ªè¡Œå®šä¹‰</strong>ï¼Œè™šæ‹Ÿæœºè§„èŒƒ<strong>æœªè§„å®šæ­¤åŒºåŸŸçš„å…·ä½“æ•°æ®ç»“æ„</strong>ã€‚ç„¶ååœ¨å†…å­˜ä¸­å®ä¾‹åŒ–ä¸€ä¸ª <code>java.lang.Class</code> ç±»çš„å¯¹è±¡ï¼ˆå¹¶æ²¡æœ‰æ˜ç¡®è§„å®šæ˜¯åœ¨ Java å †ä¸­ï¼Œå¯¹äº HotSpot è™šæ‹Ÿæœºè€Œè¨€ï¼Œ<strong>Class å¯¹è±¡æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒè™½ç„¶æ˜¯å¯¹è±¡ï¼Œä½†æ˜¯å­˜æ”¾åœ¨æ–¹æ³•åŒºé‡Œé¢</strong>ï¼‰ï¼Œè¿™ä¸ªå¯¹è±¡å°†ä½œä¸ºç¨‹åº<strong>è®¿é—®æ–¹æ³•åŒºä¸­çš„è¿™äº›ç±»å‹æ•°æ®çš„å¤–éƒ¨æ¥å£</strong>ã€‚</p>
<p><strong>åŠ è½½é˜¶æ®µä¸è¿æ¥é˜¶æ®µçš„éƒ¨åˆ†å†…å®¹</strong>ï¼ˆå¦‚ä¸€éƒ¨åˆ†å­—èŠ‚ç æ–‡ä»¶æ ¼å¼éªŒè¯åŠ¨ä½œï¼‰æ˜¯<strong>äº¤å‰è¿›è¡Œ</strong>çš„ï¼ŒåŠ è½½é˜¶æ®µå°šæœªå®Œæˆï¼Œè¿æ¥é˜¶æ®µå¯èƒ½å·²ç»å¼€å§‹ï¼Œä½†è¿™äº›å¤¹åœ¨åŠ è½½é˜¶æ®µä¹‹ä¸­è¿›è¡Œçš„åŠ¨ä½œï¼Œä»ç„¶å±äºè¿æ¥é˜¶æ®µçš„å†…å®¹ï¼Œè¿™ä¸¤ä¸ªé˜¶æ®µçš„<strong>å¼€å§‹æ—¶é—´ä»ç„¶ä¿æŒç€å›ºå®šçš„å…ˆåé¡ºåº</strong>ã€‚</p>
<h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><h4 id="ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯ï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯ï¼Ÿ</h4><ul>
<li>è™½ç„¶åœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šå¯¹ java æºç ä¼šå¯¹ä»£ç è¿›è¡Œæ£€æŸ¥ã€‚ä½†æ˜¯ .class æ–‡ä»¶å¹¶ä¸€å®šä¸è¦æ±‚ç”¨ java æºç ç¼–è¯‘æ¥çš„ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ä»»ä½•é€”å¾„ç”Ÿæˆï¼Œç”šè‡³å¯ä»¥ç”¨åå…­è¿›åˆ¶ç¼–è¾‘å™¨ç›´æ¥ç¼–å†™ class æ–‡ä»¶ã€‚è™šæ‹Ÿæœºå¦‚æœä¸æ£€æŸ¥è¾“å…¥çš„å­—èŠ‚æµï¼Œå¯¹å…¶å®Œå…¨ä¿¡ä»»çš„è¯ï¼Œå¾ˆå¯èƒ½ä¼šå› ä¸ºè½½å…¥äº†æœ‰å®³çš„å­—èŠ‚æµè€Œå¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚æ‰€ä»¥éªŒè¯æ˜¯è™šæ‹Ÿæœºå¯¹è‡ªèº«ä¿æŠ¤çš„ä¸€é¡¹é‡è¦å·¥ä½œã€‚</li>
</ul>
<h4 id="éªŒè¯ä»€ä¹ˆï¼Ÿ"><a href="#éªŒè¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="éªŒè¯ä»€ä¹ˆï¼Ÿ"></a>éªŒè¯ä»€ä¹ˆï¼Ÿ</h4><ul>
<li>æ–‡ä»¶æ ¼å¼éªŒè¯</li>
<li>å…ƒæ•°æ®éªŒè¯</li>
<li>å­—èŠ‚ç éªŒè¯</li>
<li>ç¬¦å·å¼•ç”¨éªŒè¯</li>
</ul>
<h4 id="æ–‡ä»¶æ ¼å¼éªŒè¯"><a href="#æ–‡ä»¶æ ¼å¼éªŒè¯" class="headerlink" title="æ–‡ä»¶æ ¼å¼éªŒè¯"></a>æ–‡ä»¶æ ¼å¼éªŒè¯</h4><ul>
<li>æ˜¯å¦ä»¥é­”æ•° 0xCAFEBABE å¼€å¤´ã€‚</li>
<li>ä¸»ã€æ¬¡ç‰ˆæœ¬å·æ˜¯å¦åœ¨å½“å‰è™šæ‹Ÿæœºå¤„ç†èŒƒå›´ä¹‹å†…ã€‚</li>
<li>å¸¸é‡æ± çš„å¸¸é‡ä¸­æ˜¯å¦æœ‰ä¸è¢«æ”¯æŒçš„å¸¸é‡ç±»å‹ï¼ˆæ£€æŸ¥å¸¸é‡ tag æ ‡å¿—ï¼‰ã€‚</li>
<li>æŒ‡å‘å¸¸é‡çš„å„ç§ç´¢å¼•å€¼ä¸­æ˜¯å¦æœ‰æŒ‡å‘ä¸å­˜åœ¨çš„å¸¸é‡æˆ–ä¸ç¬¦åˆç±»å‹çš„å¸¸é‡ã€‚</li>
<li>â€¦â€¦</li>
</ul>
<p>è¯¥éªŒè¯é˜¶æ®µçš„ä¸»è¦ç›®çš„æ˜¯<strong>ä¿è¯è¾“å…¥çš„å­—èŠ‚æµèƒ½æ­£ç¡®åœ°è§£æå¹¶å­˜å‚¨äºæ–¹æ³•åŒºä¹‹å†…</strong>ï¼Œæ ¼å¼ä¸Šç¬¦åˆæè¿°ä¸€ä¸ª Java ç±»å‹ä¿¡æ¯çš„è¦æ±‚ã€‚è¿™é˜¶æ®µçš„éªŒè¯æ˜¯åŸºäºäºŒè¿›åˆ¶å­—èŠ‚æµè¿›è¡Œçš„ï¼Œ<strong>åªæœ‰é€šè¿‡äº†è¿™ä¸ªé˜¶æ®µçš„éªŒè¯åï¼Œå­—èŠ‚æµæ‰ä¼šè¿›å…¥å†…å­˜çš„æ–¹æ³•åŒºä¸­è¿›è¡Œå­˜å‚¨</strong>ï¼Œåé¢çš„ 3 ä¸ªéªŒè¯é˜¶æ®µå…¨éƒ¨æ˜¯åŸºäºæ–¹æ³•åŒºçš„å­˜å‚¨ç»“æ„è¿›è¡Œçš„ï¼Œä¸ä¼šå†ç›´æ¥æ“ä½œå­—èŠ‚æµã€‚</p>
<h4 id="å…ƒæ•°æ®éªŒè¯"><a href="#å…ƒæ•°æ®éªŒè¯" class="headerlink" title="å…ƒæ•°æ®éªŒè¯"></a>å…ƒæ•°æ®éªŒè¯</h4><p>ç¬¬äºŒé˜¶æ®µæ˜¯å¯¹å­—èŠ‚ç æè¿°çš„ä¿¡æ¯è¿›è¡Œ<strong>è¯­ä¹‰åˆ†æï¼Œä»¥ä¿è¯å…¶æè¿°çš„ä¿¡æ¯ç¬¦åˆ Java è¯­è¨€è§„èŒƒçš„è¦æ±‚</strong></p>
<ul>
<li>è¿™ä¸ªç±»<strong>æ˜¯å¦æœ‰çˆ¶ç±»</strong>ï¼ˆé™¤äº† java.lang.Object ä¹‹å¤–ï¼Œæ‰€æœ‰çš„ç±»éƒ½åº”å½“æœ‰çˆ¶ç±»ï¼‰ã€‚</li>
<li>è¿™ä¸ªç±»çš„çˆ¶ç±»<strong>æ˜¯å¦ç»§æ‰¿äº†ä¸å…è®¸è¢«ç»§æ‰¿çš„ç±»</strong>ï¼ˆè¢« final ä¿®é¥°çš„ç±»ï¼‰ã€‚</li>
<li>å¦‚æœè¿™ä¸ªç±»ä¸æ˜¯æŠ½è±¡ç±»ï¼Œæ˜¯å¦å®ç°äº†å…¶çˆ¶ç±»æˆ–æ¥å£ä¹‹ä¸­è¦æ±‚å®ç°çš„æ‰€æœ‰æ–¹æ³•ã€‚å³ï¼ŒéæŠ½è±¡ç±»æ˜¯å¦å®ç°äº†æ‰€æœ‰åº”è¯¥å®ç°çš„æ–¹æ³•ï¼Ÿ</li>
<li>ç±»ä¸­çš„å­—æ®µã€æ–¹æ³•æ˜¯å¦ä¸çˆ¶ç±»äº§ç”ŸçŸ›ç›¾ï¼ˆä¾‹å¦‚è¦†ç›–äº†çˆ¶ç±»çš„ final å­—æ®µï¼Œæˆ–è€…å‡ºç°ä¸ç¬¦åˆè§„åˆ™çš„æ–¹æ³•é‡è½½ï¼Œä¾‹å¦‚æ–¹æ³•å‚æ•°éƒ½ä¸€è‡´ï¼Œä½†è¿”å›å€¼ç±»å‹å´ä¸åŒç­‰ï¼‰ã€‚</li>
</ul>
<p>ç»§æ‰¿å…³ç³»ï¼Œæ–¹æ³•è¦†ç›–</p>
<h4 id="å­—èŠ‚ç éªŒè¯"><a href="#å­—èŠ‚ç éªŒè¯" class="headerlink" title="å­—èŠ‚ç éªŒè¯"></a>å­—èŠ‚ç éªŒè¯</h4><p>ç¬¬ä¸‰é˜¶æ®µæ˜¯æ•´ä¸ªéªŒè¯è¿‡ç¨‹ä¸­<strong>æœ€å¤æ‚çš„ä¸€ä¸ªé˜¶æ®µ</strong>ï¼Œä¸»è¦ç›®çš„æ˜¯é€šè¿‡æ•°æ®æµå’Œæ§åˆ¶æµåˆ†æï¼Œ<strong>ç¡®å®šç¨‹åºè¯­ä¹‰æ˜¯åˆæ³•çš„ã€ç¬¦åˆé€»è¾‘çš„</strong>ã€‚è¿™ä¸ªé˜¶æ®µå°†<strong>å¯¹ç±»çš„æ–¹æ³•ä½“è¿›è¡Œæ ¡éªŒåˆ†æ</strong>ï¼Œ<strong>ä¿è¯è¢«æ ¡éªŒç±»çš„æ–¹æ³•åœ¨è¿è¡Œæ—¶ä¸ä¼šåšå‡ºå±å®³è™šæ‹Ÿæœºå®‰å…¨çš„äº‹ä»¶</strong>ã€‚</p>
<ul>
<li>å¦‚æœä¸€ä¸ªç±»æ–¹æ³•ä½“çš„å­—èŠ‚ç æ²¡æœ‰é€šè¿‡å­—èŠ‚ç éªŒè¯ï¼Œé‚£è‚¯å®šæ˜¯æœ‰é—®é¢˜çš„ï¼›</li>
<li>ä½†å¦‚æœä¸€ä¸ªæ–¹æ³•ä½“é€šè¿‡äº†å­—èŠ‚ç éªŒè¯ï¼Œ<strong>ä¹Ÿä¸èƒ½è¯´æ˜å…¶ä¸€å®šå°±æ˜¯å®‰å…¨çš„</strong>ã€‚</li>
</ul>
<p>ç¦»æ•£æ•°å­¦ä¸­ä¸€ä¸ªå¾ˆè‘—åçš„é—®é¢˜ã€ŒHalting Problemã€ï¼ˆåœæœºé—®é¢˜ï¼‰ ï¼šé€šè¿‡ç¨‹åºå»æ ¡éªŒç¨‹åºé€»è¾‘æ˜¯æ— æ³•åšåˆ°ç»å¯¹å‡†ç¡®çš„â€”â€”ä¸èƒ½é€šè¿‡ç¨‹åºå‡†ç¡®åœ°æ£€æŸ¥å‡ºç¨‹åºæ˜¯å¦èƒ½åœ¨æœ‰é™çš„æ—¶é—´ä¹‹å†…ç»“æŸè¿è¡Œã€‚</p>
<h4 id="ç¬¦å·å¼•ç”¨éªŒè¯"><a href="#ç¬¦å·å¼•ç”¨éªŒè¯" class="headerlink" title="ç¬¦å·å¼•ç”¨éªŒè¯"></a>ç¬¦å·å¼•ç”¨éªŒè¯</h4><p>å‘ç”Ÿåœ¨è™šæ‹Ÿæœº<strong>å°†ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨</strong>çš„æ—¶å€™ï¼Œè¿™ä¸ªè½¬åŒ–åŠ¨ä½œå°†åœ¨è¿æ¥çš„ç¬¬ä¸‰é˜¶æ®µâ€”â€”<strong>è§£æé˜¶æ®µ</strong>ä¸­å‘ç”Ÿã€‚</p>
<p>ç¬¦å·å¼•ç”¨éªŒè¯å¯ä»¥çœ‹åšæ˜¯<strong>å¯¹ç±»è‡ªèº«ä»¥å¤–ï¼ˆå¸¸é‡æ± ä¸­çš„å„ç§ç¬¦å·å¼•ç”¨ï¼‰çš„ä¿¡æ¯è¿›è¡ŒåŒ¹é…æ€§æ ¡éªŒ</strong>ï¼Œé€šå¸¸éœ€è¦æ ¡éªŒä¸‹åˆ—å†…å®¹ï¼š</p>
<ul>
<li>ç¬¦å·å¼•ç”¨ä¸­é€šè¿‡å­—ç¬¦ä¸²æè¿°çš„<strong>å…¨é™å®šåæ˜¯å¦èƒ½æ‰¾åˆ°å¯¹åº”çš„ç±»</strong>ã€‚</li>
<li>åœ¨æŒ‡å®šç±»ä¸­<strong>æ˜¯å¦å­˜åœ¨ç¬¦åˆ</strong>æ–¹æ³•çš„å­—æ®µæè¿°ç¬¦ä»¥åŠç®€å•åç§°æ‰€æè¿°çš„<em>*æ–¹æ³•å’Œå­—æ®µ</em>ã€‚</li>
<li>ç¬¦å·å¼•ç”¨ä¸­çš„ç±»ã€å­—æ®µã€æ–¹æ³•çš„<strong>è®¿é—®æ€§</strong>ï¼ˆprivateã€protectedã€publicã€defaultï¼‰æ˜¯å¦å¯è¢«å½“å‰ç±»è®¿é—®ã€‚</li>
</ul>
<h3 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h3><p>å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®<strong>==ç±»å˜é‡==åˆå§‹å€¼çš„é˜¶æ®µ</strong>ï¼Œè¿™äº›å˜é‡æ‰€ä½¿ç”¨çš„å†…å­˜éƒ½å°†åœ¨<strong>æ–¹æ³•åŒº</strong>ä¸­è¿›è¡Œåˆ†é…ã€‚</p>
<ul>
<li>é¦–å…ˆï¼Œè¿™æ—¶å€™è¿›è¡Œå†…å­˜åˆ†é…çš„<strong>ä»…åŒ…æ‹¬ç±»å˜é‡</strong>ï¼ˆè¢« static ä¿®é¥°çš„å˜é‡ï¼‰ï¼Œè€Œä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼Œå®ä¾‹å˜é‡å°†ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€èµ·åˆ†é…åœ¨ Java å †ä¸­ã€‚</li>
<li>å…¶æ¬¡ï¼Œè¿™é‡Œæ‰€è¯´çš„åˆå§‹å€¼ã€Œ<strong>é€šå¸¸æƒ…å†µã€ä¸‹æ˜¯æ•°æ®ç±»å‹çš„é›¶å€¼</strong><ul>
<li>è¿™æ—¶å€™å°šæœªå¼€å§‹æ‰§è¡Œä»»ä½• Java æ–¹æ³•ã€‚</li>
<li>ã€Œ==ç‰¹æ®Šæƒ…å†µ==ã€ï¼šå¦‚æœç±»å­—æ®µçš„å­—æ®µå±æ€§è¡¨ä¸­å­˜åœ¨ ConstantValue å±æ€§ï¼Œé‚£åœ¨å‡†å¤‡é˜¶æ®µå˜é‡ value å°±ä¼šè¢«åˆå§‹åŒ–ä¸º ConstantValue å±æ€§æ‰€æŒ‡å®šçš„å€¼ã€‚<ul>
<li>å‡è®¾ä¸Šé¢ç±»å˜é‡ value çš„å®šä¹‰å˜ä¸ºï¼š<code>public static final int value=123ï¼›</code> é‚£ä¹ˆåœ¨å‡†å¤‡é˜¶æ®µè™šæ‹Ÿæœºå°±ä¼šæ ¹æ® ConstantValue çš„è®¾ç½®å°† value èµ‹å€¼ä¸º 123ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h3><p>è§£æé˜¶æ®µæ˜¯è™šæ‹Ÿæœº<strong>å°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹</strong>ï¼Œåœ¨ Class æ–‡ä»¶ä¸­ ç¬¦å·å¼•ç”¨ ä»¥ <code>CONSTANT_Class_infoã€CONSTANT_Fieldref_infoã€CONSTANT_Methodref_info</code> ç­‰ç±»å‹çš„å¸¸é‡å‡ºç°</p>
<p><strong>ç¬¦å·å¼•ç”¨</strong>ï¼ˆSymbolic  Referencesï¼‰ï¼šç¬¦å·å¼•ç”¨<strong>ä»¥ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡</strong>ï¼Œç¬¦å·å¯ä»¥æ˜¯ä»»ä½•å½¢å¼çš„å­—é¢é‡ï¼Œåªè¦ä½¿ç”¨æ—¶èƒ½æ— æ­§ä¹‰åœ°å®šä½åˆ°ç›®æ ‡å³å¯ã€‚<strong>å„ç§è™šæ‹Ÿæœºå®ç°çš„å†…å­˜å¸ƒå±€å¯ä»¥å„ä¸ç›¸åŒ</strong>ï¼Œä½†æ˜¯å®ƒä»¬èƒ½æ¥å—çš„ç¬¦å·å¼•ç”¨å¿…é¡»éƒ½æ˜¯ä¸€è‡´çš„ï¼Œå› ä¸ºç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨ Java è™šæ‹Ÿæœºè§„èŒƒçš„ Class æ–‡ä»¶æ ¼å¼ä¸­ã€‚</p>
<p><strong>ç›´æ¥å¼•ç”¨</strong>ï¼ˆDirect Referencesï¼‰ï¼šç›´æ¥å¼•ç”¨å¯ä»¥æ˜¯<strong>ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–æ˜¯ä¸€ä¸ªèƒ½é—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„</strong>ã€‚</p>
<ul>
<li>ç›´æ¥å¼•ç”¨æ˜¯<strong>å’Œè™šæ‹Ÿæœºå®ç°çš„å†…å­˜å¸ƒå±€ç›¸å…³çš„</strong>ï¼ŒåŒä¸€ä¸ªç¬¦å·å¼•ç”¨åœ¨ä¸åŒè™šæ‹Ÿæœºå®ä¾‹ä¸Šç¿»è¯‘å‡ºæ¥çš„ç›´æ¥å¼•ç”¨ä¸€èˆ¬ä¸ä¼šç›¸åŒã€‚<ul>
<li>å¦‚æœæœ‰äº†ç›´æ¥å¼•ç”¨ï¼Œé‚£å¼•ç”¨çš„ç›®æ ‡å¿…å®šå·²ç»åœ¨å†…å­˜ä¸­å­˜åœ¨ã€‚</li>
</ul>
</li>
</ul>
<p>è™šæ‹Ÿæœºå®ç°å¯ä»¥æ ¹æ®éœ€è¦æ¥åˆ¤æ–­åˆ°åº•æ˜¯åœ¨ç±»è¢«åŠ è½½å™¨åŠ è½½æ—¶å°±å¯¹å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è¿›è¡Œè§£æï¼Œè¿˜æ˜¯ç­‰åˆ°ä¸€ä¸ªç¬¦å·å¼•ç”¨å°†è¦è¢«ä½¿ç”¨å‰æ‰å»è§£æå®ƒã€‚</p>
<p>invokedynamic æŒ‡ä»¤çš„ç›®çš„æœ¬æ¥å°±æ˜¯ç”¨äºåŠ¨æ€è¯­è¨€æ”¯æŒï¼ˆç›®å‰ä»…ä½¿ç”¨ Java è¯­è¨€ä¸ä¼šç”Ÿæˆè¿™æ¡å­—èŠ‚ç æŒ‡ä»¤ï¼‰ï¼Œå®ƒæ‰€å¯¹åº”çš„å¼•ç”¨ç§°ä¸ºã€ŒåŠ¨æ€è°ƒç”¨ç‚¹é™å®šç¬¦ã€ï¼ˆDynamic  Call  Site Specifierï¼‰ï¼Œè¿™é‡Œã€Œ<strong>åŠ¨æ€ã€çš„å«ä¹‰å°±æ˜¯å¿…é¡»ç­‰åˆ°ç¨‹åºå®é™…è¿è¡Œåˆ°è¿™æ¡æŒ‡ä»¤çš„æ—¶å€™ï¼Œè§£æåŠ¨ä½œæ‰èƒ½è¿›è¡Œ</strong>ã€‚</p>
<ul>
<li>ç›¸å¯¹çš„ï¼Œå…¶ä½™å¯è§¦å‘è§£æçš„æŒ‡ä»¤éƒ½æ˜¯ã€Œé™æ€ã€çš„ï¼Œå¯ä»¥åœ¨åˆšåˆšå®ŒæˆåŠ è½½é˜¶æ®µï¼Œè¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œä»£ç æ—¶å°±è¿›è¡Œè§£æã€‚</li>
</ul>
<h4 id="1-ç±»æˆ–æ¥å£çš„è§£æ"><a href="#1-ç±»æˆ–æ¥å£çš„è§£æ" class="headerlink" title="1. ç±»æˆ–æ¥å£çš„è§£æ"></a>1. ç±»æˆ–æ¥å£çš„è§£æ</h4><p>å‡è®¾å½“å‰ä»£ç æ‰€å¤„çš„ç±»ä¸º Dï¼Œå¦‚æœè¦æŠŠä¸€ä¸ªä»æœªè§£æè¿‡çš„ç¬¦å·å¼•ç”¨ N è§£æä¸ºä¸€ä¸ªç±»æˆ–æ¥å£ C çš„ç›´æ¥å¼•ç”¨ï¼Œé‚£è™šæ‹Ÿæœºå®Œæˆæ•´ä¸ªè§£æçš„è¿‡ç¨‹éœ€è¦ä»¥ä¸‹ 3 ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å¦‚æœ C ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œé‚£è™šæ‹Ÿæœºå°†ä¼šæŠŠä»£è¡¨ N çš„å…¨é™å®šåä¼ é€’ç»™ D çš„ç±»åŠ è½½å™¨å»åŠ è½½è¿™ä¸ªç±» Cã€‚åœ¨åŠ è½½è¿‡ç¨‹ä¸­ï¼Œç”±äºå…ƒæ•°æ®éªŒè¯ã€å­—èŠ‚ç éªŒè¯çš„éœ€è¦ï¼Œåˆå¯èƒ½è§¦å‘å…¶ä»–ç›¸å…³ç±»çš„åŠ è½½åŠ¨ä½œï¼Œä¾‹å¦‚åŠ è½½è¿™ä¸ªç±»çš„çˆ¶ç±»æˆ–å®ç°çš„æ¥å£ã€‚ä¸€æ—¦è¿™ä¸ªåŠ è½½è¿‡ç¨‹å‡ºç°äº†ä»»ä½•å¼‚å¸¸ï¼Œè§£æè¿‡ç¨‹å°±å®£å‘Šå¤±è´¥ã€‚</li>
<li>å¦‚æœ C æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œå¹¶ä¸”æ•°ç»„çš„å…ƒç´ ç±»å‹ä¸ºå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ N çš„æè¿°ç¬¦ä¼šæ˜¯ç±»ä¼¼ã€Œ[Ljava/lang/Integerã€çš„å½¢å¼ï¼Œé‚£å°†ä¼šæŒ‰ç…§ç¬¬ 1 ç‚¹çš„è§„åˆ™åŠ è½½æ•°ç»„å…ƒç´ ç±»å‹ã€‚å¦‚æœ N çš„æè¿°ç¬¦<br>å¦‚å‰é¢æ‰€å‡è®¾çš„å½¢å¼ï¼Œéœ€è¦åŠ è½½çš„å…ƒç´ ç±»å‹å°±æ˜¯ã€Œjava.lang.Integerã€ï¼Œæ¥ç€ç”±è™šæ‹Ÿæœºç”Ÿæˆä¸€ä¸ªä»£è¡¨æ­¤æ•°ç»„ç»´åº¦å’Œå…ƒç´ çš„æ•°ç»„å¯¹è±¡ã€‚</li>
<li>å¦‚æœä¸Šé¢çš„æ­¥éª¤æ²¡æœ‰å‡ºç°ä»»ä½•å¼‚å¸¸ï¼Œé‚£ä¹ˆ C åœ¨è™šæ‹Ÿæœºä¸­å®é™…ä¸Šå·²ç»æˆä¸ºä¸€ä¸ªæœ‰æ•ˆçš„ç±»æˆ–æ¥å£äº†ï¼Œä½†åœ¨è§£æå®Œæˆä¹‹å‰è¿˜è¦è¿›è¡Œ<strong>ç¬¦å·å¼•ç”¨éªŒè¯</strong>ï¼Œæ£€æŸ¥è®¿é—®æƒé™ã€‚å¦‚æœå‘ç°ä¸å…·å¤‡è®¿é—®æƒé™ï¼Œå°†æŠ›å‡º <code>java.lang.IllegalAccessError å¼‚å¸¸ã€‚</code></li>
</ol>
<h4 id="å­—æ®µè§£æ"><a href="#å­—æ®µè§£æ" class="headerlink" title="å­—æ®µè§£æ"></a>å­—æ®µè§£æ</h4><h4 id="ç±»æ–¹æ³•è§£æ"><a href="#ç±»æ–¹æ³•è§£æ" class="headerlink" title="ç±»æ–¹æ³•è§£æ"></a>ç±»æ–¹æ³•è§£æ</h4><h4 id="æ¥å£æ–¹æ³•è§£æ"><a href="#æ¥å£æ–¹æ³•è§£æ" class="headerlink" title="æ¥å£æ–¹æ³•è§£æ"></a>æ¥å£æ–¹æ³•è§£æ</h4><p>æ¥å£çš„æ–¹æ³•ã€å¸¸é‡éƒ½æ˜¯ public çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦è¿›è¡Œæƒé™éªŒè¯</p>
<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>ç±»åˆå§‹åŒ–é˜¶æ®µæ˜¯ç±»åŠ è½½è¿‡ç¨‹çš„æœ€åä¸€æ­¥ï¼Œå‰é¢çš„ç±»åŠ è½½è¿‡ç¨‹ä¸­ï¼Œé™¤äº†åœ¨åŠ è½½é˜¶æ®µç”¨æˆ·åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨å‚ä¸ä¹‹å¤–ï¼Œå…¶ä½™åŠ¨ä½œå®Œå…¨ç”±è™šæ‹Ÿæœºä¸»å¯¼å’Œæ§åˆ¶ã€‚<br><strong>åˆ°äº†åˆå§‹åŒ–é˜¶æ®µï¼Œæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œç±»ä¸­å®šä¹‰çš„ Java ç¨‹åºä»£ç ï¼ˆæˆ–è€…è¯´æ˜¯å­—èŠ‚ç </strong>ï¼‰ã€‚</p>
<ul>
<li>åœ¨å‡†å¤‡é˜¶æ®µï¼Œå˜é‡å·²ç»èµ‹è¿‡ä¸€æ¬¡ç³»ç»Ÿè¦æ±‚çš„åˆå§‹å€¼</li>
<li>åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œæ ¹æ®é¡¹ç›®éœ€è¦å¯¹ç±»å˜é‡è¿›è¡Œç›¸åº”çš„åˆå§‹åŒ–ï¼Œæˆ–è€…å¯ä»¥ä»å¦å¤–ä¸€ä¸ªè§’åº¦æ¥è¡¨è¾¾ï¼šåˆå§‹åŒ–é˜¶æ®µæ˜¯æ‰§è¡Œç±»æ„é€ å™¨ <clinit>() æ–¹æ³•çš„è¿‡ç¨‹ã€‚</clinit></li>
</ul>
<p><clinit>()æ–¹æ³•æ˜¯<strong>ç”±ç¼–è¯‘å™¨</strong>è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„<strong>æ‰€æœ‰ç±»å˜é‡çš„==èµ‹å€¼åŠ¨ä½œ==å’Œé™æ€è¯­å¥å—</strong>ï¼ˆstatic{}å—ï¼‰ä¸­çš„è¯­å¥åˆå¹¶<strong>äº§ç”Ÿçš„</strong>ï¼Œ</clinit></p>
<ul>
<li>ç¼–è¯‘å™¨æ”¶é›†çš„é¡ºåºæ˜¯ç”±è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºæ‰€å†³å®šçš„ï¼Œ</li>
<li>é™æ€è¯­å¥å—ä¸­åªèƒ½è®¿é—®åˆ°å®šä¹‰åœ¨é™æ€è¯­å¥å—ä¹‹å‰çš„å˜é‡ï¼Œå®šä¹‰åœ¨å®ƒä¹‹åçš„å˜é‡ï¼Œåœ¨å‰é¢çš„é™æ€è¯­å¥å—å¯ä»¥èµ‹å€¼ï¼Œä½†æ˜¯ä¸èƒ½è®¿é—®ã€‚</li>
<li>å¦‚æœæ²¡æœ‰é™æ€è¯­å¥å—ä¹Ÿæ²¡æœ‰å˜é‡åˆå§‹åŒ–èµ‹å€¼ï¼Œå°±ä¸ä¼šäº§ç”Ÿ <init> æ–¹æ³•</init></li>
</ul>
<p><clinit>()æ–¹æ³•<strong>ä¸éœ€è¦æ˜¾å¼åœ°è°ƒç”¨çˆ¶ç±»æ„é€ å™¨</strong>ï¼Œè™šæ‹Ÿæœºä¼šä¿è¯åœ¨å­ç±»çš„ <clinit>()æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œçˆ¶ç±»çš„<clinit>()æ–¹æ³•å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚<br>å› æ­¤åœ¨è™šæ‹Ÿæœºä¸­ç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„ <clinit>()æ–¹æ³•çš„ç±»è‚¯å®šæ˜¯ <code>java.lang.Object</code>ã€‚</clinit></clinit></clinit></clinit></p>
<p>æ¥å£ä¸ç±»ä¸€æ ·éƒ½ä¼šç”Ÿæˆ <clinit>()æ–¹æ³•ã€‚ä½†æ¥å£ä¸ç±»ä¸åŒçš„æ˜¯ï¼Œ</clinit></p>
<ul>
<li>æ‰§è¡Œæ¥å£çš„ <clinit>()æ–¹æ³•ä¸éœ€è¦å…ˆæ‰§è¡Œçˆ¶æ¥å£çš„ <clinit>()æ–¹æ³•ã€‚åªæœ‰å½“çˆ¶æ¥å£ä¸­å®šä¹‰çš„å˜é‡ä½¿ç”¨æ—¶ï¼Œçˆ¶æ¥å£æ‰ä¼šåˆå§‹åŒ–ã€‚</clinit></clinit></li>
<li>å¦å¤–ï¼Œæ¥å£çš„å®ç°ç±»åœ¨åˆå§‹åŒ–æ—¶ä¹Ÿä¸€æ ·ä¸ä¼šæ‰§è¡Œæ¥å£çš„ <clinit>()æ–¹æ³•ã€‚</clinit></li>
</ul>
<p><strong>è™šæ‹Ÿæœº</strong>ä¼šä¿è¯ä¸€ä¸ªç±»çš„ <clinit> æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«<strong>æ­£ç¡®åœ°åŠ é”ã€åŒæ­¥</strong>ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å»åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œè¿™ä¸ªç±»çš„<clinit>()æ–¹æ³•ï¼Œå…¶ä»–çº¿ç¨‹éƒ½éœ€è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æ´»åŠ¨çº¿ç¨‹æ‰§è¡Œ<clinit>()æ–¹æ³•å®Œæ¯•ã€‚å¦‚æœåœ¨ä¸€ä¸ªç±»çš„ <clinit> ()æ–¹æ³•ä¸­æœ‰è€—æ—¶å¾ˆé•¿çš„æ“ä½œï¼Œå°±å¯èƒ½é€ æˆå¤šä¸ªè¿›ç¨‹é˜»å¡ã€‚åœ¨å®é™…åº”ç”¨ä¸­è¿™ç§é˜»å¡å¾€å¾€æ˜¯å¾ˆéšè”½çš„</clinit></clinit></clinit></clinit></p>
<h2 id="ç±»åŠ è½½å™¨"><a href="#ç±»åŠ è½½å™¨" class="headerlink" title="ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h2><h3 id="ç±»ä¸ç±»åŠ è½½å™¨"><a href="#ç±»ä¸ç±»åŠ è½½å™¨" class="headerlink" title="ç±»ä¸ç±»åŠ è½½å™¨"></a>ç±»ä¸ç±»åŠ è½½å™¨</h3><p>å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æœ¬èº«ä¸€åŒç¡®ç«‹å…¶åœ¨ Java è™šæ‹Ÿæœºä¸­çš„<strong>å”¯ä¸€æ€§</strong>ï¼Œæ¯ä¸€ä¸ªç±»åŠ è½½å™¨éƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ã€‚</p>
<h3 id="åŒäº²å§”æ´¾æ¨¡å‹"><a href="#åŒäº²å§”æ´¾æ¨¡å‹" class="headerlink" title="åŒäº²å§”æ´¾æ¨¡å‹"></a>åŒäº²å§”æ´¾æ¨¡å‹</h3><p>ä» <strong>Java è™šæ‹Ÿæœºçš„è§’åº¦</strong>æ¥è®²ï¼Œåªå­˜åœ¨ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼š</p>
<ul>
<li>ä¸€ç§æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap  ClassLoaderï¼‰ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨ä½¿ç”¨ <strong>C++ è¯­è¨€å®ç°</strong> ï¼Œæ˜¯<strong>è™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†</strong>ï¼›</li>
<li>å¦ä¸€ç§å°±æ˜¯æ‰€æœ‰å…¶ä»–çš„ç±»åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨éƒ½ç”± <strong>Java</strong> è¯­è¨€å®ç°ï¼Œ<strong>ç‹¬ç«‹äºè™šæ‹Ÿæœºå¤–éƒ¨</strong>ï¼Œå¹¶ä¸”å…¨éƒ½ç»§æ‰¿è‡ªæŠ½è±¡ç±» java.lang.ClassLoaderã€‚</li>
</ul>
<p>ä» Java å¼€å‘äººå‘˜çš„è§’åº¦æ¥çœ‹ï¼Œç»å¤§éƒ¨åˆ† Java ç¨‹åºéƒ½ä¼šä½¿ç”¨åˆ°ä»¥ä¸‹ 3 ç§ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨ã€‚</p>
<ul>
<li>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼šè¿™ä¸ªç±»å°†å™¨è´Ÿè´£å°†å­˜æ”¾åœ¨<code>ï¼œJAVA_HOMEï¼\lib</code> ç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢«-Xbootclasspath å‚æ•°æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„ï¼Œå¹¶ä¸”æ˜¯è™šæ‹Ÿæœºè¯†åˆ«çš„ï¼ˆä»…<strong>æŒ‰ç…§æ–‡ä»¶åè¯†åˆ«</strong>ï¼Œå¦‚ rt.jarï¼Œåå­—ä¸ç¬¦åˆçš„ç±»åº“å³ä½¿æ”¾åœ¨ lib ç›®å½•ä¸­ä¹Ÿä¸ä¼šè¢«åŠ è½½ï¼‰<br>ç±»åº“åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­ã€‚<ul>
<li>æ— æ³•ç›´æ¥è¢«ç”¨æˆ·ä½¿ç”¨ï¼Œåªèƒ½é€šè¿‡å­ç±»è¿”å› null æ¥é—´æ¥è°ƒç”¨ã€‚</li>
</ul>
</li>
<li>æ‰©å±•ç±»åŠ è½½å™¨ï¼š<code>Extension ClassLoader</code>ï¼Œè´Ÿè´£åŠ è½½<code>ï¼œJAVA_HOMEï¼\lib\ext</code> (æ‰©å±•åº“)ç›®å½•ä¸­çš„ï¼Œæˆ–è€…è¢« java.ext.dirs ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ã€‚</li>
<li>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼šå› ä¸ºå¯ä»¥é€šè¿‡ <code>ClassLoader.getSystemClassLoader()</code> è·å–ï¼Œå› æ­¤ä¸€èˆ¬ä¹Ÿç§°ä¸º<strong>ç³»ç»Ÿç±»åŠ è½½å™¨</strong>ï¼Œè´Ÿè´£åŠ è½½ç”¨æˆ·è·¯å¾„ä¸Šæ‰€æŒ‡å®šç±»åº“ï¼Œå¯ä»¥ç›´æ¥è¢«å¼€å‘è€…ä½¿ç”¨ã€‚</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/16668676/28991885-d64d2c7c-79c1-11e7-9a8f-865a69fc24a2.png" alt="default"></p>
<p>ä¸Šå›¾ä¸­å±•ç¤ºçš„å±‚æ¬¡å…³ç³»ï¼Œç§°ä¸º<strong>ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æ¨¡å‹</strong>ã€‚</p>
<ul>
<li>è¯¥æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”è¯¥æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚<ul>
<li>æ­¤å¤„çš„çˆ¶å­å…³ç³»é€šå¸¸ä¸ä¼šé€šè¿‡ç»§æ‰¿å…³ç³»æ¥å®ç°ï¼Œè€Œæ˜¯é€‰æ‹©<strong>ç»„åˆ</strong>å…³ç³»æ¥å¤ç”¨çˆ¶åŠ è½½å™¨çš„ä»£ç </li>
</ul>
</li>
</ul>
<p><strong>å·¥ä½œè¿‡ç¨‹</strong>ï¼šå½“ä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚æ—¶ï¼Œå®ƒä¸æ˜¯è‡ªå·±åŠ è½½ï¼Œè€Œæ˜¯å°†è¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€å±‚çš„ç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œå› æ­¤<strong>æ‰€æœ‰çš„åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­</strong>ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¯¥è¯·æ±‚æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ã€‚</p>
<p><strong>å¥½å¤„</strong>ï¼š</p>
<ul>
<li>Java ç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡äº†ä¸€ç§<strong>å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»</strong>ã€‚</li>
<li><strong>ä¿è¯ java æ ¸å¿ƒåº“çš„å®‰å…¨æ€§</strong>ï¼ˆä¾‹å¦‚ï¼šå¦‚æœç”¨æˆ·è‡ªå·±å†™äº†ä¸€ä¸ª java.lang.String ç±»å°±ä¼šå› ä¸ºåŒäº²å§”æ´¾æœºåˆ¶ä¸èƒ½è¢«åŠ è½½ï¼Œä¸ä¼šç ´ååŸç”Ÿçš„ String ç±»çš„åŠ è½½ï¼‰<ul>
<li>æ —å­ï¼š Object ç±»ï¼Œæ— è®ºå“ªä¸€ä¸ªç±»è¦åŠ è½½è¯¥ç±»ï¼Œæœ€ç»ˆéƒ½æ˜¯å§”æ´¾ç»™å¤„äºæ¨¡å‹æœ€é¡¶ç«¯çš„å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå› æ­¤ Object ç±»åœ¨ç¨‹åºçš„å„ç§ç±»åŠ è½½å™¨ç¯å¢ƒä¸­éƒ½æ˜¯åŒä¸€ä¸ªç±»ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å®ç°</strong>ï¼šåœ¨ ClassLoader çš„ loadClass æ–¹æ³•ä¸­ã€‚</p>
<h3 id="å¯¹æ¯”ï¼š"><a href="#å¯¹æ¯”ï¼š" class="headerlink" title="å¯¹æ¯”ï¼š"></a>å¯¹æ¯”ï¼š</h3><p>ä»£ç†æ¨¡å¼ï¼š</p>
<ul>
<li>ä¸åŒäº²å§”æ´¾æœºåˆ¶ç›¸åï¼Œä»£ç†æ¨¡å¼æ˜¯å…ˆè‡ªå·±å°è¯•åŠ è½½ï¼Œå¦‚æœæ— æ³•åŠ è½½åˆ™å‘ä¸Šä¼ é€’ã€‚tomcat å°±æ˜¯ä»£ç†æ¨¡å¼ã€‚</li>
</ul>
<h3 id="ã€Œç ´åã€åŒäº²å§”æ´¾æ¨¡å‹"><a href="#ã€Œç ´åã€åŒäº²å§”æ´¾æ¨¡å‹" class="headerlink" title="ã€Œç ´åã€åŒäº²å§”æ´¾æ¨¡å‹"></a>ã€Œç ´åã€åŒäº²å§”æ´¾æ¨¡å‹</h3><p>åŒäº²å§”æ´¾æ¨¡å‹å¹¶ä¸æ˜¯ä¸€ä¸ªå¼ºåˆ¶æ€§çš„çº¦æŸæ¨¡å‹ã€‚</p>
<ul>
<li>åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸€æ¬¡ã€Œè¢«ç ´åã€å…¶å®å‘ç”Ÿåœ¨<strong>åŒäº²å§”æ´¾æ¨¡å‹å‡ºç°ä¹‹å‰</strong>â€”â€”å³ JDK 1.2 å‘å¸ƒä¹‹å‰ã€‚</li>
<li>åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬äºŒæ¬¡ã€Œè¢«ç ´åã€æ˜¯ç”±è¿™ä¸ªæ¨¡å‹<strong>è‡ªèº«çš„ç¼ºé™·</strong>æ‰€å¯¼è‡´çš„ï¼ŒåŒäº²å§”æ´¾å¾ˆå¥½åœ°è§£å†³äº†å„ä¸ªç±»åŠ è½½å™¨çš„åŸºç¡€ç±»çš„ç»Ÿä¸€é—®é¢˜ï¼ˆè¶ŠåŸºç¡€çš„ç±»ç”±è¶Šä¸Šå±‚çš„åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼‰<ul>
<li>åŸºç¡€ç±»ä¹‹æ‰€ä»¥ç§°ä¸ºã€ŒåŸºç¡€ã€ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ€»æ˜¯ä½œä¸ºè¢«ç”¨æˆ·ä»£ç è°ƒç”¨çš„ APIï¼Œä½†æ˜¯<strong>åŸºç¡€ç±»è°ƒç”¨å›ç”¨æˆ·çš„ä»£ç ä¸å®¹æ˜“</strong>ï¼ˆç”¨å›è°ƒä¸è¡Œï¼Ÿï¼Ÿï¼‰</li>
<li>ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ä¾¿æ˜¯ JNDI æœåŠ¡</li>
</ul>
</li>
<li>åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸‰æ¬¡ã€Œè¢«ç ´åã€æ˜¯ç”±äºç”¨æˆ·å¯¹<strong>ç¨‹åºåŠ¨æ€æ€§</strong>çš„è¿½æ±‚è€Œå¯¼è‡´çš„ï¼Œè¿™é‡Œæ‰€è¯´çš„ã€ŒåŠ¨æ€æ€§ã€æŒ‡çš„æ˜¯å½“å‰ä¸€äº›éå¸¸ã€Œçƒ­é—¨ã€çš„åè¯ï¼šä»£ç çƒ­æ›¿æ¢ï¼ˆHotSwapï¼‰ã€æ¨¡å—çƒ­éƒ¨ç½²ï¼ˆHotDeploymentï¼‰ç­‰ï¼Œè¯´ç™½äº†å°±æ˜¯å¸Œæœ›åº”ç”¨ç¨‹åºèƒ½åƒæˆ‘ä»¬çš„è®¡ç®—æœºå¤–è®¾é‚£æ ·ï¼Œæ¥ä¸Šé¼ æ ‡ã€U ç›˜ï¼Œä¸ç”¨é‡å¯æœºå™¨å°±èƒ½ç«‹å³ä½¿ç”¨ã€‚çƒ­æ’æ‹”ï¼Ÿ</li>
</ul>
<p>åœ¨ OSGi ç¯å¢ƒä¸‹ï¼Œç±»åŠ è½½å™¨ä¸å†æ˜¯åŒäº²å§”æ´¾æ¨¡å‹ä¸­çš„æ ‘çŠ¶ç»“æ„ï¼Œè€Œæ˜¯è¿›ä¸€æ­¥å‘å±•ä¸ºæ›´åŠ å¤æ‚çš„<strong>ç½‘çŠ¶ç»“æ„</strong>ï¼Œå½“æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼ŒOSGi å°†æŒ‰ç…§ä¸‹é¢çš„é¡ºåºè¿›è¡Œç±»æœç´¢ï¼š</p>
<ol>
<li>å°†ä»¥ java.*å¼€å¤´çš„ç±»å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€‚</li>
<li>å¦åˆ™ï¼Œå°†å§”æ´¾åˆ—è¡¨åå•å†…çš„ç±»å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€‚</li>
<li>å¦åˆ™ï¼Œå°† Import åˆ—è¡¨ä¸­çš„ç±»å§”æ´¾ç»™ Export è¿™ä¸ªç±»çš„ Bundle çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚</li>
<li>å¦åˆ™ï¼ŒæŸ¥æ‰¾å½“å‰ Bundle çš„ ClassPathï¼Œä½¿ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚</li>
<li>å¦åˆ™ï¼ŒæŸ¥æ‰¾ç±»æ˜¯å¦åœ¨è‡ªå·±çš„ Fragment Bundle ä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™å§”æ´¾ç»™ Fragment Bundle çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚</li>
<li>å¦åˆ™ï¼ŒæŸ¥æ‰¾ Dynamic Import åˆ—è¡¨çš„ Bundleï¼Œå§”æ´¾ç»™å¯¹åº” Bundle çš„ç±»åŠ è½½å™¨åŠ è½½ã€‚</li>
<li>å¦åˆ™ï¼Œç±»æŸ¥æ‰¾å¤±è´¥ã€‚</li>
</ol>
<h2 id="ä¸€ä¸ªé—®é¢˜"><a href="#ä¸€ä¸ªé—®é¢˜" class="headerlink" title="ä¸€ä¸ªé—®é¢˜"></a>ä¸€ä¸ªé—®é¢˜</h2><p>å†™å‡ºä¸‹é¢ä»£ç ä¸­çš„è¾“å‡ºç»“æœ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingleTon singleTon = <span class="keyword">new</span> SingleTon();</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count1;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count2 = <span class="number">0</span>;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</div><div class="line">        count1++;</div><div class="line">        count2++;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> singleTon;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SingleTon singleTon = SingleTon.getInstance();</div><div class="line">        System.out.println(<span class="string">"count1="</span> + singleTon.count1);</div><div class="line">        System.out.println(<span class="string">"count2="</span> + singleTon.count2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ†æ:</p>
<ol>
<li>ä» main å‡½æ•°çœ‹èµ·ï¼Œ<code>SingleTon singleTon = SingleTon.getInstance();</code>è°ƒç”¨äº†SingleTonç±»çš„é™æ€æ–¹æ³•ï¼Œè§¦å‘ç±»çš„åˆå§‹åŒ–ã€‚</li>
<li>ç±»åŠ è½½çš„æ—¶å€™åœ¨å‡†å¤‡è¿‡ç¨‹ä¸­ä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–é»˜è®¤å€¼<code>singleton=null count1=0,count2=0</code></li>
<li>ç±»åˆå§‹åŒ–ï¼Œä¸ºç±»çš„é™æ€å˜é‡èµ‹å€¼å’Œæ‰§è¡Œé™æ€ä»£ç å—ã€‚singletonèµ‹å€¼ä¸º<code>new SingleTon()</code>ã€‚è°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•</li>
<li>è°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•å <code>count=1;count2=1</code></li>
<li>ç»§ç»­ä¸ºcount1ä¸count2èµ‹å€¼,æ­¤æ—¶count1æ²¡æœ‰èµ‹å€¼æ“ä½œ,æ‰€æœ‰count1ä¸º1,ä½†æ˜¯count2æ‰§è¡Œèµ‹å€¼æ“ä½œå°±å˜ä¸º0</li>
</ol>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><h3 id="åŠ è½½-1"><a href="#åŠ è½½-1" class="headerlink" title="åŠ è½½"></a>åŠ è½½</h3><p>åŠ è½½æ˜¯ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µä¼šåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„<code>java.lang.Class</code>å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„å…¥å£ã€‚æ³¨æ„è¿™é‡Œä¸ä¸€å®šéå¾—è¦ä»ä¸€ä¸ª Class æ–‡ä»¶è·å–ï¼Œè¿™é‡Œæ—¢å¯ä»¥ä» ZIP åŒ…ä¸­è¯»å–ï¼ˆæ¯”å¦‚ä» jar åŒ…å’Œ war åŒ…ä¸­è¯»å–ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼ˆåŠ¨æ€ä»£ç†ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”±å…¶å®ƒæ–‡ä»¶ç”Ÿæˆï¼ˆæ¯”å¦‚å°† JSP æ–‡ä»¶è½¬æ¢æˆå¯¹åº”çš„ Class ç±»ï¼‰ã€‚</p>
<h3 id="éªŒè¯-1"><a href="#éªŒè¯-1" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><p>è¿™ä¸€é˜¶æ®µçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿ Class æ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯æ˜¯å¦ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œå¹¶ä¸”ä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«çš„å®‰å…¨ã€‚</p>
<h3 id="å‡†å¤‡-1"><a href="#å‡†å¤‡-1" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h3><p>å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡çš„åˆå§‹å€¼é˜¶æ®µï¼Œå³åœ¨æ–¹æ³•åŒºä¸­åˆ†é…è¿™äº›å˜é‡æ‰€ä½¿ç”¨çš„å†…å­˜ç©ºé—´ã€‚æ³¨æ„è¿™é‡Œæ‰€è¯´çš„åˆå§‹å€¼æ¦‚å¿µï¼Œæ¯”å¦‚ä¸€ä¸ªç±»å˜é‡å®šä¹‰ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public static int v = 8080;</div></pre></td></tr></table></figure>
<p>å®é™…ä¸Šå˜é‡ v åœ¨å‡†å¤‡é˜¶æ®µè¿‡åçš„åˆå§‹å€¼ä¸º 0 è€Œä¸æ˜¯ 8080ï¼Œå°† v èµ‹å€¼ä¸º 8080 çš„<code>putstatic</code>æŒ‡ä»¤æ˜¯ç¨‹åºè¢«ç¼–è¯‘åï¼Œå­˜æ”¾äºç±»æ„é€ å™¨<code>&lt;client&gt;</code>æ–¹æ³•ä¹‹ä¸­ï¼Œè¿™é‡Œæˆ‘ä»¬åé¢ä¼šè§£é‡Šã€‚</p>
<p>ä½†æ˜¯æ³¨æ„å¦‚æœå£°æ˜ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public static final int v = 8080;</div></pre></td></tr></table></figure>
<p>åœ¨ç¼–è¯‘é˜¶æ®µä¼šä¸º v ç”Ÿæˆ<code>ConstantValue</code>å±æ€§ï¼Œåœ¨å‡†å¤‡é˜¶æ®µè™šæ‹Ÿæœºä¼šæ ¹æ® ConstantValue å±æ€§å°† v èµ‹å€¼ä¸º 8080ã€‚</p>
<h3 id="è§£æ-1"><a href="#è§£æ-1" class="headerlink" title="è§£æ"></a>è§£æ</h3><p>è§£æé˜¶æ®µæ˜¯æŒ‡è™šæ‹Ÿæœºå°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚ç¬¦å·å¼•ç”¨å°±æ˜¯ class æ–‡ä»¶ä¸­çš„ï¼š</p>
<ul>
<li>CONSTANT_Class_info</li>
<li>CONSTANT_Field_info</li>
<li>CONSTANT_Method_info</li>
</ul>
<p>ç­‰ç±»å‹çš„å¸¸é‡ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬è§£é‡Šä¸€ä¸‹ç¬¦å·å¼•ç”¨å’Œç›´æ¥å¼•ç”¨çš„æ¦‚å¿µï¼š</p>
<ul>
<li>ç¬¦å·å¼•ç”¨ä¸è™šæ‹Ÿæœºå®ç°çš„å¸ƒå±€æ— å…³ï¼Œå¼•ç”¨çš„ç›®æ ‡å¹¶ä¸ä¸€å®šè¦å·²ç»åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å„ç§è™šæ‹Ÿæœºå®ç°çš„å†…å­˜å¸ƒå±€å¯ä»¥å„ä¸ç›¸åŒï¼Œä½†æ˜¯å®ƒä»¬èƒ½æ¥å—çš„ç¬¦å·å¼•ç”¨å¿…é¡»æ˜¯ä¸€è‡´çš„ï¼Œå› ä¸ºç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨ Java è™šæ‹Ÿæœºè§„èŒƒçš„ Class æ–‡ä»¶æ ¼å¼ä¸­ã€‚</li>
<li>ç›´æ¥å¼•ç”¨å¯ä»¥æ˜¯æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆï¼Œç›¸å¯¹åç§»é‡æˆ–æ˜¯ä¸€ä¸ªèƒ½é—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚å¦‚æœæœ‰äº†ç›´æ¥å¼•ç”¨ï¼Œé‚£å¼•ç”¨çš„ç›®æ ‡å¿…å®šå·²ç»åœ¨å†…å­˜ä¸­å­˜åœ¨ã€‚</li>
</ul>
<h3 id="åˆå§‹åŒ–-1"><a href="#åˆå§‹åŒ–-1" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>åˆå§‹åŒ–é˜¶æ®µæ˜¯ç±»åŠ è½½æœ€åä¸€ä¸ªé˜¶æ®µï¼Œå‰é¢çš„ç±»åŠ è½½é˜¶æ®µä¹‹åï¼Œé™¤äº†åœ¨åŠ è½½é˜¶æ®µå¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä»¥å¤–ï¼Œå…¶å®ƒæ“ä½œéƒ½ç”± JVM ä¸»å¯¼ã€‚åˆ°äº†åˆå§‹é˜¶æ®µï¼Œæ‰å¼€å§‹çœŸæ­£æ‰§è¡Œç±»ä¸­å®šä¹‰çš„ Java ç¨‹åºä»£ç ã€‚</p>
<p>åˆå§‹åŒ–é˜¶æ®µæ˜¯æ‰§è¡Œç±»æ„é€ å™¨<code>&lt;clint&gt;</code>æ–¹æ³•çš„è¿‡ç¨‹ã€‚<code>&lt;clint&gt;</code>æ–¹æ³•æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„ç±»å˜é‡çš„èµ‹å€¼æ“ä½œå’Œé™æ€è¯­å¥å—ä¸­çš„è¯­å¥åˆå¹¶è€Œæˆçš„ã€‚è™šæ‹Ÿæœºä¼šä¿è¯<code>&lt;clint&gt;</code>æ–¹æ³•æ‰§è¡Œä¹‹å‰ï¼Œçˆ¶ç±»çš„<code>&lt;clint&gt;</code>æ–¹æ³•å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚p.s: å¦‚æœä¸€ä¸ªç±»ä¸­æ²¡æœ‰å¯¹é™æ€å˜é‡èµ‹å€¼ä¹Ÿæ²¡æœ‰é™æ€è¯­å¥å—ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å¯ä»¥ä¸ä¸ºè¿™ä¸ªç±»ç”Ÿæˆ<code>&lt;clint&gt;()</code>æ–¹æ³•ã€‚</p>
<p><strong>æ³¨æ„ä»¥ä¸‹å‡ ç§æƒ…å†µä¸ä¼šæ‰§è¡Œç±»åˆå§‹åŒ–ï¼š</strong></p>
<ul>
<li>é€šè¿‡å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–ï¼Œè€Œä¸ä¼šè§¦å‘å­ç±»çš„åˆå§‹åŒ–ã€‚</li>
<li><strong>å®šä¹‰å¯¹è±¡æ•°ç»„</strong>ï¼Œä¸ä¼šè§¦å‘è¯¥ç±»çš„åˆå§‹åŒ–ã€‚<ul>
<li><code>Xxx[] ary = new Xxx[];</code></li>
</ul>
</li>
<li>å¸¸é‡åœ¨ç¼–è¯‘æœŸé—´ä¼šå­˜å…¥è°ƒç”¨ç±»çš„å¸¸é‡æ± ä¸­ï¼Œæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ç›´æ¥å¼•ç”¨å®šä¹‰å¸¸é‡çš„ç±»ï¼Œä¸ä¼šè§¦å‘å®šä¹‰å¸¸é‡æ‰€åœ¨çš„ç±»ã€‚</li>
<li>é€šè¿‡ç±»åè·å– Class å¯¹è±¡ï¼Œä¸ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–ã€‚</li>
<li>é€šè¿‡ Class.forName åŠ è½½æŒ‡å®šç±»æ—¶ï¼Œå¦‚æœæŒ‡å®šå‚æ•° initialize ä¸º false æ—¶ï¼Œä¹Ÿä¸ä¼šè§¦å‘ç±»åˆå§‹åŒ–ï¼Œå…¶å®è¿™ä¸ªå‚æ•°æ˜¯å‘Šè¯‰è™šæ‹Ÿæœºï¼Œæ˜¯å¦è¦å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ã€‚</li>
<li>é€šè¿‡ ClassLoader é»˜è®¤çš„ loadClass æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šè§¦å‘åˆå§‹åŒ–åŠ¨ä½œã€‚</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li>ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹</li>
<li><a href="https://www.ziwenxie.site/2017/06/07/java-jvm-classloader/" target="_blank" rel="noopener">JVM ç±»åŠ è½½æœºåˆ¶è¯¦è§£</a></li>
</ul>
<p>æœ¬æ–‡å†…å®¹ä¸»è¦å‚è€ƒè‡ªã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ï¼Œå½“ç„¶ä¹Ÿæœ‰ä¸€äº›ä¸ªäººç†è§£ï¼Œè‹¥æœ‰ä¸æ­£ç¡®çš„ç»“è®ºã€è¯´æ³•ï¼Œè¯·å¤§å®¶æŒ‡å‡ºï¼Œå…±åŒæ¢è®¨ï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢!</p>
]]></content>
      
        <categories>
            
            <category> jvm </category>
            
        </categories>
        
        
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java é›†åˆæ¡†æ¶ä¹‹ LinkedHashMap å·¥ä½œåŸç†]]></title>
      <url>https://timlin-pro.github.io/blog/2017/09/17/Java-%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6%E4%B9%8B-LinkedHashMap-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€ä¸åŒç±»å‹-Map-çš„é€‚ç”¨åœºæ™¯"><a href="#ä¸€ã€ä¸åŒç±»å‹-Map-çš„é€‚ç”¨åœºæ™¯" class="headerlink" title="ä¸€ã€ä¸åŒç±»å‹ Map çš„é€‚ç”¨åœºæ™¯"></a>ä¸€ã€ä¸åŒç±»å‹ Map çš„é€‚ç”¨åœºæ™¯</h2><ul>
<li>å¦‚æœä¸å…³å¿ƒ Map ä¸­çš„ key é¡ºåºï¼Œåªæ˜¯å¸Œæœ›èƒ½å¤Ÿä»¥ O(1) çš„æ—¶é—´å¤æ‚åº¦æ‰§è¡Œæ’å…¥å’ŒæŸ¥æ‰¾æ“ä½œã€‚é‚£ä¹ˆå¯ä»¥é€‰æ‹©<code>HashMap</code>ï¼›</li>
<li><p>å¦‚æœè¦æ±‚ <strong>key æœ‰åº</strong>ï¼Œåˆ™é€‰æ‹©<code>TreeMap</code>ã€‚ </p>
<ul>
<li>ä½†æ˜¯é€‰æ‹© TreeMap å°±ä¼šæœ‰<strong>æ€§èƒ½é—®é¢˜</strong>ï¼Œå› ä¸º TreeMap çš„ get æ“ä½œçš„æ—¶é—´å¤æ‚åº¦æ˜¯<code>O(log(n))</code>çš„ï¼Œç›¸æ¯”äº HashMap çš„<code>O(1)</code>è¿˜æ˜¯å·®ä¸å°‘çš„ï¼Œ</li>
</ul>
</li>
<li><code>LinkedHashMap</code>çš„å‡ºç°å°±æ˜¯ä¸ºäº†å¹³è¡¡è¿™äº›å› ç´ ï¼Œä½¿å¾— èƒ½å¤Ÿä»¥<strong>O(1)æ—¶é—´å¤æ‚åº¦å¢åŠ æŸ¥æ‰¾å…ƒç´ ï¼Œåˆèƒ½å¤Ÿä¿è¯ key çš„æœ‰åºæ€§</strong> æ­¤å¤–ï¼ŒLinkedHashMap æä¾›äº†ä¸¤ç§ key çš„é¡ºåºï¼š<ol>
<li>æŒ‰ç…§è®¿é—®é¡ºåºæ’åºï¼ˆaccess orderï¼‰ã€‚å¯ä»¥ä½¿ç”¨è¿™ç§é¡ºåº<strong>å®ç°<code>LRUï¼ˆLeast Recently Usedï¼‰</code>ç¼“å­˜</strong></li>
</ol>
<ul>
<li>å› ä¸ºæ¯æ¬¡è®¿é—®åçš„å…ƒç´ ä¼šè¢«ç§»åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œå®ç° LRU åªéœ€è¦ç§»é™¤ é“¾é¦–å…ƒç´  å³å¯<ul>
<li>ã€Œä¸€æ¬¡è®¿é—®ã€çš„å®šä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ<ul>
<li>putï¼ŒputIfAbsentï¼Œgetï¼ŒgetOrDefaultï¼Œcomputeï¼ŒcomputeIfAbsentï¼ŒcomputeIfPresent æˆ– merge æ–¹æ³•ä¼šå¯¼è‡´è®¿é—®ç›¸åº”çš„æ¡ç›®ï¼ˆå‡è®¾å®ƒåœ¨è°ƒç”¨å®Œæˆåå­˜åœ¨ï¼‰ã€‚å¦‚æœå€¼è¢«æ›¿æ¢ï¼Œæ›¿æ¢æ–¹æ³•åªä¼šå¯¼è‡´æ¡ç›®çš„è®¿é—®</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol>
<li>æŒ‰ç…§æ’å…¥é¡ºåºæ’åºï¼ˆinsertion ordeï¼‰ã€‚æ³¨ï¼šåŒä¸€ key çš„å¤šæ¬¡æ’å…¥ï¼Œå¹¶ä¸ä¼šå½±å“å…¶é¡ºåºã€‚<br>æ³¨ï¼šWeakHashMap ä¹Ÿå¯ä»¥ç”¨äºå®ç°ç¼“å­˜ï¼ŒäºŒè€…çš„ä½¿ç”¨åœºæ™¯ä¸åŒã€‚WeakHashMap æ— æ³•åƒ LinkedHashMap é‚£æ ·è‡ªå®šä¹‰æ·˜æ±°è§„åˆ™ï¼Œå®ƒçš„å…ƒç´ ä¼šåœ¨ gc çš„å‘ç”Ÿçš„æ—¶å€™è¢«æ¸…é™¤ã€‚</li>
</ol>
</li>
</ul>
<p>ç‰¹åˆ«åœ°ï¼Œå¯¹ collection-view çš„æ“ä½œä¸ä¼šå½±å“åå°æ˜ å°„çš„è¿­ä»£é¡ºåºã€‚</p>
<ul>
<li>collection-view æ˜¯å¦ç±»ä¼¼äºæ•°æ®åº“çš„è§†å›¾ï¼Ÿ</li>
</ul>
<h2 id="äºŒã€æ€§èƒ½"><a href="#äºŒã€æ€§èƒ½" class="headerlink" title="äºŒã€æ€§èƒ½"></a>äºŒã€æ€§èƒ½</h2><p>LinkedHashMap æä¾›äº†æ‰€æœ‰å¯é€‰çš„ Map æ“ä½œï¼Œå¹¶å…è®¸ä½¿ç”¨ null å…ƒç´ ã€‚ä¸ HashMap ä¸€æ ·ï¼Œå‡è®¾æ•£åˆ—å‡½æ•°èƒ½å¤Ÿæ­£ç¡®åœ°åœ¨æ¡¶ä¹‹é—´åˆ†æ•£å…ƒç´ ï¼Œå®ƒä¸ºåŸºæœ¬æ“ä½œï¼ˆæ·»åŠ ï¼ŒåŒ…å«å’Œåˆ é™¤ï¼‰æä¾›äº†æ’å®šçš„æ€§èƒ½ã€‚æ€§èƒ½å¯èƒ½ç•¥ä½äº HashMap çš„æ€§èƒ½ï¼Œè¿™æ˜¯å› ä¸º<strong>ç»´æŠ¤é“¾æ¥åˆ—è¡¨çš„æˆæœ¬å¢åŠ äº†</strong>ï¼Œä½†æœ‰ä¸€ä¸ª<strong>ä¾‹å¤–</strong>ï¼šå¯¹ LinkedHashMap çš„ collection-view çš„è¿­ä»£éœ€è¦æ—¶é—´<strong>ä¸ map çš„ size æˆæ¯”</strong>ï¼Œè€Œ<strong>ä¸å…³å…¶ capacity</strong>ã€‚è¿­ä»£ HashMap å¯èƒ½ä¼šæ›´åŠ æ˜‚è´µï¼Œéœ€è¦çš„æ—¶é—´<strong>ä¸å…¶ capacity æˆæ­£æ¯”</strong>ã€‚</p>
<p>LinkedHashMap æœ‰ä¸¤ä¸ªå½±å“å…¶æ€§èƒ½çš„å‚æ•°ï¼šåˆå§‹å®¹é‡å’Œè´Ÿè½½å› å­ã€‚å®ƒä»¬çš„å®šä¹‰ä¸ HashMap å®Œå…¨ç›¸åŒã€‚ä½†è¯·æ³¨æ„ï¼Œå¯¹äºæ­¤ç±»ï¼Œåˆå§‹å®¹é‡é€‰æ‹©è¿‡é«˜å€¼å¯¹æ€§èƒ½çš„å½±å“ä¸ä¼šåƒ HashMap é‚£ä¹ˆä¸¥é‡ï¼Œå› ä¸ºæ­¤ç±»çš„è¿­ä»£æ—¶é—´ä¸å—å®¹é‡å½±å“ï¼Œè¿­ä»£åªå—åˆ° size çš„å½±å“ã€‚</p>
<h2 id="ä¸‰ã€å¹¶å‘é—®é¢˜ï¼ˆfail-fastï¼‰"><a href="#ä¸‰ã€å¹¶å‘é—®é¢˜ï¼ˆfail-fastï¼‰" class="headerlink" title="ä¸‰ã€å¹¶å‘é—®é¢˜ï¼ˆfail-fastï¼‰"></a>ä¸‰ã€å¹¶å‘é—®é¢˜ï¼ˆfail-fastï¼‰</h2><p>å¹¶å‘æ–¹å¼ï¼šæ¨èä½¿ç”¨ <code>Map m = Collections.synchronizedMap(new LinkedHashMap(...));</code>è¿›è¡ŒåŒ…è£…ã€‚å†…éƒ¨æ˜¯ä½¿ç”¨ä¸€ä¸ªå†…ç½®é”ï¼Œå„ä¸ªæ–¹æ³•çš„å®ç°åªæ˜¯åŠ é”ç„¶å è°ƒç”¨åŸæ¥çš„ç±»ã€‚è¿™æœ€å¥½åœ¨åˆ›å»ºæ—¶å°±å®Œæˆã€ŒåŒ…è£…æ“ä½œã€ï¼Œä»¥é˜²æ­¢æ„å¤–çš„ä¸åŒæ­¥è®¿é—® Mapã€‚</p>
<p>ç»“æ„æ€§ä¿®æ”¹ï¼ˆA structural modification ï¼‰ æ˜¯æŒ‡</p>
<ul>
<li><strong>æ·»åŠ æˆ–åˆ é™¤</strong>ä¸€ä¸ªæˆ–å¤šä¸ªæ˜ å°„çš„æ“ä½œï¼Œ</li>
<li>åœ¨è®¿é—®æœ‰åºçš„ LinkedHashMap çš„æƒ…å†µä¸‹ä¼šå½±å“è¿­ä»£é¡ºåºã€‚</li>
<li>åœ¨æ’å…¥æœ‰åºçš„ LinkedHashMap ä¸­ï¼Œä»…æ›´æ”¹ä¸å·²åŒ…å«åœ¨æ˜ å°„ä¸­çš„é”®ç›¸å…³çš„å€¼ä¸æ˜¯ç»“æ„ä¿®æ”¹ã€‚</li>
<li><strong>åœ¨ access-ordered æ¨¡å¼ä¸‹çš„ LinkedHashMap ä¸­ï¼Œä»…é€šè¿‡ get æŸ¥è¯¢ map å°±æ˜¯ä¸€ç§ç»“æ„ä¿®æ”¹</strong>ã€‚ </li>
</ul>
<p>è¿­ä»£éå†è¿‡ç¨‹ä¸­å¦‚æœå‘ç°ç»“æ„æ€§ä¿®æ”¹é—®é¢˜ï¼ˆä½¿ç”¨ iterater#remove æ–¹æ³•äº§ç”Ÿçš„ç»“æ„æ€§ä¿®æ”¹é—®é¢˜é™¤å¤– ï¼‰ï¼Œé©¬ä¸ŠæŠ›å‡º ConcurrentModificationExceptionï¼Œä»¥å…é€ æˆæ›´å¤§çš„æŸå¤±ã€‚</p>
<p>ã€Œå¿«é€Ÿå¤±è´¥ã€å…·ä½“å®ç°æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿæ¯è¶Ÿéå†å®Œæˆä¹‹åéƒ½ä¼šè°ƒç”¨ checkForComodification æ–¹æ³•è¿›è¡Œæ£€æŸ¥</p>
<p>java.util.ArrayList.Itr#checkForComodification</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkForComodification</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (modCount != expectedModCount)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å››ã€å®ç°"><a href="#å››ã€å®ç°" class="headerlink" title="å››ã€å®ç°"></a>å››ã€å®ç°</h2><h3 id="èŠ‚ç‚¹æ•°æ®ç»“æ„"><a href="#èŠ‚ç‚¹æ•°æ®ç»“æ„" class="headerlink" title="èŠ‚ç‚¹æ•°æ®ç»“æ„"></a>èŠ‚ç‚¹æ•°æ®ç»“æ„</h3><p>ä¸»è¦åŸºäº HashMap çš„èŠ‚ç‚¹æ•°æ®ç»“æ„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMap</span>.<span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">//æ¯ä¸ªèŠ‚ç‚¹åŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å‰ç»§èŠ‚ç‚¹ä¸åç»§èŠ‚ç‚¹</span></div><div class="line">    Entry&lt;K,V&gt; before, after;</div><div class="line">    Entry(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</div><div class="line">        <span class="keyword">super</span>(hash, key, value, next);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŒå‘é“¾è¡¨å®ç°çš„ LinkedHshMapï¼Œæ‰€ä»¥æ¯ä¸ªèŠ‚ç‚¹é¡»åœ¨ HashMap çš„åŸºç¡€ä¸Šæ·»åŠ æŒ‡å‘å‰ç»§èŠ‚ç‚¹ä¸åç»§èŠ‚ç‚¹æŒ‡é’ˆï¼šbeforeï¼Œafterã€‚</p>
<h3 id="æ ¸å¿ƒæ–¹æ³•"><a href="#æ ¸å¿ƒæ–¹æ³•" class="headerlink" title="æ ¸å¿ƒæ–¹æ³•"></a>æ ¸å¿ƒæ–¹æ³•</h3><p>HashMap ä¸­å®šä¹‰äº†ä¸‰ä¸ªå›è°ƒæ–¹æ³•ä¾› LinkedHashMap é‡å†™ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Callbacks to allow LinkedHashMap post-actions</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; p)</span> </span>&#123; &#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeInsertion</span><span class="params">(<span class="keyword">boolean</span> evict)</span> </span>&#123; &#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeRemoval</span><span class="params">(Node&lt;K,V&gt; p)</span> </span>&#123; &#125;</div></pre></td></tr></table></figure>
<p>LinkedHashMap ç»§æ‰¿äº HashMapï¼Œé‡æ–°å®ç°äº†è¿™ 3 ä¸ªå‡½æ•°ï¼Œé¡¾åæ€ä¹‰è¿™ä¸‰ä¸ªå‡½æ•°çš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼š<strong>èŠ‚ç‚¹è®¿é—®åã€èŠ‚ç‚¹æ’å…¥åã€èŠ‚ç‚¹ç§»é™¤ååšä¸€äº›äº‹æƒ…</strong>ã€‚</p>
<h4 id="1-afterNodeRemoval"><a href="#1-afterNodeRemoval" class="headerlink" title="1.afterNodeRemoval"></a>1.afterNodeRemoval</h4><p>åŒå‘é“¾è¡¨åˆ é™¤èŠ‚ç‚¹å¯ä»¥å‚è€ƒè¿™æ ·æ€è·¯ã€‚</p>
<p>å‡è®¾ before â€”&gt;   p â€”&gt; after</p>
<p>è¦åˆ é™¤ p</p>
<h5 id="1-å…ˆå¤„ç†-after-æ–¹å‘"><a href="#1-å…ˆå¤„ç†-after-æ–¹å‘" class="headerlink" title="1.å…ˆå¤„ç† after æ–¹å‘"></a>1.å…ˆå¤„ç† after æ–¹å‘</h5><p>if  p ä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹ before == null  head = after</p>
<p>else before.after = after</p>
<h5 id="2-å†å¤„ç†-before-æ–¹å‘"><a href="#2-å†å¤„ç†-before-æ–¹å‘" class="headerlink" title="2.å†å¤„ç† before æ–¹å‘"></a>2.å†å¤„ç† before æ–¹å‘</h5><p>if p ä¸ºæœ€åä¸€ä¸ªèŠ‚ç‚¹  <code>after == null</code>   <code>tail = before</code><br>else  after.before = before;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeRemoval</span><span class="params">(Node&lt;K,V&gt; e)</span> </span>&#123; <span class="comment">// unlink</span></div><div class="line">    LinkedHashMap.Entry&lt;K,V&gt; p =</div><div class="line">        (LinkedHashMap.Entry&lt;K,V&gt;)e, b = p.before, a = p.after;</div><div class="line">    p.before = p.after = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (b == <span class="keyword">null</span>)</div><div class="line">        head = a;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        b.after = a;</div><div class="line">    <span class="keyword">if</span> (a == <span class="keyword">null</span>)</div><div class="line">        tail = b;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        a.before = b;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-afterNodeInsertion"><a href="#2-afterNodeInsertion" class="headerlink" title="2.afterNodeInsertion"></a>2.afterNodeInsertion</h4><p> evict å‚æ•°æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<ul>
<li>if false, the table is in creation mode.<ul>
<li>Creation mode æ˜¯ä»€ä¹ˆï¼Ÿåˆšåˆšåˆ›å»ºæ—¶çš„æ¨¡å¼ï¼Ÿ</li>
</ul>
</li>
</ul>
<p>HashMap#çš„ put æ–¹æ³•ï¼Œè°ƒç”¨ putVal æ–¹æ³•æ—¶ï¼Œä¼ å…¥çš„ evit ä¸º trueã€‚ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨å¤„ä¼ é€’ evict å…¨éƒ¨ä¸º trueã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeInsertion</span><span class="params">(<span class="keyword">boolean</span> evict)</span> </span>&#123; <span class="comment">// possibly remove eldest</span></div><div class="line">    LinkedHashMap.Entry&lt;K,V&gt; first;</div><div class="line">    <span class="keyword">if</span> (evict &amp;&amp; (first = head) != <span class="keyword">null</span> &amp;&amp; removeEldestEntry(first)) &#123;</div><div class="line">        K key = first.key;</div><div class="line">        removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-afterNodeAccess"><a href="#3-afterNodeAccess" class="headerlink" title="3.afterNodeAccess"></a>3.afterNodeAccess</h4><p>ä¸æ¨¡å¼ç›¸å…³ <code>final boolean accessOrder</code></p>
<p>åªèƒ½åœ¨æ„é€ å‡½æ•°ä¸­æŒ‡å®šï¼Œé»˜è®¤ä¸º falseï¼Œ</p>
<ul>
<li>true è¡¨ç¤ºæŒ‰è®¿é—®é¡ºåºæ’åº</li>
<li>false è¡¨ç¤ºæŒ‰æ’å…¥é¡ºåºæ’åº</li>
</ul>
<p>æŠŠèŠ‚ç‚¹ç§»åˆ°é“¾è¡¨æœ«å°¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; e)</span> </span>&#123; <span class="comment">// move node to last</span></div><div class="line">    LinkedHashMap.Entry&lt;K,V&gt; last;</div><div class="line">    <span class="keyword">if</span> (accessOrder &amp;&amp; (last = tail) != e) &#123;<span class="comment">//å¦‚æœæ˜¯æŒ‰ç…§è®¿é—®é¡ºåºï¼Œå¹¶ä¸” ä¸æ˜¯æœ€åä¸€ä¸ªå…ƒç´ </span></div><div class="line">        LinkedHashMap.Entry&lt;K,V&gt; p =</div><div class="line">            (LinkedHashMap.Entry&lt;K,V&gt;)e, b = p.before, a = p.after;</div><div class="line">        p.after = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (b == <span class="keyword">null</span>)</div><div class="line">            head = a;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            b.after = a;</div><div class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>)</div><div class="line">            a.before = b;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            last = b;</div><div class="line">        <span class="keyword">if</span> (last == <span class="keyword">null</span>)</div><div class="line">            head = p;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            p.before = last;</div><div class="line">            last.after = p;</div><div class="line">        &#125;</div><div class="line">        tail = p;</div><div class="line">        ++modCount;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-put"><a href="#4-put" class="headerlink" title="4.put"></a>4.put</h3><p><strong>put</strong> <code>put</code>å‡½æ•°åœ¨<code>LinkedHashMap</code>ä¸­æœªé‡æ–°å®ç°ï¼Œåªæ˜¯å®ç°äº†<code>afterNodeAccess</code>å’Œ<code>afterNodeInsertion</code>ä¸¤ä¸ªå›è°ƒå‡½æ•°ã€‚</p>
<h3 id="5-get"><a href="#5-get" class="headerlink" title="5.get"></a>5.get</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    Node&lt;K,V&gt; e;</div><div class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (accessOrder)</div><div class="line">        afterNodeAccess(e);</div><div class="line">    <span class="keyword">return</span> e.value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>get</code>å‡½æ•°é‡æ–°å®ç°å¹¶åŠ å…¥äº†<code>afterNodeAccess</code>æ¥ä¿è¯è®¿é—®é¡ºåº</p>
<h2 id="äº”ã€å°ç»“"><a href="#äº”ã€å°ç»“" class="headerlink" title="äº”ã€å°ç»“"></a>äº”ã€å°ç»“</h2><ol>
<li>æ€æ ·ä¿è¯æ’å…¥é¡ºåºï¼Ÿ ä½¿ç”¨å‰é©±å’Œåç»§æŒ‡é’ˆï¼Œä½¿å¾—åŸæ¥çš„ HashMap æœ‰åºï¼Œåœ¨<code>LinkedHashMap</code>ä¸­è¦†ç›–<code>HashMap</code>ä¸­<code>newNode</code> æ–¹æ³•ï¼Œä½¿å¾—æ¯æ¬¡ put æ•°æ®æ—¶ï¼Œæ–°å»ºçš„èŠ‚ç‚¹éƒ½æ˜¯<code>LinkedHashMap.Entry&lt;K,v&gt;</code> ç±»å‹çš„ï¼Œæ¯”æ™®é€šçš„<code>HsahMap.Entry</code> å¤šä¸€ä¸ªå‰é©±ç»“ç‚¹å’Œä¸€ä¸ªåç»§èŠ‚ç‚¹ï¼Œä½¿ç”¨å‰é©±å’Œåç»§ä¿è¯æ’å…¥æœ‰åºã€‚</li>
<li>æ€ä¹ˆæ ·ä¿è¯è®¿é—®é¡ºåºï¼Ÿ è¦†ç›–çˆ¶ç±»<code>HashMap</code>çš„<code>afterNodeAccess</code> æ–¹æ³•ï¼Œä½¿å¾—æ¯æ¬¡è®¿é—®åï¼Œéƒ½æ”¹å˜é“¾è¡¨é¡ºåºã€‚ä½¿å¾—åŸé“¾è¡¨æŒ‰è®¿é—®æ’åºã€‚å°†æœ€æ–°ä¸€æ¬¡è®¿é—®çš„èŠ‚ç‚¹æ”¾åˆ°é“¾è¡¨çš„æœ€åã€‚</li>
</ol>
<h2 id="å…­ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å…­ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å…­ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å…­ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://my.oschina.net/hgfdoing/blog/634125" target="_blank" rel="noopener">é‡è¯† java-LinkedHashMap</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/api/java/util/LinkedHashMap.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> é›†åˆæ¡†æ¶ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> é›†åˆæ¡†æ¶ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java å†…å­˜æ¨¡å‹ä¸çº¿ç¨‹æµ…æ]]></title>
      <url>https://timlin-pro.github.io/blog/2017/09/14/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B5%85%E6%9E%90/</url>
      <content type="html"><![CDATA[<h2 id="ç¡¬ä»¶çš„æ•ˆç‡ä¸ä¸€è‡´æ€§"><a href="#ç¡¬ä»¶çš„æ•ˆç‡ä¸ä¸€è‡´æ€§" class="headerlink" title="ç¡¬ä»¶çš„æ•ˆç‡ä¸ä¸€è‡´æ€§"></a>ç¡¬ä»¶çš„æ•ˆç‡ä¸ä¸€è‡´æ€§</h2><p><strong>å¤šçº§ç¼“å­˜çš„ä½œç”¨</strong>ï¼šç”±äºè®¡ç®—æœºçš„å­˜å‚¨è®¾å¤‡ä¸å¤„ç†å™¨çš„è¿ç®—é€Ÿåº¦æœ‰å‡ ä¸ªæ•°é‡çº§çš„å·®è·ï¼Œæ‰€ä»¥ä¸ºäº†<strong>æé«˜å¤„ç†å™¨çš„åˆ©ç”¨ç‡</strong>ï¼Œç°ä»£è®¡ç®—æœºç³»ç»Ÿéƒ½ä¸å¾—ä¸åŠ å…¥ä¸€å±‚è¯»å†™é€Ÿåº¦å°½å¯èƒ½æ¥è¿‘å¤„ç†å™¨è¿ç®—é€Ÿåº¦çš„é«˜é€Ÿç¼“å­˜(Cache)æ¥ä½œä¸ºå†…å­˜ä¸å¤„ç†å™¨ä¹‹é—´çš„ç¼“å†²ï¼šå°†è¿ç®—éœ€è¦ä½¿ç”¨åˆ°çš„æ•°æ®å¤åˆ¶åˆ°ç¼“å­˜ä¸­ï¼Œè®©è¿ç®—èƒ½å¿«é€Ÿè¿›è¡Œï¼Œå½“è¿ç®—ç»“æŸåå†ä»ç¼“å­˜åŒæ­¥å›å†…å­˜ä¹‹ä¸­ï¼Œè¿™æ ·å¤„ç†å™¨å°±æ— é¡»ç­‰å¾…ç¼“æ…¢çš„å†…å­˜è¯»å†™äº†ã€‚</p>
<p>ç¼“å­˜è™½ç„¶è§£å†³äº†é€Ÿåº¦å·®ï¼Œä½†æ˜¯ä¹Ÿå¼•å…¥äº†æ–°é—®é¢˜â€”â€”<strong>ç¼“å­˜ä¸ä¸»å†…å­˜çš„æ•°æ®ä¸€è‡´æ€§</strong>(Cache Coherence)</p>
<a id="more"></a>
<p><img src="https://user-images.githubusercontent.com/16668676/28780154-57045378-7638-11e7-8145-c98bc2ab581b.png" alt="default"></p>
<p>æœ¬æ–‡ä¸­ã€Œ<strong>å†…å­˜æ¨¡å‹</strong>ã€ä¸€è¯ï¼Œå¯ä»¥ç†è§£ä¸º<strong>åœ¨ç‰¹å®šçš„æ“ä½œåè®®ä¸‹ï¼Œå¯¹ç‰¹å®šçš„å†…å­˜æˆ–é«˜é€Ÿç¼“å­˜è¿›è¡Œè¯»å†™è®¿é—®çš„è¿‡ç¨‹æŠ½è±¡</strong>ã€‚</p>
<p>é™¤äº†å¢åŠ é«˜é€Ÿç¼“å­˜ä¹‹å¤–ï¼Œä¸ºäº†ä½¿å¾—å¤„ç†å™¨å†…éƒ¨çš„è¿ç®—å•å…ƒèƒ½å°½é‡è¢«å……åˆ†åˆ©ç”¨ï¼Œå¤„ç†å™¨å¯èƒ½<strong>ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¹±åºæ‰§è¡Œ(Out-Of-Order Execution)ä¼˜åŒ–</strong>ï¼ˆå³ æŒ‡ä»¤é‡æ’åºï¼‰ï¼Œå¤„ç†å™¨ä¼šåœ¨è®¡ç®—ä¹‹åå°†ä¹±åºæ‰§è¡Œçš„ç»“æœé‡ç»„ï¼Œä¿è¯è¯¥ç»“æœä¸é¡ºåºæ‰§è¡Œçš„ç»“æœæ˜¯ä¸€è‡´ã€‚</p>
<p>Java è¯­è¨€è§„èŒƒè¦æ±‚ JVM åœ¨çº¿ç¨‹ä¸­ç»´æŠ¤ä¸€ç§ç±»ä¼¼ä¸²è¡Œçš„è¯­ä¹‰ï¼š<strong>åªè¦ç¨‹åºçš„æœ€ç»ˆç»“æœä¸åœ¨ä¸¥æ ¼ä¸²è¡Œç¯å¢ƒä¸­æ‰§è¡Œçš„ç»“æœç›¸åŒï¼Œé‚£ä¹ˆä¸Šè¿°æ“ä½œï¼ˆæŒ‡ä»¤é‡æ’åºã€å¢åŠ é«˜é€Ÿç¼“å­˜ï¼‰éƒ½æ˜¯å…è®¸çš„</strong>ã€‚</p>
<h2 id="Java-å†…å­˜æ¨¡å‹"><a href="#Java-å†…å­˜æ¨¡å‹" class="headerlink" title="Java å†…å­˜æ¨¡å‹"></a>Java å†…å­˜æ¨¡å‹</h2><h3 id="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜"><a href="#ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜" class="headerlink" title="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜"></a>ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜</h3><p>ä»¥ä¸‹æ‰€è°ˆçš„<strong>å˜é‡</strong>(Variables)ä¸ Java ç¼–ç¨‹ä¸­æ‰€è¯´çš„å˜é‡æœ‰æ‰€åŒºåˆ«ï¼Œå®ƒåŒ…æ‹¬äº†å®ä¾‹å­—æ®µã€é™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼Œä½†<strong>ä¸åŒ…æ‹¬å±€éƒ¨å˜é‡ä¸æ–¹æ³•å‚æ•°</strong>ï¼Œå› ä¸ºåè€…æ˜¯<em>çº¿ç¨‹ç§æœ‰çš„ï¼Œä¸ä¼šè¢«å…±äº«ï¼Œè‡ªç„¶å°±ä¸ä¼šå­˜åœ¨ç«äº‰é—®é¢˜</em>ã€‚</p>
<ul>
<li>~æ³¨~ï¼šå¦‚æœå±€éƒ¨å˜é‡æ˜¯ä¸€ä¸ª reference ç±»å‹ï¼Œå®ƒå¼•ç”¨çš„å¯¹è±¡åœ¨ Java å †ä¸­å¯è¢«å„ä¸ªçº¿ç¨‹å…±äº«ï¼Œä½†æ˜¯ reference æœ¬èº«åœ¨ Java æ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œå®ƒæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</li>
</ul>
<ul>
<li>Java å†…å­˜æ¨¡å‹è§„å®šäº†<strong>æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜</strong>(Main  Memory)ä¸­(æ­¤å¤„çš„ä¸»å†…å­˜ä¸ä»‹ç»ç‰©ç†ç¡¬ä»¶æ—¶çš„ä¸»å†…å­˜åå­—ä¸€æ ·ï¼Œä¸¤è€…ä¹Ÿå¯ä»¥äº’ç›¸ç±»æ¯”ï¼Œä½†æ­¤å¤„ä»…æ˜¯è™šæ‹Ÿæœºå†…å­˜çš„ä¸€éƒ¨åˆ†)ã€‚</li>
<li>æ¯æ¡çº¿ç¨‹è¿˜æœ‰è‡ªå·±çš„<strong>å·¥ä½œå†…å­˜</strong>(Working  Memoryï¼Œå¯ä¸å‰é¢è®²çš„å¤„ç†å™¨é«˜é€Ÿç¼“å­˜ç±»æ¯”)ï¼Œçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ä¿å­˜äº†è¢«è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å˜é‡çš„<strong>ä¸»å†…å­˜å‰¯æœ¬æ‹·è´</strong> [4]</li>
<li>çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰<strong>æ“ä½œ(è¯»å–ã€èµ‹å€¼ç­‰)éƒ½å¿…é¡»åœ¨==å·¥ä½œ==å†…å­˜ä¸­è¿›è¡Œ</strong>ï¼Œè€Œ<strong>ä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡</strong>ã€‚<ul>
<li>å¹²æ´»è¦åœ¨æ“ä½œçº¿ç¨‹ä¸­å¹²ã€‚</li>
<li>è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ã€å¯¹è±¡ä¸­æŸä¸ªåœ¨çº¿ç¨‹è®¿é—®åˆ°çš„å­—æ®µæ˜¯æœ‰å¯èƒ½å­˜åœ¨æ‹·è´çš„ï¼Œä½†ä¸ä¼šæœ‰è™šæ‹Ÿæœºå®ç°æˆæŠŠæ•´ä¸ªå¯¹è±¡æ‹·<br>è´ A ä¸€æ¬¡ã€‚</li>
</ul>
</li>
<li><strong>ä¸åŒçš„çº¿ç¨‹</strong>ä¹‹é—´ä¹Ÿæ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œ<strong>çº¿ç¨‹é—´å˜é‡å€¼çš„ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆ</strong>ã€‚</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/16668676/28780155-570d932a-7638-11e7-90cf-082ba9b59d00.png" alt="12.2 çº¿ç¨‹ã€ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜ä¸‰è€…çš„äº¤äº’å…³ç³»"></p>
<h3 id="å†…å­˜é—´äº¤äº’æ“ä½œ"><a href="#å†…å­˜é—´äº¤äº’æ“ä½œ" class="headerlink" title="å†…å­˜é—´äº¤äº’æ“ä½œ"></a>å†…å­˜é—´äº¤äº’æ“ä½œ</h3><p>Java å†…å­˜æ¨¡å‹ä¸­å®šä¹‰äº†ä»¥ä¸‹ <strong>8 ç§æ“ä½œ</strong>æ¥å®Œæˆï¼Œè™šæ‹Ÿæœºå®ç°æ—¶å¿…é¡»ä¿è¯<strong>ä¸‹é¢æåŠçš„æ¯ä¸€ç§æ“ä½œéƒ½æ˜¯åŸå­çš„ã€ä¸å¯å†åˆ†çš„</strong>(å¯¹äº double å’Œ long ç±»å‹çš„å˜é‡æ¥è¯´ï¼Œloadã€storeã€read å’Œ write æ“ä½œåœ¨æŸäº›å¹³å°ä¸Šå…è®¸æœ‰ä¾‹å¤–ã€‚</p>
<ul>
<li>lockã€unlock</li>
<li>read ä»ä¸»å­˜è¯»å–</li>
<li>load åŠ è½½</li>
<li>use ä½¿ç”¨</li>
<li>assign åˆ†é…</li>
<li>store å­˜å‚¨ </li>
<li>write å†™å›ä¸»å­˜</li>
<li>å¦‚æœè¦æŠŠä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜<strong>å¤åˆ¶åˆ°å·¥ä½œå†…å­˜</strong>ï¼Œé‚£å°±è¦é¡ºåºåœ°æ‰§è¡Œ <strong>read å’Œ load æ“ä½œ</strong>ï¼Œ</li>
<li>å¦‚æœè¦æŠŠå˜é‡ä»å·¥ä½œå†…å­˜<strong>åŒæ­¥å›ä¸»å†…å­˜</strong>ï¼Œå°±è¦é¡ºåºåœ°æ‰§è¡Œ <strong>store å’Œ write æ“ä½œ</strong>ã€‚</li>
<li>æ³¨æ„ï¼ŒJava å†…å­˜æ¨¡å‹åªè¦æ±‚ä¸Šè¿°ä¸¤ä¸ªæ“ä½œ<strong>å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œ</strong>ï¼Œè€Œ<strong>æ²¡æœ‰ä¿è¯æ˜¯==è¿ç»­==æ‰§è¡Œ</strong>ã€‚</li>
</ul>
<p>Java å†…å­˜æ¨¡å‹è¿˜è§„å®šäº†åœ¨æ‰§è¡Œä¸Šè¿° 8 ç§åŸºæœ¬æ“ä½œæ—¶å¿…é¡»æ»¡è¶³å¦‚ä¸‹è§„åˆ™ï¼š</p>
<ul>
<li>ä¸å…è®¸ read å’Œ loadã€store å’Œ write æ“ä½œä¹‹ä¸€<strong>å•ç‹¬å‡ºç°</strong>ï¼Œå³ä¸å…è®¸ä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜è¯»å–äº†ä½†å·¥ä½œå†…å­˜ä¸æ¥å—ï¼Œæˆ–è€…ä»å·¥ä½œå†…å­˜å‘èµ·å›å†™äº†ä½†ä¸»å†…å­˜ä¸æ¥å—çš„æƒ…å†µå‡ºç°ã€‚<ul>
<li>read å’Œ loadã€store å’Œ write ã€‚å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜ä¹‹é—´æœ‰æ±‚å¿…åº”ã€‚</li>
</ul>
</li>
<li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒå®ƒçš„æœ€è¿‘çš„ assign æ“ä½œï¼Œå³å˜é‡åœ¨å·¥ä½œå†…å­˜ä¸­æ”¹å˜äº†ä¹‹åå¿…é¡»æŠŠè¯¥å˜åŒ–åŒæ­¥å›ä¸»å†…å­˜ã€‚<ul>
<li>æ”¹äº†ä¸€å®šè¦è®©ä¸»å†…å­˜çŸ¥é“ã€‚</li>
</ul>
</li>
<li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°(æ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½• assign æ“ä½œ)æŠŠæ•°æ®ä»çº¿ç¨‹çš„å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚<ul>
<li>æ²¡æ”¹å°±åˆ«çæŠ˜è…¾ã€‚</li>
</ul>
</li>
<li>ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­ã€Œè¯ç”Ÿã€ï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–(load æˆ– assign)çš„å˜é‡ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®æ–½ useã€store æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œè¿‡äº† assign å’Œ load æ“ä½œã€‚<ul>
<li>â€‹</li>
</ul>
</li>
<li>ä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»<strong>åªå…è®¸ä¸€æ¡çº¿ç¨‹</strong>å¯¹å…¶è¿›è¡Œ lock æ“ä½œï¼Œä½† lock æ“ä½œå¯ä»¥è¢«åŒä¸€æ¡çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œ lock åï¼Œåªæœ‰æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„ unlock æ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ã€‚<ul>
<li>é”äº†å¤šå°‘æ¬¡ï¼Œå¼€å¤šå°‘æ¬¡ã€‚</li>
</ul>
</li>
<li>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ lock æ“ä½œï¼Œé‚£å°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ load æˆ– assign æ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼ã€‚</li>
<li>å¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢« lock æ“ä½œé”å®šï¼Œé‚£å°±ä¸å…è®¸å¯¹å®ƒæ‰§è¡Œ unlock æ“ä½œï¼Œä¹Ÿä¸å…è®¸å» unlock ä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šä½çš„å˜é‡ã€‚<ul>
<li>æ²¡æœ‰é”ä¸è¦ä¹±å¼€é”</li>
</ul>
</li>
<li>å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ unlock æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥å›ä¸»å†…å­˜ä¸­(æ‰§è¡Œ storeã€write æ“ä½œ)ã€‚<ul>
<li>åšå¥½æ‰‹å°¾ï¼Œå†å¼€é”ã€‚</li>
</ul>
</li>
</ul>
<p>è¿™ 8 ç§å†…å­˜è®¿é—®æ“ä½œä»¥åŠä¸Šè¿°è§„åˆ™é™å®šï¼Œå†åŠ ä¸Šç¨åä»‹ç»çš„å¯¹ volatile çš„ä¸€äº›ç‰¹æ®Šè§„å®šï¼Œå°±å·²ç»å®Œå…¨ç¡®å®šäº† Java ç¨‹åºä¸­å“ªäº›å†…å­˜è®¿é—®æ“ä½œåœ¨å¹¶å‘ä¸‹æ˜¯å®‰å…¨çš„ã€‚</p>
<h3 id="å¯¹äº-volatile-å‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™"><a href="#å¯¹äº-volatile-å‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™" class="headerlink" title="å¯¹äº volatile å‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™"></a>å¯¹äº volatile å‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™</h3><p>å½“ä¸€ä¸ªå˜é‡å®šä¹‰ä¸º volatile ä¹‹åï¼Œå®ƒå°†å…·å¤‡ä¸¤ç§ç‰¹æ€§ï¼Œ</p>
<ul>
<li>ç¬¬ä¸€æ˜¯ä¿è¯æ­¤å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹çš„<strong><em>å¯è§æ€§</em></strong>ï¼Œè¿™é‡Œçš„ã€Œå¯è§æ€§ã€æ˜¯æŒ‡å½“<strong>ä¸€æ¡çº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼</strong>ï¼Œæ–°å€¼<strong>å¯¹äºå…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯å¯ä»¥ç«‹å³å¾—çŸ¥</strong>çš„ã€‚<ul>
<li>è€Œæ™®é€šå˜é‡ä¸èƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼Œæ™®é€šå˜é‡çš„å€¼åœ¨çº¿ç¨‹é—´ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆï¼Œä¾‹å¦‚ï¼Œçº¿ç¨‹ A ä¿®æ”¹ä¸€ä¸ªæ™®é€šå˜é‡çš„å€¼ï¼Œç„¶åå‘ä¸»å†…å­˜è¿›è¡Œå›å†™ï¼Œå¦å¤–ä¸€æ¡çº¿ç¨‹ B åœ¨çº¿ç¨‹ A å›å†™å®Œæˆäº†ä¹‹åå†ä»ä¸»å†…å­˜è¿›è¡Œè¯»å–æ“ä½œï¼Œæ–°å˜é‡å€¼æ‰ä¼šå¯¹çº¿ç¨‹ B å¯è§ã€‚</li>
</ul>
</li>
<li>ç¬¬äºŒä¸ªè¯­ä¹‰æ˜¯<strong><em>ç¦æ­¢æŒ‡ä»¤é‡æ’åº</em></strong>ã€‚</li>
</ul>
<p>å¯è§æ€§ != çº¿ç¨‹å®‰å…¨</p>
<p>volatile å˜é‡åœ¨å„ä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ä¸å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜(åœ¨å„ä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œvolatile å˜é‡ä¹Ÿå¯ä»¥å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†ç”±äº<strong>æ¯æ¬¡ä½¿ç”¨ä¹‹å‰éƒ½è¦å…ˆåˆ·æ–°</strong>ï¼Œæ‰§è¡Œå¼•æ“çœ‹ä¸åˆ°ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå› æ­¤å¯ä»¥è®¤ä¸ºä¸å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜)ï¼Œä½†æ˜¯ <strong>Java é‡Œé¢çš„==è¿ç®—å¹¶éåŸå­æ“ä½œ==</strong>ï¼Œå¯¼è‡´ volatile å˜é‡çš„è¿ç®—åœ¨å¹¶å‘ä¸‹ä¸€æ ·æ˜¯ä¸å®‰å…¨çš„ï¼Œ</p>
<ul>
<li>éåŸå­æ“ä½œä¼šå¯¼è‡´è¯»å–æ•°æ®åï¼Œå¤šä¸ªçº¿ç¨‹<strong>å¹¶è¡Œæ‰€è¿›è¡Œæ“ä½œçš„éƒ½æ˜¯æ—§å€¼</strong>ã€‚é‚£ä¹ˆåŠ è½½åˆ°ä¸»å†…å­˜çš„å€¼ä¹Ÿå°±ä¸æ˜¯æœ€æ–°çš„äº†ã€‚<ul>
<li>éåŸå­æ“ä½œ æ‰§è¡Œè¿‡ç¨‹ä¸­æ˜¯å¯ä»¥æš‚åœçš„ï¼Œæš‚åœçš„é‚£ä¸€æ®µæ—¶é—´é‡Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ã€‚</li>
</ul>
</li>
</ul>
<p>ç”±äº volatile å˜é‡åªèƒ½ä¿è¯å¯è§æ€§ï¼Œåœ¨<strong>ä¸ç¬¦åˆ</strong>ä»¥ä¸‹<strong>ä¸¤æ¡è§„åˆ™</strong>çš„è¿ç®—åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬<strong>ä»ç„¶è¦é€šè¿‡åŠ é”</strong>(ä½¿ç”¨ synchronized æˆ– java.util.concurrent ä¸­çš„åŸå­ç±»)æ¥ä¿è¯åŸå­æ€§ã€‚</p>
<ul>
<li><strong>è¿ç®—ç»“æœå¹¶ä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼</strong>ï¼Œæˆ–è€…èƒ½å¤Ÿ<strong>ç¡®ä¿åªæœ‰å•ä¸€çš„çº¿ç¨‹ä¿®æ”¹å˜é‡çš„å€¼</strong>ã€‚</li>
<li>å˜é‡<strong>ä¸éœ€è¦ä¸å…¶ä»–çš„çŠ¶æ€å˜é‡å…±åŒå‚ä¸ä¸å˜çº¦æŸ</strong></li>
</ul>
<h4 id="volatile-æ€§èƒ½"><a href="#volatile-æ€§èƒ½" class="headerlink" title="volatile æ€§èƒ½"></a>volatile æ€§èƒ½</h4><p>æŸäº›æƒ…å†µä¸‹ï¼Œvolatile çš„åŒæ­¥æœºåˆ¶çš„æ€§èƒ½ç¡®å®è¦ä¼˜äºé”(ä½¿ç”¨ synchronized å…³é”®å­—æˆ– java.util.concurrent åŒ…é‡Œé¢çš„é”)ï¼Œä½†æ˜¯ç”±äºè™šæ‹Ÿæœºå¯¹é”å®è¡Œçš„è®¸å¤šæ¶ˆé™¤å’Œä¼˜åŒ–ï¼Œä½¿å¾—æˆ‘ä»¬å¾ˆéš¾é‡åŒ–åœ°è®¤ä¸º volatile å°±ä¼šæ¯” synchronized å¿«å¤šå°‘ã€‚</p>
<ul>
<li>volatile å˜é‡<strong>è¯»æ“ä½œçš„æ€§èƒ½æ¶ˆè€—ä¸æ™®é€šå˜é‡å‡ ä¹æ²¡æœ‰ä»€ä¹ˆå·®åˆ«</strong>ï¼Œä½†æ˜¯<strong>å†™æ“ä½œåˆ™å¯èƒ½ä¼šæ…¢ä¸€äº›</strong>ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨æœ¬åœ°ä»£ç ä¸­æ’å…¥è®¸<br>å¤šå†…å­˜å±éšœæŒ‡ä»¤æ¥ä¿è¯å¤„ç†å™¨ä¸å‘ç”Ÿä¹±åºæ‰§è¡Œã€‚</li>
</ul>
<p>å¤§å¤šæ•°åœºæ™¯ä¸‹ volatile çš„æ€»å¼€é”€ä»ç„¶è¦æ¯”é”ä½ï¼Œæˆ‘ä»¬åœ¨ volatile ä¸é”ä¹‹ä¸­<strong>é€‰æ‹©çš„å”¯ä¸€ä¾æ®ä»…ä»…æ˜¯ volatile çš„è¯­ä¹‰èƒ½å¦æ»¡è¶³ä½¿ç”¨åœºæ™¯çš„éœ€æ±‚</strong>ã€‚</p>
<h3 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h3><p><strong>å†…å­˜å±éšœ</strong>ï¼ˆMemory Barrierï¼Œæˆ–æœ‰æ—¶å«åš<strong>å†…å­˜æ …æ </strong>ï¼ŒMemory Fenceï¼‰æ˜¯ä¸€ç§ CPU æŒ‡ä»¤ï¼Œç”¨äºæ§åˆ¶ç‰¹å®šæ¡ä»¶ä¸‹çš„é‡æ’åºå’Œå†…å­˜å¯è§æ€§é—®é¢˜ã€‚Java ç¼–è¯‘å™¨ä¹Ÿä¼šæ ¹æ®å†…å­˜å±éšœçš„è§„åˆ™ç¦æ­¢é‡æ’åºã€‚<br>å†…å­˜å±éšœå¯ä»¥è¢«åˆ†ä¸ºä»¥ä¸‹ 4 ç§ç±»å‹</p>
<ul>
<li><strong>LoadLoad å±éšœ</strong>ï¼šå¯¹äºè¿™æ ·çš„è¯­å¥ Load1; LoadLoad å±éšœ; Load2ï¼Œåœ¨ Load2 åŠåç»­è¯»å–æ“ä½œè¦è¯»å–çš„æ•°æ®è¢«è®¿é—®å‰ï¼Œä¿è¯ Load1 è¦è¯»å–çš„æ•°æ®è¢«è¯»å–å®Œæ¯•ã€‚</li>
<li><strong>StoreStore å±éšœ</strong>ï¼šå¯¹äºè¿™æ ·çš„è¯­å¥ Store1; StoreStore å±éšœ; Store2ï¼Œåœ¨ Store2 åŠåç»­å†™å…¥æ“ä½œæ‰§è¡Œå‰ï¼Œä¿è¯ Store1 çš„å†™å…¥æ“ä½œå¯¹å…¶å®ƒå¤„ç†å™¨å¯è§ã€‚</li>
<li><strong>LoadStore å±éšœ</strong>ï¼šå¯¹äºè¿™æ ·çš„è¯­å¥ Load1; LoadStore å±éšœ; Store2ï¼Œåœ¨ Store2 åŠåç»­å†™å…¥æ“ä½œè¢«åˆ·å‡ºå‰ï¼Œä¿è¯ Load1 è¦è¯»å–çš„æ•°æ®è¢«è¯»å–å®Œæ¯•ã€‚</li>
<li><strong>StoreLoad å±éšœ</strong>ï¼šå¯¹äºè¿™æ ·çš„è¯­å¥ Store1; StoreLoad å±éšœ; Load2ï¼Œåœ¨ Load2 åŠåç»­æ‰€æœ‰è¯»å–æ“ä½œæ‰§è¡Œå‰ï¼Œä¿è¯ Store1 çš„å†™å…¥å¯¹æ‰€æœ‰å¤„ç†å™¨å¯è§ã€‚å®ƒçš„<strong>å¼€é”€æ˜¯å››ç§å±éšœä¸­æœ€å¤§çš„</strong>ã€‚åœ¨å¤§å¤šæ•°å¤„ç†å™¨çš„å®ç°ä¸­ï¼Œè¿™ä¸ªå±éšœæ˜¯ä¸ªä¸‡èƒ½å±éšœï¼Œå…¼å…·å…¶å®ƒä¸‰ç§å†…å­˜å±éšœçš„åŠŸèƒ½ã€‚</li>
</ul>
<p>æœ‰çš„å¤„ç†å™¨çš„é‡æ’åºè§„åˆ™è¾ƒä¸¥ï¼Œæ— éœ€å†…å­˜å±éšœä¹Ÿèƒ½å¾ˆå¥½çš„å·¥ä½œï¼ŒJava ç¼–è¯‘å™¨ä¼šåœ¨è¿™ç§æƒ…å†µä¸‹ä¸æ”¾ç½®å†…å­˜å±éšœã€‚<br>ä¸ºäº†å®ç° JSR-133 çš„è§„å®šï¼ŒJava ç¼–è¯‘å™¨ä¼šè¿™æ ·ä½¿ç”¨å†…å­˜å±éšœï¼š</p>
<p><img src="https://user-images.githubusercontent.com/16668676/30509011-80b17200-9ad7-11e7-9244-2081c271c752.png" alt="fences-table"></p>
<h3 id="å¯¹äº-long-å’Œ-double-å‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™"><a href="#å¯¹äº-long-å’Œ-double-å‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™" class="headerlink" title="å¯¹äº long å’Œ double å‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™"></a>å¯¹äº long å’Œ double å‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™</h3><p>å…è®¸è™šæ‹Ÿæœºå®ç°é€‰æ‹©<strong>å¯ä»¥ä¸ä¿è¯ 64 ä½æ•°æ®ç±»å‹çš„ loadã€storeã€read å’Œ write è¿™ 4 ä¸ªæ“ä½œçš„åŸå­æ€§</strong>ï¼Œè¿™ç‚¹å°±æ˜¯æ‰€è°“çš„ long å’Œ double çš„<strong>éåŸå­æ€§åå®š</strong>(Nonatomic Treatment ofdouble and long Variables)ã€‚</p>
<p>Java å†…å­˜æ¨¡å‹ã€Œå¼ºçƒˆå»ºè®®ã€è™šæ‹ŸæœºæŠŠè¿™äº›æ“ä½œå®ç°ä¸ºå…·æœ‰åŸå­æ€§çš„æ“ä½œã€‚ç›®å‰å„ç§å•†ç”¨è™šæ‹Ÿæœºä¹Ÿéƒ½æ˜¯å°†å®ƒä»¬å®ç°ä¸ºåŸå­æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬åœ¨<strong>ç¼–å†™ä»£ç æ—¶==ä¸€èˆ¬ä¸éœ€è¦==æŠŠç”¨åˆ°çš„ long å’Œ double å˜é‡ä¸“é—¨å£°æ˜ä¸º volatile</strong>ã€‚</p>
<h3 id="åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§"><a href="#åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§" class="headerlink" title="åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§"></a>åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§</h3><h4 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h4><p><strong>åŸå­æ€§</strong>æ˜¯æŒ‡<strong>ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ã€‚å³ä½¿æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¸€èµ·æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹å¹²æ‰°</strong>ã€‚</p>
<p>ç”± Java å†…å­˜æ¨¡å‹ç›´æ¥ä¿è¯çš„åŸå­æ€§å˜é‡æ“ä½œåŒ…æ‹¬ readã€loadã€assignã€useã€store å’Œ writeï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥è®¤ä¸º<strong>åŸºæœ¬æ•°æ®ç±»å‹çš„è®¿é—®è¯»å†™æ˜¯å…·å¤‡åŸå­æ€§çš„</strong>(ä¾‹å¤–å°±æ˜¯ long å’Œ double çš„éåŸå­æ€§åå®š)ã€‚</p>
<p>å°½ç®¡è™šæ‹ŸæœºæœªæŠŠ lock å’Œ unlock æ“ä½œç›´æ¥å¼€æ”¾ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œä½†æ˜¯å´<strong>æä¾›äº†æ›´é«˜å±‚æ¬¡çš„å­—èŠ‚ç æŒ‡ä»¤monitorenter å’Œ monitorexit æ¥éšå¼åœ°ä½¿ç”¨è¿™ä¸¤ä¸ªæ“ä½œï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤åæ˜ åˆ° Java ä»£ç ä¸­å°±æ˜¯åŒæ­¥å—â€”â€”synchronized å…³é”®å­—</strong>ï¼Œå› æ­¤åœ¨ synchronized å—ä¹‹é—´çš„æ“ä½œä¹Ÿå…·å¤‡åŸå­æ€§ã€‚</p>
<h4 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h4><p><strong>å¯è§æ€§</strong>(Visibility)ï¼šå¯è§æ€§æ˜¯æŒ‡å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿ<strong>ç«‹å³å¾—çŸ¥è¿™ä¸ªä¿®æ”¹</strong>ã€‚</p>
<p>é™¤äº† volatile ä»¥å¤–ï¼ŒJava è¿˜æœ‰ä¸¤ä¸ªå…³é”®å­—èƒ½å®ç°å¯è§æ€§ï¼Œå³ <strong>synchronized å’Œ final</strong>ã€‚</p>
<ul>
<li>åŒæ­¥å—çš„å¯è§æ€§æ˜¯ç”±ã€Œå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ unlock æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥å›ä¸»å†…å­˜ä¸­(æ‰§è¡Œ storeã€write æ“ä½œ)ã€è¿™æ¡è§„åˆ™è·å¾—çš„ï¼Œ</li>
<li>final å…³é”®å­—çš„å¯è§æ€§æ˜¯æŒ‡ï¼šä¿è¯ä¸€ä¸ªå¯¹è±¡çš„æ„å»ºæ–¹æ³•ç»“æŸå‰ï¼Œæ‰€æœ‰ final æˆå‘˜å˜é‡éƒ½å¿…é¡»å®Œæˆåˆå§‹åŒ–ï¼ˆå‰ææ˜¯æ²¡æœ‰ this å¼•ç”¨æº¢å‡ºï¼‰ã€‚åœ¨æ„é€ å™¨ä¸­ä¸€æ—¦åˆå§‹åŒ–å®Œæˆï¼Œå¹¶ä¸”æ„é€ å™¨æ²¡æœ‰æŠŠã€Œthisã€çš„å¼•ç”¨ä¼ é€’å‡ºå»ï¼Œé‚£åœ¨å…¶ä»–çº¿ç¨‹ä¸­å°±èƒ½çœ‹è§ final å­—æ®µçš„å€¼ã€‚<ul>
<li><strong>this å¼•ç”¨é€ƒé€¸</strong> æ˜¯æŒ‡åœ¨æ„é€ å‡½æ•°è¿”å›ä¹‹å‰å…¶ä»–çº¿ç¨‹å°±æŒæœ‰è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚è°ƒç”¨å°šæœªæ„é€ å®Œå…¨çš„å¯¹è±¡çš„æ–¹æ³•å¯èƒ½å¼•å‘ä»¤äººç–‘æƒ‘çš„é”™è¯¯, å› æ­¤åº”è¯¥é¿å… this é€ƒé€¸çš„å‘ç”Ÿã€‚<ul>
<li>ä¾‹å­ï¼šåœ¨<strong>æ„é€ å‡½æ•°ä¸­</strong>å¯åŠ¨çº¿ç¨‹ / æ³¨å†Œç›‘å¬å™¨/ åˆ›å»ºåŒ¿åå†…éƒ¨ç±»ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h4><p>å¦‚æœåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚å‰åŠå¥æ˜¯æŒ‡ã€Œçº¿ç¨‹å†…è¡¨ç°ä¸ºä¸²è¡Œçš„è¯­ä¹‰ã€(Within-Thread  As-If-Serial Semantics)ï¼ŒååŠå¥æ˜¯æŒ‡ã€ŒæŒ‡ä»¤é‡æ’åºã€ç°è±¡å’Œã€Œå·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜åŒæ­¥å»¶è¿Ÿã€ç°è±¡ã€‚</p>
<h3 id="å…ˆè¡Œå‘ç”ŸåŸåˆ™"><a href="#å…ˆè¡Œå‘ç”ŸåŸåˆ™" class="headerlink" title="å…ˆè¡Œå‘ç”ŸåŸåˆ™"></a>å…ˆè¡Œå‘ç”ŸåŸåˆ™</h3><p><strong>å…ˆè¡Œå‘ç”ŸåŸåˆ™æ˜¯åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ç«äº‰ã€çº¿ç¨‹æ˜¯å¦å®‰å…¨çš„ä¸»è¦ä¾æ®</strong>ã€‚</p>
<p>å…ˆè¡Œå‘ç”Ÿæ˜¯ Java å†…å­˜æ¨¡å‹ä¸­å®šä¹‰çš„ä¸¤é¡¹æ“ä½œä¹‹é—´çš„ååºå…³ç³»ã€‚æ‰€è°“ååºå…³ç³»å¯ä»¥è¿™æ ·ç†è§£ï¼š<strong>å¯¹äºä¸¤ä¸ªæ“ä½œAå’ŒBï¼Œè¿™ä¸¤ä¸ªæ“ä½œå¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚å¦‚æœA Happens-Before Bï¼Œé‚£ä¹ˆå¯ä»¥ä¿è¯ï¼Œå½“Aæ“ä½œæ‰§è¡Œå®Œåï¼ŒAæ“ä½œçš„æ‰§è¡Œç»“æœå¯¹Bæ“ä½œæ˜¯å¯è§çš„</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä»¥ä¸‹æ“ä½œåœ¨çº¿ç¨‹ A ä¸­æ‰§è¡Œ</span></div><div class="line">i=<span class="number">1</span>ï¼›</div><div class="line"><span class="comment">//ä»¥ä¸‹æ“ä½œåœ¨çº¿ç¨‹ B ä¸­æ‰§è¡Œ</span></div><div class="line">j=iï¼›</div><div class="line"><span class="comment">//ä»¥ä¸‹æ“ä½œåœ¨çº¿ç¨‹ C ä¸­æ‰§è¡Œ</span></div><div class="line">i=<span class="number">2</span>ï¼›</div></pre></td></tr></table></figure>
<p>å‡è®¾ A B C ä¹‹é—´æ»¡è¶³ Happens-Before æ¡ä»¶ï¼Œä¸” A Happens-Before B Happens-Before Cï¼Œé‚£ä¹ˆæ‰§è¡Œç»“æœå°±æ˜¯ j = 1; i = 2;</p>
<p>è¿™äº›å…ˆè¡Œå‘ç”Ÿå…³ç³»æ— é¡»ä»»ä½•åŒæ­¥å™¨ååŠ©å°±å·²ç»å­˜åœ¨ï¼Œå¯ä»¥åœ¨ç¼–ç ä¸­ç›´æ¥ä½¿ç”¨ã€‚<strong>å¦‚æœä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å…³ç³»ä¸åœ¨æ­¤åˆ—ï¼Œå¹¶ä¸”æ— æ³•ä»ä¸‹åˆ—è§„åˆ™æ¨å¯¼å‡ºæ¥çš„è¯ï¼Œå®ƒä»¬å°±æ²¡æœ‰é¡ºåºæ€§ä¿éšœï¼Œè™šæ‹Ÿæœºå¯ä»¥å¯¹å®ƒä»¬éšæ„åœ°è¿›è¡Œé‡æ’åº</strong>ã€‚</p>
<ul>
<li><strong>ç¨‹åºæ¬¡åºè§„åˆ™</strong>(Program Order Rule)ï¼š<strong>åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ç¨‹åºä»£ç é¡ºåº</strong>ï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºä¹¦å†™åœ¨åé¢çš„æ“ä½œã€‚å‡†ç¡®åœ°è¯´ï¼Œåº”è¯¥æ˜¯<strong>æ§åˆ¶æµé¡ºåº</strong>è€Œä¸æ˜¯ç¨‹åºä»£ç é¡ºåºï¼Œå› ä¸ºè¦è€ƒè™‘åˆ†æ”¯ã€å¾ªç¯ç­‰ç»“æ„ã€‚</li>
<li><strong>ç®¡ç¨‹é”å®šè§„åˆ™</strong>(Monitor Lock Rule)ï¼šä¸€ä¸ª <strong>unlock æ“ä½œ</strong>å…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹<em>åŒä¸€ä¸ªé”</em>çš„ lockæ“ä½œã€‚è¿™é‡Œå¿…é¡»å¼ºè°ƒçš„æ˜¯<em>åŒä¸€ä¸ªé”</em>ï¼Œè€Œã€Œåé¢ã€æ˜¯æŒ‡<strong>æ—¶é—´ä¸Š</strong>çš„å…ˆåé¡ºåºã€‚</li>
<li><strong>volatile å˜é‡è§„åˆ™</strong>(Volatile Variable Rule)ï¼šå¯¹ä¸€ä¸ª volatile å˜é‡çš„<strong>å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢</strong>å¯¹è¿™ä¸ªå˜é‡çš„<strong>è¯»æ“ä½œ</strong>ï¼Œè¿™é‡Œçš„ã€Œåé¢ã€åŒæ ·æ˜¯æŒ‡<strong>æ—¶é—´ä¸Š</strong>çš„å…ˆåé¡ºåºã€‚</li>
<li><strong>çº¿ç¨‹å¯åŠ¨è§„åˆ™</strong>(Thread Start Rule)ï¼šThread å¯¹è±¡çš„ start()æ–¹æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚</li>
<li><strong>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™</strong>(Thread Termination Rule)ï¼šçº¿ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œå¿…é¡»åœ¨å…¶ä»–çº¿ç¨‹æ£€æµ‹åˆ°è¯¥çº¿ç¨‹å·²ç»ç»“æŸä¹‹å‰å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Thread.join()æ–¹æ³•ç»“æŸã€Thread.isAlive()çš„è¿”å›å€¼ç­‰æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œã€‚</li>
<li><strong>çº¿ç¨‹ä¸­æ–­è§„åˆ™</strong>(Thread Interruption Rule)ï¼šå¯¹çº¿ç¨‹ interrupt()æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡ Thread.interrupted()æ–¹æ³•æ£€æµ‹åˆ°æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚</li>
<li><strong>å¯¹è±¡ç»ˆç»“è§„åˆ™</strong>(Finalizer Rule)ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆ(æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸ)å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„ finalize()æ–¹æ³•çš„å¼€å§‹ã€‚</li>
<li><strong>ä¼ é€’æ€§</strong>(Transitivity)ï¼šå¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œæ“ä½œ B å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œé‚£å°±å¯ä»¥å¾—å‡ºæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ C çš„ç»“è®ºã€‚</li>
</ul>
<p>Java æ— éœ€ä»»ä½•åŒæ­¥æ‰‹æ®µå°±èƒ½æˆç«‹çš„å…ˆè¡Œå‘ç”Ÿè§„åˆ™å°±ä»¥ä¸Š 8 ç‚¹ã€‚çœ‹ä¸Šå»æœ‰äº›æŠ½è±¡ï¼Œæƒ³è¦è¿›ä¸€æ­¥äº†è§£çš„åŒå­¦å¯ä»¥å‚è€ƒä¸‹è¿™ç¯‡æ–‡ç«  <a href="https://segmentfault.com/a/1190000011458941" target="_blank" rel="noopener">ä»Javaå¤šçº¿ç¨‹å¯è§æ€§è°ˆHappens-BeforeåŸåˆ™</a></p>
<p>==æ—¶é—´å…ˆåé¡ºåºä¸å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¹‹é—´åŸºæœ¬æ²¡æœ‰å¤ªå¤§çš„å…³ç³»==ï¼Œæ‰€ä»¥æˆ‘ä»¬è¡¡é‡å¹¶å‘å®‰å…¨é—®é¢˜çš„æ—¶å€™==ä¸è¦å—åˆ°æ—¶é—´é¡ºåºçš„å¹²æ‰°ï¼Œä¸€åˆ‡å¿…é¡»ä»¥å…ˆè¡Œå‘ç”ŸåŸåˆ™ä¸ºå‡†==ã€‚</p>
<p>è¿™å¥è¯åº”è¯¥å¦‚ä½•ç†è§£å‘¢ï¼Ÿ</p>
<p>è€ƒè™‘è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line"><span class="comment">//çº¿ç¨‹ A å…ˆï¼ˆæ—¶é—´ä¸Šï¼‰è°ƒç”¨äº† getValue æ–¹æ³•</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> value;</div><div class="line">&#125;</div><div class="line"><span class="comment">//ä¹‹åï¼ˆæ—¶é—´ä¸Šï¼‰çº¿ç¨‹ B è°ƒç”¨äº† setValue(2) æ–¹æ³•</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.value = value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯çº¿ç¨‹ A çš„ getValue è·å–çš„ç»“æœæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¯èƒ½æ˜¯ 0 ï¼Œä¹Ÿå¯èƒ½æ˜¯ 2ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<em>æ²¡æœ‰è¿›è¡ŒåŒæ­¥å¤„ç†çš„æƒ…å†µä¸‹</em>ï¼Œä¸åŒçº¿ç¨‹å¯¹åœ¨æ—¶é—´ä¸Šå…ˆåå¯¹è°ƒç”¨å¯¹æŸä¸ªå…±äº«å˜é‡çš„æ“ä½œï¼Œå¹¶ä¸èƒ½ä¿è¯å®ƒä»¬çš„ç»“æœæ˜¯æ ¹æ®å®ƒä»¬åœ¨æ—¶é—´ä¸Šè°ƒç”¨é¡ºåºç¡®å®šçš„ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´ï¼Œã€Œæ—¶é—´ä¸Šçš„å…ˆè°ƒç”¨ã€å¹¶ä¸ä»£è¡¨ã€Œå…ˆè¡Œå‘ç”Ÿã€ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ç»™ getValue å’Œ setValue æ–¹æ³•éƒ½å®šä¹‰ä¸º synchronized çš„ï¼Œå› ä¸ºè¿™æ ·å°±å¯ä»¥å¥—ç”¨ã€Œç®¡ç¨‹é”å®šåŸåˆ™ã€äº†ã€‚æˆ–è€…å°† value å®šä¹‰äº† volatile å˜é‡ï¼Œå› ä¸º setValue æ–¹æ³•å¯¹ value çš„ä¿®æ”¹ä¸ä¾èµ– value çš„åŸå€¼ï¼Œæ»¡è¶³ volatile å…³é”®å­—ä½¿ç”¨åœºæ™¯ï¼Œè¿™æ ·å°±å¯ä»¥å¥—ç”¨ volatile å˜é‡è§„åˆ™æ¥å®ç°å…ˆè¡Œå‘ç”Ÿè§„åˆ™äº†ã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„è®¨è®ºï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼šä¸€ä¸ªæ“ä½œã€Œæ—¶é—´ä¸Šçš„å…ˆå‘ç”Ÿã€ä¸ä»£è¡¨è¿™ä¸ªæ“ä½œä¼šä¼šæ˜¯ã€Œå…ˆè¡Œå‘ç”Ÿã€ã€‚é‚£ä¹ˆä¸€ä¸ªæ“ä½œã€Œå…ˆè¡Œå‘ç”Ÿã€æ˜¯å¦èƒ½æ¨å¯¼å‡ºè¿™ä¸ªæ“ä½œå¿…å®šæ˜¯ã€Œæ—¶é—´ä¸Šå…ˆå‘ç”Ÿã€å‘¢ï¼Ÿè¿™ä¸ªæ¨è®ºä¹Ÿæ˜¯ä¸æˆç«‹çš„ï¼Œä¸€ä¸ªå…¸å‹çš„æ —å­å°±æ˜¯ã€ŒæŒ‡ä»¤é‡æ’åºã€</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> i = <span class="number">2</span>;</div><div class="line"><span class="keyword">int</span> j = <span class="number">1</span>;</div></pre></td></tr></table></figure>
<p>æŒ‰ç…§ç¨‹åºæ¬¡åºè§„åˆ™ï¼Œ<code>int i = 2;</code> çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿä¸ <code>int j = 1;</code>,ä½†æ˜¯ <code>int j = 1;</code> å®Œå…¨å¯èƒ½å…ˆæ‰§è¡Œï¼Œè¿™å¹¶ä¸å½±å“å…ˆè¡Œå‘ç”ŸåŸåˆ™çš„æ­£ç¡®æ€§ï¼Œå› ä¸ºåœ¨åŒä¸€æ¡çº¿ç¨‹ä¸­æ— æ³•æ„ŸçŸ¥åˆ°è¿™ç‚¹ã€‚</p>
<h3 id="å…ˆè¡Œå‘ç”ŸåŸåˆ™çš„çœŸæ­£æ„ä¹‰"><a href="#å…ˆè¡Œå‘ç”ŸåŸåˆ™çš„çœŸæ­£æ„ä¹‰" class="headerlink" title="å…ˆè¡Œå‘ç”ŸåŸåˆ™çš„çœŸæ­£æ„ä¹‰"></a>å…ˆè¡Œå‘ç”ŸåŸåˆ™çš„çœŸæ­£æ„ä¹‰</h3><p>è¯¥æ®µå†…å®¹å‚è€ƒè‡ª<a href="https://segmentfault.com/a/1190000011458941" target="_blank" rel="noopener">ä»Javaå¤šçº¿ç¨‹å¯è§æ€§è°ˆHappens-BeforeåŸåˆ™</a></p>
<blockquote>
<p>  ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒHappens-BeforeåŸåˆ™è‡´åŠ›äº<strong>è§£å†³å˜é‡é—´å¯è§æ€§é—®é¢˜</strong>ã€‚ä½†æ˜¯å®ƒæ˜¯å¦‚ä½•è§£å†³çš„å‘¢ï¼Ÿ</p>
<p>  <strong>å¯¼è‡´å¤šçº¿ç¨‹é—´å˜é‡é—´å¯è§æ€§é—®é¢˜çš„æ ¹æºåœ¨äº CPU ç¼“å­˜ä»¥åŠæŒ‡ä»¤é‡æ’åº</strong>ã€‚é‚£ä¹ˆï¼Œè¦è§£å†³è¿™ä¸ªå¯è§æ€§é—®é¢˜ï¼Œä¸€ä¸ªæœ€ç®€å•ç²—æš´çš„æ–¹æ³•å°±æ˜¯ç¦æ­¢æ‰€æœ‰çš„é‡æ’åºå’Œ CPU ç¼“å­˜ã€‚å³å…³é—­æ‰€æœ‰çš„ç¼–è¯‘å™¨ã€æ“ä½œç³»ç»Ÿå’Œå¤„ç†å™¨çš„ä¼˜åŒ–ï¼Œè¿™æ ·æ‰€æœ‰çš„æŒ‡ä»¤é¡ºåºå…¨éƒ¨æŒ‰ç…§ç¨‹åºä»£ç ä¹¦å†™çš„é¡ºåºæ‰§è¡Œã€‚å»æ‰ CPU é«˜é€Ÿç¼“å­˜ï¼Œè®© CPU æ¯æ¬¡è¯»å†™æ“ä½œéƒ½ç›´æ¥ä¸ä¸»å­˜äº¤äº’ã€‚</p>
<p>  ä½†æ˜¯ï¼Œå¦‚æ­¤ç²—æš´çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸å¯å–çš„ï¼Œå› ä¸ºè¿™ä¼šæå¤§å½±å“å¤„ç†å™¨çš„è®¡ç®—æ€§èƒ½ï¼Œå¹¶ä¸”å¯¹äºé‚£äº›éå¤šçº¿ç¨‹å…±äº«çš„ å˜é‡æ˜¯æä¸å…¬å¹³çš„ã€‚æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€ç§æŠ˜ä¸­çš„æ–¹æ¡ˆæ¥è§£å†³ CPU é«˜é€Ÿç¼“å­˜ä¸æŒ‡ä»¤é‡æ’å¸¦æ¥çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚<strong>ä½¿ç”¨åˆ†å‰²çº¿æŠŠæ•´ä¸ªç¨‹åºåˆ’åˆ†ä¸ºå‡ ä¸ªç¨‹åºå—</strong>ï¼Œåœ¨æ¯ä¸ª<strong>ç¨‹åºå—å†…éƒ¨çš„æŒ‡ä»¤æ˜¯å¯é‡æ’åºçš„</strong>ï¼Œä½†æ˜¯åˆ†å‰²çº¿ä¸Šçš„æŒ‡ä»¤ä¸ç¨‹åºå—å…¶ä»–æŒ‡ä»¤ä¹‹é—´æ˜¯ä¸å¯ä»¥é‡æ’åºçš„ã€‚åœ¨ä¸€ä¸ªç¨‹åºå—å†…éƒ¨ï¼ŒCPU ä¸ç”¨æ¯æ¬¡éƒ½ä¸ä¸»å†…å­˜è¿›è¡Œäº¤äº’ï¼Œåªéœ€è¦åœ¨ CPU ç¼“å­˜ä¸­æ‰§è¡Œè¯»å†™æ“ä½œå³å¯ï¼Œä½†æ˜¯å½“ç¨‹åºæ‰§è¡Œåˆ°åˆ†å‰²çº¿å‡ºï¼ŒCPU å¿…é¡»å°†æ‰§è¡Œç»“æœåŒæ­¥åˆ°ä¸»å†…å­˜æˆ–è€…ä»ä¸»å†…å­˜è¯»å–æœ€æ–°çš„å˜é‡å€¼ï¼Œé‚£ä¹ˆ Happen-before è§„åˆ™å°±æ˜¯å®šä¹‰äº†è¿™äº›ç¨‹åºå—çš„åˆ†å‰²çº¿ã€‚</p>
</blockquote>
<p><img src="https://user-images.githubusercontent.com/16668676/32106891-945e0bb2-bb5f-11e7-8d9e-be0b72d75ff2.png" alt="image"></p>
<blockquote>
<p>  å¦‚å›¾æ‰€ç¤ºï¼Œè¿™é‡Œçš„unlock Må’Œlock Må°±æ˜¯åˆ’åˆ†ç¨‹åºçš„åˆ†å‰²çº¿ã€‚åœ¨è¿™é‡Œï¼Œçº¢è‰²åŒºåŸŸå’Œç»¿è‰²åŒºåŸŸçš„ä»£ç å†…éƒ¨æ˜¯å¯ä»¥è¿›è¡Œé‡æ’åºçš„ï¼Œä½†æ˜¯ unlock å’Œ lock æ“ä½œæ˜¯ä¸èƒ½ä¸å®ƒä»¬è¿›è¡Œé‡æ’åºçš„ã€‚å³ç¬¬ä¸€ä¸ªå›¾ä¸­çš„çº¢è‰²éƒ¨åˆ†å¿…é¡»è¦åœ¨unlock MæŒ‡ä»¤ä¹‹å‰å…¨éƒ¨æ‰§è¡Œå®Œï¼Œç¬¬äºŒä¸ªå›¾ä¸­çš„ç»¿è‰²éƒ¨åˆ†å¿…é¡»å…¨éƒ¨åœ¨lock MæŒ‡ä»¤ä¹‹åæ‰§è¡Œã€‚å¹¶ä¸”åœ¨ç¬¬ä¸€ä¸ªå›¾ä¸­çš„unlock MæŒ‡ä»¤å¤„ï¼Œçº¢è‰²éƒ¨åˆ†çš„æ‰§è¡Œç»“æœè¦å…¨éƒ¨åˆ·æ–°åˆ°ä¸»å­˜ä¸­ï¼Œåœ¨ç¬¬äºŒä¸ªå›¾ä¸­çš„lock MæŒ‡ä»¤å¤„ï¼Œç»¿è‰²éƒ¨åˆ†ç”¨åˆ°çš„å˜é‡éƒ½è¦ä»ä¸»å­˜ä¸­é‡æ–°è¯»å–ã€‚</p>
<p>  åœ¨ç¨‹åºä¸­åŠ å…¥åˆ†å‰²çº¿å°†å…¶åˆ’åˆ†æˆå¤šä¸ªç¨‹åºå—ï¼Œè™½ç„¶åœ¨ç¨‹åºå—<strong>å†…éƒ¨ä»£ç ä»ç„¶å¯èƒ½è¢«é‡æ’åº</strong>ï¼Œä½†æ˜¯<strong>ä¿è¯äº†ç¨‹åºä»£ç åœ¨å®è§‚ä¸Šæ˜¯æœ‰åºçš„</strong>ã€‚å¹¶ä¸”å¯ä»¥ç¡®ä¿<strong>åœ¨åˆ†å‰²çº¿å¤„ï¼ŒCPUä¸€å®šä¼šå’Œä¸»å†…å­˜è¿›è¡Œäº¤äº’</strong>ã€‚<strong>Happens-BeforeåŸåˆ™å°±æ˜¯å®šä¹‰äº†ç¨‹åºä¸­ä»€ä¹ˆæ ·çš„ä»£ç å¯ä»¥ä½œä¸ºåˆ†å‰²çº¿</strong>ã€‚å¹¶ä¸”æ— è®ºæ˜¯å“ªæ¡Happens-BeforeåŸåˆ™ï¼Œå®ƒä»¬æ‰€äº§ç”Ÿåˆ†å‰²çº¿çš„ä½œç”¨éƒ½æ˜¯ç›¸åŒçš„ã€‚</p>
</blockquote>
<h2 id="Java-ä¸çº¿ç¨‹"><a href="#Java-ä¸çº¿ç¨‹" class="headerlink" title="Java ä¸çº¿ç¨‹"></a>Java ä¸çº¿ç¨‹</h2><h3 id="çº¿ç¨‹çš„å®ç°"><a href="#çº¿ç¨‹çš„å®ç°" class="headerlink" title="çº¿ç¨‹çš„å®ç°"></a>çº¿ç¨‹çš„å®ç°</h3><p>(å¹¿ä¹‰)<br>å®ç°çº¿ç¨‹ä¸»è¦æœ‰ 3 ç§æ–¹å¼ï¼šä½¿ç”¨å†…æ ¸çº¿ç¨‹å®ç°ã€ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°å’Œä½¿ç”¨ç”¨æˆ·çº¿ç¨‹åŠ è½»é‡çº§è¿›ç¨‹æ··åˆå®ç°ã€‚</p>
<p>Thread ç±»ä¸å¤§éƒ¨åˆ†çš„ Java API æœ‰æ˜¾è‘—çš„å·®åˆ«ï¼Œå®ƒçš„æ‰€æœ‰å…³é”®æ–¹æ³•éƒ½æ˜¯å£°æ˜ä¸º Native çš„ã€‚åœ¨ Java API ä¸­ï¼Œä¸€ä¸ª Native æ–¹æ³•å¾€å¾€æ„å‘³ç€è¿™ä¸ªæ–¹æ³•æ²¡æœ‰ä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨å¹³å°æ— å…³çš„æ‰‹æ®µæ¥å®ç°(å½“ç„¶ä¹Ÿå¯èƒ½æ˜¯ä¸ºäº†æ‰§è¡Œæ•ˆç‡è€Œä½¿ç”¨ Native æ–¹æ³•ï¼Œä¸è¿‡ï¼Œé€šå¸¸æœ€é«˜æ•ˆç‡çš„æ‰‹æ®µä¹Ÿå°±æ˜¯å¹³å°ç›¸å…³çš„æ‰‹æ®µ)ã€‚</p>
<h4 id="1-å†…æ ¸çº¿ç¨‹å®ç°"><a href="#1-å†…æ ¸çº¿ç¨‹å®ç°" class="headerlink" title="1.å†…æ ¸çº¿ç¨‹å®ç°"></a>1.å†…æ ¸çº¿ç¨‹å®ç°</h4><p>å†…æ ¸çº¿ç¨‹(Kernel-Level Thread,KLT)å°±æ˜¯<strong>ç›´æ¥ç”±æ“ä½œç³»ç»Ÿå†…æ ¸</strong>(Kernelï¼Œä¸‹ç§°å†…æ ¸)<strong>æ”¯æŒçš„çº¿ç¨‹</strong>ï¼Œè¿™ç§çº¿ç¨‹ç”±å†…æ ¸æ¥å®Œæˆçº¿ç¨‹åˆ‡æ¢ï¼Œå†…æ ¸é€šè¿‡æ“çºµè°ƒåº¦å™¨(Scheduler)å¯¹çº¿ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œå¹¶è´Ÿè´£å°†çº¿ç¨‹çš„ä»»åŠ¡æ˜ å°„åˆ°å„ä¸ªå¤„ç†å™¨ä¸Šã€‚</p>
<p>ç¨‹åºä¸€èˆ¬ä¸ä¼šç›´æ¥å»ä½¿ç”¨å†…æ ¸çº¿ç¨‹ï¼Œè€Œæ˜¯å»ä½¿ç”¨å†…æ ¸çº¿ç¨‹çš„ä¸€ç§é«˜çº§æ¥å£â€”â€”<strong>è½»é‡çº§è¿›ç¨‹</strong>(Light Weight Process,LWP)ï¼Œ<strong>è½»é‡çº§è¿›ç¨‹å°±æ˜¯æˆ‘ä»¬é€šå¸¸æ„ä¹‰ä¸Šæ‰€è®²çš„çº¿ç¨‹</strong>ï¼Œç”±äºæ¯ä¸ªè½»é‡çº§è¿›ç¨‹éƒ½ç”±ä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ”¯æŒï¼Œå› æ­¤åªæœ‰å…ˆæ”¯æŒå†…æ ¸çº¿ç¨‹ï¼Œæ‰èƒ½æœ‰è½»é‡çº§è¿›ç¨‹ã€‚</p>
<p><strong>ç³»ç»Ÿè°ƒç”¨çš„ä»£ä»·</strong>ç›¸å¯¹è¾ƒé«˜ï¼Œéœ€è¦åœ¨<strong>ç”¨æˆ·æ€(User Mode)å’Œå†…æ ¸æ€(Kernel Mode)ä¸­æ¥å›åˆ‡æ¢</strong>ã€‚å…¶æ¬¡ï¼Œæ¯ä¸ªè½»é‡çº§è¿›ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªå†…æ ¸çº¿ç¨‹çš„æ”¯æŒï¼Œå› æ­¤è½»é‡çº§è¿›ç¨‹è¦æ¶ˆè€—ä¸€å®šçš„å†…æ ¸èµ„æº(å¦‚å†…æ ¸çº¿ç¨‹çš„æ ˆç©ºé—´)ï¼Œå› æ­¤ä¸€ä¸ªç³»ç»Ÿæ”¯æŒè½»é‡çº§è¿›ç¨‹çš„æ•°é‡æ˜¯æœ‰é™çš„ã€‚</p>
<p>1:1</p>
<h4 id="2-ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°"><a href="#2-ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°" class="headerlink" title="2.ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°"></a>2.ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹å®ç°</h4><p>ä»å¹¿ä¹‰ä¸Šæ¥è®²ï¼Œä¸€ä¸ªçº¿ç¨‹åªè¦ä¸æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œå°±å¯ä»¥è®¤ä¸ºæ˜¯ç”¨æˆ·çº¿ç¨‹(User Thread,UT)ï¼Œå› æ­¤ï¼Œä»è¿™ä¸ªå®šä¹‰ä¸Šæ¥è®²ï¼Œè½»é‡çº§è¿›ç¨‹ä¹Ÿå±äºç”¨æˆ·çº¿ç¨‹ï¼Œä½†è½»é‡çº§è¿›ç¨‹çš„å®ç°å§‹ç»ˆæ˜¯å»ºç«‹åœ¨å†…æ ¸ä¹‹ä¸Šçš„ï¼Œè®¸å¤šæ“ä½œéƒ½è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ•ˆç‡ä¼šå—åˆ°é™åˆ¶ã€‚<br><strong>ç‹­ä¹‰ä¸Šçš„ç”¨æˆ·çº¿ç¨‹æŒ‡çš„æ˜¯å®Œå…¨å»ºç«‹åœ¨ç”¨æˆ·ç©ºé—´çš„çº¿ç¨‹åº“ä¸Šï¼Œç³»ç»Ÿå†…æ ¸ä¸èƒ½æ„ŸçŸ¥ç”¨æˆ·çº¿ç¨‹å­˜åœ¨çš„å®ç°</strong>ã€‚</p>
<p>ç°åœ¨ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹çš„ç¨‹åºè¶Šæ¥è¶Šå°‘äº†ï¼ŒJavaã€Ruby ç­‰è¯­è¨€éƒ½æ›¾ç»ä½¿ç”¨è¿‡ç”¨æˆ·çº¿ç¨‹ï¼Œæœ€ç»ˆåˆéƒ½æ”¾å¼ƒä½¿ç”¨å®ƒã€‚</p>
<h4 id="3-ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹åŠ è½»é‡çº§è¿›ç¨‹æ··åˆå®ç°"><a href="#3-ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹åŠ è½»é‡çº§è¿›ç¨‹æ··åˆå®ç°" class="headerlink" title="3.ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹åŠ è½»é‡çº§è¿›ç¨‹æ··åˆå®ç°"></a>3.ä½¿ç”¨ç”¨æˆ·çº¿ç¨‹åŠ è½»é‡çº§è¿›ç¨‹æ··åˆå®ç°</h4><p>çº¿ç¨‹é™¤äº†ä¾èµ–å†…æ ¸çº¿ç¨‹å®ç°å’Œå®Œå…¨ç”±ç”¨æˆ·ç¨‹åºè‡ªå·±å®ç°ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§å°†å†…æ ¸çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·ä½¿ç”¨çš„å®ç°æ–¹å¼ã€‚åœ¨è¿™ç§æ··åˆå®ç°ä¸‹ï¼Œæ—¢å­˜åœ¨ç”¨æˆ·çº¿ç¨‹ï¼Œä¹Ÿå­˜åœ¨è½»é‡çº§è¿›ç¨‹ã€‚ç”¨æˆ·çº¿ç¨‹è¿˜æ˜¯å®Œå…¨å»ºç«‹åœ¨ç”¨æˆ·ç©ºé—´ä¸­åœ¨è¿™ç§æ··åˆæ¨¡å¼ä¸­ï¼Œç”¨æˆ·çº¿ç¨‹ä¸è½»é‡çº§è¿›ç¨‹çš„æ•°é‡æ¯”æ˜¯ä¸å®šçš„ï¼Œå³ä¸º Nï¼šM çš„å…³ç³»</p>
<h3 id="çº¿ç¨‹è°ƒåº¦"><a href="#çº¿ç¨‹è°ƒåº¦" class="headerlink" title="çº¿ç¨‹è°ƒåº¦"></a>çº¿ç¨‹è°ƒåº¦</h3><p>ä¸»è¦è°ƒåº¦æ–¹å¼æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯<strong>ååŒå¼çº¿ç¨‹è°ƒåº¦</strong>(Cooperative  Threads-Scheduling)å’Œ<strong>æŠ¢å å¼çº¿ç¨‹è°ƒåº¦</strong>(Preemptive  Threads-Scheduling)ã€‚</p>
<p>å¦‚æœä½¿ç”¨ååŒå¼è°ƒåº¦çš„å¤šçº¿ç¨‹ç³»ç»Ÿï¼Œ<strong>çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”±çº¿ç¨‹æœ¬èº«æ¥æ§åˆ¶</strong>ï¼Œçº¿ç¨‹æŠŠè‡ªå·±çš„å·¥ä½œæ‰§è¡Œå®Œäº†ä¹‹åï¼Œè¦ä¸»åŠ¨é€šçŸ¥ç³»ç»Ÿåˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸Šã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œä¸ç”¨è€ƒè™‘åŒæ­¥é—®é¢˜ã€‚</li>
<li>ç¼ºç‚¹ï¼šä¸ç¨³å®šï¼Œå‰é¢ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆåé¢çš„çº¿ç¨‹éƒ½ä¼šå—åˆ°å½±å“ã€‚</li>
</ul>
<p>å¦‚æœä½¿ç”¨æŠ¢å å¼è°ƒåº¦çš„å¤šçº¿ç¨‹ç³»ç»Ÿï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹å°†<strong>ç”±ç³»ç»Ÿæ¥åˆ†é…æ‰§è¡Œæ—¶é—´</strong>ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ä¸ç”±çº¿ç¨‹æœ¬èº«æ¥å†³å®šã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼šç›¸å¯¹äºååŒå¼è°ƒåº¦è€Œè¨€ï¼Œè¾ƒä¸ºç¨³å®šã€‚</li>
<li>ç¼ºç‚¹ï¼šå¯æ§æ€§ä¸æ˜¯å¾ˆé«˜ï¼Œå› ä¸ºçº¿ç¨‹çš„ä¼˜å…ˆçº§ä¸æ˜¯å¾ˆé è°±ï¼›è™½ç„¶ Thread.yield()å¯ä»¥è®©å‡ºæ‰§è¡Œæ—¶é—´ï¼Œä½†æ˜¯è¦è·å–æ‰§è¡Œæ—¶é—´çš„è¯ï¼Œçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰ä»€ä¹ˆåŠæ³•ã€‚</li>
</ul>
<p>ç›®å‰ Java ä½¿ç”¨çš„çº¿ç¨‹è°ƒåº¦æ–¹å¼å°±æ˜¯æŠ¢å å¼è°ƒåº¦ã€‚JDK åç»­ç‰ˆæœ¬ä¸­æœ‰å¯èƒ½ä¼šæä¾›åç¨‹(Coroutines)æ–¹å¼æ¥è¿›è¡Œå¤šä»»åŠ¡å¤„ç†</p>
<p>ä¸ºä»€ä¹ˆè¯´çº¿ç¨‹ä¼˜å…ˆçº§å¹¶ä¸æ˜¯å¤ªé è°±ï¼Ÿå› ä¸º Java çš„çº¿ç¨‹æ˜¯é€šè¿‡æ˜ å°„åˆ°ç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¸Šæ¥å®ç°çš„ï¼Œæ‰€ä»¥çº¿ç¨‹è°ƒåº¦æœ€ç»ˆè¿˜æ˜¯å–å†³äºæ“ä½œç³»ç»Ÿï¼Œè™½ç„¶ç°åœ¨å¾ˆå¤šæ“ä½œç³»ç»Ÿéƒ½æä¾›çº¿ç¨‹ä¼˜å…ˆçº§çš„æ¦‚å¿µï¼Œä½†æ˜¯å¹¶ä¸è§å¾—èƒ½ä¸ Java çº¿ç¨‹çš„ä¼˜å…ˆçº§ä¸€ä¸€å¯¹åº”ã€‚</p>
<h3 id="çº¿ç¨‹çš„çŠ¶æ€è½¬æ¢"><a href="#çº¿ç¨‹çš„çŠ¶æ€è½¬æ¢" class="headerlink" title="çº¿ç¨‹çš„çŠ¶æ€è½¬æ¢"></a>çº¿ç¨‹çš„çŠ¶æ€è½¬æ¢</h3><p>å›¾ç‰‡å‚è€ƒè‡ª<a href="http://uule.iteye.com/blog/1100799" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a></p>
<p><img src="https://user-images.githubusercontent.com/16668676/30508637-9ff0e262-9ace-11e7-8a3a-608482184f5d.jpg" alt="thread state"></p>
<ul>
<li>åˆ›å»º (New)</li>
<li>è¿è¡Œï¼Œä¸¤ç§å­çŠ¶æ€<ul>
<li>Running æ­£åœ¨æ‰§è¡Œ</li>
<li>Ready ç­‰å¾…ç€ CPU ç»™å®ƒåˆ†é…æ‰§è¡Œæ—¶é—´ã€‚</li>
</ul>
</li>
<li>ç­‰å¾… (Waiting)<ul>
<li>æ— é™æœŸç­‰å¾…<ul>
<li>æ²¡æœ‰è®¾ç½® Timeout å‚æ•°çš„ Object.wait()æ–¹æ³•ã€‚</li>
<li>æ²¡æœ‰è®¾ç½® Timeout å‚æ•°çš„ Thread.join()æ–¹æ³•ã€‚</li>
<li>LockSupport.park()æ–¹æ³•ã€‚</li>
</ul>
</li>
<li>æœ‰é™æœŸç­‰å¾… (Timed Waiting)<ul>
<li>Thread.sleep()æ–¹æ³•ã€‚</li>
<li>è®¾ç½®äº† Timeout å‚æ•°çš„ Object.wait()æ–¹æ³•ã€‚</li>
<li>è®¾ç½®äº† Timeout å‚æ•°çš„ Thread.join()æ–¹æ³•ã€‚</li>
<li>LockSupport.parkNanos()æ–¹æ³•ã€‚</li>
<li>LockSupport.parkUntil()æ–¹æ³•ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>é˜»å¡ (Blocked)<ul>
<li>ã€Œ<strong>é˜»å¡çŠ¶æ€ã€ä¸ã€Œç­‰å¾…çŠ¶æ€ã€çš„åŒºåˆ«</strong>æ˜¯ï¼šã€Œé˜»å¡çŠ¶æ€ã€åœ¨<strong>ç­‰å¾…ç€è·å–åˆ°ä¸€ä¸ªäº’æ–¥é”(æ’å®ƒé”)</strong>ï¼Œè¿™ä¸ªäº‹ä»¶å°†åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ”¾å¼ƒè¿™ä¸ªé”çš„æ—¶å€™å‘ç”Ÿï¼›è€Œã€Œç­‰å¾…çŠ¶æ€ã€åˆ™æ˜¯åœ¨<strong>ç­‰å¾…ä¸€æ®µæ—¶é—´</strong>ï¼Œæˆ–è€…å”¤é†’åŠ¨ä½œçš„å‘ç”Ÿã€‚åœ¨ç¨‹åºç­‰å¾…è¿›å…¥åŒæ­¥åŒºåŸŸçš„æ—¶å€™ï¼Œçº¿ç¨‹å°†è¿›å…¥è¿™ç§çŠ¶æ€ã€‚</li>
</ul>
</li>
<li>ç»“æŸ (Terminated)</li>
</ul>
<h4 id="ç›¸å…³æ–¹æ³•ä»‹ç»"><a href="#ç›¸å…³æ–¹æ³•ä»‹ç»" class="headerlink" title="ç›¸å…³æ–¹æ³•ä»‹ç»"></a>ç›¸å…³æ–¹æ³•ä»‹ç»</h4><p>è°ƒç”¨ sleepã€join æ—¶ï¼Œä¸ä¼šé‡Šæ”¾æ‰€å ç”¨çš„èµ„æºï¼Œä¼š<strong>è¿›å…¥é˜»å¡çŠ¶æ€</strong>ï¼›<br>è°ƒç”¨ wait æ—¶ï¼Œä¼šé‡Šæ”¾æ‰€å ç”¨çš„èµ„æºï¼Œä¼š<strong>è¿›å…¥ç­‰å¾…é˜Ÿåˆ—</strong>ã€‚</p>
<h4 id="sleep-æ–¹æ³•"><a href="#sleep-æ–¹æ³•" class="headerlink" title="sleep æ–¹æ³•"></a>sleep æ–¹æ³•</h4><p><strong>çº¿ç¨‹ç¡çœ åˆ°æœŸè‡ªåŠ¨è‹é†’ï¼Œå¹¶è¿”å›åˆ°<em>å¯è¿è¡ŒçŠ¶æ€</em>ï¼Œä¸æ˜¯è¿è¡ŒçŠ¶æ€</strong> ã€‚sleep() ä¸­æŒ‡å®šçš„æ—¶é—´æ˜¯çº¿ç¨‹ä¸ä¼šè¿è¡Œçš„æœ€çŸ­æ—¶é—´ã€‚å› æ­¤ï¼Œ<strong>sleep() æ–¹æ³•ä¸èƒ½ä¿è¯è¯¥çº¿ç¨‹ç¡çœ åˆ°æœŸåå°±å¼€å§‹æ‰§è¡Œ</strong>ã€‚</p>
<p><strong>sleep()æ˜¯é™æ€æ–¹æ³•</strong>ï¼Œåªèƒ½æ§åˆ¶å½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ã€‚</p>
<h4 id="wait-æ–¹æ³•"><a href="#wait-æ–¹æ³•" class="headerlink" title="wait æ–¹æ³•"></a>wait æ–¹æ³•</h4><p>å› ä¸º wait() æ–¹æ³•ä¼šé‡Šæ”¾é”ï¼Œæ‰€ä»¥å¿…é¡»è¦åœ¨ synchronized å—ä¸­è°ƒç”¨ï¼ˆä¹Ÿå°±æ˜¯è¦å…ˆæ‹¿åˆ°é”ï¼Œä¸ç„¶å°±æ²¡æœ‰é”å¯ä»¥æ˜¯é‡Šæ”¾äº†ï¼‰ã€‚</p>
<h4 id="join-æ–¹æ³•"><a href="#join-æ–¹æ³•" class="headerlink" title="join æ–¹æ³•"></a>join æ–¹æ³•</h4><p>join() å¯¼è‡´çº¿ç¨‹æ ˆå‘ç”Ÿäº†å˜åŒ–ï¼Œå½“ç„¶è¿™äº›å˜åŒ–éƒ½æ˜¯ç¬æ—¶çš„ã€‚</p>
<p>join() æ–¹æ³•æœ‰<strong>å¸¦è¶…æ—¶é™åˆ¶çš„é‡è½½ç‰ˆæœ¬</strong>ã€‚ ä¾‹å¦‚ <code>t.join(5000);</code>åˆ™è®©çº¿ç¨‹ç­‰å¾… 5000 æ¯«ç§’ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œåˆ™åœæ­¢ç­‰å¾…ï¼Œå˜ä¸ºå¯è¿è¡ŒçŠ¶æ€ã€‚</p>
<h4 id="yield-æ–¹æ³•"><a href="#yield-æ–¹æ³•" class="headerlink" title="yield æ–¹æ³•"></a>yield æ–¹æ³•</h4><p>yield() æ–¹æ³•ä¼šåœæ­¢å½“å‰çº¿ç¨‹ï¼ˆä½¿ä¹‹è¿›å…¥å¯è¿è¡ŒçŠ¶æ€ï¼‰ï¼Œè®©åŒç­‰ä¼˜å…ˆæƒçš„çº¿ç¨‹è¿è¡Œã€‚å¦‚æœæ²¡æœ‰åŒç­‰ä¼˜å…ˆæƒçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆ yield() æ–¹æ³•å°†ä¸ä¼šèµ·ä½œç”¨ã€‚ å®é™…ä¸­æ— æ³•ä¿è¯ yield() è¾¾åˆ°è®©æ­¥ç›®çš„ï¼Œå› ä¸º<strong>è®©æ­¥çš„çº¿ç¨‹(å›åˆ°å¯æ‰§è¡ŒçŠ¶æ€)è¿˜æœ‰å¯èƒ½è¢«çº¿ç¨‹è°ƒåº¦ç¨‹åºå†æ¬¡é€‰ä¸­</strong>ã€‚</p>
<h2 id="ç®€è®°ï¼š"><a href="#ç®€è®°ï¼š" class="headerlink" title="ç®€è®°ï¼š"></a>ç®€è®°ï¼š</h2><h3 id="ç¡¬ä»¶æ•ˆç‡ä¸ä¸€è‡´æ€§"><a href="#ç¡¬ä»¶æ•ˆç‡ä¸ä¸€è‡´æ€§" class="headerlink" title="ç¡¬ä»¶æ•ˆç‡ä¸ä¸€è‡´æ€§"></a>ç¡¬ä»¶æ•ˆç‡ä¸ä¸€è‡´æ€§</h3><p>å› ä¸ºå¤„ç†å™¨éœ€è¦è¯»å–å’Œè¿”å›æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦å­˜å‚¨å™¨ã€‚è€Œå­˜å‚¨å™¨çš„é€Ÿåº¦ä¸å¤„ç†å™¨çš„è¿ç®—é€Ÿåº¦ç›¸å·®å‡ ä¸ªæ•°é‡çº§ã€‚æ‰€ä»¥å¼•å…¥äº†ç¼“å­˜ï¼Œå¼•å…¥ç¼“å­˜çš„åŒæ—¶ä¹Ÿå¼•å…¥äº†ä¸»å­˜ä¸ç¼“å­˜ä¸­çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
<p>ä¸ºäº†å……åˆ†åˆ©ç”¨å¤„ç†å™¨çš„è¿ç®—èƒ½åŠ›ï¼Œé™¤äº†å¼•å…¥ç¼“å­˜ä»¥å¤–ï¼Œå¤„ç†å™¨å¯èƒ½è¿˜ä¼šå¯¹è¾“å…¥çš„ä»£ç è¿›è¡Œæ¥ä¹±åºæ‰§è¡Œ(ä¸å½±å“ç»“æœ)ã€‚JVM çš„å³æ—¶ç¼–è¯‘å™¨ä¸­ä¹Ÿæœ‰ç±»ä¼¼äºæŒ‡ä»¤é‡æ’çš„ä¼˜åŒ–ã€‚</p>
<h3 id="å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜"><a href="#å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜" class="headerlink" title="å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜"></a>å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜</h3><p>æ¯æ¡çº¿ç¨‹æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå·¥ä½œå†…å­˜æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå¦‚æœè¦äº¤æ¢å¿…é¡»é€šè¿‡ä¸»å†…å­˜ã€‚<br>è‹¥è¦æŠŠäºŒè€…ä¸ Java ä¸­çš„å†…å­˜åŒºåŸŸå¯¹åº”èµ·æ¥ï¼Œåˆ™å·¥ä½œå†…å­˜åƒå¯¹åº”è™šæ‹Ÿæœºæ ˆä¸­çš„éƒ¨åˆ†åŒºåŸŸï¼Œä¸»å†…å­˜å¯¹åº”äºå †ä¸­çš„å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†ã€‚</p>
<p>è™šæ‹Ÿæœºå¯èƒ½ä¼šè®©<strong>å·¥ä½œå†…å­˜</strong>ä¼˜å…ˆå­˜å‚¨åœ¨å¯„å­˜å™¨æˆ–è€…é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå› ä¸º<strong>ç¨‹åºè¿è¡Œæ—¶ä¸»è¦è®¿é—®è¯»å†™çš„æ˜¯å·¥ä½œå†…å­˜</strong> ã€‚</p>
<h3 id="å†…å­˜é—´çš„äº¤äº’æ“ä½œ"><a href="#å†…å­˜é—´çš„äº¤äº’æ“ä½œ" class="headerlink" title="å†…å­˜é—´çš„äº¤äº’æ“ä½œ"></a>å†…å­˜é—´çš„äº¤äº’æ“ä½œ</h3><p>(lock)read load use assign store write(unlock)</p>
<ul>
<li>ä¸€ä¸ªå˜é‡åœ¨åŒä¸€æ—¶åˆ»åªèƒ½è¢«æŸ<strong>ä¸€ä¸ª</strong>çº¿ç¨‹ lockã€‚ä½†æ˜¯è¯¥çº¿ç¨‹å¯ä»¥å¯¹è¿™ä¸ªå˜é‡ lock å¤šæ¬¡ã€‚</li>
<li>æŸäº›æ“ä½œå¿…é¡»æˆå¯¹å‡ºç°ï¼Œæ¯”å¦‚ read ä¸ load ã€store ä¸ writeã€‚</li>
<li>å¯¹æŸä¸ªå˜é‡æ‰§è¡Œäº† assign æ“ä½œï¼Œå¿…é¡»æŠŠå®ƒåŒæ­¥å›ä¸»å†…å­˜ã€‚</li>
</ul>
<h3 id="volatile-å…³é”®å­—"><a href="#volatile-å…³é”®å­—" class="headerlink" title="volatile å…³é”®å­—"></a>volatile å…³é”®å­—</h3><p>ä¿è¯å¯è§æ€§ã€ç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚</p>
<p>æ— æ³•ä¿è¯ä¸€è‡´æ€§ã€‚ä»¥å¤šçº¿ç¨‹ä¿®æ”¹å˜é‡è‡ªå¢ä¸ºä¾‹ï¼Œå½“çº¿ç¨‹ A è¯»å–äº†è¯¥å˜é‡(æ­¤æ—¶å˜é‡çš„å€¼æ˜¯æ­£ç¡®çš„)ä½†æ˜¯è¿˜æœªè¿›è¡Œ +1 æ“ä½œï¼Œæ­¤å˜é‡çš„å€¼è¢«çº¿ç¨‹ B æ‰§è¡Œäº† +1 æ“ä½œ(æ›´æ–°åä¼šé€šçŸ¥æ‰€æœ‰çº¿ç¨‹ï¼Œä½†æ˜¯ç”±äº çº¿ç¨‹ A å·²ç»è¯»å–è¿‡è¯¥å€¼äº†ä½†æ˜¯ç”±è¿˜æ²¡æœ‰è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šå¾—åˆ°æœ€æ–°çš„å€¼)ï¼Œä½†æ˜¯ä¹‹åçº¿ç¨‹ A ä¼šå¯¹æ—§å€¼è¿›è¡Œè‡ªå¢æ“ä½œï¼Œå¯¼è‡´ç»“æœé”™è¯¯ã€‚</p>
<ul>
<li>æ³¨ï¼ši++ ç”± 4 æ¡å­—èŠ‚ç æŒ‡ä»¤æ„æˆã€‚ä»å­—èŠ‚ç å±‚é¢è§£é‡Šï¼šå½“ getStatic æŒ‡ä»¤æŠŠ race çš„å€¼(è¿›è¡Œè‡ªå¢æ“ä½œçš„å˜é‡)è¯»å–åˆ°æ“ä½œæ ˆé¡¶æ—¶ï¼Œvolatile ä¿è¯ race çš„å€¼åœ¨æ­¤æ—¶æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œ iconst_1ã€add è¿™äº›æŒ‡ä»¤æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½å·²ç»æŠŠ  race çš„å€¼åŠ å¤§äº†ï¼Œè€Œåœ¨æ“ä½œæ ˆé¡¶çš„å€¼å°±å˜æˆäº†è¿‡æœŸçš„æ•°æ®ï¼Œæ‰€ä»¥ putStatic æŒ‡ä»¤æ‰§è¡Œåå°±å¯èƒ½æŠŠè¾ƒå°çš„ race å€¼åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚</li>
</ul>
<p>åœ¨<strong>ä¸ç¬¦åˆ</strong>ä»¥ä¸‹ä¸¤æ¡è§„åˆ™çš„è¿ç®—åœºæ™¯ä¸­ï¼Œ<strong>ä»ç„¶è¦é€šè¿‡åŠ é”</strong>æ¥ä¿è¯åŸå­æ€§ã€‚</p>
<ul>
<li>è¿ç®—ç»“æœä¸ä¾èµ–å˜é‡å½“å‰çš„å€¼ or åªè¦å•ä¸€çš„çº¿ç¨‹ä¿®æ”¹å˜é‡çš„å€¼</li>
<li>å˜é‡ä¸éœ€è¦ä¸å…¶ä»–çš„çŠ¶æ€å˜é‡å…±åŒå‚ä¸ä¸å˜çº¦æŸã€‚</li>
</ul>
<p>æ™®é€šå˜é‡åªä¿è¯ã€Œç»“æœæ­£ç¡®ã€ï¼Œvolitale å˜é‡è¿˜ä¿è¯ã€Œç¨‹åºæ­£ç¡®ã€</p>
<ul>
<li>ã€Œç¨‹åºæ­£ç¡®ã€æŒ‡çš„æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œ</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li>ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ </li>
<li><a href="https://tech.meituan.com/java-memory-reordering.html" target="_blank" rel="noopener">Java å†…å­˜è®¿é—®é‡æ’åºçš„ç ”ç©¶</a></li>
<li><a href="http://uule.iteye.com/blog/1100799" target="_blank" rel="noopener">çº¿ç¨‹çŠ¶æ€çš„è½¬æ¢</a></li>
<li><a href="https://segmentfault.com/a/1190000011458941" target="_blank" rel="noopener">ä»Javaå¤šçº¿ç¨‹å¯è§æ€§è°ˆHappens-BeforeåŸåˆ™</a></li>
</ul>
<p>è‹¥æœ¬æ–‡ä¸­æœ‰ä¸æ­£ç¡®çš„ç»“è®ºã€è¯´æ³•ï¼Œè¯·å¤§å®¶æŒ‡å‡ºï¼Œå…±åŒæ¢è®¨ï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢!</p>
]]></content>
      
        <categories>
            
            <category> jvm </category>
            
            <category> å¹¶å‘ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> jvm </tag>
            
            <tag> å¹¶å‘ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java çº¿ç¨‹å®‰å…¨ä¸é”ä¼˜åŒ–]]></title>
      <url>https://timlin-pro.github.io/blog/2017/09/11/Java%20%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/</url>
      <content type="html"><![CDATA[<h2 id="1-çº¿ç¨‹å®‰å…¨"><a href="#1-çº¿ç¨‹å®‰å…¨" class="headerlink" title="1.çº¿ç¨‹å®‰å…¨"></a>1.çº¿ç¨‹å®‰å…¨</h2><p>å½“æˆ‘ä»¬è°ˆçº¿ç¨‹å®‰å…¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ˆäº›ä»€ä¹ˆï¼Ÿ</p>
<p>å…ˆçœ‹çœ‹ã€Œçº¿ç¨‹å®‰å…¨ã€çš„å®šä¹‰ï¼š</p>
<p>å½“<strong>å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªå¯¹è±¡</strong>æ—¶ï¼Œå¦‚æœ<strong>ä¸ç”¨è€ƒè™‘è¿™äº›çº¿ç¨‹åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸‹çš„è°ƒåº¦å’Œäº¤æ›¿æ‰§è¡Œ</strong>ï¼Œä¹Ÿä¸éœ€è¦è¿›è¡Œ<strong>é¢å¤–</strong>çš„åŒæ­¥ï¼Œæˆ–è€…åœ¨è°ƒç”¨æ–¹è¿›è¡Œä»»ä½•å…¶ä»–çš„åè°ƒæ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºéƒ½å¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<h3 id="1-1-Java-è¯­è¨€ä¸­çš„çº¿ç¨‹å®‰å…¨"><a href="#1-1-Java-è¯­è¨€ä¸­çš„çº¿ç¨‹å®‰å…¨" class="headerlink" title="1.1 Java è¯­è¨€ä¸­çš„çº¿ç¨‹å®‰å…¨"></a>1.1 Java è¯­è¨€ä¸­çš„çº¿ç¨‹å®‰å…¨</h3><p>å¯å°† Java è¯­è¨€ä¸­çš„å„ç§æ“ä½œå…±äº«çš„æ•°æ®åˆ†ä¸ºä»¥ä¸‹ 5 ç±»ï¼šä¸å¯å˜ã€ç»å¯¹çº¿ç¨‹å®‰å…¨ã€ç›¸å¯¹çº¿ç¨‹å®‰å…¨ã€çº¿ç¨‹å…¼å®¹å’Œçº¿ç¨‹å¯¹ç«‹ã€‚</p>
<a id="more"></a>
<h4 id="1-ä¸å¯å˜"><a href="#1-ä¸å¯å˜" class="headerlink" title="1. ä¸å¯å˜"></a>1. ä¸å¯å˜</h4><p>åªè¦ä¸€ä¸ªä¸å¯å˜å¯¹è±¡è¢«æ­£ç¡®åœ°æ„å»ºå‡ºæ¥ï¼ˆæ²¡æœ‰ this å¼•ç”¨é€ƒé€¸çš„æƒ…å†µï¼‰ï¼Œé‚£ä¹ˆå…¶å¤–éƒ¨çš„å¯è§çŠ¶æ€æ°¸è¿œä¹Ÿä¸ä¼šæ”¹å˜ã€‚</p>
<p>final  + åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåˆ™è¯¥å˜é‡ä¸ºä¸å¯å˜å˜é‡<br>final  + å¯¹è±¡ï¼Œæ— æ³•ä¿è¯å¯¹è±¡æ˜¯ä¸å¯å˜çš„</p>
<p>å¦‚ä½•ä¿è¯å¯¹è±¡çš„è¡Œä¸ºä¸ä¼šå¯¹å…¶çŠ¶æ€äº§ç”Ÿä»»ä½•å½±å“ï¼Ÿæœ€ç®€å•çš„å°±æ˜¯<strong>å°†å¯¹è±¡ä¸­å¸¦æœ‰çŠ¶æ€çš„å˜é‡éƒ½å£°æ˜ä¸º final</strong>ã€‚</p>
<p>Java API ä¸­å±äºä¸å¯å˜çš„ç±»æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>String</li>
<li>åŸºç¡€æ•°æ®ç±»å‹åŒ…è£…ç±»</li>
<li>BigInteger</li>
<li>BigDecimal </li>
</ul>
<p>æ³¨æ„ï¼šåŒä¸º Number çš„åŸå­ç±» AtomicInteger å’Œ AtomicLong åˆ™å¹¶éä¸å¯å˜çš„ã€‚å› ä¸ºå®ƒä»¬éƒ½æœ‰ set æ–¹æ³•ï¼Œå¯ä»¥æ”¹å˜å¯¹è±¡çš„çŠ¶æ€ã€‚</p>
<h4 id="2-ç»å¯¹çº¿ç¨‹å®‰å…¨"><a href="#2-ç»å¯¹çº¿ç¨‹å®‰å…¨" class="headerlink" title="2. ç»å¯¹çº¿ç¨‹å®‰å…¨"></a>2. ç»å¯¹çº¿ç¨‹å®‰å…¨</h4><p>ç»å¯¹çº¿ç¨‹å®‰å…¨çš„å®šä¹‰æ˜¯å¾ˆä¸¥æ ¼çš„ã€‚Java API ä¸­æ ‡æ³¨è‡ªå·±çš„æ˜¯çº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œå¤§å¤šæ•°éƒ½ä¸æ˜¯ç»å¯¹çš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>æ —å­ï¼šVector</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> jvm.ch13;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Vector;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VectorTest</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Vector&lt;Integer&gt; sIntegerVector = <span class="keyword">new</span> Vector&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">                sIntegerVector.add(i);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Thread removeThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sIntegerVector.size(); i++) &#123;</div><div class="line">                    sIntegerVector.remove(i);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            Thread printThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sIntegerVector.size(); i++) &#123;</div><div class="line">                    System.out.println(sIntegerVector.get(i));</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            removeThread.start();</div><div class="line">            printThread.start();</div><div class="line">            <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">20</span>) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç å¯èƒ½ä¼šæŠ¥ ArrayIndexOutOfBoundException</p>
<p>å› ä¸ºå¯èƒ½å‡ºç°ä¸€ä¸ªçº¿ç¨‹æ°å¥½åœ¨ä¸€ä¸ªé”™è¯¯çš„æ—¶é—´åˆ é™¤äº†ä¸€ä¸ªå…ƒç´ ï¼Œå¯¼è‡´ i å…ƒç´ å·²ç»ä¸å†å¯ç”¨ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è®¿é—®äº† i å…ƒç´ ã€‚ï¼ˆæ¯”å¦‚ï¼š<strong>get(i) è¿›å…¥ç­‰å¾…é”æœŸé—´ï¼Œremove(i) åˆšå¥½æ‰§è¡Œå®Œäº†</strong>ï¼‰ã€‚</p>
<p>è§£å†³ï¼šæ“ä½œæ—¶åŠ ä¸Šé”ï¼Œä½¿å¾—å¤åˆæ“ä½œå˜ä¸ºåŸå­æ“ä½œã€‚</p>
<p>åŸå­æ“ä½œä¸å¤åˆæ“ä½œç®€ä»‹ï¼š</p>
<ul>
<li>åŸå­æ“ä½œï¼šä¸å¯åˆ†å‰²çš„æ“ä½œï¼Œè¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥ã€‚</li>
<li><strong>å¤åˆæ“ä½œï¼šå¯åˆ†å‰²çš„æ“ä½œ</strong>ï¼Œå¯èƒ½å‡ºç°æ•°æ®å¤±æ•ˆçš„é—®é¢˜ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Thread removeThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">    <span class="keyword">synchronized</span> (sIntegerVector) &#123;<span class="comment">//åŠ ä¸Šé”ä½¿ä¹‹æˆä¸ºåŸå­æ“ä½œ</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sIntegerVector.size(); i++) &#123;</div><div class="line">            sIntegerVector.remove(i);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">Thread printThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</div><div class="line">    <span class="keyword">synchronized</span> (sIntegerVector) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sIntegerVector.size(); i++) &#123;</div><div class="line">            System.out.println(sIntegerVector.get(i));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆæ˜¯ä½¿ç”¨ Vector å¯¹è±¡ä½œä¸ºé”ï¼Ÿå› ä¸º Vector  å†…éƒ¨æ˜¯ä½¿ç”¨è‡ªå¸¦çš„é”æ¥å®ç°çš„ã€‚</p>
<h4 id="3-ç›¸å¯¹çº¿ç¨‹å®‰å…¨"><a href="#3-ç›¸å¯¹çº¿ç¨‹å®‰å…¨" class="headerlink" title="3. ç›¸å¯¹çº¿ç¨‹å®‰å…¨"></a>3. ç›¸å¯¹çº¿ç¨‹å®‰å…¨</h4><p>å³é€šå¸¸æ„ä¹‰ä¸Šæ‰€è®²çš„çº¿ç¨‹å®‰å…¨ã€‚å®ƒéœ€è¦ä¿è¯å¯¹è¿™ä¸ªå¯¹è±¡å•ç‹¬æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè°ƒç”¨æ—¶å°±ä¸éœ€è¦åšé¢å¤–çš„ä¿éšœæªæ–½ã€‚</p>
<p><strong>å¯¹äºä¸€äº›ç‰¹å®šé¡ºåºçš„è¿ç»­è°ƒç”¨ï¼Œå°±å¯èƒ½éœ€è¦åœ¨è°ƒç”¨ç«¯ä½¿ç”¨<em>é¢å¤–çš„åŒæ­¥æ‰‹æ®µ</em>æ¥ä¿è¯è°ƒç”¨çš„æ­£ç¡®æ€§</strong>ã€‚</p>
<p>Java API ä¸­å¤§éƒ¨åˆ†çº¿ç¨‹å®‰å…¨çš„ç±»éƒ½å±äºè¿™ç§ç±»å‹ï¼š</p>
<ul>
<li><code>Vectorï¼ŒHashTableï¼ŒCollections.sychronizedCollection()</code></li>
</ul>
<h4 id="4-çº¿ç¨‹å…¼å®¹"><a href="#4-çº¿ç¨‹å…¼å®¹" class="headerlink" title="4. çº¿ç¨‹å…¼å®¹"></a>4. çº¿ç¨‹å…¼å®¹</h4><p>ä¹Ÿå°±æ˜¯å¹³å¸¸æ‰€è¯´çš„çº¿ç¨‹ä¸å®‰å…¨ç±»ã€‚å¯¹è±¡æœ¬èº«å¹¶ä¸å®‰å…¨ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åœ¨è°ƒç”¨ç«¯æ­£ç¡®åœ°ä½¿ç”¨åŒæ­¥æ‰‹æ®µæ¥ä¿è¯å¯¹è±¡å­å•Šå¹¶å‘ç¯å¢ƒä¸­å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ã€‚</p>
<p>æ¯”å¦‚ï¼šArrayListã€HashKMap</p>
<h4 id="5-çº¿ç¨‹å¯¹ç«‹"><a href="#5-çº¿ç¨‹å¯¹ç«‹" class="headerlink" title="5. çº¿ç¨‹å¯¹ç«‹"></a>5. çº¿ç¨‹å¯¹ç«‹</h4><p>åœ¨è°ƒç”¨ç«¯æ˜¯å¦ä½¿ç”¨åŒæ­¥æ‰‹æ®µéƒ½æ— æ³•å†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚</p>
<ul>
<li>è¿™ç§æ’æ–¥å¤šçº¿ç¨‹ä»£ç å¾ˆå°‘å‡ºç°ã€‚</li>
</ul>
<h3 id="çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•"><a href="#çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•" class="headerlink" title="çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•"></a>çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•</h3><p>çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼šäº’æ–¥åŒæ­¥ã€éé˜»å¡åŒæ­¥ã€æ— åŒæ­¥æ–¹æ¡ˆã€‚</p>
<h4 id="1-äº’æ–¥åŒæ­¥"><a href="#1-äº’æ–¥åŒæ­¥" class="headerlink" title="1. äº’æ–¥åŒæ­¥"></a>1. äº’æ–¥åŒæ­¥</h4><p>ã€Œäº’æ–¥åŒæ­¥ã€çš„æ„æ€æ˜¯é€šè¿‡äº’æ–¥æ¥å®ç°åŒæ­¥ã€‚<br><strong>åŒæ­¥</strong>æ˜¯æŒ‡åœ¨å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«æ•°æ®çš„æ—¶å€™ï¼Œä¿è¯å…±äº«æ•°æ®åœ¨<strong>åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªï¼ˆæˆ–è€…ä¸€äº›ï¼Œä½¿ç”¨ä¿¡å·é‡çš„æ—¶å€™ï¼‰çº¿ç¨‹ä½¿ç”¨</strong>ã€‚<strong>ä¸´ç•ŒåŒºã€äº’æ–¥é‡ã€ä¿¡å·é‡éƒ½æ˜¯ä¸»è¦çš„äº’æ–¥å®ç°æ–¹å¼</strong>ã€‚</p>
<p>æœ€åŸºæœ¬çš„äº’æ–¥åŒæ­¥å®ç°æ–¹æ³•å°±æ˜¯ä½¿ç”¨ synchronized å…³é”®å­—ã€‚synchronized å…³é”®å­—ç»è¿‡ç¼–è¯‘ä¹‹åï¼Œä¼šåœ¨åŒæ­¥å—çš„å‰ååˆ†åˆ«å½¢æˆ monitorenterã€monitorexit ä¸¤æ¡æŒ‡ä»¤ã€‚æ ¹æ®è™šæ‹Ÿæœºè§„èŒƒçš„è¦æ±‚ï¼Œ</p>
<ul>
<li>åœ¨æ‰§è¡Œ monitorenter æŒ‡ä»¤æ—¶ï¼Œé¦–å…ˆè¦å°è¯•è·å–å¯¹è±¡çš„é”ã€‚å¦‚æœè¿™ä¸ªå¯¹è±¡æ²¡è¢«é”å®šï¼Œæˆ–è€…å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†é‚£ä¸ªå¯¹è±¡çš„é”ï¼ŒæŠŠé”çš„è®¡æ•°å™¨åŠ  1ï¼Œ</li>
</ul>
<ul>
<li>åœ¨æ‰§è¡Œ monitorexit æŒ‡ä»¤æ—¶ä¼šå°†é”è®¡æ•°å™¨å‡ 1ï¼Œå½“è®¡æ•°å™¨ä¸º 0 æ—¶ï¼Œé”å°±è¢«é‡Šæ”¾ã€‚å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦<strong>é˜»å¡ç­‰å¾…</strong>ï¼Œç›´åˆ°å¯¹è±¡é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚</li>
</ul>
<p>ä¸Šè¿°æè¿°ä¸­æœ‰ä¸¤ç‚¹æ˜¯éœ€è¦ç‰¹åˆ«æ³¨æ„çš„ã€‚</p>
<ul>
<li>é¦–å…ˆï¼Œsynchronized åŒæ­¥å—å¯¹åŒä¸€æ¡çº¿ç¨‹æ¥è¯´æ˜¯<strong>å¯é‡å…¥çš„</strong>ï¼Œä¸ä¼šå‡ºç°è‡ªå·±æŠŠè‡ªå·±é”æ­»çš„é—®é¢˜ã€‚</li>
<li>å…¶æ¬¡ï¼ŒåŒæ­¥å—åœ¨å·²è¿›å…¥çš„çº¿ç¨‹æ‰§è¡Œå®Œä¹‹å‰ï¼Œä¼š<strong>é˜»å¡åé¢å…¶ä»–çº¿ç¨‹çš„è¿›å…¥</strong>ã€‚</li>
</ul>
<p>Java çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°<strong>æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹</strong>ä¹‹ä¸Šçš„ï¼Œå¦‚æœè¦é˜»å¡æˆ–å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿæ¥å¸®å¿™å®Œæˆï¼Œè¿™å°±éœ€è¦<strong>ä»ç”¨æˆ·æ€è½¬æ¢åˆ°æ ¸å¿ƒæ€ä¸­</strong>ï¼Œå› æ­¤<strong>çŠ¶æ€è½¬æ¢éœ€è¦è€—è´¹å¾ˆå¤šçš„å¤„ç†å™¨æ—¶é—´</strong>ã€‚</p>
<p>é™¤äº† synchronized ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ java.util.concurrentï¼ˆç®€ç§° J.U.Cï¼‰åŒ…ä¸­çš„é‡å…¥é”ï¼ˆReentrantLockï¼‰æ¥å®ç°åŒæ­¥ï¼Œåœ¨åŸºæœ¬ç”¨æ³•ä¸Šï¼ŒReentrantLock ä¸ synchronized å¾ˆç›¸ä¼¼ï¼Œä»–ä»¬<strong>éƒ½å…·å¤‡ä¸€æ ·çš„çº¿ç¨‹é‡å…¥ç‰¹æ€§</strong>ï¼Œä¸åŒç‚¹è¡¨ç°åœ¨ä»£ç å†™æ³•ä¸Š</p>
<ul>
<li>ä¸€ä¸ªè¡¨ç°ä¸º API å±‚é¢çš„äº’æ–¥é”ï¼ˆlock() å’Œ unlock() æ–¹æ³•é…åˆ try/finally è¯­å¥å—æ¥å®Œæˆï¼‰ï¼Œ</li>
<li>å¦ä¸€ä¸ªè¡¨ç°ä¸ºåŸç”Ÿè¯­æ³•å±‚é¢çš„äº’æ–¥é”ã€‚</li>
</ul>
<p>ç›¸æ¯” synchronized,ReentrantLock å¢åŠ äº†ä¸€äº›<strong>é«˜çº§åŠŸèƒ½</strong>ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ 3 é¡¹ï¼š</p>
<ul>
<li><strong>ç­‰å¾…å¯ä¸­æ–­</strong>,å¦‚æœæŒæœ‰é”çš„çº¿ç¨‹é•¿æ—¶é—´ä¸é‡Šæ”¾é”ï¼Œæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ã€‚</li>
<li>å…¬å¹³é”<ul>
<li>å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»<strong>æŒ‰ç…§ç”³è¯·é”çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”</strong>; </li>
<li>éå…¬å¹³é”åˆ™ä¸ä¿è¯è¿™ä¸€ç‚¹ï¼Œåœ¨é”è¢«é‡Šæ”¾æ—¶ï¼Œä»»ä½•ä¸€ä¸ªç­‰å¾…é”çš„çº¿ç¨‹éƒ½æœ‰æœºä¼šè·å¾—é”ã€‚</li>
<li>synchronized ä¸­çš„é”æ˜¯éå…¬å¹³çš„ï¼Œ</li>
<li>ReentrantLock <strong>é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯éå…¬å¹³çš„</strong>ï¼Œä½†å¯ä»¥é€šè¿‡å¸¦å¸ƒå°”å€¼çš„æ„é€ å‡½æ•°è¦æ±‚ä½¿ç”¨å…¬å¹³é”ã€‚</li>
</ul>
</li>
<li>é”<strong>å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶</strong><ul>
<li>ä¸€ä¸ª ReentrantLock å¯¹è±¡<strong>å¯ä»¥åŒæ—¶ç»‘å®šå¤šä¸ª Condition å¯¹è±¡</strong></li>
<li>è€Œåœ¨ synchronized ä¸­ï¼Œé”å¯¹è±¡çš„ wait() å’Œ notify() æˆ– notifyAll() æ–¹æ³•<strong>å¯ä»¥å®ç°ä¸€ä¸ªéšå«çš„æ¡ä»¶</strong>ï¼Œå¦‚æœè¦å’Œå¤šäºä¸€ä¸ªçš„æ¡ä»¶å…³è”çš„æ—¶å€™ï¼Œå°±ä¸å¾—ä¸é¢å¤–åœ°æ·»åŠ ä¸€ä¸ªé”ã€‚</li>
</ul>
</li>
</ul>
<h5 id="ReentrantLock-è¿˜æ˜¯-synchronizedï¼Ÿ"><a href="#ReentrantLock-è¿˜æ˜¯-synchronizedï¼Ÿ" class="headerlink" title="ReentrantLock è¿˜æ˜¯ synchronizedï¼Ÿ"></a>ReentrantLock è¿˜æ˜¯ synchronizedï¼Ÿ</h5><p>å…³äºæ€§èƒ½ï¼š<strong>Java 1.6 å‘å¸ƒä¹‹åï¼Œsynchronized ä¸ ReentrantLock çš„æ€§èƒ½åŸºæœ¬ä¸Šæ˜¯å®Œå…¨æŒå¹³äº†</strong>ã€‚å› æ­¤ï¼ŒJava 1.6 æˆ–ä»¥ä¸Šï¼Œæ€§èƒ½å› ç´ å°±ä¸å†æ˜¯é€‰æ‹© ReentrantLock çš„ç†ç”±äº†ï¼Œè™šæ‹Ÿæœºåœ¨æœªæ¥çš„æ€§èƒ½æ”¹è¿›ä¸­è‚¯å®šä¹Ÿä¼šæ›´åŠ åå‘äºåŸç”Ÿçš„ synchronizedã€‚</p>
<p>å› æ­¤åœ¨<strong>ä¸éœ€è¦ç”¨åˆ° ReentrantLock ä¸‰ä¸ªç‰¹æ€§çš„æƒ…å†µä¸‹ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ synchronized æ¥è¿›è¡ŒåŒæ­¥</strong>ã€‚</p>
<h4 id="2-éé˜»å¡åŒæ­¥"><a href="#2-éé˜»å¡åŒæ­¥" class="headerlink" title="2. éé˜»å¡åŒæ­¥"></a>2. éé˜»å¡åŒæ­¥</h4><p>äº’æ–¥åŒæ­¥æœ€ä¸»è¦çš„é—®é¢˜å°±æ˜¯è¿›è¡Œçº¿ç¨‹é˜»å¡å’Œå”¤é†’æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤è¿™ç§åŒæ­¥ä¹Ÿç§°ä¸º<strong>é˜»å¡åŒæ­¥</strong>ï¼ˆBlocking Synchronizationï¼‰ã€‚ä»å¤„ç†é—®é¢˜çš„æ–¹å¼ä¸Šè¯´ï¼Œäº’æ–¥åŒæ­¥å±äºä¸€ç§<strong>æ‚²è§‚çš„å¹¶å‘ç­–ç•¥</strong>ï¼Œ<strong>æ€»æ˜¯è®¤ä¸ºåªè¦ä¸å»åšæ­£ç¡®çš„åŒæ­¥æªæ–½ï¼ˆä¾‹å¦‚åŠ é”ï¼‰ï¼Œé‚£å°±è‚¯å®šä¼šå‡ºç°é—®é¢˜</strong>ã€‚</p>
<p><strong>åŸºäºå†²çªæ£€æµ‹</strong>çš„<strong>ä¹è§‚å¹¶å‘ç­–ç•¥</strong>ï¼Œé€šä¿—åœ°è¯´ï¼Œå°±æ˜¯å…ˆè¿›è¡Œæ“ä½œï¼Œ</p>
<ul>
<li>å¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹äº‰ç”¨å…±äº«æ•°æ®ï¼Œé‚£æ“ä½œå°±æˆåŠŸäº†ï¼›</li>
<li>å¦‚æœå…±äº«æ•°æ®æœ‰äº‰ç”¨ï¼Œäº§ç”Ÿäº†å†²çªï¼Œé‚£å°±å†é‡‡å–å…¶ä»–çš„<strong>è¡¥å¿æªæ–½</strong>ï¼ˆæœ€å¸¸è§çš„è¡¥å¿æªæ–½å°±æ˜¯ä¸æ–­åœ°é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼‰ï¼Œè¿™ç§ä¹è§‚çš„å¹¶å‘ç­–ç•¥çš„<strong>è®¸å¤šå®ç°éƒ½ä¸éœ€è¦æŠŠçº¿ç¨‹æŒ‚èµ·</strong>ï¼Œå› æ­¤è¿™ç§åŒæ­¥æ“ä½œç§°ä¸º<strong>éé˜»å¡åŒæ­¥</strong>ï¼ˆNon-Blocking Synchronizationï¼‰ã€‚</li>
</ul>
<p>ä¸ºä»€ä¹ˆè¯´ä½¿ç”¨ä¹è§‚å¹¶å‘ç­–ç•¥éœ€è¦ â€œç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•â€ æ‰èƒ½è¿›è¡Œå‘¢ï¼Ÿ</p>
<ul>
<li>å› ä¸ºæˆ‘ä»¬<strong>éœ€è¦æ“ä½œå’Œå†²çªæ£€æµ‹è¿™ä¸¤ä¸ªæ­¥éª¤å…·å¤‡åŸå­æ€§</strong>ï¼Œé ä»€ä¹ˆæ¥ä¿è¯å‘¢ï¼Ÿå¦‚æœè¿™é‡Œå†ä½¿ç”¨äº’æ–¥åŒæ­¥æ¥ä¿è¯å°±å¤±å»æ„ä¹‰äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½é ç¡¬ä»¶æ¥å®Œæˆè¿™ä»¶äº‹æƒ…ï¼Œ<strong>ç¡¬ä»¶ä¿è¯ä¸€ä¸ªä»è¯­ä¹‰ä¸Šçœ‹èµ·æ¥éœ€è¦å¤šæ¬¡æ“ä½œçš„è¡Œä¸ºåªé€šè¿‡ä¸€æ¡å¤„ç†å™¨æŒ‡ä»¤å°±èƒ½å®Œæˆ</strong>ã€‚</li>
<li>è¿™ç±»æŒ‡ä»¤å¸¸ç”¨çš„æœ‰ï¼š<ul>
<li>æµ‹è¯•å¹¶è®¾ç½®ï¼ˆTest-and-Setï¼‰ã€‚</li>
<li>è·å–å¹¶å¢åŠ ï¼ˆFetch-and-Incrementï¼‰ã€‚</li>
<li>äº¤æ¢ï¼ˆSwapï¼‰ã€‚</li>
<li>==æ¯”è¾ƒå¹¶äº¤æ¢ï¼ˆCompare-and-Swapï¼Œä¸‹æ–‡ç§° CAS==ï¼‰ã€‚</li>
<li>åŠ è½½é“¾æ¥/æ¡ä»¶å­˜å‚¨ï¼ˆLoad-Linked/Store-Conditionalï¼Œä¸‹æ–‡ç§° LL/SCï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p>Java 1.5 ä¹‹åï¼ŒJava ç¨‹åºä¸­æ‰å¯ä»¥ä½¿ç”¨ CAS æ“ä½œï¼Œè¯¥æ“ä½œç”± sun.misc.Unsafe ç±»é‡Œé¢çš„ <code>compareAndSwapInt()</code>å’Œ <code>compareAndSwapLong()</code> ç­‰å‡ ä¸ªæ–¹æ³•åŒ…è£…æä¾›ï¼Œè™šæ‹Ÿæœºåœ¨å†…éƒ¨å¯¹è¿™äº›æ–¹æ³•åšäº†ç‰¹æ®Šå¤„ç†ï¼Œå³æ—¶ç¼–è¯‘å‡ºæ¥çš„ç»“æœå°±æ˜¯ä¸€æ¡å¹³å°ç›¸å…³çš„å¤„ç†å™¨ CAS æŒ‡ä»¤ã€‚</p>
<p><strong>CAS æŒ‡ä»¤</strong>éœ€è¦æœ‰ <strong>3 ä¸ªæ“ä½œæ•°</strong>ï¼Œåˆ†åˆ«æ˜¯<strong>å†…å­˜ä½ç½®</strong>ï¼ˆåœ¨ Java ä¸­å¯ä»¥ç®€å•ç†è§£ä¸ºå˜é‡çš„å†…å­˜åœ°å€ï¼Œç”¨ V è¡¨ç¤ºï¼‰ã€<strong>æ—§çš„é¢„æœŸå€¼</strong>ï¼ˆç”¨ A è¡¨ç¤ºï¼‰å’Œ<strong>æ–°å€¼</strong>ï¼ˆç”¨ B è¡¨ç¤ºï¼‰ã€‚<strong>CAS æŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œå½“ä¸”ä»…å½“ V ç¬¦åˆæ—§é¢„æœŸå€¼ A æ—¶ï¼Œå¤„ç†å™¨ç”¨æ–°å€¼ B æ›´æ–° V çš„å€¼ï¼Œå¦åˆ™å®ƒå°±ä¸æ‰§è¡Œæ›´æ–°</strong>ï¼Œä½†æ˜¯<strong>æ— è®ºæ˜¯å¦æ›´æ–°äº† V çš„å€¼ï¼Œéƒ½ä¼šè¿”å› V çš„æ—§å€¼</strong>ï¼Œä¸Šè¿°çš„å¤„ç†è¿‡ç¨‹æ˜¯ä¸€ä¸ª<strong>åŸå­æ“ä½œ</strong>ã€‚</p>
<p>Unsafe ç±»<strong>ä¸æ˜¯æä¾›ç»™ç”¨æˆ·ç¨‹åºè°ƒç”¨çš„ç±»</strong>ï¼ˆUnsafe.getUnsafe()çš„ä»£ç ä¸­é™åˆ¶äº†åªæœ‰å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap  ClassLoaderï¼‰åŠ è½½çš„ Class æ‰èƒ½è®¿é—®å®ƒï¼‰ï¼Œå› æ­¤ï¼Œå¦‚æœä¸é‡‡ç”¨åå°„æ‰‹æ®µï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡å…¶ä»–çš„ Java  API æ¥é—´æ¥ä½¿ç”¨å®ƒã€‚</p>
<ul>
<li>å¦‚ J.U.Cï¼ˆjava.util.concurrentï¼‰ åŒ…é‡Œé¢çš„æ•´æ•°åŸå­ç±»ï¼Œå…¶ä¸­çš„ compareAndSet()å’Œ getAndIncrement()ç­‰æ–¹æ³•éƒ½ä½¿ç”¨äº† Unsafe ç±»çš„ CAS æ“ä½œã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">incrementAndGet</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">for</span>ï¼ˆ;;ï¼‰&#123;</div><div class="line">        <span class="keyword">int</span> current = get()ï¼›</div><div class="line">        <span class="keyword">int</span> next = current+<span class="number">1</span>ï¼›</div><div class="line">        <span class="keyword">if</span>ï¼ˆcompareAndSetï¼ˆcurrent,nextï¼‰ï¼‰</div><div class="line">            <span class="keyword">return</span> nextï¼›</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CAS å­˜åœ¨çš„é—®é¢˜ï¼š</p>
<ul>
<li><strong>æ— æ³•æ¶µç›–äº’æ–¥åŒæ­¥çš„æ‰€æœ‰ä½¿ç”¨åœºæ™¯</strong></li>
<li>å­˜åœ¨==ABA é—®é¢˜==ï¼Œå€¼æ”¹äº†ä½†æ˜¯è‡ªå·±å´ä¸çŸ¥é“ã€‚<ul>
<li>æ€ä¹ˆè§£å†³ï¼Ÿ<ul>
<li>åŠ å…¥å¼•ç”¨è®¡æ•°ã€‚</li>
<li>åŠ å…¥ä¿®æ”¹è®°å½•</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>å¯é‡å…¥ä»£ç </strong>ï¼ˆReentrant Codeï¼‰ï¼šè¿™ç§ä»£ç ä¹Ÿå«åš<strong>çº¯ä»£ç </strong>ï¼ˆPure Codeï¼‰ï¼Œå¯ä»¥åœ¨ä»£ç æ‰§è¡Œçš„ä»»ä½•æ—¶åˆ»ä¸­æ–­å®ƒï¼Œè½¬è€Œå»æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç ï¼ˆåŒ…æ‹¬é€’å½’è°ƒç”¨å®ƒæœ¬èº«ï¼‰ï¼Œè€Œåœ¨æ§åˆ¶æƒè¿”å›åï¼ŒåŸæ¥çš„ç¨‹åºä¸ä¼šå‡ºç°ä»»ä½•é”™è¯¯ã€‚</p>
<p><strong>å¯é‡å…¥ä»£ç çš„ä¸€äº›å…±åŒçš„ç‰¹å¾</strong>ï¼š</p>
<ul>
<li>ä¸ä¾èµ–å­˜å‚¨åœ¨å †ä¸Šçš„æ•°æ®å’Œå…¬ç”¨çš„ç³»ç»Ÿèµ„æºã€</li>
<li>ç”¨åˆ°çš„çŠ¶æ€é‡éƒ½<strong>ç”±å‚æ•°ä¸­ä¼ å…¥</strong>ã€</li>
<li>ä¸è°ƒç”¨éå¯é‡å…¥çš„æ–¹æ³•ç­‰ã€‚</li>
</ul>
<p><strong>åˆ¤æ–­ä»£ç æ˜¯å¦å…·å¤‡å¯é‡å…¥æ€§</strong>ï¼šå¦‚æœä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒçš„<strong>è¿”å›ç»“æœæ˜¯å¯ä»¥é¢„æµ‹çš„</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦è¾“å…¥äº†ç›¸åŒçš„æ•°æ®ï¼Œå°±éƒ½èƒ½è¿”å›ç›¸åŒçš„ç»“æœï¼Œé‚£å®ƒå°±æ»¡è¶³å¯é‡å…¥æ€§çš„è¦æ±‚ï¼Œå½“ç„¶ä¹Ÿå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<h4 id="3-æ— åŒæ­¥æ–¹æ¡ˆ"><a href="#3-æ— åŒæ­¥æ–¹æ¡ˆ" class="headerlink" title="3. æ— åŒæ­¥æ–¹æ¡ˆ"></a>3. æ— åŒæ­¥æ–¹æ¡ˆ</h4><p>ä¸€ä¸ªæ•°æ®çš„å¯è§èŒƒå›´å±€é™åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œ ä¸ä¼šå­˜åœ¨å¤šçº¿ç¨‹ç«äº‰é—®é¢˜ï¼Œä¹Ÿå°±ä¸éœ€è¦è¿›è¡ŒåŒæ­¥äº†ã€‚</p>
<p>å¦‚æœä¸€ä¸ªå˜é‡è¦è¢«æŸä¸ªçº¿ç¨‹ç‹¬äº«ï¼ŒJava ä¸­å¯ä»¥é€šè¿‡ <code>java.lang.ThreadLocal</code> ç±»æ¥å®ç°çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åŠŸèƒ½ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹çš„ Thread å¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ª ThreadLocalMap å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å­˜å‚¨äº†ä¸€ç»„ä»¥ <code>ThreadLocal.threadLocalHashCode</code> ä¸ºé”®ï¼Œä»¥æœ¬åœ°çº¿ç¨‹å˜é‡ä¸ºå€¼çš„ K-V å€¼å¯¹ï¼ŒThreadLocal å¯¹è±¡å°±æ˜¯å½“å‰çº¿ç¨‹çš„ ThreadLocalMap çš„è®¿é—®å…¥å£ï¼Œæ¯ä¸€ä¸ª ThreadLocal å¯¹è±¡éƒ½åŒ…å«äº†ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ threadLocalHashCode å€¼ï¼Œä½¿ç”¨è¿™ä¸ªå€¼å°±å¯ä»¥åœ¨çº¿ç¨‹ K-V å€¼å¯¹ä¸­æ‰¾å›å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹å˜é‡ã€‚</p>
<h2 id="2-Java-ä¸­é”çš„åˆ†ç±»ä¸ä¼˜åŒ–"><a href="#2-Java-ä¸­é”çš„åˆ†ç±»ä¸ä¼˜åŒ–" class="headerlink" title="2. Java ä¸­é”çš„åˆ†ç±»ä¸ä¼˜åŒ–"></a>2. Java ä¸­é”çš„åˆ†ç±»ä¸ä¼˜åŒ–</h2><h3 id="å¯é‡å…¥é”"><a href="#å¯é‡å…¥é”" class="headerlink" title="å¯é‡å…¥é”"></a>å¯é‡å…¥é”</h3><p>åˆç§°ä¸ºã€Œé€’å½’é”ã€ï¼ŒæŒ‡çš„æ˜¯å½“åŒä¸€ä¸ªçº¿ç¨‹çš„å¤–å±‚æ–¹æ³•è·å–é”æ—¶ï¼Œè¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ã€‚</p>
<p>å¯é‡å…¥é”çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…æ­»é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Thread.sleep(<span class="number">1000</span>);</div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">        Thread.sleep(<span class="number">1000</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ç‹¬äº«-å -é”-å…±äº«é”"><a href="#ç‹¬äº«-å -é”-å…±äº«é”" class="headerlink" title="ç‹¬äº«(å )é”/å…±äº«é”"></a>ç‹¬äº«(å )é”/å…±äº«é”</h3><p>æ ¹æ®èƒ½å¤ŸåŒæ—¶è¢«å¤šå°‘çº¿ç¨‹æŒæœ‰æ¥åŒºåˆ†ã€‚</p>
<ul>
<li>ç‹¬äº«é”å°±æ˜¯æŒ‡è¯¥é”ä¸€æ¬¡ä»…èƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚</li>
<li>å…±äº«é”å¯ä»¥åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹æŒæœ‰ã€‚</li>
</ul>
<h3 id="äº’æ–¥é”-è¯»å†™é”"><a href="#äº’æ–¥é”-è¯»å†™é”" class="headerlink" title="äº’æ–¥é”/è¯»å†™é”"></a>äº’æ–¥é”/è¯»å†™é”</h3><p>ä¸Šé¢è®²çš„<strong>ç‹¬äº«é”/å…±äº«é”</strong>å°±æ˜¯ä¸€ç§<strong>å¹¿ä¹‰çš„è¯´æ³•</strong>ï¼Œ<strong>äº’æ–¥é”/è¯»å†™é”</strong>å°±æ˜¯<strong>å…·ä½“çš„å®ç°</strong>ã€‚</p>
<ul>
<li>äº’æ–¥é”ï¼šåœ¨ Java ä¸­çš„å…·ä½“å°±æ˜¯ ReentrantLock</li>
<li>è¯»å†™é”ï¼šåœ¨ Java ä¸­çš„å…·ä½“å®ç°å°±æ˜¯ ReadWriteLockã€‚å…¶è¯»é”æ˜¯å…±äº«é”ï¼Œå…¶å†™é”æ˜¯ç‹¬äº«é”ã€‚<ul>
<li>è¯»é”çš„å…±äº«å¯ä¿è¯é«˜æ•ˆå¹¶å‘ã€‚</li>
<li>è¯»å†™ã€å†™è¯»ã€å†™å†™çš„è¿‡ç¨‹æ˜¯<strong>äº’æ–¥çš„</strong></li>
</ul>
</li>
</ul>
<p>ç‹¬äº«é”ä¸å…±äº«é”ä¹Ÿæ˜¯ä½¿ç”¨ AQS æ¥å®ç°çš„ã€‚é€šè¿‡å®ç°ä¸åŒçš„æ–¹æ³•æ¥å®ç°ç‹¬äº«æˆ–è€…å…±äº«ã€‚</p>
<h3 id="ä¹è§‚é”-æ‚²è§‚é”"><a href="#ä¹è§‚é”-æ‚²è§‚é”" class="headerlink" title="ä¹è§‚é”/æ‚²è§‚é”"></a>ä¹è§‚é”/æ‚²è§‚é”</h3><p>å¹¶ä¸æ˜¯æŒ‡å…·ä½“ç±»å‹çš„é”ï¼Œè€Œæ˜¯æŒ‡<strong>çœ‹å¾…å¹¶å‘åŒæ­¥çš„æ€åº¦</strong>ã€‚</p>
<p><strong>æ‚²è§‚é”</strong>é‡‡ç”¨ä¸€ç§æ‚²è§‚çš„å¹¶å‘ç­–ç•¥<strong>ï¼Œ</strong>æ€»æ˜¯<strong>è®¤ä¸ºåªè¦ä¸å»åšæ­£ç¡®çš„åŒæ­¥æªæ–½ï¼ˆä¾‹å¦‚åŠ é”ï¼‰ï¼Œé‚£å°±è‚¯å®šä¼šå‡ºç°é—®é¢˜</strong>ã€‚<br>æ‰€è°“<strong>ä¹è§‚é”</strong>å°±æ˜¯ï¼Œæ¯æ¬¡ä¸åŠ é”è€Œæ˜¯<strong>å‡è®¾æ²¡æœ‰å†²çªè€Œå»å®ŒæˆæŸé¡¹æ“ä½œ</strong>ï¼Œå¦‚æœå› ä¸º<strong>å†²çªå¤±è´¥å°±é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢</strong>ã€‚ä¹è§‚é”<strong>ä¸èƒ½è§£å†³è„è¯»çš„é—®é¢˜</strong>ã€‚</p>
<h4 id="äºŒè€…ä¹‹é—´å¦‚ä½•é€‰æ‹©é€‰æ‹©ï¼Ÿ"><a href="#äºŒè€…ä¹‹é—´å¦‚ä½•é€‰æ‹©é€‰æ‹©ï¼Ÿ" class="headerlink" title="äºŒè€…ä¹‹é—´å¦‚ä½•é€‰æ‹©é€‰æ‹©ï¼Ÿ"></a>äºŒè€…ä¹‹é—´å¦‚ä½•é€‰æ‹©é€‰æ‹©ï¼Ÿ</h4><p>é¦–å…ˆè¦å¼„æ¸…æ¥šï¼Œ<strong>äº‹å®æ˜¯æ‚²è§‚çš„è¿˜æ˜¯ä¹è§‚çš„</strong>ï¼Ÿ</p>
<p>å‡å¦‚ä½ çš„èµ„æºç«äº‰å¾ˆæ¿€çƒˆï¼Œå¹¶ä¸”æ— æ³•å…±äº«çš„è¯ï¼Œä¹è§‚é”ä¸è¿‡æ˜¯è®©å¤§é‡è¯·æ±‚çš„å¸Œæœ›è½ç©ºç½¢äº†ã€‚â€”â€”å¦‚æœäº‹å®æ˜¯æ‚²è§‚çš„ï¼Œä½†æ˜¯é‡‡ç”¨äº†ä¹è§‚é”ï¼Œé‚£å°±åªä¼šå¯¼è‡´å¤§é‡è¯·æ±‚è½ç©ºç½¢äº†ã€‚</p>
<p>å‡å¦‚ä½ çš„èµ„æºæ²¡ä»€ä¹ˆç«äº‰ï¼ˆè¿™ä¸ªå’Œå¹¶å‘é«˜ä½æ²¡å¿…ç„¶çš„å…³è”ï¼Œä¸šåŠ¡çš„å½±å“æ›´å¤§ï¼‰ï¼Œé‚£æ‚²è§‚é”æ„å‘³ç€ä¸å¿…è¦åœ°åŠ é”ã€‚å¦‚æœåŸæœ¬æ˜¯å¯å…±äº«çš„èµ„æºï¼ˆæ¯”å¦‚èµ„æºæ”¯æŒå¤šä¸ªåªè¯»æ–¹ï¼‰ï¼Œé‚£ä¹ˆæ‚²è§‚é”æ„å‘³ç€å¤±å»åŸæœ¬çš„å¯ä»¥ä½¿ç”¨çš„æ—¶é—´ã€‚â€”â€”å¦‚æœäº‹å®æ˜¯ä¹è§‚çš„ï¼Œä½†æ˜¯ä½¿ç”¨äº†æ‚²è§‚é”ï¼Œé‚£ä¹ˆå°±æŸå¤±ä¸€äº›æœ¬æ¥å¯ä»¥ä½¿ç”¨çš„æ—¶é—´ã€‚</p>
<p>å†è¯¦ç»†ç‚¹å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥åˆ¤æ–­ï¼š</p>
<ol>
<li><strong>å“åº”é€Ÿåº¦</strong>ï¼šå¦‚æœéœ€è¦éå¸¸é«˜çš„å“åº”é€Ÿåº¦ï¼Œå»ºè®®é‡‡ç”¨ä¹è§‚é”æ–¹æ¡ˆï¼ŒæˆåŠŸå°±æ‰§è¡Œï¼Œä¸æˆåŠŸå°±å¤±è´¥ï¼Œä¸éœ€è¦ç­‰å¾…å…¶ä»–å¹¶å‘å»é‡Šæ”¾é”ã€‚</li>
<li><strong>å†²çªé¢‘ç‡</strong>ï¼šå¦‚æœå†²çªé¢‘ç‡éå¸¸é«˜ï¼Œå»ºè®®é‡‡ç”¨æ‚²è§‚é”ï¼Œä¿è¯æˆåŠŸç‡ï¼Œå¦‚æœå†²çªé¢‘ç‡å¤§ï¼Œä¹è§‚é”ä¼šéœ€è¦å¤šæ¬¡é‡è¯•æ‰èƒ½æˆåŠŸï¼Œä»£ä»·æ¯”è¾ƒå¤§ã€‚</li>
<li><strong>é‡è¯•ä»£ä»·</strong>ï¼šå¦‚æœé‡è¯•ä»£ä»·å¤§ï¼Œå»ºè®®é‡‡ç”¨æ‚²è§‚é”ã€‚</li>
</ol>
<p>ä»¥ä¸Šå†…å®¹å‚è€ƒè‡ª<a href="https://segmentfault.com/q/1010000009251675" target="_blank" rel="noopener">é«˜å¹¶å‘ä¸‹æ‚²è§‚é”ä¸ä¹è§‚é”çš„é€‰æ‹©é—®é¢˜</a></p>
<h3 id="åˆ†æ®µé”"><a href="#åˆ†æ®µé”" class="headerlink" title="åˆ†æ®µé”"></a>åˆ†æ®µé”</h3><p>åˆ†æ®µé”å…¶å®æ˜¯ä¸€ç§<strong>é”çš„è®¾è®¡</strong>ï¼Œå¹¶ä¸æ˜¯å…·ä½“çš„ä¸€ç§é”ã€‚</p>
<p>æˆ‘ä»¬ä»¥<code>ConcurrentHashMap</code>æ¥è¯´ä¸€ä¸‹åˆ†æ®µé”çš„å«ä¹‰ä»¥åŠè®¾è®¡æ€æƒ³ï¼Œ<code>ConcurrentHashMap</code>ä¸­çš„åˆ†æ®µé”ç§°ä¸º Segmentï¼Œå®ƒå³ç±»ä¼¼äº HashMapï¼ˆJava7 ä¸ Java8 ä¸­ HashMap çš„å®ç°ï¼‰çš„ç»“æ„ï¼Œå³å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ª Entry æ•°ç»„ï¼Œ<strong>æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼›åŒæ—¶åˆæ˜¯ä¸€ä¸ª ReentrantLockï¼ˆSegment ç»§æ‰¿äº† ReentrantLock)</strong>ã€‚<br>å½“éœ€è¦ put å…ƒç´ çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯å¯¹æ•´ä¸ª hashmap è¿›è¡ŒåŠ é”ï¼Œè€Œæ˜¯<strong>å…ˆé€šè¿‡ hashcode æ¥çŸ¥é“ä»–è¦æ”¾åœ¨é‚£ä¸€ä¸ªåˆ†æ®µä¸­ï¼Œç„¶åå¯¹è¿™ä¸ªåˆ†æ®µè¿›è¡ŒåŠ é”</strong>ï¼Œæ‰€ä»¥å½“å¤šçº¿ç¨‹ put çš„æ—¶å€™ï¼Œåªè¦ä¸æ˜¯æ”¾åœ¨ä¸€ä¸ªåˆ†æ®µä¸­ï¼Œå°±å®ç°äº†çœŸæ­£çš„å¹¶è¡Œçš„æ’å…¥ã€‚</p>
<p>ä½†æ˜¯ï¼Œåœ¨ç»Ÿè®¡ size çš„æ—¶å€™ï¼Œå¯å°±æ˜¯è·å– hashmap å…¨å±€ä¿¡æ¯çš„æ—¶å€™ï¼Œå°±éœ€è¦è·å–æ‰€æœ‰çš„åˆ†æ®µé”æ‰èƒ½ç»Ÿè®¡ã€‚åˆ†æ®µé”çš„è®¾è®¡<strong>ç›®çš„æ˜¯ç»†åŒ–é”çš„ç²’åº¦</strong>ï¼Œå½“æ“ä½œä¸éœ€è¦æ›´æ–°æ•´ä¸ªæ•°ç»„çš„æ—¶å€™ï¼Œå°±ä»…ä»…é’ˆå¯¹æ•°ç»„ä¸­çš„ä¸€é¡¹è¿›è¡ŒåŠ é”æ“ä½œã€‚</p>
<h3 id="åå‘é”-è½»é‡çº§é”-é‡é‡çº§é”"><a href="#åå‘é”-è½»é‡çº§é”-é‡é‡çº§é”" class="headerlink" title="åå‘é”/è½»é‡çº§é”/é‡é‡çº§é”"></a>åå‘é”/è½»é‡çº§é”/é‡é‡çº§é”</h3><p>è¿™ä¸‰ç§é”æ˜¯æŒ‡<strong>é”çš„çŠ¶æ€</strong>ï¼Œå¹¶ä¸”æ˜¯é’ˆå¯¹<code>Synchronized</code> çš„ã€‚åœ¨ Java1.5 é€šè¿‡å¼•å…¥<strong>é”å‡çº§çš„æœºåˆ¶</strong>æ¥å®ç°é«˜æ•ˆçš„<code>Synchronized</code>ã€‚è¿™ä¸‰ç§é”çš„çŠ¶æ€æ˜¯<strong>é€šè¿‡å¯¹è±¡ç›‘è§†å™¨åœ¨å¯¹è±¡å¤´ä¸­çš„å­—æ®µæ¥è¡¨æ˜çš„</strong>ã€‚</p>
<p><strong>åå‘é”</strong>ï¼šå½“ä¸€æ®µåŒæ­¥ä»£ç æ€»æ˜¯è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®çš„æ—¶å€™ï¼Œ é‚£ä¹ˆè¯¥çº¿ç¨‹å°±ä¼šè‡ªåŠ¨è·å–é”ï¼Œé™ä½è·å–é”çš„ä»£ä»·ã€‚å¦‚æœè¯´è½»é‡çº§é”æ˜¯åœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹ä½¿ç”¨ CAS æ“ä½œå»æ¶ˆé™¤åŒæ­¥ä½¿ç”¨çš„äº’æ–¥é‡ï¼Œé‚£åå‘é”å°±æ˜¯<strong>åœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹æŠŠæ•´ä¸ªåŒæ­¥éƒ½æ¶ˆé™¤æ‰ï¼Œè¿ CAS æ“ä½œéƒ½ä¸åšäº†</strong>ã€‚åå‘é”çš„â€œåâ€ï¼Œæ„æ€æ˜¯è¿™ä¸ªé”ä¼š<strong>åå‘äº<em>ç¬¬ä¸€ä¸ª</em>è·å¾—å®ƒçš„çº¿ç¨‹</strong>ï¼Œå¦‚æœåœ¨æ¥ä¸‹æ¥çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¯¥é”æ²¡æœ‰è¢«å…¶ä»–çš„çº¿ç¨‹è·å–ï¼Œåˆ™æŒæœ‰åå‘é”çš„çº¿ç¨‹å°†æ°¸è¿œä¸éœ€è¦å†è¿›è¡ŒåŒæ­¥ã€‚</p>
<p><strong>è½»é‡çº§é”</strong>ï¼šå½“é”æ˜¯åå‘é”æ—¶ï¼ˆå› ä¸ºç»å¸¸è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼‰ï¼Œå½“å¦å¤–ä¸€ä¸ªçº¿ç¨‹éœ€è¦è®¿é—®ç›¸åº”çš„åŒæ­¥ä»£ç æ®µæ—¶ï¼Œåå‘é”ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé€šè¿‡<strong>è‡ªæ—‹çš„æ–¹å¼</strong>å°è¯•å»è·å–é”ï¼Œè½»é‡çº§é”å¹¶ä¸æ˜¯ç”¨æ¥ä»£æ›¿é‡é‡çº§é”çš„ï¼Œå®ƒçš„æœ¬æ„æ˜¯<strong>åœ¨æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰çš„å‰æä¸‹ï¼Œå‡å°‘ä¼ ç»Ÿçš„é‡é‡çº§é”ä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡äº§ç”Ÿçš„æ€§èƒ½æ¶ˆè€—</strong>ã€‚</p>
<p><strong>é‡é‡çº§é”</strong>ï¼šè‡ªæ—‹è¾¾åˆ°ä¸€å®šæ¬¡æ•°ä¹‹åï¼Œå°±ä¼šè†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚é‡é‡çº§é”ä¼šä½¿å…¶ä»–ç”³è¯·çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</p>
<p>é”™è¯¯è§‚ç‚¹ï¼š<del>é”<strong>å¯ä»¥å‡çº§ä½†ä¸èƒ½é™çº§</strong>ï¼Œæ„å‘³ç€åå‘é”å‡çº§æˆè½»é‡çº§é”åä¸èƒ½é™çº§æˆåå‘é”</del>ã€‚å…·ä½“å¯ä»¥å‚è€ƒä¸‹<a href="http://www.jianshu.com/p/9932047a89be" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a></p>
<p>é”çš„å‡çº§ï¼š</p>
<p><img src="https://user-images.githubusercontent.com/16668676/30313216-2beddbd8-97cf-11e7-8e50-d07dccb4ec21.png" alt="lock update"></p>
<h4 id="åå‘é”çš„å®ç°"><a href="#åå‘é”çš„å®ç°" class="headerlink" title="åå‘é”çš„å®ç°"></a>åå‘é”çš„å®ç°</h4><p>å‡è®¾å½“å‰è™šæ‹Ÿæœºå¯ç”¨äº†åå‘é”ï¼Œé‚£ä¹ˆï¼Œå½“é”å¯¹è±¡<strong>ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å–çš„æ—¶å€™</strong>ï¼Œè™šæ‹Ÿæœºå°†ä¼šæŠŠå¯¹è±¡å¤´ä¸­çš„æ ‡å¿—ä½è®¾ä¸ºâ€œ01â€ï¼Œå³<strong>åå‘æ¨¡å¼</strong>ã€‚åŒæ—¶ä½¿ç”¨ CAS æ“ä½œæŠŠè·å–åˆ°è¿™ä¸ªé”çš„çº¿ç¨‹çš„ ID è®°å½•åœ¨å¯¹è±¡çš„ Mark Word ä¹‹ä¸­ï¼Œ</p>
<ul>
<li>å¦‚æœ CAS æ“ä½œæˆåŠŸï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹ä»¥åæ¯æ¬¡è¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—æ—¶ï¼Œè™šæ‹Ÿæœºéƒ½å¯ä»¥ä¸å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼ˆä¾‹å¦‚ Lockingã€Unlocking åŠå¯¹ Mark Word çš„ Update ç­‰ï¼‰ã€‚</li>
<li>å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹å»å°è¯•è·å–è¿™ä¸ªé”æ—¶ï¼Œåå‘æ¨¡å¼å°±å®£å‘Šç»“æŸã€‚</li>
<li>æ ¹æ®é”å¯¹è±¡ç›®å‰æ˜¯å¦å¤„äºè¢«é”å®šçš„çŠ¶æ€ï¼Œ<strong>æ’¤é”€åå‘</strong>ï¼ˆRevoke Biasï¼‰åæ¢å¤åˆ°æœªé”å®šï¼ˆæ ‡å¿—ä½ä¸ºâ€œ01â€ï¼‰æˆ–è½»é‡çº§é”å®šï¼ˆæ ‡å¿—ä½ä¸ºâ€œ00â€ï¼‰çš„çŠ¶æ€ï¼Œ</li>
<li>åç»­çš„åŒæ­¥æ“ä½œå°±å¦‚ä¸Šé¢ä»‹ç»çš„è½»é‡çº§é”é‚£æ ·æ‰§è¡Œã€‚</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/16668676/30313215-2bede358-97cf-11e7-84bd-2eeff1472644.png" alt="lock"></p>
<p>å›¾ç‰‡å‚è€ƒè‡ª<a href="http://www.infoq.com/cn/articles/java-se-16-synchronized" target="_blank" rel="noopener">èŠèŠå¹¶å‘ï¼ˆäºŒï¼‰â€”â€”Java SE1.6ä¸­çš„Synchronized</a></p>
<h4 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h4><h5 id="è½»é‡çº§é”çš„åŠ é”è¿‡ç¨‹"><a href="#è½»é‡çº§é”çš„åŠ é”è¿‡ç¨‹" class="headerlink" title="è½»é‡çº§é”çš„åŠ é”è¿‡ç¨‹"></a>è½»é‡çº§é”çš„åŠ é”è¿‡ç¨‹</h5><p>åœ¨ä»£ç è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œ</p>
<ul>
<li>å¦‚æœæ­¤åŒæ­¥å¯¹è±¡<strong>æ²¡æœ‰è¢«é”å®š</strong>ï¼ˆé”æ ‡å¿—ä½ä¸ºâ€œ01â€çŠ¶æ€ï¼‰ï¼Œè™šæ‹Ÿæœºé¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸º<strong>é”è®°å½•</strong>ï¼ˆLock  Recordï¼‰çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„ Mark Word çš„æ‹·è´ï¼ˆå®˜æ–¹æŠŠè¿™ä»½æ‹·è´åŠ äº†ä¸€ä¸ª Displaced å‰ç¼€ï¼Œå³ Displaced Mark Wordï¼‰ï¼Œè¿™æ—¶å€™çº¿ç¨‹å †æ ˆä¸å¯¹è±¡å¤´çš„çŠ¶æ€å¦‚å›¾ 13-3 æ‰€ç¤ºã€‚</li>
<li>ç„¶åï¼Œè™šæ‹Ÿæœºå°†ä½¿ç”¨ CAS æ“ä½œå°è¯•å°†å¯¹è±¡çš„ Mark Word æ›´æ–°ä¸ºæŒ‡å‘ Lock Record çš„æŒ‡é’ˆã€‚<ul>
<li>å¦‚æœè¿™ä¸ª<strong>æ›´æ–°åŠ¨ä½œæˆåŠŸäº†</strong>ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”ï¼Œå¹¶ä¸”å¯¹è±¡ Mark Word çš„é”æ ‡å¿—ä½ï¼ˆMark Word çš„æœ€å 2bitï¼‰å°†è½¬å˜ä¸ºâ€œ00â€ï¼Œå³è¡¨ç¤ºæ­¤å¯¹è±¡å¤„äºè½»é‡çº§é”å®šçŠ¶æ€ï¼Œè¿™æ—¶å€™çº¿ç¨‹å †æ ˆä¸å¯¹è±¡å¤´çš„çŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</li>
<li>å¦‚æœè¿™ä¸ª<strong>æ›´æ–°æ“ä½œå¤±è´¥äº†</strong>ï¼Œè™šæ‹Ÿæœºé¦–å…ˆä¼šæ£€æŸ¥å¯¹è±¡çš„ <strong>Mark Word æ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§</strong>ï¼Œ<ul>
<li>å¦‚æœåªè¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œé‚£å°±å¯ä»¥ç›´æ¥è¿›å…¥åŒæ­¥å—ç»§ç»­æ‰§è¡Œï¼Œ</li>
</ul>
</li>
<li>å¦åˆ™è¯´æ˜è¿™ä¸ªé”å¯¹è±¡å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŠ¢å äº†ã€‚<ul>
<li>å¦‚æœæœ‰<strong>ä¸¤æ¡ä»¥ä¸Šçš„çº¿ç¨‹äº‰ç”¨åŒä¸€ä¸ªé”ï¼Œé‚£è½»é‡çº§é”å°±ä¸å†æœ‰æ•ˆï¼Œè¦è†¨èƒ€ä¸ºé‡é‡çº§é”</strong>ï¼Œé”æ ‡å¿—çš„çŠ¶æ€å€¼å˜ä¸ºâ€œ10â€ï¼ŒMark Word ä¸­å­˜å‚¨çš„å°±æ˜¯æŒ‡å‘é‡é‡çº§é”ï¼ˆäº’æ–¥é‡ï¼‰çš„æŒ‡é’ˆï¼Œåé¢ç­‰å¾…é”çš„çº¿ç¨‹ä¹Ÿè¦è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/16668676/28906024-2978ad6c-7847-11e7-88d2-30d22e7babb0.png" alt="cas"></p>
<p><img src="https://user-images.githubusercontent.com/16668676/30313218-2c1d4698-97cf-11e7-9765-6d1ffdc9b915.png" alt="light weight"></p>
<p>å›¾ç‰‡å‚è€ƒè‡ª<a href="http://www.infoq.com/cn/articles/java-se-16-synchronized" target="_blank" rel="noopener">èŠèŠå¹¶å‘ï¼ˆäºŒï¼‰â€”â€”Java SE1.6ä¸­çš„Synchronized</a></p>
<h5 id="è½»é‡çº§é”çš„è§£é”è¿‡ç¨‹"><a href="#è½»é‡çº§é”çš„è§£é”è¿‡ç¨‹" class="headerlink" title="è½»é‡çº§é”çš„è§£é”è¿‡ç¨‹"></a>è½»é‡çº§é”çš„è§£é”è¿‡ç¨‹</h5><p><strong>è§£é”è¿‡ç¨‹ä¹Ÿæ˜¯é€šè¿‡ CAS æ“ä½œæ¥è¿›è¡Œçš„</strong></p>
<ul>
<li>å¦‚æœå¯¹è±¡çš„ Mark Word ä»ç„¶æŒ‡å‘ç€çº¿ç¨‹çš„é”è®°å½•ï¼Œé‚£å°±ç”¨ CAS æ“ä½œ<strong>æŠŠå¯¹è±¡å½“å‰çš„ Mark Word å’Œçº¿ç¨‹ä¸­å¤åˆ¶çš„ Displaced Mark Word æ›¿æ¢å›æ¥</strong>ï¼Œ<ul>
<li>å¦‚æœæ›¿æ¢æˆåŠŸï¼Œæ•´ä¸ªåŒæ­¥è¿‡ç¨‹å°±å®Œæˆäº†ã€‚</li>
<li>å¦‚æœæ›¿æ¢å¤±è´¥ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹<strong>å°è¯•è¿‡è·å–è¯¥é”</strong>ï¼Œé‚£å°±è¦åœ¨é‡Šæ”¾é”çš„åŒæ—¶ï¼Œå”¤é†’è¢«æŒ‚èµ·çš„çº¿ç¨‹ã€‚ï¼ˆå¦‚ä½•å”¤é†’ï¼Ÿ <code>notify()</code> ï¼‰</li>
</ul>
</li>
</ul>
<p>è½»é‡çº§é”èƒ½æå‡ç¨‹åºåŒæ­¥æ€§èƒ½çš„<strong>ä¾æ®</strong>æ˜¯â€œ<strong>å¯¹äºç»å¤§éƒ¨åˆ†çš„é”ï¼Œåœ¨æ•´ä¸ªåŒæ­¥å‘¨æœŸå†…éƒ½æ˜¯ä¸å­˜åœ¨ç«äº‰çš„</strong>â€ï¼Œè¿™æ˜¯ä¸€ä¸ªç»éªŒæ•°æ®ã€‚</p>
<ul>
<li>å¦‚æœæ²¡æœ‰ç«äº‰ï¼Œè½»é‡çº§é”ä½¿ç”¨ CAS æ“ä½œé¿å…äº†ä½¿ç”¨äº’æ–¥é‡çš„å¼€é”€ï¼Œ</li>
<li>å¦‚æœå­˜åœ¨é”ç«äº‰ï¼Œé™¤äº†äº’æ–¥é‡çš„å¼€é”€å¤–ï¼Œè¿˜é¢å¤–å‘ç”Ÿäº† CAS æ“ä½œï¼Œå› æ­¤åœ¨==æœ‰ç«äº‰çš„æƒ…å†µä¸‹ï¼Œè½»é‡çº§é”ä¼šæ¯”ä¼ ç»Ÿçš„é‡é‡çº§é”æ›´æ…¢==ã€‚</li>
</ul>
<h4 id="é”çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”"><a href="#é”çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”" class="headerlink" title="é”çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”"></a>é”çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”</h4><table>
<thead>
<tr>
<th>é”</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>åå‘é”</td>
<td>åŠ é”å’Œè§£é”ä¸éœ€è¦é¢å¤–çš„æ¶ˆè€—ï¼Œå’Œæ‰§è¡ŒéåŒæ­¥æ–¹æ³•æ¯”ä»…å­˜åœ¨çº³ç§’çº§çš„å·®è·</td>
<td>å¦‚æœçº¿ç¨‹é—´å­˜åœ¨é”ç«äº‰ï¼Œä¼šå¸¦æ¥é¢å¤–çš„é”æ’¤é”€çš„æ¶ˆè€—</td>
<td>é€‚ç”¨äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—åœºæ™¯</td>
</tr>
<tr>
<td>è½»é‡çº§é”</td>
<td>ç«äº‰çš„çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œæé«˜äº†ç¨‹åºçš„å“åº”é€Ÿåº¦</td>
<td>å¦‚æœå§‹ç»ˆå¾—ä¸åˆ°é”ç«äº‰çš„çº¿ç¨‹ä½¿ç”¨è‡ªæ—‹ä¼šæ¶ˆè€— CPU</td>
<td>è¿½æ±‚å“åº”æ—¶é—´,é”å ç”¨æ—¶é—´å¾ˆçŸ­</td>
</tr>
<tr>
<td>é‡é‡çº§é”</td>
<td>çº¿ç¨‹ç«äº‰ä¸ä½¿ç”¨è‡ªæ—‹ï¼Œä¸ä¼šæ¶ˆè€— CPU</td>
<td>çº¿ç¨‹é˜»å¡ï¼Œå“åº”æ—¶é—´ç¼“æ…¢</td>
<td>è¿½æ±‚ååé‡,é”å ç”¨æ—¶é—´è¾ƒé•¿</td>
</tr>
</tbody>
</table>
<h3 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h3><p>åœ¨ Java ä¸­ï¼Œè‡ªæ—‹é”æ˜¯æŒ‡<strong>å°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”</strong>ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€— CPUã€‚<br>å…¸å‹çš„è‡ªæ—‹é”å®ç°çš„ä¾‹å­ï¼Œå¯ä»¥å‚è€ƒ<a href="http://ifeve.com/java_lock_see1/" target="_blank" rel="noopener">è‡ªæ—‹é”çš„å®ç°</a></p>
<p>å¦‚æœçº¿ç¨‹<strong>ç«äº‰ä¸æ¿€çƒˆ</strong>ï¼Œå¹¶ä¸”ä¿æŒé”çš„æ—¶é—´æ®µã€‚é€‚åˆä½¿ç”¨è‡ªæ—‹é”ã€‚è¿™æ ·å¯ä»¥é¿å…çº¿ç¨‹æŒ‚èµ·å’Œæ¢å¤(æŒ‚èµ·çº¿ç¨‹å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œéƒ½éœ€è¦è½¬å…¥å†…æ ¸æ€ä¸­å®Œæˆï¼Œè¿™äº›æ“ä½œç»™ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å¸¦æ¥äº†å¾ˆå¤§çš„å‹åŠ›)ï¼Œä»è€Œé™ä½æ€§èƒ½å¼€é”€ã€‚</p>
<ul>
<li>è‡ªæ—‹æ¬¡æ•°çš„é»˜è®¤å€¼æ˜¯ 10 æ¬¡ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å‚æ•°<code>-XXï¼šPreBlockSpin</code> æ¥æ›´æ”¹ã€‚</li>
</ul>
<p>åœ¨ Java 1.6 ä¸­å¼•å…¥äº†<strong>è‡ªé€‚åº”çš„è‡ªæ—‹é”</strong>ã€‚è‡ªé€‚åº”æ„å‘³ç€<strong>è‡ªæ—‹çš„æ—¶é—´ä¸å†å›ºå®šäº†</strong>ï¼Œè€Œæ˜¯<strong>ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€</strong>æ¥å†³å®šã€‚</p>
<h3 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a>é”æ¶ˆé™¤</h3><p><strong>é”æ¶ˆé™¤</strong>æ˜¯æŒ‡è™šæ‹Ÿæœº<strong>å³æ—¶ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶</strong>ï¼Œå¯¹ä¸€äº›ä»£ç ä¸Šè¦æ±‚åŒæ­¥ï¼Œä½†æ˜¯è¢«æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚</p>
<p>é”æ¶ˆé™¤çš„<strong>ä¸»è¦åˆ¤å®šä¾æ®</strong>æ¥æºäº<strong>é€ƒé€¸åˆ†æçš„æ•°æ®æ”¯æŒ</strong>ï¼ˆç¬¬ 11 ç« å·²ç»è®²è§£è¿‡é€ƒé€¸åˆ†ææŠ€æœ¯ï¼‰ï¼Œå¦‚æœåˆ¤æ–­åœ¨ä¸€æ®µä»£ç ä¸­ï¼Œ<strong>å †ä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½ä¸ä¼šé€ƒé€¸å‡ºå»</strong>ä»è€Œè¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£å°±å¯ä»¥æŠŠå®ƒä»¬å½“åšæ ˆä¸Šæ•°æ®å¯¹å¾…ï¼Œè®¤ä¸ºå®ƒä»¬æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼ŒåŒæ­¥åŠ é”è‡ªç„¶å°±æ— é¡»è¿›è¡Œã€‚</p>
<p>ä¸¾ä¸ªæ —å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> String concatStringï¼ˆString s1ï¼ŒString s2ï¼ŒString s3ï¼‰&#123;</div><div class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer()ï¼›</div><div class="line">    sb.appendï¼ˆs1ï¼‰;</div><div class="line">    sb.appendï¼ˆs2ï¼‰;</div><div class="line">    sb.appendï¼ˆs3ï¼‰;</div><div class="line">    <span class="keyword">return</span> sb.toString()ï¼›</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ¯ä¸ª StringBuffer.append()æ–¹æ³•ä¸­éƒ½æœ‰ä¸€ä¸ªåŒæ­¥å—ï¼Œé”å°±æ˜¯ sb å¯¹è±¡ã€‚è™šæ‹Ÿæœºè§‚å¯Ÿå˜é‡ sbï¼Œå¾ˆå¿«å°±ä¼šå‘ç°å®ƒçš„åŠ¨æ€ä½œç”¨åŸŸè¢«é™åˆ¶åœ¨ concatString()æ–¹æ³•å†…éƒ¨ã€‚sb çš„æ‰€æœ‰å¼•ç”¨æ°¸è¿œä¸ä¼šâ€œé€ƒé€¸â€åˆ° concatString()æ–¹æ³•ä¹‹å¤–ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®åˆ°å®ƒï¼Œå› æ­¤ï¼Œè™½ç„¶è¿™é‡Œæœ‰é”ï¼Œä½†æ˜¯å¯ä»¥è¢«å®‰å…¨åœ°æ¶ˆé™¤æ‰ï¼Œåœ¨<strong>å³æ—¶ç¼–è¯‘ä¹‹åï¼Œè¿™æ®µä»£ç å°±ä¼šå¿½ç•¥æ‰æ‰€æœ‰çš„åŒæ­¥è€Œç›´æ¥æ‰§è¡Œ</strong>äº†ã€‚</p>
<h3 id="é”ç²—åŒ–"><a href="#é”ç²—åŒ–" class="headerlink" title="é”ç²—åŒ–"></a>é”ç²—åŒ–</h3><p>åŸåˆ™ä¸Šï¼Œæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œæ€»æ˜¯æ¨èå°†åŒæ­¥å—çš„ä½œç”¨èŒƒå›´é™åˆ¶å¾—å°½é‡å°â€”â€”åªåœ¨å…±äº«æ•°æ®çš„å®é™…ä½œç”¨åŸŸä¸­æ‰è¿›è¡ŒåŒæ­¥ï¼Œè¿™æ ·æ˜¯ä¸º<strong>ä½¿å¾—éœ€è¦åŒæ­¥çš„æ“ä½œæ•°é‡å°½å¯èƒ½å˜å°</strong>ã€‚</p>
<p>å¦‚æœä¸€ç³»åˆ—çš„è¿ç»­æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”å’Œè§£é”ï¼Œç”šè‡³åŠ é”æ“ä½œæ˜¯å‡ºç°åœ¨å¾ªç¯ä½“ä¸­çš„ï¼Œé‚£å³ä½¿æ²¡æœ‰çº¿ç¨‹ç«äº‰ï¼Œ<strong>é¢‘ç¹åœ°è¿›è¡Œäº’æ–¥åŒæ­¥æ“ä½œä¹Ÿä¼šå¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æŸè€—</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> String concatStringï¼ˆString s1ï¼ŒString s2ï¼ŒString s3ï¼‰&#123;</div><div class="line">    StringBuffer sb=<span class="keyword">new</span> StringBuffer()ï¼›</div><div class="line">    sb.appendï¼ˆs1ï¼‰ï¼›</div><div class="line">    sb.appendï¼ˆs2ï¼‰ï¼›</div><div class="line">    sb.appendï¼ˆs3ï¼‰ï¼›</div><div class="line">    <span class="keyword">return</span> sb.toString()ï¼›</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿ç»­çš„ append()æ–¹æ³•å°±å±äºè¿™ç±»æƒ…å†µã€‚å¦‚æœè™šæ‹Ÿæœºæ¢æµ‹åˆ°æœ‰è¿™æ ·ä¸€ä¸²é›¶ç¢çš„æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†ä¼š<strong>æŠŠåŠ é”åŒæ­¥çš„èŒƒå›´æ‰©å±•ï¼ˆç²—åŒ–ï¼‰åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨</strong>ï¼Œä»¥ä¸Šè¿°ä»£ç ä¸ºä¾‹ï¼Œå°±æ˜¯æ‰©å±•åˆ°ç¬¬ä¸€ä¸ª append()æ“ä½œä¹‹å‰ç›´è‡³æœ€åä¸€ä¸ª append()æ“ä½œä¹‹åï¼Œè¿™æ ·åªéœ€è¦åŠ é”ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://www.importnew.com/20472.html" target="_blank" rel="noopener">ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼â€”â€”CAS</a></li>
<li><a href="http://www.cnblogs.com/qifengshi/p/6831055.html" target="_blank" rel="noopener">Java ä¸­çš„é”åˆ†ç±»</a></li>
<li><a href="http://blog.csdn.net/vernonzheng/article/details/8275624" target="_blank" rel="noopener">Javaå¤šçº¿ç¨‹ï¼ˆä¸ƒï¼‰ä¹‹åŒæ­¥å™¨åŸºç¡€ï¼šAQSæ¡†æ¶æ·±å…¥åˆ†æ</a></li>
<li><a href="https://segmentfault.com/q/1010000009251675" target="_blank" rel="noopener">é«˜å¹¶å‘ä¸‹æ‚²è§‚é”ä¸ä¹è§‚é”çš„é€‰æ‹©é—®é¢˜</a></li>
<li><a href="http://www.infoq.com/cn/articles/java-se-16-synchronized" target="_blank" rel="noopener">èŠèŠå¹¶å‘ï¼ˆäºŒï¼‰â€”â€”Java SE1.6ä¸­çš„Synchronized</a></li>
<li>ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹</li>
</ul>
<p>å¦‚æœæœ¬æ–‡ä¸­å­˜åœ¨ä¸æ­£ç¡®çš„è¯´æ³•ï¼Œè¯·æå‡ºï¼Œå…±åŒè®¨è®ºï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> å¹¶å‘ </category>
            
            <category> JVM </category>
            
        </categories>
        
        
        <tags>
            
            <tag> å¹¶å‘ </tag>
            
            <tag> JVM </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java é›†åˆæ¡†æ¶ä¹‹ HashMap å·¥ä½œåŸç†]]></title>
      <url>https://timlin-pro.github.io/blog/2017/09/10/Java%20%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6%E4%B9%8B%20HashMap%20%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><p>æ¦‚æ‹¬çš„è¯´ï¼Œ<code>HashMap</code> æ˜¯ä¸€ä¸ª<strong>å…³è”æ•°ç»„ã€å“ˆå¸Œè¡¨</strong>ï¼Œå®ƒæ˜¯<strong>çº¿ç¨‹ä¸å®‰å…¨</strong>çš„ï¼Œå…è®¸<strong>key ä¸º null</strong>,<strong>value ä¸º null</strong>ã€‚éå†æ—¶<strong>æ— åº</strong>ã€‚<br>å…¶åº•å±‚æ•°æ®ç»“æ„æ˜¯<strong>æ•°ç»„</strong>ç§°ä¹‹ä¸º<strong>å“ˆå¸Œæ¡¶</strong>ï¼Œæ¯ä¸ª<strong>æ¡¶é‡Œé¢æ”¾çš„æ˜¯é“¾è¡¨</strong>ï¼Œé“¾è¡¨ä¸­çš„<strong>æ¯ä¸ªèŠ‚ç‚¹</strong>ï¼Œå°±æ˜¯å“ˆå¸Œè¡¨ä¸­çš„<strong>æ¯ä¸ªå…ƒç´ </strong>ã€‚<br>åœ¨ JDK8 ä¸­ï¼Œå½“é“¾è¡¨é•¿åº¦è¾¾åˆ° 8ï¼Œä¼šè½¬åŒ–æˆçº¢é»‘æ ‘ï¼Œä»¥æå‡å®ƒçš„æŸ¥è¯¢ã€æ’å…¥æ•ˆç‡ï¼Œå®ƒå®ç°äº†<code>Map&lt;K,V&gt;, Cloneable, Serializable</code>æ¥å£ã€‚</p>
<p>å› å…¶åº•å±‚å“ˆå¸Œæ¡¶çš„æ•°æ®ç»“æ„æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥ä¹Ÿä¼šæ¶‰åŠåˆ°<strong>æ‰©å®¹</strong>çš„é—®é¢˜ã€‚</p>
<p>å½“<code>HashMap</code>çš„å®¹é‡è¾¾åˆ°<code>threshold</code>åŸŸå€¼æ—¶ï¼Œå°±ä¼šè§¦å‘æ‰©å®¹ã€‚æ‰©å®¹å‰åï¼Œå“ˆå¸Œæ¡¶çš„<strong>é•¿åº¦ä¸€å®šä¼šæ˜¯ 2 çš„æ¬¡æ–¹</strong>ã€‚<br>è¿™æ ·åœ¨æ ¹æ® key çš„ hash å€¼å¯»æ‰¾å¯¹åº”çš„å“ˆå¸Œæ¡¶æ—¶ï¼Œå¯ä»¥<strong>ç”¨ä½è¿ç®—æ›¿ä»£å–ä½™æ“ä½œ</strong>ï¼Œ<strong>æ›´åŠ é«˜æ•ˆ</strong>ã€‚</p>
<p>è€Œ key çš„ hash å€¼ï¼Œå¹¶ä¸ä»…ä»…åªæ˜¯ key å¯¹è±¡çš„<code>hashCode()</code>æ–¹æ³•çš„è¿”å›å€¼ï¼Œè¿˜ä¼šç»è¿‡<strong>æ‰°åŠ¨å‡½æ•°</strong>çš„æ‰°åŠ¨ï¼Œä»¥ä½¿ hash å€¼æ›´åŠ å‡è¡¡ã€‚<br>å› ä¸º<code>hashCode()</code>æ˜¯<code>int</code>ç±»å‹ï¼Œå–å€¼èŒƒå›´æ˜¯ 40 å¤šäº¿ï¼Œåªè¦å“ˆå¸Œå‡½æ•°æ˜ å°„çš„æ¯”è¾ƒå‡åŒ€æ¾æ•£ï¼Œç¢°æ’å‡ ç‡æ˜¯å¾ˆå°çš„ã€‚ </p>
<a id="more"></a>
<p>ä½†å°±ç®—åŸæœ¬çš„<code>hashCode()</code>å–å¾—å¾ˆå¥½ï¼Œæ¯ä¸ª key çš„<code>hashCode()</code>ä¸åŒï¼Œä½†æ˜¯ç”±äº<code>HashMap</code>çš„å“ˆå¸Œæ¡¶çš„é•¿åº¦è¿œæ¯” hash å–å€¼èŒƒå›´å°ï¼Œé»˜è®¤æ˜¯ 16ï¼Œæ‰€ä»¥å½“å¯¹ hash å€¼ä»¥æ¡¶çš„é•¿åº¦å–ä½™ï¼Œä»¥æ‰¾åˆ°å­˜æ”¾è¯¥ key çš„æ¡¶çš„ä¸‹æ ‡æ—¶ï¼Œç”±äºå–ä½™æ˜¯é€šè¿‡ä¸æ“ä½œå®Œæˆçš„ï¼Œä¼šå¿½ç•¥ hash å€¼çš„é«˜ä½ã€‚å› æ­¤åªæœ‰<code>hashCode()</code>çš„ä½ä½å‚åŠ è¿ç®—ï¼Œå‘ç”Ÿä¸åŒçš„ hash å€¼ï¼Œä½†æ˜¯å¾—åˆ°çš„ index ç›¸åŒçš„æƒ…å†µçš„å‡ ç‡ä¼šå¤§å¤§å¢åŠ ï¼Œè¿™ç§æƒ…å†µç§°ä¹‹ä¸º<strong>hash ç¢°æ’ã€‚</strong> å³ï¼Œç¢°æ’ç‡ä¼šå¢å¤§ã€‚</p>
<p><strong>æ‰°åŠ¨å‡½æ•°</strong>å°±æ˜¯ä¸ºäº†è§£å†³ hash ç¢°æ’çš„ã€‚å®ƒä¼šç»¼åˆ hash å€¼é«˜ä½å’Œä½ä½çš„ç‰¹å¾ï¼Œå¹¶å­˜æ”¾åœ¨ä½ä½ï¼Œå› æ­¤åœ¨ä¸è¿ç®—æ—¶ï¼Œç›¸å½“äºé«˜ä½ä½ä¸€èµ·å‚ä¸äº†è¿ç®—ï¼Œä»¥å‡å°‘ hash ç¢°æ’çš„æ¦‚ç‡ã€‚ï¼ˆåœ¨ JDK8 ä¹‹å‰ï¼Œæ‰°åŠ¨å‡½æ•°ä¼šæ‰°åŠ¨å››æ¬¡ï¼ŒJDK8 ç®€åŒ–äº†è¿™ä¸ªæ“ä½œï¼‰</p>
<p>æ‰§è¡Œæ‰©å®¹æ“ä½œæ—¶ï¼Œä¼š new ä¸€ä¸ªæ–°çš„<code>Node</code>æ•°ç»„ä½œä¸ºå“ˆå¸Œæ¡¶ï¼Œç„¶åå°†åŸå“ˆå¸Œè¡¨ä¸­çš„æ‰€æœ‰æ•°æ®(<code>Node</code>èŠ‚ç‚¹)ç§»åŠ¨åˆ°æ–°çš„å“ˆå¸Œæ¡¶ä¸­ï¼Œç›¸å½“äºå¯¹åŸå“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„æ•°æ®é‡æ–°åšäº†ä¸€ä¸ª put æ“ä½œã€‚æ‰€ä»¥æ€§èƒ½æ¶ˆè€—å¾ˆå¤§ï¼Œ<strong>å¯æƒ³è€ŒçŸ¥ï¼Œåœ¨å“ˆå¸Œè¡¨çš„å®¹é‡è¶Šå¤§æ—¶ï¼Œæ€§èƒ½æ¶ˆè€—è¶Šæ˜æ˜¾ã€‚</strong></p>
<p>æ‰©å®¹æ—¶ï¼Œå¦‚æœå‘ç”Ÿè¿‡å“ˆå¸Œç¢°æ’ï¼ŒèŠ‚ç‚¹æ•°å°äº 8 ä¸ªã€‚åˆ™è¦æ ¹æ®é“¾è¡¨ä¸Šæ¯ä¸ªèŠ‚ç‚¹çš„å“ˆå¸Œå€¼ï¼Œä¾æ¬¡æ”¾å…¥æ–°å“ˆå¸Œæ¡¶å¯¹åº”ä¸‹æ ‡ä½ç½®ã€‚<br>å› ä¸ºæ‰©å®¹æ˜¯å®¹é‡ç¿»å€ï¼Œæ‰€ä»¥åŸé“¾è¡¨ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œç°åœ¨å¯èƒ½å­˜æ”¾åœ¨åŸæ¥çš„ä¸‹æ ‡ï¼Œå³ low ä½ï¼Œ æˆ–è€…æ‰©å®¹åçš„ä¸‹æ ‡ï¼Œå³ high ä½ã€‚ high ä½= low ä½+åŸå“ˆå¸Œæ¡¶å®¹é‡<br>å¦‚æœè¿½åŠ èŠ‚ç‚¹åï¼Œé“¾è¡¨æ•°é‡ã€‹=8ï¼Œåˆ™è½¬åŒ–ä¸ºçº¢é»‘æ ‘</p>
<p>ç”±è¿­ä»£å™¨çš„å®ç°å¯ä»¥çœ‹å‡ºï¼Œéå† HashMap æ—¶ï¼Œé¡ºåºæ˜¯æŒ‰ç…§å“ˆå¸Œæ¡¶ä»ä½åˆ°é«˜ï¼Œé“¾è¡¨ä»å‰å¾€åï¼Œä¾æ¬¡éå†çš„ã€‚å±äº<strong>æ— åº</strong>é›†åˆã€‚</p>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="ä¸¤ä¸ªé‡è¦çš„å‚æ•°"><a href="#ä¸¤ä¸ªé‡è¦çš„å‚æ•°" class="headerlink" title="ä¸¤ä¸ªé‡è¦çš„å‚æ•°"></a>ä¸¤ä¸ªé‡è¦çš„å‚æ•°</h3><blockquote>
<p>  An instance of <code>HashMap</code> has two parameters that affect its performance: <em>initial capacity</em> and <em>load factor</em>. <strong>The <em>capacity</em> is the number of buckets in the hash table</strong>, and the initial capacity is simply the capacity at the time the hash table is created. The <em>load factor</em> is a measure of how full the hash table is allowed to get before its capacity is automatically increased. When the number of entries in the hash table exceeds the product of the load factor and the current capacity, the hash table is <em>rehashed</em> (that is, internal data structures are rebuilt) so that the hash table has approximately twice the number of buckets.</p>
</blockquote>
<ul>
<li>capacityï¼šå®¹é‡ã€‚ä¹Ÿå°±æ˜¯å“ˆå¸Œæ¡¶æ•°ç»„çš„é•¿åº¦ã€‚é»˜è®¤åˆå§‹åŒ–å®¹é‡ä¸º 16ã€‚</li>
<li>loadFactorï¼šåŠ è½½å› å­ã€‚  æ‰©å®¹çš„é˜ˆå€¼ <code>threshold = capacity * loadFactor</code><ul>
<li>åŠ è½½å› å­é»˜è®¤ä¸º 0.75ï¼Œè¿™æ˜¯æ—¶é—´å’Œç©ºé—´ä¸Šçš„æŠ˜è¡·ç‚¹ã€‚å¤§äº 0.75ï¼Œèƒ½æé«˜ç©ºé—´åˆ©ç”¨ç‡ï¼Œä½†æ˜¯ä¼šå¯¼è‡´æŸ¥æ‰¾æ•ˆç‡é™ä½ã€‚</li>
</ul>
</li>
</ul>
<p>å½“ hashMap ä¸­å…ƒç´ çš„æ€»æ•°å¤§äº capacity * loadFactor  æ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ‰©å®¹ï¼ˆå°† buckets çš„æ•°ç›®è°ƒæ•´ä¸ºå½“å‰çš„ä¸¤å€ï¼‰ã€‚</p>
<p>capacity è¢«æ§åˆ¶ä¸º 2 çš„ n æ¬¡æ–¹ï¼ˆä¸€å®šæ˜¯åˆæ•°ï¼‰ï¼Œè¿™æœ‰ç‚¹ä¸åˆå¸¸è§„ã€‚å¸¸è§„çš„åšæ³•æ˜¯å°†æ¡¶æ•°ç»„çš„é•¿åº¦è®¾ç½®ä¸ºç´ æ•°ï¼Œå› ä¸ºç›¸å¯¹è€Œè¨€ä½¿ç”¨ç´ æ•°å‘ç”Ÿå†²çªçš„æ¦‚ç‡è¦æ¯”ä½¿ç”¨åˆæ•°è¦å°ä¸€äº›ã€‚HashTable é»˜è®¤åˆå§‹åŒ–å®¹é‡å°±ä¸º 11ï¼ˆç´ æ•°ï¼ŒHashtable æ‰©å®¹åä¸èƒ½ä¿è¯è¿˜æ˜¯ç´ æ•°ï¼‰ã€‚ä¹‹æ‰€ä»¥è¿™æ ·è®¾è®¡æ˜¯å–æ¨¡å’Œæ‰©å®¹æ—¶è¿›è¡Œä¼˜åŒ–ï¼ˆä½¿ç”¨ä½è¿ç®—<strong>æé«˜æ•ˆç‡</strong>ï¼‰ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†<strong>å‡å°‘å†²çª</strong>ï¼ŒHashMap å®šä½å“ˆå¸Œæ¡¶ç´¢å¼•ä½ç½®æ—¶ï¼Œä¹ŸåŠ å…¥äº†é«˜ä½å‚ä¸è¿ç®—çš„è¿‡ç¨‹ã€‚</p>
<h3 id="put-å‡½æ•°çš„å®ç°"><a href="#put-å‡½æ•°çš„å®ç°" class="headerlink" title="put å‡½æ•°çš„å®ç°"></a>put å‡½æ•°çš„å®ç°</h3><p>1.8 å¯¹ HashMap çš„åº•å±‚å®ç°è¿›è¡Œäº†ä¿®æ”¹ï¼ˆå½“ç›¸åŒ hash å€¼çš„å…ƒç´ å¤§äº 8 ä¸ªæ—¶ï¼Œä¼šå°†é“¾è¡¨è½¬æ¢ä¸º çº¢é»‘æ ‘ï¼Œä»¥æé«˜æŸ¥æ‰¾æ•ˆç‡ï¼‰ï¼Œæ‰€ä»¥ put å‡½æ•°çœ‹èµ·æ¥ç›¸å¯¹å¤æ‚äº†ç‚¹ï¼Œé€šè¿‡ä»¥ä¸‹æµç¨‹å›¾èƒ½å¸®åŠ©ç†è§£ã€‚</p>
<p>å›¾ç‰‡å‡ºè‡ª<a href="https://tech.meituan.com/img/java-hashmap/hashMap%20put%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E5%9B%BE.png" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>
<p><img width="858" alt="hashmap put" src="https://user-images.githubusercontent.com/16668676/30247192-dbfc4bf8-9640-11e7-9fd6-0aca25db077c.png"></p>
<p>æ³¨æ„ï¼šå¯¹äº resize æ–¹æ³•çš„æ˜¯å¦éœ€è¦æ‰§è¡Œæœ‰ä¸¤æ¬¡åˆ¤æ–­ï¼š</p>
<p>ç¬¬ä¸€æ¬¡åˆ¤æ–­æ¡¶æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é€šè¿‡ resize æ–¹æ³•æ‰§è¡Œåˆå§‹åŒ–æ“ä½œã€‚<br>ç¬¬äºŒæ¬¡åˆ¤æ–­æ˜¯åœ¨æ’å…¥æˆåŠŸåï¼Œåˆ¤æ–­å®é™…å­˜åœ¨çš„é”®å€¼å¯¹æ•°é‡ size æ˜¯å¦è¶…å¤šäº†æœ€å¤§å®¹é‡ thresholdï¼Œå¦‚æœè¶…è¿‡ï¼Œè¿›è¡Œæ‰©å®¹ã€‚</p>
<p>put æ–¹æ³•å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * å°†æŒ‡å®šçš„å€¼ä¸è¯¥æ˜ å°„ä¸­æŒ‡å®šçš„é”®å…³è”èµ·æ¥ã€‚</div><div class="line"> * å¦‚æœè¯¥ key å¯¹åº”çš„ value å­˜åœ¨ï¼Œåˆ™æ›¿æ¢æ—§å€¼</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></div><div class="line">               <span class="keyword">boolean</span> evict) &#123;</div><div class="line">    java.util.HashMap.Node&lt;K,V&gt;[] tab; java.util.HashMap.Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</div><div class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)<span class="comment">//æ¡¶æ•°ç»„ä¸ºç©ºæˆ–è€…é•¿åº¦ä¸º 0ï¼ˆè¯´æ˜è¿˜æœªåˆå§‹åŒ–ï¼‰</span></div><div class="line">        n = (tab = resize()).length;<span class="comment">//è°ƒç”¨æ‰©å®¹æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶è·å–åˆå§‹åŒ–åæ¡¶æ•°ç»„çš„é•¿åº¦</span></div><div class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)<span class="comment">//æ ¹æ® hash å€¼ä¸ n-1 è¿›è¡Œã€Œæ¨¡è¿ç®—ã€è·å–æ’å…¥æ•°ç»„çš„ç´¢å¼•çš„ iã€‚</span></div><div class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);<span class="comment">//åˆ›å»ºæ–°ç»“ç‚¹</span></div><div class="line">    <span class="keyword">else</span> &#123; <span class="comment">//å‘ç”Ÿç¢°æ’</span></div><div class="line">        java.util.HashMap.Node&lt;K,V&gt; e; K k;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;        <span class="comment">//key å€¼ç›¸åŒï¼Œæ›¿æ¢æ—§å€¼</span></div><div class="line">                ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">            e = p;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> java.util.HashMap.TreeNode)<span class="comment">//è¯¥é“¾ä¸ºæ ‘</span></div><div class="line">            e = ((java.util.HashMap.TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</div><div class="line">        <span class="keyword">else</span> &#123;<span class="comment">//è¯¥é“¾ä¸ºé“¾è¡¨</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</div><div class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></div><div class="line">                        treeifyBin(tab, hash);<span class="comment">//è½¬æ¢ä¸ºçº¢é»‘æ ‘</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</div><div class="line">                        ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                p = e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">      </div><div class="line">        <span class="comment">//å¦‚æœæœ¬èº«å­˜åœ¨ç›¸åŒçš„ keyï¼Œåˆ™å°†æ—§å€¼è¿”å›</span></div><div class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></div><div class="line">            V oldValue = e.value;</div><div class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</div><div class="line">                e.value = value;</div><div class="line">            afterNodeAccess(e);</div><div class="line">            <span class="keyword">return</span> oldValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ++modCount;<span class="comment">//ç»“æ„åŒ–ä¿®æ”¹æ¬¡æ•°åŠ  1</span></div><div class="line">    <span class="keyword">if</span> (++size &gt; threshold)<span class="comment">//å¦‚æœå½“å‰æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è¿›è¡Œæ‰©å®¹</span></div><div class="line">        resize();</div><div class="line">    afterNodeInsertion(evict);<span class="comment">//é»˜è®¤ä¸ºç©ºå®ç°</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;<span class="comment">//åŸå…ˆ key ä¸å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰æ—§å€¼ï¼Œç›´æ¥è¿”å› null</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="get-å‡½æ•°çš„å®ç°"><a href="#get-å‡½æ•°çš„å®ç°" class="headerlink" title="get å‡½æ•°çš„å®ç°"></a>get å‡½æ•°çš„å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * è·å–ç»™å®š key çš„ hash å€¼ï¼Œè·å–ç›¸åº”ä½ç½® value</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    java.util.HashMap.Node&lt;K,V&gt; e;</div><div class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">final</span> java.util.HashMap.<span class="function">Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</div><div class="line">    java.util.HashMap.Node&lt;K,V&gt;[] tab; java.util.HashMap.Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</div><div class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</div><div class="line">            (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; </div><div class="line">                ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))<span class="comment">//å…ˆæ£€æŸ¥å¯¹åº”ä½ç½®çš„ã€Œå¤´ç»“ç‚¹ã€ï¼Œå¦‚æœåŒ¹é…ç›´æ¥è¿”å›å¯¹åº”çš„å€¼</span></div><div class="line">            <span class="keyword">return</span> first;</div><div class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> java.util.HashMap.TreeNode)<span class="comment">//è¯¥é“¾æ˜¯çº¢é»‘æ ‘ï¼Œæ ¹æ® hash å’Œ key åˆ° æ ‘ä¸­æŸ¥æ‰¾ç›¸åº”çš„ value,ç›´æ¥è¿”å›</span></div><div class="line">                <span class="keyword">return</span> ((java.util.HashMap.TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</div><div class="line">            <span class="comment">//è¯¥é“¾æ˜¯é“¾è¡¨ï¼Œåˆ°é“¾è¡¨ä¸­éå†æŸ¥æ‰¾</span></div><div class="line">            <span class="keyword">do</span> &#123;</div><div class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</div><div class="line">                        ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">                    <span class="keyword">return</span> e;</div><div class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° get æ–¹æ³•çš„å¤§è‡´é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>å…ˆè®¡ç®—å‡ºå½“å‰ key çš„ hash å€¼ï¼Œç„¶åé€šè¿‡ getNode æ–¹æ³•å»è·å–å½“å‰å¯¹åº”çš„ç»“ç‚¹</li>
<li>å¦‚æœå¯¹åº”çš„èŠ‚ç‚¹ä¸º nullï¼Œç›´æ¥è¿”å› nullï¼Œ</li>
<li>å¦åˆ™è¿”å›èŠ‚ç‚¹ä¸­çš„  valueã€‚</li>
</ul>
<p>getNode æ–¹æ³•çš„å®ç°æ€è·¯æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>é€šè¿‡ hash è·Ÿ å½“å‰å®¹é‡è¿›è¡Œ <strong>ä¸è¿ç®—</strong> å¾—åˆ°æ•°ç»„ä¸‹æ ‡</li>
<li>ä½¿ç”¨æŒ‡å®šä¸‹æ ‡å»è·å–å¯¹åº”çš„èŠ‚ç‚¹ï¼ˆä»å¤´ç»“ç‚¹å¼€å§‹ï¼‰<ul>
<li>å¦‚æœé¦–ä¸ªå…ƒç´ å°±å‘½ä¸­ï¼Œç›´æ¥è¿”å›ç»“ç‚¹ã€‚</li>
<li>å­˜åœ¨å†²çªï¼š<br>å¦‚æœè¯¥ hash å€¼å¯¹åº”çš„æ˜¯ä¸€æ£µ<strong>çº¢é»‘æ ‘</strong>ï¼Œåˆ™åˆ°çº¢é»‘æ ‘ä¸­å»è·å–ç›¸åº”çš„ç»“ç‚¹ã€‚<br>å¦‚æœè¯¥ hash å€¼å¯¹åº”çš„æ˜¯ä¸€ä¸ª<strong>é“¾è¡¨</strong>ï¼Œåˆ™éå†è¯¥é“¾è¡¨ï¼Œç›´åˆ°å–å¾—ç›¸åº”çš„ç»“ç‚¹æˆ–è€…åˆ°è¾¾é“¾å°¾ã€‚</li>
</ul>
</li>
</ul>
<h3 id="hash-å‡½æ•°çš„å®ç°"><a href="#hash-å‡½æ•°çš„å®ç°" class="headerlink" title="hash å‡½æ•°çš„å®ç°"></a>hash å‡½æ•°çš„å®ç°</h3><p>åœ¨ HashMap ä¸­ï¼Œå“ˆå¸Œæ¡¶æ•°ç»„ table çš„é•¿åº¦ length å¤§å°å¿…é¡»ä¸º 2 çš„ n æ¬¡æ–¹(ä¸€å®šæ˜¯åˆæ•°)ï¼Œè¿™æ˜¯ä¸€ç§<strong>éå¸¸è§„çš„è®¾è®¡</strong>ï¼Œ<strong>å¸¸è§„çš„è®¾è®¡æ˜¯æŠŠæ¡¶çš„å¤§å°è®¾è®¡ä¸ºç´ æ•°</strong>ã€‚ç›¸å¯¹æ¥è¯´ç´ æ•°å¯¼è‡´å†²çªçš„æ¦‚ç‡è¦å°äºåˆæ•°ï¼Œå…·ä½“è¯æ˜å¯ä»¥å‚è€ƒ<a href="http://blog.csdn.net/liuqiyao_01/article/details/14475159" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ï¼ŒHashtable åˆå§‹åŒ–æ¡¶å¤§å°ä¸º 11ï¼Œå°±æ˜¯æ¡¶å¤§å°è®¾è®¡ä¸ºç´ æ•°çš„åº”ç”¨ï¼ˆHashtable æ‰©å®¹åä¸èƒ½ä¿è¯è¿˜æ˜¯ç´ æ•°ï¼‰ã€‚HashMap é‡‡ç”¨è¿™ç§éå¸¸è§„è®¾è®¡ï¼Œ<strong>ä¸»è¦æ˜¯ä¸ºäº†åœ¨å–æ¨¡å’Œæ‰©å®¹æ—¶åšä¼˜åŒ–ï¼ŒåŒæ—¶ä¸ºäº†å‡å°‘å†²çª</strong>ï¼ŒHashMap å®šä½å“ˆå¸Œæ¡¶ç´¢å¼•ä½ç½®æ—¶ï¼Œä¹ŸåŠ å…¥äº†é«˜ä½å‚ä¸è¿ç®—çš„è¿‡ç¨‹ã€‚</p>
<p>é€šè¿‡ <code>h &amp; (table.length -1)</code> æ¥å¾—åˆ°è¯¥å¯¹è±¡çš„ä¿å­˜ä½ï¼Œè€Œ <code>HashMap</code> åº•å±‚æ•°ç»„çš„é•¿åº¦æ€»æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼Œè¿™æ˜¯ HashMap åœ¨é€Ÿåº¦ä¸Šçš„ä¼˜åŒ–ã€‚å½“ length æ€»æ˜¯ 2 çš„ n æ¬¡æ–¹æ—¶ï¼Œh&amp; (length-1) è¿ç®—ç­‰ä»·äºå¯¹ length å–æ¨¡ï¼Œä¹Ÿå°±æ˜¯ h%lengthï¼Œä½†æ˜¯&amp;æ¯”%å…·æœ‰æ›´é«˜çš„æ•ˆç‡ã€‚</p>
<ul>
<li><code>h &amp; (length - 1) ã€Š==ã€‹ h % length</code></li>
</ul>
<p>åœ¨ JDK1.8 çš„å®ç°ä¸­ï¼Œä¼˜åŒ–äº†é«˜ä½è¿ç®—çš„ç®—æ³•ï¼Œé€šè¿‡ <code>hashCode()</code>çš„é«˜ 16 ä½ï¼ˆå…¶å®æ˜¯å®Œæ•´çš„ï¼‰ å¼‚æˆ– ä½ 16 ä½å®ç°çš„ï¼š(h = k.hashCode()) ^ (h &gt;&gt;&gt; 16)ï¼Œä¸»è¦æ˜¯ä»é€Ÿåº¦ã€åŠŸæ•ˆã€è´¨é‡æ¥è€ƒè™‘çš„ï¼Œè¿™ä¹ˆåšå¯ä»¥åœ¨æ•°ç»„ table çš„ length æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œä¹Ÿèƒ½ä¿è¯è€ƒè™‘åˆ°é«˜ä½ Bit éƒ½å‚ä¸åˆ° Hash çš„è®¡ç®—ä¸­ï¼ŒåŒæ—¶ä¸ä¼šæœ‰å¤ªå¤§çš„å¼€é”€ã€‚</p>
<p>hash æ˜¯ int ç±»å‹çš„ï¼ˆ32 ä½ï¼‰ï¼ŒåŸ hashcode å¼‚æˆ– å³ç§» 16 ä½åçš„ hashcodeï¼Œé«˜ä½ä½å…¼é¡¾</p>
<ul>
<li>å³ç§» 16 ä½ï¼Œé‚£ä¹ˆé«˜ 16 ä½å‡ä¸º 0ï¼Œæ‰€ä»¥é«˜åå…­ä½çš„å–å€¼ç”± key çš„ hashCode çš„é«˜åå…­ä½ç¡®å®šï¼Œ</li>
<li>ä½ 16 ä½çš„å€¼ç”± hashcode çš„ä½åå…­ä½ä¸é«˜åå…­ä½</li>
</ul>
<p>åœ¨ get å’Œ put çš„è¿‡ç¨‹ä¸­ï¼Œè®¡ç®—ä¸‹æ ‡æ—¶ï¼Œå…ˆå¯¹ hashCode è¿›è¡Œ hash æ“ä½œï¼Œç„¶åå†é€šè¿‡ hash å€¼è¿›ä¸€æ­¥è®¡ç®—ä¸‹æ ‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://cloud.githubusercontent.com/assets/1736354/6957712/293b52fc-d932-11e4-854d-cb47be67949a.png" alt="hash"></p>
<p>åœ¨å¯¹ hashCode()è®¡ç®— hash æ—¶å…·ä½“å®ç°æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> h;</div><div class="line">  	<span class="comment">//å› ä¸º h &gt;&gt;&gt; 16 å³ç§»äº† 16 ä½(é«˜ 16 ä½éƒ½ä¸º 0)ï¼Œå› æ­¤ç»“æœçš„é«˜ 16 ä½ä»ç„¶æ˜¯ key.hashCode() çš„é«˜ 16 ä½</span></div><div class="line">  	<span class="comment">//è€Œä½ 16 ä½å–å†³äº key.hashCode() çš„é«˜åå…­ä½å’Œä½åå…­ä½è¿›è¡Œå¼‚æˆ–çš„ç»“æœ</span></div><div class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°å¤§æ¦‚çš„ä½œç”¨å°±æ˜¯ï¼š<strong>é«˜ 16bit ä¸å˜ï¼Œä½ 16bit å’Œé«˜ 16bit åšäº†ä¸€ä¸ªå¼‚æˆ–</strong>ã€‚è¿™æ ·åšçš„ç›®çš„å°±åœ¨äºä½ æ±‚ä½™çš„æ—¶å€™<strong>åŒ…å«äº†é«˜ 16 ä½å’Œç¬¬ 16 ä½çš„ç‰¹æ€§</strong> ä¹Ÿå°±æ˜¯è¯´ä½ æ‰€è®¡ç®—å‡ºæ¥çš„ hash å€¼åŒ…å«ä»è€Œä½¿å¾—ä½ çš„ hash å€¼æ›´åŠ ã€Œéšæœºã€ä»¥é™ä½ç¢°æ’çš„æ¦‚ç‡</p>
<h4 id="è®¡ç®—ä¸‹æ ‡"><a href="#è®¡ç®—ä¸‹æ ‡" class="headerlink" title="è®¡ç®—ä¸‹æ ‡"></a>è®¡ç®—ä¸‹æ ‡</h4><p>å­˜å‚¨ç»“ç‚¹æ—¶ï¼Œè®¡ç®—å¾—åˆ°çš„ hash å€¼å¯èƒ½è¿œå¤§äºå“ˆå¸Œæ¡¶æ•°ç»„çš„é•¿åº¦ï¼Œä¸ºäº†é¿å…æ•°ç»„è¶Šç•Œï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œ<strong>å–æ¨¡è¿ç®—</strong>ã€‚è®¡ç®—ä¸‹æ ‡çš„æ—¶å€™ï¼Œæ˜¯è¿™æ ·å®ç°çš„(ä½¿ç”¨<code>&amp;</code>ä½æ“ä½œï¼Œè€Œé<code>%</code>æ±‚ä½™)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(n - <span class="number">1</span>) &amp; hash</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„è®¡ç®—å®é™…ä¸Šç­‰ä»·äº<code>hash % n</code>ï¼Œä½†æ˜¯å‰è€…çš„æ•ˆç‡æ¯”è¾ƒé«˜ã€‚å‰é¢æˆ‘ä»¬æåˆ°è¿‡ï¼ŒHashMap çš„æ•°ç»„é•¿åº¦ä¸€å®šæ˜¯ 2 çš„ ï¼Ÿæ¬¡æ–¹ã€‚ä¹Ÿå°±æ˜¯è¯´ (n - 1) å¯ä»¥åŒ–ä¸º 0â€¦0011â€¦1ï¼Œè¿™æ ·è·Ÿ hash è¿›è¡Œä¸è¿ç®—ï¼Œå°±ç›¸å½“äºå–æ¨¡è¿ç®—ã€‚</p>
<h4 id="Java-8-æ‰€åšçš„ä¼˜åŒ–"><a href="#Java-8-æ‰€åšçš„ä¼˜åŒ–" class="headerlink" title="Java 8 æ‰€åšçš„ä¼˜åŒ–"></a>Java 8 æ‰€åšçš„ä¼˜åŒ–</h4><p>hash å‡½æ•°è®¾è®¡å¾—å†å¥½ï¼Œä¹Ÿæ— æ³•é¿å…å†²çªçš„ã€‚å¦‚ä½•è§£å†³å†²çªä¹Ÿæ˜¯ä¸€é—¨å­¦é—®ã€‚</p>
<p>åœ¨ Java 8 ä¹‹å‰çš„å®ç°ä¸­æ˜¯ç”¨é“¾è¡¨è§£å†³å†²çªçš„ï¼Œåœ¨äº§ç”Ÿç¢°æ’çš„æƒ…å†µä¸‹ï¼Œè¿›è¡Œ get æ—¶ï¼Œä¸¤æ­¥çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)+O(n)ã€‚å› æ­¤ï¼Œå½“ç¢°æ’å¾ˆå‰å®³çš„æ—¶å€™ n å¾ˆå¤§ï¼ŒO(n)çš„é€Ÿåº¦æ˜¾ç„¶æ˜¯å½±å“é€Ÿåº¦çš„ã€‚</p>
<p>å› æ­¤åœ¨ Java 8 ä¸­ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äº 8 æ—¶ï¼Œå°±åˆ©ç”¨çº¢é»‘æ ‘æ›¿æ¢é“¾è¡¨ï¼Œè¿™æ ·å¤æ‚åº¦å°±å˜æˆäº† O(1)+O(logn)äº†ï¼Œè¿™æ ·åœ¨ n å¾ˆå¤§çš„æ—¶å€™ï¼Œèƒ½å¤Ÿæ¯”è¾ƒç†æƒ³çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨<a href="http://www.importnew.com/14417.html" target="_blank" rel="noopener">Java 8ï¼šHashMap çš„æ€§èƒ½æå‡</a>ä¸€æ–‡ä¸­æœ‰æ€§èƒ½æµ‹è¯•çš„ç»“æœã€‚</p>
<h3 id="resize-ï¼ˆæ‰©å®¹ï¼‰å®ç°"><a href="#resize-ï¼ˆæ‰©å®¹ï¼‰å®ç°" class="headerlink" title="resize ï¼ˆæ‰©å®¹ï¼‰å®ç°"></a>resize ï¼ˆæ‰©å®¹ï¼‰å®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * åˆå§‹åŒ–æˆ–è€…æ‰©å®¹ä¸€å€</div><div class="line"> * */</div><div class="line"><span class="keyword">final</span> java.util.HashMap.Node&lt;K,V&gt;[] resize() &#123;</div><div class="line">    java.util.HashMap.Node&lt;K,V&gt;[] oldTab = table;</div><div class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;<span class="comment">//æ—§é•¿åº¦</span></div><div class="line">    <span class="keyword">int</span> oldThr = threshold;<span class="comment">//æ—§é˜ˆå€¼</span></div><div class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</div><div class="line">    <span class="comment">//è¿™ä¸€æ®µä»£ç ç”¨äºç¡®å®šæ–°å®¹é‡,å¹¶æ ¹æ®æ–°å®¹é‡é‡æ–°ç¡®å®šé˜ˆå€¼</span></div><div class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;<span class="comment">//æ—§å®¹é‡å¤§äºæœ€å¤§å…è®¸å®¹é‡ï¼Œå°†é˜ˆå€¼èµ‹å€¼ä¸ºæœ€å¤§å…è®¸å®¹é‡</span></div><div class="line">            threshold = Integer.MAX_VALUE;</div><div class="line">            <span class="keyword">return</span> oldTab;<span class="comment">//ç›´æ¥è¿”å›æ—§è¡¨</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</div><div class="line">                oldCap &gt;= DEFAULT_INITIAL_CAPACITY)<span class="comment">//æ‰©å®¹åå°äºå…è®¸çš„æœ€å¤§å®¹é‡ï¼Œä¸”å¤§äºé»˜è®¤åˆå§‹å®¹é‡ï¼ˆ16ï¼‰ï¼Œåˆ™ä¿®æ”¹ threshold</span></div><div class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// threshold å¢å¤§ä¸€å€</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// åŸæœ‰é˜ˆå€¼å¤§äº 0ï¼Œä½†æ˜¯åŸå®¹é‡å°äº 0</span></div><div class="line">        newCap = oldThr;<span class="comment">//å°†æ–°å®¹é‡èµ‹å€¼ä¸ºå°±æ—§é˜ˆå€¼</span></div><div class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// åŸé˜ˆå€¼ã€åŸå®¹é‡å‡ä¸º 0 ï¼Œä½¿ç”¨é»˜è®¤çš„åˆå§‹åŒ–å‚æ•°æ¥åˆ›å»º map</span></div><div class="line">        newCap = DEFAULT_INITIAL_CAPACITY;<span class="comment">//é»˜è®¤çš„åˆå§‹åŒ–å®¹é‡ ï¼ˆ16ï¼‰</span></div><div class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);<span class="comment">//æ–°çš„é˜ˆå€¼</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;<span class="comment">//å¦‚æœæ–°é˜ˆå€¼ä¸º 0</span></div><div class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;<span class="comment">//é‡æ–°è®¡ç®—</span></div><div class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</div><div class="line">                (<span class="keyword">int</span>)ft : Integer.MAX_VALUE); <span class="comment">//å¦‚æœé˜ˆå€¼å¤§äºæœ€å¤§å®¹é‡ï¼Œä¿®æ”¹é˜ˆå€¼ä¸º int çš„æœ€å¤§å€¼(2^31-1)ï¼Œè¿™æ ·ä»¥åå°±ä¸ä¼šæ‰©å®¹äº†</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    threshold = newThr;</div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</div><div class="line">    java.util.HashMap.Node&lt;K,V&gt;[] newTab = (java.util.HashMap.Node&lt;K,V&gt;[])<span class="keyword">new</span> java.util.HashMap.Node[newCap];<span class="comment">//æŒ‰ç…§æ–°å®¹é‡ åˆ›å»ºæ•°ç»„</span></div><div class="line">    table = newTab;</div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;<span class="comment">//åŸæœ‰çš„ map ä¸Šçš„å…ƒç´ ä¸ä¸ºç©ºï¼Œå°†åŸæœ‰ map ä¸Šé¢çš„æ•°æ®å¤åˆ¶åˆ°æ–°çš„ map ä¸Šé¢</span></div><div class="line">        <span class="comment">//éå†æ—§å…ƒç´ </span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</div><div class="line">            java.util.HashMap.Node&lt;K,V&gt; e;</div><div class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</div><div class="line">                oldTab[j] = <span class="keyword">null</span>;<span class="comment">//é‡Šæ”¾ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span></div><div class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</div><div class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;<span class="comment">//è¯¥æ¡¶ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œè·å–çš„ hash å€¼å¹¶ä¸ï¼ˆæ–°å®¹é‡ -1ï¼‰è¿›è¡Œ ä¸è¿ç®—</span></div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> java.util.HashMap.TreeNode)<span class="comment">//å¦‚æœè¯¥å…ƒç´ æ˜¯ä¸€ä¸ªæ ‘èŠ‚ç‚¹ï¼ˆè¯´æ˜è¯¥æ¡¶å¯¹åº”æœ‰ä¸€æ£µçº¢é»‘æ ‘ï¼‰ï¼Œå°†æ ‘å­˜å‚¨åˆ°æ–°æ•°ç»„ä¸Š</span></div><div class="line">                    ((java.util.HashMap.TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</div><div class="line">                <span class="keyword">else</span> &#123; <span class="comment">// ä¿æŒé¡ºåº</span></div><div class="line">                    <span class="comment">//å› ä¸ºæ‰©å®¹æ˜¯å®¹é‡ç¿»å€ï¼Œæ‰€ä»¥åŸé“¾è¡¨ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œç°åœ¨å¯èƒ½å­˜æ”¾åœ¨åŸæ¥çš„ä¸‹æ ‡ï¼Œå³ low ä½ï¼Œ æˆ–è€…æ‰©å®¹åçš„ä¸‹æ ‡ï¼Œå³ high ä½ã€‚ high ä½ = low ä½+åŸå“ˆå¸Œæ¡¶å®¹é‡</span></div><div class="line">                    <span class="comment">//ä½ä½é“¾è¡¨çš„å¤´ç»“ç‚¹ã€å°¾èŠ‚ç‚¹</span></div><div class="line">                    java.util.HashMap.Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</div><div class="line">                    <span class="comment">//é«˜ä½é“¾è¡¨çš„å¤´ç»“ç‚¹ã€å°¾èŠ‚ç‚¹</span></div><div class="line">                    java.util.HashMap.Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</div><div class="line">                    <span class="comment">//ä¸´æ—¶ç»“ç‚¹</span></div><div class="line">                    java.util.HashMap.Node&lt;K,V&gt; next;</div><div class="line">                    <span class="keyword">do</span> &#123;</div><div class="line">                        next = e.next;</div><div class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;<span class="comment">//æ ¹æ® hash å€¼ä¸ oldCap çš„è¿ç®—ç»“æœï¼Œå°†é“¾è¡¨ä¸­é›†ç»“çš„å…ƒç´ åˆ†å¼€ï¼Œå¯è®¤ä¸ºç»“æœæ˜¯éšæœºçš„</span></div><div class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</div><div class="line">                                loHead = e;</div><div class="line">                            <span class="keyword">else</span></div><div class="line">                                loTail.next = e;</div><div class="line">                            loTail = e;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">else</span> &#123;</div><div class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</div><div class="line">                                hiHead = e;</div><div class="line">                            <span class="keyword">else</span></div><div class="line">                                hiTail.next = e;</div><div class="line">                            hiTail = e;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</div><div class="line">                    <span class="comment">//åœ¨åŸç´¢å¼•å¤„å­˜æ”¾ ã€Œä½ä½é“¾è¡¨ã€</span></div><div class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</div><div class="line">                        loTail.next = <span class="keyword">null</span>;</div><div class="line">                        newTab[j] = loHead;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//åœ¨åŸç´¢å¼•åŠ ä¸ŠåŸå®¹é‡å¤„ï¼Œå­˜æ”¾ã€Œé«˜ä½é“¾è¡¨ã€</span></div><div class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</div><div class="line">                        hiTail.next = <span class="keyword">null</span>;</div><div class="line">                        newTab[j + oldCap] = hiHead;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> newTab;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ 2 æ¬¡å¹‚çš„æ‰©å±•(æŒ‡é•¿åº¦æ‰©ä¸ºåŸæ¥ 2 å€)ï¼Œæ‰€ä»¥ï¼Œ<strong>å…ƒç´ çš„ä½ç½®è¦ä¹ˆæ˜¯åœ¨åŸä½ç½®ï¼Œè¦ä¹ˆæ˜¯åœ¨åŸä½ç½®å†ç§»åŠ¨ 2 æ¬¡å¹‚çš„ä½ç½®</strong>ã€‚çœ‹ä¸‹å›¾å¯ä»¥æ˜ç™½è¿™å¥è¯çš„æ„æ€ï¼Œn ä¸º table çš„é•¿åº¦ï¼Œå›¾ï¼ˆaï¼‰è¡¨ç¤ºæ‰©å®¹å‰çš„ key1 å’Œ key2 ä¸¤ç§ key ç¡®å®šç´¢å¼•ä½ç½®çš„ç¤ºä¾‹ï¼Œå›¾ï¼ˆbï¼‰è¡¨ç¤ºæ‰©å®¹å key1 å’Œ key2 ä¸¤ç§ key ç¡®å®šç´¢å¼•ä½ç½®çš„ç¤ºä¾‹ï¼Œå…¶ä¸­ hash1 æ˜¯ key1 å¯¹åº”çš„å“ˆå¸Œä¸é«˜ä½è¿ç®—ç»“æœã€‚</p>
<p><img src="https://tech.meituan.com/img/java-hashmap/hashMap%201.8%20%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E4%BE%8B%E5%9B%BE1.png" alt="hashMap 1.8 å“ˆå¸Œç®—æ³•ä¾‹å›¾ 1"></p>
<p>å…ƒç´ åœ¨é‡æ–°è®¡ç®— hash ä¹‹åï¼Œå› ä¸º n å˜ä¸º 2 å€ï¼Œé‚£ä¹ˆ n-1 çš„ mask èŒƒå›´åœ¨é«˜ä½å¤š 1bit(çº¢è‰²)ï¼Œå› æ­¤æ–°çš„ index å°±ä¼šå‘ç”Ÿè¿™æ ·çš„å˜åŒ–ï¼š</p>
<p><img src="https://tech.meituan.com/img/java-hashmap/hashMap%201.8%20%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E4%BE%8B%E5%9B%BE2.png" alt="hashMap 1.8 å“ˆå¸Œç®—æ³•ä¾‹å›¾ 2"></p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ‰©å…… HashMap çš„æ—¶å€™ï¼Œä¸éœ€è¦åƒ JDK1.7 çš„å®ç°é‚£æ ·é‡æ–°è®¡ç®— hashï¼Œåªéœ€è¦çœ‹çœ‹åŸæ¥çš„ hash å€¼æ–°å¢çš„é‚£ä¸ª bit æ˜¯ 1 è¿˜æ˜¯ 0 å°±å¥½äº†ï¼Œ<strong>æ˜¯ 0 çš„è¯ç´¢å¼•æ²¡å˜ï¼Œæ˜¯ 1 çš„è¯ç´¢å¼•å˜æˆâ€œåŸç´¢å¼•+oldCap</strong>ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹å›¾ä¸º 16 æ‰©å……ä¸º 32 çš„ resize ç¤ºæ„å›¾ï¼š</p>
<p><img src="https://tech.meituan.com/img/java-hashmap/jdk1.8%20hashMap%E6%89%A9%E5%AE%B9%E4%BE%8B%E5%9B%BE.png" alt="jdk1.8 hashMap æ‰©å®¹ä¾‹å›¾"></p>
<p>è¿™ä¸ªè®¾è®¡ç¡®å®éå¸¸çš„å·§å¦™ï¼Œæ—¢çœå»äº†é‡æ–°è®¡ç®— hash å€¼çš„æ—¶é—´ï¼Œè€Œä¸”åŒæ—¶ï¼Œç”±äºæ–°å¢çš„ 1bit æ˜¯ 0 è¿˜æ˜¯ 1 å¯ä»¥è®¤ä¸ºæ˜¯éšæœºçš„ï¼Œå› æ­¤ resize çš„è¿‡ç¨‹ï¼Œå‡åŒ€çš„æŠŠä¹‹å‰çš„å†²çªçš„èŠ‚ç‚¹åˆ†æ•£åˆ°æ–°çš„ bucket äº†ã€‚è¿™ä¸€å—å°±æ˜¯ JDK1.8 æ–°å¢çš„ä¼˜åŒ–ç‚¹ã€‚</p>
<h3 id="æ ‘åŒ–ä¸é“¾è¡¨åŒ–"><a href="#æ ‘åŒ–ä¸é“¾è¡¨åŒ–" class="headerlink" title="æ ‘åŒ–ä¸é“¾è¡¨åŒ–"></a>æ ‘åŒ–ä¸é“¾è¡¨åŒ–</h3><p>å½“å†²çªé“¾è¡¨é•¿åº¦è¾¾åˆ° 8 çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ <code>treeifyBin</code> å°è¯•å°†é“¾è¡¨è½¬æ¢ä¸ºæ ‘ã€‚</p>
<p>å¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64 çš„è¯ï¼Œåªä¼šè§¦å‘æ‰©å®¹ï¼Œè€Œä¸ä¼šå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> hash)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n, index; Node&lt;K,V&gt; e;</div><div class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)<span class="comment">//åœ¨ã€Œæ ‘åŒ–ã€ä¹‹å‰å…ˆåˆ¤æ–­ï¼Œå½“å‰çš„å®¹é‡</span></div><div class="line">        resize();</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((e = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</div><div class="line">        TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span class="keyword">null</span>);</div><div class="line">            <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</div><div class="line">                hd = p;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                p.prev = tl;</div><div class="line">                tl.next = p;</div><div class="line">            &#125;</div><div class="line">            tl = p;</div><div class="line">        &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">if</span> ((tab[index] = hd) != <span class="keyword">null</span>)</div><div class="line">            hd.treeify(tab);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“ç§»é™¤å…ƒç´ æˆ–è€…æ˜¯æ‰©å®¹çš„æ—¶å€™ï¼Œå¦‚æœæ ‘çš„å¤§å°&lt;=6ï¼Œä¼šè°ƒç”¨ HashMap.TreeNode#untreeify æ–¹æ³•å°†çº¢é»‘æ ‘è½¬æ¢ä¸ºé“¾è¡¨ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆè¦è¿›è¡Œã€Œæ ‘åŒ–ã€å‘¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦è¿›è¡Œã€Œæ ‘åŒ–ã€å‘¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦è¿›è¡Œã€Œæ ‘åŒ–ã€å‘¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦è¿›è¡Œã€Œæ ‘åŒ–ã€å‘¢ï¼Ÿ</h4><p>ä¸€æ–¹é¢æ˜¯ä¸ºäº†ä¿è¯æ€§èƒ½ï¼Œå¦‚æœåŒä¸€ä¸ªæ¡¶ä¸Šé¢çš„å†²çªéƒ½é€šè¿‡é“¾è¡¨è¿æ¥ï¼Œé“¾è¡¨çš„æŸ¥è¯¢æ˜¯çº¿æ€§çš„ï¼ŒåŒä¸€ä¸ªæ¡¶ä¸Šå†²çªè¾ƒå¤šçš„æ—¶å€™ï¼Œä¼šä¸¥é‡å½±å“å­˜å–çš„æ€§èƒ½ã€‚</p>
<p>å¦ä¸€ä¸ªåŸå› å…¶å®ä¹Ÿæ˜¯ç”±æ€§èƒ½é—®é¢˜å¼•å‘çš„å“ˆå¸Œç¢°æ’æ‹’ç»æœåŠ¡æ”»å‡»ï¼Œå› ä¸ºæ„é€ å“ˆå¸Œå†²çªçš„æ•°æ®å¹¶ä¸æ˜¯å›°éš¾çš„äº‹æƒ…ï¼Œæ¶æ„ä»£ç å¯ä»¥æ„é€ è¿™æ ·çš„æ•°æ®å¤§é‡ä¸æœåŠ¡ç«¯äº¤äº’ï¼Œå¯¼è‡´æœåŠ¡ç«¯CPU å¤§é‡å ç”¨ã€‚</p>
<h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><p>æ­¤éƒ¨åˆ†å†…å®¹å‚è€ƒè‡ª<a href="http://yikun.github.io/2015/04/01/Java-HashMap%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/" target="_blank" rel="noopener">HashMap çš„å·¥ä½œåŸç†</a></p>
<p><strong>1. ä»€ä¹ˆæ—¶å€™ä¼šä½¿ç”¨ HashMapï¼Ÿä»–æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ</strong><br>æ˜¯åŸºäº Map æ¥å£çš„å®ç°ï¼Œå­˜å‚¨é”®å€¼å¯¹æ—¶ï¼Œå®ƒå¯ä»¥æ¥æ”¶ null çš„é”®å€¼ï¼Œæ˜¯éåŒæ­¥çš„ï¼ŒHashMap å­˜å‚¨ç€ Entry(hash, key, value, next)å¯¹è±¡ã€‚</p>
<p><strong>2. ä½ çŸ¥é“ HashMap çš„å·¥ä½œåŸç†å—ï¼Ÿ</strong><br>é€šè¿‡ hash çš„æ–¹æ³•ï¼Œé€šè¿‡ put å’Œ get å­˜å‚¨å’Œè·å–å¯¹è±¡ã€‚å­˜å‚¨å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬å°† K/V ä¼ ç»™ put æ–¹æ³•æ—¶ï¼Œå®ƒè°ƒç”¨ hashCode è®¡ç®— hash ä»è€Œå¾—åˆ° bucket ä½ç½®ï¼Œè¿›ä¸€æ­¥å­˜å‚¨ï¼ŒHashMap ä¼šæ ¹æ®å½“å‰ bucket çš„å ç”¨æƒ…å†µè‡ªåŠ¨è°ƒæ•´å®¹é‡(è¶…è¿‡ Load Facotr åˆ™ resize ä¸ºåŸæ¥çš„ 2 å€)ã€‚è·å–å¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬å°† K ä¼ ç»™ getï¼Œå®ƒè°ƒç”¨ hashCode è®¡ç®— hash ä»è€Œå¾—åˆ° bucket ä½ç½®ï¼Œå¹¶è¿›ä¸€æ­¥è°ƒç”¨ equals()æ–¹æ³•ç¡®å®šé”®å€¼å¯¹ã€‚å¦‚æœå‘ç”Ÿç¢°æ’çš„æ—¶å€™ï¼ŒHashmap é€šè¿‡é“¾è¡¨å°†äº§ç”Ÿç¢°æ’å†²çªçš„å…ƒç´ ç»„ç»‡èµ·æ¥ï¼Œåœ¨ Java 8 ä¸­ï¼Œå¦‚æœä¸€ä¸ª bucket ä¸­ç¢°æ’å†²çªçš„å…ƒç´ è¶…è¿‡æŸä¸ªé™åˆ¶(é»˜è®¤æ˜¯ 8)ï¼Œåˆ™ä½¿ç”¨çº¢é»‘æ ‘æ¥æ›¿æ¢é“¾è¡¨ï¼Œä»è€Œæé«˜é€Ÿåº¦ã€‚</p>
<p><strong>3. ä½ çŸ¥é“ get å’Œ put çš„åŸç†å—ï¼Ÿequals()å’Œ hashCode()çš„éƒ½æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</strong><br>é€šè¿‡å¯¹ key çš„ hashCode()è¿›è¡Œ hashingï¼Œå¹¶è®¡ç®—ä¸‹æ ‡( n-1 &amp; hash)ï¼Œä»è€Œè·å¾— buckets çš„ä½ç½®ã€‚å¦‚æœäº§ç”Ÿç¢°æ’ï¼Œåˆ™åˆ©ç”¨ key.equals()æ–¹æ³•å»é“¾è¡¨æˆ–æ ‘ä¸­å»æŸ¥æ‰¾å¯¹åº”çš„èŠ‚ç‚¹</p>
<p><strong>4. ä½ çŸ¥é“ hash çš„å®ç°å—ï¼Ÿä¸ºä»€ä¹ˆè¦è¿™æ ·å®ç°ï¼Ÿ</strong><br>åœ¨ Java 1.8 çš„å®ç°ä¸­ï¼Œæ˜¯é€šè¿‡ hashCode()çš„é«˜ 16 ä½å¼‚æˆ–ä½ 16 ä½å®ç°çš„ï¼š<code>(h = k.hashCode()) ^ (h &gt;&gt;&gt; 16)</code>ï¼Œä¸»è¦æ˜¯ä»é€Ÿåº¦ã€åŠŸæ•ˆã€è´¨é‡æ¥è€ƒè™‘çš„ï¼Œè¿™ä¹ˆåšå¯ä»¥åœ¨ bucket çš„ n æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œä¹Ÿèƒ½ä¿è¯è€ƒè™‘åˆ°é«˜ä½ bit éƒ½å‚ä¸åˆ° hash çš„è®¡ç®—ä¸­ï¼ŒåŒæ—¶ä¸ä¼šæœ‰å¤ªå¤§çš„å¼€é”€ã€‚</p>
<p><strong>5. å¦‚æœ HashMap çš„å¤§å°è¶…è¿‡äº†è´Ÿè½½å› å­(load factor)å®šä¹‰çš„å®¹é‡ï¼Œæ€ä¹ˆåŠï¼Ÿ</strong><br>å¦‚æœè¶…è¿‡äº†è´Ÿè½½å› å­(é»˜è®¤ 0.75)ï¼Œåˆ™ä¼šé‡æ–° resize ä¸€ä¸ªåŸæ¥é•¿åº¦ä¸¤å€çš„ HashMapï¼Œå¹¶ä¸”é‡æ–°è°ƒç”¨ hash æ–¹æ³•ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://blog.csdn.net/zxt0601/article/details/77413921" target="_blank" rel="noopener">é¢è¯•å¿…å¤‡ï¼šHashMap æºç è§£æï¼ˆJDK8ï¼‰</a></li>
<li><a href="https://www.zhihu.com/question/20733617" target="_blank" rel="noopener">HashMap çš„ hash å‡½æ•°åŸç†</a></li>
<li><a href="https://tech.meituan.com/java-hashmap.html" target="_blank" rel="noopener">é‡æ–°è®¤è¯† HashMap</a></li>
<li><a href="http://yikun.github.io/2015/04/01/Java-HashMap å·¥ä½œåŸç†åŠå®ç°/" target="_blank" rel="noopener">HashMap çš„å·¥ä½œåŸç†</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®æ¬¢è¿åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> javaé›†åˆæ¡†æ¶ </category>
            
            <category> åŸç†åˆ†æ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> javaé›†åˆæ¡†æ¶ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JVM åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥]]></title>
      <url>https://timlin-pro.github.io/blog/2017/09/08/JVM%20%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B8%8E%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/</url>
      <content type="html"><![CDATA[<h2 id="ç¡®å®šå›æ”¶çš„å¯¹è±¡"><a href="#ç¡®å®šå›æ”¶çš„å¯¹è±¡" class="headerlink" title="ç¡®å®šå›æ”¶çš„å¯¹è±¡"></a>ç¡®å®šå›æ”¶çš„å¯¹è±¡</h2><p><strong>ã€Œæ­»å»ã€çš„å¯¹è±¡</strong>å³ä¸å¯èƒ½å†è¢«ä»»ä½•é€”å¾„ä½¿ç”¨çš„å¯¹è±¡ã€‚</p>
<p>å‡ ä¹æ‰€æœ‰å¯¹è±¡çš„å®ä¾‹éƒ½å­˜åœ¨å †ä¸­ã€‚ï¼ˆéƒ¨åˆ† String å¯¹è±¡å­˜åœ¨äºå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼ŒJDK1.7 ä»¥å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ–¹æ³•åŒºä¸­ï¼‰ã€‚</p>
<p>è¿›è¡Œå›æ”¶çš„ç¬¬ä¸€æ­¥å°±æ˜¯ç¡®å®šå“ªäº›å¯¹è±¡è¿˜æ´»ç€ï¼Œå“ªäº›å·²ç»æ­»äº¡ã€‚</p>
<a id="more"></a>
<h3 id="å¼•ç”¨è®¡æ•°ç®—æ³•"><a href="#å¼•ç”¨è®¡æ•°ç®—æ³•" class="headerlink" title="å¼•ç”¨è®¡æ•°ç®—æ³•"></a>å¼•ç”¨è®¡æ•°ç®—æ³•</h3><p>ç»™å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œ</p>
<ul>
<li>æ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨å€¼å°±åŠ  1ï¼›</li>
<li>å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨å€¼å°±å‡ 1ï¼›</li>
<li>ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨ä¸º 0 çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹</strong>ï¼šå¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´<strong>ç›¸äº’å¾ªç¯å¼•ç”¨çš„é—®é¢˜</strong>ã€‚å› æ­¤ Java è™šæ‹Ÿæœºä¸­æ²¡æœ‰é‡‡ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•æ¥ç®¡ç†å†…å­˜ã€‚</p>
<h3 id="å¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#å¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="å¯è¾¾æ€§åˆ†æç®—æ³•"></a>å¯è¾¾æ€§åˆ†æç®—æ³•</h3><p>ä¸»æµçš„å•†ç”¨ç¨‹åºè¯­è¨€çš„ä¸»æµå®ç°ä¸­ï¼Œéƒ½æ˜¯é€šè¿‡<strong>å¯è¾¾æ€§åˆ†æ</strong>æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»çš„ã€‚</p>
<p>ç®—æ³•çš„åŸºæœ¬æ€è·¯ï¼š</p>
<ul>
<li>é€šè¿‡ä¸€ç³»åˆ—çš„ç§°ä¸º GC Root çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºã€å¼•ç”¨é“¾ã€ï¼ˆReference Chainï¼‰</li>
<li><p><strong>å½“ä¸€ä¸ªå¯¹è±¡åˆ° GC Root æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„</strong>ã€‚</p>
<p>GC Root å¯¹è±¡çš„å®šä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ  <a href="http://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Fconcepts%2Fgcroots.html&amp;cp=37_2_3" target="_blank" rel="noopener">Help - Eclipse Platform</a> ä¸Šç»™çš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š</p>
</li>
</ul>
<blockquote>
<p>  A garbage collection root is an object that is accessible from outside the heap</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ <strong>GC Roots æ˜¯å¯ä»¥ä»å †å¤–è®¿é—®çš„å¯¹è±¡</strong>ã€‚ç”± Java è¿è¡Œæ—¶æ•°æ®åŒºå¯ä»¥çŸ¥é“ï¼Œå †å¤–çš„ç©ºé—´æœ‰è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆä»¥åŠæ–¹æ³•åŒºã€‚è€Œjava 1.8 å°†æ•´ä¸ªæ–¹æ³•åŒºè¢«ç§»åˆ°ä¸€ä¸ªå«å…ƒç©ºé—´çš„åœ°æ–¹ï¼ˆä½¿ç”¨æœ¬åœ°å†…å­˜å­˜å‚¨ï¼‰</p>
<p>æ‰€ä»¥GC Roots å¯¹è±¡åŒ…å«ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>è™šæ‹Ÿæœºæ ˆ(æ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨)ä¸­å¼•ç”¨çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡ã€‚</li>
<li>æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNI å¼•ç”¨çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬<ul>
<li>æœ¬åœ°æ–¹æ³•æ ˆä¸­çš„å±€éƒ¨å˜é‡æˆ–è€…å‚æ•°</li>
<li>JNIå…¨å±€å¼•ç”¨</li>
</ul>
</li>
<li>æ–¹æ³•åŒºä¸­<strong>ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</strong>ã€‚<strong>ç”± Java è™šæ‹Ÿæœºè‡ªå¸¦çš„ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»ï¼Œåœ¨è™šæ‹Ÿæœºçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå§‹ç»ˆä¸ä¼šè¢«å¸è½½</strong>ã€‚å®ƒä»¬å¯ä»¥é€šè¿‡é™æ€å±æ€§çš„æ–¹å¼æŒæœ‰å¯¹è±¡çš„å¼•ç”¨ã€‚æ³¨æ„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç”±è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½çš„ç±»ä¸èƒ½æˆä¸ºGC Roots</li>
<li>æ–¹æ³•åŒºä¸­<strong>å¸¸é‡å¼•ç”¨çš„å¯¹è±¡</strong></li>
</ul>
<h3 id="å¼•ç”¨åˆ†ç±»"><a href="#å¼•ç”¨åˆ†ç±»" class="headerlink" title="å¼•ç”¨åˆ†ç±»"></a>å¼•ç”¨åˆ†ç±»</h3><p>JDK 1.2 ä¹‹åå¯¹ï¼ŒJava å¯¹å¼•ç”¨çš„æ¦‚å¿µè¿›è¡Œäº†æ‰©å……ï¼ˆä¸å†æ˜¯ä»…æœ‰è¢«å¼•ç”¨æˆ–è€…æ²¡æœ‰è¢«å¼•ç”¨ä¸¤ç§ï¼‰ï¼š</p>
<p>å…±æœ‰å››ç§ï¼š</p>
<ul>
<li><strong>å¼ºå¼•ç”¨</strong><ul>
<li>åªè¦å¼ºå¼•ç”¨è¿˜å­˜åœ¨ï¼Œåƒåœ¾æ”¶é›†å™¨æ°¸è¿œä¸ä¼šå›æ”¶æ‰è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><strong>è½¯å¼•ç”¨</strong> SoftReference <ul>
<li>å†…å­˜ä¸å¤Ÿæ—¶è¢«å›æ”¶<ul>
<li>åœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œå°†ä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—è¿›å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ã€‚å¦‚æœè¿™æ¬¡å›æ”¶è¿˜æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>å¼±å¼•ç”¨</strong> WeakReference<ul>
<li>åªè¦ä¸€æ‰§è¡Œ GC å°±ä¼šè¢«å›æ”¶</li>
</ul>
</li>
<li><strong>è™šå¼•ç”¨</strong>ï¼Œä¹Ÿç§°ä¸º<strong>å¹½çµå¼•ç”¨ã€å¹»å½±å¼•ç”¨</strong>  PhantomReference<ul>
<li>ã€å½¢åŒè™šè®¾ã€ã€‚ä¸€ä¸ªå¯¹è±¡è¢«æŒæœ‰è™šå¼•ç”¨å¯¹å…¶ç”Ÿå‘½å‘¨æœŸæ¯«æ— å½±å“</li>
<li>è™šå¼•ç”¨çš„ä½œç”¨ä»…ä»…æ˜¯åœ¨è¯¥å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œæ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥è€Œå·²</li>
</ul>
</li>
</ul>
<h3 id="ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡"><a href="#ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡" class="headerlink" title="ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡"></a>ç”Ÿå­˜è¿˜æ˜¯æ­»äº¡</h3><p>ä¸€ä¸ªå¯¹è±¡çš„ finalize æ–¹æ³•æœ€å¤šåªä¼šè¢«ç³»ç»Ÿè°ƒç”¨ä¸€æ¬¡ã€‚</p>
<p>å³ä½¿åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œä¹Ÿå¹¶éæ˜¯ã€Œéæ­»ä¸å¯ã€çš„ï¼Œ<strong>è¦çœŸæ­£å®£å‘Šä¸€ä¸ªå¯¹è±¡æ­»äº¡ï¼Œè‡³å°‘è¦ç»å†ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹</strong>ï¼š</p>
<ul>
<li>å¦‚æœå¯¹è±¡åœ¨è¿›è¡Œ<strong>å¯è¾¾æ€§åˆ†æ</strong>åå‘ç°æ²¡æœ‰ä¸ GCRoots ç›¸è¿æ¥çš„å¼•ç”¨é“¾ï¼Œé‚£å®ƒå°†ä¼šè¢«<strong>ç¬¬ä¸€æ¬¡æ ‡è®°å¹¶ä¸”è¿›è¡Œä¸€æ¬¡ç­›é€‰</strong>ï¼Œ<ul>
<li><strong>ç­›é€‰çš„æ¡ä»¶</strong>æ˜¯æ­¤å¯¹è±¡<strong>æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œ finalize æ–¹æ³•</strong>ã€‚å½“å¯¹è±¡<strong>æ²¡æœ‰è¦†ç›– finalize æ–¹æ³•</strong>ï¼Œæˆ–è€… <strong>finalize æ–¹æ³•å·²ç»è¢«è™šæ‹Ÿæœºè°ƒç”¨è¿‡</strong>ï¼Œè™šæ‹Ÿæœºå°†è¿™ä¸¤ç§æƒ…å†µéƒ½è§†ä¸ºã€Œ<strong>æ²¡æœ‰å¿…è¦æ‰§è¡Œ</strong>ã€ã€‚</li>
<li>å¦‚æœè¿™ä¸ªå¯¹è±¡è¢«åˆ¤å®šä¸º<strong>æœ‰å¿…è¦æ‰§è¡Œ finalize æ–¹æ³•</strong>ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°†ä¼šæ”¾ç½®åœ¨ä¸€ä¸ªå«åš <strong>F-Queue çš„é˜Ÿåˆ—</strong>ä¹‹ä¸­ï¼Œå¹¶åœ¨ç¨åç”±ä¸€ä¸ªç”±è™šæ‹Ÿæœºè‡ªåŠ¨å»ºç«‹çš„ã€ä½ä¼˜å…ˆçº§çš„ <strong>Finalizer çº¿ç¨‹</strong>å»æ‰§è¡Œå®ƒã€‚</li>
</ul>
</li>
</ul>
<p>è¿™é‡Œæ‰€è°“çš„ã€Œ<strong>æ‰§è¡Œ</strong>ã€æ˜¯æŒ‡è™šæ‹Ÿæœº <strong>ä¼šè§¦å‘</strong>è¿™ä¸ªæ–¹æ³•ï¼Œä½†å¹¶<strong>ä¸æ‰¿è¯ºä¼šç­‰å¾…å®ƒè¿è¡Œç»“æŸ</strong>ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ</p>
<ul>
<li>å› ä¸ºå¦‚æœæ‰¿è¯ºå¾—åˆ° finalize æ–¹æ³•æ‰§è¡Œç»“æŸï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªå¯¹è±¡åœ¨ finalize æ–¹æ³•ä¸­æ‰§è¡Œç¼“æ…¢ï¼Œæˆ–è€…å‘ç”Ÿäº†æ­»å¾ªç¯ï¼ˆæ›´æç«¯çš„æƒ…å†µï¼‰ï¼Œå°†å¾ˆå¯èƒ½ä¼šå¯¼è‡´ F-Queue é˜Ÿåˆ—ä¸­å…¶ä»–å¯¹è±¡æ°¸ä¹…å¤„äºç­‰å¾…ï¼Œç”šè‡³å¯¼è‡´æ•´ä¸ªå†…å­˜å›æ”¶ç³»ç»Ÿå´©æºƒã€‚</li>
</ul>
<p>finalize æ–¹æ³•æ˜¯<strong>å¯¹è±¡é€ƒè„±æ­»äº¡å‘½è¿çš„==æœ€åä¸€æ¬¡æœºä¼š==</strong>ï¼Œç¨å GC å°†å¯¹ F-Queue ä¸­çš„å¯¹è±¡è¿›è¡Œ<strong>ç¬¬äºŒæ¬¡å°è§„æ¨¡çš„æ ‡è®°</strong>ï¼Œ</p>
<ul>
<li>å¦‚æœå¯¹è±¡è¦åœ¨ finalize ä¸­æˆåŠŸæ‹¯æ•‘è‡ªå·±â€”â€”åªè¦é‡æ–°ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹å…³è”å³å¯ï¼Œè­¬å¦‚æŠŠè‡ªå·±ï¼ˆthis å…³é”®å­—ï¼‰èµ‹å€¼ç»™æŸä¸ªç±»å˜é‡æˆ–è€…å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œé‚£åœ¨<strong>ç¬¬äºŒæ¬¡æ ‡è®°æ—¶å®ƒå°†è¢«ç§»é™¤å‡ºã€Œå³å°†å›æ”¶ã€çš„é›†åˆ</strong>ï¼›</li>
<li>å¦‚æœå¯¹è±¡è¿™æ—¶å€™è¿˜æ²¡æœ‰é€ƒè„±ï¼Œé‚£åŸºæœ¬ä¸Šå®ƒå°±çœŸçš„è¢«å›æ”¶äº†ã€‚</li>
</ul>
<p>ä»»ä½•ä¸€ä¸ªå¯¹è±¡çš„ finalize æ–¹æ³•åªä¼šè¢«ç³»ç»Ÿè°ƒç”¨ä¸€æ¬¡ã€‚</p>
<h3 id="å›æ”¶æ–¹æ³•åŒº"><a href="#å›æ”¶æ–¹æ³•åŒº" class="headerlink" title="å›æ”¶æ–¹æ³•åŒº"></a>å›æ”¶æ–¹æ³•åŒº</h3><p>æ°¸ä¹…ä»£çš„åƒåœ¾å›æ”¶ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†çš„å†…å®¹ï¼š</p>
<ul>
<li>åºŸå¼ƒå¸¸é‡</li>
<li>æ— ç”¨çš„ç±»</li>
</ul>
<h4 id="å›æ”¶åºŸå¼ƒå¸¸é‡"><a href="#å›æ”¶åºŸå¼ƒå¸¸é‡" class="headerlink" title="å›æ”¶åºŸå¼ƒå¸¸é‡"></a>å›æ”¶åºŸå¼ƒå¸¸é‡</h4><p>å›æ”¶åºŸå¼ƒå¸¸é‡ä¸å›æ”¶ Java å †ä¸­å¯¹è±¡å¾ˆç›¸ä¼¼ã€‚ä»¥å¸¸é‡æ± ä¸­å­—é¢é‡çš„å›æ”¶ä¸ºä¾‹ï¼Œå‡å¦‚ä¸€ä¸ªå­—ç¬¦ä¸²ã€Œabcã€å·²ç»è¿›å…¥äº†å¸¸é‡æ± ä¸­ï¼Œå®ƒ<strong>æ²¡æœ‰è¢«å¼•ç”¨</strong>ï¼Œå¦‚æœè¿™æ—¶<strong>å‘ç”Ÿå†…å­˜å›æ”¶ï¼Œè€Œä¸”å¿…è¦çš„è¯</strong>ï¼Œè¿™ä¸ªã€Œabcã€å¸¸é‡<strong>å°±ä¼šè¢«ç³»ç»Ÿæ¸…ç†å‡ºå¸¸é‡æ± </strong>ã€‚å¸¸é‡æ± ä¸­çš„å…¶ä»–ç±»ï¼ˆæ¥å£ï¼‰ã€æ–¹æ³•ã€å­—æ®µçš„ç¬¦å·å¼•ç”¨ä¹Ÿä¸æ­¤ç±»ä¼¼ã€‚</p>
<h4 id="å›æ”¶æ— ç”¨ç±»"><a href="#å›æ”¶æ— ç”¨ç±»" class="headerlink" title="å›æ”¶æ— ç”¨ç±»"></a>å›æ”¶æ— ç”¨ç±»</h4><p>ç±»éœ€è¦<strong>åŒæ—¶æ»¡è¶³ä¸‹é¢ 3 ä¸ªæ¡ä»¶æ‰èƒ½ç®—æ˜¯ã€Œæ— ç”¨çš„ç±»</strong>ã€ï¼š</p>
<ol>
<li>è¯¥ç±»æ‰€æœ‰çš„<strong>å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶</strong>ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ã€‚</li>
<li><strong>åŠ è½½è¯¥ç±»çš„ ClassLoader å·²ç»è¢«å›æ”¶</strong>ã€‚</li>
<li>è¯¥ç±»<strong>å¯¹åº”çš„ java.lang.Class å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨</strong>ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚</li>
</ol>
<p>è™šæ‹Ÿæœº<strong>å¯ä»¥</strong>å¯¹æ»¡è¶³ä¸Šè¿°3ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œå¯ä»¥â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ï¼Œä¸ä½¿ç”¨äº†å°±å¿…ç„¶ä¼šå›æ”¶ã€‚ è€Œä¸”å› ä¸ºç”± Java è™šæ‹Ÿæœºè‡ªå¸¦çš„ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»ï¼Œåœ¨è™šæ‹Ÿæœºçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå§‹ç»ˆä¸ä¼šè¢«å¸è½½ã€‚æ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹å›æ”¶æ— ç”¨ç±»æ”¶æ•ˆç”šå¾®ã€‚</p>
<h2 id="åƒåœ¾æ”¶é›†ç®—æ³•"><a href="#åƒåœ¾æ”¶é›†ç®—æ³•" class="headerlink" title="åƒåœ¾æ”¶é›†ç®—æ³•"></a>åƒåœ¾æ”¶é›†ç®—æ³•</h2><h3 id="æ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#æ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="æ ‡è®°-æ¸…é™¤ç®—æ³•"></a>æ ‡è®°-æ¸…é™¤ç®—æ³•</h3><p><strong>æ ‡è®°-æ¸…é™¤</strong> (Mark-Sweep) ç®—æ³•æ˜¯<strong>æœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•</strong>ï¼Œåˆ†ä¸ºæ ‡è®°å’Œæ¸…é™¤ä¸¤ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>é¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œ</li>
<li>åœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶æ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡</li>
</ul>
<p>ä¹‹æ‰€ä»¥è¯´å®ƒåŸºç¡€ï¼Œæ˜¯å› ä¸ºåç»­çš„æ”¶é›†ç®—æ³•éƒ½æ˜¯åŸºäºè¿™ç§æ€è·¯å¹¶å¯¹å…¶ä¸è¶³è¿›è¡Œæ”¹è¿›è€Œå¾—åˆ°çš„ã€‚</p>
<p>ä¸»è¦ä¸è¶³æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li><strong>æ•ˆç‡é—®é¢˜</strong>ï¼šæ ‡è®°å’Œæ¸…é™¤ä¸¤ä¸ªè¿‡ç¨‹çš„æ•ˆç‡éƒ½ä¸é«˜ï¼›</li>
<li><strong>ç©ºé—´é—®é¢˜</strong>ï¼ˆç¡®åˆ‡è€Œè¨€æ˜¯ç©ºé—´ç¢ç‰‡é—®é¢˜ï¼‰ï¼šæ ‡è®°æ¸…é™¤ä¹‹åä¼š<strong>äº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡</strong>ï¼Œç©ºé—´ç¢ç‰‡å¤ªå¤šå¯èƒ½ä¼šå¯¼è‡´ä»¥ååœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦<strong>åˆ†é…è¾ƒå¤§å¯¹è±¡æ—¶ï¼Œæ— æ³•æ‰¾åˆ°è¶³å¤Ÿçš„è¿ç»­å†…å­˜</strong>è€Œä¸å¾—ä¸æå‰è§¦å‘å¦ä¸€æ¬¡åƒåœ¾æ”¶é›†åŠ¨ä½œã€‚</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/16668676/30166872-34869854-9417-11e7-9586-95308fa7820c.png" alt="mark-sweep"></p>
<p>ä»…æœ‰ CMS æ”¶é›†å™¨ä½¿ç”¨äº†æ ‡è®°-æ¸…é™¤ç®—æ³•ã€‚</p>
<h3 id="å¤åˆ¶ç®—æ³•"><a href="#å¤åˆ¶ç®—æ³•" class="headerlink" title="å¤åˆ¶ç®—æ³•"></a>å¤åˆ¶ç®—æ³•</h3><p>å¤åˆ¶ç®—æ³•ä¸»è¦æ˜¯ä¸ºäº†è§£å†³æ•ˆç‡é—®é¢˜ï¼Œå®ƒ<strong>å°†å¯ç”¨å†…å­˜æŒ‰å®¹é‡åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—</strong>ï¼Œ<strong>æ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—</strong>ã€‚  å½“è¿™ä¸€å—çš„å†…å­˜ç”¨å®Œäº†ï¼Œå°±å°†è¿˜å­˜æ´»ç€çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ä¸Šé¢ï¼Œç„¶åå†æŠŠå·²ä½¿ç”¨è¿‡çš„å†…å­˜ç©ºé—´ä¸€æ¬¡æ¸…ç†æ‰ã€‚è¿™æ ·ä½¿å¾—<strong>æ¯æ¬¡éƒ½æ˜¯å¯¹æ•´ä¸ªåŠåŒºè¿›è¡Œå†…å­˜å›æ”¶</strong>ï¼Œå†…å­˜åˆ†é…æ—¶ä¹Ÿå°±ä¸ç”¨è€ƒè™‘å†…å­˜ç¢ç‰‡ç­‰å¤æ‚æƒ…å†µï¼Œåªè¦ç§»åŠ¨å †é¡¶æŒ‡é’ˆï¼ŒæŒ‰é¡ºåºåˆ†é…å†…å­˜å³å¯ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆã€‚</p>
<p><strong>å•†ä¸šè™šæ‹Ÿæœº</strong>éƒ½é‡‡ç”¨å¤åˆ¶æ”¶é›†ç®—æ³•æ¥<strong>å›æ”¶æ–°ç”Ÿä»£</strong>ï¼Œä½†å¹¶ä¸æ˜¯æŒ‰ç…§ 1:1 çš„æ¯”ä¾‹æ¥åˆ’åˆ†å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯<strong>å°†å†…å­˜åˆ†ä¸ºä¸€å—è¾ƒå¤§çš„ Eden ç©ºé—´å’Œ==ä¸¤å—==è¾ƒå°çš„ ==Survivor==</strong> ç©ºé—´ï¼Œ<strong>æ¯æ¬¡ä½¿ç”¨ Eden å’Œå…¶ä¸­ä¸€å— Survivor</strong>ï¼Œå½“å›æ”¶æ—¶ï¼Œå°† Eden å’Œ Survivor ä¸­è¿˜å­˜æ´»ç€çš„å¯¹è±¡<strong>ä¸€æ¬¡æ€§åœ°å¤åˆ¶åˆ°==å¦å¤–ä¸€å—==Survivor ç©ºé—´ä¸Š</strong>ï¼Œæœ€åæ¸…ç†æ‰ Eden å’Œåˆšæ‰ç”¨è¿‡çš„ Survivor ç©ºé—´ã€‚</p>
<ul>
<li>HotSpot è™šæ‹Ÿæœº<strong>é»˜è®¤ Eden å’Œä¸¤å— Survivor çš„å¤§å°æ¯”ä¾‹æ˜¯ 8:1:1</strong>ï¼Œä¹Ÿå°±æ˜¯<strong>æ¯æ¬¡æ–°ç”Ÿä»£ä¸­å¯ç”¨å†…å­˜ç©ºé—´ä¸ºæ•´ä¸ªæ–°ç”Ÿä»£å®¹é‡çš„</strong> 90%ï¼ˆ80%+10%ï¼‰ï¼Œåªæœ‰ 10%çš„å†…å­˜ä¼šè¢«ã€Œæµªè´¹ã€ã€‚å½“ Survivor ç©ºé—´ä¸å¤Ÿç”¨æ—¶ï¼Œéœ€è¦ä¾èµ–å…¶ä»–å†…å­˜ï¼ˆè¿™é‡ŒæŒ‡è€å¹´ä»£ï¼‰è¿›è¡Œ<strong>åˆ†é…æ‹…ä¿</strong>ï¼ˆHandle Promotionï¼‰ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä½¿ç”¨<strong>ç©ºé—´æ¢å–æ—¶é—´</strong>ï¼Œè¿™ç§ç®—æ³•<strong>å°†å†…å­˜ç¼©å°ä¸ºäº†åŸæ¥çš„ä¸€åŠ</strong>ã€‚</li>
<li>å¤åˆ¶æ”¶é›†ç®—æ³•åœ¨<strong>å¯¹è±¡å­˜æ´»ç‡è¾ƒé«˜æ—¶</strong>å°±è¦è¿›è¡Œ<strong>è¾ƒå¤šçš„å¤åˆ¶æ“ä½œ</strong>ï¼Œæ•ˆç‡å°†ä¼šå˜ä½ã€‚æ›´å…³é”®çš„æ˜¯ï¼Œå¦‚æœä¸æƒ³æµªè´¹ 50%çš„ç©ºé—´ï¼Œå°±éœ€è¦æœ‰<strong>é¢å¤–çš„ç©ºé—´è¿›è¡Œåˆ†é…æ‹…ä¿</strong>ï¼Œä»¥åº”å¯¹è¢«ä½¿ç”¨çš„å†…å­˜ä¸­æ‰€æœ‰å¯¹è±¡éƒ½ 100% å­˜æ´»çš„æç«¯æƒ…å†µï¼Œæ‰€ä»¥åœ¨<strong>è€å¹´ä»£ä¸€èˆ¬ä¸èƒ½ç›´æ¥é€‰ç”¨è¿™ç§å¤åˆ¶ç®—æ³•</strong>ã€‚</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/16668676/30166943-6af312e6-9417-11e7-8b7a-8a53bb607625.png" alt="copy sweep"></p>
<h3 id="æ ‡è®°-æ•´ç†-ç®—æ³•"><a href="#æ ‡è®°-æ•´ç†-ç®—æ³•" class="headerlink" title="æ ‡è®°-==æ•´ç†==ç®—æ³•"></a>æ ‡è®°-==æ•´ç†==ç®—æ³•</h3><p>ã€Œ<strong>æ ‡è®°-æ•´ç†ã€ç®—æ³•</strong>çš„<strong>æ ‡è®°è¿‡ç¨‹</strong>ä»ç„¶ä¸ã€Œæ ‡è®°-æ¸…é™¤ã€ç®—æ³•ä¸€æ ·ï¼Œä½†<strong>åç»­æ­¥éª¤ä¸æ˜¯ç›´æ¥å¯¹å¯å›æ”¶å¯¹è±¡è¿›è¡Œæ¸…ç†</strong>ï¼Œè€Œæ˜¯<strong>è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½å‘ä¸€ç«¯ç§»åŠ¨</strong>ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜ã€‚(å…ˆç§»åŠ¨åˆ°ã€å®‰å…¨ä½ç½®ã€å†æ¸…é™¤æ‰å®‰å…¨åŒºåŸŸè¾¹ç•Œå¤–çš„æ— ç”¨ä½ç½®)</p>
<p><img src="https://user-images.githubusercontent.com/16668676/30166870-34829cb8-9417-11e7-99ae-276d0e6cd96c.png" alt="mark-compact"></p>
<h3 id="åˆ†ä»£æ”¶é›†ç®—æ³•"><a href="#åˆ†ä»£æ”¶é›†ç®—æ³•" class="headerlink" title="åˆ†ä»£æ”¶é›†ç®—æ³•"></a>åˆ†ä»£æ”¶é›†ç®—æ³•</h3><p>ç›®å‰å•†ä¸šè™šæ‹Ÿæœºçš„åƒåœ¾æ”¶é›†<strong>éƒ½é‡‡ç”¨ã€Œåˆ†ä»£æ”¶é›†ã€ï¼ˆGenerational  Collectionï¼‰ç®—æ³•</strong>ï¼Œ</p>
<p>åªæ˜¯<strong>æ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒå°†å†…å­˜åˆ’åˆ†ä¸ºå‡ å—</strong>ã€‚ä¸€èˆ¬æ˜¯æŠŠ Java å †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·å°±å¯ä»¥<strong>æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é‡‡ç”¨æœ€é€‚å½“çš„æ”¶é›†ç®—æ³•</strong>ã€‚å¯ä»¥é€šè¿‡ <code>-XX:NewRatio</code>è°ƒæ•´æ–°ç”Ÿä»£ä¸è€å¹´ä»£çš„å†…å­˜ç©ºé—´æ¯”ä¾‹ï¼ˆæŒ‡å®šè€å¹´ä»£æ‰€å çš„ã€Œä»½æ•°ã€ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ <code>NewRatio = 2</code>ï¼Œå³ï¼š æ–°ç”Ÿä»£çº¦å æ•´ä¸ªå †ç©ºé—´çš„ 1/3 ,è€å¹´ä»£çº¦å  2/3 ã€‚</p>
<ul>
<li>åœ¨<strong>æ–°ç”Ÿä»£</strong>ä¸­ï¼Œå› ä¸ºå¯¹è±¡å­˜æ´»ç‡æ¯”è¾ƒä½ï¼Œåªéœ€è¦ä»˜å‡ºå°‘é‡å­˜æ´»å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ”¶é›†ã€‚é€‰ç”¨<strong>å¤åˆ¶ç®—æ³•</strong>ã€‚</li>
<li>è€Œ<strong>è€å¹´ä»£</strong>ä¸­å› ä¸ºå¯¹è±¡å­˜æ´»ç‡é«˜ã€æ²¡æœ‰é¢å¤–ç©ºé—´å¯¹å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œå°±å¿…é¡»ä½¿ç”¨ã€Œæ ‡è®°-æ¸…ç†ã€æˆ–è€…ã€Œæ ‡è®°-æ•´ç†ã€ç®—æ³•æ¥è¿›è¡Œå›æ”¶ã€‚</li>
</ul>
<h2 id="HotSpot-çš„ç®—æ³•å®ç°"><a href="#HotSpot-çš„ç®—æ³•å®ç°" class="headerlink" title="HotSpot çš„ç®—æ³•å®ç°"></a>HotSpot çš„ç®—æ³•å®ç°</h2><p>å¦‚ä½•å‘èµ·å†…å­˜å›æ”¶ï¼Ÿé¦–å…ˆè¦çŸ¥é“å›æ”¶çš„å“ªäº›å¯¹è±¡ã€‚</p>
<h3 id="æšä¸¾æ ¹èŠ‚ç‚¹"><a href="#æšä¸¾æ ¹èŠ‚ç‚¹" class="headerlink" title="æšä¸¾æ ¹èŠ‚ç‚¹"></a>æšä¸¾æ ¹èŠ‚ç‚¹</h3><p>å¯ä½œä¸º GC Roots çš„èŠ‚ç‚¹ä¸»è¦åœ¨å…¨å±€æ€§çš„å¼•ç”¨ï¼ˆä¾‹å¦‚å¸¸é‡æˆ–ç±»é™æ€å±æ€§ï¼‰ä¸æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆä¾‹å¦‚æ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­ï¼Œç°åœ¨å¾ˆå¤šåº”ç”¨ä»…ä»…æ–¹æ³•åŒºå°±æœ‰æ•°ç™¾å…†ï¼Œå¦‚æœè¦é€ä¸ªæ£€æŸ¥è¿™é‡Œé¢çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå¿…ç„¶ä¼šæ¶ˆè€—å¾ˆå¤šæ—¶é—´ã€‚</p>
<h4 id="åˆ†ææœŸé—´å¼•ç”¨ä¸å¯å˜å¯¼è‡´-GC-åœé¡¿"><a href="#åˆ†ææœŸé—´å¼•ç”¨ä¸å¯å˜å¯¼è‡´-GC-åœé¡¿" class="headerlink" title="åˆ†ææœŸé—´å¼•ç”¨ä¸å¯å˜å¯¼è‡´ GC åœé¡¿"></a>åˆ†ææœŸé—´å¼•ç”¨ä¸å¯å˜å¯¼è‡´ GC åœé¡¿</h4><p>å¯è¾¾æ€§åˆ†æå¯¹æ‰§è¡Œæ—¶é—´çš„æ•æ„Ÿè¿˜ä½“ç°åœ¨ <strong>GC åœé¡¿</strong> ä¸Šï¼Œå› ä¸ºè¿™é¡¹åˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ç¡®ä¿ä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œã€‚</p>
<ul>
<li>ã€Œ<strong>ä¸€è‡´æ€§</strong>ã€çš„æ„æ€æ˜¯æŒ‡åœ¨<strong>æ•´ä¸ªåˆ†ææœŸé—´</strong>ï¼Œä¸å¯ä»¥å‡ºç°åˆ†æè¿‡ç¨‹ä¸­å¯¹è±¡å¼•ç”¨å…³ç³»è¿˜åœ¨ä¸æ–­å˜åŒ–çš„æƒ…å†µï¼Œè¯¥ç‚¹ä¸æ»¡è¶³çš„è¯åˆ†æç»“æœå‡†ç¡®æ€§å°±æ— æ³•å¾—åˆ°ä¿è¯ã€‚è¿™ç‚¹æ˜¯å¯¼è‡´ GC è¿›è¡Œæ—¶å¿…é¡»åœé¡¿æ‰€æœ‰ Java æ‰§è¡Œçº¿ç¨‹ï¼ˆSun å°†è¿™ä»¶äº‹æƒ…ç§°ä¸ºã€Œ<strong>Stop The World</strong>ã€ï¼‰çš„å…¶ä¸­ä¸€ä¸ªé‡è¦åŸå› ï¼Œå³ä½¿æ˜¯åœ¨å·ç§°ï¼ˆå‡ ä¹ï¼‰ä¸ä¼šå‘ç”Ÿåœé¡¿çš„ CMS æ”¶é›†å™¨ä¸­ï¼Œ<strong>æšä¸¾æ ¹èŠ‚ç‚¹æ—¶ä¹Ÿæ˜¯å¿…é¡»è¦åœé¡¿çš„</strong>ã€‚</li>
</ul>
<p>ç”±äºç›®å‰çš„ä¸»æµ Java è™šæ‹Ÿæœºä½¿ç”¨çš„éƒ½æ˜¯<strong>å‡†ç¡®å¼ GC</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè™šæ‹Ÿæœºå¯ä»¥å‡†ç¡®çš„çŸ¥é“å†…å­˜ä¸­æŸä¸ªä½ç½®çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆã€‚æ‰€ä»¥å½“æ‰§è¡Œç³»ç»Ÿåœé¡¿ä¸‹æ¥åï¼Œå¹¶<strong>ä¸éœ€è¦ä¸€ä¸ªä¸æ¼åœ°æ£€æŸ¥å®Œæ‰€æœ‰æ‰§è¡Œä¸Šä¸‹æ–‡å’Œå…¨å±€çš„å¼•ç”¨ä½ç½®</strong>ï¼Œè™šæ‹Ÿæœºåªè¦ç›´æ¥æ‰«æå­˜æ”¾å¯¹è±¡å¼•ç”¨çš„åŒºåŸŸã€‚</p>
<ul>
<li>åœ¨ HotSpot çš„å®ç°ä¸­ï¼Œä½¿ç”¨ä¸€ç»„ç§°ä¸º <strong>OopMap</strong> çš„æ•°æ®ç»“æ„æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„çš„ï¼Œåœ¨ç±»åŠ è½½å®Œæˆçš„æ—¶å€™ï¼ŒHotSpot å°±æŠŠå¯¹è±¡å†…ä»€ä¹ˆåç§»é‡ä¸Šæ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®è®¡ç®—å‡ºæ¥ï¼Œåœ¨ JIT ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šåœ¨<strong>ç‰¹å®šçš„ä½ç½®è®°å½•</strong>ä¸‹æ ˆå’Œå¯„å­˜å™¨ä¸­å“ªäº›ä½ç½®æ˜¯å¼•ç”¨ã€‚è¿™æ ·ï¼ŒGC åœ¨æ‰«ææ—¶å°±å¯ä»¥ç›´æ¥å¾—çŸ¥è¿™äº›ä¿¡æ¯äº†ã€‚</li>
</ul>
<p>ä½¿ç”¨ç©ºé—´æ¢æ—¶é—´ã€‚</p>
<h3 id="å®‰å…¨ç‚¹"><a href="#å®‰å…¨ç‚¹" class="headerlink" title="å®‰å…¨ç‚¹"></a>å®‰å…¨ç‚¹</h3><p>ä»çº¿ç¨‹è§’åº¦çœ‹ï¼Œsafepoint å¯ä»¥ç†è§£æˆæ˜¯åœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­çš„<strong>ä¸€äº›ç‰¹æ®Šä½ç½®ï¼Œå½“çº¿ç¨‹æ‰§è¡Œåˆ°è¿™äº›ä½ç½®çš„æ—¶å€™ï¼Œè¯´æ˜è™šæ‹Ÿæœºå½“å‰çš„çŠ¶æ€æ˜¯å®‰å…¨çš„</strong>ï¼Œï¼ˆå°±å¥½åƒé«˜é€Ÿå…¬è·¯ä¸Šçš„æœåŠ¡åŒºï¼Œå¯ä»¥å®‰å…¨åœ°åœä¸‹æ¥ä¼‘æ¯ï¼‰</p>
<ul>
<li>å¦‚æœæœ‰éœ€è¦ï¼Œå¯ä»¥åœ¨è¿™ä¸ªä½ç½®æš‚åœï¼Œæ¯”å¦‚å‘ç”Ÿ GC æ—¶ï¼Œéœ€è¦æš‚åœæš‚åœæ‰€ä»¥æ´»åŠ¨çº¿ç¨‹ï¼Œ</li>
<li>ä½†æ˜¯çº¿ç¨‹åœ¨è¿™ä¸ªæ—¶åˆ»ï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œåˆ°ä¸€ä¸ªå®‰å…¨ç‚¹ï¼Œæ‰€ä»¥è¯¥çº¿ç¨‹åº”è¯¥ç»§ç»­æ‰§è¡Œï¼Œåˆ°è¾¾ä¸‹ä¸€ä¸ªå®‰å…¨ç‚¹çš„æ—¶å€™æš‚åœï¼Œç­‰å¾… GC ç»“æŸã€‚ï¼ˆè¿˜åœ¨é©¬è·¯ä¸Šï¼Œå°±ä¸èƒ½ä¼‘æ¯ï¼Œè¦åˆ°ä¸‹ä¸€ä¸ªæœåŠ¡åŒºæ‰èƒ½ä¼‘æ¯ï¼‰</li>
</ul>
<h4 id="å®‰å…¨çš„é€‰å–"><a href="#å®‰å…¨çš„é€‰å–" class="headerlink" title="å®‰å…¨çš„é€‰å–"></a>å®‰å…¨çš„é€‰å–</h4><p>å®‰å…¨ç‚¹æ˜¯æ€ä¹ˆé€‰çš„ï¼ŸåŸºæœ¬ä¸Šæ˜¯ä»¥ç¨‹åºã€Œ<strong>æ˜¯å¦å…·æœ‰è®©ç¨‹åºé•¿æ—¶é—´æ‰§è¡Œçš„ç‰¹å¾ã€ä¸ºæ ‡å‡†</strong>è¿›è¡Œé€‰å®šçš„ã€‚</p>
<ul>
<li>ã€Œ<strong>é•¿æ—¶é—´æ‰§è¡Œ</strong>ã€çš„<strong>æœ€æ˜æ˜¾ç‰¹å¾å°±æ˜¯æŒ‡ä»¤åºåˆ—å¤ç”¨</strong>ï¼Œä¾‹å¦‚ï¼šæ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬ã€å¼‚å¸¸è·³è½¬ç­‰ï¼Œæ‰€ä»¥å…·æœ‰è¿™äº›åŠŸèƒ½çš„æŒ‡ä»¤æ‰ä¼šäº§ç”Ÿ Safepointã€‚ </li>
</ul>
<h4 id="GC-æ—¶è®©çº¿ç¨‹åœæ­¢çš„æ–¹å¼"><a href="#GC-æ—¶è®©çº¿ç¨‹åœæ­¢çš„æ–¹å¼" class="headerlink" title="GC æ—¶è®©çº¿ç¨‹åœæ­¢çš„æ–¹å¼"></a>GC æ—¶è®©çº¿ç¨‹åœæ­¢çš„æ–¹å¼</h4><p>å¦‚ä½•åœ¨ GC å‘ç”Ÿæ—¶è®©æ‰€æœ‰çº¿ç¨‹ï¼ˆè¿™é‡Œä¸åŒ…æ‹¬æ‰§è¡Œ JNI è°ƒç”¨çš„çº¿ç¨‹ï¼‰éƒ½ã€Œè·‘ã€åˆ°æœ€è¿‘çš„å®‰å…¨ç‚¹ä¸Šå†åœé¡¿ä¸‹æ¥ï¼Ÿ</p>
<p>è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼šæŠ¢å…ˆå¼ä¸­æ–­ï¼ˆPreemptive Suspensionï¼‰å’Œä¸»åŠ¨å¼ä¸­æ–­ï¼ˆVoluntary Suspensionï¼‰ï¼Œ</p>
<ul>
<li><strong>æŠ¢å…ˆå¼ä¸­æ–­</strong><br>åœ¨ GC å‘ç”Ÿæ—¶ï¼Œé¦–å…ˆæŠŠæ‰€æœ‰çº¿ç¨‹å…¨éƒ¨ä¸­æ–­ï¼Œå¦‚æœ<strong>å‘ç°æœ‰çº¿ç¨‹ä¸­æ–­çš„åœ°æ–¹ä¸åœ¨å®‰å…¨ç‚¹ä¸Š</strong>ï¼Œå°±æ¢å¤çº¿ç¨‹ï¼Œ<strong>è®©å®ƒã€Œè·‘ã€åˆ°å®‰å…¨ç‚¹ä¸Š</strong>ã€‚ç°åœ¨å‡ ä¹æ²¡æœ‰è™šæ‹Ÿæœºå®ç°é‡‡ç”¨æŠ¢å…ˆå¼ä¸­æ–­æ¥æš‚åœçº¿ç¨‹ä»è€Œå“åº” GC äº‹ä»¶ã€‚</li>
<li><strong>ä¸»åŠ¨å¼ä¸­æ–­</strong><br>ä¸»åŠ¨å¼ä¸­æ–­çš„æ€æƒ³æ˜¯å½“ GC éœ€è¦ä¸­æ–­çº¿ç¨‹çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¯¹çº¿ç¨‹æ“ä½œï¼Œ<strong>ä»…ä»…ç®€å•åœ°è®¾ç½®ä¸€ä¸ªæ ‡å¿—</strong>ï¼Œ<strong>å„ä¸ªçº¿ç¨‹æ‰§è¡Œæ—¶ä¸»åŠ¨å»è½®è¯¢è¿™ä¸ªæ ‡å¿—</strong>ï¼Œå‘ç°ä¸­æ–­æ ‡å¿—ä¸ºçœŸæ—¶å°±è‡ªå·±ä¸­æ–­æŒ‚èµ·ã€‚<ul>
<li>è½®è¯¢æ ‡å¿—çš„åœ°æ–¹å’Œå®‰å…¨ç‚¹æ˜¯é‡åˆçš„ï¼Œå¦å¤–å†åŠ ä¸Šåˆ›å»ºå¯¹è±¡éœ€è¦åˆ†é…å†…å­˜çš„åœ°æ–¹ã€‚</li>
</ul>
</li>
</ul>
<h3 id="å®‰å…¨åŒºåŸŸ"><a href="#å®‰å…¨åŒºåŸŸ" class="headerlink" title="å®‰å…¨åŒºåŸŸ"></a>å®‰å…¨åŒºåŸŸ</h3><p>å®‰å…¨åŒºåŸŸæ˜¯ä¸€ä¸ªå®‰å…¨ç‚¹è¿ç»­çš„ä»£ç æ®µã€‚</p>
<p>å®‰å…¨åŒºåŸŸæ˜¯æŒ‡åœ¨<strong>ä¸€æ®µä»£ç ç‰‡æ®µ</strong>ä¹‹ä¸­ï¼Œ<strong>å¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–</strong>ã€‚åœ¨è¿™ä¸ªåŒºåŸŸä¸­çš„ä»»æ„åœ°æ–¹å¼€å§‹ GC éƒ½æ˜¯å®‰å…¨çš„ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠ Safe Region çœ‹åšæ˜¯è¢«æ‰©å±•äº†çš„ Safepointã€‚</p>
<p>åœ¨çº¿ç¨‹<strong>æ‰§è¡Œåˆ° Safe Region ä¸­çš„ä»£ç æ—¶</strong>ï¼Œé¦–å…ˆ<strong>æ ‡è¯†</strong>è‡ªå·±<strong>å·²ç»è¿›å…¥äº† Safe Region</strong>ï¼Œ</p>
<ul>
<li>é‚£æ ·ï¼Œå½“åœ¨è¿™æ®µæ—¶é—´é‡Œ JVM è¦å‘èµ· GC æ—¶ï¼Œå°±ä¸ç”¨ç®¡æ ‡è¯†è‡ªå·±ä¸º Safe Region çŠ¶æ€çš„çº¿ç¨‹äº†ã€‚<ul>
<li>ï¼ˆé‚£äº›æ²¡æ ‡è®°ä¸ºå®‰å…¨åŒºåŸŸçš„æ€ä¹ˆå¤„ç†ï¼Ÿï¼‰</li>
</ul>
</li>
<li>åœ¨çº¿ç¨‹è¦ç¦»å¼€ Safe Region æ—¶ï¼Œå®ƒè¦<strong>æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å·²ç»å®Œæˆäº†==æ ¹èŠ‚ç‚¹æšä¸¾==ï¼ˆæˆ–è€…æ˜¯æ•´ä¸ª GC è¿‡ç¨‹</strong>ï¼‰[å› ä¸ºå…¶ä»–æ­¥éª¤å¯èƒ½ä¸éœ€è¦ stop the world ]<ul>
<li>å¦‚æœå®Œæˆäº†ï¼Œé‚£çº¿ç¨‹å°±ç»§ç»­æ‰§è¡Œï¼Œ</li>
<li>å¦åˆ™å®ƒå°±å¿…é¡»ç­‰å¾…ç›´åˆ°<strong>æ”¶åˆ°å¯ä»¥å®‰å…¨ç¦»å¼€ Safe Region çš„ä¿¡å·</strong>ä¸ºæ­¢ã€‚</li>
</ul>
</li>
</ul>
<h2 id="åƒåœ¾æ”¶é›†å™¨"><a href="#åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨"></a>åƒåœ¾æ”¶é›†å™¨</h2><p>å†…å­˜å›æ”¶å¦‚ä½•è¿›è¡Œæ˜¯ç”±è™šæ‹Ÿæœºæ‰€é‡‡ç”¨çš„ GC æ”¶é›†å™¨å†³å®šçš„ï¼Œè€Œé€šå¸¸è™šæ‹Ÿæœºä¸­å¾€å¾€ä¸æ­¢æœ‰ä¸€ç§ GC æ”¶é›†å™¨ã€‚</p>
<p>å¦‚æœè¯´<strong>æ”¶é›†ç®—æ³•æ˜¯å†…å­˜å›æ”¶çš„æ–¹æ³•è®º</strong>ï¼Œé‚£ä¹ˆåƒåœ¾å›æ”¶å™¨å°±æ˜¯<strong>å†…å­˜å›æ”¶çš„å…·ä½“å®ç°</strong>ã€‚</p>
<p>è™šæ‹Ÿæœºè§„èŒƒä¸­å¯¹äºåƒåœ¾å›æ”¶å™¨åº”è¯¥å¦‚ä½•å®ç°å¹¶æ²¡æœ‰ä»»ä½•è§„å®šã€‚</p>
<p><img src="https://user-images.githubusercontent.com/16668676/28901528-5469b7bc-782b-11e7-856b-62c876707344.png" alt="hotspot"></p>
<p>å›¾ 3-5 å±•ç¤ºäº† 7 ç§ä½œç”¨äºä¸åŒåˆ†ä»£çš„æ”¶é›†å™¨ï¼Œ<strong>å¦‚æœä¸¤ä¸ªæ”¶é›†å™¨ä¹‹é—´å­˜åœ¨è¿çº¿ï¼Œå°±è¯´æ˜å®ƒä»¬å¯ä»¥æ­é…ä½¿ç”¨</strong>ã€‚è™šæ‹Ÿæœºæ‰€å¤„çš„åŒºåŸŸï¼Œåˆ™è¡¨ç¤ºå®ƒæ˜¯å±äºæ–°ç”Ÿä»£æ”¶é›†å™¨è¿˜æ˜¯è€å¹´ä»£æ”¶é›†å™¨ã€‚</p>
<p>æˆ‘ä»¬é€‰æ‹©çš„åªæ˜¯å¯¹å…·ä½“åº”ç”¨æœ€åˆé€‚çš„æ”¶é›†å™¨ã€‚</p>
<p>ä»¥ä¸‹åˆ†æçš„å…³æ³¨ç‚¹ï¼š</p>
<ul>
<li>æ”¶é›†å™¨çš„ç‰¹ç‚¹ï¼š<ul>
<li>å·¥ä½œçº¿ç¨‹æ•°?</li>
<li>å·¥ä½œè¿‡ç¨‹ä¸­éœ€ä¸éœ€è¦ stop the wordï¼Ÿ<ul>
<li>éœ€è¦çš„è¯å…·ä½“æ˜¯å“ªä¸ªè¿‡ç¨‹éœ€è¦ï¼Ÿ</li>
</ul>
</li>
</ul>
</li>
<li>èƒ½ä¸å“ªä¸ªæ”¶é›†å™¨æ­é…ä½¿ç”¨?</li>
</ul>
<h3 id="Serial-æ”¶é›†å™¨"><a href="#Serial-æ”¶é›†å™¨" class="headerlink" title="Serial æ”¶é›†å™¨"></a>Serial æ”¶é›†å™¨</h3><p>ä¸€ä¸ªå•çº¿ç¨‹çš„æ”¶é›†å™¨ã€‚å•çº¿ç¨‹æŒ‡çš„æ˜¯å®ƒç”¨<strong>å•æ¡çº¿ç¨‹</strong>å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œ</p>
<ul>
<li>é‡ç‚¹ï¼šåœ¨å®ƒè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»<strong>æš‚åœå…¶ä»–æ‰€æœ‰å·¥ä½œçº¿ç¨‹</strong>ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/16668676/28901652-5c798f30-782c-11e7-9394-6944abe6a65e.png" alt="serial serial old"></p>
<p>å®é™…ä¸Šåˆ°ç°åœ¨ä¸ºæ­¢ï¼Œå®ƒä¾ç„¶æ˜¯<strong>è™šæ‹Ÿæœºè¿è¡Œåœ¨ Client æ¨¡å¼ä¸‹çš„é»˜è®¤æ–°ç”Ÿä»£æ”¶é›†å™¨</strong>ã€‚</p>
<p>ä¼˜ç‚¹ï¼šç®€å•è€Œé«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹æ¯”ï¼‰ï¼Œå¯¹äº<strong>é™å®šå•ä¸ª CPU çš„ç¯å¢ƒ</strong>æ¥è¯´ï¼ŒSerial æ”¶é›†å™¨ä¸“å¿ƒåšåƒåœ¾æ”¶é›†è‡ªç„¶å¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ã€‚</p>
<p><strong>Serial æ”¶é›†å™¨å¯¹äºè¿è¡Œåœ¨ Client æ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºæ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©</strong><br>å› ä¸ºåœ¨ç”¨æˆ·çš„æ¡Œé¢åº”ç”¨åœºæ™¯ä¸­ï¼Œåˆ†é…ç»™è™šæ‹Ÿæœºç®¡ç†çš„å†…å­˜ä¸€èˆ¬æ¥è¯´ä¸ä¼šå¾ˆå¤§ï¼Œåœé¡¿æ—¶é—´å®Œå…¨å¯ä»¥æ§åˆ¶åœ¨å‡ åæ¯«ç§’æœ€å¤šä¸€ç™¾å¤šæ¯«ç§’ä»¥å†…ï¼Œåªè¦ä¸æ˜¯é¢‘ç¹å‘ç”Ÿï¼Œè¿™ç‚¹åœé¡¿æ˜¯å¯ä»¥æ¥å—çš„ã€‚</p>
<h3 id="ParNew-æ”¶é›†å™¨"><a href="#ParNew-æ”¶é›†å™¨" class="headerlink" title="ParNew æ”¶é›†å™¨"></a>ParNew æ”¶é›†å™¨</h3><p>ParNew æ”¶é›†å™¨å…¶å®å°±æ˜¯ <strong>Serial æ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬</strong></p>
<p><img src="https://user-images.githubusercontent.com/16668676/28901651-5c7621ec-782c-11e7-8feb-b98516448962.png" alt="parnew serial old"></p>
<p><strong>æ˜¯è®¸å¤šè¿è¡Œåœ¨ Server æ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºä¸­é¦–é€‰çš„æ–°ç”Ÿä»£æ”¶é›†å™¨</strong>ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªä¸æ€§èƒ½æ— å…³ä½†<br>å¾ˆé‡è¦çš„åŸå› æ˜¯ï¼Œ<strong>é™¤äº† Serial æ”¶é›†å™¨å¤–ï¼Œç›®å‰åªæœ‰å®ƒèƒ½ä¸ CMS æ”¶é›†å™¨é…åˆå·¥ä½œ</strong>ã€‚</p>
<p>ä¸¤ä¸ªåè¯ï¼šå¹¶å‘å’Œå¹¶è¡Œã€‚</p>
<ul>
<li>å¹¶è¡Œï¼ˆParallelï¼‰ï¼šæŒ‡å¤šæ¡åƒåœ¾æ”¶é›†çº¿ç¨‹<strong>å¹¶è¡Œå·¥ä½œ</strong>ï¼Œä½†æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä»ç„¶å¤„äºç­‰å¾…çŠ¶æ€ã€‚</li>
<li>å¹¶å‘ï¼ˆConcurrentï¼‰ï¼šæŒ‡ç”¨æˆ·çº¿ç¨‹ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹<strong>åŒæ—¶æ‰§è¡Œ</strong>ï¼ˆä½†<strong>ä¸ä¸€å®šæ˜¯å¹¶è¡Œçš„ï¼Œå¯èƒ½ä¼šäº¤æ›¿æ‰§è¡Œ</strong>ï¼‰ï¼Œç”¨æˆ·ç¨‹åºåœ¨ç»§ç»­è¿è¡Œï¼Œè€Œåƒåœ¾æ”¶é›†ç¨‹åºè¿è¡Œäºå¦ä¸€ä¸ª CPU ä¸Šã€‚</li>
<li>äºŒè€…å…³ç³»ï¼šå¹¶è¡Œæ˜¯å¹¶å‘çš„ä¸€ä¸ªå­é›†</li>
</ul>
<h3 id="ParallelScavenge-æ”¶é›†å™¨"><a href="#ParallelScavenge-æ”¶é›†å™¨" class="headerlink" title="ParallelScavenge æ”¶é›†å™¨"></a>ParallelScavenge æ”¶é›†å™¨</h3><p>Parallel Scavenge æ”¶é›†å™¨æ˜¯ä¸€ä¸ªæ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œ ä¸ ParNew å¾ˆç›¸ä¼¼ã€‚ä½†å®ƒçš„<strong>å…³æ³¨ç‚¹ä¸å…¶ä»–æ”¶é›†å™¨ä¸åŒ</strong>ï¼ŒCMS ç­‰æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ˜¯<strong>å°½å¯èƒ½åœ°ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´</strong>ï¼Œè€Œ Parallel Scavenge æ”¶é›†å™¨çš„ç›®æ ‡æ˜¯è¾¾åˆ°<strong>ä¸€ä¸ª==å¯æ§åˆ¶==çš„ååé‡</strong>ï¼ˆThroughputï¼‰ã€‚å®é™…ä¸ŠäºŒè€…æ¦‚å¿µå­˜åœ¨é‡å çš„åœ°æ–¹ã€‚å› ä¸º GC è¿‡ç¨‹ä¸­ç”¨æˆ·çº¿ç¨‹åœé¡¿æ—¶é—´ç¼©çŸ­ï¼Œé‚£ä¹ˆååé‡ä¹Ÿå°±ä¸Šå»äº†ï¼Œåªä¸è¿‡è¦è€ƒè™‘ç”¨æˆ·ä»£ç æ‰§è¡Œæ—¶é—´ä¸åœé¡¿æ—¶é—´çš„æ¯”ä¾‹ã€‚</p>
<p><strong>ååé‡</strong>å°±æ˜¯ CPU ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸ CPU æ€»æ¶ˆè€—æ—¶é—´çš„æ¯”å€¼ï¼Œå³</p>
<ul>
<li><code>ååé‡ = è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´/ï¼ˆè¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´+åƒåœ¾æ”¶é›†æ—¶é—´ï¼‰</code>ï¼Œå‡è®¾è™šæ‹Ÿæœºæ€»å…±è¿è¡Œäº† 100 åˆ†é’Ÿï¼Œå…¶ä¸­åƒåœ¾æ”¶é›†èŠ±æ‰ 1 åˆ†é’Ÿï¼Œé‚£ååé‡å°±æ˜¯ 99%ã€‚</li>
<li>é«˜ååé‡åˆ™å¯ä»¥é«˜æ•ˆç‡åœ°åˆ©ç”¨ CPU æ—¶é—´ï¼Œå°½å¿«å®Œæˆç¨‹åºçš„è¿ç®—ä»»åŠ¡ï¼Œä¸»è¦<strong>é€‚åˆåœ¨åå°è¿ç®—</strong>è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡ã€‚</li>
</ul>
<p><code>MaxGCPauseMillis</code> å‚æ•°å…è®¸çš„å€¼æ˜¯ä¸€ä¸ªå¤§äº 0 çš„æ¯«ç§’æ•°ï¼Œæ”¶é›†å™¨å°†<strong>å°½å¯èƒ½åœ°ä¿è¯å†…å­˜å›æ”¶èŠ±è´¹çš„æ—¶é—´ä¸è¶…è¿‡è®¾å®šå€¼</strong>ã€‚æ³¨æ„ï¼šGC åœé¡¿æ—¶é—´ç¼©çŸ­æ˜¯ä»¥ç‰ºç‰²ååé‡å’Œæ–°ç”Ÿä»£ç©ºé—´æ¥æ¢å–çš„ï¼š<strong>ç³»ç»ŸæŠŠæ–°ç”Ÿä»£è°ƒå°ä¸€äº›ï¼Œè¿™ä¹Ÿç›´æ¥å¯¼è‡´åƒåœ¾æ”¶é›†å‘ç”Ÿå¾—æ›´é¢‘ç¹ä¸€äº›</strong>ã€‚åœé¡¿æ—¶é—´çš„ç¡®åœ¨ä¸‹é™ï¼Œä½†ååé‡ä¹Ÿé™ä¸‹æ¥äº†ã€‚</p>
<p>GCTimeRatio å‚æ•°çš„å€¼æ˜¯ä¸€ä¸ªå¤§äº 0 ä¸”å°äº 100 çš„æ•´æ•°ï¼Œä¹Ÿå°±æ˜¯<strong>åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ç‡</strong>ï¼Œç›¸å½“äºæ˜¯<strong>ååé‡çš„å€’æ•°</strong>ã€‚å¦‚æœæŠŠæ­¤å‚æ•°è®¾ç½®ä¸º 19ï¼Œé‚£å…è®¸çš„æœ€å¤§ GC æ—¶é—´å°±å æ€»æ—¶é—´çš„ 5%ï¼ˆå³ 1/ï¼ˆ1+19ï¼‰ï¼‰ï¼Œé»˜è®¤å€¼ä¸º 99ï¼Œå°±æ˜¯å…è®¸æœ€å¤§ 1 %ï¼ˆå³ 1/ï¼ˆ1+99ï¼‰ï¼‰çš„åƒåœ¾æ”¶é›†æ—¶é—´ã€‚</p>
<p>ç”±äºä¸ååé‡å…³ç³»å¯†åˆ‡ï¼ŒParallel Scavenge æ”¶é›†å™¨ä¹Ÿç»å¸¸ç§°ä¸ºã€Œ<strong>ååé‡ä¼˜å…ˆã€æ”¶é›†å™¨</strong>ã€‚</p>
<p>Parallel Scavenge æ”¶é›†å™¨è¿˜æœ‰ä¸€ä¸ªå¼€å…³å‚æ•° <code>-XXï¼š+UseAdaptiveSizePolicy</code>å½“è¿™ä¸ªå‚æ•°æ‰“å¼€ä¹‹åï¼Œå°±ä¸éœ€è¦æ‰‹å·¥æŒ‡å®šæ–°ç”Ÿä»£çš„å¤§å°ï¼ˆ-Xmnï¼‰ã€Eden ä¸ Survivor åŒºçš„æ¯”ä¾‹ï¼ˆ-XXï¼šSurvivorRatioï¼‰ã€æ™‹å‡è€å¹´ä»£å¯¹è±¡å¹´é¾„ï¼ˆ-XXï¼šPretenureSizeThresholdï¼‰ç­‰ç»†èŠ‚å‚æ•°äº†ï¼Œ<strong>è™šæ‹Ÿæœºä¼šæ ¹æ®å½“å‰ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µ</strong>æ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯ï¼Œ<strong>åŠ¨æ€è°ƒæ•´è¿™äº›å‚æ•°</strong>ä»¥æä¾›æœ€åˆé€‚çš„åœé¡¿æ—¶é—´æˆ–è€…æœ€å¤§çš„ååé‡ï¼Œè¿™ç§è°ƒèŠ‚æ–¹å¼ç§°ä¸º ==<strong>GC è‡ªé€‚åº”çš„è°ƒèŠ‚ç­–ç•¥</strong>==ï¼ˆGC Ergonomicsï¼‰ã€‚è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ä¹Ÿæ˜¯ Parallel Scavenge æ”¶é›†å™¨ä¸ ParNew æ”¶é›†å™¨çš„ä¸€ä¸ªé‡è¦åŒºåˆ«ã€‚</p>
<h3 id="SerialOld-æ”¶é›†å™¨"><a href="#SerialOld-æ”¶é›†å™¨" class="headerlink" title="SerialOld æ”¶é›†å™¨"></a>SerialOld æ”¶é›†å™¨</h3><p>Serial  Old æ˜¯ Serial æ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œä½¿ç”¨ã€Œæ ‡è®°-æ•´ç†ã€ç®—æ³•ã€‚</p>
<ul>
<li><p>è¿™ä¸ªæ”¶é›†å™¨çš„ä¸»è¦æ„ä¹‰ä¹Ÿæ˜¯åœ¨äº<strong>ç»™ Client æ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºä½¿ç”¨</strong>ã€‚</p>
</li>
<li><p>å¦‚æœåœ¨ Server æ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆå®ƒä¸»è¦è¿˜æœ‰ä¸¤å¤§ç”¨é€”ï¼š</p>
<ul>
<li><p>ä¸€ç§ç”¨é€”æ˜¯åœ¨ JDK 1.5 ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­<strong>ä¸ Parallel Scavenge æ”¶é›†å™¨</strong>æ­é…ä½¿ç”¨</p>
</li>
<li><p>å¦ä¸€ç§ç”¨é€”å°±æ˜¯<strong>ä½œä¸º CMS æ”¶é›†å™¨çš„åå¤‡é¢„æ¡ˆ</strong>ï¼Œåœ¨å¹¶å‘æ”¶é›†å‘ç”Ÿ Concurrent Mode Failure æ—¶ä½¿ç”¨ã€‚</p>
<p><img src="https://user-images.githubusercontent.com/16668676/28901652-5c798f30-782c-11e7-9394-6944abe6a65e.png" alt="serial serial old"></p>
</li>
</ul>
</li>
</ul>
<p>Parallel Scavenge æ”¶é›†å™¨æ¶æ„ä¸­æœ¬èº«æœ‰ PS MarkSweep æ”¶é›†å™¨æ¥è¿›è¡Œè€å¹´ä»£æ”¶é›†ï¼Œ<strong>å¹¶éç›´æ¥ä½¿ç”¨äº† Serial Old æ”¶é›†å™¨ï¼Œä½†æ˜¯è¿™ä¸ª PS MarkSweep æ”¶é›†å™¨ä¸ Serial Old çš„å®ç°éå¸¸æ¥è¿‘</strong>ã€‚</p>
<h3 id="ParallelOld-æ”¶é›†å™¨"><a href="#ParallelOld-æ”¶é›†å™¨" class="headerlink" title="ParallelOld æ”¶é›†å™¨"></a>ParallelOld æ”¶é›†å™¨</h3><p>Parallel Old æ˜¯ Parallel Scavenge æ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œä½¿ç”¨å¤šçº¿ç¨‹å’Œã€Œæ ‡è®°-æ•´ç†ã€ç®—æ³•ã€‚</p>
<p>è¿™ä¸ªæ”¶é›†å™¨æ˜¯åœ¨ JDK 1.6 ä¸­æ‰å¼€å§‹æä¾›çš„ï¼Œæ­¤å‰ï¼Œæ–°ç”Ÿä»£çš„ Parallel Scavenge æ”¶é›†å™¨ä¸€ç›´å¤„äºæ¯”è¾ƒå°´å°¬çš„çŠ¶æ€ã€‚å› ä¸º JDK1.6 ä»¥å‰åªèƒ½é€‰æ‹© serial old ä½œä¸ºè€å¹´ä»£æ”¶é›†å™¨ã€‚ï¼ˆå”¯ä¸€èƒ½é€‰æ‹©çš„é˜Ÿå‹ä¸è¡Œï¼‰</p>
<p>ç›´åˆ° Parallel  Old æ”¶é›†å™¨å‡ºç°åï¼Œã€Œååé‡ä¼˜å…ˆã€æ”¶é›†å™¨ç»ˆäºæœ‰äº†æ¯”è¾ƒåå‰¯å…¶å®çš„åº”ç”¨ç»„åˆï¼Œåœ¨<strong>æ³¨é‡ååé‡ä»¥åŠ CPU èµ„æºæ•æ„Ÿçš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼˜å…ˆè€ƒè™‘ Parallel Scavenge åŠ  Parallel Old æ”¶é›†å™¨</strong>ã€‚</p>
<p><img src="https://user-images.githubusercontent.com/16668676/28902291-989d0c04-7830-11e7-8c0f-68559b75a4d4.png" alt="parallel scavenge parallel old"></p>
<h3 id="CMS-æ”¶é›†å™¨"><a href="#CMS-æ”¶é›†å™¨" class="headerlink" title="CMS æ”¶é›†å™¨"></a>CMS æ”¶é›†å™¨</h3><p>CMS æ”¶é›†å™¨ï¼ˆConcurrent Mark Sweepï¼‰åœ¨ JDK1.5 æ—¶æœŸè¢«æ¨å‡ºï¼Œè¿™æ¬¾æ”¶é›†å™¨æ˜¯ HotSpot è™šæ‹Ÿæœºä¸­<strong>ç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„==å¹¶å‘==æ”¶é›†å™¨</strong>ï¼Œå®ƒ<strong>ç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ï¼ˆåŸºæœ¬ä¸Šï¼‰åŒæ—¶å·¥ä½œ</strong>ã€‚</p>
<p>CMS ä½œä¸ºè€å¹´ä»£çš„æ”¶é›†å™¨ï¼Œå´æ— æ³•ä¸ JDK 1.4.0 ä¸­å·²ç»å­˜åœ¨çš„æ–°ç”Ÿä»£æ”¶é›†å™¨ Parallel Scavenge é…åˆå·¥ä½œã€‚</p>
<p><strong>CMSï¼ˆConcurrent Mark Sweep</strong>ï¼‰æ”¶é›†å™¨æ˜¯ä¸€ç§<strong>ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡</strong>çš„æ”¶é›†å™¨ã€‚é€‚åˆäºäº¤äº’å‹çš„åº”ç”¨ã€‚å¸Œæœ›ç³»ç»Ÿåœé¡¿æ—¶é—´æœ€çŸ­ï¼Œä»¥ç»™ç”¨æˆ·å¸¦æ¥è¾ƒå¥½çš„ä½“éªŒã€‚CMS æ”¶é›†å™¨å°±éå¸¸ç¬¦åˆè¿™ç±»åº”ç”¨çš„éœ€æ±‚ã€‚<br>ä»åå­—ï¼ˆåŒ…å«ã€ŒMark Sweepã€ï¼‰ä¸Šå°±å¯ä»¥çœ‹å‡ºï¼ŒCMS æ”¶é›†å™¨æ˜¯<strong>åŸºäºã€Œæ ‡è®°â€”==æ¸…é™¤==ã€ç®—æ³•</strong>å®ç°çš„ï¼Œå®ƒçš„è¿ä½œè¿‡ç¨‹ç›¸å¯¹äºå‰é¢å‡ ç§æ”¶é›†å™¨æ¥è¯´æ›´å¤æ‚ä¸€äº›ï¼Œæ•´ä¸ªè¿‡ç¨‹åˆ†ä¸º 4 ä¸ªæ­¥éª¤ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>åˆå§‹</strong>æ ‡è®°ï¼ˆCMS initial markï¼‰ ,éœ€è¦ã€Œ<em>Stop The World</em>ã€<br>ä»…ä»…åªæ˜¯æ ‡è®°ä¸€ä¸‹ GC Roots èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«</li>
<li><strong>å¹¶å‘</strong>æ ‡è®°ï¼ˆCMS concurrent markï¼‰<br>è¿›è¡Œ GC RootsTracing </li>
<li><strong>é‡æ–°</strong>æ ‡è®°ï¼ˆCMS remarkï¼‰,éœ€è¦ã€Œ<em>Stop The World</em>ã€<br><strong>ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•</strong>ï¼Œè¿™ä¸ªé˜¶æ®µçš„åœé¡¿æ—¶é—´ä¸€èˆ¬ä¼šæ¯”åˆå§‹æ ‡è®°é˜¶æ®µç¨é•¿ä¸€äº›ï¼Œä½†è¿œæ¯”å¹¶å‘æ ‡è®°çš„æ—¶é—´çŸ­ã€‚</li>
<li><strong>å¹¶å‘</strong>æ¸…é™¤ï¼ˆCMS concurrent sweepï¼‰</li>
</ul>
<p>ç”±äºæ•´ä¸ªè¿‡ç¨‹ä¸­<strong>è€—æ—¶æœ€é•¿çš„å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…é™¤è¿‡ç¨‹æ”¶é›†å™¨çº¿ç¨‹éƒ½å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·å·¥ä½œ</strong>ï¼Œæ‰€ä»¥ï¼Œä»æ€»ä½“ä¸Šæ¥è¯´ï¼ŒCMS æ”¶é›†å™¨çš„å†…å­˜å›æ”¶è¿‡ç¨‹æ˜¯ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·å¹¶å‘æ‰§è¡Œçš„ã€‚é€šè¿‡å›¾ 3-10 å¯ä»¥æ¯”è¾ƒæ¸…æ¥šåœ°çœ‹åˆ° CMS æ”¶é›†å™¨çš„è¿ä½œæ­¥éª¤ä¸­å¹¶å‘å’Œéœ€è¦åœé¡¿çš„æ—¶é—´ã€‚<br><img src="https://user-images.githubusercontent.com/16668676/28902476-a8394528-7831-11e7-8fae-73813a57bc06.png" alt="concurrent mark sweep"></p>
<h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ul>
<li><strong>å¯¹ CPU èµ„æºéå¸¸æ•æ„Ÿ</strong><br>å…¶å®ï¼Œé¢å‘å¹¶å‘è®¾è®¡çš„ç¨‹åºéƒ½å¯¹ CPU èµ„æºæ¯”è¾ƒæ•æ„Ÿã€‚åœ¨å¹¶å‘é˜¶æ®µï¼Œå®ƒè™½ç„¶ä¸ä¼šå¯¼è‡´ç”¨æˆ·çº¿ç¨‹åœé¡¿ï¼Œä½†æ˜¯<strong>ä¼šå› ä¸ºå ç”¨äº†ä¸€éƒ¨åˆ†çº¿ç¨‹ï¼ˆæˆ–è€…è¯´ CPU èµ„æºï¼‰è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢</strong>ï¼Œæ€»ååé‡ä¼šé™ä½ã€‚<ul>
<li>CMS é»˜è®¤å¯åŠ¨çš„å›æ”¶çº¿ç¨‹æ•°æ˜¯ï¼ˆ<code>CPU æ•°é‡ + 3ï¼‰/ 4</code>ï¼Œ<ul>
<li>ä¹Ÿå°±æ˜¯å½“ CPU åœ¨ 4 ä¸ªä»¥ä¸Šæ—¶ï¼Œå¹¶å‘å›æ”¶æ—¶åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸å°‘äº 25%çš„ CPU èµ„æºï¼Œå¹¶ä¸”éšç€ CPU æ•°é‡çš„å¢åŠ è€Œä¸‹é™ã€‚</li>
<li>ä½†æ˜¯å½“ CPU ä¸è¶³ 4 ä¸ªï¼ˆè­¬å¦‚ 2 ä¸ªï¼‰æ—¶ï¼ŒCMS å¯¹ç”¨æˆ·ç¨‹åºçš„å½±å“å°±å¯èƒ½å˜å¾—å¾ˆå¤§.</li>
</ul>
</li>
<li>ç”¨æˆ·ç¨‹åºåœ¨ GC è¿‡ç¨‹ä¸­æ‰§è¡Œ ç¼“æ…¢çš„é—®é¢˜ï¼Œæ¨å‡ºäº†<strong>å¢é‡å¼ CMS</strong>ï¼ˆi-CMSï¼‰ï¼Œåœ¨å¹¶å‘æ ‡è®°ã€æ¸…é™¤æ—¶è®© GC çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œå°½é‡å‡å°‘ GC çº¿ç¨‹ç‹¬å èµ„æºçš„æ—¶é—´ï¼Œè™½ç„¶è¿™æ ·ä¼šå¯¼è‡´æ•´ä¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹å˜é•¿ã€‚ä½†æ˜¯æ•ˆæœä¸æ˜æ˜¾ï¼Œç›®å‰ç‰ˆæœ¬ä¸­å·²ç»ä¸å†æ¨èä½¿ç”¨ã€‚</li>
</ul>
</li>
<li><strong>æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾</strong>ï¼ˆFloating  Garbageï¼‰<br>å¯èƒ½å‡ºç°ã€ŒConcurrent  Mode Failureã€å¤±è´¥è€Œå¯¼è‡´å¦ä¸€æ¬¡ Full GC çš„äº§ç”Ÿã€‚<ul>
<li>ç”±äº CMS å¹¶å‘æ¸…ç†é˜¶æ®µç”¨æˆ·çº¿ç¨‹è¿˜åœ¨è¿è¡Œç€ï¼Œä¼´éšç¨‹åºè¿è¡Œè‡ªç„¶å°±è¿˜ä¼šæœ‰æ–°çš„åƒåœ¾ä¸æ–­äº§ç”Ÿï¼Œè¿™ä¸€éƒ¨åˆ†åƒåœ¾å‡ºç°åœ¨æ ‡è®°è¿‡ç¨‹ä¹‹åï¼ŒCMS æ— æ³•åœ¨å½“æ¬¡æ”¶é›†ä¸­å¤„ç†æ‰å®ƒä»¬ï¼Œåªå¥½ç•™å¾…ä¸‹ä¸€æ¬¡ GC æ—¶å†æ¸…ç†æ‰ã€‚è¿™ä¸€éƒ¨åˆ†åƒåœ¾å°±ç§°ä¸ºã€Œ<strong>æµ®åŠ¨åƒåœ¾</strong>ã€ã€‚</li>
</ul>
</li>
<li><strong>æ”¶é›†ç»“æŸæ—¶ä¼šäº§ç”Ÿå¤§é‡ç©ºé—´ç¢ç‰‡</strong>ã€‚ï¼ˆå› ä¸ºä½¿ç”¨äº†ã€Œæ ‡è®°-æ¸…é™¤ã€ç®—æ³•ï¼‰<br>ç©ºé—´ç¢ç‰‡è¿‡å¤šæ—¶ï¼Œå°†ä¼šç»™å¤§å¯¹è±¡åˆ†é…å¸¦æ¥å¾ˆå¤§éº»çƒ¦ï¼Œå¾€å¾€ä¼šå‡ºç°è€å¹´ä»£è¿˜æœ‰å¾ˆå¤§ç©ºé—´å‰©ä½™ï¼Œä½†æ˜¯æ— æ³•æ‰¾åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­ç©ºé—´æ¥åˆ†é…å½“å‰å¯¹è±¡ï¼Œä¸å¾—ä¸æå‰è§¦å‘ä¸€æ¬¡ Full GC ã€‚<ul>
<li>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒCMS æ”¶é›†å™¨æä¾›äº†ä¸€ä¸ª<code>-XXï¼š+UseCMSCompactAtFullCollection</code> å¼€å…³å‚æ•°ï¼ˆé»˜è®¤å°±æ˜¯å¼€å¯çš„ï¼‰ï¼Œç”¨äºåœ¨ CMS æ”¶é›†å™¨<strong>é¡¶ä¸ä½è¦è¿›è¡Œ FullGC æ—¶å¼€å¯å†…å­˜ç¢ç‰‡çš„åˆå¹¶æ•´ç†è¿‡ç¨‹</strong>ï¼Œå†…å­˜æ•´ç†çš„è¿‡ç¨‹æ˜¯æ— æ³•å¹¶å‘çš„ï¼Œ<strong>ç©ºé—´ç¢ç‰‡é—®é¢˜æ²¡æœ‰äº†ï¼Œä½†åœé¡¿æ—¶é—´ä¸å¾—ä¸å˜é•¿</strong>ã€‚</li>
<li>å¦å¤–ä¸€ä¸ªå‚æ•°<code>-XXï¼šCMSFullGCsBeforeCompaction</code>ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ç”¨äºè®¾ç½®<strong>æ‰§è¡Œå¤šå°‘æ¬¡ä¸å‹ç¼©çš„ Full GC åï¼Œè·Ÿç€æ¥ä¸€æ¬¡å¸¦å‹ç¼©çš„</strong>ï¼ˆé»˜è®¤å€¼ä¸º 0ï¼Œè¡¨ç¤ºæ¯æ¬¡è¿›å…¥ Full GC æ—¶éƒ½è¿›è¡Œç¢ç‰‡æ•´ç†ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h3 id="G1-æ”¶é›†å™¨"><a href="#G1-æ”¶é›†å™¨" class="headerlink" title="G1 æ”¶é›†å™¨"></a>G1 æ”¶é›†å™¨</h3><p>G1ï¼ˆ<strong>Garbage-First</strong>ï¼‰æ˜¯ä¸€æ¬¾<strong>é¢å‘æœåŠ¡ç«¯åº”ç”¨</strong>çš„åƒåœ¾æ”¶é›†å™¨ã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ï¼š</p>
<ul>
<li><strong>å¹¶è¡Œä¸å¹¶å‘</strong>ï¼š<br>G1 èƒ½å……åˆ†åˆ©ç”¨å¤š CPUã€å¤šæ ¸ç¯å¢ƒä¸‹çš„ç¡¬ä»¶ä¼˜åŠ¿ï¼Œä½¿ç”¨å¤šä¸ª CPUï¼ˆCPU æˆ–è€… CPU æ ¸å¿ƒï¼‰æ¥ç¼©çŸ­<code>Stop-The-World</code>åœé¡¿çš„æ—¶é—´</li>
<li><strong>åˆ†ä»£æ”¶é›†</strong>ï¼š<br><strong>ä¸éœ€è¦å…¶ä»–æ”¶é›†å™¨é…åˆå°±èƒ½ç‹¬ç«‹ç®¡ç†æ•´ä¸ª GC å †</strong>ï¼Œèƒ½å¤Ÿé‡‡ç”¨ä¸åŒçš„æ–¹å¼å»å¤„ç†æ–°åˆ›å»ºçš„å¯¹è±¡å’Œå·²ç»å­˜æ´»äº†ä¸€æ®µæ—¶é—´ã€ç†¬è¿‡å¤šæ¬¡ GC çš„æ—§å¯¹è±¡ä»¥è·å–æ›´å¥½çš„æ”¶é›†æ•ˆæœã€‚</li>
<li>ç©ºé—´æ•´åˆï¼šæ— å†…å­˜ç¢ç‰‡ã€‚<br>ä¸ CMS çš„ã€Œæ ‡è®°â€”æ¸…ç†ã€ç®—æ³•ä¸åŒï¼ŒG1<ul>
<li>ä»<strong>æ•´ä½“</strong>æ¥çœ‹æ˜¯<strong>åŸºäºã€Œæ ‡è®°â€”æ•´ç†ã€ç®—æ³•å®ç°</strong>çš„æ”¶é›†å™¨</li>
<li>ä»<strong>å±€éƒ¨</strong>ï¼ˆä¸¤ä¸ª Region ä¹‹é—´ï¼‰ä¸Šæ¥çœ‹æ˜¯<strong>åŸºäºã€Œå¤åˆ¶ã€ç®—æ³•</strong>å®ç°çš„</li>
<li>è¿™ä¸¤ç§ç®—æ³•éƒ½æ„å‘³ç€<strong>G1 è¿ä½œæœŸé—´ä¸ä¼šäº§ç”Ÿå†…å­˜ç©ºé—´ç¢ç‰‡ï¼Œæ”¶é›†åèƒ½æä¾›è§„æ•´çš„å¯ç”¨å†…å­˜</strong>ã€‚è¿™ç§ç‰¹æ€§æœ‰åˆ©äºç¨‹åºé•¿æ—¶é—´è¿è¡Œï¼Œåˆ†é…å¤§å¯¹è±¡æ—¶ä¸ä¼šå› ä¸ºæ— æ³•æ‰¾åˆ°è¿ç»­å†…å­˜ç©ºé—´è€Œæå‰è§¦å‘ä¸‹ä¸€æ¬¡ GCã€‚</li>
</ul>
</li>
<li><strong>å¯é¢„æµ‹çš„åœé¡¿</strong>ï¼š<br>é™ä½åœé¡¿æ—¶é—´æ˜¯ G1 å’Œ CMS å…±åŒçš„å…³æ³¨ç‚¹ï¼Œä½† G1 é™¤äº†è¿½æ±‚ä½åœé¡¿å¤–ï¼Œ<strong>è¿˜èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹</strong>ï¼Œèƒ½è®©ä½¿ç”¨è€…<strong>æ˜ç¡®æŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸º M æ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œæ¶ˆè€—åœ¨åƒåœ¾æ”¶é›†ä¸Šçš„æ—¶é—´ä¸å¾—è¶…è¿‡ N æ¯«ç§’</strong>ã€‚ä½¿ç”¨ G1 æ”¶é›†å™¨æ—¶ï¼ŒJava å †çš„å†…å­˜å¸ƒå±€å°±ä¸å…¶ä»–æ”¶é›†å™¨æœ‰å¾ˆå¤§å·®åˆ«ï¼ˆå…¶ä»–æ”¶é›†å™¨éƒ½æ˜¯å¯¹æ•´ä¸€ä¸ªè€å¹´ä»£æˆ–è€…æ–°ç”Ÿä»£è¿›è¡Œæ“ä½œï¼‰ï¼Œå®ƒ<strong>å°†æ•´ä¸ª Java  å †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸ</strong>ï¼ˆRegionï¼‰ï¼Œè™½ç„¶è¿˜ä¿ç•™æœ‰æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†<strong>æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸å†æ˜¯ç‰©ç†éš”ç¦»çš„äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸€éƒ¨åˆ† Regionï¼ˆä¸éœ€è¦è¿ç»­ï¼‰çš„é›†åˆ</strong>ã€‚</li>
</ul>
<p>ä¹‹æ‰€ä»¥èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼Œæ˜¯å› ä¸ºå®ƒ<strong>å¯ä»¥æœ‰è®¡åˆ’åœ°é¿å…</strong>åœ¨æ•´ä¸ª Java å †ä¸­<strong>è¿›è¡Œå…¨åŒºåŸŸçš„åƒåœ¾æ”¶é›†</strong>ã€‚G1 è·Ÿè¸ªå„ä¸ª Region é‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œ<strong>åœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨</strong>ï¼Œ<strong>æ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„ Region</strong>ï¼ˆè¿™ä¹Ÿå°±æ˜¯ Garbage-First åç§°çš„æ¥ç”±ï¼‰ã€‚è¿™ç§<strong>ä½¿ç”¨ Region åˆ’åˆ†å†…å­˜ç©ºé—´ä»¥åŠæœ‰ä¼˜å…ˆçº§çš„åŒºåŸŸå›æ”¶æ–¹å¼</strong>ï¼Œä¿è¯äº† G1 æ”¶é›†å™¨åœ¨æœ‰é™çš„æ—¶é—´å†…å¯ä»¥è·å–å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡ã€‚</p>
<p>Region ä¸å¯èƒ½æ˜¯å­¤ç«‹çš„ã€‚ä¸€ä¸ªå¯¹è±¡åˆ†é…åœ¨æŸä¸ª Region ä¸­ï¼Œå¯ä»¥ä¸æ•´ä¸ª Java å †ä»»æ„çš„å¯¹è±¡å‘ç”Ÿå¼•ç”¨å…³ç³»ã€‚é‚£åœ¨åšå¯è¾¾æ€§åˆ¤å®šç¡®å®šå¯¹è±¡æ˜¯å¦å­˜æ´»çš„æ—¶å€™ï¼Œå²‚ä¸æ˜¯è¿˜å¾—æ‰«ææ•´ä¸ª Java å †æ‰èƒ½ä¿è¯å‡†ç¡®æ€§ï¼Ÿåœ¨ G1 æ”¶é›†å™¨ä¸­ï¼ŒRegion ä¹‹é—´çš„å¯¹è±¡å¼•ç”¨ä»¥åŠå…¶ä»–æ”¶é›†å™¨ä¸­çš„æ–°ç”Ÿä»£ä¸è€å¹´ä»£ä¹‹é—´çš„å¯¹è±¡<br>å¼•ç”¨ï¼Œè™šæ‹Ÿæœºéƒ½æ˜¯<strong>ä½¿ç”¨ ==Remembered Set== æ¥é¿å…å…¨å †æ‰«æ</strong>çš„ã€‚</p>
<ul>
<li>G1 ä¸­æ¯ä¸ª Region éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ Remembered Setï¼Œè™šæ‹Ÿæœºå‘ç°ç¨‹åºåœ¨<strong>å¯¹ Reference ç±»å‹çš„æ•°æ®è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª Write Barrier æš‚æ—¶ä¸­æ–­å†™æ“ä½œ</strong>ï¼Œæ£€æŸ¥ Reference å¼•ç”¨çš„å¯¹è±¡æ˜¯å¦å¤„äºä¸åŒçš„ Region ä¹‹ä¸­ï¼ˆåœ¨åˆ†ä»£çš„ä¾‹å­ä¸­å°±æ˜¯æ£€æŸ¥æ˜¯å¦è€å¹´ä»£ä¸­çš„å¯¹è±¡å¼•ç”¨äº†æ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œä¾¿é€šè¿‡ <strong>CardTable</strong> æŠŠç›¸å…³å¼•ç”¨ä¿¡æ¯è®°å½•åˆ°è¢«å¼•ç”¨å¯¹è±¡æ‰€å±çš„ Region çš„ Remembered Set ä¹‹ä¸­ã€‚</li>
<li>å½“è¿›è¡Œå†…å­˜å›æ”¶æ—¶ï¼Œåœ¨ GC æ ¹èŠ‚ç‚¹çš„æšä¸¾èŒƒå›´ä¸­åŠ å…¥ Remembered Set å³å¯ä¿è¯ä¸å¯¹å…¨å †æ‰«æä¹Ÿä¸ä¼šæœ‰é—æ¼ã€‚</li>
</ul>
<p>å¦‚æœä¸è®¡ç®—ç»´æŠ¤ Remembered Set çš„æ“ä½œï¼ŒG1 æ”¶é›†å™¨çš„è¿ä½œå¤§è‡´å¯åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>åˆå§‹æ ‡è®°ï¼ˆInitial Markingï¼‰</li>
<li>å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markingï¼‰</li>
<li>æœ€ç»ˆæ ‡è®°ï¼ˆFinal Markingï¼‰</li>
<li><strong>ç­›é€‰å›æ”¶</strong>ï¼ˆLive Data Counting and Evacuationï¼‰<ul>
<li>å“ªä¸€å—å›æ”¶çš„æ”¶ç›Šå¤§å°±é€‰å“ªä¸€å—ã€‚</li>
</ul>
</li>
</ul>
<p>G1 çš„å‰å‡ ä¸ªæ­¥éª¤çš„è¿ä½œè¿‡ç¨‹å’Œ CMS æœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ã€‚</p>
<ul>
<li><strong>åˆå§‹æ ‡è®°é˜¶æ®µ</strong><br>ä»…ä»…åªæ˜¯æ ‡è®°ä¸€ä¸‹ GC Roots <strong>èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡</strong>ï¼Œå¹¶ä¸”ä¿®æ”¹ TAMSï¼ˆNext Top at Mark Startï¼‰çš„å€¼ï¼Œè®©ä¸‹ä¸€é˜¶æ®µç”¨æˆ·ç¨‹åºå¹¶å‘è¿è¡Œæ—¶ï¼Œèƒ½åœ¨æ­£ç¡®å¯ç”¨çš„ Region ä¸­åˆ›å»ºæ–°å¯¹è±¡ï¼Œè¿™é˜¶æ®µ<strong>éœ€è¦åœé¡¿çº¿ç¨‹ï¼Œä½†è€—æ—¶å¾ˆçŸ­</strong>ã€‚</li>
<li><strong>å¹¶å‘æ ‡è®°é˜¶æ®µ</strong><br>æ˜¯ä» GC Root å¼€å§‹å¯¹å †ä¸­å¯¹è±¡è¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œæ‰¾å‡ºå­˜æ´»çš„å¯¹è±¡ï¼Œè¿™é˜¶æ®µè€—æ—¶è¾ƒé•¿ï¼Œä½†<strong>å¯ä¸ç”¨æˆ·ç¨‹åºå¹¶å‘æ‰§è¡Œ</strong>ã€‚</li>
<li><strong>æœ€ç»ˆæ ‡è®°é˜¶æ®µ</strong><br>æ˜¯ä¸ºäº†<strong>ä¿®æ­£åœ¨å¹¶å‘æ ‡è®°æœŸé—´å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†æ ‡è®°è®°å½•</strong>ï¼Œè™šæ‹Ÿæœºå°†è¿™æ®µæ—¶é—´å¯¹è±¡å˜åŒ–è®°å½•åœ¨çº¿ç¨‹ Remembered Set Logs é‡Œé¢ï¼Œæœ€ç»ˆæ ‡è®°é˜¶æ®µéœ€è¦æŠŠ <strong>Remembered Set Logs çš„æ•°æ®åˆå¹¶åˆ° Remembered Set ä¸­</strong>ï¼Œè¿™é˜¶æ®µ<strong>éœ€è¦åœé¡¿çº¿ç¨‹</strong>ï¼Œä½†æ˜¯<strong>å¯å¹¶è¡Œæ‰§è¡Œ</strong>ã€‚</li>
<li><strong>ç­›é€‰å›æ”¶é˜¶æ®µ</strong><br>å¯¹å„ä¸ª Region çš„<strong>å›æ”¶ä»·å€¼å’Œæˆæœ¬è¿›è¡Œæ’åº</strong>ï¼Œæ ¹æ®ç”¨æˆ·æ‰€æœŸæœ›çš„ GC åœé¡¿æ—¶é—´æ¥åˆ¶å®šå›æ”¶è®¡åˆ’ã€‚</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/16668676/28903495-d71fceb0-7837-11e7-8e8e-6f26da762c22.png" alt="g1"></p>
<h3 id="ç»„åˆç­–ç•¥"><a href="#ç»„åˆç­–ç•¥" class="headerlink" title="ç»„åˆç­–ç•¥"></a>ç»„åˆç­–ç•¥</h3><p>åœ¨è¿›è¡Œ JVM è°ƒä¼˜çš„è¿‡ç¨‹ä¸­ï¼Œå¹¶éä»»ä½•ä¸€ç§æ–°ç”Ÿä»£ GC ç­–ç•¥éƒ½å¯ä»¥å’Œå¦ä¸€ç§å¹´è€ä»£ GC ç­–ç•¥è¿›è¡Œé…åˆå·¥ä½œï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åº”è¯¥çŸ¥é“ï¼Œå“ªäº›ç§ç»„åˆå¯ä»¥æœ‰æ•ˆåœ°è¿›è¡Œ GCï¼Œè€Œä¸”åº”è¯¥åœ¨ä»€ä¹ˆæ ·çš„åº”ç”¨åœºæ™¯ä¸‹é€‰æ‹©å“ªä¸€ç§ç»„åˆï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:left"><strong>æ–°ç”Ÿä»£ GC ç­–ç•¥</strong></th>
<th><strong>å¹´è€ä»£ GC ç­–ç•¥</strong></th>
<th style="text-align:left"><strong>è¯´æ˜</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ç»„åˆ 1</td>
<td style="text-align:left">Serial</td>
<td>Serial Old</td>
<td style="text-align:left">Serial å’Œ Serial Old éƒ½æ˜¯å•çº¿ç¨‹è¿›è¡Œ GCï¼Œç‰¹ç‚¹å°±æ˜¯ GC æ—¶æš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚</td>
</tr>
<tr>
<td style="text-align:center">ç»„åˆ 2</td>
<td style="text-align:left">Serial</td>
<td>CMS+Serial Old</td>
<td style="text-align:left">CMSï¼ˆConcurrent Mark Sweepï¼‰æ˜¯å¹¶å‘ GCï¼Œå®ç° GC çº¿ç¨‹å’Œåº”ç”¨çº¿ç¨‹å¹¶å‘å·¥ä½œï¼Œä¸éœ€è¦æš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚å¦å¤–ï¼Œå½“ CMS è¿›è¡Œ GC å¤±è´¥æ—¶ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ Serial Old ç­–ç•¥è¿›è¡Œ GCã€‚</td>
</tr>
<tr>
<td style="text-align:center">ç»„åˆ 3</td>
<td style="text-align:left">ParNew</td>
<td>CMS</td>
<td style="text-align:left">ä½¿ç”¨-XX:+UseParNewGC é€‰é¡¹æ¥å¼€å¯ã€‚ParNew æ˜¯ Serial çš„å¹¶è¡Œç‰ˆæœ¬ï¼Œå¯ä»¥æŒ‡å®š GC çº¿ç¨‹æ•°ï¼Œé»˜è®¤ GC çº¿ç¨‹æ•°ä¸º CPU çš„æ•°é‡ã€‚å¯ä»¥ä½¿ç”¨-XX:ParallelGCThreads é€‰é¡¹æŒ‡å®š GC çš„çº¿ç¨‹æ•°ã€‚å¦‚æœæŒ‡å®šäº†é€‰é¡¹-XX:+UseConcMarkSweepGC é€‰é¡¹ï¼Œåˆ™æ–°ç”Ÿä»£é»˜è®¤ä½¿ç”¨ ParNew GC ç­–ç•¥ã€‚</td>
</tr>
<tr>
<td style="text-align:center">ç»„åˆ 4</td>
<td style="text-align:left">ParNew</td>
<td>Serial Old</td>
<td style="text-align:left">ä½¿ç”¨-XX:+UseParNewGC é€‰é¡¹æ¥å¼€å¯ã€‚æ–°ç”Ÿä»£ä½¿ç”¨ ParNew GC ç­–ç•¥ï¼Œå¹´è€ä»£é»˜è®¤ä½¿ç”¨ Serial Old GC ç­–ç•¥ã€‚</td>
</tr>
<tr>
<td style="text-align:center">ç»„åˆ 5</td>
<td style="text-align:left">Parallel Scavenge</td>
<td>Serial Old</td>
<td style="text-align:left">Parallel Scavenge ç­–ç•¥ä¸»è¦æ˜¯å…³æ³¨ä¸€ä¸ªå¯æ§çš„ååé‡ï¼šåº”ç”¨ç¨‹åºè¿è¡Œæ—¶é—´ / (åº”ç”¨ç¨‹åºè¿è¡Œæ—¶é—´ + GC æ—¶é—´)ï¼Œå¯è§è¿™ä¼šä½¿å¾— CPU çš„åˆ©ç”¨ç‡å°½å¯èƒ½çš„é«˜ï¼Œé€‚ç”¨äºåå°æŒä¹…è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè€Œä¸é€‚ç”¨äºäº¤äº’è¾ƒå¤šçš„åº”ç”¨ç¨‹åºã€‚</td>
</tr>
<tr>
<td style="text-align:center">ç»„åˆ 6</td>
<td style="text-align:left">Parallel Scavenge</td>
<td>Parallel Old</td>
<td style="text-align:left">Parallel Old æ˜¯ Parallel Scavenge æ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ã€‚é€‚ç”¨äºæ³¨é‡ååé‡ä»¥åŠ CPU èµ„æºæ•æ„Ÿçš„åœºåˆ</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:left">G1</td>
<td></td>
<td style="text-align:left">G1 æ˜¯ Garbage First åƒåœ¾æ”¶é›†å™¨ã€‚</td>
</tr>
</tbody>
</table>
<h3 id="ç†è§£-GC-æ—¥å¿—"><a href="#ç†è§£-GC-æ—¥å¿—" class="headerlink" title="ç†è§£ GC æ—¥å¿—"></a>ç†è§£ GC æ—¥å¿—</h3><p>GC æ—¥å¿—å¼€å¤´çš„ ã€Œ[GCã€å’Œã€Œ[Full  GCã€<strong>è¯´æ˜äº†è¿™æ¬¡åƒåœ¾æ”¶é›†çš„==åœé¡¿ç±»å‹==ï¼Œè€Œä¸æ˜¯ç”¨æ¥åŒºåˆ†æ–°ç”Ÿä»£ GC è¿˜æ˜¯è€å¹´ä»£ GC çš„</strong>ã€‚</p>
<ul>
<li>å¦‚æœæœ‰ã€ŒFullã€ï¼Œ<strong>è¯´æ˜è¿™æ¬¡ GC æ˜¯å‘ç”Ÿäº† Stop-The-World çš„</strong>ï¼Œè¿™æ®µæ–°ç”Ÿä»£æ”¶é›†å™¨ ParNew çš„æ—¥å¿—ä¹Ÿä¼šå‡ºç°ã€Œ[Full GCã€ï¼ˆè¿™ä¸€èˆ¬æ˜¯å› ä¸ºå‡ºç°äº†åˆ†é…æ‹…ä¿å¤±è´¥ä¹‹ç±»çš„é—®é¢˜ï¼Œæ‰€ä»¥æ‰å¯¼è‡´ STWï¼‰ã€‚</li>
<li>å¦‚æœæ˜¯è°ƒç”¨ System.gcï¼ˆï¼‰æ–¹æ³•æ‰€è§¦å‘çš„æ”¶é›†ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°†æ˜¾ç¤ºã€Œ[Full GCï¼ˆSystemï¼‰ã€ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥çš„ã€Œ[DefNewã€ã€ã€Œ[Tenuredã€ã€ã€Œ[Permã€è¡¨ç¤º <strong>GC å‘ç”Ÿçš„åŒºåŸŸ</strong>ï¼Œè¿™é‡Œæ˜¾ç¤ºçš„åŒºåŸŸåç§°ä¸ä½¿ç”¨çš„ GC æ”¶é›†å™¨æ˜¯å¯†åˆ‡ç›¸å…³çš„ï¼Œ</p>
<ul>
<li>Serial æ”¶é›†å™¨ä¸­çš„æ–°ç”Ÿä»£åä¸º ã€ŒDefault New  Generationã€ï¼Œæ‰€ä»¥æ˜¾ç¤ºçš„æ˜¯ã€Œ[DefNewã€ã€‚</li>
<li>å¦‚æœæ˜¯ ParNew æ”¶é›†å™¨ï¼Œæ–°ç”Ÿä»£åç§°å°±ä¼šå˜ä¸ºã€Œ[ParNewã€ï¼Œæ„ä¸º ã€ŒParallel New Generationã€ã€‚</li>
<li>å¦‚æœé‡‡ç”¨ Parallel Scavenge æ”¶é›†å™¨ï¼Œé‚£å®ƒé…å¥—çš„æ–°ç”Ÿä»£ç§°ä¸ºã€ŒPSYoungGenã€</li>
</ul>
<h2 id="å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥"><a href="#å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥" class="headerlink" title="å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥"></a>å†…å­˜åˆ†é…ä¸å›æ”¶ç­–ç•¥</h2><p>å¯¹è±¡çš„å†…å­˜åˆ†é…ï¼Œå¾€å¤§æ–¹å‘è®²ï¼Œå°±æ˜¯åœ¨å †ä¸Šåˆ†é…ï¼ˆä½†ä¹Ÿå¯èƒ½ç»è¿‡ JIT ç¼–è¯‘åè¢«æ‹†æ•£ä¸ºæ ‡é‡ç±»å‹å¹¶é—´æ¥åœ°æ ˆä¸Šåˆ†é…ï¼‰ï¼Œ<strong>å¯¹è±¡ä¸»è¦åˆ†é…åœ¨æ–°ç”Ÿä»£çš„ Eden åŒºä¸Šï¼Œå¦‚æœå¯åŠ¨äº†æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²ï¼Œå°†æŒ‰çº¿ç¨‹ä¼˜å…ˆåœ¨ TLAB ä¸Šåˆ†é…*ã€‚å°‘æ•°æƒ…å†µä¸‹ä¹Ÿå¯èƒ½ä¼šç›´æ¥åˆ†é…åœ¨è€å¹´ä»£ä¸­</strong>ï¼Œ</p>
<ul>
<li>æ³¨: TLAB å…¨ç§°ä¸º Thread Local Allocation Buffered</li>
</ul>
<p>åˆ†é…çš„è§„åˆ™å¹¶ä¸æ˜¯ç™¾åˆ†ä¹‹ç™¾å›ºå®šçš„ï¼Œå…¶ç»†èŠ‚å–å†³äºå½“å‰ä½¿ç”¨çš„æ˜¯å“ªä¸€ç§åƒåœ¾æ”¶é›†å™¨ç»„åˆï¼Œè¿˜æœ‰è™šæ‹Ÿæœºä¸­ä¸å†…å­˜ç›¸å…³çš„å‚æ•°çš„è®¾ç½®ã€‚ä»¥ä¸‹ä¸ºå‡ æ¡æœ€æ™®éçš„å†…å­˜åˆ†é…è§„åˆ™ã€‚</p>
<ul>
<li>å¯¹è±¡ä¼˜å…ˆåœ¨ Eden åˆ†é…ã€ </li>
<li>å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ã€ </li>
<li>é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£ ã€</li>
<li>åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š ã€</li>
<li>ç©ºé—´åˆ†é…æ‹…ä¿</li>
</ul>
<h3 id="å¯¹è±¡ä¼˜å…ˆåœ¨-Eden-åˆ†é…"><a href="#å¯¹è±¡ä¼˜å…ˆåœ¨-Eden-åˆ†é…" class="headerlink" title="å¯¹è±¡ä¼˜å…ˆåœ¨ Eden åˆ†é…"></a>å¯¹è±¡ä¼˜å…ˆåœ¨ Eden åˆ†é…</h3><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£ Eden åŒºä¸­åˆ†é…ã€‚å½“ Eden åŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡ <strong>Minor GC</strong>ã€‚</p>
<h4 id="Minor-GC-å’Œ-Full-major-GC-æœ‰ä»€ä¹ˆä¸ä¸€æ ·å—ï¼Ÿ"><a href="#Minor-GC-å’Œ-Full-major-GC-æœ‰ä»€ä¹ˆä¸ä¸€æ ·å—ï¼Ÿ" class="headerlink" title="Minor GC å’Œ Full/major GC æœ‰ä»€ä¹ˆä¸ä¸€æ ·å—ï¼Ÿ"></a>Minor GC å’Œ Full/major GC æœ‰ä»€ä¹ˆä¸ä¸€æ ·å—ï¼Ÿ</h4><ul>
<li><strong>æ–°ç”Ÿä»£ GC</strong>ï¼ˆMinor GCï¼‰ï¼šæŒ‡å‘ç”Ÿåœ¨<strong>æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†åŠ¨ä½œ</strong>ï¼Œå› ä¸º Java å¯¹è±¡å¤§å¤šéƒ½å…·å¤‡æœç”Ÿå¤•ç­çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ Minor GC éå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚</li>
<li><strong>è€å¹´ä»£ GC</strong>ï¼ˆMajor GC/Full GCï¼‰ï¼šæŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„ GCï¼Œå‡ºç°äº† Major GCï¼Œ<strong>ç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„ Minor GC</strong>ï¼ˆä½†éç»å¯¹çš„ï¼Œåœ¨ Parallel Scavenge æ”¶é›†å™¨çš„æ”¶é›†ç­–ç•¥é‡Œå°±æœ‰ç›´æ¥è¿›è¡Œ Major GC çš„ç­–ç•¥é€‰æ‹©è¿‡ç¨‹ï¼‰ã€‚<strong>Major GC çš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯” Minor GC æ…¢ 10 å€ä»¥ä¸Š</strong>ã€‚</li>
</ul>
<h3 id="å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£"><a href="#å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£" class="headerlink" title="å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£"></a>å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£</h3><p>æ‰€è°“çš„å¤§å¯¹è±¡æ˜¯æŒ‡ï¼Œ<strong>éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„ Java å¯¹è±¡</strong>ï¼Œæœ€å…¸å‹çš„å¤§å¯¹è±¡å°±æ˜¯é‚£ç§å¾ˆé•¿çš„å­—ç¬¦ä¸²ä»¥åŠæ•°ç»„ã€‚</p>
<p>è™šæ‹Ÿæœºæä¾›äº†ä¸€ä¸ª<code>-XXï¼šPretenureSizeThreshold</code> å‚æ•°ï¼Œä»¤å¤§äºè¿™ä¸ªè®¾ç½®å€¼çš„å¯¹è±¡ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯<strong>é¿å…åœ¨ Eden åŒºåŠä¸¤ä¸ª Survivor åŒºä¹‹é—´å‘ç”Ÿå¤§é‡çš„å†…å­˜å¤åˆ¶</strong>ï¼ˆå¤ä¹ ä¸€ä¸‹ï¼šæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•æ”¶é›†å†…å­˜ï¼‰ã€‚</p>
<h3 id="é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£"><a href="#é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£" class="headerlink" title="é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£"></a>é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£</h3><p>ä¸ºäº†åšåˆ°è¿™ç‚¹ï¼Œè™šæ‹Ÿæœºç»™æ¯ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€ä¸ª<strong>å¯¹è±¡å¹´é¾„ï¼ˆAgeï¼‰è®¡æ•°å™¨</strong>ã€‚</p>
<ul>
<li>å¦‚æœå¯¹è±¡åœ¨ Eden å‡ºç”Ÿå¹¶<strong>ç»è¿‡ç¬¬ä¸€æ¬¡ Minor GC åä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢« Survivor å®¹çº³çš„è¯</strong>ï¼Œå°†è¢«ç§»åŠ¨åˆ° Survivor ç©ºé—´ä¸­ï¼Œå¹¶ä¸”å¯¹è±¡å¹´é¾„è®¾ä¸º 1ã€‚</li>
<li><strong>å¯¹è±¡åœ¨ Survivor åŒºä¸­æ¯ã€Œç†¬è¿‡ã€ä¸€æ¬¡ Minor GCï¼Œå¹´é¾„å°±å¢åŠ  1 å²</strong>ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º 15 å²ï¼‰ï¼Œå°±å°†ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚<ul>
<li>å¯¹è±¡æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡å‚æ•° <code>-XXï¼šMaxTenuringThreshold</code> è®¾ç½®ã€‚</li>
</ul>
</li>
</ul>
<h3 id="åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š"><a href="#åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š" class="headerlink" title="åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š"></a>åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š</h3><p>è™šæ‹Ÿæœºå¹¶ä¸æ˜¯æ°¸è¿œåœ°è¦æ±‚å¯¹è±¡çš„å¹´é¾„å¿…é¡»è¾¾åˆ°äº† <code>MaxTenuringThreshold</code>æ‰èƒ½æ™‹å‡è€å¹´ä»£ï¼Œ<strong>å¦‚æœåœ¨ Survivor ç©ºé—´ä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äº Survivor ç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£</strong>ï¼Œæ— é¡»ç­‰åˆ° <code>MaxTenuringThreshold</code>ä¸­è¦æ±‚çš„å¹´é¾„ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒé¾„çš„å°ä¼™ä¼´çš„å†…å­˜å¤§äºæ€»å†…å­˜çš„ä¸€åŠã€‚é‚£ä¹ˆ &gt;= è¯¥å¹´é¾„çš„å°±ç®—è€äº†ã€‚</p>
<h3 id="ç©ºé—´åˆ†é…æ‹…ä¿"><a href="#ç©ºé—´åˆ†é…æ‹…ä¿" class="headerlink" title="ç©ºé—´åˆ†é…æ‹…ä¿"></a>ç©ºé—´åˆ†é…æ‹…ä¿</h3><p>åœ¨å‘ç”Ÿ Minor GC ä¹‹å‰ï¼Œ</p>
<ul>
<li>è™šæ‹Ÿæœºä¼šå…ˆ<strong>æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡æ€»ç©ºé—´</strong>ï¼Œ<ul>
<li>å¦‚æœè¿™ä¸ªæ¡ä»¶æˆç«‹ï¼Œé‚£ä¹ˆ Minor GC å¯ä»¥ç¡®ä¿æ˜¯å®‰å…¨çš„ã€‚</li>
<li>å¦‚æœä¸æˆç«‹ï¼Œåˆ™è™šæ‹Ÿæœºä¼šæŸ¥çœ‹  HandlePromotionFailure è®¾ç½®å€¼æ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥ã€‚<ul>
<li>å¦‚æœå…è®¸ï¼Œé‚£ä¹ˆä¼šç»§ç»­æ£€æŸ¥<strong>è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´</strong>æ˜¯å¦å¤§äº<strong>å†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡å®¹é‡</strong>çš„==å¹³å‡å¤§å°==ï¼Œ<ul>
<li>å¦‚æœå¤§äºï¼Œå°†å°è¯•ç€è¿›è¡Œä¸€æ¬¡ Minor GCï¼Œå°½ç®¡è¿™æ¬¡ Minor GC æ˜¯æœ‰é£é™©çš„ï¼›</li>
<li>å¦‚æœå°äºï¼Œæˆ–è€… HandlePromotionFailure è®¾ç½®ä¸å…è®¸å†’é™©ï¼Œé‚£è¿™æ—¶ä¹Ÿè¦æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡ <code>Full GC</code>ã€‚</li>
</ul>
</li>
<li>å¦‚æœä¸å…è®¸ï¼Œæ”¹ä¸ºè¿›è¡Œä¸€æ¬¡ <code>Full GC</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ã€Œå†’é™©ã€æ˜¯å†’äº†ä»€ä¹ˆé£é™©ï¼Ÿ  </p>
<ul>
<li>ä¸€å¥è¯å°±æ˜¯ï¼šè€å¹´ä»£çš„æœ€å¤§å¯ç”¨è¿ç»­ç©ºé—´å¯èƒ½å°äºæ–°ç”Ÿä»£æ‰€æœ‰å­˜æ´»å¯¹è±¡æ€»ç©ºé—´ï¼Œå°±ä¼šå¯¼è‡´ Full GCï¼Œæœ¬æ¥æ˜¯åº”è¯¥ç›´æ¥æ‰§è¡Œ Full GC çš„ï¼Œä½†æ˜¯æ²¡æœ‰ç›´æ¥æ‰§è¡Œï¼Œå¯¼è‡´æµªè´¹äº†æ—¶é—´ã€‚</li>
<li>å…·ä½“è€Œè¨€ï¼š<br>æ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶æ”¶é›†ç®—æ³•ï¼Œä½†ä¸ºäº†å†…å­˜åˆ©ç”¨ç‡ï¼Œ<strong>åªä½¿ç”¨å…¶ä¸­ä¸€ä¸ª Survivor ç©ºé—´æ¥ä½œä¸ºè½®æ¢å¤‡ä»½</strong>ï¼Œå› æ­¤å½“å‡ºç°<strong>å¤§é‡å¯¹è±¡åœ¨ Minor GC åä»ç„¶å­˜æ´»çš„æƒ…å†µ</strong>ï¼ˆæœ€æç«¯çš„æƒ…å†µå°±æ˜¯å†…å­˜å›æ”¶åæ–°ç”Ÿä»£ä¸­æ‰€æœ‰å¯¹è±¡éƒ½å­˜æ´»ï¼‰ï¼Œå°±éœ€è¦è€å¹´ä»£è¿›è¡Œåˆ†é…æ‹…ä¿ï¼ŒæŠŠ Survivor æ— æ³•å®¹çº³çš„å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚<strong>è€å¹´ä»£è¦è¿›è¡Œè¿™æ ·çš„æ‹…ä¿ï¼Œå‰ææ˜¯è€å¹´ä»£æœ¬èº«è¿˜æœ‰å®¹çº³è¿™äº›å¯¹è±¡çš„å‰©ä½™ç©ºé—´</strong>ï¼Œä¸€å…±æœ‰å¤šå°‘å¯¹è±¡ä¼šæ´»ä¸‹æ¥åœ¨å®é™…å®Œæˆå†…å­˜å›æ”¶ä¹‹å‰æ˜¯æ— æ³•æ˜ç¡®çŸ¥é“çš„ï¼Œæ‰€ä»¥åªå¥½å–ä¹‹å‰æ¯ä¸€æ¬¡å›æ”¶æ™‹å‡åˆ°è€å¹´ä»£å¯¹è±¡å®¹é‡çš„å¹³å‡å¤§å°å€¼ä½œä¸ºç»éªŒå€¼ï¼Œä¸è€å¹´ä»£çš„å‰©ä½™ç©ºé—´è¿›è¡Œæ¯”è¾ƒï¼Œå†³å®šæ˜¯å¦è¿›è¡Œ Full GC æ¥è®©è€å¹´ä»£è…¾å‡ºæ›´å¤šç©ºé—´ã€‚</li>
</ul>
<p>å–å¹³å‡å€¼è¿›è¡Œæ¯”è¾ƒå…¶å®ä»ç„¶æ˜¯<strong>ä¸€ç§åŠ¨æ€æ¦‚ç‡çš„æ‰‹æ®µ</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæŸæ¬¡ Minor GC å­˜æ´»åçš„å¯¹è±¡çªå¢ï¼Œè¿œè¿œé«˜äºå¹³å‡å€¼çš„è¯ï¼Œä¾ç„¶ä¼šå¯¼è‡´æ‹…ä¿å¤±è´¥ï¼ˆHandle Promotion Failureï¼‰ã€‚<br>å¦‚æœå‡ºç°äº† HandlePromotionFailure å¤±è´¥ï¼Œé‚£å°±åªå¥½åœ¨å¤±è´¥åé‡æ–°å‘èµ·ä¸€æ¬¡ Full GCã€‚</p>
<p>è™½ç„¶æ‹…ä¿å¤±è´¥æ—¶ç»•çš„åœˆå­æ˜¯æœ€å¤§çš„ï¼Œä½†<strong>å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½è¿˜æ˜¯ä¼šå°† HandlePromotionFailure å¼€å…³æ‰“å¼€ï¼Œé¿å… Full GC è¿‡äºé¢‘ç¹</strong>ã€‚</p>
<h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><h3 id="ä½ èƒ½ä¸èƒ½è°ˆè°ˆï¼ŒGC-æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œå¯¹ä»€ä¹ˆä¸œè¥¿ï¼Œåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ"><a href="#ä½ èƒ½ä¸èƒ½è°ˆè°ˆï¼ŒGC-æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œå¯¹ä»€ä¹ˆä¸œè¥¿ï¼Œåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ" class="headerlink" title="ä½ èƒ½ä¸èƒ½è°ˆè°ˆï¼ŒGC æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œå¯¹ä»€ä¹ˆä¸œè¥¿ï¼Œåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ"></a>ä½ èƒ½ä¸èƒ½è°ˆè°ˆï¼ŒGC æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œå¯¹ä»€ä¹ˆä¸œè¥¿ï¼Œåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ</h3><p>æ­¤é—®é¢˜æ‘˜è‡ªã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ä½œè€…çš„ä¸€ç¯‡åšæ–‡ï¼Œè¯¦è§ <a href="http://icyfenix.iteye.com/blog/715301" target="_blank" rel="noopener">ä¸€ä¸ªé¢è¯•å®˜å¯¹é¢è¯•é—®é¢˜çš„åˆ†æ</a></p>
<h3 id="javaçš„gcä¸ºä»€ä¹ˆè¦åˆ†ä»£ï¼Ÿ"><a href="#javaçš„gcä¸ºä»€ä¹ˆè¦åˆ†ä»£ï¼Ÿ" class="headerlink" title="javaçš„gcä¸ºä»€ä¹ˆè¦åˆ†ä»£ï¼Ÿ"></a>javaçš„gcä¸ºä»€ä¹ˆè¦åˆ†ä»£ï¼Ÿ</h3><p>ç­”æ¡ˆå¯å‚è€ƒ R å¤§çš„è¿™ä¸ª<a href="https://www.zhihu.com/question/53613423/answer/135743258" target="_blank" rel="noopener">å›ç­”</a></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ²¡æœ‰å›ºå®šæ”¶é›†å™¨ã€å‚æ•°ç»„åˆï¼Œä¹Ÿæ²¡æœ‰æœ€ä¼˜çš„è°ƒä¼˜æ–¹æ³•ï¼Œè™šæ‹Ÿæœºä¹Ÿå°±æ²¡æœ‰ä»€ä¹ˆå¿…ç„¶çš„å†…å­˜å›æ”¶è¡Œä¸ºã€‚</p>
<p>å­¦ä¹ è™šæ‹Ÿæœºå†…å­˜çŸ¥è¯†ï¼Œå¦‚æœè¦åˆ°å®è·µè°ƒä¼˜é˜¶æ®µï¼Œé‚£ä¹ˆå¿…é¡»äº†è§£æ¯ä¸ªå…·ä½“æ”¶é›†å™¨çš„è¡Œä¸ºã€ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€è°ƒèŠ‚å‚æ•°ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li>ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹</li>
</ul>
<p>æœ¬æ–‡å¤§éƒ¨åˆ†å†…å®¹éƒ½å‡ºè‡ªã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ ç¬¬ä¸‰ç« ï¼Œè‹¥æ–‡ä¸­æœ‰ä¸æ­£ç¡®çš„ç»“è®ºã€è¯´æ³•ï¼Œè¯·å¤§å®¶æŒ‡å‡ºï¼Œå…±åŒæ¢è®¨ï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢!</p>
]]></content>
      
        <categories>
            
            <category> jvm </category>
            
        </categories>
        
        
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JVM è¿è¡Œæ—¶æ•°æ®åŒºåŸŸä¸å¯¹è±¡åˆ›å»ºå¸ƒå±€]]></title>
      <url>https://timlin-pro.github.io/blog/2017/09/07/JVM-%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA%E5%9F%9F%E4%B8%8E%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E5%B8%83%E5%B1%80/</url>
      <content type="html"><![CDATA[<h2 id="java-è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ"><a href="#java-è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ" class="headerlink" title="java è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ"></a>java è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ</h2><p>æ ¹æ®ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹è§„å®šï¼ŒJava è™šæ‹Ÿæœºé”ç®¡ç†çš„å†…å­˜åŒ…å«ä»¥ä¸‹ä»¥ä¸‹å‡ ä¸ªè¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://user-images.githubusercontent.com/16668676/30062052-64dd918e-927c-11e7-9ec8-a82e507dc3ce.png" alt="java runtime memory"></p>
<a id="more"></a>
<h3 id="ç¨‹åºè®¡æ•°å™¨"><a href="#ç¨‹åºè®¡æ•°å™¨" class="headerlink" title="ç¨‹åºè®¡æ•°å™¨"></a>ç¨‹åºè®¡æ•°å™¨</h3><p>ç¨‹åºè®¡æ•°å™¨æ˜¯<strong>çº¿ç¨‹ç§æœ‰çš„</strong>ï¼Œå„çº¿ç¨‹ç‹¬ç«‹å­˜å‚¨ï¼Œä»¥ä¾¿çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ã€‚å¯ä»¥çœ‹ä½œæ˜¯<strong>å½“å‰çº¿ç¨‹</strong>æ‰€æ‰§è¡Œçš„<strong>å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨</strong>ã€‚</p>
<ul>
<li>å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ª Java æ–¹æ³•ï¼Œè¯¥è®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ã€‚</li>
<li>å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ª Native æ–¹æ³•ï¼Œåˆ™è¯¥è®¡æ•°å™¨å€¼ä¸ºç©ºã€‚</li>
</ul>
<p>==æ­¤å†…å­˜åŒºåŸŸæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨ Java è™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½• OOM æƒ…å†µçš„åŒºåŸŸ==</p>
<h3 id="Java-è™šæ‹Ÿæœºæ ˆ"><a href="#Java-è™šæ‹Ÿæœºæ ˆ" class="headerlink" title="Java è™šæ‹Ÿæœºæ ˆ"></a>Java è™šæ‹Ÿæœºæ ˆ</h3><p>Java è™šæ‹Ÿæœºæ ˆæ˜¯==çº¿ç¨‹ç§æœ‰çš„==ã€‚ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒã€‚</p>
<p>è™šæ‹Ÿæœºæ ˆæè¿°çš„æ˜¯ Java æ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ï¼šæ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ã€‚æ¯ä¸€ä¸ªæ–¹æ³•ä»è°ƒç”¨åˆ°æ‰§è¡Œéƒ½å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆå’Œå‡ºæ ˆçš„è¿‡ç¨‹ã€‚</p>
<p>æ³¨ï¼šæ ˆå¸§ï¼ˆStack Frame ï¼‰æ˜¯æ–¹æ³•è¿è¡Œæ—¶åŸºç¡€æ•°æ®ç»“æ„ï¼Œå…¶ä¸­å­˜å‚¨äº†å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚</p>
<p>å¹³æ—¶æ‰€è®²çš„æ ˆå†…å­˜ï¼Œå°±æ˜¯ç°åœ¨è®²çš„ Java è™šæ‹Ÿæœºæ ˆï¼Œæˆ–è€…è¯´æ˜¯<strong>è™šæ‹Ÿæœºæ ˆä¸­å±€éƒ¨å˜é‡è¡¨éƒ¨åˆ†</strong>ã€‚</p>
<ul>
<li>å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æ·±åº¦ï¼Œå°†æŠ›å‡º SOFï¼ˆStack Over Flowï¼‰ å¼‚å¸¸</li>
<li>å¦‚æœæ‰©å±•æ—¶ï¼Œæ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œå°±ä¼šæŠ› OOMError å¼‚å¸¸</li>
</ul>
<h3 id="æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="æœ¬åœ°æ–¹æ³•æ ˆ"></a>æœ¬åœ°æ–¹æ³•æ ˆ</h3><p>å‘æŒ¥çš„ä½œç”¨ä¸è™šæ‹Ÿæœºæ ˆç›¸ä¼¼ã€‚åªä¸è¿‡ä¸€ä¸ªæ˜¯é’ˆå¯¹ Java æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯é’ˆå¯¹æœ¬åœ°æ–¹æ³•ã€‚</p>
<h3 id="Java-å †"><a href="#Java-å †" class="headerlink" title="Java å †"></a>Java å †</h3><p>å¯¹äºå¤§å¤šæ•°åº”ç”¨è€Œè¨€ï¼ŒJava å †æ˜¯ Java è™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ã€‚åŒæ—¶å®ƒä¹Ÿæ˜¯==æ‰€æœ‰çº¿ç¨‹å…±äº«==çš„ä¸€å—å†…å­˜åŒºåŸŸã€‚Java è™šæ‹Ÿæœºè§„å®šï¼ŒJava å †<strong>å¯ä»¥æ˜¯ç‰©ç†ä¸Šä¸è¿ç»­çš„</strong>å†…å­˜ç©ºé—´ï¼Œåªè¦é€»è¾‘ä¸Šè¿ç»­å³å¯ã€‚</p>
<p>æŒ‰ç…§è™šæ‹Ÿæœºè§„èŒƒä¸­çš„æè¿°ï¼Œ<strong>æ‰€æœ‰å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½è¦åœ¨å †ä¸Šåˆ†é…</strong>ã€‚ä¸è¿‡éšç€ JIT ç¼–è¯‘å™¨çš„å‘å±•å’Œé€ƒé€¸åˆ†ææŠ€æœ¯çš„é€æ¸æˆç†Ÿï¼Œæœªæ¥æˆ–è®¸ä¼šæœ‰æ‰€æ”¹å˜ã€‚</p>
<p>ä»å†…å­˜åˆ†é…è§’åº¦æ¥çœ‹ï¼Œçº¿ç¨‹å…±äº«çš„ Java å †ä¸­å¯èƒ½ä¼šåˆ’åˆ†å‡ºå¤šä¸ª<strong>çº¿ç¨‹ç§æœ‰çš„åˆ†é…ç¼“å†²åŒº</strong>ï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰ã€‚<strong>ä¸ç®¡æ€ä¹ˆåˆ’åˆ†ï¼Œå…¶ä¸­å­˜å‚¨çš„éƒ½æ˜¯å¯¹è±¡</strong>ï¼Œè¿›è¡Œåˆ’åˆ†çš„ç›®çš„åªæ˜¯ä¸ºäº†æ›´å¥½åœ°å›æ”¶/åˆ†é…å†…å­˜ã€‚</p>
<h3 id="æ–¹æ³•åŒº"><a href="#æ–¹æ³•åŒº" class="headerlink" title="æ–¹æ³•åŒº"></a>æ–¹æ³•åŒº</h3><p>æ–¹æ³•åŒºæœ‰ä¸€ä¸ªåˆ«åï¼šnon-heapï¼Œä¸ Java å †åŒºåˆ†å¼€æ¥ã€‚å®ƒæ˜¯==æ‰€æœ‰çº¿ç¨‹å…±äº«==çš„ï¼Œç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å¸¸é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚</p>
<p>Hotspot è™šæ‹Ÿæœºè®¾è®¡å›¢é˜Ÿé€‰æ‹©æŠŠ GC åˆ†ä»£æ”¶é›†æ‰©å±•åˆ°æ–¹æ³•åŒºï¼Œæˆ–è€…è¯´ä½¿ç”¨æ°¸ä¹…ä»£æ¥å®ç°æ–¹æ³•åŒºã€‚å› ä¸ºè¿™æ ·å°±ä¸ç”¨ä¸“é—¨ä¸ºæ–¹æ³•åŒºç¼–å†™å†…å­˜ç®¡ç†çš„ä»£ç çš„å·¥ä½œã€‚å¯¹äºå…¶ä»–è™šæ‹Ÿæœºè€Œè¨€æ˜¯ä¸å­˜åœ¨æ°¸ä¹…ä»£è¿™ä¸ªæ¦‚å¿µçš„ã€‚</p>
<p>ä½¿ç”¨æ°¸ä¹…ä»£æ¥å®ç°æ–¹æ³•åŒºçš„<strong>å¥½å¤„</strong>åœ¨äºå¯ä»¥ç›´æ¥åƒç®¡ç† Java å †é‚£æ ·ç®¡ç†è¿™éƒ¨åˆ†å†…å­˜ï¼Œè€Œä¸éœ€è¦å†ä¸“é—¨ä¸ºæ–¹æ³•åŒºç¼–å†™å†…å­˜ç®¡ç†ä»£ç ã€‚<strong>åå¤„</strong>åœ¨äºè¿™æ ·<strong>æ›´å®¹æ˜“å¯¼è‡´ OOM</strong>ï¼Œå› ä¸ºæ°¸ä¹…ä»£æœ‰ <code>-XXï¼šMaxPermSize</code> çš„ä¸Šé™ã€‚åœ¨ JDK 1.8  HotSpot è™šæ‹Ÿæœºçš„å®ç°ä¸­å·²ç»å°†æ•´ä¸ªæ°¸ä¹…ä»£ç§»é™¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä¸ªå«å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰çš„åŒºåŸŸã€‚</p>
<p>å½“æ–¹æ³•åŒºæ— æ³•æ»¡è¶³å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œå°†æŠ›å‡º <code>java.lang.OutOfMemoryError: PermGen space</code> ã€‚</p>
<h3 id="è¿è¡Œæ—¶å¸¸é‡æ± "><a href="#è¿è¡Œæ—¶å¸¸é‡æ± " class="headerlink" title="è¿è¡Œæ—¶å¸¸é‡æ± "></a>è¿è¡Œæ—¶å¸¸é‡æ± </h3><p>Class æ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ˜¯<strong>å¸¸é‡æ± </strong>ï¼Œç”¨äºå­˜æ”¾<strong>ç¼–è¯‘æœŸç”Ÿæˆçš„</strong>å„ç§<strong>å­—é¢é‡å’Œç¬¦å·å¼•ç”¨</strong>ã€‚JDK 1.8 å‰è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>è™šæ‹Ÿæœºè§„èŒƒä¸­å¯¹ Class æ–‡ä»¶ä¸­çš„æ¯ä¸€ä¸ªéƒ¨åˆ†çš„<strong>æ ¼å¼</strong>éƒ½æœ‰ä¸¥æ ¼è§„å®šã€‚ä½†æ˜¯<strong>å¯¹äºè¿è¡Œæ—¶å¸¸é‡æ± ï¼Œå¹¶æ²¡æœ‰åšä»»ä½•ç»†èŠ‚çš„è¦æ±‚</strong>ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œé™¤äº†ä¿å­˜ Class æ–‡ä»¶ä¸­æè¿°çš„ç¬¦å·å¼•ç”¨å¤–ï¼Œè¿˜ä¼šæŠŠç¿»è¯‘å‡ºæ¥çš„ç›´æ¥å¼•ç”¨ä¹Ÿå­˜å‚¨åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚</p>
<p>è¿è¡Œæ—¶å¸¸é‡æ± ç›¸å¯¹äº Class æ–‡ä»¶å¸¸é‡æ± çš„çš„å¦ä¸€ç‰¹å¾åœ¨äº<strong>å…·å¤‡åŠ¨æ€æ€§</strong>ã€‚java <strong>è¿è¡ŒæœŸé—´ä¹Ÿå¯ä»¥æŠŠæ–°çš„å¸¸é‡æ”¾å…¥æ± ä¸­</strong>ã€‚æ¯”å¦‚ä½¿ç”¨ String.intern() å°†å †ä¸­çš„å­—ç¬¦ä¸²åŠ å…¥å¸¸é‡æ± ä¸­ã€‚</p>
<p>JDK1.7 ä¸­æŠŠåŸæœ¬æ”¾åœ¨æ°¸ä¹…ä»£çš„å­—ç¬¦ä¸²å¸¸é‡æ± ç§»åˆ° Java å †ä¸­ã€‚<strong>å¸¸é‡æ± ä½ç½®çš„ä¸åŒå½±å“åˆ°äº† String çš„ intern()æ–¹æ³•çš„è¡¨ç°</strong>ã€‚ä¸åŒç‰ˆæœ¬çš„ JDK  ä½¿ç”¨ã€Œ==ã€å»æ¯”è¾ƒ String å­—ç¬¦ä¸²çš„ç»“æœä¼šæœ‰ä¸åŒã€‚å…·ä½“æƒ…å†µå¯å‚è€ƒè¿™ç¯‡æ–‡ç« â€”â€”<a href="http://blog.csdn.net/seu_calvin/article/details/52291082" target="_blank" rel="noopener">Java æŠ€æœ¯â€”â€”ä½ çœŸçš„äº†è§£ String ç±»çš„ intern()æ–¹æ³•å—</a></p>
<h3 id="Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰"><a href="#Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰" class="headerlink" title="Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰"></a>Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰</h3><p>ä»‹ç»å…ƒç©ºé—´ä¹‹å‰å…ˆè¯´ç‚¹é¢˜å¤–è¯ã€‚å…¶å®ï¼Œç§»é™¤æ°¸ä¹…ä»£çš„å·¥ä½œä» JDK1.7 å°±å¼€å§‹äº†ã€‚JDK1.7 ä¸­ï¼Œå­˜å‚¨åœ¨æ°¸ä¹…ä»£çš„éƒ¨åˆ†æ•°æ®å°±å·²ç»è½¬ç§»åˆ°äº† Java Heap æˆ–è€…æ˜¯ Native Heapã€‚è­¬å¦‚ç¬¦å·å¼•ç”¨(Symbols)è½¬ç§»åˆ°äº† native heapã€å­—é¢é‡(interned strings)è½¬ç§»åˆ°äº† java heapã€ç±»çš„é™æ€å˜é‡(class statics)è½¬ç§»åˆ°äº† java heapã€‚ä½† JDK1.7 å¹¶æ²¡æœ‰å®Œå…¨ç§»é™¤å°†æ°¸ä¹…ä»£å®Œå…¨ç§»é™¤ã€‚ç›´åˆ° JDK1.8 æ‰å°†æ°¸ä¹…ä»£å®Œæ•´åœ°ç§»é™¤ã€‚</p>
<p>å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œ<strong>éƒ½æ˜¯å¯¹ JVM è§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°</strong>ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯<strong>ä½¿ç”¨æœ¬åœ°å†…å­˜</strong>ã€‚å› æ­¤ï¼Œ<strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶</strong>ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹å‚æ•°æ¥æŒ‡å®šå…ƒç©ºé—´çš„å¤§å°ï¼š</p>
<ul>
<li><code>-XX:MetaspaceSize</code>ï¼Œ<strong>åˆå§‹ç©ºé—´å¤§å°</strong>ï¼Œ<strong>è¾¾åˆ°è¯¥å€¼å°±ä¼šè§¦å‘åƒåœ¾æ”¶é›†è¿›è¡Œç±»å‹å¸è½½</strong>ï¼ŒåŒæ—¶ <strong>GC ä¼šå¯¹è¯¥å€¼è¿›è¡Œè°ƒæ•´</strong>ï¼šå¦‚æœé‡Šæ”¾äº†å¤§é‡çš„ç©ºé—´ï¼Œå°±é€‚å½“é™ä½è¯¥å€¼ï¼›å¦‚æœé‡Šæ”¾äº†å¾ˆå°‘çš„ç©ºé—´ï¼Œé‚£ä¹ˆåœ¨ä¸è¶…è¿‡ MaxMetaspaceSize æ—¶ï¼Œé€‚å½“æé«˜è¯¥å€¼ã€‚</li>
<li><code>-XX:MaxMetaspaceSize</code>ï¼Œ<strong>æœ€å¤§ç©ºé—´</strong>ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰é™åˆ¶çš„ã€‚</li>
</ul>
<p>å¦‚æœæœ¬åœ°ç©ºé—´çš„å†…å­˜ç”¨å°½äº†ä¼šæ”¶åˆ°<code>java.lang.OutOfMemoryError: Metadata space</code> çš„é”™è¯¯ä¿¡æ¯ã€‚<br>JDK1.8 ä¸­æŒä¹…ä»£ç›¸å…³çš„ JVM å‚æ•° <code>-XX:PermSize</code> åŠ <code>-XX:MaxPermSize</code> å°†ä¼šè¢«å¿½ç•¥æ‰ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆç§»é™¤æŒä¹…ä»£ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆç§»é™¤æŒä¹…ä»£ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆç§»é™¤æŒä¹…ä»£ï¼Ÿ"></a>ä¸ºä»€ä¹ˆç§»é™¤æŒä¹…ä»£ï¼Ÿ</h4><ul>
<li>å®ƒçš„å¤§å°åªèƒ½åœ¨å¯åŠ¨æ—¶æŒ‡å®šï¼Œè¿è¡Œæ—¶æ— æ³•ä¿®æ”¹â€”â€”å¾ˆéš¾è¿›è¡Œè°ƒä¼˜ã€‚-XX:MaxPermSizeï¼Œè®¾ç½®æˆå¤šå°‘å¥½å‘¢ï¼Ÿ</li>
<li>HotSpot çš„å†…éƒ¨ç±»å‹ä¹Ÿæ˜¯ Java å¯¹è±¡ï¼šå®ƒå¯èƒ½ä¼šåœ¨ Full GC ä¸­è¢«ç§»åŠ¨ï¼ŒåŒæ—¶å®ƒå¯¹åº”ç”¨ä¸é€æ˜ï¼Œä¸”æ˜¯éå¼ºç±»å‹çš„ï¼Œéš¾ä»¥è·Ÿè¸ªè°ƒè¯•ï¼Œè¿˜éœ€è¦å­˜å‚¨å…ƒæ•°æ®çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ˆmeta-metadataï¼‰ã€‚</li>
<li>ç®€åŒ– Full GCï¼šæ¯ä¸€ä¸ªå›æ”¶å™¨æœ‰ä¸“é—¨çš„å…ƒæ•°æ®è¿­ä»£å™¨ã€‚</li>
<li>å¯ä»¥åœ¨ GC ä¸è¿›è¡Œæš‚åœçš„æƒ…å†µä¸‹å¹¶å‘åœ°é‡Šæ”¾ç±»æ•°æ®ã€‚</li>
<li>ä½¿å¾—åŸæ¥å—é™äºæŒä¹…ä»£çš„ä¸€äº›æ”¹è¿›æœªæ¥æœ‰å¯èƒ½å®ç°</li>
</ul>
<h4 id="å…ƒç©ºé—´çš„å†…å­˜åˆ†é…æ¨¡å‹"><a href="#å…ƒç©ºé—´çš„å†…å­˜åˆ†é…æ¨¡å‹" class="headerlink" title="å…ƒç©ºé—´çš„å†…å­˜åˆ†é…æ¨¡å‹"></a>å…ƒç©ºé—´çš„å†…å­˜åˆ†é…æ¨¡å‹</h4><ul>
<li>ç»å¤§å¤šæ•°çš„ç±»å…ƒæ•°æ®çš„ç©ºé—´éƒ½ä»æœ¬åœ°å†…å­˜ä¸­åˆ†é…</li>
<li>ç”¨æ¥æè¿°ç±»å…ƒæ•°æ®çš„ç±»ï¼ˆklasses)ä¹Ÿè¢«åˆ é™¤äº†</li>
<li>åˆ†å…ƒæ•°æ®åˆ†é…äº†å¤šä¸ªè™šæ‹Ÿå†…å­˜ç©ºé—´</li>
<li>ç»™æ¯ä¸ªç±»åŠ è½½å™¨åˆ†é…ä¸€ä¸ªå†…å­˜å—çš„åˆ—è¡¨ã€‚å—çš„å¤§å°å–å†³äºç±»åŠ è½½å™¨çš„ç±»å‹; sun/åå°„/ä»£ç†å¯¹åº”çš„ç±»åŠ è½½å™¨çš„å—ä¼šå°ä¸€äº›</li>
<li>å½’è¿˜å†…å­˜å—ï¼Œé‡Šæ”¾å†…å­˜å—åˆ—è¡¨</li>
<li>ä¸€æ—¦å…ƒç©ºé—´çš„æ•°æ®è¢«æ¸…ç©ºäº†ï¼Œè™šæ‹Ÿå†…å­˜çš„ç©ºé—´ä¼šè¢«å›æ”¶æ‰</li>
<li>å‡å°‘ç¢ç‰‡çš„ç­–ç•¥</li>
</ul>
<h3 id="ç›´æ¥å†…å­˜"><a href="#ç›´æ¥å†…å­˜" class="headerlink" title="ç›´æ¥å†…å­˜"></a>ç›´æ¥å†…å­˜</h3><p>ç›´æ¥å†…å­˜å¹¶<strong>ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†</strong>ï¼Œä¹Ÿä¸æ˜¯è™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚</p>
<p>JDK 1.4 æ–°æ·»åŠ çš„ NIOï¼ˆNew Input/Outputï¼‰ å¯ä»¥ä½¿ç”¨ Native å‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨ Java å †ä¸­çš„ DireByteBuffer å¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚è¿™æ ·é¿å…äº†åœ¨ Java å †å’Œ Native å †ä¸­æ¥å›å¤åˆ¶æ•°æ®ï¼Œå› æ­¤åœ¨ä¸€äº›åœºåˆèƒ½å¤Ÿæ˜¾è‘—æé«˜æ€§èƒ½ã€‚</p>
<p>æœ¬æœºç›´æ¥å†…å­˜<strong>ä¸å— Java å †å¤§å°çš„é™åˆ¶</strong>ï¼Œä½†æ˜¯å—åˆ°æœ¬æœºæ€»å†…å­˜çš„å¤§å°ä»¥åŠå¤„ç†å™¨å¯»å€ç©ºé—´çš„é™åˆ¶ã€‚</p>
<h2 id="HotSpot-è™šæ‹Ÿæœºä¸­å¯¹è±¡åˆ›å»ºã€åˆå§‹åŒ–ä¸å¸ƒå±€"><a href="#HotSpot-è™šæ‹Ÿæœºä¸­å¯¹è±¡åˆ›å»ºã€åˆå§‹åŒ–ä¸å¸ƒå±€" class="headerlink" title="HotSpot è™šæ‹Ÿæœºä¸­å¯¹è±¡åˆ›å»ºã€åˆå§‹åŒ–ä¸å¸ƒå±€"></a>HotSpot è™šæ‹Ÿæœºä¸­å¯¹è±¡åˆ›å»ºã€åˆå§‹åŒ–ä¸å¸ƒå±€</h2><h3 id="å¯¹è±¡çš„åˆ›å»º"><a href="#å¯¹è±¡çš„åˆ›å»º" class="headerlink" title="å¯¹è±¡çš„åˆ›å»º"></a>å¯¹è±¡çš„åˆ›å»º</h3><h4 id="ç±»åŠ è½½æ£€æŸ¥ã€åˆ¤æ–­"><a href="#ç±»åŠ è½½æ£€æŸ¥ã€åˆ¤æ–­" class="headerlink" title="ç±»åŠ è½½æ£€æŸ¥ã€åˆ¤æ–­"></a>ç±»åŠ è½½æ£€æŸ¥ã€åˆ¤æ–­</h4><p>é‡åˆ°ä¸€æ¡ new æŒ‡ä»¤ï¼Œé¦–å…ˆæ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°æ˜¯å¦èƒ½åœ¨å¸¸é‡æ± ä¸­å®šä½åˆ°ä¸€ä¸ªç±»çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»æ˜¯å¦å·²è¢«åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£å¿…é¡»å…ˆæ‰§è¡Œç›¸åº”çš„ç±»åŠ è½½ã€‚</p>
<h4 id="åˆ†é…å†…å­˜"><a href="#åˆ†é…å†…å­˜" class="headerlink" title="åˆ†é…å†…å­˜"></a>åˆ†é…å†…å­˜</h4><p>ç±»åŠ è½½æ£€æŸ¥é€šè¿‡åï¼Œå°†<strong>ä¸ºæ–°ç”Ÿå¯¹è±¡åˆ†é…å†…å­˜</strong>ã€‚ä¹Ÿå°±æ˜¯åˆ’åˆ†å‡ºä¸€å—å†…å­˜åŒºåŸŸã€‚</p>
<ul>
<li>å¦‚æœ java å †ä¸­çš„å†…å­˜æ˜¯ç»å¯¹è§„æ•´çš„ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨<strong>æŒ‡é’ˆç¢°æ’</strong>çš„åˆ†é…æ–¹å¼</li>
<li>å¦‚æœ java å †ä¸­çš„å†…å­˜ä¸è§„æ•´çš„ï¼Œè™šæ‹Ÿæœºå¿…é¡»ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨ï¼Œè®°å½•å“ªäº›å†…å­˜å—å¯ç”¨ï¼Œåœ¨åˆ†é…æ—¶ä»åˆ—è¡¨ä¸­ï¼Œæ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´åˆ’åˆ†ç»™å¯¹è±¡ã€‚å³ï¼Œä½¿ç”¨<strong>ç©ºé—²åˆ—è¡¨</strong>çš„åˆ†é…æ–¹å¼ã€‚</li>
</ul>
<p>é€‰æ‹©å“ªç§åˆ†é…æ–¹å¼ç”± java å †æ˜¯å¦è§„æ•´å†³å®šï¼Œè€Œ <strong>Java å †æ˜¯å¦è§„æ•´</strong>åˆç”±æ‰€é‡‡ç”¨çš„<strong>åƒåœ¾æ”¶é›†å™¨</strong>æ˜¯å¦å¸¦æœ‰<strong>å‹ç¼©æ•´ç†åŠŸèƒ½</strong>å†³å®šã€‚</p>
<ul>
<li>åœ¨ä½¿ç”¨ Serialã€ParNew ç­‰<strong>å¸¦ Compact è¿‡ç¨‹</strong>çš„æ”¶é›†å™¨æ—¶ï¼Œç³»ç»Ÿé‡‡ç”¨çš„åˆ†é…ç®—æ³•æ˜¯<strong>æŒ‡é’ˆç¢°æ’</strong></li>
<li>è€Œä½¿ç”¨ CMS è¿™ç§<strong>åŸºäº Mark-Sweep ç®—æ³•</strong>çš„æ”¶é›†å™¨æ—¶ï¼Œé€šå¸¸é‡‡ç”¨<strong>ç©ºé—²åˆ—è¡¨</strong>ã€‚</li>
</ul>
<p><strong>çº¿ç¨‹å®‰å…¨é—®é¢˜</strong>ï¼š<br>å¦å¤–ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„é—®é¢˜æ˜¯å¯¹è±¡åˆ›å»ºåœ¨è™šæ‹Ÿæœºä¸­æ˜¯éå¸¸é¢‘ç¹çš„è¡Œä¸ºï¼Œå³ä½¿æ˜¯ä»…ä»…ä¿®æ”¹ä¸€ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„ä½ç½®ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ä¹Ÿå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯èƒ½å‡ºç°æ­£åœ¨ç»™å¯¹è±¡ A åˆ†é…å†…å­˜ï¼ŒæŒ‡é’ˆè¿˜æ²¡æ¥å¾—åŠä¿®æ”¹ï¼Œå¯¹è±¡ B åˆåŒæ—¶ä½¿ç”¨äº†åŸæ¥çš„æŒ‡é’ˆæ¥åˆ†é…å†…å­˜çš„æƒ…å†µã€‚è§£å†³è¿™ä¸ªé—®é¢˜æœ‰<strong>ä¸¤ç§æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>ä¸€ç§æ˜¯<strong>å¯¹åˆ†é…å†…å­˜ç©ºé—´çš„åŠ¨ä½œè¿›è¡ŒåŒæ­¥å¤„ç†</strong>â€”â€”å®é™…ä¸Šè™šæ‹Ÿæœºé‡‡ç”¨ <strong>CAS é…ä¸Šå¤±è´¥é‡è¯•çš„æ–¹å¼</strong>ä¿è¯æ›´æ–°æ“ä½œçš„åŸå­æ€§ï¼›</li>
<li>å¦ä¸€ç§æ˜¯æŠŠå†…å­˜åˆ†é…çš„åŠ¨ä½œæŒ‰ç…§çº¿ç¨‹åˆ’åˆ†åœ¨ä¸åŒçš„ç©ºé—´ä¹‹ä¸­è¿›è¡Œï¼Œå³<strong>æ¯ä¸ªçº¿ç¨‹åœ¨ Java å †ä¸­é¢„å…ˆåˆ†é…ä¸€å°å—å†…å­˜</strong>ï¼Œç§°ä¸º<strong>æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²</strong>ï¼ˆThread Local Allocation Buffer,TLABï¼‰ã€‚<ul>
<li>å“ªä¸ªçº¿ç¨‹è¦åˆ†é…å†…å­˜ï¼Œå°±åœ¨å“ªä¸ªçº¿ç¨‹çš„ TLAB ä¸Šåˆ†é…ï¼Œ<strong>åªæœ‰ TLAB ç”¨å®Œå¹¶åˆ†é…æ–°çš„ TLAB æ—¶ï¼Œæ‰éœ€è¦åŒæ­¥é”å®š</strong>ã€‚<ul>
<li>è™šæ‹Ÿæœºæ˜¯å¦ä½¿ç”¨ TLABï¼Œå¯ä»¥é€šè¿‡<code>-XXï¼š+/-UseTLAB</code> å‚æ•°æ¥è®¾å®šã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="å¯¹è±¡çš„åˆå§‹åŒ–"><a href="#å¯¹è±¡çš„åˆå§‹åŒ–" class="headerlink" title="å¯¹è±¡çš„åˆå§‹åŒ–"></a>å¯¹è±¡çš„åˆå§‹åŒ–</h3><p>æ­¤å¤„çš„åˆå§‹åŒ–æŒ‡çš„æ˜¯å°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´åˆå§‹åŒ–ä¸º<strong>é›¶å€¼</strong>ã€‚ï¼ˆä¸åŒ…æ‹¬å¯¹è±¡å¤´ï¼‰ã€‚å¦‚æœä½¿ç”¨ TLABï¼Œè¯¥è¿‡ç¨‹ä¹Ÿå¯ä»¥æå‰è‡³ TLAB åˆ†é…æ—¶è¿›è¡Œã€‚åˆå§‹åŒ–ä¸ºé›¶å€¼çš„æ“ä½œä¿è¯äº†å¯¹è±¡çš„<strong>å®ä¾‹å­—æ®µ</strong>åœ¨ Java ä»£ç ä¸­å¯ä¸èµ‹åˆå€¼å°±ä½¿ç”¨ã€‚</p>
<p>å¯¹è±¡å¤´çš„è®¾ç½®ï¼š</p>
<ul>
<li>å¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹</li>
<li>å¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯</li>
<li>å¯¹è±¡çš„å“ˆå¸Œç </li>
<li>å¯¹è±¡çš„ GC åˆ†ä»£å¹´é¾„ç­‰ä¿¡æ¯ã€‚</li>
<li>â€¦</li>
</ul>
<p>ä»è™šæ‹Ÿæœºçš„è§†è§’æ¥çœ‹ï¼Œä¸€ä¸ªæ–°çš„å¯¹è±¡å·²ç»åˆ›å»ºå®Œæ¯•ã€‚  </p>
<ul>
<li>ä½†ä» Java ç¨‹åºè§†è§’æ¥çœ‹ï¼Œå¯¹è±¡çš„åˆ›å»ºæ‰åˆšåˆšå¼€å§‹â€”â€”<init> æ–¹æ³•è¿˜æ²¡æœ‰æ‰§è¡Œã€æ‰€æœ‰å­—æ®µéƒ½è¿˜ä¸ºé›¶.<ul>
<li>ä¸€èˆ¬æ¥è¯´ï¼ˆç”±å­—èŠ‚ç ä¸­æ˜¯å¦è·Ÿéš invokespecial æŒ‡ä»¤æ‰€å†³å®šï¼‰ï¼Œæ‰§è¡Œ <strong>new æŒ‡ä»¤</strong>ä¹‹åä¼šæ¥ç€æ‰§è¡Œ <strong><init> æ–¹æ³•</init></strong>ï¼ŒæŠŠå¯¹è±¡æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·ä¸€ä¸ªçœŸæ­£å¯ç”¨çš„å¯¹è±¡æ‰ç®—å®Œå…¨äº§ç”Ÿå‡ºæ¥ã€‚</li>
</ul>
</init></li>
</ul>
<h3 id="å¯¹è±¡çš„å†…å­˜å¸ƒå±€"><a href="#å¯¹è±¡çš„å†…å­˜å¸ƒå±€" class="headerlink" title="å¯¹è±¡çš„å†…å­˜å¸ƒå±€"></a>å¯¹è±¡çš„å†…å­˜å¸ƒå±€</h3><p>HotSpot ä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„å¸ƒå±€å¯ä»¥<strong>åˆ†ä¸º 3 å—åŒºåŸŸ</strong>ï¼š</p>
<ul>
<li>å¯¹è±¡å¤´ Header</li>
<li>å®ä¾‹æ•°æ® Instance Data</li>
<li>å¯¹é½å¡«å…… Padding (å¹¶ä¸æ˜¯å¿…ç„¶å­˜åœ¨)</li>
</ul>
<h4 id="1-å¯¹è±¡å¤´"><a href="#1-å¯¹è±¡å¤´" class="headerlink" title="1. å¯¹è±¡å¤´"></a>1. å¯¹è±¡å¤´</h4><p><strong>å¯¹è±¡å¤´åŒ…æ‹¬ä¸¤éƒ¨åˆ†ä¿¡æ¯</strong>ï¼šç¬¬ä¸€éƒ¨åˆ†ä¸ºå­˜å‚¨å¯¹è±¡è‡ªèº«å¾—è¿è¡Œæ—¶æ•°æ®ï¼Œç¬¬äºŒéƒ¨åˆ†ä¸ºç±»å‹æŒ‡é’ˆã€‚</p>
<ol>
<li><strong>å­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®</strong>ã€‚å¦‚ï¼š<ul>
<li>å“ˆå¸Œç ï¼ˆHashCodeï¼‰</li>
<li>GC åˆ†ä»£å¹´é¾„ã€</li>
<li>é”çŠ¶æ€æ ‡å¿—ã€</li>
<li>çº¿ç¨‹æŒæœ‰çš„é”ã€</li>
<li>åå‘çº¿ç¨‹ IDã€</li>
<li>åå‘æ—¶é—´æˆ³ç­‰ï¼Œè¿™éƒ¨åˆ†æ•°æ®çš„é•¿åº¦åœ¨ 32 ä½å’Œ 64 ä½çš„è™šæ‹Ÿæœºï¼ˆæœªå¼€å¯å‹ç¼©æŒ‡é’ˆï¼‰ä¸­åˆ†åˆ«ä¸º 32bit å’Œ 64bitï¼Œå®˜æ–¹ç§°å®ƒä¸ºã€Œ<strong>Mark Word</strong>ã€ã€‚</li>
<li>å¯¹è±¡å¤´ä¿¡æ¯æ˜¯<strong>ä¸å¯¹è±¡è‡ªèº«å®šä¹‰çš„æ•°æ®æ— å…³çš„é¢å¤–å­˜å‚¨æˆæœ¬</strong>ï¼Œè€ƒè™‘åˆ°è™šæ‹Ÿæœºçš„ç©ºé—´æ•ˆç‡ï¼ŒMark Word è¢«è®¾è®¡æˆä¸€ä¸ª<strong>éå›ºå®šçš„æ•°æ®ç»“æ„ä»¥ä¾¿åœ¨æå°çš„ç©ºé—´å†…å­˜å‚¨å°½é‡å¤šçš„ä¿¡æ¯</strong>ï¼Œå®ƒä¼šæ ¹æ®å¯¹è±¡çš„çŠ¶æ€å¤ç”¨è‡ªå·±çš„å­˜å‚¨ç©ºé—´ã€‚</li>
</ul>
</li>
<li><strong>ç±»å‹æŒ‡é’ˆ</strong>ï¼Œå³å¯¹è±¡æŒ‡å‘å®ƒçš„<strong>ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆ</strong>ï¼Œè™šæ‹Ÿæœºé€šè¿‡è¯¥æŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚<ul>
<li>å¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‚£ä¹ˆå¯¹è±¡å¤´ä¸­è¿˜éœ€è¦æœ‰ä¸€å—ç”¨äºè®°å½•æ•°æ®é•¿åº¦çš„æ•°æ®<ul>
<li>å› ä¸ºä»æ•°æ®çš„å…ƒæ•°æ®æ— æ³•ç¡®å®šæ•°ç»„çš„å¤§å°</li>
</ul>
</li>
<li>æ³¨æ„ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰çš„è™šæ‹Ÿæœºå®ç°éƒ½å¿…é¡»åœ¨å¯¹è±¡æ•°æ®ä¸Šä¿ç•™ç±»å‹æŒ‡é’ˆï¼Œæ¢å¥è¯è¯´ï¼Œ<strong>æŸ¥æ‰¾å¯¹è±¡çš„å…ƒæ•°æ®ä¿¡æ¯å¹¶ä¸ä¸€å®šè¦ç»è¿‡å¯¹è±¡æœ¬èº«</strong><ul>
<li>æ¯”å¦‚ï¼šé€šè¿‡å¥æŸ„è®¿é—®å¯¹è±¡</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="2-å®ä¾‹æ•°æ®"><a href="#2-å®ä¾‹æ•°æ®" class="headerlink" title="2. å®ä¾‹æ•°æ®"></a>2. å®ä¾‹æ•°æ®</h4><p>æ¥ä¸‹æ¥çš„<strong>å®ä¾‹æ•°æ®éƒ¨åˆ†</strong>æ˜¯å¯¹è±¡çœŸæ­£å­˜å‚¨çš„æœ‰æ•ˆä¿¡æ¯ï¼Œä¹Ÿæ˜¯åœ¨ç¨‹åºä»£ç ä¸­æ‰€å®šä¹‰çš„å„ç§ç±»å‹çš„å­—æ®µå†…å®¹ã€‚</p>
<ul>
<li>æ— è®ºæ˜¯ä»çˆ¶ç±»ç»§æ‰¿ä¸‹æ¥çš„ï¼Œè¿˜æ˜¯åœ¨å­ç±»ä¸­å®šä¹‰çš„ï¼Œéƒ½éœ€è¦è®°å½•èµ·æ¥ã€‚</li>
<li>è¿™éƒ¨åˆ†çš„<strong>å­˜å‚¨é¡ºåº</strong>ä¼š<strong>å—åˆ°è™šæ‹Ÿæœºåˆ†é…ç­–ç•¥å‚æ•°</strong>ï¼ˆFieldsAllocationStyleï¼‰å’Œ<strong>å­—æ®µåœ¨ Java æºç ä¸­å®šä¹‰é¡ºåºçš„å½±å“</strong>ã€‚<ul>
<li>HotSpot è™šæ‹Ÿæœºé»˜è®¤çš„åˆ†é…ç­–ç•¥ä¸º longs/doublesã€intsã€shorts/charsã€bytes/booleansã€oopsï¼ˆOrdinary Object Pointersï¼‰ï¼Œ<ul>
<li>å¯ä»¥çœ‹å‡ºï¼Œ<strong>ç›¸åŒå®½åº¦çš„å­—æ®µæ€»æ˜¯è¢«åˆ†é…åˆ°ä¸€èµ·</strong>ã€‚</li>
<li>åœ¨æ»¡è¶³è¿™ä¸ªå‰ææ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œåœ¨çˆ¶ç±»ä¸­å®šä¹‰çš„å˜é‡ä¼šå‡ºç°åœ¨å­ç±»ä¹‹å‰ã€‚</li>
<li>å¦‚æœ CompactFields å‚æ•°å€¼ä¸º trueï¼ˆé»˜è®¤ä¸º trueï¼‰ï¼Œé‚£ä¹ˆå­ç±»ä¹‹ä¸­è¾ƒçª„çš„å˜é‡ä¹Ÿå¯èƒ½ä¼šæ’å…¥åˆ°çˆ¶ç±»å˜é‡çš„ç©ºéš™ä¹‹ä¸­ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="3-å¯¹é½å¡«å……"><a href="#3-å¯¹é½å¡«å……" class="headerlink" title="3. å¯¹é½å¡«å……"></a>3. å¯¹é½å¡«å……</h4><p><strong>å¯¹é½å¡«å……</strong>å¹¶ä¸æ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œä¹Ÿæ²¡æœ‰ç‰¹åˆ«çš„å«ä¹‰ï¼Œå®ƒä»…ä»…<strong>èµ·ç€å ä½ç¬¦çš„ä½œç”¨</strong>ã€‚</p>
<p>ç”±äº HotSpot VM çš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿ<strong>è¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯ 8 å­—èŠ‚çš„æ•´æ•°å€</strong>ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯<strong>å¯¹è±¡çš„å¤§å°å¿…é¡»æ˜¯ 8 å­—èŠ‚çš„æ•´æ•°å€</strong>ã€‚</p>
<h3 id="å¯¹è±¡çš„è®¿é—®å®šä½"><a href="#å¯¹è±¡çš„è®¿é—®å®šä½" class="headerlink" title="å¯¹è±¡çš„è®¿é—®å®šä½"></a>å¯¹è±¡çš„è®¿é—®å®šä½</h3><p>ç”±äº reference ç±»å‹åœ¨ Java è™šæ‹Ÿæœºè§„èŒƒä¸­<strong>åªè§„å®šäº†ä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„å¼•ç”¨</strong>ï¼Œå¹¶<strong>æ²¡æœ‰å®šä¹‰è¿™ä¸ªå¼•ç”¨åº”è¯¥é€šè¿‡ä½•ç§æ–¹å¼å»å®šä½</strong>ã€è®¿é—®å †ä¸­çš„å¯¹è±¡çš„å…·ä½“ä½ç½®ï¼Œæ‰€ä»¥<strong>å¯¹è±¡è®¿é—®æ–¹å¼ä¹Ÿæ˜¯å–å†³äºè™šæ‹Ÿæœºå®ç°è€Œå®šçš„</strong>ã€‚</p>
<p>ä¸»æµçš„è®¿é—®æ–¹å¼æœ‰ä¸¤ç§ï¼š1. ä½¿ç”¨å¥æŸ„ï¼Œ2. ä½¿ç”¨ç›´æ¥æŒ‡é’ˆ</p>
<h4 id="ä½¿ç”¨å¥æŸ„è®¿é—®ï¼š"><a href="#ä½¿ç”¨å¥æŸ„è®¿é—®ï¼š" class="headerlink" title="ä½¿ç”¨å¥æŸ„è®¿é—®ï¼š"></a>ä½¿ç”¨å¥æŸ„è®¿é—®ï¼š</h4><ul>
<li>Java å †ä¸­å°†ä¼šåˆ’åˆ†å‡ºæ¥ä¸€å—å†…å­˜ä½œä¸ºå¥æŸ„æ± ï¼Œreference ä¸­å°±æ˜¯å­˜å‚¨äº†<strong>å¯¹è±¡çš„å¥æŸ„åœ°å€</strong>ï¼Œè€Œå¥æŸ„ä¸­åŒ…å«äº†å¯¹è±¡<strong>å®ä¾‹æ•°æ®</strong>å’Œ<strong>ç±»å‹æ•°æ®</strong>å„è‡ªçš„<strong>å…·ä½“åœ°å€</strong>ä¿¡æ¯ã€‚<br><img src="https://user-images.githubusercontent.com/16668676/30117448-d342779e-9352-11e7-8d1e-5d4c44308d8f.png" alt="visit obj with handle"></li>
</ul>
<h4 id="ç›´æ¥æŒ‡é’ˆè®¿é—®ï¼š"><a href="#ç›´æ¥æŒ‡é’ˆè®¿é—®ï¼š" class="headerlink" title="ç›´æ¥æŒ‡é’ˆè®¿é—®ï¼š"></a>ç›´æ¥æŒ‡é’ˆè®¿é—®ï¼š</h4><ul>
<li>é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œé‚£ä¹ˆ Java å †<strong>å¯¹è±¡çš„å¸ƒå±€ä¸­å°±å¿…é¡»è€ƒè™‘å¦‚ä½•æ”¾ç½®è®¿é—®ç±»å‹æ•°æ®çš„ç›¸å…³ä¿¡æ¯</strong>ï¼Œreference ä¸­å­˜å‚¨çš„ç›´æ¥å°±æ˜¯å¯¹è±¡åœ°å€ï¼Œè€Œ<strong>å¯¹è±¡ä¸­åŒ…å«</strong>äº†å¯¹è±¡<strong>ç±»å‹æ•°æ®çš„åœ°å€ä¿¡æ¯</strong>ã€‚<br><img src="https://user-images.githubusercontent.com/16668676/30117447-d31537ac-9352-11e7-980c-d56f667070e4.png" alt="visit obj with pointer"></li>
</ul>
<h4 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h4><ul>
<li>ä½¿ç”¨<strong>å¥æŸ„</strong>è®¿é—®ä¼˜ç‚¹ï¼šæ˜¯ <strong>reference ä¸­å­˜å‚¨çš„æ˜¯ç¨³å®šçš„å¥æŸ„åœ°å€</strong>ï¼Œåœ¨<strong>å¯¹è±¡è¢«ç§»åŠ¨æ—¶</strong>ï¼Œåªä¼šæ”¹å˜å¥æŸ„ä¸­çš„å®ä¾‹æ•°æ®æŒ‡é’ˆï¼Œè€Œ <strong>reference æœ¬èº«ä¸éœ€è¦è¢«ä¿®æ”¹</strong>ã€‚</li>
<li>ä½¿ç”¨<strong>ç›´æ¥æŒ‡é’ˆ</strong>çš„æœ€å¤§å¥½å¤„å°±æ˜¯<strong>é€Ÿåº¦æ›´å¿«</strong>ï¼ŒèŠ‚çœäº†ä¸€æ¬¡æŒ‡é’ˆå®šä½éœ€è¦çš„æ—¶é—´å¼€é”€ï¼Œç”±äº Java å¯¹è±¡è®¿é—®ååˆ†é¢‘ç¹ï¼Œè¿™ç±»å¼€é”€ç§¯å°æˆå¤šåä¹Ÿæ˜¯ä¸€é¡¹éå¸¸å¯è§‚çš„æ‰§è¡Œæˆæœ¬ã€‚<ul>
<li>Sun HotSpot è™šæ‹Ÿæœºä½¿ç”¨çš„å°±æ˜¯è¿™ç§è®¿é—®æ–¹å¼ã€‚</li>
</ul>
</li>
</ul>
<h2 id="OutOfMemoryError-å¼‚å¸¸ç®€æ"><a href="#OutOfMemoryError-å¼‚å¸¸ç®€æ" class="headerlink" title="OutOfMemoryError å¼‚å¸¸ç®€æ"></a>OutOfMemoryError å¼‚å¸¸ç®€æ</h2><h3 id="Java-å †æº¢å‡º"><a href="#Java-å †æº¢å‡º" class="headerlink" title="Java å †æº¢å‡º"></a>Java å †æº¢å‡º</h3><p>ä¸æ–­åˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä¸”ä¿è¯ GC Roots åˆ°å¯¹è±¡ä¹‹é—´æœ‰å¯è¾¾è·¯å¾„æ¥<strong>é¿å…åƒåœ¾å›æ”¶æœºåˆ¶æ¸…é™¤è¿™äº›å¯¹è±¡</strong>ã€‚åœ¨å¯¹è±¡æ€»å†…å­˜è¾¾åˆ° <code>-XmX:heapSize</code>æŒ‡å®šçš„å€¼ä¹‹åå°±ä¼š OOMã€‚</p>
<p>ä¸€èˆ¬å‡ºç°è¿™ç§æƒ…å†µéƒ½æ˜¯é€šè¿‡ MAT å·¥å…·æ¥åˆ†æã€‚ç¡®å®šæ˜¯å‡ºç°äº†å†…å­˜æ³„æ¼ï¼Œè¿˜æ˜¯çš„æœ€å¤§å †ç©ºé—´çš„è®¾ç½®ä¸åˆç†ã€‚</p>
<ul>
<li>å¦‚æœæ˜¯å†…å­˜æ³„æ¼ï¼Œå¯è¿›ä¸€æ­¥é€šè¿‡å·¥å…·æ¥æŸ¥çœ‹å¯¹è±¡åˆ°   GC Roots çš„å¼•ç”¨é“¾ï¼Œæ‰¾å‡ºå†…å­˜æ³„æ¼çš„åŸå› </li>
<li>å¦‚æœä¸å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œå³å¯¹è±¡ç¡®å®å¿…é¡»å­˜æ´»ç€ï¼Œé‚£å°±è¦æ£€æŸ¥è™šæ‹Ÿæœºçš„å †å‚æ•°ï¼ˆ-Xmx ä¸ -Xmsï¼‰ä¸æœºå™¨ç‰©ç†å†…å­˜æ¯”è¾ƒçœ‹æ˜¯å¦è¿˜å¯ä»¥è°ƒå¤§ï¼›åŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦å­˜åœ¨ä¸€äº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸè¿‡é•¿ã€æŒæœ‰çŠ¶æ€æ—¶é—´è¿‡é•¿çš„æƒ…å†µï¼Œå°è¯•Â·å‡å°‘ç¨‹åºè¿è¡ŒæœŸçš„å†…å­˜æ¶ˆè€—ã€‚</li>
</ul>
<h3 id="è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º"><a href="#è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º" class="headerlink" title="è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º"></a>è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæº¢å‡º</h3><p>åœ¨ HotSpot è™šæ‹Ÿæœºä¸­å¹¶ä¸åŒºåˆ†è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆã€‚æ ˆå®¹é‡åªç”± <code>-Xss</code> å‚æ•°è®¾å®šã€‚</p>
<p>å…³äºè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œåœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æè¿°äº†ä¸¤ç§å¼‚å¸¸ï¼š</p>
<ul>
<li>å¦‚æœçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æœ€å¤§æ·±åº¦ï¼Œå°†æŠ›å‡ºStackOverflowErrorå¼‚å¸¸ã€‚</li>
<li>å¦‚æœè™šæ‹Ÿæœºåœ¨æ‰©å±•æ ˆæ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œåˆ™æŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚</li>
</ul>
<p>å¯¼è‡´ SOF çš„å¸¸è§åŸå› æœ‰é€’å½’ã€å®šä¹‰å¤§é‡çš„å±€éƒ¨å˜é‡ç­‰ã€‚</p>
<h3 id="æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º"><a href="#æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º" class="headerlink" title="æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º"></a>æ–¹æ³•åŒºå’Œè¿è¡Œæ—¶å¸¸é‡æ± æº¢å‡º</h3><p>å¯ä»¥é€šè¿‡åœ¨è¿è¡Œæ—¶äº§ç”Ÿå¤§é‡çš„<strong>ç±»</strong>å»å¡«æ»¡æ–¹æ³•åŒºã€‚</p>
<p>ç”±äº JDK1.7 æŠŠå­—ç¬¦ä¸²å¸¸é‡æ± ä»æ–¹æ³•åŒºç§»åˆ°å †ä¸­ï¼Œåœ¨ä¸åŒçš„ç‰ˆæœ¬çš„ JDKä¸­<code>String.intern()</code>æ–¹æ³•çš„è¡¨ç°ä¸ä¸€ã€‚</p>
<ul>
<li>JDK1.6 ä¸­è°ƒç”¨ <code>String.intern()</code> æ–¹æ³•æ—¶ï¼Œä¼šæŠŠ<strong>é¦–æ¬¡é‡åˆ°çš„å­—ç¬¦ä¸²å¤åˆ¶åˆ°æ°¸ä¹…ä»£ä¸­</strong>ã€‚</li>
<li>JDK1.7 ä¸­è°ƒç”¨ <code>String.intern()</code>æ–¹æ³•æ—¶ï¼Œä¸ä¼šå†å¤åˆ¶å®ä¾‹ï¼Œåªæ˜¯åœ¨å¸¸é‡æ± ä¸­<strong>è®°å½•é¦–æ¬¡å‡ºç°çš„å®ä¾‹å¼•ç”¨</strong></li>
</ul>
<h3 id="æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º"><a href="#æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º" class="headerlink" title="æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º"></a>æœ¬æœºç›´æ¥å†…å­˜æº¢å‡º</h3><p>å¯ä»¥é€šè¿‡ <code>-XX:MaxDirectMemorySize</code> æŒ‡å®šï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸ Java å †æœ€å¤§å€¼ï¼ˆ<code>-Xmx</code>æŒ‡å®šï¼‰ä¸€æ ·</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://www.cnblogs.com/paddix/p/5309550.html" target="_blank" rel="noopener">Java8 å†…å­˜æ¨¡å‹â€”æ°¸ä¹…ä»£(PermGen)å’Œå…ƒç©ºé—´(Metaspace)</a></li>
<li><a href="http://it.deepinmind.com/gc/2014/05/14/metaspace-in-java-8.html" target="_blank" rel="noopener">Java 8 çš„å…ƒç©ºé—´</a></li>
<li>Java 8 çš„å…ƒç©ºé—´<a href="http://java-latte.blogspot.sg/2014/03/metaspace-in-java-8.html" target="_blank" rel="noopener">è‹±æ–‡åŸæ–‡</a></li>
<li><a href="http://caoyaojun1988-163-com.iteye.com/blog/1969853" target="_blank" rel="noopener">JAVA 8 ï¼šä»æ°¸ä¹…åŒºï¼ˆPermGenï¼‰åˆ°å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰</a></li>
<li><a href="http://liuwangshu.cn/java/jvm/1-runtime-data-area.html" target="_blank" rel="noopener">Javaè™šæ‹Ÿæœºï¼ˆä¸€ï¼‰ç»“æ„åŸç†ä¸è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ</a></li>
<li>ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœº(ç¬¬ 2 ç‰ˆ)ã€‹</li>
</ul>
<p>è‹¥æœ¬æ–‡ä¸­æœ‰ä¸æ­£ç¡®çš„ç»“è®ºã€è¯´æ³•ï¼Œè¯·å¤§å®¶æå‡ºï¼Œå…±åŒæ¢è®¨ï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢!</p>
]]></content>
      
        <categories>
            
            <category> jvm </category>
            
        </categories>
        
        
        <tags>
            
            <tag> jvm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java é›†åˆæ¡†æ¶ä¹‹ ArrayList]]></title>
      <url>https://timlin-pro.github.io/blog/2017/09/06/Java-%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6%E4%B9%8BArrayList/</url>
      <content type="html"><![CDATA[<h2 id="æ¦‚è¦"><a href="#æ¦‚è¦" class="headerlink" title="æ¦‚è¦"></a>æ¦‚è¦</h2><p>ArrayList æ˜¯ä¸€ä¸ªåŠ¨æ€æ•°ç»„ï¼Œå®ƒæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå…è®¸å…ƒç´ ä¸º nullã€‚å®ƒçš„åº•å±‚æ•°æ®ç»“æ„æ˜¯æ•°ç»„ï¼ŒArrayList å®ç°äº† <code>List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable</code> æ¥å£ï¼Œå…¶ä¸­ RandomAccess ä»£è¡¨äº†å…¶æ‹¥æœ‰éšæœºå¿«é€Ÿè®¿é—®çš„èƒ½åŠ›ï¼Œ<code>ArrayList</code> å¯ä»¥ä»¥ O(1) çš„æ—¶é—´å¤æ‚åº¦å»æ ¹æ®ä¸‹æ ‡è®¿é—®å…ƒç´ ã€‚</p>
<h3 id="æ—¶é—´ã€ç©ºé—´æ•ˆç‡"><a href="#æ—¶é—´ã€ç©ºé—´æ•ˆç‡" class="headerlink" title="æ—¶é—´ã€ç©ºé—´æ•ˆç‡"></a>æ—¶é—´ã€ç©ºé—´æ•ˆç‡</h3><p>å› ä¸ºæ•°ç»„å†…å­˜çš„è¿ç»­ï¼Œå¯ä»¥æ ¹æ®ä¸‹æ ‡ä»¥ O1 çš„æ—¶é—´æ”¹æŸ¥å…ƒç´ ï¼Œå› æ­¤<strong>æ—¶é—´æ•ˆç‡å¾ˆé«˜</strong></p>
<p>åŒæ ·ä¹Ÿå› ä¸ºæ•°ç»„è¦å æ®ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å®ƒä¹Ÿæœ‰æ•°ç»„çš„ç¼ºç‚¹â€”â€”<strong>ç©ºé—´æ•ˆç‡ä¸é«˜</strong>ã€‚</p>
<a id="more"></a>
<h3 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h3><p>å½“é›†åˆä¸­çš„å…ƒç´ è¶…å‡ºå®¹é‡æ—¶ï¼Œä¼šè¿›è¡Œ<strong>æ‰©å®¹æ“ä½œ</strong>ï¼Œæ‰©å®¹æ“ä½œæ˜¯ä¸€ä¸ªæ€§èƒ½æ¶ˆè€—è¾ƒå¤§çš„åœ°æ–¹ï¼Œæ‰€ä»¥å¦‚æœèƒ½é¢„çŸ¥æ•°æ®çš„è§„æ¨¡ï¼Œæœ€å¥½åœ¨åˆå§‹åŒ–æ—¶é€šè¿‡ <code>public ArrayList(int initialCapacity)</code> æ„é€ æ–¹æ³•æŒ‡å®š ArrayList çš„å¤§å°ï¼Œæ¥æ„é€  ArrayList å®ä¾‹ï¼Œä»¥<strong>å‡å°‘æ‰©å®¹æ¬¡æ•°ï¼Œæé«˜æ•ˆç‡</strong>ã€‚</p>
<p>åœ¨æ·»åŠ å¤§é‡å…ƒç´ å‰ï¼Œåº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥ä½¿ç”¨ ensureCapacity æ“ä½œæ¥å¢åŠ  ArrayList å®ä¾‹çš„å®¹é‡ï¼Œè¿™å¯ä»¥å‡å°‘é€’å¢å¼å†åˆ†é…çš„æ•°é‡ã€‚ ä¸è¿‡è¯¥æ–¹æ³•æ˜¯ ArrayList ä¸­æ·»åŠ çš„ï¼ŒList ä¸­æ²¡æœ‰è¯¥æ–¹æ³•ã€‚æ‰€ä»¥å¦‚æœå£°æ˜çš„ç±»å‹ä¸º List çš„è¯ï¼Œéœ€è¦è¿›è¡Œå¼ºè½¬ã€‚<code>((ArrayList)list).ensureCapacity(number);</code></p>
<p>å½“æ¯æ¬¡ä¿®æ”¹ç»“æ„æ—¶(æ·»åŠ æˆ–è€…åˆ é™¤å…ƒç´ )ï¼Œéƒ½ä¼šä¿®æ”¹ modCountã€‚</p>
<h2 id="æˆå‘˜å˜é‡"><a href="#æˆå‘˜å˜é‡" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">10</span>;<span class="comment">//é»˜è®¤åˆå§‹å®¹é‡</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] EMPTY_ELEMENTDATA = &#123;&#125;;<span class="comment">//ç©ºå¯¹è±¡æ•°æ®ï¼Œç”¨äºç©ºå¯¹è±¡ï¼Œå¦‚æœæŒ‡å®šåˆå§‹å®¹é‡ä¸º 0 å°±ç»™å…ƒç´ é™„ä¸€ä¸ªç©ºå¯¹è±¡</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Shared empty array instance used for default sized empty instances. We</div><div class="line"> * distinguish this from EMPTY_ELEMENTDATA to know how much to inflate when</div><div class="line"> * first element is added.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;<span class="comment">//å…±äº«çš„ç©ºæ•°ç»„å¯¹è±¡ï¼Œä½¿ç”¨è¯¥å¯¹è±¡ç”¨ä»¥åŒºåˆ† EMPTY_ELEMENTDATAï¼Œä»è€ŒçŸ¥é“ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œåº”è¯¥åˆå§‹åŒ–çš„æ•°ç»„é•¿åº¦ã€‚</span></div><div class="line"></div><div class="line"><span class="keyword">transient</span> Object[] elementData; <span class="comment">// ä¹‹æ‰€ä»¥ä¸å£°æ˜ä¸º private æ˜¯ä¸ºäº†ç®€åŒ–å†…éƒ¨ç±»è®¿é—®ï¼Œ</span></div><div class="line"><span class="comment">// æ‰€æœ‰åŸæœ¬ä¸ºé»˜è®¤å®¹é‡çš„ç©ºæ•°ç»„ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ çš„æ—¶å€™éƒ½ä¼šè¢«åˆå§‹åŒ–ä¸ºé•¿åº¦ä¸ºé»˜è®¤å®¹é‡çš„æ•°ç»„</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> size;<span class="comment">//åŒ…å«å…ƒç´ çš„æ•°é‡</span></div></pre></td></tr></table></figure>
<h2 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><p>ArrayList æä¾›äº†ä¸‰ç§æ–¹å¼çš„æ„é€ å™¨ï¼Œå¯ä»¥æ„é€ ä¸€ä¸ªé»˜è®¤åˆå§‹å®¹é‡ä¸º 10 çš„ç©ºåˆ—è¡¨ã€æ„é€ ä¸€ä¸ªæŒ‡å®šåˆå§‹å®¹é‡çš„ç©ºåˆ—è¡¨ä»¥åŠæ„é€ ä¸€ä¸ªåŒ…å«æŒ‡å®š collection çš„å…ƒç´ çš„åˆ—è¡¨ï¼Œè¿™äº›å…ƒç´ æŒ‰ç…§è¯¥ collection çš„è¿­ä»£å™¨è¿”å›å®ƒä»¬çš„é¡ºåºæ’åˆ—çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;<span class="comment">//æŒ‰ç…§æŒ‡å®šçš„åˆå§‹å®¹é‡åˆå§‹åŒ–</span></div><div class="line">    <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];<span class="comment">//åˆ›å»ºæ•°ç»„</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;<span class="comment">//å¦‚æœæŒ‡å®šåˆå§‹å®¹é‡ä¸º 0 å°±ç»™å…ƒç´ é™„ä¸€ä¸ªç©ºå¯¹è±¡</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal Capacity: "</span> +</div><div class="line">                initialCapacity);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;<span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªåˆå§‹å®¹é‡ä¸º 10 çš„ ArrayList</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//æ„é€ ä¸€ä¸ªåŒ…å«æŒ‡å®š collection çš„å…ƒç´ çš„åˆ—è¡¨ï¼Œè¿™äº›å…ƒç´ æŒ‰ç…§è¯¥ collection çš„è¿­ä»£å™¨è¿”å›å®ƒä»¬çš„é¡ºåºæ’åˆ—çš„ã€‚</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;<span class="comment">//ä»ç»™å®šçš„å®¹å™¨ä¸­æ„å»ºä¸€ä¸ª ArrayList</span></div><div class="line">    elementData = c.toArray();<span class="comment">//å°†å®¹å™¨å¯¹è±¡ä¸­çš„å…ƒç´ è½¬æ¢ä¸ºæ•°ç»„</span></div><div class="line">    <span class="keyword">if</span> ((size = elementData.length) != <span class="number">0</span>) &#123;<span class="comment">//é•¿åº¦ä¸ä¸º 0ï¼Œè¿›è¡Œåˆ¤æ–­æ“ä½œ</span></div><div class="line">        <span class="comment">// c.toArray might (incorrectly) not return Object[] (see 6260652)</span></div><div class="line">        <span class="keyword">if</span> (elementData.getClass() != Object[].class)</div><div class="line">            elementData = Arrays.copyOf(elementData, size, Object[].class);<span class="comment">//å¦‚æœè¿”å›çš„æ•°ç»„ä¸æ˜¯ Object[].class ç±»å‹çš„ï¼Œåˆ™è¿›è¡Œå°†æ•°ç»„å…ƒç´ å¤åˆ¶åˆ°ç±»å‹ä¸º Object æ•°ç»„ä¸Š</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// replace with empty array.</span></div><div class="line">        <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;<span class="comment">//é•¿åº¦ä¸º 0ï¼Œåˆ™å°†ç©ºæ•°ç»„å¯¹è±¡èµ‹å€¼ç»™å…ƒç´ æ•°ç»„</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ç¬¬ä¸‰ä¸ªæ„é€ æ–¹æ³•ä¸­å¯¹æ•°ç»„å…ƒç´ ç±»å‹çš„åˆ¤æ–­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (elementData.getClass() != Object[].class)&#123;</div><div class="line">    elementData = Arrays.copyOf(elementData, size, Object[].class);</div><div class="line">&#125; <span class="keyword">else</span>&#123;</div><div class="line">  <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> è™½ç„¶è¡¨é¢ä¸Šçœ‹èµ·æ¥ï¼Œc.toArray() ä¼šè¿”å›ä¸€ä¸ª  Object[]  å¯¹è±¡æ•°ç»„ï¼Œä½†æ˜¯å®ƒæŒ‡å‘çš„å®é™…ç±»å‹å¹¶ä¸ä¸€å®šæ˜¯ Object[]ï¼Œè¿™æ ·å½“æˆ‘ä»¬è°ƒç”¨ objList[i] =  new Object(); å°±ä¼šæŠ¥é”™   ã€‚ æ¯”å¦‚è¯´å¦‚æœæˆ‘ä»¬æœ‰ 1 ä¸ª List<string> stringList å¯¹è±¡ï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>Object[] objectArray = stringList.toArray()</code>çš„æ—¶å€™ï¼Œ  objectArray åªèƒ½å­˜æ”¾ String ç±»å‹çš„æ•°æ®è€Œä¸èƒ½å­˜å‚¨å…¶ä»–ç±»å‹çš„å¯¹è±¡ã€‚</string></p>
<h2 id="å¢"><a href="#å¢" class="headerlink" title="å¢"></a>å¢</h2><p> ArrayList æä¾›äº† add(E e)ã€add(int index, E element)ã€addAll(Collection&lt;? extends E&gt; c)ã€addAll(int index, Collection&lt;? extends E&gt; c)è¿™äº›æ·»åŠ å…ƒç´ çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * æ·»åŠ å…ƒç´ åˆ°åˆ—è¡¨å°¾éƒ¨ã€‚</div><div class="line"> * å…ˆç¡®è®¤ ArrayList çš„å®¹é‡</div><div class="line"> * æ¯æ¬¡ add ä¹‹å‰ï¼Œéƒ½ä¼šåˆ¤æ–­ add åçš„å®¹é‡ï¼Œæ˜¯å¦éœ€è¦æ‰©å®¹ã€‚</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!! ç¡®ä¿å®¹é‡è¶³ä»¥å®¹çº³åŸæœ‰å…ƒç´ åŠ ä¸Šæ–°å¢çš„å…ƒç´ </span></div><div class="line">    elementData[size++] = e;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * æ·»åŠ å…ƒç´ åˆ°åˆ—è¡¨æŒ‡å®šä½ç½®ã€‚éœ€è¦å°†è¯¥ä½ç½®å³ç«¯çš„æ‰€æœ‰å…ƒç´ éƒ½å¾€å³ç§»åŠ¨ä¸€ä¸ªå•ä½</div><div class="line"> * å…ˆç¡®è®¤ ArrayList çš„å®¹é‡</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</div><div class="line">    rangeCheckForAdd(index);<span class="comment">//ä¸Šä¸‹ç•Œåˆ¤æ–­</span></div><div class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!! åˆ¤æ–­ add ä¹‹åçš„å®¹é‡ï¼Œæ ¹æ®æƒ…å†µè¿›è¡Œæ‰©å®¹</span></div><div class="line">    System.arraycopy(elementData, index, elementData, index + <span class="number">1</span>,<span class="comment">// å°† index ~ size-1 èŒƒå›´å†…çš„å…ƒç´ å¤åˆ¶åˆ° index+1 ~ size èŒƒå›´ä¸­ã€‚ä¹Ÿå°±æ˜¯å°† index åŠå…¶ä»¥åçš„å…ƒç´ åç§»ä¸€ä¸ªä½ç½®</span></div><div class="line">            size - index);</div><div class="line">    elementData[index] = element;<span class="comment">//å°†ç»™å®šå…ƒç´ æ·»åŠ åˆ°æŒ‡å®šå…ƒç´ ä¸­</span></div><div class="line">    size++;<span class="comment">//å…ƒç´ æ•°é‡ + 1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * æ·»åŠ ç»™å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ åˆ° ArrayList ä¸­</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</div><div class="line">    Object[] a = c.toArray();<span class="comment">//å…ˆè½¬æ¢ä¸ºæ•°ç»„</span></div><div class="line">    <span class="keyword">int</span> numNew = a.length;<span class="comment">//è¦æ·»åŠ çš„å…ƒç´ æ•°é‡</span></div><div class="line">    ensureCapacityInternal(size + numNew);  <span class="comment">// Increments modCountï¼Œç¡®ä¿å®¹é‡è¶³å¤Ÿå®¹çº³æ–°æ·»åŠ çš„æ‰€æœ‰å…ƒç´ </span></div><div class="line">    System.arraycopy(a, <span class="number">0</span>, elementData, size, numNew);<span class="comment">//å°†å…ƒç´ æ·»åŠ åˆ°åˆ—è¡¨å°¾éƒ¨</span></div><div class="line">    size += numNew;</div><div class="line">    <span class="keyword">return</span> numNew != <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * ä»æŒ‡å®šçš„ä½ç½®å¼€å§‹ï¼Œå°†æŒ‡å®š collection ä¸­çš„æ‰€æœ‰å…ƒç´ æ’å…¥åˆ°æ­¤åˆ—è¡¨ä¸­ã€‚  </div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(<span class="keyword">int</span> index, Collection&lt;? extends E&gt; c)</span> </span>&#123;</div><div class="line">    rangeCheckForAdd(index);<span class="comment">//æ£€æŸ¥ä¸Šä¸‹ç•Œ</span></div><div class="line"></div><div class="line">    Object[] a = c.toArray();<span class="comment">//è½¬æ¢ä¸ºæ•°ç»„</span></div><div class="line">    <span class="keyword">int</span> numNew = a.length;<span class="comment">//å¢åŠ çš„æ•°é‡</span></div><div class="line">    ensureCapacityInternal(size + numNew);  <span class="comment">// Increments modCount</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> numMoved = size - index;<span class="comment">//è¦ç§»åŠ¨çš„å…ƒç´ æ•°</span></div><div class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</div><div class="line">        System.arraycopy(elementData, index, elementData, index + numNew,</div><div class="line">                numMoved);<span class="comment">//ç§»åŠ¨æ•°ç»„ä¸­éœ€è¦ç§»åŠ¨çš„å…ƒç´ </span></div><div class="line"></div><div class="line">    System.arraycopy(a, <span class="number">0</span>, elementData, index, numNew);<span class="comment">//æ’å…¥å…ƒç´ </span></div><div class="line">    size += numNew;</div><div class="line">    <span class="keyword">return</span> numNew != <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="åˆ "><a href="#åˆ " class="headerlink" title="åˆ "></a>åˆ </h2><p>ArrayList æä¾›äº†<strong>æ ¹æ®ä¸‹æ ‡</strong>æˆ–è€…<strong>æŒ‡å®šå¯¹è±¡</strong>ä¸¤ç§æ–¹å¼çš„åˆ é™¤åŠŸèƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * ç§»é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ </div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    rangeCheck(index);<span class="comment">//ä¸Šç•Œåˆ¤æ–­</span></div><div class="line"></div><div class="line">    modCount++;<span class="comment">//ç»“æ„ä¿®æ”¹æ¬¡æ•° + 1</span></div><div class="line">    E oldValue = elementData(index);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> numMoved = size - index - <span class="number">1</span>;<span class="comment">//ç§»åŠ¨çš„å…ƒç´ æ€»æ•°</span></div><div class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</div><div class="line">        System.arraycopy(elementData, index + <span class="number">1</span>, elementData, index,<span class="comment">//</span></div><div class="line">                numMoved);<span class="comment">//å°†è¦åˆ é™¤çš„å…ƒç´ çš„åé¢çš„æ‰€æœ‰å…ƒç´ å¾€å‰ç§»ä¸€ä¸ªå•ä½</span></div><div class="line">    elementData[--size] = <span class="keyword">null</span>; <span class="comment">// clear to let GC do its work å°†æœ«å…ƒç´ ç½®ä¸º nullï¼Œä»¥å…å†…å­˜æ³„æ¼</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> oldValue;<span class="comment">//è¿”å›åˆ é™¤æ‰çš„å€¼</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * ç§»é™¤æ­¤åˆ—è¡¨ä¸­é¦–æ¬¡å‡ºç°çš„æŒ‡å®šå…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ã€‚</div><div class="line"> * å…ˆæ‰¾åˆ°æŒ‡å®šå…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œç„¶åå†è°ƒç”¨ fastRemove åˆ é™¤</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">  	<span class="comment">// ç”±äº ArrayList ä¸­å…è®¸å­˜æ”¾ nullï¼Œå› æ­¤ä¸‹é¢é€šè¿‡ä¸¤ç§æƒ…å†µæ¥åˆ†åˆ«å¤„ç†ã€‚  </span></div><div class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; size; index++)</div><div class="line">            <span class="keyword">if</span> (elementData[index] == <span class="keyword">null</span>) &#123;</div><div class="line">                fastRemove(index);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; size; index++)</div><div class="line">            <span class="keyword">if</span> (o.equals(elementData[index])) &#123;</div><div class="line">                fastRemove(index);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *  åˆ é™¤ [fromIndexï¼ŒtoIndex) èŒƒå›´ä¸­çš„æ‰€æœ‰å…ƒç´  </div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">removeRange</span><span class="params">(<span class="keyword">int</span> fromIndex, <span class="keyword">int</span> toIndex)</span> </span>&#123;</div><div class="line">    modCount++;</div><div class="line">    <span class="keyword">int</span> numMoved = size - toIndex;</div><div class="line">    System.arraycopy(elementData, toIndex, elementData, fromIndex,</div><div class="line">            numMoved);</div><div class="line"></div><div class="line">    <span class="comment">// clear to let GC do its work</span></div><div class="line">    <span class="keyword">int</span> newSize = size - (toIndex - fromIndex);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = newSize; i &lt; size; i++) &#123;</div><div class="line">        elementData[i] = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    size = newSize;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * ç§»é™¤ ArrayList ä¸­ç»™å®šæŒ‡å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeAll</span><span class="params">(Collection&lt;?&gt; c)</span> </span>&#123;</div><div class="line">    Objects.requireNonNull(c);</div><div class="line">    <span class="keyword">return</span> batchRemove(c, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * æ‰¹é‡åˆ é™¤</div><div class="line"> * complement ä¸º false æ—¶ï¼Œåˆ é™¤æŒ‡å®šé›†åˆ c ä¸­æ‰€æœ‰çš„å…ƒç´ ã€‚</div><div class="line"> * complement ä¸º true æ—¶ï¼Œåˆ é™¤æŒ‡å®šé›†åˆ c ä¸­ä»¥å¤–çš„æ‰€æœ‰çš„å…ƒç´ ã€‚</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">batchRemove</span><span class="params">(Collection&lt;?&gt; c, <span class="keyword">boolean</span> complement)</span> </span>&#123;<span class="comment">// complement ä¸º true æ—¶ä¸ºè¡¥é›†</span></div><div class="line">    <span class="keyword">final</span> Object[] elementData = <span class="keyword">this</span>.elementData;<span class="comment">//å°†æ•°ç»„å¼•ç”¨èµ‹ç»™ elementdata,èŠ‚çœç©ºé—´</span></div><div class="line">    <span class="keyword">int</span> r = <span class="number">0</span>, w = <span class="number">0</span>;</div><div class="line">    <span class="keyword">boolean</span> modified = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//éå†ï¼ŒæŠŠè¦ä¿å­˜çš„å…ƒç´ å­˜åœ¨å‰é¢</span></div><div class="line">        <span class="keyword">for</span> (; r &lt; size; r++)</div><div class="line">            <span class="keyword">if</span> (c.contains(elementData[r]) == complement)<span class="comment">//å­˜å‚¨è¦ä¿ç•™çš„å…ƒç´ ã€‚é›†åˆ c ä¸­æ˜¯å¦åŒ…æ‹¬è¯¥å…ƒç´  == åˆ é™¤è¡¥é›†ï¼Ÿ</span></div><div class="line">                elementData[w++] = elementData[r];</div><div class="line"></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="comment">// Preserve behavioral compatibility with AbstractCollection,</span></div><div class="line">        <span class="comment">// even if c.contains() throws.</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (r != size) &#123;<span class="comment">// æ­¤æ®µä»£ç ä½œç”¨ä¸ºï¼šå½“ c.contains æŠ›å‡ºå¼‚å¸¸æ—¶ï¼ˆæ­¤æ—¶ r &lt; size ï¼‰ï¼Œä¿æŒä¸ AbstractCollection çš„è¡Œä¸ºå…¼å®¹æ€§</span></div><div class="line">            System.arraycopy(elementData, r,</div><div class="line">                    elementData, w,</div><div class="line">                    size - r);<span class="comment">//å°†åé¢çš„å…ƒç´ ç§»åŠ¨åˆ° w åé¢</span></div><div class="line">            w += size - r;<span class="comment">//åŠ ä¸Šç§»åŠ¨çš„å…ƒç´ æ•°ï¼Œè·å–ã€Œæœ€åçš„å…ƒç´ ã€çš„ä¸‹æ ‡</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (w != size) &#123;<span class="comment">//æ¸…é™¤å¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span></div><div class="line">            <span class="comment">// clear to let GC do its work</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = w; i &lt; size; i++)<span class="comment">//å°† w ä¹‹åçš„å…ƒç´ éƒ½ç½®ä¸º null</span></div><div class="line">                elementData[i] = <span class="keyword">null</span>;</div><div class="line">            modCount += size - w;</div><div class="line">            size = w;</div><div class="line">            modified = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> modified;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æ€§èƒ½-1"><a href="#æ€§èƒ½-1" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h3><p>æ³¨æ„ï¼šä»æ•°ç»„ä¸­ç§»é™¤å…ƒç´ çš„æ“ä½œï¼Œä¹Ÿä¼š<strong>å¯¼è‡´è¢«ç§»é™¤çš„å…ƒç´ ä»¥åçš„æ‰€æœ‰å…ƒç´ çš„å‘å·¦ç§»åŠ¨ä¸€ä¸ªä½ç½®</strong>ã€‚</p>
<h2 id="æŸ¥-è·å–"><a href="#æŸ¥-è·å–" class="headerlink" title="æŸ¥/è·å–"></a>æŸ¥/è·å–</h2><p> è·å–æ­¤åˆ—è¡¨ä¸­æŒ‡å®šä½ç½®ä¸Šçš„å…ƒç´ ã€‚  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    rangeCheck(index);</div><div class="line">    checkForComodification();</div><div class="line">    <span class="keyword">return</span> java.util.ArrayList.<span class="keyword">this</span>.elementData(offset + index);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å°ç»“ã€å¯¹æ¯”"><a href="#å°ç»“ã€å¯¹æ¯”" class="headerlink" title="å°ç»“ã€å¯¹æ¯”"></a>å°ç»“ã€å¯¹æ¯”</h3><h2 id="æ”¹"><a href="#æ”¹" class="headerlink" title="æ”¹"></a>æ”¹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E e)</span> </span>&#123;</div><div class="line">    rangeCheck(index);</div><div class="line">    checkForComodification();</div><div class="line">    E oldValue = java.util.ArrayList.<span class="keyword">this</span>.elementData(offset + index);</div><div class="line">    java.util.ArrayList.<span class="keyword">this</span>.elementData[offset + index] = e;</div><div class="line">    <span class="keyword">return</span> oldValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h3><h2 id="è°ƒæ•´æ•°ç»„å®¹é‡"><a href="#è°ƒæ•´æ•°ç»„å®¹é‡" class="headerlink" title="è°ƒæ•´æ•°ç»„å®¹é‡"></a>è°ƒæ•´æ•°ç»„å®¹é‡</h2><h3 id="æ‰©å®¹"><a href="#æ‰©å®¹" class="headerlink" title="æ‰©å®¹"></a>æ‰©å®¹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ensureCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> minExpand = (elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA)</div><div class="line">            <span class="comment">// any size if not default element table</span></div><div class="line">            ? <span class="number">0</span></div><div class="line">            <span class="comment">// larger than default for default empty table. It's already</span></div><div class="line">            <span class="comment">// supposed to be at default size.</span></div><div class="line">            : DEFAULT_CAPACITY;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (minCapacity &gt; minExpand) &#123;</div><div class="line">        ensureExplicitCapacity(minCapacity);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * å†…éƒ¨ä¿è¯å®¹é‡ï¼Œå¦‚æœ ArrayList æ˜¯é€šè¿‡æ— å‚æ„é€ å‡½æ•°åˆ›å»ºçš„ï¼Œ</div><div class="line"> * é‚£ä¹ˆç¬¬ä¸€æ¬¡ add å…ƒç´ çš„æ—¶å€™å°±ä¼šè°ƒç”¨è¯¥æ–¹æ³•æ‰©å®¹</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</div><div class="line">        minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ensureExplicitCapacity(minCapacity);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * ç¡®ä¿åˆ†é…æŒ‡å®šçš„å®¹é‡</div><div class="line"> * */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureExplicitCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</div><div class="line">    modCount++;</div><div class="line"></div><div class="line">    <span class="comment">// overflow-conscious code</span></div><div class="line">    <span class="comment">//å¦‚æœæŒ‡æ˜çš„æœ€å°å®¹é‡è¶…è¿‡æ•°ç»„çš„é•¿åº¦ï¼Œå°±å¢å¤§å®¹é‡</span></div><div class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</div><div class="line">        grow(minCapacity);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ¯æ¬¡æ•°ç»„å®¹é‡çš„å¢é•¿å¤§çº¦æ˜¯å…¶åŸå®¹é‡çš„ 1.5 å€ã€‚è¿™ç§æ“ä½œçš„ä»£ä»·æ˜¯å¾ˆé«˜çš„ï¼Œå› æ­¤åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡é¿å…æ•°ç»„å®¹é‡çš„æ‰©å¼ ã€‚å½“æˆ‘ä»¬å¯é¢„çŸ¥è¦ä¿å­˜çš„å…ƒç´ çš„å¤šå°‘æ—¶ï¼Œè¦åœ¨æ„é€  ArrayList å®ä¾‹æ—¶ï¼Œå°±æŒ‡å®šå…¶å®¹é‡ï¼Œä»¥é¿å…æ•°ç»„æ‰©å®¹çš„å‘ç”Ÿã€‚æˆ–è€…æ ¹æ®å®é™…éœ€æ±‚ï¼Œé€šè¿‡è°ƒç”¨ ensureCapacity æ–¹æ³•æ¥æ‰‹åŠ¨å¢åŠ  ArrayList å®ä¾‹çš„å®¹é‡ã€‚</p>
<h3 id="ã€Œå‹ç¼©ã€"><a href="#ã€Œå‹ç¼©ã€" class="headerlink" title="ã€Œå‹ç¼©ã€"></a>ã€Œå‹ç¼©ã€</h3><p>   ArrayList è¿˜ç»™æˆ‘ä»¬æä¾›äº†å°†åº•å±‚æ•°ç»„çš„å®¹é‡è°ƒæ•´ä¸ºå½“å‰åˆ—è¡¨ä¿å­˜çš„å®é™…å…ƒç´ çš„å¤§å°çš„åŠŸèƒ½ã€‚å®ƒå¯ä»¥é€šè¿‡ trimToSize æ–¹æ³•æ¥å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å°† ArrayList çš„å®¹é‡å‹ç¼©åˆ°å½“å‰å…ƒç´ æ•°é‡ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§é™åº¦èŠ‚çœç©ºé—´</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">()</span> </span>&#123;</div><div class="line">    modCount++;<span class="comment">//å®šä¹‰ä¸çˆ¶ç±» AbstractList ä¸­ï¼Œè®°å½•å‘ç”Ÿç»“æ„åŒ–ä¿®æ”¹çš„æ¬¡æ•°ã€‚å¦‚æœä¸æ‰“ç®—æä¾›ã€Œå¿«é€Ÿå¤±è´¥çš„è¿­ä»£å™¨ã€ï¼Œå¯å¿½ç•¥æ­¤åŸŸ</span></div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (size &lt; elementData.length) &#123;</div><div class="line">        elementData = (size == <span class="number">0</span>)</div><div class="line">                ? EMPTY_ELEMENTDATA</div><div class="line">                : Arrays.copyOf(elementData, size);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Fail-Fast-æœºåˆ¶"><a href="#Fail-Fast-æœºåˆ¶" class="headerlink" title="Fail-Fast æœºåˆ¶"></a>Fail-Fast æœºåˆ¶</h2><p>ArrayList ä¹Ÿé‡‡ç”¨äº†å¿«é€Ÿå¤±è´¥çš„æœºåˆ¶ï¼Œé€šè¿‡è®°å½• modCount å‚æ•°æ¥å®ç°ã€‚åœ¨é¢å¯¹å¹¶å‘çš„ä¿®æ”¹æ—¶ï¼Œè¿­ä»£å™¨å¾ˆå¿«å°±ä¼šå®Œå…¨å¤±è´¥ï¼Œè€Œä¸æ˜¯å†’ç€åœ¨å°†æ¥æŸä¸ªä¸ç¡®å®šæ—¶é—´å‘ç”Ÿä»»æ„ä¸ç¡®å®šè¡Œä¸ºçš„é£é™©ã€‚å…·ä½“ä»‹ç»è¯·å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« <a href="http://zhangshixi.iteye.com/blog/672697" target="_blank" rel="noopener">æ·±å…¥ Java é›†åˆå­¦ä¹ ç³»åˆ—ï¼šHashMap çš„å®ç°åŸç†</a> ä¸­çš„ Fail-Fast æœºåˆ¶ã€‚</p>
<ul>
<li>å¿«é€Ÿå¤±è´¥ï¼šå½“ä½ åœ¨è¿­ä»£ä¸€ä¸ªé›†åˆçš„æ—¶å€™ï¼Œå¦‚æœæœ‰å¦ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ä¿®æ”¹ä½ æ­£åœ¨è®¿é—®çš„é‚£ä¸ªé›†åˆæ—¶ï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ª ConcurrentModification å¼‚å¸¸ã€‚   <ul>
<li>åœ¨ java.util åŒ…ä¸‹çš„éƒ½æ˜¯å¿«é€Ÿå¤±è´¥ã€‚</li>
</ul>
</li>
<li>å®‰å…¨å¤±è´¥ï¼šä½ åœ¨è¿­ä»£çš„æ—¶å€™ä¼šå»åº•å±‚é›†åˆåšä¸€ä¸ªæ‹·è´ï¼Œæ‰€ä»¥ä½ åœ¨ä¿®æ”¹ä¸Šå±‚é›†åˆçš„æ—¶å€™æ˜¯ä¸ä¼šå—å½±å“çš„ï¼Œä¸ä¼šæŠ›å‡º ConcurrentModification å¼‚å¸¸ã€‚<ul>
<li>åœ¨ java.util.concurrent åŒ…ä¸‹çš„å…¨æ˜¯å®‰å…¨å¤±è´¥çš„ã€‚</li>
</ul>
</li>
</ul>
<p>å³ æŠ›å¼‚å¸¸æ˜¯å¿«é€Ÿå¤±è´¥ï¼ˆutil åŒ…ä¸‹éƒ½æ˜¯å¿«é€Ÿå¤±è´¥ï¼‰ï¼Œä¸æŠ›å¼‚å¸¸æ˜¯å®‰å…¨å¤±è´¥ã€‚ Java ç‰ˆæœ¬è¶Šå¾€åè¶Šã€Œå®‰å…¨ã€ï¼Œconcurrent åŒ…ä¸‹é¢å…¨éƒ¨ä¸º<strong>å®‰å…¨å¤±è´¥</strong></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯ä»¥çœ‹åˆ°æ ¸å¿ƒæ“ä½œåœ¨äºå¢åŠ å’Œåˆ é™¤å…ƒç´ ã€‚</p>
<ol>
<li>å¢åˆ æ”¹æŸ¥ä¸­ï¼Œ å¢å¯¼è‡´<strong>æ‰©å®¹</strong>ï¼Œåˆ™<strong>ä¼šä¿®æ”¹ modCount</strong>ï¼Œ<strong>åˆ ä¸€å®šä¼šä¿®æ”¹</strong>ã€‚ <strong>æ”¹å’ŒæŸ¥ä¸€å®šä¸ä¼šä¿®æ”¹ modCount</strong>ã€‚</li>
<li>æ‰©å®¹æ“ä½œä¼šå¯¼è‡´æ•°ç»„å¤åˆ¶ï¼Œ<strong>æ‰¹é‡åˆ é™¤ä¼šå¯¼è‡´æ‰¾å‡ºä¸¤ä¸ªé›†åˆçš„äº¤é›†ï¼Œä»¥åŠæ•°ç»„å¤åˆ¶æ“ä½œ</strong>ï¼Œå› æ­¤ï¼Œå¢ã€åˆ éƒ½ç›¸å¯¹ä½æ•ˆã€‚ è€Œ æ”¹ã€æŸ¥éƒ½æ˜¯å¾ˆé«˜æ•ˆçš„æ“ä½œã€‚</li>
<li>å› æ­¤ï¼Œç»“åˆç‰¹ç‚¹ï¼Œåœ¨ä½¿ç”¨ä¸­ï¼Œä»¥ Android ä¸­æœ€å¸¸ç”¨çš„å±•ç¤ºåˆ—è¡¨ä¸ºä¾‹ï¼Œåˆ—è¡¨æ»‘åŠ¨æ—¶éœ€è¦å±•ç¤ºæ¯ä¸€ä¸ª Itemï¼ˆelementï¼‰çš„æ•°ç»„ï¼Œ<strong>æ‰€ä»¥ æŸ¥ æ“ä½œæ˜¯æœ€é«˜é¢‘çš„</strong>ã€‚ç›¸å¯¹æ¥è¯´ï¼Œ<strong>å¢æ“ä½œåªæœ‰åœ¨åˆ—è¡¨åŠ è½½æ›´å¤šæ—¶æ‰ä¼šç”¨åˆ°</strong> ï¼Œè€Œä¸”æ˜¯åœ¨åˆ—è¡¨å°¾éƒ¨æ’å…¥ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ç§»åŠ¨æ•°æ®çš„æ“ä½œã€‚è€Œåˆ æ“ä½œåˆ™æ›´ä½é¢‘ã€‚ æ•…é€‰ç”¨ ArrayList ä½œä¸ºä¿å­˜æ•°æ®çš„ç»“æ„ã€‚</li>
<li>å’Œ<code>Vector</code>çš„åŒºåˆ«ï¼ŒVector<code>å†…éƒ¨ä¹Ÿæ˜¯æ•°ç»„å®ç°çš„ï¼ŒåŒºåˆ«åœ¨äº</code>Vector<code>åœ¨ API ä¸Šéƒ½åŠ äº†</code>synchronized<code>æ‰€ä»¥å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä»¥åŠ</code>Vector<code>æ‰©å®¹æ—¶ï¼Œæ˜¯ç¿»å€ sizeï¼Œè€Œ</code>ArrayList`æ˜¯æ‰©å®¹ 50%ã€‚</li>
</ol>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://blog.csdn.net/zxt0601/article/details/77281231" target="_blank" rel="noopener">é¢è¯•å¿…å¤‡ï¼šArrayList æºç è§£æï¼ˆJDK8ï¼‰</a></li>
<li><a href="http://zhangshixi.iteye.com/blog/674856" target="_blank" rel="noopener">æ·±å…¥ Java é›†åˆå­¦ä¹ ç³»åˆ—ï¼šArrayList çš„å®ç°åŸç†</a></li>
<li><a href="http://yikun.github.io/2015/04/04/Java-ArrayList%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/" target="_blank" rel="noopener">Java ArrayList å·¥ä½œåŸç†åŠå®ç°</a></li>
</ul>
<p>è‹¥æœ¬æ–‡ä¸­æœ‰ä¸æ­£ç¡®çš„ç»“è®ºã€è¯´æ³•ï¼Œè¯·å¤§å®¶æå‡ºï¼Œå…±åŒæ¢è®¨ï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢!</p>
]]></content>
      
        <categories>
            
            <category> javaé›†åˆæ¡†æ¶ </category>
            
            <category> åŸç†åˆ†æ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> javaé›†åˆæ¡†æ¶ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android æºç ä¸­çš„è£…é¥°è€…æ¨¡å¼]]></title>
      <url>https://timlin-pro.github.io/blog/2017/09/05/Android-%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<h2 id="è£…é¥°è€…æ¨¡å¼çš„å®šä¹‰"><a href="#è£…é¥°è€…æ¨¡å¼çš„å®šä¹‰" class="headerlink" title="è£…é¥°è€…æ¨¡å¼çš„å®šä¹‰"></a>è£…é¥°è€…æ¨¡å¼çš„å®šä¹‰</h2><p>è£…é¥°æ¨¡å¼ï¼ˆDecorator Patternï¼‰ ä¹Ÿç§°<strong>åŒ…è£…æ¨¡å¼</strong>ï¼ˆWrapper Patternï¼‰ï¼Œæ˜¯ç»“æ„å‹è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œä½¿ç”¨ä¸€ç§å¯¹å®¢æˆ·ç«¯é€æ˜çš„æ–¹å¼æ¥<strong>åŠ¨æ€åœ°æ‹“å±•å¯¹è±¡çš„åŠŸèƒ½</strong>ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯ç»§æ‰¿å…³ç³»çš„ä¸€ç§æ›¿ä»£æ–¹æ¡ˆä¹‹ä¸€ã€‚</p>
<p>é€šè¿‡è£…é¥°è€…æ¨¡å¼å¯ä»¥åŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ ä¸€äº›é¢å¤–çš„èŒè´£ã€‚å°±å¢åŠ åŠŸèƒ½è€Œè¨€ï¼Œè£…é¥°æ¨¡å¼ç›¸æ¯”ç”Ÿæˆå­ç±»æ›´çµæ´»ã€‚å› ä¸ºå®ƒè£…é¥°è€…æŒæœ‰ä¸€ä¸ªè¢«è£…é¥°è€…çš„å¼•ç”¨ï¼Œå› æ­¤å¯ä»¥æ–¹ä¾¿åœ°è°ƒç”¨å…·ä½“è¢«è£…é¥°è€…å¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸ç ´ååŸç±»å±‚æ¬¡ç»“æ„çš„æƒ…å†µä¸‹ä¸ºç±»å¢åŠ ä¸€äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¢«è£…é¥°è€…å¯¹è±¡çš„ç›¸åº”æ–¹æ³•å‰åå¢åŠ ç›¸åº”çš„åŠŸèƒ½é€»è¾‘å³å¯ã€‚</p>
<a id="more"></a>
<h2 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><p>éœ€è¦é€æ˜ä¸”åŠ¨æ€åœ°æ‹“å±•ç±»çš„åŠŸèƒ½æ—¶ã€‚</p>
<h2 id="UML-ç±»å›¾"><a href="#UML-ç±»å›¾" class="headerlink" title="UML ç±»å›¾"></a>UML ç±»å›¾</h2><p><img src="https://user-images.githubusercontent.com/16668676/30046081-a4423c2c-923a-11e7-9dad-170e000c5ece.png" alt="decorator uml"></p>
<ul>
<li>Component  æŠ½è±¡ç»„ä»¶<ul>
<li>å¯ä»¥æ˜¯æ¥å£æˆ–è€…æŠ½è±¡ç±»ï¼Œå……å½“ä¸€ä¸ªè¢«è£…é¥°çš„åŸå§‹å¯¹è±¡ã€‚ï¼ˆåœ¨è¯¥æ¨¡å¼ä¸­ä½äºç»§æ‰¿ç»“æ„çš„é¡¶éƒ¨ï¼Œå¤§å®¶éƒ½ç›´æ¥/é—´æ¥åœ°ç»§æ‰¿å®ƒï¼‰</li>
</ul>
</li>
<li>ConcreteComponent ç»„ä»¶å…·ä½“å®ç°ç±»<ul>
<li>è¯¥ç±»æ˜¯ Component ç±»çš„å…·ä½“å®ç°ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬è£…é¥°çš„å…·ä½“å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>Decorator  æŠ½è±¡è£…é¥°è€…<ul>
<li>ç»§æ‰¿è‡ª Component å¹¶ä¸”<strong>å¿…é¡»æŒæœ‰ä¸€ä¸ªæŒ‡å‘ Component çš„å¼•ç”¨</strong></li>
<li>é€šå¸¸ä¼šåœ¨å…¶æ–¹æ³•ä¸­è°ƒç”¨ ConcreteComponent çš„æ–¹æ³•ã€‚</li>
<li>å¦‚æœè£…é¥°é€»è¾‘å•ä¸€ï¼Œå¯ä»¥ç›´æ¥çœç•¥è¯¥ç±»ï¼Œç›´æ¥å†™ä¸€ä¸ªå…·ä½“çš„è£…é¥°è€…å¯¹è±¡å³å¯ã€‚</li>
</ul>
</li>
<li>ConcreteDecoratorA,B,C<ul>
<li>ç»§æ‰¿è‡ª Decorationï¼Œ åœ¨çˆ¶ç±»å¯¹ Component çš„æ–¹æ³•è°ƒç”¨åŸºç¡€ä¸Šä¸Šï¼Œå¢åŠ è‡ªå·±çš„ä¸€äº›åŠŸèƒ½ã€‚ï¼ˆé€šå¸¸éƒ½æ˜¯åœ¨åŸºç¡€æ–¹æ³•æ‰§è¡Œå‰æˆ–è€…åè°ƒç”¨è‡ªå·±æ–°å¢çš„æ–¹æ³•ï¼‰</li>
</ul>
</li>
</ul>
<p>ä½¿ç”¨æ—¶ç»å¸¸ä¼šæŠŠ ComponentImpl æˆ–è€…è¯´ ConcreteComponent ä¼ å…¥ç»™å…·ä½“çš„ Decoratorã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Compoent component = <span class="keyword">new</span> ConponentImpl();</div><div class="line">DecoratorImpl decoratorImpl = <span class="keyword">new</span> DecoratorImpl(component);</div><div class="line">decoratorImpl.xxOperation();</div></pre></td></tr></table></figure>
<h2 id="Android-æºç ä¸­çš„æ¨¡å¼å®ç°"><a href="#Android-æºç ä¸­çš„æ¨¡å¼å®ç°" class="headerlink" title="Android æºç ä¸­çš„æ¨¡å¼å®ç°"></a>Android æºç ä¸­çš„æ¨¡å¼å®ç°</h2><p><img src="https://user-images.githubusercontent.com/16668676/30047048-b4aeb6e2-9241-11e7-9a04-b11bb1acdc44.png" alt="context"></p>
<p>è§’è‰²ç®€ä»‹ï¼š</p>
<ul>
<li>Context ï¼šæŠ½è±¡ç»„ä»¶</li>
<li>ComtextImpl ï¼šContext çš„å…·ä½“å®ç°ç±»</li>
<li>ContextWrapper ï¼šè£…é¥°è€…çš„çˆ¶ç±»ï¼ˆå…¶ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½åªæ˜¯è°ƒç”¨äº† ContextImpl ä¸­å¯¹åº”çš„æ–¹æ³•ï¼‰</li>
<li>ContextThemeWrapper ï¼šç»§æ‰¿è‡ª ContextWrapper  çš„è£…é¥°è€…</li>
<li>Activity ï¼šç»§æ‰¿è‡ª ContextThemeWrapper çš„è£…é¥°è€…</li>
</ul>
<p>æˆ‘ä»¬ä»¥å¸¸ç”¨çš„æ–¹æ³•ä¸ºä¾‹ï¼Œçœ‹çœ‹è£…é¥°è€…æ¨¡å¼åœ¨å…¶ä¸­çš„å…·ä½“å®ç°æ–¹å¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextWrapper</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</div><div class="line">    Context mBase;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ContextWrapper</span><span class="params">(Context base)</span> </span>&#123;</div><div class="line">        mBase = base;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="comment">//å¯åŠ¨ Activity</span></div><div class="line">   <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, Bundle options)</span> </span>&#123;</div><div class="line">        mBase.startActivity(intent, options);</div><div class="line">    &#125;</div><div class="line">  	</div><div class="line">    <span class="comment">//å‘é€å¹¿æ’­</span></div><div class="line">    <span class="meta">@SystemApi</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendBroadcast</span><span class="params">(Intent intent, String receiverPermission, Bundle options)</span> </span>&#123;</div><div class="line">        mBase.sendBroadcast(intent, receiverPermission, options);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">//æ³¨å†Œç›‘å¬å™¨</span></div><div class="line">      <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(</span></span></div><div class="line">        BroadcastReceiver receiver, IntentFilter filter) &#123;</div><div class="line">        <span class="keyword">return</span> mBase.registerReceiver(receiver, filter);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä»¥ä¸Šçš„ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼ŒContextWrapper ä½œä¸ºè£…é¥°è€…çš„çˆ¶ç±»ï¼ŒæŒæœ‰ Context çš„å¼•ç”¨ mBaseï¼ˆmBase çš„å®é™…ç±»å‹ä¸º ContextImplï¼‰ï¼Œå…¶ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½åªæ˜¯è°ƒç”¨äº† ContextImpl ä¸­å¯¹åº”çš„æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextImpl</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</div><div class="line">     <span class="comment">//å¯åŠ¨ Activity çš„é€»è¾‘å®ç°</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        warnIfCallingFromSystemProcess();</div><div class="line">        startActivity(intent, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, Bundle options)</span> </span>&#123;</div><div class="line">        warnIfCallingFromSystemProcess();</div><div class="line"></div><div class="line">        <span class="comment">// ä»£ç çœç•¥</span></div><div class="line">        <span class="comment">//è°ƒç”¨ Instrumentation.execStartActivity() æ–¹æ³•</span></div><div class="line">        mMainThread.getInstrumentation().execStartActivity(</div><div class="line">                getOuterContext(), mMainThread.getApplicationThread(), <span class="keyword">null</span>,</div><div class="line">                (Activity) <span class="keyword">null</span>, intent, -<span class="number">1</span>, options);</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendBroadcast</span><span class="params">(Intent intent, String receiverPermission)</span> </span>&#123;</div><div class="line">        warnIfCallingFromSystemProcess();</div><div class="line">        String resolvedType = intent.resolveTypeIfNeeded(getContentResolver());</div><div class="line">        String[] receiverPermissions = receiverPermission == <span class="keyword">null</span> ? <span class="keyword">null</span></div><div class="line">                : <span class="keyword">new</span> String[] &#123;receiverPermission&#125;;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            intent.prepareToLeaveProcess(<span class="keyword">this</span>);</div><div class="line">          	<span class="comment">//è°ƒç”¨ AMS çš„ broadcastIntent æ–¹æ³•</span></div><div class="line">            ActivityManagerNative.getDefault().broadcastIntent(</div><div class="line">                    mMainThread.getApplicationThread(), intent, resolvedType, <span class="keyword">null</span>,</div><div class="line">                    Activity.RESULT_OK, <span class="keyword">null</span>, <span class="keyword">null</span>, receiverPermissions, AppOpsManager.OP_NONE,</div><div class="line">                    <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, getUserId());</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//æ³¨å†Œå¹¿æ’­çš„æ–¹æ³•</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(BroadcastReceiver receiver, IntentFilter filter)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> registerReceiver(receiver, filter, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">    &#125;  </div><div class="line">   <span class="comment">//æ³¨å†Œå¹¿æ’­</span></div><div class="line">  	<span class="meta">@Override</span></div><div class="line">  	<span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(BroadcastReceiver receiver, IntentFilter filter,</span></span></div><div class="line">            String broadcastPermission, Handler scheduler) &#123;</div><div class="line">        <span class="keyword">return</span> registerReceiverInternal(receiver, getUserId(),</div><div class="line">                filter, broadcastPermission, scheduler, getOuterContext());</div><div class="line">    &#125;</div><div class="line">   <span class="comment">//æ³¨å†Œå¹¿æ’­çš„å…·ä½“å®ç°</span></div><div class="line">    <span class="function"><span class="keyword">private</span> Intent <span class="title">registerReceiverInternal</span><span class="params">(BroadcastReceiver receiver, <span class="keyword">int</span> userId,</span></span></div><div class="line">            IntentFilter filter, String broadcastPermission,</div><div class="line">            Handler scheduler, Context context) &#123;</div><div class="line">        IIntentReceiver rd = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (receiver != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span> &amp;&amp; context != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</div><div class="line">                    scheduler = mMainThread.getHandler();</div><div class="line">                &#125;</div><div class="line">                rd = mPackageInfo.getReceiverDispatcher(</div><div class="line">                    receiver, context, scheduler,</div><div class="line">                    mMainThread.getInstrumentation(), <span class="keyword">true</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</div><div class="line">                    scheduler = mMainThread.getHandler();</div><div class="line">                &#125;</div><div class="line">                rd = <span class="keyword">new</span> LoadedApk.ReceiverDispatcher(</div><div class="line">                        receiver, context, scheduler, <span class="keyword">null</span>, <span class="keyword">true</span>).getIIntentReceiver();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          	<span class="comment">//è°ƒç”¨ AMS çš„ registerReceiver æ–¹æ³•</span></div><div class="line">            <span class="keyword">final</span> Intent intent = ActivityManagerNative.getDefault().registerReceiver(</div><div class="line">                    mMainThread.getApplicationThread(), mBasePackageName,</div><div class="line">                    rd, filter, broadcastPermission, userId);</div><div class="line">            <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</div><div class="line">                intent.setExtrasClassLoader(getClassLoader());</div><div class="line">                intent.prepareToEnterProcess();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> intent;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒContextImpl ä¸­æä¾›äº†å…·ä½“çš„æ–¹æ³•å®ç°ã€‚</p>
<p>ContextWrapper çš„å­ç±»ï¼Œä¾‹å¦‚ Activity ä¼šæ ¹æ®éœ€è¦å¯¹å…·ä½“æ–¹æ³•çš„å®ç°è¿›è¡Œè£…é¥°æˆ–è€…ä¿®æ”¹ã€‚</p>
<p>æ¯”å¦‚ startActivity() æ–¹æ³•ï¼ŒActivity æ²¡æœ‰ä½¿ç”¨è¢«è£…é¥°è€…çš„å®ç°ï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº†ä¸€å¥—é€»è¾‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activity</span> <span class="keyword">extends</span> <span class="title">ContextThemeWrapper</span></span></div><div class="line">        <span class="keyword">implements</span> <span class="title">LayoutInflater</span>.<span class="title">Factory2</span>,</div><div class="line">        <span class="title">Window</span>.<span class="title">Callback</span>, <span class="title">KeyEvent</span>.<span class="title">Callback</span>,</div><div class="line">        <span class="title">OnCreateContextMenuListener</span>, <span class="title">ComponentCallbacks2</span>,</div><div class="line">        <span class="title">Window</span>.<span class="title">OnWindowDismissedCallback</span>, <span class="title">WindowControllerCallback</span> &#123;</div><div class="line">        </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">         <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">                startActivityForResult(intent, -<span class="number">1</span>, options);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Note we want to go through this call for compatibility with</span></div><div class="line">                <span class="comment">// applications that may have overridden the method.</span></div><div class="line">                startActivityForResult(intent, -<span class="number">1</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;   </div><div class="line">             </div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,@Nullable Bundle options)</span> </span>&#123;</div><div class="line">              <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</div><div class="line">                  options = transferSpringboardActivityOptions(options);</div><div class="line">                  <span class="comment">//è°ƒç”¨ Instrumentation.execStartActivity() æ–¹æ³•</span></div><div class="line">                  Instrumentation.ActivityResult ar =</div><div class="line">                      mInstrumentation.execStartActivity(</div><div class="line">                          <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</div><div class="line">                          intent, requestCode, options);</div><div class="line">                <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ContextImpl-çš„åˆ›å»º"><a href="#ContextImpl-çš„åˆ›å»º" class="headerlink" title="ContextImpl çš„åˆ›å»º"></a>ContextImpl çš„åˆ›å»º</h2><p>ä»ä¸Šé¢è§£æä¸­æˆ‘ä»¬çŸ¥é“ Context çš„å®ç°ä¸­ä½¿ç”¨äº†è£…é¥°è€…æ¨¡å¼ä¹ŸçŸ¥é“äº† ContextImpl æ˜¯ Context å…·ä½“å®ç°ç±»ï¼Œä½†æ˜¯ ContextImpl æ˜¯åœ¨ä¸Šé¢åœ°æ–¹è¢«åˆå§‹åŒ–çš„å‘¢ï¼Ÿ</p>
<p>å› ä¸º Activity å¯åŠ¨ä¹‹åæˆ‘ä»¬ä¾¿å¯ä»¥è°ƒç”¨ Context ä¸­çš„æ–¹æ³•äº†ï¼Œæˆ‘ä»¬çŒœæƒ³ ContextImpl æ˜¯åœ¨ Activity åˆ›å»ºè¿‡ç¨‹ä¸­åˆå§‹åŒ–çš„ã€‚</p>
<p>å¯¹ Android Framework å±‚æœ‰æ‰€äº†è§£åŒå­¦åº”è¯¥çŸ¥é“ Activity æ˜¯ç”± AMS ç®¡ç†çš„ï¼ŒAMS ä¼šé€šè¿‡è°ƒç”¨ ApplicationThread ä¸é—´æ¥åœ°æ§åˆ¶ Activityã€‚ ApplicationThread çš„ scheduleXxx æ–¹æ³•ä¸­ä¼šè°ƒç”¨ sendMessage æ–¹æ³•å°†ç›¸åº”çš„ Message å‘é€ç»™ Hï¼ŒH æ ¹æ®ä¸åŒçš„ Message è°ƒç”¨ ActivityThread ä¸­ç›¸åº”çš„ handleXxx æ–¹æ³•ã€‚</p>
<p>ActivityThread#H</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">	<span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">        <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">            <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</div><div class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</div><div class="line">                <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</div><div class="line">                r.packageInfo = getPackageInfoNoCheck(</div><div class="line">                        r.activityInfo.applicationInfo, r.compatInfo);</div><div class="line">              	<span class="comment">//è°ƒç”¨ handleLaunchActivity</span></div><div class="line">                handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</div><div class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">            &#125; <span class="keyword">break</span>;       </div><div class="line">    <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“éœ€è¦å¯åŠ¨æ–°çš„ Activity æ—¶ï¼ŒApplicationThread çš„  scheduleLaunchActivity æ–¹æ³•ä¼šå…ˆè¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•ä¼šé€šè¿‡ H è°ƒç”¨ handleLaunchActivity æ–¹æ³•ï¼Œè€Œ handleLaunchActivity æ–¹æ³•åˆä¼šè°ƒç”¨  performLaunchActivity æ–¹æ³•ã€‚</p>
<p>ActivityThread#performLaunchActivity </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    Activity activity = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">      	<span class="comment">//åˆ›å»º Activity</span></div><div class="line">        activity = mInstrumentation.newActivity(</div><div class="line">                cl, component.getClassName(), r.intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">          	<span class="comment">//è·å– Context</span></div><div class="line">            Context appContext = createBaseContextForActivity(r, activity);</div><div class="line">			<span class="comment">//å°†å‰é¢å‡†å¤‡çš„å€¼å…³è”åˆ° Activity ä¸­</span></div><div class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</div><div class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                    r.referrer, r.voiceInteractor, window);</div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> activity;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ActivityThread#createBaseContextForActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Context <span class="title">createBaseContextForActivity</span><span class="params">(ActivityClientRecord r, <span class="keyword">final</span> Activity activity)</span> </span>&#123;</div><div class="line">    ContextImpl appContext = ContextImpl.createActivityContext(<span class="comment">//è°ƒç”¨ ContextImpl çš„é™æ€æ–¹æ³•åˆ›å»º Activity Context</span></div><div class="line">            <span class="keyword">this</span>, r.packageInfo, r.token, displayId, r.overrideConfig);</div><div class="line">    appContext.setOuterContext(activity);<span class="comment">//å¤–éƒ¨çš„ contextï¼ˆæ­¤å¤„ä¸º Activityï¼‰è®¾ç½®ç»™ ContextImpl</span></div><div class="line">    Context baseContext = appContext;</div><div class="line">	<span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    <span class="keyword">return</span> baseContext;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ContextImpl#createActivityContext()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createActivityContext</span><span class="params">(ActivityThread mainThread,</span></span></div><div class="line">        LoadedApk packageInfo, IBinder activityToken, <span class="keyword">int</span> displayId,</div><div class="line">        Configuration overrideConfiguration) &#123;</div><div class="line">    <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"packageInfo"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread, packageInfo, activityToken, <span class="keyword">null</span>, <span class="number">0</span>,</div><div class="line">            <span class="keyword">null</span>, overrideConfiguration, displayId);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼ŒActivity çš„ Context æ˜¯åœ¨ performLaunchActivity æ–¹æ³•ä¸­é€šè¿‡è°ƒç”¨ createBaseContextForActivity  åˆå§‹åŒ–çš„ã€‚åœ¨ createBaseContextForActivity æ–¹æ³•ä¸­ï¼Œé€šè¿‡è°ƒç”¨ ContextImpl çš„é™æ€æ–¹æ³• createActivityContext åˆ›å»º è·å–ä¸€ä¸ª ContextImpl çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶é€šè¿‡ setOuterContext æ–¹æ³•å°†ä¸¤è€…å»ºç«‹å…³è”ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å­¦è¿‡ä»£ç†æ¨¡å¼çš„åŒå­¦å¯èƒ½è§‰å¾—è£…é¥°æ¨¡å¼ä¸ä»£ç†æ¨¡å¼æœ‰ç‚¹åƒï¼ˆå› ä¸ºåŒæ ·æŒæœ‰å¼•ç”¨ï¼‰ã€‚ä½†æ˜¯æ—¢ç„¶æ˜¯å®ƒä»¬æ˜¯ä¸¤ä¸ªä¸åŒçš„è®¾è®¡æ¨¡å¼ï¼Œå…ˆçœ‹çœ‹å®ƒä»¬å„è‡ªçš„å®šä¹‰ã€‚</p>
<p>è£…é¥°æ¨¡å¼ï¼šä»¥å¯¹å®¢æˆ·ç«¯é€æ˜çš„æ–¹å¼<strong>æ‰©å±•å¯¹è±¡çš„åŠŸèƒ½</strong>ï¼Œæ˜¯<strong>ç»§æ‰¿å…³ç³»çš„ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆ</strong>ï¼›<br>ä»£ç†æ¨¡å¼ï¼šç»™ä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¹¶<strong>ç”±ä»£ç†å¯¹è±¡æ¥æ§åˆ¶å¯¹åŸæœ‰å¯¹è±¡çš„å¼•ç”¨</strong>ï¼›</p>
<p>å…‰çœ‹å®šä¹‰å¯èƒ½è¿˜æ˜¯æ¯”è¾ƒæ¨¡ç³Šã€‚äºŒè€…<strong>åŒºåˆ«</strong>åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
<ul>
<li>è£…é¥°æ¨¡å¼åº”è¯¥ä¸ºæ‰€è£…é¥°çš„å¯¹è±¡<strong>å¢å¼ºåŠŸèƒ½</strong></li>
<li>ä»£ç†æ¨¡å¼å¯¹ä»£ç†çš„å¯¹è±¡æ–½åŠ æ§åˆ¶ï¼Œä½†<strong>ä¸å¯¹å¯¹è±¡æœ¬èº«çš„åŠŸèƒ½è¿›è¡Œå¢å¼º</strong>ã€‚</li>
</ul>
<p>å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºï¼šä½ åœ¨ä¸€ä¸ªåœ°æ–¹å†™è£…é¥°ï¼Œå¤§å®¶å°±çŸ¥é“è¿™æ˜¯åœ¨å¢åŠ åŠŸèƒ½ï¼Œä½ å†™ä»£ç†ï¼Œå¤§å®¶å°±çŸ¥é“æ˜¯åœ¨é™åˆ¶ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li>ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹</li>
</ul>
]]></content>
      
        <categories>
            
            <category> åŸç†åˆ†æ </category>
            
            <category> Android è¿›é˜¶ </category>
            
            <category> è®¾è®¡æ¨¡å¼ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> Android è¿›é˜¶ </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android æºç ä¸­çš„äº«å…ƒæ¨¡å¼â€”â€”Message å¤ç”¨åŸç†]]></title>
      <url>https://timlin-pro.github.io/blog/2017/08/26/Android-%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94Message%E5%A4%8D%E7%94%A8%E6%9C%BA%E5%88%B6/</url>
      <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>äº«å…ƒæ¨¡å¼æ˜¯å¯¹è±¡æ± çš„ä¸€ç§å®ç°ï¼Œå®ƒçš„è‹±æ–‡åä¸º Flyweightï¼Œä»£è¡¨è½»é‡çº§çš„æ„æ€ã€‚</p>
<p>äº«å…ƒæ¨¡å¼ç”¨æ¥å°½å¯èƒ½==å‡å°‘å†…å­˜ä½¿ç”¨é‡==ï¼Œå®ƒé€‚åˆç”¨äºå¯èƒ½å­˜åœ¨å¤§é‡å¯¹è±¡çš„åœºæ™¯ï¼Œæ¥==ç¼“å­˜å¯å…±äº«çš„å¯¹è±¡==ï¼ˆä¾‹å¦‚ Messageã€Java ä¸­çš„å­—ç¬¦ä¸²å¸¸é‡æ± ï¼‰,ä»è€Œå®ç°å¯¹è±¡å…±äº«ã€é¿å…åˆ›å»ºè¿‡å¤šå¯¹è±¡çš„æ•ˆæœï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥æå‡æ€§èƒ½ï¼Œé¿å…å†…å­˜ç§»é™¤ç­‰ã€‚</p>
<p>äº«å…ƒæ¨¡å¼ä¸­çš„éƒ¨åˆ†çŠ¶æ€æ˜¯å¯ä»¥å…±äº«çš„ï¼Œ</p>
<ul>
<li>å¯ä»¥å…±äº«çš„çŠ¶æ€ç§°ä¸º<strong>å†…éƒ¨çŠ¶æ€</strong>ã€‚å†…éƒ¨çŠ¶æ€ä¸ä¼šéšç€ç¯å¢ƒå˜åŒ–</li>
<li>ä¸å¯å…±äº«çš„çŠ¶æ€åˆ™ç§°ä¹‹ä¸º<strong>å¤–éƒ¨çŠ¶æ€</strong>ï¼Œä»–ä»¬ä¼šéšç€ç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜ã€‚</li>
</ul>
<p>äº«å…ƒæ¨¡å¼ä¼šå»ºç«‹ä¸€ä¸ª<strong>å¯¹è±¡å®¹å™¨</strong>ï¼Œåœ¨ç»å…¸çš„äº«å…ƒæ¨¡å¼ä¸­ï¼Œè¯¥å®¹å™¨ä¸ºä¸€ä¸ª Mapï¼Œå®ƒçš„é”®æ˜¯äº«å…ƒå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå®ƒçš„å€¼å°±æ˜¯äº«å…ƒå¯¹è±¡æœ¬èº«ã€‚</p>
<a id="more"></a>
<h2 id="äº«å…ƒæ¨¡å¼çš„å®šä¹‰"><a href="#äº«å…ƒæ¨¡å¼çš„å®šä¹‰" class="headerlink" title="äº«å…ƒæ¨¡å¼çš„å®šä¹‰"></a>äº«å…ƒæ¨¡å¼çš„å®šä¹‰</h2><p>äº«å…ƒæ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œä»¥å…±äº«çš„æ–¹å¼é«˜æ•ˆåœ°æ”¯æŒå¤§é‡çš„ç»†ç²’åº¦å¯¹è±¡ã€‚</p>
<h2 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><ol>
<li>ç³»ç»Ÿä¸­å­˜åœ¨<strong>å¤§é‡çš„ç›¸ä¼¼å¯¹è±¡</strong></li>
<li>ç»†ç²’åº¦çš„å¯¹è±¡éƒ½å…·å¤‡è¾ƒæ¥è¿‘çš„å¤–éƒ¨çŠ¶æ€ï¼Œè€Œä¸”å†…éƒ¨çŠ¶æ€ä¸ç¯å¢ƒæ— å…³ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹è±¡æ²¡æœ‰ç‰¹å®šèº«ä»½ã€‚</li>
<li>éœ€è¦<strong>ç¼“å†²æ± </strong>çš„åœºæ™¯ã€‚</li>
</ol>
<h2 id="UML-ç±»å›¾"><a href="#UML-ç±»å›¾" class="headerlink" title="UML ç±»å›¾"></a>UML ç±»å›¾</h2><p><img src="https://user-images.githubusercontent.com/16668676/29702859-ac3f4f5c-89a5-11e7-92cd-2c26051b399f.png" alt="flyweight uml"></p>
<ul>
<li><strong>Flyweight</strong> ï¼šäº«å…ƒå¯¹è±¡æŠ½è±¡åŸºç±»æˆ–è€…æ¥å£ã€‚</li>
<li><strong>ConcreteFlyweight</strong>ï¼šå…·ä½“äº«å…ƒå¯¹è±¡ã€‚</li>
<li><strong>FlyweightFactory</strong> ï¼šäº«å…ƒå·¥å‚ï¼Œè´Ÿè´£åˆ›å»ºäº«å…ƒå¯¹è±¡å’Œç®¡ç†äº«å…ƒå¯¹è±¡æ± ã€‚</li>
</ul>
<h2 id="Android-æºç ä¸­çš„äº«å…ƒæ¨¡å¼"><a href="#Android-æºç ä¸­çš„äº«å…ƒæ¨¡å¼" class="headerlink" title="Android æºç ä¸­çš„äº«å…ƒæ¨¡å¼"></a>Android æºç ä¸­çš„äº«å…ƒæ¨¡å¼</h2><p>åœ¨ä½¿ç”¨ Handler å‘é€æ¶ˆæ¯ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šä½¿ç”¨å¦‚ä¸‹ä»£ç è°ƒç”¨ <code>mHandler.obtainMessage()</code> æ–¹æ³•è·å–ä¸€ä¸ª Message å¯¹è±¡ã€‚è¿™å…¶ä¸­ç©¶ç«Ÿæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Handler mHandler = <span class="keyword">new</span> Handler();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">do</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">//do sth</span></div><div class="line">            Message message = mHandler.obtainMessage();</div><div class="line">            message.what = <span class="number">1</span>;</div><div class="line">            message.obj = result;</div><div class="line">            mHandler.sendMessage(message);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Handler.otainMessage()æ–¹æ³•</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Message <span class="title">obtainMessage</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> Message.obtain(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° Handler.obtainMessage() å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ Message çš„ obtain æ–¹æ³•ï¼Œæˆ‘ä»¬é¡ºç€æºç çœ‹ä¸‹å»ã€‚</p>
<p>å…ˆçœ‹çœ‹ Message ç±»éƒ¨åˆ†æºç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// sometimes we store linked lists of these things</span></div><div class="line">Message next;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object sPoolSync = <span class="keyword">new</span> Object();<span class="comment">//ä½œä¸ºé”å¯¹è±¡</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Message sPool;<span class="comment">//è™½ç„¶åç§°ä¸º sPool ä½†æ˜¯å®é™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘æ¶ˆæ¯é˜Ÿåˆ—é˜Ÿé¦–çš„æŒ‡é’ˆ</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> sPoolSize = <span class="number">0</span>;<span class="comment">//</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_POOL_SIZE = <span class="number">50</span>;<span class="comment">//ã€Œå¯¹è±¡æ± ã€ä¸­çš„æœ€å¤§æ•°é‡</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title">obtain</span><span class="params">(Handler h)</span> </span>&#123;</div><div class="line">    Message m = obtain();<span class="comment">//è°ƒç”¨ obtain æ–¹æ³•è·å– message å¯¹è±¡</span></div><div class="line">    m.target = h;<span class="comment">//æŒ‡å®š message çš„ç›®æ ‡å¯¹è±¡</span></div><div class="line">    <span class="keyword">return</span> m;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ä»æ¶ˆæ¯å¯¹è±¡æ± ä¸­å–å‡ºä¸€ä¸ª Message å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ª</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title">obtain</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (sPoolSync) &#123;</div><div class="line">        <span class="keyword">if</span> (sPool != <span class="keyword">null</span>) &#123;</div><div class="line">            Message m = sPool;</div><div class="line">            sPool = m.next;</div><div class="line">            m.next = <span class="keyword">null</span>;</div><div class="line">            m.flags = <span class="number">0</span>; <span class="comment">// æ¸…ç©º in-use flag</span></div><div class="line">            sPoolSize--;</div><div class="line">            <span class="keyword">return</span> m;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Message();<span class="comment">//æ¶ˆæ¯æ± ä¸­æ²¡æœ‰å¯å¤ç”¨çš„ Message å°±åˆ›å»ºä¸€ä¸ªæ–°çš„ Message</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œä»å¯¹è±¡æ± ä¸­è·å–å¯¹è±¡çš„å¤§è‡´æµç¨‹ã€‚æ— è®ºæ˜¯ Handler.obtainMessage(å‚æ•°åˆ—è¡¨) æ–¹æ³•ï¼Œè¿˜æ˜¯ Message çš„ obtain(å‚æ•°åˆ—è¡¨) æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨ Message.obtain() æ–¹æ³•ã€‚åœ¨ Message.obtain() æ–¹æ³•çš„å®ç°ä¸­ï¼Œä¼šå…ˆä»å¯¹è±¡æ± ä¸­è·å– Message å¯¹è±¡ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ Message å¯¹è±¡ï¼Œç„¶åè¿”å›ã€‚è¯¥å¯¹è±¡åœ¨åç»­çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šè¢«å›æ”¶åˆ°å¯¹è±¡æ± ï¼Œä»¥ä¾¿å¤ç”¨ã€‚</p>
<p>ä½†æ˜¯ Message å¯¹è±¡æ˜¯å¦‚ä½•è¢«å›æ”¶åˆ°ã€Œå¯¹è±¡æ± ã€ä¸­çš„å‘¢ï¼Ÿ    ä» Message ç±»çš„éƒ¨åˆ†ä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ° sPool çš„å®é™…ç±»å‹æ˜¯ä¸€ä¸ª Message å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå®¹å™¨ã€‚å¦å¤–ä» obtain æ–¹æ³•ä¸­æˆ‘ä»¬ä¸éš¾çœ‹åˆ°é“¾è¡¨çš„è¸ªå½±ã€‚éš¾é“æ¶ˆæ¯æ± æ˜¯ä½¿ç”¨é“¾è¡¨å®ç°çš„å—ï¼Ÿ</p>
<p>åœ¨ AS ä¸­æ‰“å¼€ Message ç±»çš„ç»“æ„å›¾ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ä¸€ä¸ª recycle æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹çœ‹é‡Œé¢æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isInUse()) &#123;<span class="comment">//åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è¿˜åœ¨ä½¿ç”¨</span></div><div class="line">        <span class="keyword">if</span> (gCheckRecycle) &#123;<span class="comment">//å¦‚æœæ¶ˆæ¯å¤„åœ¨ä½¿ç”¨çŠ¶æ€æ—¶è¢« gc å›æ”¶ï¼Œå°±æŠ›å‡ºå¼‚å¸¸</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"This message cannot be recycled because it "</span> + <span class="string">"is still in use."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span>;<span class="comment">//ç›´æ¥è¿”å›ï¼Œå–æ¶ˆå›æ”¶æ“ä½œ</span></div><div class="line">    &#125;</div><div class="line">    recycleUnchecked();<span class="comment">//è°ƒç”¨å›æ”¶æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * å›æ”¶ä¸€ä¸ªå¯èƒ½è¿˜åœ¨ä½¿ç”¨çš„å¯¹è±¡</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">recycleUnchecked</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// åªè¦è¯¥å¯¹è±¡è¿˜åœ¨å›æ”¶å¯¹è±¡æ± ä¸­ï¼Œå°±æ ‡è®°è¯¥å¯¹è±¡ä¸ºæ­£åœ¨ä½¿ç”¨çŠ¶æ€ã€‚</span></div><div class="line">    <span class="comment">// æ¸…ç©ºå…¶ä»–çŠ¶æ€</span></div><div class="line">    flags = FLAG_IN_USE;</div><div class="line">    what = <span class="number">0</span>;</div><div class="line">    arg1 = <span class="number">0</span>;</div><div class="line">    arg2 = <span class="number">0</span>;</div><div class="line">    obj = <span class="keyword">null</span>;</div><div class="line">    replyTo = <span class="keyword">null</span>;</div><div class="line">    sendingUid = -<span class="number">1</span>;</div><div class="line">    when = <span class="number">0</span>;</div><div class="line">    target = <span class="keyword">null</span>;</div><div class="line">    callback = <span class="keyword">null</span>;</div><div class="line">    data = <span class="keyword">null</span>;</div><div class="line">	<span class="comment">//å›æ”¶æ¶ˆæ¯åˆ°æ¶ˆæ¯æ± ä¸­</span></div><div class="line">    <span class="keyword">synchronized</span> (sPoolSync) &#123;</div><div class="line">        <span class="keyword">if</span> (sPoolSize &lt; MAX_POOL_SIZE) &#123;</div><div class="line">            next = sPool;</div><div class="line">            sPool = <span class="keyword">this</span>;</div><div class="line">            sPoolSize++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>recycle æ–¹æ³•é¦–å…ˆä¼šåˆ¤æ–­ Message å¯¹è±¡æ˜¯å¦å¤„åœ¨ä½¿ç”¨çŠ¶æ€ã€‚å¦‚æœå¤„åœ¨ä½¿ç”¨çŠ¶æ€ä¼šç›´æ¥è¿”å›ï¼ˆå¦‚æœæ­¤æ—¶ GC å›æ”¶è¯¥å¯¹è±¡ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œå¦åˆ™è°ƒç”¨ recycleUnchecked æ–¹æ³•ï¼Œå…·ä½“çš„å›æ”¶é€»è¾‘æ˜¯åœ¨ recycleUnchecked  æ–¹æ³•ä¸­å®ç°çš„ã€‚é¦–å…ˆä¼šæ ‡è®° Message å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œç„¶åæ¸…ç©ºå¯¹è±¡ä¸­çš„å…¶ä»–çŠ¶æ€ã€‚å°†æ¶ˆæ¯å­˜å…¥å›æ”¶æ± ï¼Œä¸»è¦æ˜¯é“¾è¡¨çš„æ“ä½œã€‚å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://user-images.githubusercontent.com/16668676/29739978-6c03d780-8a7e-11e7-8aad-3da3590c2ea1.png" alt="msg"></p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>Message é€šè¿‡åœ¨å†…éƒ¨æ„å»ºä¸€ä¸ªé“¾è¡¨æ¥ç»´æŠ¤ä¸€ä¸ªè¢«ä¼šå—åˆ°  Message å¯¹è±¡çš„å¯¹è±¡æ± ï¼Œå½“ç”¨æˆ·è°ƒç”¨ obtain æ–¹æ³•æ—¶ï¼Œä¼šä¼˜å…ˆä»æ± ä¸­è·å–ã€‚å¦‚æœæ± ä¸­æ²¡æœ‰å¯ä»¥å¤ç”¨çš„å¯¹è±¡å°±åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä½¿ç”¨å®Œä¹‹åï¼Œä¼šè¢«ç¼“å­˜åˆ°å¯¹è±¡æ± ä¸­ï¼Œå½“ä¸‹æ¬¡è°ƒç”¨ obtain æ–¹æ³•æ—¶ï¼Œä»–ä»¬å°±ä¼šè¢«å¤ç”¨ã€‚</p>
<p>æ­¤å¤„ Message æ‰®æ¼”äº†ä¸‰ä¸ªè§’è‰²ã€‚æ—¢æ˜¯ FlyWeight æŠ½è±¡ï¼Œåˆæ˜¯ ConcreteFlyWeight å¯¹è±¡ï¼ŒåŒæ—¶è¿˜æ‹…ä»» FlyWeightFactory è§’è‰²ï¼Œæ‰¿æ‹…ç€ç®¡ç†å¯¹è±¡æ± çš„èŒè´£ã€‚</p>
<p>æƒ³è¿›ä¸€æ­¥äº†è§£ Android æ¶ˆæ¯æœºåˆ¶çš„åŒå­¦å¯å‚è€ƒ<a href="https://ivanljt.github.io/blog/2017/04/28/Android-%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90/" target="_blank" rel="noopener">Android æ¶ˆæ¯æœºåˆ¶è§£æ</a>ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>äº«å…ƒæ¨¡å¼çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¤§å¹…åº¦é™ä½äº†å†…å­˜ä¸­å¯¹è±¡çš„æ•°é‡ã€‚ä»è€Œé™ä½äº†å†…å­˜çš„å ç”¨ï¼Œæé«˜äº†ç¨‹åºçš„æ€§èƒ½ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä½¿å¾—ç³»ç»Ÿæ›´åŠ å¤æ‚ã€‚ä¸ºäº†ä½¿åº”ç”¨èƒ½å¤Ÿå…±äº«ï¼Œéœ€è¦å°†ä¸€äº›çŠ¶æ€å¤–éƒ¨åŒ–ï¼Œè¿™ä½¿å¾—ç¨‹åºçš„é€»è¾‘å¤æ‚åŒ–ã€‚</li>
<li>äº«å…ƒæ¨¡å¼å°†çŠ¶æ€å¤–éƒ¨åŒ–ï¼Œè€Œè¯»å–å¤–éƒ¨çŠ¶æ€ä½¿å¾—<strong>è¿è¡Œæ—¶é—´ç¨å¾®å˜é•¿</strong></li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://www.cnblogs.com/java-my-life/archive/2012/04/26/2468499.html" target="_blank" rel="noopener">ã€ŠJAVA ä¸æ¨¡å¼ã€‹ä¹‹äº«å…ƒæ¨¡å¼</a></li>
<li>ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹</li>
<li><a href="https://ivanljt.github.io/blog/2017/04/28/Android-%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90/" target="_blank" rel="noopener">Android æ¶ˆæ¯æœºåˆ¶è§£æ</a></li>
</ul>
<p>è‹¥æœ¬æ–‡ä¸­æœ‰ä¸æ­£ç¡®çš„ç»“è®ºã€è¯´æ³•ï¼Œè¯·å¤§å®¶æŒ‡å‡ºï¼Œå…±åŒæ¢è®¨ï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢!</p>
]]></content>
      
        <categories>
            
            <category> åŸç†åˆ†æ </category>
            
            <category> Android è¿›é˜¶ </category>
            
            <category> è®¾è®¡æ¨¡å¼ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> Android è¿›é˜¶ </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android æºç ä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼â€”â€”AsyncTaskè§£æ]]></title>
      <url>https://timlin-pro.github.io/blog/2017/08/24/Android-%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F%E2%80%94%E2%80%94AsyncTask%E8%A7%A3%E6%9E%90/</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‡è®¾æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªç®—æ³•æ‰€éœ€çš„å…³é”®æ­¥éª¤ï¼Œå¹¶ç¡®å®šäº†è¿™äº›æ­¥éª¤çš„æ‰§è¡Œé¡ºåºï¼Œä½†æ˜¯ï¼Œ<strong>æŸäº›æ­¥éª¤çš„å…·ä½“å®ç°æ˜¯æœªçŸ¥çš„</strong>ï¼Œæˆ–è€…è¯´æŸäº›æ­¥éª¤çš„å®ç°æ˜¯ä¼š<strong>éšç€ç¯å¢ƒçš„å˜åŒ–è€Œæ”¹å˜çš„</strong>ã€‚<br>å°±å¥½åƒæ‰§è¡Œç¨‹åºçš„æµç¨‹ï¼š</p>
<ol>
<li>æ£€æŸ¥ä»£ç çš„æ­£ç¡®æ€§</li>
<li>é“¾æ¥ç›¸å…³ä»£ç </li>
<li>ç¼–è¯‘ç›¸å…³ä»£ç </li>
<li>æ‰§è¡Œç¨‹åº</li>
</ol>
<p>å¯¹äºä¸åŒçš„è¯­è¨€ï¼Œä¸Šè¿° 4 ä¸ªæ­¥éª¤éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯å®ƒä»¬çš„æ‰§è¡Œæµç¨‹æ˜¯å›ºå®šçš„ï¼Œè¿™ç±»é—®é¢˜çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯æˆ‘ä»¬ä»‹ç»çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€‚</p>
<a id="more"></a>
<h2 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„å®šä¹‰"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„å®šä¹‰" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„å®šä¹‰"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„å®šä¹‰</h2><p>å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„<strong>ç®—æ³•çš„æ¡†æ¶</strong>ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ï¼Œä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æ„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚</p>
<h2 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯</h2><ol>
<li>å¤šä¸ªå­ç±»æœ‰å…¬æœ‰çš„æ–¹æ³•ï¼Œå¹¶ä¸”é€»è¾‘åŸºæœ¬ç›¸åŒæ—¶ã€‚</li>
<li>é‡è¦ã€å¤æ‚çš„ç®—æ³•ï¼Œå¯ä»¥æŠŠæ ¸å¿ƒç®—æ³•è®¾è®¡ä¸ºæ¨¡æ¿æ–¹æ³•ï¼Œå‘¨è¾¹çš„ç›¸å…³ç»†èŠ‚åŠŸèƒ½åˆ™ç”±å„ä¸ªå­ç±»å®ç°ã€‚</li>
<li>é‡æ„æ—¶ï¼ŒæŠŠç›¸åŒçš„ä»£ç æŠ½å–åˆ°çˆ¶ç±»ä¸­ï¼Œç„¶åé€šè¿‡<strong>é’©å­æ–¹æ³•</strong>çº¦æŸå…¶è¡Œä¸ºã€‚</li>
</ol>
<h3 id="æ³¨ï¼šä½•è°“é’©å­æ–¹æ³•ï¼Ÿ"><a href="#æ³¨ï¼šä½•è°“é’©å­æ–¹æ³•ï¼Ÿ" class="headerlink" title="æ³¨ï¼šä½•è°“é’©å­æ–¹æ³•ï¼Ÿ"></a>æ³¨ï¼šä½•è°“é’©å­æ–¹æ³•ï¼Ÿ</h3><p>åŸºæœ¬æ–¹æ³•åˆå¯ä»¥åˆ†ä¸ºä¸‰ç§ï¼šæŠ½è±¡æ–¹æ³•ï¼ˆAbstract Methodï¼‰ã€å…·ä½“æ–¹æ³•ï¼ˆConcrete Methodï¼‰å’Œé’©å­æ–¹æ³•ï¼ˆHook Methodï¼‰ã€‚</p>
<p>è¿™æ˜¯ã€Šjavaä¸æ¨¡å¼ã€‹ä¹¦é‡Œçš„ä¸€ç§è¯´æ³•ï¼Œä¸‰ç§æ–¹æ³•ä¹Ÿæ˜¯åœ¨ä¹¦ä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼ä¸­æåŠåˆ°çš„ã€‚</p>
<p>å…ˆè¯´è¿™ä¸ªä¸‰ä¸ªæ–¹æ³•çš„åŸºæœ¬å®šä¹‰ï¼š</p>
<ul>
<li>æŠ½è±¡æ–¹æ³•ï¼šç”±æŠ½è±¡ç±»å£°æ˜ï¼Œç”±å…·ä½“å­ç±»å®ç°ã€‚åœ¨javaè¯­è¨€é‡Œä¸€ä¸ªæŠ½è±¡æ–¹æ³•ä»¥abstractå…³é”®å­—æ ‡ç¤ºå‡ºæ¥ã€‚</li>
<li>å…·ä½“æ–¹æ³•ï¼šç”±æŠ½è±¡ç±»å£°æ˜å¹¶å®ç°ï¼Œè€Œå­ç±»å¹¶ä¸å®ç°æˆ–è¦†ç›–ã€‚å…¶å®å°±æ˜¯<strong>ä¸€èˆ¬çš„æ–¹æ³•</strong>ï¼Œä½†æ˜¯ä¸éœ€è¦å­ç±»æ¥å®ç°ã€‚</li>
<li>é’©å­æ–¹æ³•ï¼šç”±æŠ½è±¡ç±»<strong>å£°æ˜å¹¶å®ç°</strong>ï¼Œè€Œå­ç±»ä¹Ÿä¼šåŠ ä»¥æ‰©å±•ã€‚é€šå¸¸æŠ½è±¡ç±»ç»™å‡ºçš„æ˜¯ä¸€ä¸ªç©ºçš„é’©å­æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•ä½“ä¸ºç©ºçš„æ–¹æ³•ï¼ˆä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦å®ç°éƒ¨åˆ†é€»è¾‘ï¼‰ã€‚å…¶å®å®ƒå’Œå…·ä½“æ–¹æ³•åœ¨ä»£ç ä¸Šæ²¡æœ‰åŒºåˆ«ï¼Œä¸è¿‡æ˜¯æ„è¯†ä¸Šçš„ä¸€ç§åŒºåˆ«ã€‚</li>
</ul>
<p>è¯¦è§<a href="https://www.the5fire.com/%E6%8A%BD%E8%B1%A1%E6%96%B9%E6%B3%95-%E5%85%B7%E4%BD%93%E6%96%B9%E6%B3%95-%E9%92%A9%E5%AD%90%E6%96%B9%E6%B3%95.html" target="_blank" rel="noopener">æŠ½è±¡æ–¹æ³• å…·ä½“æ–¹æ³• é’©å­æ–¹æ³•</a></p>
<h2 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„-UML-ç±»å›¾"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„-UML-ç±»å›¾" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ UML ç±»å›¾"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ UML ç±»å›¾</h2><p><img src="https://user-images.githubusercontent.com/16668676/29603702-be32185a-8817-11e7-95f3-9cf7ee08c644.png" alt="template method pattern"></p>
<ul>
<li>AbsTemplateï¼šæŠ½è±¡ç±»ï¼Œå®šä¹‰ä¸€å¥—ç®—æ³•æ¡†æ¶</li>
<li>ConcreteImplAï¼šå…·ä½“å®ç°ç±» A</li>
<li>ConcreteImplBï¼šå…·ä½“å®ç°ç±» B</li>
</ul>
<h2 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ç®€å•ç¤ºä¾‹"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ç®€å•ç¤ºä¾‹" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ç®€å•ç¤ºä¾‹"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ç®€å•ç¤ºä¾‹</h2><p>å®é™…ä¸Šæ˜¯å°è£…ä¸€ä¸ªå›ºå®šæµç¨‹ï¼Œå°±åƒæ˜¯ä¸€å¥—æ‰§è¡Œæ¨¡æ¿ä¸€æ ·ï¼Œç¬¬ä¸€æ­¥è¯¥åšä»€ä¹ˆï¼Œç¬¬äºŒæ­¥è¯¥åšä»€ä¹ˆéƒ½å·²ç»åœ¨æŠ½è±¡ç±»ä¸­å®šä¹‰å¥½ã€‚è€Œå­ç±»å¯ä»¥æœ‰ä¸åŒçš„ç®—æ³•å®ç°ï¼Œåœ¨æ¡†æ¶ä¸è¢«ä¿®æ”¹çš„æƒ…å†µä¸‹å®ç°æŸäº›æ­¥éª¤çš„ç®—æ³•æ›¿æ¢ã€‚</p>
<h2 id="Android-æºç ä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><a href="#Android-æºç ä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="headerlink" title="Android æºç ä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼"></a>Android æºç ä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h2><h3 id="AsyncTask"><a href="#AsyncTask" class="headerlink" title="AsyncTask"></a>AsyncTask</h3><p>ä½¿ç”¨è¿‡ AsyncTask çš„åŒå­¦éƒ½çŸ¥é“ï¼Œæˆ‘ä»¬è°ƒç”¨ execute ä¹‹åï¼Œï¼ˆå¦‚æœæ²¡æœ‰è°ƒç”¨ cancel æ–¹æ³•çš„è¯ï¼‰ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•ä¼šä¾æ¬¡æ‰§è¡Œï¼š</p>
<ul>
<li>onPreExecute</li>
<li>doInBackground </li>
<li>onPostExecute</li>
</ul>
<p>ä¸ºä»€ä¹ˆèƒ½è®©å®ƒä»¬ä¾æ¬¡æ‰§è¡Œå‘¢ï¼Ÿå…¶å†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿæˆ‘ä»¬çœ‹çœ‹æºç ï¼Œä¸€æ¢ç©¶ç«Ÿã€‚</p>
<p>é¦–å…ˆçœ‹çœ‹å¼‚æ­¥ä»»åŠ¡çš„å…¥å£æ–¹æ³• executeã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"> <span class="meta">@MainThread</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@MainThread</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></div><div class="line">        Params... params) &#123;</div><div class="line">    <span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</div><div class="line">        <span class="keyword">switch</span> (mStatus) &#123;</div><div class="line">            <span class="keyword">case</span> RUNNING:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                        + <span class="string">" the task is already running."</span>);</div><div class="line">            <span class="keyword">case</span> FINISHED:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                        + <span class="string">" the task has already been executed "</span></div><div class="line">                        + <span class="string">"(a task can be executed only once)"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mStatus = Status.RUNNING;</div><div class="line"></div><div class="line">    onPreExecute();</div><div class="line"></div><div class="line">    mWorker.mParams = params;</div><div class="line">    exec.execute(mFuture);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»¥ä¸Šä¸¤ä¸ªæ„é€ æ–¹æ³•ä¸­ä¸»è¦åšäº†å¦‚ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>çŠ¶æ€åˆ¤æ–­</li>
<li>åˆ¤æ–­ä¹‹åæ‰§è¡Œ <code>onPreExecute();</code></li>
<li>ä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡Œ mFuture<ul>
<li>ä»€ä¹ˆæ ·çš„çº¿ç¨‹æ± ï¼Ÿ<ul>
<li>é»˜è®¤ä¸º SerialExecutor å³å•çº¿ç¨‹çš„çº¿ç¨‹æ± </li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line">            Result result = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);<span class="comment">//è®¾ç½®è¿›ç¨‹ä¼˜å…ˆçº§</span></div><div class="line">                <span class="comment">//noinspection unchecked</span></div><div class="line">                result = doInBackground(mParams);<span class="comment">//è°ƒç”¨ doInBackground æ–¹æ³•</span></div><div class="line">                Binder.flushPendingCommands();</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable tr) &#123;</div><div class="line">                mCancelled.set(<span class="keyword">true</span>);</div><div class="line">                <span class="keyword">throw</span> tr;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                postResult(result);<span class="comment">//è°ƒç”¨ postResult æ–¹æ³•</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                postResultIfNotInvoked(get());<span class="comment">//ä»»åŠ¡å®Œæˆ</span></div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                android.util.Log.w(LOG_TAG, e);</div><div class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</div><div class="line">                        e.getCause());</div><div class="line">            &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</div><div class="line">                postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> WorkerRunnable&lt;Params, Result&gt; mWorker;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> FutureTask&lt;Result&gt; mFuture;</div></pre></td></tr></table></figure>
<ul>
<li>mWorker ç±»å‹ä¸º <code>WorkerRunnable&lt;Params, Result&gt;</code> ï¼Œ WorkerRunnable å®ç°äº† Callable</li>
<li>mFuture ç±»å‹ä¸º <code>FutureTask&lt;Result&gt;</code></li>
</ul>
<p>ç®€è€Œè¨€ä¹‹ï¼Œè¿™ä¸ª mFuture åŒ…è£…äº†è¿™ä¸ª mWorker å¯¹è±¡ï¼Œè€Œ mFuture æ˜¯åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ï¼Œä¼šè°ƒç”¨ mFuture çš„ run æ–¹æ³•ï¼Œè¯¥ run æ–¹æ³•ä¸­è°ƒç”¨äº† mWorker çš„ call æ–¹æ³•ï¼ŒmWorker çš„ call æ–¹æ³•åˆè°ƒç”¨äº† doInBackground æ–¹æ³•ï¼Œæ‰€ä»¥ doInBackground æ˜¯åœ¨å·¥ä½œçº¿ç¨‹æ‰§è¡Œçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postResultIfNotInvoked</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> wasTaskInvoked = mTaskInvoked.get();</div><div class="line">    <span class="keyword">if</span> (!wasTaskInvoked) &#123;</div><div class="line">        postResult(result);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>doInBackground</code> æ‰§è¡Œå®Œæˆåä¼šé€šè¿‡ <code>postResult(result)</code> æ–¹æ³•å°†ç»“æœä¼ é€’ç»™ä¸»çº¿ç¨‹ã€‚</p>
<ul>
<li><code>postResult(result)</code> å¯èƒ½é€šè¿‡ call æ–¹æ³•çš„ finally å—ç›´æ¥è°ƒç”¨æˆ–è€…é€šè¿‡ FutureTask ä¸­çš„ done æ–¹æ³•é‡Œé¢çš„ <code>postResultIfNotInvoked(get());</code> æ¥é—´æ¥è°ƒç”¨ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ <code>postResult(result)</code> æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">            <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</div><div class="line">    message.sendToTarget();</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Looper.getMainLooper());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">        <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">            <span class="keyword">case</span> MESSAGE_POST_RESULT:</div><div class="line">                <span class="comment">// è°ƒç”¨ AsyncTask çš„ finish æ–¹æ³•</span></div><div class="line">                result.mTask.finish(result.mData[<span class="number">0</span>]);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</div><div class="line">                result.mTask.onProgressUpdate(result.mData);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">        onCancelled(result);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        onPostExecute(result);</div><div class="line">    &#125;</div><div class="line">    mStatus = Status.FINISHED;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>postResult(result)</code>  æ–¹æ³•å°±æ˜¯é€šè¿‡å‘é€ä¸€æ¡æ¶ˆæ¯ï¼ˆmsg.what == MESSAGE_POST_RESULTï¼‰ç»™ sHandlerï¼ŒsHandler ä¸º InternalHanlderã€‚å½“ InternalHanlder æ¥æ”¶åˆ° MESSAGE_POST_RESULT æ—¶ï¼Œå°±ä¼šè°ƒç”¨ <code>result.mTask.finish(result.mData[0])</code> æ–¹æ³•ï¼Œresult çš„ç±»å‹ä¸º AsyncTaskResult</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTaskResult</span>&lt;<span class="title">Data</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">final</span> AsyncTask mTask;</div><div class="line">    <span class="keyword">final</span> Data[] mData;</div><div class="line"></div><div class="line">    AsyncTaskResult(AsyncTask task, Data... data) &#123;</div><div class="line">        mTask = task;</div><div class="line">        mData = data;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä» AsyncTaskResult çš„å…·ä½“å®ç°ä¸­å—ï¼Œæˆ‘ä»¬çŸ¥é“ mTask å°±æ˜¯ AsyncTaskï¼Œfinish æ–¹æ³•ä¸­åˆè°ƒç”¨äº† <code>onPostExecute</code> ï¼Œæ­¤æ—¶æ•´ä¸ªæ‰§è¡Œæµç¨‹å°±å®Œæˆäº†ã€‚</p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>execute æ–¹æ³•å†…éƒ¨å°è£…äº† onPreExecuteã€doInBackGroundã€onPostExecute è¿™ä¸ªé€»è¾‘æµç¨‹ã€‚<br>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å†è¦†å†™è¿™å‡ ä¸ªæ–¹æ³•ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡æ¥å®Œæˆè€—æ—¶çš„æ“ä½œåŠæ›´æ–° UIã€‚å®é™…ä¸Šå°±æ˜¯é€šè¿‡çº¿ç¨‹æ± æ¥æ‰§è¡Œè€—æ—¶çš„ä»»åŠ¡ï¼Œå¾—åˆ°ç»“æœä¹‹åï¼Œé€šè¿‡ Handler å°†ç»“æœä¼ é€’ç»™ UI çº¿ç¨‹æ‰§è¡Œã€‚</p>
<h3 id="Activity-çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°"><a href="#Activity-çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°" class="headerlink" title="Activity çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°"></a>Activity çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°</h3><p>é™¤äº† AsyncTask ä»¥å¤–ï¼ŒAndroid æºç ä¸­è¿˜æœ‰ä¸å°‘åœ°æ–¹æœ‰æ¨¡æ¿æ–¹æ³•çš„èº«å½±ï¼Œæ¯”å¦‚è¯´ Activity çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•â€”â€” onCreate ã€onStartã€onResume ç­‰ï¼Œéƒ½æ˜¯æŒ‰ç…§é¡ºåºè°ƒç”¨çš„ï¼Œæˆ‘ä»¬ä¼šåœ¨å¯¹åº”çš„æ–¹æ³•ä¸­æ‰§è¡Œåˆé€‚çš„æ“ä½œã€‚</p>
<p>å…¶å†…éƒ¨å®ç°æ¶‰åŠåˆ°è¿›ç¨‹é—´é€šä¿¡ï¼Œé™äºç¯‡å¹…ï¼Œæœ¬æ–‡ä¸ä½œæ·±å…¥ä»‹ç»ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹çœ‹ ActivityThread çš„ main æ–¹æ³•ï¼Œä»¥ä¹‹ä½œä¸ºå…¥å£ï¼Œå¯¹ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„è°ƒç”¨æ—¶æœºåšè¿›ä¸€æ­¥ç ”ç©¶ã€‚</p>
<h2 id="æ¨¡æ¿æ–¹æ³•æ€»ç»“"><a href="#æ¨¡æ¿æ–¹æ³•æ€»ç»“" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ€»ç»“"></a>æ¨¡æ¿æ–¹æ³•æ€»ç»“</h2><p>ç®€å•æ¦‚æ‹¬æ¨¡æ¿æ–¹æ³•æ¨¡å¼å°±æ˜¯æµç¨‹å°è£…ã€‚æŠŠæŸä¸€ä¸ªå›ºå®šçš„æµç¨‹å°è£…åˆ°ä¸€ä¸ªå›ºå®šçš„ final æ–¹æ³•ä¸­ã€‚å¹¶ä¸”è®©å­ç±»èƒ½å¤Ÿå®šåˆ¶è¿™ä¸ªè¿‡ç¨‹ä¸­çš„æŸäº›ç”šè‡³æ‰€æœ‰æ­¥éª¤ï¼Œè¿™å°±è¦æ±‚çˆ¶ç±»æå–å…±ç”¨çš„ä»£ç ï¼Œæå‡ä»£ç çš„å¤ç”¨ç‡ï¼ŒåŒæ—¶ä¹Ÿå¸¦æ¥äº†æ›´é«˜çš„å¯æ‰©å±•æ€§ã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼š<ul>
<li>å°è£…ä¸å˜çš„éƒ¨åˆ†ï¼Œæ‰©å±•å¯å˜çš„éƒ¨åˆ†</li>
<li>æå–å…¬å…±éƒ¨åˆ†ä»£ç ï¼Œä¾¿äºç»´æŠ¤ã€‚</li>
</ul>
</li>
<li>ç¼ºç‚¹ï¼š<ul>
<li>æé«˜äº†ä»£ç é˜…è¯»çš„éš¾åº¦ï¼Œä¼šè®©ç”¨æˆ·è§‰å¾—éš¾ä»¥ç†è§£</li>
</ul>
</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li>ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹</li>
<li><a href="https://www.the5fire.com/%E6%8A%BD%E8%B1%A1%E6%96%B9%E6%B3%95-%E5%85%B7%E4%BD%93%E6%96%B9%E6%B3%95-%E9%92%A9%E5%AD%90%E6%96%B9%E6%B3%95.html" target="_blank" rel="noopener">æŠ½è±¡æ–¹æ³• å…·ä½“æ–¹æ³• é’©å­æ–¹æ³•</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> åŸç†åˆ†æ </category>
            
            <category> Android è¿›é˜¶ </category>
            
            <category> è®¾è®¡æ¨¡å¼ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> Android è¿›é˜¶ </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ä¹‹å¤‡å¿˜å½•æ¨¡å¼]]></title>
      <url>https://timlin-pro.github.io/blog/2017/08/21/%E8%A1%8C%E4%B8%BA%E5%9E%8B%E8%AE%BE%E7%BD%AE%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%A4%87%E5%BF%98%E5%BD%95%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<h2 id="å¤‡å¿˜å½•æ¨¡å¼çš„å®šä¹‰"><a href="#å¤‡å¿˜å½•æ¨¡å¼çš„å®šä¹‰" class="headerlink" title="å¤‡å¿˜å½•æ¨¡å¼çš„å®šä¹‰"></a>å¤‡å¿˜å½•æ¨¡å¼çš„å®šä¹‰</h2><p>å¤‡å¿˜å½•æ¨¡å¼æ˜¯ä¸€ç§<strong>è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼</strong>ï¼Œè¯¥æ¨¡å¼ç”¨äºä¿å­˜å¯¹è±¡å½“å‰çš„çŠ¶æ€ï¼Œå¹¶ä¸”åœ¨ä¹‹åå¯ä»¥å†æ¬¡æ¢å¤åˆ°æ­¤çŠ¶æ€ã€‚</p>
<p>å®ç°æ•ˆæœä¸ºï¼šåœ¨ä¸ç ´åå°é—­çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ï¼Œä»¥ä¾¿åç»­å°†å¯¹è±¡æ¢å¤åˆ°åŸæ¥çš„çŠ¶æ€ã€‚</p>
<h2 id="å¤‡å¿˜å½•æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯"><a href="#å¤‡å¿˜å½•æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="å¤‡å¿˜å½•æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯"></a>å¤‡å¿˜å½•æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯</h2><ol>
<li>éœ€è¦ä¿å­˜ä¸€ä¸ªå¯¹è±¡åœ¨æŸä¸€ä¸ªæ—¶åˆ»çš„çŠ¶æ€æˆ–éƒ¨åˆ†çŠ¶æ€</li>
<li>ä¸€ä¸ªå¯¹è±¡ä¸å¸Œæœ›å¤–ç•Œç›´æ¥è®¿é—®å…¶å†…éƒ¨çŠ¶æ€ï¼Œé€šè¿‡ä¸­é—´å¯¹è±¡å¯ä»¥é—´æ¥è®¿é—®å…¶å†…éƒ¨çŠ¶æ€ã€‚ï¼ˆå¦‚æœä½¿ç”¨æ¥å£æ¥è®©å…¶ä»–å¯¹è±¡è·å–å¯¹è±¡çš„çŠ¶æ€ï¼Œä¼šç ´åå°è£…æ€§ï¼‰</li>
</ol>
<a id="more"></a>
<h2 id="å¤‡å¿˜å½•æ¨¡å¼çš„UMLç±»å›¾"><a href="#å¤‡å¿˜å½•æ¨¡å¼çš„UMLç±»å›¾" class="headerlink" title="å¤‡å¿˜å½•æ¨¡å¼çš„UMLç±»å›¾"></a>å¤‡å¿˜å½•æ¨¡å¼çš„UMLç±»å›¾</h2><p><img src="https://user-images.githubusercontent.com/16668676/29518826-890e58e8-86ad-11e7-9ce8-90ff79fcc071.png" alt="memoto pattern"></p>
<p>ä¸‰ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>Originatorï¼šéœ€è¦ä¿å­˜çŠ¶æ€çš„å¯¹è±¡ã€‚è´Ÿè´£åˆ›å»ºä¸€ä¸ªå¤‡å¿˜å½•ï¼Œå¯ä»¥è®°å½•ã€æ¢å¤è‡ªèº«çš„å†…éƒ¨çŠ¶æ€ã€‚åŒæ—¶ Originator è¿˜å¯ä»¥æ ¹æ®éœ€è¦å†³å®š Memento å­˜å‚¨è‡ªèº«çš„å“ªäº›å†…éƒ¨çŠ¶æ€ã€‚</li>
<li>Mementoï¼ˆç±»ä¼¼äº pojo ç±»ï¼‰å¤‡å¿˜å½•è§’è‰²ã€‚ç”¨äºå­˜å‚¨ Originator å†…éƒ¨çŠ¶æ€ï¼Œå¹¶ä¸”å¯ä»¥é˜²æ­¢ Originator ä»¥å¤–çš„å¯¹è±¡è®¿é—® Memento</li>
<li>Caretakerï¼šè´Ÿè´£å­˜å‚¨å¤‡å¿˜å½•ï¼Œä¸èƒ½å¯¹<strong>å¤‡å¿˜å½•çš„å†…å®¹</strong>è¿›è¡Œæ“ä½œå’Œè®¿é—®ï¼Œåªèƒ½å°†å¤‡å¿˜å½•ä¼ é€’ç»™å…¶ä»–å¯¹è±¡ã€‚</li>
</ul>
<h2 id="Androidæºç ä¸­çš„å¤‡å¿˜å½•æ¨¡å¼"><a href="#Androidæºç ä¸­çš„å¤‡å¿˜å½•æ¨¡å¼" class="headerlink" title="Androidæºç ä¸­çš„å¤‡å¿˜å½•æ¨¡å¼"></a>Androidæºç ä¸­çš„å¤‡å¿˜å½•æ¨¡å¼</h2><p>æ—¥å¸¸å¼€å‘ä¸­å¦‚æœéœ€è¦ä¿å­˜ä»€ä¹ˆæ•°æ®ä»¥é˜²æ­¢ Activity æ„å¤–é”€æ¯ï¼Œç¬¬ä¸€æ—¶é—´ä¼šæƒ³åˆ° Activity ä¸­çš„è¿™ä¸¤ä¸ªæ–¹æ³•â€”â€”<code>onSaveInstanceState</code>ã€<code>onRestoreInstanceState</code>ã€‚å…¶å†…éƒ¨å…·ä½“æ˜¯å¦‚ä½•å®ç°æ•°æ®ä¿å­˜çš„å‘¢ï¼Ÿ</p>
<p>å…ˆé€æ¼ä¸€ä¸‹ï¼Œè¿™é‡Œé¢ä½¿ç”¨åˆ°äº†å¤‡å¿˜å½•æ¨¡å¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span> </span>&#123;</div><div class="line">    <span class="comment">//1. å­˜å‚¨çª—å£çš„è§†å›¾æ ‘çš„çŠ¶æ€</span></div><div class="line">    outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState());</div><div class="line">    <span class="comment">//2. å­˜å‚¨ Fragment ä¸­çš„çŠ¶æ€    </span></div><div class="line">    Parcelable p = mFragments.saveAllState();</div><div class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</div><div class="line">        outState.putParcelable(FRAGMENTS_TAG, p);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//3. è‹¥ç”¨æˆ·è®¾ç½®äº† Activity çš„ ActivityLifeCycleCallbacksï¼Œ</span></div><div class="line">    <span class="comment">//åˆ™è°ƒç”¨ ActivityLifeCycleCallbacks çš„ onSaveInstanceState è¿›è¡Œå­˜å‚¨çŠ¶æ€ã€‚</span></div><div class="line">    getApplication().dispatchActivitySaveInstanceState(<span class="keyword">this</span>, outState);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Activity.onSaveInstanceState æ–¹æ³•ä¸­ä¸»è¦åšäº†ä¸‰ä»¶äº‹</p>
<ol>
<li>å­˜å‚¨çª—å£çš„è§†å›¾æ ‘çš„çŠ¶æ€</li>
<li>å­˜å‚¨ Fragment ä¸­çš„çŠ¶æ€</li>
<li>è‹¥ç”¨æˆ·è®¾ç½®äº† Activity çš„ ActivityLifeCycleCallbacksï¼Œåˆ™è°ƒç”¨ ActivityLifeCycleCallbacks çš„ onSaveInstanceState è¿›è¡Œå­˜å‚¨çŠ¶æ€ã€‚</li>
</ol>
<p>é¦–å…ˆçœ‹çœ‹æ­¥éª¤ 1ï¼Œè¯¥æ­¥éª¤å°† Window å¯¹è±¡ä¸­çš„è§†å›¾æ ‘ä¸­çš„å„ä¸ª View çŠ¶æ€å­˜å‚¨åˆ° Bundle ä¸­ã€‚</p>
<p>Window çš„å…·ä½“å®ç°åœ¨ <code>PhoneWindow</code> ä¸­.ä»¥ä¸‹ä¸º <code>PhoneWindow.saveHierarchyState</code> çš„å…·ä½“å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Bundle <span class="title">saveHierarchyState</span><span class="params">()</span> </span>&#123;</div><div class="line">    Bundle outState = <span class="keyword">new</span> Bundle();</div><div class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> outState;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// SparseArray ç›¸å½“äºä¸€ä¸ª key ä¸º æ•´å‹çš„ map</span></div><div class="line">    SparseArray&lt;Parcelable&gt; states = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</div><div class="line">    <span class="comment">//æ­¤å¤„çš„ mContentParent å°±æ˜¯æˆ‘ä»¬ setContentView æ—¶è®¾ç½®çš„ View</span></div><div class="line">    mContentParent.saveHierarchyState(states);</div><div class="line">    outState.putSparseParcelableArray(VIEWS_TAG, states);</div><div class="line"></div><div class="line">    <span class="comment">// æŒæœ‰ç„¦ç‚¹çš„ View å¿…é¡»è®¾ç½® idï¼Œå¦åˆ™é‡æ–°è¿›å…¥è¯¥ç•Œé¢æ—¶ä¸ä¼šæ¢å¤å®ƒçš„ç„¦ç‚¹çŠ¶æ€</span></div><div class="line">    <span class="keyword">final</span> View focusedView = mContentParent.findFocus();</div><div class="line">    <span class="keyword">if</span> (focusedView != <span class="keyword">null</span> &amp;&amp; focusedView.getId() != View.NO_ID) &#123;</div><div class="line">        outState.putInt(FOCUSED_ID_TAG, focusedView.getId());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// å­˜å‚¨æ•´ä¸ªé¢æ¿çš„çŠ¶æ€</span></div><div class="line">    SparseArray&lt;Parcelable&gt; panelStates = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</div><div class="line">    savePanelState(panelStates);</div><div class="line">    <span class="keyword">if</span> (panelStates.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        outState.putSparseParcelableArray(PANELS_TAG, panelStates);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ä¿å­˜ actionbar çš„çŠ¶æ€</span></div><div class="line">    <span class="keyword">if</span> (mDecorContentParent != <span class="keyword">null</span>) &#123;</div><div class="line">        SparseArray&lt;Parcelable&gt; actionBarStates = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</div><div class="line">        mDecorContentParent.saveToolbarHierarchyState(actionBarStates);</div><div class="line">        outState.putSparseParcelableArray(ACTION_BAR_TAG, actionBarStates);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> outState;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹çœ‹æ­¥éª¤ 2 ä¸­çš„ <code>mContentParent.saveHierarchyState</code> æ–¹æ³•ï¼ŒmContentParent æ˜¯ä¸€ä¸ª ViewGroup ä½†æ˜¯ saveHierarchyState æ–¹æ³•å¹¶ä¸æ˜¯å®šä¹‰åœ¨ ViewGroup ä¸­ï¼Œè€Œæ˜¯å®šä¹‰åœ¨å®ƒçš„çˆ¶ç±»â€”â€”View ä¸­ï¼ŒæŸ¥çœ‹ä¸‹è¯¥æ–¹æ³•åœ¨ View ä¸­çš„å®ç°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveHierarchyState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</div><div class="line">    dispatchSaveInstanceState(container);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</div><div class="line">    <span class="comment">//1. åªæœ‰å«æœ‰ id çš„ Viewï¼ŒçŠ¶æ€æ‰ä¼šè¢«å­˜å‚¨</span></div><div class="line">    <span class="keyword">if</span> (mID != NO_ID &amp;&amp; (mViewFlags &amp; SAVE_DISABLED_MASK) == <span class="number">0</span>) &#123;</div><div class="line">        mPrivateFlags &amp;= ~PFLAG_SAVE_STATE_CALLED;</div><div class="line">        <span class="comment">//2. è°ƒç”¨ onSaveInstanceState æ–¹æ³•è·å–è‡ªèº«çŠ¶æ€</span></div><div class="line">        Parcelable state = onSaveInstanceState();</div><div class="line">        <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_SAVE_STATE_CALLED) == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    <span class="string">"Derived class did not call super.onSaveInstanceState()"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//3. å°†è‡ªèº«çŠ¶æ€å­˜æ”¾åˆ° container ä¸­</span></div><div class="line">        <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</div><div class="line">            container.put(mID, state);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>View.onSaveInstanceState</code> æ–¹æ³•é»˜è®¤å­˜å‚¨çš„çŠ¶æ€ä¸ºç©ºçŠ¶æ€ã€‚ä½†æ˜¯å®ƒçš„å­ç±»é€šå¸¸éƒ½æœ‰å®šä¹‰è‡ªèº«çš„è¦†ç›–æ–¹æ³•ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@CallSuper</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Parcelable <span class="title">onSaveInstanceState</span><span class="params">()</span> </span>&#123;</div><div class="line">    mPrivateFlags |= PFLAG_SAVE_STATE_CALLED;</div><div class="line">    <span class="keyword">if</span> (mStartActivityRequestWho != <span class="keyword">null</span>) &#123;</div><div class="line">        BaseSavedState state = <span class="keyword">new</span> BaseSavedState(AbsSavedState.EMPTY_STATE);</div><div class="line">        state.mStartActivityRequestWhoSaved = mStartActivityRequestWho;</div><div class="line">        <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> BaseSavedState.EMPTY_STATE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ­¥éª¤ 2 ä¸­çš„ View çš„è°ƒç”¨å¤§è‡´å¦‚ä¸‹ï¼šsaveHierarchyState ==ã€‹ dispatchSaveInstanceState ==ã€‹ onSaveInstanceState</p>
<ul>
<li>å…¶ä¸­è¦æ³¨æ„çš„æ˜¯ åªæœ‰å«æœ‰ id çš„ Viewï¼ŒçŠ¶æ€æ‰ä¼šè¢«å­˜å‚¨ï¼Œå¦‚æœæ²¡æœ‰ç»™ view èµ‹ä¸€ä¸ª idï¼Œé‚£ä¹ˆç³»ç»Ÿæ˜¯ä¸ä¼šå¸®å¿™ä¿å­˜è¯¥ view çš„çŠ¶æ€çš„ã€‚</li>
</ul>
<p>View ç±»ä¸­çš„ saveHierarchyState æ–¹æ³•è°ƒç”¨äº†dispatchSaveInstanceState æ–¹æ³•ç”¨æ¥å­˜å‚¨è‡ªèº«çŠ¶æ€ã€‚ ViewGroup è¦†å†™äº† dispatchSaveInstanceState æ¥å­˜å‚¨è‡ªèº«ä»¥åŠå­è§†å›¾çš„çŠ¶æ€ã€‚ </p>
<p><code>ViewGroup.dispatchSaveInstanceState</code>å…·ä½“å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.dispatchSaveInstanceState(container);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</div><div class="line">    <span class="keyword">final</span> View[] children = mChildren;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;<span class="comment">//éå†è°ƒç”¨å­ View çš„ dispatchSaveInstanceState æ–¹æ³•</span></div><div class="line">        View c = children[i];</div><div class="line">        <span class="keyword">if</span> ((c.mViewFlags &amp; PARENT_SAVE_DISABLED_MASK) != PARENT_SAVE_DISABLED) &#123;</div><div class="line">            c.dispatchSaveInstanceState(container);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ° ViewGroup çš„ <code>dispatchSaveInstanceState</code> æ–¹æ³•ä¼šå…ˆè°ƒç”¨ <code>super.dispatchSaveInstanceState(container);</code> å­˜å‚¨è‡ªèº«çš„çŠ¶æ€ã€‚ç„¶åéå†è°ƒç”¨æ‰€æœ‰å­è§†å›¾çš„ <code>dispatchSaveInstanceState(container)</code> æ–¹æ³•æ¥ä¿å­˜å®ƒä»¬çš„çŠ¶æ€ï¼Œå¦‚æœå­ View ä¹Ÿæ˜¯ä¸€ä¸ª ViewGroupï¼Œåˆ™ä¼šå†æ¬¡æ‰§è¡Œè¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<hr>
<p>æˆ‘ä»¬ä»¥ TextView çš„ saveInstanceState æ–¹æ³•ä¸ºä¾‹ï¼Œçœ‹çœ‹å…·ä½“çš„æ§ä»¶æ˜¯å¦‚ä½•ä¿å­˜è‡ªèº«çŠ¶æ€çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Parcelable <span class="title">onSaveInstanceState</span><span class="params">()</span> </span>&#123;</div><div class="line">    Parcelable superState = <span class="keyword">super</span>.onSaveInstanceState();</div><div class="line"></div><div class="line">    <span class="comment">// Save state if we are forced to</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> freezesText = getFreezesText();</div><div class="line">    <span class="keyword">boolean</span> hasSelection = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">int</span> start = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">int</span> end = -<span class="number">1</span>;</div><div class="line">    <span class="comment">//å­˜å‚¨ TextView çš„ startã€end </span></div><div class="line">    <span class="keyword">if</span> (mText != <span class="keyword">null</span>) &#123;</div><div class="line">        start = getSelectionStart();</div><div class="line">        end = getSelectionEnd();</div><div class="line">        <span class="keyword">if</span> (start &gt;= <span class="number">0</span> || end &gt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// æ˜¯å¦å­˜å­˜åœ¨é€‰é¡¹</span></div><div class="line">            hasSelection = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (freezesText || hasSelection) &#123;</div><div class="line">        SavedState ss = <span class="keyword">new</span> SavedState(superState);</div><div class="line">        <span class="comment">//ä¿å­˜ TextView çš„æ–‡æœ¬å†…å®¹</span></div><div class="line">        <span class="keyword">if</span> (freezesText) &#123;</div><div class="line">            <span class="keyword">if</span> (mText <span class="keyword">instanceof</span> Spanned) &#123;</div><div class="line">                <span class="keyword">final</span> Spannable sp = <span class="keyword">new</span> SpannableStringBuilder(mText);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (mEditor != <span class="keyword">null</span>) &#123;</div><div class="line">                    removeMisspelledSpans(sp);</div><div class="line">                    sp.removeSpan(mEditor.mSuggestionRangeSpan);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                ss.text = sp;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ss.text = mText.toString();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//å­˜å‚¨ TextView çš„ startã€end </span></div><div class="line">        <span class="keyword">if</span> (hasSelection) &#123;</div><div class="line">            <span class="comment">// XXX Should also save the current scroll position!</span></div><div class="line">            ss.selStart = start;</div><div class="line">            ss.selEnd = end;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (isFocused() &amp;&amp; start &gt;= <span class="number">0</span> &amp;&amp; end &gt;= <span class="number">0</span>) &#123;</div><div class="line">            ss.frozenWithFocus = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ss.error = getError();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mEditor != <span class="keyword">null</span>) &#123;</div><div class="line">            ss.editorState = mEditor.saveInstanceState();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//è¿”å›çŠ¶æ€å¯¹è±¡</span></div><div class="line">        <span class="keyword">return</span> ss;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> superState;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è°ƒç”¨ View çš„ onSaveInstance å‡½æ•°ä¹‹åå°±å¾—åˆ°äº† View è¦å­˜å‚¨çš„æ•°æ®ï¼Œæ­¤æ—¶æ‰§è¡Œåˆ° View çš„  dispatchSaveInstanceState æ–¹æ³•ä¸­çš„æ³¨é‡Š 3ã€‚è¿™é‡Œä»¥ View çš„ id ä¸º keyï¼Œä»¥çŠ¶æ€ä¸º valueï¼Œå­˜å‚¨åˆ° containerï¼ˆ SparseArray ç±»å‹ï¼‰ä¸­ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//3. å°†è‡ªèº«çŠ¶æ€å­˜æ”¾åˆ° container ä¸­</span></div><div class="line"><span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</div><div class="line">    container.put(mID, state);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>å­˜å‚¨å®Œ Window çš„è§†å›¾çŠ¶æ€ä¿¡æ¯ä¹‹åï¼Œä¾¿ä¼šæ‰§è¡Œå­˜å‚¨ Fragment ä¸­çš„çŠ¶æ€ä¿¡æ¯ã€å›é€€æ ˆç­‰ã€‚Fragment  ä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨è‡ªèº«çš„ onSaveInstaceState æ–¹æ³•æ¥å­˜å‚¨è‡ªèº«çš„ View è§†å›¾æ ‘çŠ¶æ€çš„ã€‚</li>
<li>æœ€åå°±æ˜¯è°ƒç”¨ç”¨æˆ·è®¾ç½®çš„ ActivityLifecycleCallbacks çš„ onSaveInstaceState æ–¹æ³•ï¼Œè®©ç”¨æˆ·åšä¸€äº›é¢å¤–çš„å¤„ç†</li>
</ul>
<p>å‰é¢æˆ‘ä»¬æ‰€æåŠåˆ°çš„åªæ˜¯å¤‡å¿˜å½•æ¨¡å¼ä¸­çš„ Originator è§’è‰²ï¼Œå³éœ€è¦ä¿å­˜å¤‡å¿˜å½•çš„å¯¹è±¡ã€‚ä¸è¿‡ä¹Ÿæœ‰æ¶‰åŠåˆ° CareTaker è§’è‰²â€”â€”Activityã€‚ä¸‹é¢æˆ‘ä»¬å†çœ‹çœ‹å¦å¤–ä¸¤ä¸ªè§’è‰²â€”â€”Memoto å’Œ CareTakerã€‚</p>
<p>å­˜äº†çŠ¶æ€ä¿¡æ¯çš„ Bundle æ•°æ®å­˜å‚¨åœ¨å“ªï¼Ÿ</p>
<ul>
<li>onSaveInstance æ–¹æ³•æ˜¯åœ¨ onStop æ–¹æ³•ä¹‹å‰è°ƒç”¨çš„ã€‚Activity.onStop æ–¹æ³•æ˜¯é€šè¿‡ Activity çš„ performStopActivity é—´æ¥è°ƒç”¨ã€‚<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performStopActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> saveState, String reason)</span> </span>&#123;</div><div class="line">    <span class="comment">//è·å– ActivityClientRecord</span></div><div class="line">    ActivityClientRecord r = mActivities.get(token);</div><div class="line">    <span class="comment">// saveState è¡¨ç¤ºæ˜¯å¦ä¿å­˜çŠ¶æ€</span></div><div class="line">    performStopActivityInner(r, <span class="keyword">null</span>, <span class="keyword">false</span>, saveState, reason);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performStopActivityInner</span><span class="params">(ActivityClientRecord r,</span></span></div><div class="line">        StopInfo info, <span class="keyword">boolean</span> keepShown, <span class="keyword">boolean</span> saveState, String reason) &#123;</div><div class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!keepShown &amp;&amp; r.stopped) &#123;</div><div class="line">            <span class="keyword">if</span> (r.activity.mFinished) &#123;</div><div class="line">                <span class="comment">// å¦‚æœæ­£åœ¨æ‰§è¡Œé”€æ¯è¿‡ç¨‹ï¼Œæ˜¯ç”¨æˆ·ä¸»åŠ¨é”€æ¯ã€‚ activity ä¸æ‰“ç®—æ¢å¤ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡å¿…è¦è°ƒç”¨ onStop æ–¹æ³•</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// åœ¨è°ƒç”¨ onStop ä¹‹å‰å¿…é¡»å…ˆè°ƒç”¨ onPause </span></div><div class="line">        performPauseActivityIfNeeded(r, reason);</div><div class="line"></div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">        <span class="comment">// æ¥ä¸‹æ¥è®© activity ä¿å­˜å®ƒç›®å‰çš„çŠ¶æ€å’Œå®ƒæ‰€ç®¡ç†çš„ dialogs </span></div><div class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; saveState) &#123;</div><div class="line">            <span class="keyword">if</span> (r.state == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// é—´æ¥è°ƒç”¨ Activity.onSaveInstance()</span></div><div class="line">                callCallActivityOnSaveInstanceState(r);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!keepShown) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// æ‰§è¡Œ onStop æ–¹æ³•</span></div><div class="line">                r.activity.performStop(<span class="keyword">false</span> <span class="comment">/*preserveWindow*/</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="comment">// ...</span></div><div class="line">            &#125;</div><div class="line">            <span class="comment">//å°† stop å­—æ®µç½®ä¸º true è¡¨ç¤ºå·²ç»è°ƒç”¨äº† stop æ–¹æ³•ã€‚</span></div><div class="line">            r.stopped = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callCallActivityOnSaveInstanceState</span><span class="params">(ActivityClientRecord r)</span> </span>&#123;</div><div class="line">    r.state = <span class="keyword">new</span> Bundle();<span class="comment">//å†…å®¹å°±å­˜å‚¨åœ¨è¯¥ Bundle ä¸­</span></div><div class="line">    r.state.setAllowFds(<span class="keyword">false</span>);</div><div class="line">    <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">        r.persistentState = <span class="keyword">new</span> PersistableBundle();</div><div class="line">        mInstrumentation.callActivityOnSaveInstanceState(r.activity, r.state,</div><div class="line">                r.persistentState);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//è¯¥æ–¹æ³•å®é™…è°ƒç”¨äº† Activity.onSaveInstanceState æ–¹æ³•</span></div><div class="line">        mInstrumentation.callActivityOnSaveInstanceState(r.activity, r.state);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnSaveInstanceState</span><span class="params">(Activity activity, Bundle outState,</span></span></div><div class="line">        PersistableBundle outPersistentState) &#123;</div><div class="line">    activity.performSaveInstanceState(outState, outPersistentState);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ performStopActivity ä¸ performStopActivityInner æ–¹æ³•ä¸­ï¼Œé¦–å…ˆé€šè¿‡ token ä» mActivities ä¸­è·å–ä¸€ä¸ª ActivityClientRecord å¯¹è±¡ï¼ŒçŠ¶æ€ä¿¡æ¯å°±æ˜¯å­˜å‚¨åœ¨è¿™é‡Œé¢çš„ã€‚è·å–è¯¥å¯¹è±¡ä¹‹åï¼Œè°ƒç”¨äº† performStopActivityInner æ–¹æ³•ï¼Œå¯¹äºä¿å­˜çŠ¶æ€è€Œè¨€ï¼Œè¯¥æ–¹æ³•å¤§æ¦‚æœ‰å¦‚ä¸‹ä¸‰æ­¥</p>
<ol>
<li>åˆ¤æ–­ Activity æ˜¯å¦éœ€è¦ä¿å­˜çŠ¶æ€</li>
<li>å¦‚æœéœ€è¦ï¼Œåˆ™è°ƒç”¨ onSaveInstance æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå°†çŠ¶æ€ä¿¡æ¯å­˜å‚¨åˆ° ActivityClientRecord ä¸­</li>
<li>è°ƒç”¨ <code>Activity.onStop()</code> æ–¹æ³•</li>
</ol>
<p>æ‰§è¡Œ onStop æ–¹æ³•ä¹‹å‰ï¼Œç³»ç»Ÿä¼šæ ¹æ®æƒ…å†µæ¥é€‰æ‹©æ˜¯å¦å­˜å‚¨ Activity çš„çŠ¶æ€ï¼Œå¹¶ä¸”å°†è¿™äº›çŠ¶æ€ï¼ˆç®€ä»‹åœ°ï¼‰å­˜å‚¨åˆ° mActivities ä¸­ã€‚</p>
<p>mActivities æ˜¯ä¸€ä¸ª <code>ArrayMap&lt;IBinder, ActivityClientRecord&gt;</code> ï¼Œå®ƒç»´æŠ¤äº†ä¸€ä¸ª Activity çš„ä¿¡æ¯è¡¨ï¼Œå½“ Activity é‡æ–°å¯åŠ¨æ—¶ï¼Œä¼šä» mActivities ä¸­æŸ¥è¯¢å¯¹åº”çš„ ActivityClientRecordï¼Œå¦‚æœè¿™ä¸ªè®°å½•å¯¹è±¡ä¸­å«æœ‰çŠ¶æ€ä¿¡æ¯å°±è°ƒç”¨ Activity çš„ onRestoreInstanceState æ–¹æ³•ã€‚å¼€å‘äººå‘˜å¯ä»¥ä»è¿™ä¸ªæ–¹æ³•ä¸­åšä¸€äº›çŠ¶æ€æ¢å¤æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line">    <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    Activity activity = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">        <span class="comment">//1. æ„å»º Activity </span></div><div class="line">        activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//2. åˆ›å»ºä¸€ä¸ª Application å¯¹è±¡</span></div><div class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line"></div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//åˆ›å»º appContextï¼Œç±»å‹ä¸º ContextImpl</span></div><div class="line">            Context appContext = createBaseContextForActivity(r, activity);</div><div class="line">            <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">            <span class="comment">//3. å…³è” appContextã€Application ç­‰å¯¹è±¡åˆ° Activity ä¸­</span></div><div class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</div><div class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                    r.referrer, r.voiceInteractor, window);</div><div class="line">            <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">            activity.mCalled = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">//4. è°ƒç”¨ Activity.onCreate æ–¹æ³•</span></div><div class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">            r.activity = activity;</div><div class="line">            r.stopped = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                <span class="comment">//è°ƒç”¨ onStart æ–¹æ³•</span></div><div class="line">                activity.performStart();</div><div class="line">                r.stopped = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">             <span class="comment">//5. å¦‚æœæœ‰ä¿å­˜çŠ¶æ€çš„è¯ï¼Œè°ƒç”¨ Activity.onRestoreInstanceState æ–¹æ³•æ¢å¤çŠ¶æ€</span></div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                    <span class="keyword">if</span> (r.state != <span class="keyword">null</span> || r.persistentState != <span class="keyword">null</span>) &#123;</div><div class="line">   </div><div class="line">                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</div><div class="line">                                r.persistentState);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</div><div class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">        &#125;</div><div class="line">        r.paused = <span class="keyword">true</span>;</div><div class="line">        <span class="comment">//6. å°† Activity çš„ä¿¡æ¯è®°å½•å¯¹è±¡â€”â€”ActivityClientRecord å­˜å‚¨åˆ° mActivities ä¸­ã€‚ </span></div><div class="line">        mActivities.put(r.token, r);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> activity;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„æ³¨é‡Š 5 å¤„ï¼Œç³»ç»Ÿä¼šåˆ¤æ–­ Activity æ˜¯å¦è°ƒç”¨è¿‡äº† <code>Activity.finish()</code> æ–¹æ³•ã€æ˜¯å¦æ˜¯ã€Œæ°¸ä¹…çš„ã€ä»¥åŠ ActivityClientRecord å¯¹è±¡ä¸­çš„ state æ˜¯å¦ä¸ºç©ºï¼Œ</p>
<ul>
<li>å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œå°±ä¼šè·å–å­˜å‚¨çš„çŠ¶æ€ä¿¡æ¯ä¼ é€’ç»™ <code>Activity.onRestoreInstanceState</code> æ–¹æ³•ï¼Œä¹Ÿä¼šå°†è¿™äº›æ•°æ®ä¼ é€’ç»™ onCreate æ–¹æ³•çš„ bundle å‚æ•° ã€‚</li>
<li>ä¸è¿‡ Google å®˜æ–¹æ¨èè°ƒç”¨ onRestoreInstanceState æ–¹æ³•æ¥æ¢å¤çŠ¶æ€ï¼Œå› ä¸ºåªæœ‰åœ¨å­˜å‚¨æœ‰çŠ¶æ€ä¿¡æ¯çš„æ—¶å€™æ‰ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè€Œåœ¨ onCreate æ–¹æ³•ä¸­è¿˜éœ€è¦å…ˆè¿›è¡Œåˆ¤ç©ºå¤„ç†ã€‚</li>
</ul>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>ä¸Šè¿°è¿‡ç¨‹ä¸­å¤‡å¿˜å½•æ¨¡å¼çš„ä¸‰ç§å…³é”®è§’è‰²åˆ†åˆ«ç”±ä»€ä¹ˆç±»æ‰®æ¼”ï¼Ÿ</p>
<ul>
<li><strong>CareTaker</strong>ï¼šActivity è´Ÿè´£å­˜å‚¨ã€æ¢å¤ UI çš„æ€ä¿¡æ¯ã€‚</li>
<li><strong>Originator</strong>ï¼šActivityã€Fragmentã€Viewã€ViewGroup ï¼Œæ˜¯éœ€è¦å­˜å‚¨çŠ¶æ€çš„å¯¹è±¡</li>
<li><strong>Memoto</strong>ï¼šç”± Bundle ç±»æ‰®æ¼”</li>
</ul>
<ul>
<li>Activity ä¼šåœ¨åœæ­¢ä¹‹å‰æ ¹æ® Activity çš„é€€å‡ºæƒ…æ™¯æ¥é€‰æ‹©æ˜¯å¦éœ€è¦å­˜å‚¨çŠ¶æ€</li>
<li>åœ¨<strong>é‡æ–°å¯åŠ¨</strong>è¯¥ Activity æ—¶ä¼šåˆ¤æ–­ ActivityClientRecord å¯¹è±¡ä¸­æ˜¯å¦å­˜å‚¨äº† Activity çš„çŠ¶æ€<ul>
<li>å¦‚æœå«æœ‰çŠ¶æ€ï¼Œè°ƒç”¨ <code>Activity.onRestoreInstanceState()</code> æ–¹æ³•æ¢å¤çŠ¶æ€ã€‚ä»è€Œä½¿å¾— Activity çš„ UI å¯ä»¥æ¢å¤è‡³å¼‚å¸¸é€€å‡ºå‰çš„çŠ¶æ€ã€‚</li>
</ul>
</li>
</ul>
<h2 id="ä½ å¯èƒ½ä¼šé—®çš„é—®é¢˜"><a href="#ä½ å¯èƒ½ä¼šé—®çš„é—®é¢˜" class="headerlink" title="ä½ å¯èƒ½ä¼šé—®çš„é—®é¢˜"></a>ä½ å¯èƒ½ä¼šé—®çš„é—®é¢˜</h2><h3 id="onSaveInstanceState-ä½•æ—¶è¢«è°ƒç”¨"><a href="#onSaveInstanceState-ä½•æ—¶è¢«è°ƒç”¨" class="headerlink" title="onSaveInstanceState ä½•æ—¶è¢«è°ƒç”¨"></a>onSaveInstanceState ä½•æ—¶è¢«è°ƒç”¨</h3><p>onSaveInstanceState() æ–¹æ³•ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è¢«æ‰§è¡Œï¼Ÿ<br>æœ‰è¿™ä¹ˆå‡ ç§æƒ…å†µï¼š</p>
<ol>
<li>å½“ç”¨æˆ·æŒ‰ä¸‹ HOME é”®æ—¶ã€‚<ul>
<li>è¿™æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œç³»ç»Ÿä¸çŸ¥é“ä½ æŒ‰ä¸‹HOMEåè¦è¿è¡Œå¤šå°‘å…¶ä»–çš„ç¨‹åºï¼Œè‡ªç„¶ä¹Ÿä¸çŸ¥é“activity Aæ˜¯å¦ä¼šè¢«é”€æ¯ï¼Œå› æ­¤ç³»ç»Ÿä¼šè°ƒç”¨onSaveInstanceState()ï¼Œè®©ç”¨æˆ·æœ‰æœºä¼šä¿å­˜æŸäº›éæ°¸ä¹…æ€§çš„æ•°æ®ã€‚ä»¥ä¸‹å‡ ç§æƒ…å†µçš„åˆ†æéƒ½éµå¾ªè¯¥åŸåˆ™</li>
</ul>
</li>
<li>é•¿æŒ‰HOMEé”®ï¼Œé€‰æ‹©è¿è¡Œå…¶ä»–çš„ç¨‹åºæ—¶ã€‚</li>
<li>æŒ‰ä¸‹ç”µæºæŒ‰é”®ï¼ˆå…³é—­å±å¹•æ˜¾ç¤ºï¼‰æ—¶ã€‚</li>
<li>ä» Activity A ä¸­å¯åŠ¨ä¸€ä¸ªæ–°çš„ Activity æ—¶ã€‚</li>
<li>å±å¹•æ–¹å‘åˆ‡æ¢æ—¶ï¼Œä¾‹å¦‚ä»ç«–å±åˆ‡æ¢åˆ°æ¨ªå±æ—¶ã€‚</li>
</ol>
<p>onSaveInstanceState çš„è°ƒç”¨åœ¨ onStop æ–¹æ³•ä¹‹å‰ï¼Œä½†æ˜¯ä¸ onPause æ–¹æ³•ä¹‹é—´æ²¡æœ‰æ—¢å®šå…³ç³»ã€‚</p>
<ul>
<li>æ€»è€Œè¨€ä¹‹ï¼Œå½“ç³»ç»Ÿå­˜åœ¨ã€Œ==æœªç»ç”¨æˆ·è®¸å¯==ã€æ—¶é”€æ¯äº†æˆ‘ä»¬çš„ Activityï¼Œåˆ™ <code>onSaveInstanceState()</code> ä¼šè¢«ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ˜¯ç³»ç»Ÿçš„è´£ä»»ï¼Œå› æ­¤å®ƒå¿…é¡»æä¾›ä¸€ä¸ªæœºä¼šè®©ç”¨æˆ·ä¿å­˜æ•°æ®ã€‚</li>
<li>ã€Œç»ç”¨æˆ·è®¸å¯ã€çš„æƒ…å†µä¸å¤šï¼Œé€šå¸¸åªæœ‰ç”¨æˆ·æŒ‰ä¸‹å›é€€é”®è¿™ä¸€ç§ã€‚è¿™ç§æƒ…å†µä¸‹æ˜¯ç”¨æˆ·ä¸»åŠ¨é€€å‡ºæŸä¸ª Activityï¼Œç³»ç»Ÿä¸ä¼šè°ƒç”¨  <code>onSaveInstanceState()</code> æ–¹æ³•ã€‚</li>
</ul>
<h3 id="å„ä¸ª-ã€ŒOriginator-ã€-çš„-onSaveInstanceState-æ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ"><a href="#å„ä¸ª-ã€ŒOriginator-ã€-çš„-onSaveInstanceState-æ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ" class="headerlink" title="å„ä¸ª ã€ŒOriginator ã€ çš„ onSaveInstanceState() æ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ"></a>å„ä¸ª ã€ŒOriginator ã€ çš„ onSaveInstanceState() æ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</h3><p>åœ¨å‰é¢çš„åˆ†æä¸­æˆ‘ä»¬çŸ¥é“å³ä½¿æ²¡æœ‰è¦†å†™ onSaveInstanceState()æ–¹æ³•, ViewGroupã€Viewã€Fragmentã€Activity å†…éƒ¨éƒ½æœ‰è‡ªå·±çš„é»˜è®¤å®ç°ï¼Œå®ƒä»¬çš„é»˜è®¤å®ç°ä¹Ÿä¼š<strong>ä¿å­˜æŸäº›çŠ¶æ€æ•°æ®</strong>ã€‚ </p>
<ul>
<li>æ¯”å¦‚ activity ä¸­å„ç§ UI æ§ä»¶çš„çŠ¶æ€ã€‚android åº”ç”¨æ¡†æ¶ä¸­å®šä¹‰çš„å‡ ä¹æ‰€æœ‰ UI æ§ä»¶éƒ½æ°å½“çš„å®ç°äº† onSaveInstanceState() æ–¹æ³•,å› æ­¤å½“ Activity è¢«é”€æ¯å’Œé‡å»ºæ—¶, è¿™äº› UI æ§ä»¶ä¼šè‡ªåŠ¨ä¿å­˜å’Œæ¢å¤çŠ¶æ€æ•°æ®.<ul>
<li>EditText æ§ä»¶ä¼šè‡ªåŠ¨ä¿å­˜å’Œæ¢å¤è¾“å…¥çš„æ•°æ®</li>
<li>CheckBox æ§ä»¶ä¼šè‡ªåŠ¨ä¿å­˜å’Œæ¢å¤é€‰ä¸­çŠ¶æ€</li>
<li>â€¦</li>
</ul>
</li>
<li>å¼€å‘è€…åª<strong>éœ€è¦ä¸ºè¿™äº›æ§ä»¶æŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„ id</strong>(é€šè¿‡è®¾ç½® <code>android:id</code> å±æ€§å³å¯), å‰©ä½™çš„äº‹æƒ…å°±å¯ä»¥è‡ªåŠ¨å®Œæˆäº†<ul>
<li>æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰ä¸ºæ§ä»¶æŒ‡å®šID, åˆ™è¿™ä¸ªæ§ä»¶å°±ä¸ä¼šè¿›è¡Œè‡ªåŠ¨çš„æ•°æ®ä¿å­˜å’Œæ¢å¤æ“ä½œã€‚</li>
</ul>
</li>
</ul>
<p>ç”±ä¸Šæ‰€è¿°, å¦‚æœæˆ‘ä»¬éœ€è¦è¦†å†™ onSaveInstanceState() æ–¹æ³•, ä¸€èˆ¬ä¼šåœ¨ç¬¬ä¸€è¡Œä»£ç ä¸­è°ƒç”¨è¯¥æ–¹æ³•çš„é»˜è®¤å®ç°:super.onSaveInstanceState(outState)ã€‚</p>
<h3 id="æœ‰é»˜è®¤å®ç°ï¼Œè¿˜éœ€è¦é‡å†™-onSaveInstanceState-æ–¹æ³•å—ï¼Ÿ"><a href="#æœ‰é»˜è®¤å®ç°ï¼Œè¿˜éœ€è¦é‡å†™-onSaveInstanceState-æ–¹æ³•å—ï¼Ÿ" class="headerlink" title="æœ‰é»˜è®¤å®ç°ï¼Œè¿˜éœ€è¦é‡å†™ onSaveInstanceState() æ–¹æ³•å—ï¼Ÿ"></a>æœ‰é»˜è®¤å®ç°ï¼Œè¿˜éœ€è¦é‡å†™ onSaveInstanceState() æ–¹æ³•å—ï¼Ÿ</h3><p>æ—¢ç„¶è¯¥æ–¹æ³•çš„é»˜è®¤å®ç°å¯ä»¥è‡ªåŠ¨çš„ä¿å­˜UIæ§ä»¶çš„çŠ¶æ€æ•°æ®, é‚£ä»€ä¹ˆæ—¶å€™éœ€è¦è¦†å†™è¯¥æ–¹æ³•å‘¢? </p>
<p>å¦‚æœ<strong>éœ€è¦ä¿å­˜é¢å¤–çš„æ•°æ®æ—¶</strong>, å°±éœ€è¦è¦†å†™ onSaveInstanceState() æ–¹æ³•ã€‚å¤§å®¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼šonSaveInstanceState()æ–¹æ³•<strong>åªé€‚åˆä¿å­˜ç¬æ€æ•°æ®</strong>, æ¯”å¦‚ UI æ§ä»¶çš„çŠ¶æ€ï¼Œæˆå‘˜å˜é‡çš„å€¼ç­‰ï¼Œè€Œä¸åº”è¯¥ç”¨æ¥ä¿å­˜æŒä¹…åŒ–æ•°æ®ï¼ŒæŒä¹…åŒ–æ•°æ®åº”è¯¥å½“ç”¨æˆ·ç¦»å¼€å½“å‰çš„ activityæ—¶ï¼Œåœ¨ onPause() ä¸­ä¿å­˜ï¼ˆæ¯”å¦‚å°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“æˆ–æ–‡ä»¶ä¸­ï¼‰ã€‚è¯´åˆ°è¿™é‡Œï¼Œè¿˜è¦è¯´ä¸€ç‚¹çš„å°±æ˜¯åœ¨onPause()ä¸­ä¸é€‚åˆç”¨æ¥ä¿å­˜æ¯”è¾ƒè´¹æ—¶çš„æ•°æ®ï¼Œæ‰€ä»¥è¿™ç‚¹è¦ç†è§£ã€‚</p>
<p>å¦å¤–ç”±äº <code>onSaveInstanceState()</code> æ–¹æ³•æ–¹æ³•ä¸ä¸€å®šä¼šè¢«è°ƒç”¨, å› æ­¤<strong>ä¸é€‚åˆåœ¨è¯¥æ–¹æ³•ä¸­ä¿å­˜æŒä¹…åŒ–æ•°æ®</strong>, ä¾‹å¦‚å‘æ•°æ®åº“ä¸­æ’å…¥è®°å½•ç­‰ã€‚ ä¿å­˜æŒä¹…åŒ–æ•°æ®çš„æ“ä½œåº”è¯¥æ”¾åœ¨ onPause() ä¸­ã€‚è‹¥æ˜¯æ°¸ä¹…æ€§å€¼ï¼Œåˆ™åœ¨ onPause() ä¸­ä¿å­˜ï¼›è‹¥æœ‰å¤§é‡è¦ä¿å­˜çš„æ•°æ®ï¼Œåˆ™å¦å¼€çº¿ç¨‹ï¼Œä»¥å…é˜»å¡ UI çº¿ç¨‹ã€‚ </p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li>ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹</li>
<li><a href="http://www.cnblogs.com/hanyonglu/archive/2012/03/28/2420515.html" target="_blank" rel="noopener">Android å¼€å‘ä¹‹ instanceStateè¯¦è§£</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> è®¾è®¡æ¨¡å¼ </category>
            
            <category> Android åŸç†åˆ†æ </category>
            
            <category> Android è¿›é˜¶ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android è¿›é˜¶ </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
            <tag> Android åŸç†åˆ†æ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æ·±å…¥ç†è§£ ThreadLocal]]></title>
      <url>https://timlin-pro.github.io/blog/2017/08/21/%E7%90%86%E8%A7%A3%20ThreadLocal/</url>
      <content type="html"><![CDATA[<h2 id="ThreadLocal-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ThreadLocal-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ThreadLocal æ˜¯ä»€ä¹ˆï¼Ÿ"></a>ThreadLocal æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ThreadLocal æ˜¯ä¸€ä¸ª<strong>çº¿ç¨‹å†…éƒ¨</strong>çš„<strong>æ•°æ®å­˜å‚¨ç±»</strong>ï¼Œé€šè¿‡å®ƒå¯ä»¥åœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­å­˜å‚¨æ•°æ®ï¼Œæ•°æ®å­˜å‚¨åï¼Œåªæœ‰åœ¨æŒ‡å®šçº¿ç¨‹ä¸­æ‰èƒ½è·å–åˆ°å­˜å‚¨çš„æ•°æ®ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹æ¥è¯´åˆ™æ— æ³•è·å–åˆ°æ•°æ®ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨-ThreadLocalï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨-ThreadLocalï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ ThreadLocalï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ ThreadLocalï¼Ÿ</h2><p>ä»å®šä¹‰æˆ‘ä»¬çŸ¥é“ ThreadLocal æ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨æœ¬çº¿ç¨‹å†…éƒ¨æ•°æ®çš„ç±»ã€‚å‡è®¾æ²¡æœ‰ ThreadLocal çš„è¯ï¼Œæ¯ä¸ª Thread ä¸­å¯ä»¥è¾“å…¥è‡ªå·±çš„ä¸€ä¸ªæœ¬åœ°å˜é‡ï¼Œä½†æ˜¯åœ¨æ•´ä¸ª Thread çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¦‚æœè¦ç©¿æ¢­å¾ˆå¤š class çš„å¾ˆå¤š method æ¥ä½¿ç”¨è¿™ä¸ªæœ¬åœ°å˜é‡çš„è¯ï¼Œå°±è¦ä¸€ç›´ä¸€ç›´å‘ä¸‹ä¼ é€è¿™ä¸ªå˜é‡ï¼Œæ˜¾ç„¶å¾ˆéº»çƒ¦ã€‚<br>é‚£ä¹ˆæ€ä¹ˆæ‰èƒ½åœ¨è¿™ä¸ª Thread çš„ç”Ÿå‘½ä¸­ï¼Œåœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½å¤Ÿæ–¹ä¾¿çš„è®¿é—®åˆ°è¿™ä¸ªå˜é‡å‘¢ï¼Œè¿™æ—¶å€™ ThreadLocal å°±è¯ç”Ÿäº†ã€‚</p>
<a id="more"></a>
<p>ThreadLocal å°±æ˜¯è¿™ä¹ˆä¸ªä½œç”¨ï¼Œé™¤æ­¤ä¹‹å¤–å’Œé€šå¸¸ä½¿ç”¨çš„æœ¬åœ°å˜é‡æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚<br>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ²¡æœ‰ ThreadLocal ä¹Ÿæ˜¯å¯ä»¥è§£å†³é—®é¢˜çš„ï¼Œä½†æ˜¯ä¼šæ¯”è¾ƒéº»çƒ¦ï¼ŒThreadLocal çš„ä½œç”¨ä¾¿æ˜¯ç®€åŒ–çº¿ç¨‹å†…éƒ¨æ•°æ®çš„ä½¿ç”¨æµç¨‹ã€‚</p>
<h2 id="ThreadLocal-çš„å†…éƒ¨å®ç°"><a href="#ThreadLocal-çš„å†…éƒ¨å®ç°" class="headerlink" title="ThreadLocal çš„å†…éƒ¨å®ç°"></a>ThreadLocal çš„å†…éƒ¨å®ç°</h2><p>æ—¢ç„¶æ˜¯çº¿ç¨‹çš„æœ¬åœ°å˜é‡ï¼Œé‚£è‡ªç„¶ä¸çº¿ç¨‹æœ‰ç€å¯†åˆ‡çš„è”ç³»ã€‚</p>
<p>æ‰“å¼€ Thread çš„æºç å¯ä»¥çœ‹åˆ°ï¼Œæºç ä¸­æœ‰ä¸€ä¸ªç±»å‹ä¸º <code>ThreadLocal.ThreadLocalMap</code> çš„å˜é‡<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ThreadLocal.ThreadLocalMap threadLocals = <span class="keyword">null</span>;</div></pre></td></tr></table></figure></p>
<h3 id="ThreadLocal-get-æµç¨‹"><a href="#ThreadLocal-get-æµç¨‹" class="headerlink" title="ThreadLocal#get æµç¨‹"></a>ThreadLocal#get æµç¨‹</h3><p>æˆ‘ä»¬ä»¥ ThreadLocal#get æ–¹æ³•ä½œä¸ºåˆ†æçš„æºå¤´ã€‚è¿™äº›æ–¹æ³•çš„é€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œå› æ­¤ç›´æ¥åœ¨æ³¨é‡Šä¸­è¯´æ˜ã€‚å¯å‚è€ƒå°ç»“éƒ¨åˆ†çš„è°ƒç”¨æµç¨‹å›¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">    Thread t = Thread.currentThread();<span class="comment">//è·å–å½“å‰çº¿ç¨‹</span></div><div class="line">    ThreadLocalMap map = getMap(t);<span class="comment">//è·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡</span></div><div class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">        ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);<span class="comment">//è·å–å­˜å‚¨è¯¥ ThreadLocal çš„ Entry</span></div><div class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> (T)e.value;<span class="comment">//è·å–ç›®æ ‡å€¼å¹¶è¿”å›</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> setInitialValue();<span class="comment">//è®¾ç½®åˆå§‹å€¼</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ThreadLocal#getMapï¼Œè¯¥æ–¹æ³•è¿”å›å½“å‰çº¿ç¨‹çš„ ThreadLocalMap  å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> t.threadLocals;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Entry ç±»ç»§æ‰¿è‡ªå¼±å¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚å…¶ä¸­å­˜å‚¨äº† ThreadLocal ä»¥åŠå¯¹åº”çš„å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&gt; </span>&#123;</div><div class="line">    Object value;</div><div class="line"></div><div class="line">    Entry(ThreadLocal k, Object v) &#123;</div><div class="line">        <span class="keyword">super</span>(k);</div><div class="line">        value = v;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ThreadLocal#setInitialValue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    T value = initialValue();<span class="comment">//è·å–é»˜è®¤çš„åˆå§‹å€¼</span></div><div class="line">    Thread t = Thread.currentThread();<span class="comment">//è·å–å½“å‰çº¿ç¨‹</span></div><div class="line">    ThreadLocalMap map = getMap(t);<span class="comment">//è·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡</span></div><div class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">        map.set(<span class="keyword">this</span>, value);<span class="comment">//å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡ä¸ä¸ºç©ºï¼Œç›´æ¥è®¾ç½®ç»™ç›®æ ‡å¯¹è±¡ã€‚</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        createMap(t, value);<span class="comment">//ä¸ºå½“å‰çº¿ç¨‹åˆ›å»º ThreadLocalMap å¯¹è±¡ã€‚</span></div><div class="line">    <span class="keyword">return</span> value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ThreadLocal#initialValue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è¯¥æ–¹æ³•çš„è°ƒç”¨æ—¶æœºï¼š</span></div><div class="line"><span class="comment">//1. é€šå¸¸è¯¥æ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶</span></div><div class="line"><span class="comment">//2. è°ƒç”¨äº† ThreadLocal#remove æ–¹æ³•ä¹‹åï¼ˆä½¿å¾— Entry è¢«å›æ”¶ï¼‰ï¼Œå†è°ƒç”¨ ThreadLocal#get æ–¹æ³•</span></div><div class="line"><span class="function"><span class="keyword">protected</span> T <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;<span class="comment">//ï¼›é»˜è®¤å®ç°ä¸ºè¿”å› null</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ThreadLocal#createMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</div><div class="line">    t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);<span class="comment">//è°ƒç”¨æ„é€ æ–¹æ³•åˆå§‹åŒ–</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ThreadLocal-set-æµç¨‹"><a href="#ThreadLocal-set-æµç¨‹" class="headerlink" title="ThreadLocal#set æµç¨‹"></a>ThreadLocal#set æµç¨‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</div><div class="line">    Thread t = Thread.currentThread();<span class="comment">//è·å–å½“å‰çº¿ç¨‹</span></div><div class="line">    ThreadLocalMap map = getMap(t);<span class="comment">//è·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡</span></div><div class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">        map.set(<span class="keyword">this</span>, value);<span class="comment">//å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡ å·²ç»å­˜åœ¨ç›´æ¥è®¾ç½®å€¼</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        createMap(t, value);<span class="comment">//ä¸ºå½“å‰çº¿ç¨‹åˆ›å»º ThreadLocalMap </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° ThreadLocal#set æ–¹æ³•çš„é€»è¾‘ä¸ ThreadLocal#setInitialValue æ–¹æ³•ä¸­çš„é€»è¾‘å¦‚å‡ºä¸€è¾™ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h3 id="ThreadLocalMap"><a href="#ThreadLocalMap" class="headerlink" title="ThreadLocalMap"></a>ThreadLocalMap</h3><p>ThreadLocalMap æ˜¯ ThreadLocal çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ã€‚å…¶ä¸­ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨æ•°æ®ã€‚å¯ä»¥å°†å®ƒç®€å•ç†è§£ä¸ºä¸€ä¸ª HashMapã€‚ThreadLocal#createMap æ–¹æ³•é€šè¿‡è°ƒç”¨ ThreadLocalMap çš„æ„é€ æ–¹æ³•ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºä¸€ä¸ª ThreadLocalMap å¯¹è±¡ã€‚</p>
<h4 id="ThreadLocalMap-çš„æ„é€ æ–¹æ³•"><a href="#ThreadLocalMap-çš„æ„é€ æ–¹æ³•" class="headerlink" title="ThreadLocalMap çš„æ„é€ æ–¹æ³•"></a>ThreadLocalMap çš„æ„é€ æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ThreadLocalMap(ThreadLocal firstKey, Object firstValue) &#123;</div><div class="line">    table = <span class="keyword">new</span> Entry[INITIAL_CAPACITY];<span class="comment">//åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 16 çš„ Entry æ•°ç»„</span></div><div class="line">    <span class="keyword">int</span> i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);<span class="comment">//è®¡ç®— key çš„å“ˆå¸Œå€¼</span></div><div class="line">    table[i] = <span class="keyword">new</span> Entry(firstKey, firstValue);<span class="comment">//å°† Entry å­˜åˆ°æŒ‡å®šä½ç½®ã€‚</span></div><div class="line">    size = <span class="number">1</span>;</div><div class="line">    setThreshold(INITIAL_CAPACITY);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ThreadLocalMap</code> çš„æ„é€ æ–¹æ³•ä¸»è¦åšäº†ä¸‹é¢å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª <code>Entry</code> æ•°ç»„ï¼Œ<ul>
<li><code>Entry</code> æ˜¯ <code>ThreadLocalMap</code> ä¸­çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»,å®ƒä»¥ <code>ThreadLocal</code> ä¸º keyï¼Œä»¥è¦å­˜å‚¨çš„å€¼ä¸º valueã€‚</li>
</ul>
</li>
<li>ç„¶åæ ¹æ® key è®¡ç®— Hash å€¼</li>
<li>æ¥ç€åˆ›å»ºä¸€ä¸ª Entry å¯¹è±¡å­˜å‚¨åœ¨æ•°ç»„ä¸­</li>
<li>æœ€åè®¾ç½®å¤§å°å’Œé˜ˆå€¼ã€‚</li>
</ul>
<h4 id="ThreadLocalMap-Entry"><a href="#ThreadLocalMap-Entry" class="headerlink" title="ThreadLocalMap.Entry"></a>ThreadLocalMap.Entry</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/** The value associated with this ThreadLocal. */</span></div><div class="line">    Object value;</div><div class="line"></div><div class="line">    Entry(ThreadLocal k, Object v) &#123;</div><div class="line">        <span class="keyword">super</span>(k);</div><div class="line">        value = v;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Entry ä½œä¸º ThreadLocalMap çš„å…ƒç´ ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼šThreadLocal çš„å¼±å¼•ç”¨ä¸ºé”®ï¼Œå°†è¦ç”¨ ThreadLocal å­˜å‚¨çš„å¯¹è±¡ä¸ºå€¼ã€‚</p>
<h3 id="è§£å†³å†²çªçš„æ–¹å¼"><a href="#è§£å†³å†²çªçš„æ–¹å¼" class="headerlink" title="è§£å†³å†²çªçš„æ–¹å¼"></a>è§£å†³å†²çªçš„æ–¹å¼</h3><p>çº¿æ€§æ¢æµ‹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">/*ThreadLocals ä¾èµ–äºé™„åŠ åˆ°æ¯ä¸ªçº¿ç¨‹ï¼ˆThread.threadLocalså’ŒinheritableThreadLocalsï¼‰çš„çº¿æ€§æ¢æµ‹ HashMapã€‚ ThreadLocalå¯¹è±¡ä½œä¸ºé”®ï¼Œé€šè¿‡threadLocalHashCodeè¿›è¡Œæœç´¢ã€‚è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ hash codeï¼ˆä»…åœ¨ThreadLocalMapsä¸­æœ‰ç”¨ï¼‰ï¼Œå¯ä»¥æ¶ˆé™¤å¸¸è§æƒ…å†µä¸‹çš„å†²çªï¼Œè€Œåœ¨ä¸å¸¸è§çš„æƒ…å†µä¸‹ä¹Ÿèƒ½è¡¨ç°è‰¯å¥½ã€‚</span></div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> threadLocalHashCode = nextHashCode();</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger nextHashCode = <span class="keyword">new</span> AtomicInteger();</div><div class="line"><span class="comment">/**</span></div><div class="line"> * The difference between successively generated hash codes - turns</div><div class="line"> * implicit sequential thread-local IDs into near-optimally spread</div><div class="line"> * multiplicative hash values for power-of-two-sized tables.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_INCREMENT = <span class="number">0x61c88647</span>;<span class="comment">//ï¼ˆ1640531527ï¼‰åè¿›åˆ¶</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns the next hash code.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nextHashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>java.lang.ThreadLocal.ThreadLocalMap#getEntryAfterMiss</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="keyword">int</span> i, Entry e)</span> </span>&#123;</div><div class="line">    Entry[] tab = table;</div><div class="line">    <span class="keyword">int</span> len = tab.length;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">        ThreadLocal&lt;?&gt; k = e.get();</div><div class="line">        <span class="keyword">if</span> (k == key)</div><div class="line">            <span class="keyword">return</span> e;</div><div class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>)</div><div class="line">            expungeStaleEntry(i);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            i = nextIndex(i, len);</div><div class="line">        e = tab[i];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>java.lang.ThreadLocal.ThreadLocalMap#nextIndex</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nextIndex</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> len)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ((i + <span class="number">1</span> &lt; len) ? i + <span class="number">1</span> : <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ThreadLocal-ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Ÿ"><a href="#ThreadLocal-ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Ÿ" class="headerlink" title="ThreadLocal ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Ÿ"></a>ThreadLocal ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Ÿ</h2><p>å› ä¸ºä½œä¸º key çš„ ThreadLocal æ˜¯å¼±å¼•ç”¨ï¼Œæ‰€ä»¥ä¸€å‘ç”Ÿ GC ï¼ŒThreadLocal å°±ä¼šè¢«å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™ Map ä¸­å­˜åœ¨ä¸€ä¸ª Key ä¸º null çš„é”®å€¼å¯¹ï¼Œä½†æ˜¯ <strong>value ä»ç„¶è¢«çº¿ç¨‹å¼ºå¼•ç”¨ç€</strong>ï¼Œé‚£ä¹ˆå¦‚æœç”¨å®ŒThreadLocalåä¸ä¸»åŠ¨ç§»é™¤ï¼ˆè°ƒç”¨ ThreadLocal#remove æ–¹æ³•ï¼‰ï¼Œå°±ä¼šé€ æˆ<strong>çŸ­æœŸçš„å†…å­˜æ³„æ¼</strong>ã€‚ä½†äº‹å®ä¸Šï¼ŒThreadLocal <strong>ç”¨å®Œåä¸»åŠ¨è°ƒ remove</strong> å°±èƒ½è§„é¿è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>æ³¨ï¼šä¸Šé¢è¯´ value è¢«çº¿ç¨‹å¼ºå¼•ç”¨æ˜¯å› ä¸ºå­˜åœ¨è¿™æ ·ä¸€æ¡å¼•ç”¨é“¾ï¼šæ ˆå¸§ä¸­æŒæœ‰ä¸€ä¸ªå½“å‰çº¿ç¨‹çš„å¼•ç”¨ï¼ŒThreadLocalMap è¢«å½“å‰çº¿ç¨‹å¼•ç”¨ç€ï¼ŒThreadLocalMap ä¸­æœ‰æŒ‡å‘ Entry çš„å¼ºå¼•ç”¨ï¼ŒEntry æœ‰æŒæœ‰ value çš„å¼ºå¼•ç”¨ã€‚å…·ä½“å¯å‚è€ƒä¸‹å›¾ã€‚</p>
<p><img src="https://user-images.githubusercontent.com/16668676/31853072-84517b72-b6b5-11e7-84f1-0a51baaa05a2.png" alt="image"></p>
<p>å½“å‰ Thread ç»“æŸä»¥å, Current Thread å°±ä¸ä¼šå­˜åœ¨æ ˆä¸­,å¼ºå¼•ç”¨æ–­å¼€, Current Thread, Map, valueå°†å…¨éƒ¨è¢«GCå›æ”¶ã€‚</p>
<p>å‰é¢æåˆ°ä¸è°ƒç”¨ remove æ–¹æ³• ThreadLocal ä¼šé€ æˆçŸ­æœŸçš„å†…å­˜æ³„æ¼ï¼Œä¸‹é¢å°±æ¥è¯æ˜ä¸‹è¿™ä¸ªè¯´æ³•æ˜¯å¦æ­£ç¡®ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆè¯´æ˜¯ã€ŒçŸ­æœŸçš„å†…å­˜æ³„æ¼ã€å‘¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¯´æ˜¯ã€ŒçŸ­æœŸçš„å†…å­˜æ³„æ¼ã€å‘¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¯´æ˜¯ã€ŒçŸ­æœŸçš„å†…å­˜æ³„æ¼ã€å‘¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¯´æ˜¯ã€ŒçŸ­æœŸçš„å†…å­˜æ³„æ¼ã€å‘¢ï¼Ÿ</h3><p>ä»¥ ThreadLocal#get ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">    Thread t = Thread.currentThread();</div><div class="line">    ThreadLocalMap map = getMap(t);</div><div class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">        ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);<span class="comment">//è°ƒç”¨ ThreadLcoalMap#getEntry æ–¹æ³•</span></div><div class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> (T)e.value;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> setInitialValue();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntry</span><span class="params">(ThreadLocal key)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</div><div class="line">    Entry e = table[i];</div><div class="line">    <span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e.get() == key)<span class="comment">//å‘½ä¸­</span></div><div class="line">        <span class="keyword">return</span> e;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> getEntryAfterMiss(key, i, e);<span class="comment">//ä¸åœ¨æ•°ç»„çš„ç›¸åº”ä½ç½®ä¸Šï¼ˆå¯èƒ½æ˜¯å†²çªï¼‰</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ThreadLocal.ThreadLocalMap#getEntryAfterMiss</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntryAfterMiss</span><span class="params">(ThreadLocal key, <span class="keyword">int</span> i, Entry e)</span> </span>&#123;</div><div class="line">    Entry[] tab = table;</div><div class="line">    <span class="keyword">int</span> len = tab.length;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">        ThreadLocal k = e.get();</div><div class="line">        <span class="keyword">if</span> (k == key)</div><div class="line">            <span class="keyword">return</span> e;</div><div class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>)</div><div class="line">            expungeStaleEntry(i);<span class="comment">//ç§»é™¤ã€Œè¿‡æœŸçš„ã€Entryï¼Œä¹Ÿå°±æ˜¯ç§»é™¤ key ä¸º null çš„ Entry</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">            i = nextIndex(i, len);<span class="comment">//åŠ  1 ã€Œå–æ¨¡ã€ï¼Œè·å¾—ä¸‹ä¸€ä¸ªåœ°å€</span></div><div class="line">        e = tab[i];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ThreadLocal.ThreadLocalMap#expungeStaleEntry</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ç§»é™¤æŒ‡å®šä¸‹æ ‡å¯¹åº”çš„çš„ã€Œè¿‡æœŸçš„ã€Entryï¼Œ</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">expungeStaleEntry</span><span class="params">(<span class="keyword">int</span> staleSlot)</span> </span>&#123;</div><div class="line">    Entry[] tab = table;</div><div class="line">    <span class="keyword">int</span> len = tab.length;</div><div class="line"></div><div class="line">    <span class="comment">// åˆ é™¤è¿‡æœŸçš„ slot ä¸Šçš„ entry</span></div><div class="line">    tab[staleSlot].value = <span class="keyword">null</span>;</div><div class="line">    tab[staleSlot] = <span class="keyword">null</span>;</div><div class="line">    size--;</div><div class="line"></div><div class="line">    <span class="comment">// ä¸æ–­å°è¯•ï¼Œç›´åˆ°é‡åˆ° e ä¸º nullä¸ºæ­¢ã€‚</span></div><div class="line">    Entry e;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">for</span> (i = nextIndex(staleSlot, len);<span class="comment">//ï¼ˆstaleSlot +1ï¼‰% len</span></div><div class="line">         (e = tab[i]) != <span class="keyword">null</span>;</div><div class="line">         i = nextIndex(i, len)) &#123;<span class="comment">//(i+1)%len</span></div><div class="line">        ThreadLocal k = e.get();<span class="comment">//å¾…æ¸…é™¤çš„ entry</span></div><div class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;<span class="comment">//key ä¸º nullï¼Œè¯´æ˜è¯¥ entry å·²ç»è¿‡æœŸï¼Œéœ€è¦è¢«ç§»é™¤</span></div><div class="line">            e.value = <span class="keyword">null</span>;<span class="comment">//å°† value ç½®ä¸º nullï¼Œæ–¹ä¾¿ GC</span></div><div class="line">            tab[i] = <span class="keyword">null</span>;<span class="comment">//è§£é™¤å¯¹ entry çš„åº”ç”¨</span></div><div class="line">            size--;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//key ä¸ä¸º null çš„æƒ…å†µã€‚è¿™ä¸€æ­¥çš„æ“ä½œä¸»è¦æ˜¯æ–¹ä¾¿æŸ¥æ‰¾ï¼Œæé«˜å‘½ä¸­ç‡</span></div><div class="line">            <span class="keyword">int</span> h = k.threadLocalHashCode &amp; (len - <span class="number">1</span>);<span class="comment">//é€šè¿‡ hash å€¼è®¡ç®—ä¸‹æ ‡</span></div><div class="line">            <span class="keyword">if</span> (h != i) &#123;<span class="comment">//ä¸‹æ ‡ä¸ç›¸ç­‰ï¼Œè¯´æ˜ä¹‹å‰setValue æ—¶å‘ç”Ÿå†²çªï¼Œå¾€åé¢å­˜å‚¨äº†ã€‚</span></div><div class="line">                tab[i] = <span class="keyword">null</span>;<span class="comment">//å°†</span></div><div class="line">				<span class="comment">//ä¸Knuth 6.4ç®—æ³•R ä¸åŒï¼Œæˆ‘ä»¬å¿…é¡»æ‰«æç›´åˆ°nullï¼Œå› ä¸ºå¯èƒ½æœ‰å¤šä¸ªentryå·²ç»è¿‡æœŸã€‚</span></div><div class="line">                <span class="keyword">while</span> (tab[h] != <span class="keyword">null</span>)<span class="comment">//ä»ã€Œæœ¬åº”è¯¥å¯¹åº”çš„ä¸‹æ ‡ã€å¼€å§‹å¾€åæ¢æµ‹ï¼Œç›´åˆ°æœ‰ç©ºä½</span></div><div class="line">                    h = nextIndex(h, len);</div><div class="line">                tab[h] = e;<span class="comment">//å°† e å­˜å‚¨åœ¨å½“å‰æƒ…å†µä¸‹ï¼Œæœ€æ¥è¿‘è‡ªå·±è®¡ç®—å¾—å‡ºä½ç½®çš„é‚£ä¸ªä¸‹æ ‡ã€‚</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> i;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä» <code>ThreadLocal#get</code> æ–¹æ³•ï¼ˆset æ–¹æ³•ä¹Ÿæœ‰ç±»ä¼¼çš„å®ç°ï¼‰çš„è°ƒç”¨é“¾ä¸­å¯ä»¥çœ‹åˆ°ï¼šåœ¨æ²¡æœ‰ä¸»åŠ¨è°ƒç”¨ ThreadLocal#remove çš„æƒ…å†µä¸‹ï¼ŒThreadLocalMapåç»­çš„get/setä¸­ä¹Ÿä¼šæ¢æµ‹åˆ°é‚£äº›keyä¸º nullçš„entryï¼Œç„¶åå°†å…¶ value è®¾ç½®ä¸º null ä»¥å¸®åŠ©GCï¼Œå› æ­¤ <strong>value åœ¨ key è¢« GC åå¯èƒ½è¿˜ä¼šå­˜æ´»ä¸€æ®µæ—¶é—´ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¼šé€ æˆçŸ­æœŸçš„å†…å­˜æ³„æ¼ï¼‰ï¼Œä½†æœ€ç»ˆä¹Ÿä¼šè¢«å›æ”¶</strong>ã€‚è¿™ä¸ªè¿‡ç¨‹å’Œ <code>java.util.WeakHashMap</code> çš„å®ç°å‡ ä¹æ˜¯ä¸€æ ·çš„ã€‚ä¸è¿‡ä¸ºäº†é¿å…æ½œåœ¨çš„å†…å­˜æ³„æ¼è¿˜æ˜¯è¦å…»æˆä¸€ä¸ªä¹ æƒ¯ï¼Œä½¿ç”¨å®Œ ThreadLocal ä¸­çš„value ä¹‹åè¦è°ƒç”¨ <code>ThreadLocal#remove</code> ã€‚</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><h4 id="get-æ–¹æ³•è°ƒç”¨çš„ä¸»è¦æµç¨‹"><a href="#get-æ–¹æ³•è°ƒç”¨çš„ä¸»è¦æµç¨‹" class="headerlink" title="get æ–¹æ³•è°ƒç”¨çš„ä¸»è¦æµç¨‹"></a>get æ–¹æ³•è°ƒç”¨çš„ä¸»è¦æµç¨‹</h4><p><img src="https://user-images.githubusercontent.com/16668676/30096800-004b9f36-930d-11e7-9c27-c7f17619c3a7.png" alt="threadlocal get"></p>
<p>get æ–¹æ³•ä¸­ä¼šå°è¯•è·å–å½“å‰çº¿ç¨‹çš„ ThreadLocalMap</p>
<ul>
<li>å¦‚æœ ThreadLocalMap éç©ºï¼Œå¹¶ä¸”ä»¥å½“å‰ ThreadLocal å¯¹è±¡ä¸º key å»è·å–åˆ°çš„ Entry ä¸ä¸ºç©ºï¼Œå°±è¿”å›è¯¥ ThreadLocal å¯¹åº”çš„å€¼ï¼›</li>
<li>å¦åˆ™ï¼Œå…ˆè·å–é»˜è®¤çš„åˆå§‹å€¼ï¼ˆé»˜è®¤å®ç°ä¸ºç©ºï¼Œå¯ä»¥è‡ªå·±é‡å†™ initialValue æ–¹æ³•æ¥è®¾ç½®éœ€è¦çš„å€¼ï¼‰<ul>
<li>ç„¶ååˆ¤æ–­ ThreadLocalMap æ˜¯å¦ä¸ºç©º<ul>
<li>å¦‚æœä¸ºç©ºåˆ›å»ºä¸€ä¸ª ThreadLocalMap åŒæ—¶å°†åˆå§‹å€¼è®¾ç½®è¿›å»ã€‚</li>
<li>å¦‚æœä¸ä¸ºç©ºï¼Œç›´æ¥æŠŠåˆå§‹å€¼å­˜å‚¨åœ¨å…¶ä¸­ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="set-æ–¹æ³•çš„è°ƒç”¨æµç¨‹"><a href="#set-æ–¹æ³•çš„è°ƒç”¨æµç¨‹" class="headerlink" title="set æ–¹æ³•çš„è°ƒç”¨æµç¨‹"></a>set æ–¹æ³•çš„è°ƒç”¨æµç¨‹</h4><p><img src="https://user-images.githubusercontent.com/16668676/30096799-0047aeee-930d-11e7-8ac5-1927aadeab2d.png" alt="threadlocal set"></p>
<h2 id="ä½ å¯èƒ½å­˜åœ¨çš„ç–‘é—®"><a href="#ä½ å¯èƒ½å­˜åœ¨çš„ç–‘é—®" class="headerlink" title="ä½ å¯èƒ½å­˜åœ¨çš„ç–‘é—®"></a>ä½ å¯èƒ½å­˜åœ¨çš„ç–‘é—®</h2><h3 id="æ¯ä¸ª-ThreadLocal-åªèƒ½æ”¾ä¸€ä¸ªå¯¹è±¡å—ï¼Ÿ"><a href="#æ¯ä¸ª-ThreadLocal-åªèƒ½æ”¾ä¸€ä¸ªå¯¹è±¡å—ï¼Ÿ" class="headerlink" title="æ¯ä¸ª ThreadLocal åªèƒ½æ”¾ä¸€ä¸ªå¯¹è±¡å—ï¼Ÿ"></a>æ¯ä¸ª ThreadLocal åªèƒ½æ”¾ä¸€ä¸ªå¯¹è±¡å—ï¼Ÿ</h3><p>æ¯ä¸ª ThreadLocal åªèƒ½æ”¾ä¸€ä¸ªå¯¹è±¡ã€‚è¦æ˜¯éœ€è¦æ”¾å…¶ä»–çš„å¯¹è±¡ï¼Œå°±å† new ä¸€ä¸ªæ–°çš„ ThreadLocal å‡ºæ¥ï¼Œè¿™ä¸ªæ–°çš„ ThreadLocal å°†ä½œä¸º key,éœ€è¦æ”¾çš„å¯¹è±¡ä½œä¸ºvalueï¼Œæ”¾åœ¨ ThreadLocalMap ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å«æœ‰å¤šä¸ª ThreadLocal ç±»ã€‚</p>
<p>å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦åœ¨ ThreadLocal å­˜æ”¾ä¸€äº›å®¹å™¨å¯¹è±¡ï¼Œæ¯”å¦‚ Listã€Setã€Mapï¼Œä¸€ä¸ª ThreadLocal å­˜æ”¾ä¸€ä¸ªå®¹å™¨å¯¹è±¡ï¼Œå€ŸåŠ©è¯¥å®¹å™¨å¯¹è±¡ä¹Ÿå¯ä»¥å®ç°å­˜å‚¨å¤šä¸ªå¯¹è±¡ã€‚ </p>
<h3 id="ä¸ºä»€ä¹ˆ-ThreadLocal-åªå­˜å‚¨ä¸€ä¸ªå¯¹è±¡å´è¦ç”¨ä¸€ä¸ª-ThreadLocalMap-æ¥å­˜å‚¨å€¼ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆ-ThreadLocal-åªå­˜å‚¨ä¸€ä¸ªå¯¹è±¡å´è¦ç”¨ä¸€ä¸ª-ThreadLocalMap-æ¥å­˜å‚¨å€¼ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆ ThreadLocal  åªå­˜å‚¨ä¸€ä¸ªå¯¹è±¡å´è¦ç”¨ä¸€ä¸ª ThreadLocalMap æ¥å­˜å‚¨å€¼ï¼Ÿ"></a>ä¸ºä»€ä¹ˆ ThreadLocal  åªå­˜å‚¨ä¸€ä¸ªå¯¹è±¡å´è¦ç”¨ä¸€ä¸ª ThreadLocalMap æ¥å­˜å‚¨å€¼ï¼Ÿ</h3><p>å®é™…ä¸Šæ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ª ThreadLocal.ThreadLocalMapï¼ŒçœŸæ­£å­˜å‚¨æ•°æ®çš„ç±»æ˜¯ ThreadLocalMap ï¼Œå¯ä»¥å°†å®ƒçœ‹ä½œæ˜¯ä¸€ä¸ª HashMapï¼Œè€Œ ThreadLocal æ˜¯ä¸€ä¸ª<strong>ç»´æŠ¤ç±»</strong>ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå­˜å‚¨çš„æ—¶å€™ï¼Œéƒ½æ˜¯ä»¥ ThreadLocal å®ä¾‹ä½œä¸º keyï¼Œç„¶åå’Œ value ä¸€èµ·ä½œä¸ºé”®å€¼å¯¹å­˜å‚¨åˆ° ThreadLocalMap ä¸­ã€‚å½“æˆ‘ä»¬è°ƒç”¨ä¸åŒ ThreadLocal çš„ set æ–¹æ³•æ—¶ï¼Œå¦‚æœ ThreadLocalMap ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆç›´æ¥åœ¨é‡Œé¢å­˜å‚¨é”®å€¼å¯¹å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦å†åˆ›å»ºæ–°çš„å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>åŒä¸€ä¸ªçº¿ç¨‹ä¸Šçš„ä¸åŒ ThreadLocal å¯¹è±¡ï¼Œå­˜å‚¨çš„å€¼æ˜¯åœ¨åŒä¸€ä¸ª ThreadLocalMap ä¸Š</strong>ã€‚</p>
<h3 id="æ²¡æœ‰-ThreadLocal-èƒ½ä¸èƒ½è§£å†³é—®é¢˜ï¼Ÿ"><a href="#æ²¡æœ‰-ThreadLocal-èƒ½ä¸èƒ½è§£å†³é—®é¢˜ï¼Ÿ" class="headerlink" title="æ²¡æœ‰ ThreadLocal èƒ½ä¸èƒ½è§£å†³é—®é¢˜ï¼Ÿ"></a>æ²¡æœ‰ ThreadLocal èƒ½ä¸èƒ½è§£å†³é—®é¢˜ï¼Ÿ</h3><p>èƒ½ã€‚</p>
<p>å¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ªé™æ€çš„ mapï¼Œå°†å½“å‰ thread ä½œä¸º keyï¼Œå°†ç›®æ ‡å€¼ä½œä¸º valueï¼Œput åˆ° map ä¸­ï¼Œè¿™ä¹Ÿæ˜¯ä¸€èˆ¬äººçš„æƒ³æ³•ã€‚</p>
<p>ThreadLocal çš„å®ç°åˆšå¥½ç›¸åï¼Œå®ƒæ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­æœ‰ä¸€ä¸ª mapï¼Œè€Œå°† ThreadLocal å®ä¾‹ä½œä¸º keyï¼Œè¿™æ ·æ¯ä¸ª map ä¸­çš„é¡¹æ•°å¾ˆå°‘ï¼Œè€Œä¸”å½“çº¿ç¨‹é”€æ¯æ—¶ç›¸åº”çš„ä¸œè¥¿ä¹Ÿä¸€èµ·é”€æ¯äº†ã€‚<br>å› ä¸ºå„çº¿ç¨‹è®¿é—®çš„ map æ˜¯å„è‡ªä¸åŒçš„ mapï¼Œæ‰€ä»¥ä¸éœ€è¦åŒæ­¥ï¼Œé€Ÿåº¦ä¼šå¿«äº›ï¼›è€Œå¦‚æœæŠŠæ‰€æœ‰çº¿ç¨‹è¦ç”¨çš„å¯¹è±¡éƒ½æ”¾åˆ°ä¸€ä¸ªé™æ€ mapä¸­çš„è¯ å¤šçº¿ç¨‹å¹¶å‘è®¿é—®éœ€è¦è¿›è¡ŒåŒæ­¥ã€‚</p>
<p>æ‰€ä»¥è¯´ ThreadLocal åªæ˜¯å®ç°çº¿ç¨‹ç§æœ‰å˜é‡çš„ä¸€ç§æ–¹å¼ã€‚ä½†æ˜¯ç»¼åˆæ¥çœ‹è¿™ç§æ–¹å¼ç›¸æ¯”å…¶ä»–å®ç°æ–¹å¼è¦æ›´å¥½ã€‚</p>
<h2 id="å…¸å‹åº”ç”¨"><a href="#å…¸å‹åº”ç”¨" class="headerlink" title="å…¸å‹åº”ç”¨"></a>å…¸å‹åº”ç”¨</h2><p>æˆ‘ä»¬é€šå¸¸ä¼šç”¨ä¸‹é¢çš„æ–¹å¼ä¸ºæ™®é€šçº¿ç¨‹åˆ›å»ºä¸€ä¸ª Looperã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> Handler mHandler;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            Looper.prepare();<span class="comment">//ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºä¸€ä¸ª Looper</span></div><div class="line">            mHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">                    <span class="comment">// process incoming messages here</span></div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">            Looper.loop();<span class="comment">//å¼€å¯æ¶ˆæ¯å¾ªç¯</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>Android ä¸­æ¯ä¸ªçº¿ç¨‹ä¸­æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ª Looperï¼Œè¿™ç§é™åˆ¶å°±æ˜¯é€šè¿‡ ThreadLocal æ¥å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Looper</span> </span>&#123;</div><div class="line">  	<span class="comment">//åˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡ï¼Œå…¶æ³›å‹ç±»å‹ä¸º Looperï¼Œåœ¨è°ƒç”¨ prepare ä¹‹å‰ sThreadLocal.get() éƒ½è¿”å›ç©ºã€‚</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;Looper&gt;();</div><div class="line">  	<span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ›å»º Looper æ—¶ä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªæ³›å‹ç±»å‹ä¸º Looper çš„ ThreadLocal å¯¹è±¡ã€‚</p>
<p>Looper#prepare()ï¼Œé€šè¿‡ prepare æ–¹æ³•å¯ä»¥ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºä¸€ä¸ª Looperã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</div><div class="line">    prepare(<span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœçº¿ç¨‹å·²ç»å­˜åœ¨ Looper äº†</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">    &#125;</div><div class="line">    sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));<span class="comment">//ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºä¸€ä¸ª Looper å¯¹è±¡ï¼Œå¹¶å°†å®ƒå­˜å‚¨åœ¨å½“å‰çº¿ç¨‹çš„ ThreadLocalMap ä¸­</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Looper#myLooper() ï¼Œé€šè¿‡è¯¥æ–¹æ³•å¯ä»¥è·å–å½“å‰çº¿ç¨‹çš„ Looper å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> sThreadLocal.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h2><p>å¦‚æœä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è¢«å¤šä¸ªçº¿ç¨‹æŒæœ‰ï¼Œé‚£ä¹ˆå³ä½¿è¯¥å¯¹è±¡å­˜åœ¨ ThreadLocalMap ä¸­ä¹Ÿä¸æ˜¯çº¿ç¨‹çš„æœ¬åœ°å˜é‡ã€‚</p>
<p>é¦–å…ˆï¼ŒThreadLocal ä¸æ˜¯ç”¨æ¥è§£å†³å…±äº«å¯¹è±¡çš„å¤šçº¿ç¨‹è®¿é—®é—®é¢˜çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé€šè¿‡ <code>ThreadLocal.set()</code> åˆ°çº¿ç¨‹ä¸­çš„å¯¹è±¡æ˜¯è¯¥çº¿ç¨‹è‡ªå·±ä½¿ç”¨çš„å¯¹è±¡ï¼Œå…¶ä»–çº¿ç¨‹æ˜¯ä¸éœ€è¦è®¿é—®çš„ï¼Œä¹Ÿè®¿é—®ä¸åˆ°çš„ã€‚å„ä¸ªçº¿ç¨‹ä¸­è®¿é—®çš„æ˜¯ä¸åŒçš„å¯¹è±¡ã€‚ </p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¦è®¿é—®ï¼Œè¿˜è¦çœ‹ä½ çš„ set è¿›å»çš„å¯¹è±¡å¼•ç”¨æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ã€‚ å¦‚æœä¸¤ä¸ªçº¿ç¨‹éƒ½å­˜å…¥åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œé‚£å°±ä¼šæœ‰çº¿ç¨‹å…±äº«é—®é¢˜ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><blockquote>
<p>ThreadLocal é€šè¿‡æ“ä½œ Thread ä¸­çš„ä¸€ä¸ª mapï¼ˆ <code>ThreadLocal.ThreadLocalMap</code>ï¼‰ï¼Œæ¥å®ç°åœ¨ Therad ä¸­æ·»åŠ ä¸€ä¸ªé€»è¾‘ä¸Šçš„æˆå‘˜å˜é‡ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬æ€»ç»“ ThreadLocal å…·ä½“æ˜¯æ€ä¹ˆä¸€æ­¥ä¸€æ­¥å»ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ª~çº¿ç¨‹ç§æœ‰å˜é‡~çš„ï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œåœ¨æ¯ä¸ªçº¿ç¨‹ Thread å†…éƒ¨æœ‰ä¸€ä¸ª <code>ThreadLocal.ThreadLocalMap</code> ç±»å‹çš„æˆå‘˜å˜é‡ threadLocalsï¼Œè¿™ä¸ª threadLocals å°±æ˜¯ç”¨æ¥å­˜å‚¨~çº¿ç¨‹ç§æœ‰å˜é‡çš„~ï¼Œé”®å€¼ï¼ˆkeyï¼‰ä¸ºå½“å‰ ThreadLocal å˜é‡ï¼Œå€¼ value ä¸º~çº¿ç¨‹çš„ç§æœ‰å˜é‡~ï¼ˆå³ T ç±»å‹çš„å˜é‡ï¼‰ã€‚</li>
<li>åˆå§‹æ—¶ï¼Œåœ¨ Thread é‡Œé¢ï¼ŒthreadLocals ä¸ºç©ºï¼Œå½“é€šè¿‡ ThreadLocal å˜é‡è°ƒç”¨ get() æ–¹æ³•æˆ–è€… set() æ–¹æ³•ï¼Œå°±ä¼šå¯¹ Thread ç±»ä¸­çš„ threadLocals è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸”ä»¥å½“å‰ ThreadLocal å˜é‡ä¸º keyï¼Œä»¥ ThreadLocal è¦ä¿å­˜çš„~çº¿ç¨‹ç§æœ‰å˜é‡~ä¸º valueï¼Œå­˜åˆ° threadLocals ä¸­ã€‚<ul>
<li>æ³¨æ„ï¼Œå¦‚æœæ˜¯ å…ˆè°ƒç”¨ get() æ–¹æ³•è€Œä¸æ˜¯ set() æ–¹æ³•çš„è¯ï¼Œä¼šè¿”å› null</li>
</ul>
</li>
<li>ç„¶ååœ¨å½“å‰çº¿ç¨‹é‡Œé¢ï¼Œå¦‚æœè¦ä½¿ç”¨~è¯¥çº¿ç¨‹ç§æœ‰å˜é‡~ï¼Œå°±å¯ä»¥é€šè¿‡ get æ–¹æ³•åœ¨ å½“å‰çº¿ç¨‹çš„<code>ThreadLocal.ThreadLocalMap</code>  ä¸­æŸ¥æ‰¾ã€‚</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://www.iteye.com/topic/103804" target="_blank" rel="noopener">æ­£ç¡®ç†è§£ ThreadLocal</a></li>
<li><a href="http://www.iteye.com/topic/82984" target="_blank" rel="noopener">ThreadLocal and synchronized è¡¥å……</a></li>
<li><a href="http://droidyue.com/blog/2016/03/13/learning-threadlocal-in-java/index.html" target="_blank" rel="noopener">ThreadLocal</a></li>
<li><a href="http://www.cnblogs.com/dolphin0520/p/3920407.html" target="_blank" rel="noopener">Javaå¹¶å‘ç¼–ç¨‹ï¼šæ·±å…¥å‰–æThreadLocal</a></li>
<li><a href="http://www.jianshu.com/p/95291228aff7" target="_blank" rel="noopener">Androidå…³äºThreadLocalçš„æ€è€ƒå’Œæ€»ç»“</a></li>
<li><a href="http://vence.github.io/2016/05/28/threadlocal-info/" target="_blank" rel="noopener">æ·±å…¥ç†è§£ThreadLocal</a></li>
<li><a href="https://www.jianshu.com/p/e0eb1f6a151a" target="_blank" rel="noopener">ä»éœ€æ±‚çš„è§’åº¦å»ç†è§£ThreadLocalåŠæºç è§£æ</a></li>
</ul>
<p>å¦‚æœæœ¬æ–‡ä¸­æœ‰ä¸æ­£ç¡®çš„ç»“è®ºã€è¯´æ³•ï¼Œè¯·å¤§å®¶æŒ‡å‡ºï¼Œå…±åŒæ¢è®¨ï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢!</p>
]]></content>
      
        <categories>
            
            <category> å¹¶å‘ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> å¹¶å‘ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æ˜ç™½åŸç†,è½»æ¾è§£å†³å†…å­˜æ³„æ¼]]></title>
      <url>https://timlin-pro.github.io/blog/2017/08/19/%E6%98%8E%E7%99%BD%E5%8E%9F%E7%90%86-%E8%BD%BB%E6%9D%BE%E8%A7%A3%E5%86%B3%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/</url>
      <content type="html"><![CDATA[<p>ç›¸ä¿¡ã€Œå†…å­˜æ³„æ¼ã€ é—®é¢˜ï¼Œæ˜¯ä¸€ä¸ªæŒºè®©å¼€å‘è€…å¤´ç–¼çš„äº‹æƒ…ï¼Œç¬”è€…åœ¨å›é¡¾ä»¥ä¸ºä»£ç æ—¶ï¼ŒæƒŠè®¶å‘ç°ï¼šåˆå­¦ Android æ—¶ï¼Œè®¸å¤šä¸ä¿®è¾¹å¹…çš„ä»£ç ä¹ æƒ¯ï¼Œå¯¼è‡´äº†è®¸å¤šå†…å­˜æ³„æ¼é—®é¢˜ï¼Œå€Ÿæ­¤åˆ†æå…¶åŸå› ï¼ŒæŠŠè‡ªå·±æŒ–è¿‡çš„å‘è¡¥ä¸€ä¸‹ï¼Œä¹Ÿå¸Œæœ›å¥”è·‘åœ¨ Android å¼€å‘é“è·¯ä¸Šçš„ä½ èƒ½å¤Ÿä¼˜é›…é¿å…ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼"><a href="#ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼" class="headerlink" title="ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼"></a>ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼</h2><ul>
<li>å¯¹äº C++ æ¥è¯´ï¼Œå†…å­˜æ³„æ¼å°±æ˜¯ new å‡ºæ¥çš„å¯¹è±¡æ²¡æœ‰ deleteï¼Œä¿—ç§°é‡æŒ‡é’ˆï¼›</li>
<li>è€Œå¯¹äº java è€Œè¨€ï¼Œå°±æ˜¯å­˜æ”¾åœ¨å †ä¸Šçš„ Object æ— æ³•è¢« GC æ­£å¸¸å›æ”¶ï¼›</li>
</ul>
<a id="more"></a>
<p>åˆ†æä¹‹å‰æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸‰ä¸ªåŸºç¡€çŸ¥è¯†ç‚¹ã€‚</p>
<h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><h3 id="java-çš„å†…å­˜åˆ†é…ç®€è¿°"><a href="#java-çš„å†…å­˜åˆ†é…ç®€è¿°" class="headerlink" title="java çš„å†…å­˜åˆ†é…ç®€è¿°"></a>java çš„å†…å­˜åˆ†é…ç®€è¿°</h3><p>è¿è¡Œæ—¶æ•°æ®åŒºåŸŸå†…å­˜æ¨¡å‹å›¾<br><img src="http://gityuan.com/images/jvm/jvm_memory_1.png" alt=""></p>
<ul>
<li>æ–¹æ³•åŒºï¼ˆnon-heapï¼‰ï¼šç¼–è¯‘æ—¶å°±åˆ†é…å¥½ï¼Œåœ¨ç¨‹åº<strong>æ•´ä¸ªè¿è¡ŒæœŸé—´éƒ½å­˜åœ¨</strong>ã€‚å®ƒä¸»è¦å­˜æ”¾é™æ€æ•°æ®å’Œå¸¸é‡ï¼›</li>
<li>æ ˆåŒºï¼šå½“æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œä¼šåœ¨æ ˆåŒºå†…å­˜ä¸­åˆ›å»ºæ–¹æ³•ä½“å†…éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œæ–¹æ³•ç»“æŸåè‡ªåŠ¨é‡Šæ”¾å†…å­˜ï¼›</li>
<li>å †åŒºï¼ˆheapï¼‰ï¼šé€šå¸¸ç”¨æ¥å­˜æ”¾ new å‡ºæ¥çš„å¯¹è±¡ã€‚ç”± GC è´Ÿè´£å›æ”¶ã€‚</li>
</ul>
<h3 id="å››ç§ä¸åŒç±»å‹çš„å¼•ç”¨"><a href="#å››ç§ä¸åŒç±»å‹çš„å¼•ç”¨" class="headerlink" title="å››ç§ä¸åŒç±»å‹çš„å¼•ç”¨"></a>å››ç§ä¸åŒç±»å‹çš„å¼•ç”¨</h3><p>GC è¿‡ç¨‹ä¸å¯¹è±¡çš„å¼•ç”¨ç±»å‹æœ‰ç€å¾ˆå¤§çš„è”ç³»ï¼Œä¸‹é¢æˆ‘ä»¬å°±çœ‹çœ‹ Java ä¸­ï¼ˆAndroid ä¸­å­˜åœ¨å·®å¼‚ï¼‰çš„å››ç§å¼•ç”¨ï¼š </p>
<ul>
<li>å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰:JVM å®æ„¿æŠ›å‡º OOMï¼Œä¹Ÿä¸ä¼šè®© GC å›æ”¶å­˜åœ¨å¼ºå¼•ç”¨çš„å¯¹è±¡ã€‚</li>
<li>è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰ ï¼šåªæœ‰å†…å­˜ä¸è¶³æ—¶ï¼Œæ‰ä¼šè¢« GC å›æ”¶ã€‚ </li>
<li>å¼±å¼•ç”¨ï¼ˆweak Referenceï¼‰ï¼šåœ¨ GC æ—¶ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡åªå­˜åœ¨å¼±å¼•ç”¨ï¼Œå°†ä¼šè¢«å›æ”¶ </li>
<li>è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰ï¼šä»»ä½•æ—¶å€™éƒ½å¯ä»¥è¢« GC å›æ”¶ï¼Œå½“åƒåœ¾å›æ”¶å™¨å‡†å¤‡å›æ”¶ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœå‘ç°å®ƒè¿˜æœ‰è™šå¼•ç”¨ï¼Œå°±ä¼šåœ¨å›æ”¶å¯¹è±¡çš„å†…å­˜ä¹‹å‰ï¼ŒæŠŠè¿™ä¸ªè™šå¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚ç¨‹åºå¯ä»¥é€šè¿‡åˆ¤æ–­å¼•ç”¨é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨è¯¥å¯¹è±¡çš„è™šå¼•ç”¨ï¼Œæ¥äº†è§£è¿™ä¸ªå¯¹è±¡æ˜¯å¦å°†è¦è¢«å›æ”¶ã€‚å¯ä»¥ç”¨æ¥ä½œä¸º GC å›æ”¶ Object çš„æ ‡å¿—ã€‚ </li>
</ul>
<p>ä¸ Android ä¸­çš„å·®å¼‚ï¼š<strong>åœ¨ 2.3 ä»¥åç‰ˆæœ¬ä¸­ï¼Œå³ä½¿å†…å­˜å¤Ÿç”¨ï¼ŒAndroid ç³»ç»Ÿä¼šä¼˜å…ˆå°† SoftReference çš„å¯¹è±¡æå‰å›æ”¶æ‰</strong>, å…¶ä»–å’Œ Java ä¸­æ˜¯ä¸€æ ·çš„ã€‚<br>å› æ­¤è°·æ­Œå®˜æ–¹å»ºè®®ç”¨ LruCache(least recentlly use æœ€å°‘æœ€è¿‘ä½¿ç”¨ç®—æ³•)ã€‚ä¼šå°†å†…å­˜æ§åˆ¶åœ¨ä¸€å®šçš„å¤§å°å†…, è¶…å‡ºæœ€å¤§å€¼æ—¶ä¼šè‡ªåŠ¨å›æ”¶, è¿™ä¸ªæœ€å¤§å€¼å¼€å‘è€…è‡ªå·±å®šã€‚</p>
<h3 id="å¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#å¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="å¯è¾¾æ€§åˆ†æç®—æ³•"></a>å¯è¾¾æ€§åˆ†æç®—æ³•</h3><p>å†…å­˜æ³„æ¼æ˜¯å› ä¸ºå†…å­˜æ— æ³•è¢«æ­£å¸¸å›æ”¶å¼•èµ·ã€‚ä¸ºä»€ä¹ˆæ— æ³•è¢«å›æ”¶ï¼Ÿæˆ‘ä»¬å‰é¢æ˜¯è¿™ä¹ˆè¯´çš„â€”â€”ã€Œå› ä¸ºå®ƒçš„å¼º/è½¯å¼•ç”¨è¢«é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æŒæœ‰ã€ã€‚å¯ä¸ºä»€ä¹ˆå¼•ç”¨è¢«é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æŒæœ‰å°±ä¸èƒ½è¿›è¡Œé‡Šæ”¾å‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°äº†<a href="https://ivanljt.github.io/blog/2017/09/08/JVM%20%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B8%8E%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/" target="_blank" rel="noopener">åƒåœ¾å›æ”¶æœºåˆ¶</a>ã€‚</p>
<p>è¿›è¡Œåƒåœ¾å›æ”¶çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯å¦‚ä½•ç¡®å®šå“ªäº›å¯¹è±¡æ˜¯å¯ä»¥è¢«å›æ”¶çš„åƒåœ¾ã€‚é€šå¸¸æœ‰ä¸¤ç§åˆ¤æ–­æ–¹æ³•ï¼Œä¸€ç§æ˜¯å¼•ç”¨è®¡æ•°æ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯å¯è¾¾æ€§åˆ†æç®—æ³•ã€‚ä¸»æµçš„å•†ç”¨ç¨‹åºè¯­è¨€çš„ä¸»æµå®ç°ä¸­ï¼Œéƒ½æ˜¯é€šè¿‡<strong>å¯è¾¾æ€§åˆ†æ</strong>æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»çš„ã€‚</p>
<p>å¯è¾¾æ€§åˆ†æç®—æ³•çš„åŸºæœ¬æ€è·¯æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>é€šè¿‡ä¸€ç³»åˆ—çš„ç§°ä¸º GC Root çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºã€å¼•ç”¨é“¾ã€ï¼ˆReference Chainï¼‰</li>
<li><strong>å½“ä¸€ä¸ªå¯¹è±¡åˆ° GC Root æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„</strong>ã€‚</li>
</ul>
<p>é—®é¢˜æ¥äº†ï¼Œåˆ°åº•ä»€ä¹ˆæ˜¯ GC Root å‘¢ï¼Ÿ</p>
<p>R å¤§åœ¨çŸ¥ä¹ä¸­è¿™æ ·ç­”é“ï¼šæ‰€è°“â€œGC rootsâ€ï¼Œæˆ–è€…è¯´tracing GCçš„â€œæ ¹é›†åˆâ€ï¼Œ<strong>ä¸€ç»„å¿…é¡»æ´»è·ƒçš„==å¼•ç”¨==</strong></p>
<blockquote>
<ul>
<li>æ‰€æœ‰Javaçº¿ç¨‹å½“å‰æ´»è·ƒçš„æ ˆå¸§é‡ŒæŒ‡å‘GCå †é‡Œçš„å¯¹è±¡çš„å¼•ç”¨ï¼›æ¢å¥è¯è¯´ï¼Œå½“å‰<strong>æ‰€æœ‰æ­£åœ¨è¢«è°ƒç”¨çš„æ–¹æ³•çš„å¼•ç”¨ç±»å‹çš„å‚æ•°/å±€éƒ¨å˜é‡/ä¸´æ—¶å€¼</strong>ã€‚</li>
<li>VMçš„ä¸€äº›<strong>é™æ€æ•°æ®ç»“æ„é‡ŒæŒ‡å‘GCå †é‡Œçš„å¯¹è±¡çš„å¼•ç”¨</strong>ï¼Œä¾‹å¦‚è¯´HotSpot VMé‡Œçš„Universeé‡Œæœ‰å¾ˆå¤šè¿™æ ·çš„å¼•ç”¨ã€‚</li>
<li>JNI handlesï¼ŒåŒ…æ‹¬global handleså’Œlocal handles</li>
<li>ï¼ˆçœ‹æƒ…å†µï¼‰æ‰€æœ‰å½“å‰è¢«åŠ è½½çš„Javaç±»</li>
<li>ï¼ˆçœ‹æƒ…å†µï¼‰Javaç±»çš„<strong>è¿è¡Œæ—¶å¸¸é‡æ± é‡Œçš„å¼•ç”¨ç±»å‹å¸¸é‡</strong>ï¼ˆStringæˆ–Classç±»å‹ï¼‰</li>
<li>ï¼ˆçœ‹æƒ…å†µï¼‰<strong>Stringå¸¸é‡æ± </strong>ï¼ˆStringTableï¼‰é‡Œçš„å¼•ç”¨</li>
</ul>
</blockquote>
<p>å…³äº GC å›æ”¶æœºåˆ¶ï¼Œå¯ä»¥å‚è€ƒä¸‹<a href="https://ivanljt.github.io/blog/2017/09/08/JVM%20%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B8%8E%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a></p>
<h2 id="å†…å­˜æ³„æ¼çš„å±å®³"><a href="#å†…å­˜æ³„æ¼çš„å±å®³" class="headerlink" title="å†…å­˜æ³„æ¼çš„å±å®³"></a>å†…å­˜æ³„æ¼çš„å±å®³</h2><ul>
<li><strong>è¿è¡Œæ€§èƒ½çš„é—®é¢˜</strong>: Androidåœ¨è¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœå†…å­˜æ³„æ¼å°†å¯¼è‡´å…¶ä»–ç»„ä»¶å¯ç”¨çš„å†…å­˜å˜å°‘ï¼Œä¸€æ–¹é¢ä¼šä½¿å¾—GCçš„é¢‘ç‡åŠ å‰§ï¼Œåœ¨å‘ç”ŸGCçš„æ—¶å€™ï¼Œæ‰€æœ‰è¿›ç¨‹éƒ½å¿…é¡»è¿›è¡Œç­‰å¾…ï¼ŒGCçš„é¢‘ç‡è¶Šå¤šï¼Œä»è€Œç”¨æˆ·è¶Šå®¹æ˜“æ„ŸçŸ¥åˆ°<strong>å¡é¡¿</strong>ã€‚å¦ä¸€æ–¹é¢ï¼Œå†…å­˜å˜å°‘ï¼Œå°†å¯èƒ½ä½¿å¾—ç³»ç»Ÿä¼šé¢å¤–åˆ†é…ç»™ä½ ä¸€äº›å†…å­˜ï¼Œè€Œ<strong>å½±å“æ•´ä¸ªç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µ</strong>ã€‚</li>
<li><strong>è¿è¡Œå´©æºƒé—®é¢˜</strong>: å†…å­˜æ³„éœ²æ˜¯å†…å­˜æº¢å‡º(<strong>OOM</strong>)çš„é‡è¦åŸå› ä¹‹ä¸€ï¼Œä¼šå¯¼è‡´ Crashã€‚å¦‚æœåº”ç”¨ç¨‹åºåœ¨æ¶ˆè€—å…‰äº†æ‰€æœ‰çš„å¯ç”¨å †ç©ºé—´ï¼Œé‚£ä¹ˆå†è¯•å›¾åœ¨å †ä¸Šåˆ†é…æ–°å¯¹è±¡æ—¶å°±ä¼šå¼•èµ· <code>OOM(Out Of Memory Error)</code> å¼‚å¸¸ï¼Œæ­¤æ—¶åº”ç”¨ç¨‹åºå°±ä¼šå´©æºƒé€€å‡ºã€‚</li>
</ul>
<h2 id="å†…å­˜æ³„æ¼çš„å…¸å‹æ¡ˆä¾‹"><a href="#å†…å­˜æ³„æ¼çš„å…¸å‹æ¡ˆä¾‹" class="headerlink" title="å†…å­˜æ³„æ¼çš„å…¸å‹æ¡ˆä¾‹"></a>å†…å­˜æ³„æ¼çš„å…¸å‹æ¡ˆä¾‹</h2><p>è¦æƒ³é¿å…å†…å­˜æ³„æ¼ï¼Œé¦–å…ˆè¦çŸ¥é“å¯¼è‡´å†…å­˜æ³„æ¼çš„åŸå› ã€‚<br><strong>å†…å­˜æ³„æ¼æœ¬è´¨åŸå› </strong>:==é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æŒæœ‰çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„å¼º/è½¯å¼•ç”¨ã€‚å¯¼è‡´æœ¬åº”è¯¥è¢«å›æ”¶çš„çŸ­ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æ— æ³•è¢«æ­£å¸¸å›æ”¶==ã€‚</p>
<p>è¿™ä¹ˆè®²å¯èƒ½æ¯”è¾ƒæŠ½è±¡ã€‚ä¸¾ä¸ªå¸¸è§çš„æ —å­ï¼šå•ä¾‹æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸åœ¨è·å–å•ä¾‹å¯¹è±¡æ—¶éœ€è¦ä¼ ä¸€ä¸ª Context ã€‚å•ä¾‹å¯¹è±¡æ˜¯ä¸€ä¸ªé•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼ˆåº”ç”¨ç¨‹åºç»“æŸæ—¶æ‰ç»ˆç»“ï¼‰ï¼Œè€Œå¦‚æœæˆ‘ä»¬ä¼ é€’çš„æ˜¯æŸä¸€ä¸ª Activity ä½œä¸º context,é‚£ä¹ˆè¿™ä¸ª Activity å°±ä¼šå› ä¸ºå¼•ç”¨è¢«æŒæœ‰è€Œæ— æ³•é”€æ¯ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å¯¼è‡´å†…å­˜æ³„æ¼çš„å¸¸è§ä¾‹å­ã€‚</p>
<h3 id="æ°¸è¿œçš„-Singleton"><a href="#æ°¸è¿œçš„-Singleton" class="headerlink" title="æ°¸è¿œçš„ Singleton"></a>æ°¸è¿œçš„ Singleton</h3><p>å•ä¾‹çš„ä½¿ç”¨åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­éšå¤„å¯è§ï¼Œå› ä¸ºä½¿ç”¨å®ƒå¯ä»¥è§£å†³æˆ‘ä»¬åœ¨ç¨‹åºä¸­é‡å¤åˆ›å»ºå¯¹è±¡çš„é—®é¢˜ã€‚ä½†æ˜¯<strong>ç”±äºå•ä¾‹æ¨¡å¼çš„é™æ€ç‰¹æ€§ï¼Œä½¿å¾—å®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œæˆ‘ä»¬çš„åº”ç”¨ä¸€æ ·é•¿ï¼Œä¸€ä¸å°å¿ƒè®©å•ä¾‹æ— é™åˆ¶çš„æŒæœ‰ Activity çš„å¼ºå¼•ç”¨å°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼</strong>ã€‚</p>
<h4 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><ul>
<li>åº”è¯¥æŠŠä¼ å…¥çš„ Context æ”¹ä¸ºåŒåº”ç”¨ç”Ÿå‘½å‘¨æœŸä¸€æ ·é•¿çš„ Application ä¸­çš„ Contextã€‚</li>
<li>ä¹Ÿå¯ä»¥é€šè¿‡é‡å†™ Applicationï¼Œæä¾› getContext æ–¹æ³•,é‚£æ ·å°±ä¸éœ€è¦åœ¨è·å–å•ä¾‹æ—¶ä¼ å…¥ contextã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseApplication</span> <span class="keyword">extends</span> <span class="title">Application</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext sContext;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        sContext = getApplicationContext();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Context <span class="title">getApplicationContext</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> sContext;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Handler-å¼•å‘çš„å†…å­˜æ³„æ¼"><a href="#Handler-å¼•å‘çš„å†…å­˜æ³„æ¼" class="headerlink" title="Handler å¼•å‘çš„å†…å­˜æ³„æ¼"></a>Handler å¼•å‘çš„å†…å­˜æ³„æ¼</h3><p>ç”±äº Handler é€šå¸¸ä¼šè¢« Message æ‰€æŒæœ‰ï¼Œè€Œ Message é€šå¸¸ä¼šé—´æ¥åœ°è¢«ä¸»çº¿ç¨‹æŒæœ‰ï¼Œå¦‚æœåˆ›å»º Handler çš„æ—¶å€™ï¼Œç›´æ¥é€šè¿‡ new çš„æ–¹å¼åˆ›å»ºåŒ¿åå†…éƒ¨ç±»ï¼ˆé»˜è®¤æŒæœ‰ å¤–éƒ¨ç±»çš„å¼ºå¼•ç”¨ï¼Œnew æ“ä½œé€šå¸¸æ˜¯ Activity æˆ–è€…æ˜¯ Fragment å†…éƒ¨ç›´æ¥ï¼‰ï¼Œåœ¨ç•Œé¢é€€å‡ºçš„æ—¶å€™ï¼Œåˆæ²¡æœ‰è°ƒç”¨ <code>android.os.Handler#removeCallbacksAndMessages</code>æ–¹æ³•ï¼Œå¯èƒ½å°±ä¼šå¯¼è‡´å®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œ Activity ä¸ä¸€è‡´ã€‚è¿›è€Œå®¹æ˜“å¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerBadActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler handler = <span class="keyword">new</span> Handler()&#123;<span class="comment">//éé™æ€å†…éƒ¨ç±»ï¼ŒæŒæœ‰å¤–éƒ¨ç±»çš„å¼ºå¼•ç”¨</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_handler_bad);</div><div class="line">        <span class="comment">// å»¶è¿Ÿ 5min å‘é€ä¸€ä¸ªæ¶ˆæ¯</span></div><div class="line">        handler.postDelayed(<span class="keyword">new</span> Runnable() &#123;<span class="comment">//å†…éƒ¨ä¼šå°†è¯¥ Runable å°è£…ä¸ºä¸€ä¸ª Message å¯¹è±¡ï¼ŒåŒæ—¶å°† Message.target èµ‹å€¼ä¸º handler</span></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="comment">//do something</span></div><div class="line">            &#125;</div><div class="line">        &#125;, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">5</span>);</div><div class="line">        <span class="keyword">this</span>.finish();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç ä¸­å‘é€äº†ä¸€ä¸ªå»¶æ—¶ 5 åˆ†é’Ÿæ‰§è¡Œçš„ Messageï¼Œå½“è¯¥ Activity é€€å‡ºçš„æ—¶å€™ï¼Œå»¶æ—¶ä»»åŠ¡ï¼ˆMessageï¼‰è¿˜åœ¨ä¸»çº¿ç¨‹çš„ MessageQueue ä¸­ç­‰å¾…ï¼Œæ­¤æ—¶çš„ <strong>Message æŒæœ‰ Handler çš„å¼ºå¼•ç”¨</strong>ï¼ˆåˆ›å»ºæ—¶é€šè¿‡ Message.target è¿›è¡ŒæŒ‡å®šï¼‰ï¼Œå¹¶ä¸”ç”±äº Handler æ˜¯ HandlerBadActivity çš„<strong>éé™æ€å†…éƒ¨ç±»ï¼Œæ‰€ä»¥ Handler ä¼šæŒæœ‰ä¸€ä¸ªæŒ‡å‘ HandlerBadActivity çš„å¼ºå¼•ç”¨</strong>ï¼ŒåŒæ—¶ Message è¢« MessageQueue æ‰€æŒæœ‰ï¼ŒMessageQueue åˆè¢«ä¸»çº¿ç¨‹ Looper æŒæœ‰ï¼Œä¸»çº¿ç¨‹ Looper è¢«ä¸»çº¿ç¨‹çš„ looper æ‰€æŒæœ‰ï¼ˆå¼•ç”¨é“¾ä¸ºï¼š ä¸»Thread â€”&gt; Looperâ€”&gt; MessageQueue â€”&gt; Message â€”&gt;  Handler å®ä¾‹ â€”&gt;  Activity ï¼‰ æ‰€ä»¥è™½ç„¶æ­¤æ—¶ HandlerBadActivity è°ƒç”¨äº† finish ä¹Ÿæ— æ³•è¿›è¡Œå†…å­˜å›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p>
<h4 id="è§£å†³-1"><a href="#è§£å†³-1" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><p>å°† Handler å£°æ˜ä¸º<strong>é™æ€å†…éƒ¨ç±»</strong>ï¼Œä½†æ˜¯è¦æ³¨æ„å¦‚æœç”¨åˆ° Context ç­‰å¤–éƒ¨ç±»çš„ éstatic å¯¹è±¡ï¼Œè¿˜æ˜¯åº”è¯¥ä½¿ç”¨ ApplicationContext æˆ–è€…é€šè¿‡å¼±å¼•ç”¨æ¥æŒæœ‰è¿™äº›å¤–éƒ¨å¯¹è±¡ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerGoodActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span></span>&#123;<span class="comment">//å£°æ˜ä¸ºé™æ€å†…éƒ¨ç±»ï¼ˆé¿å…æŒæœ‰å¤–éƒ¨ç±»çš„å¼ºå¼•ç”¨ï¼‰</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;HandlerGoodActivity&gt; mActivity;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyHandler</span><span class="params">(HandlerGoodActivity activity)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.mActivity = <span class="keyword">new</span> WeakReference&lt;HandlerGoodActivity&gt;(activity);<span class="comment">//ä½¿ç”¨å¼±å¼•ç”¨</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            HandlerGoodActivity activity = mActivity.get();</div><div class="line">            <span class="keyword">if</span> (activity == <span class="keyword">null</span> || activity.isFinishing() || activity.isDestroyed()) &#123;<span class="comment">//åˆ¤æ–­ activity æ˜¯å¦ä¸ºç©ºï¼Œä»¥åŠæ˜¯å¦æ­£åœ¨è¢«é”€æ¯ã€æˆ–è€…å·²ç»è¢«é”€æ¯</span></div><div class="line">              removeCallbacksAndMessages(<span class="keyword">null</span>);</div><div class="line">              <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// do something</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MyHandler myHandler = <span class="keyword">new</span> MyHandler(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="æ…ç”¨-static-æˆå‘˜å˜é‡"><a href="#æ…ç”¨-static-æˆå‘˜å˜é‡" class="headerlink" title="æ…ç”¨ static æˆå‘˜å˜é‡"></a>æ…ç”¨ static æˆå‘˜å˜é‡</h3><p>ä»å‰é¢çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ï¼Œstatic ä¿®é¥°çš„å˜é‡ä½äºå†…å­˜çš„æ–¹æ³•åŒºï¼Œ<strong>å…¶ç”Ÿå‘½å‘¨æœŸä¸ App çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´</strong>ã€‚<br>è¿™å¿…ç„¶ä¼šå¯¼è‡´ä¸€ç³»åˆ—é—®é¢˜ï¼Œå¦‚æœä½ çš„ app è¿›ç¨‹è®¾è®¡ä¸Šæ˜¯é•¿é©»å†…å­˜çš„ï¼Œé‚£å³ä½¿ app åˆ‡åˆ°åå°ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚</p>
<h4 id="è§£å†³-2"><a href="#è§£å†³-2" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><p>ä¸è¦åœ¨ç±»åˆå§‹æ—¶åˆå§‹åŒ–é™æ€æˆå‘˜ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è€ƒè™‘æ‡’åŠ è½½ã€‚æ¶æ„è®¾è®¡ä¸Šè¦æ€è€ƒæ˜¯å¦çœŸçš„æœ‰å¿…è¦è¿™æ ·åšï¼Œå°½é‡é¿å…ã€‚å¦‚æœæ¶æ„éœ€è¦è¿™ä¹ˆè®¾è®¡ï¼Œé‚£ä¹ˆæ­¤å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä½ æœ‰è´£ä»»ç®¡ç†èµ·æ¥ã€‚</p>
<p>å½“ç„¶ï¼ŒApplication çš„ context ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½éšä¾¿ä¹±ç”¨ï¼Œå¯¹äºæœ‰äº›åœ°æ–¹åˆ™å¿…é¡»ä½¿ç”¨ Activity çš„ Contextï¼Œå¯¹äºApplicationï¼ŒServiceï¼ŒActivityä¸‰è€…çš„Contextçš„åº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š</p>
<p><img src="http://upload-images.jianshu.io/upload_images/727790-afde094317e73842.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ä¸åŒ Context çš„åº”ç”¨åœºæ™¯"></p>
<p>è¯´æ˜ï¼š </p>
<ul>
<li>NO1 è¡¨ç¤º Application å’Œ Service å¯ä»¥å¯åŠ¨ä¸€ä¸ª Activityï¼Œä¸è¿‡éœ€è¦==åˆ›å»ºä¸€ä¸ªæ–°çš„ task ä»»åŠ¡é˜Ÿåˆ—==ã€‚</li>
<li>å¯¹äº Dialog è€Œè¨€ï¼Œåªæœ‰åœ¨ Activity ä¸­æ‰èƒ½åˆ›å»º</li>
</ul>
<p>ä¸‹é¢ä¸¾ä¸€ä¸ªéšè”½çš„æ —å­</p>
<h3 id="ä½¿ç”¨ç³»ç»ŸæœåŠ¡å¼•å‘çš„å†…å­˜æ³„æ¼"><a href="#ä½¿ç”¨ç³»ç»ŸæœåŠ¡å¼•å‘çš„å†…å­˜æ³„æ¼" class="headerlink" title="ä½¿ç”¨ç³»ç»ŸæœåŠ¡å¼•å‘çš„å†…å­˜æ³„æ¼"></a>ä½¿ç”¨ç³»ç»ŸæœåŠ¡å¼•å‘çš„å†…å­˜æ³„æ¼</h3><p>ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ä¸€äº›å¸¸è§çš„ç³»ç»ŸæœåŠ¡ï¼ŒActivity åšäº†ä¸€äº›å°è£…ã€‚æ¯”å¦‚è¯´ï¼Œå¯ä»¥é€šè¿‡ getPackageManager åœ¨ Activtiy ä¸­è·å– PackageManagerServiceï¼Œä½†æ˜¯ï¼Œé‡Œé¢å®é™…ä¸Šè°ƒç”¨äº† Activity å¯¹åº”çš„ ContextImpl ä¸­çš„ getPackageManager æ–¹æ³•</p>
<p><code>ContextWrapper#getPackageManager</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> PackageManager <span class="title">getPackageManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mBase.getPackageManager();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ContextImpl#getPackageManager</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> PackageManager <span class="title">getPackageManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mPackageManager != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> mPackageManager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    IPackageManager pm = ActivityThread.getPackageManager();</div><div class="line">    <span class="keyword">if</span> (pm != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// Doesn't matter if we make more than one instance.</span></div><div class="line">        <span class="keyword">return</span> (mPackageManager = <span class="keyword">new</span> ApplicationPackageManager(<span class="keyword">this</span>, pm));<span class="comment">//åˆ›å»º ApplicationPackageManager</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ApplicationPackageManager#ApplicationPackageManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ApplicationPackageManager(ContextImpl context,</div><div class="line">                          IPackageManager pm) &#123;</div><div class="line">    mContext = context;<span class="comment">//ä¿å­˜ ContextImpl çš„å¼ºå¼•ç”¨</span></div><div class="line">    mPM = pm;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">UserManagerService</span><span class="params">(Context context, PackageManagerService pm,</span></span></div><div class="line">        Object packagesLock, File dataDir) &#123;</div><div class="line">    mContext = context;<span class="comment">//æŒæœ‰å¤–éƒ¨ Context å¼•ç”¨</span></div><div class="line">    mPm = pm;</div><div class="line"> 	<span class="comment">//ä»£ç çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>PackageManagerService#PackageManagerService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerService</span> <span class="keyword">extends</span> <span class="title">IPackageManager</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> UserManagerService sUserManager;<span class="comment">//æŒæœ‰ UMS é™æ€å¼•ç”¨</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></div><div class="line">        <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore) &#123;</div><div class="line">          sUserManager = <span class="keyword">new</span> UserManagerService(context, <span class="keyword">this</span>, mPackages);<span class="comment">//åˆå§‹åŒ– UMS</span></div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬”è€…é‡åˆ°çš„å†…å­˜æ³„æ¼é—®é¢˜æ˜¯å› ä¸ºåœ¨ Activity ä¸­è°ƒç”¨äº† getPackageManger æ–¹æ³•è·å– PMS ï¼Œè¯¥æ–¹æ³•è°ƒç”¨çš„æ˜¯ ContextImplï¼Œæ­¤æ—¶å¦‚æœContextImpl ä¸­  PackageManager ä¸º nullï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª PackageMangerï¼ˆContextImpl ä¼šå°†è‡ªå·±ä¼ é€’è¿›å»ï¼Œè€Œ ContextImpl çš„  mOuterContext ä¸º Activityï¼‰ï¼Œåˆ›å»º PackageManager å®é™…ä¸Šä¼šåˆ›å»º PackageManagerServiceï¼ˆç®€ç§° PMSï¼‰ï¼Œè€Œ PMS çš„æ„é€ æ–¹æ³•ä¸­ä¼šåˆ›å»ºä¸€ä¸ª UserMangerï¼ˆUserManger åˆå§‹åŒ–ä¹‹åä¼šæŒæœ‰ ContextImpl çš„å¼ºå¼•ç”¨ï¼‰ã€‚</p>
<p>åªè¦ PMS çš„ class æœªè¢«é”€æ¯ï¼Œé‚£ä¹ˆå°±ä¼šä¸€ç›´å¼•ç”¨ç€ UserManger ï¼Œè¿›è€Œå¯¼è‡´å…¶å…³è”åˆ°çš„èµ„æºæ— æ³•æ­£å¸¸é‡Šæ”¾ã€‚</p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>æœ¬ä¾‹çš„å¼•ç”¨é“¾å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p>æ–¹æ³•åŒºä¸­ï¼ˆ1.8 åç§»åˆ°äº† å…ƒç©ºé—´ï¼‰å«æœ‰å·²ç»åŠ è½½çš„ PMS classï¼ŒPMS é™æ€å¼•ç”¨ â€“&gt; UserMangerï¼ˆmContextï¼‰ â€“&gt; ContextImplï¼ˆmOuterContextï¼‰ â€“&gt; Activity (èµ„æºæ— æ³•è¢«æ­£å¸¸å›æ”¶)</p>
<p>é€šå¸¸è¿™ç§å†…å­˜æ³„æ¼æ€»æ˜¯æ¯”è¾ƒéšè”½ï¼Œä¸ä½¿ç”¨æ£€æµ‹å·¥å…·ï¼Œæ ¹æœ¬å°±æƒ³ä¸åˆ°ï¼ŒåŸæ¥é‚£ä¸€è¡Œä»£ç ç«Ÿç„¶ä¼šå¼•å‘å†…å­˜æ³„æ¼ã€‚</p>
<h4 id="è§£å†³-3"><a href="#è§£å†³-3" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><p>å°†getPackageManager() æ”¹ä¸º getApplication()#getPackageManager() ã€‚è¿™æ ·å¼•ç”¨çš„å°±æ˜¯ Application Contextï¼Œè€Œé Activity äº†ã€‚</p>
<h3 id="è¿œç¦»éé™æ€å†…éƒ¨ç±»å’ŒåŒ¿åç±»ï¼Œæœ‰éœ€è¦æ—¶è¯·ä½¿ç”¨é™æ€å†…éƒ¨ç±»"><a href="#è¿œç¦»éé™æ€å†…éƒ¨ç±»å’ŒåŒ¿åç±»ï¼Œæœ‰éœ€è¦æ—¶è¯·ä½¿ç”¨é™æ€å†…éƒ¨ç±»" class="headerlink" title="è¿œç¦»éé™æ€å†…éƒ¨ç±»å’ŒåŒ¿åç±»ï¼Œæœ‰éœ€è¦æ—¶è¯·ä½¿ç”¨é™æ€å†…éƒ¨ç±»"></a>è¿œç¦»éé™æ€å†…éƒ¨ç±»å’ŒåŒ¿åç±»ï¼Œæœ‰éœ€è¦æ—¶è¯·ä½¿ç”¨é™æ€å†…éƒ¨ç±»</h3><p>ä¸ºä»€ä¹ˆè¦æ€ä¹ˆåšå‘¢?å› ä¸ºä½¿ç”¨éé™æ€å†…éƒ¨ç±»å’ŒåŒ¿åç±»éƒ½ä¼šé»˜è®¤æŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œå¦‚æœç”Ÿå‘½å‘¨æœŸä¸ä¸€è‡´ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<p>çœ‹ä¸€ä¸ªä¾‹å­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NestedClassLeakActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">InnerClass</span> </span>&#123;<span class="comment">//éé™æ€å†…éƒ¨ç±»</span></div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InnerClass sInner;<span class="comment">//æŒ‡å‘éé™æ€å†…éƒ¨ç±»çš„é™æ€å¼•ç”¨</span></div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_nested_class);</div><div class="line">        <span class="keyword">if</span> (sInner == <span class="keyword">null</span>) &#123;</div><div class="line">           sInner = <span class="keyword">new</span> InnerClass();<span class="comment">//åˆ›å»ºéé™æ€å†…éƒ¨ç±»çš„å®ä¾‹</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ¬ä¾‹ä¸­ï¼Œå› ä¸º<strong>éé™æ€å†…éƒ¨ç±»é»˜è®¤ä¼šæŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨</strong>ï¼Œè€Œå¤–éƒ¨ç±»ä¸­åˆæœ‰ä¸€ä¸ªè¯¥éé™æ€å†…éƒ¨ç±»çš„é™æ€å®ä¾‹ï¼Œè¯¥é™æ€å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸå’Œåº”ç”¨çš„ä¸€æ ·é•¿ï¼Œè€Œé™æ€å®ä¾‹åˆæŒæœ‰ Activity çš„å¼•ç”¨ï¼Œå› æ­¤å¯¼è‡´ Activity çš„å†…å­˜èµ„æºä¸èƒ½æ­£å¸¸å›æ”¶ã€‚</p>
<h4 id="è§£å†³-4"><a href="#è§£å†³-4" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><ol>
<li>å°†è¯¥å†…éƒ¨ç±»è®¾ä¸ºé™æ€å†…éƒ¨ç±»</li>
<li>ä¹Ÿå¯ä»¥å°†è¯¥å†…éƒ¨ç±»æŠ½å–å‡ºæ¥å°è£…æˆä¸€ä¸ªå•ä¾‹</li>
</ol>
<h3 id="é›†åˆå¼•å‘çš„å†…å­˜æ³„æ¼"><a href="#é›†åˆå¼•å‘çš„å†…å­˜æ³„æ¼" class="headerlink" title="é›†åˆå¼•å‘çš„å†…å­˜æ³„æ¼"></a>é›†åˆå¼•å‘çš„å†…å­˜æ³„æ¼</h3><p>æˆ‘ä»¬é€šå¸¸ä¼šæŠŠä¸€äº›å¯¹è±¡çš„å¼•ç”¨åŠ å…¥åˆ°é›†åˆå®¹å™¨ï¼ˆæ¯”å¦‚ArrayListï¼‰ä¸­ï¼Œå½“æˆ‘ä»¬ä¸å†éœ€è¦è¯¥å¯¹è±¡æ—¶ï¼ˆé€šå¸¸ä¼šè°ƒç”¨ remove æ–¹æ³•ï¼‰ï¼Œå¹¶æ²¡æœ‰æŠŠå®ƒçš„å¼•ç”¨ä»é›†åˆä¸­æ¸…ç†æ‰ï¼ˆå…¶ä¸­çš„ä¸€ç§æƒ…å†µå°±æ˜¯ remove æ–¹æ³•æ²¡æœ‰å°†ä¸å†éœ€è¦çš„å¼•ç”¨èµ‹å€¼ä¸º nullï¼‰ï¼Œä¸‹é¢ä»¥ ArrayList çš„ remove æ–¹æ³•ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">( <span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    <span class="comment">// æ•°ç»„è¶Šç•Œæ£€æŸ¥</span></div><div class="line">    RangeCheck(index);</div><div class="line">    modCount++;</div><div class="line">    <span class="comment">// å–å‡ºè¦åˆ é™¤ä½ç½®çš„å…ƒç´ ï¼Œä¾›è¿”å›ä½¿ç”¨</span></div><div class="line">    E oldValue = (E) elementData[index];</div><div class="line">   <span class="comment">// è®¡ç®—æ•°ç»„è¦å¤åˆ¶çš„æ•°é‡</span></div><div class="line">    <span class="keyword">int</span> numMoved = size - index - <span class="number">1</span>;</div><div class="line">   <span class="comment">// æ•°ç»„å¤åˆ¶ï¼Œå°±æ˜¯å°†indexä¹‹åçš„å…ƒç´ å¾€å‰ç§»åŠ¨ä¸€ä¸ªä½ç½®</span></div><div class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</div><div class="line">       System. arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</div><div class="line">                      numMoved);</div><div class="line">   <span class="comment">// å°†æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ç½®ç©ºï¼ˆå› ä¸ºåˆ é™¤äº†ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åindexåé¢çš„å…ƒç´ éƒ½å‘å‰ç§»åŠ¨äº†ï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªå°±æ²¡ç”¨äº†ï¼‰ï¼Œå¥½è®©gcå°½å¿«å›æ”¶</span></div><div class="line">    elementData[--size ] = <span class="keyword">null</span>; <span class="comment">// Let gc do its work</span></div><div class="line">    <span class="keyword">return</span> oldValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>elementData[--size ] = null; // Let gc do its work</code> å¦‚æœæ›¿æ¢ä¸º <code>--size</code>ï¼Œå°±ä¼šå¯¼è‡´å·²ç»ã€Œç§»é™¤ã€çš„å¯¹è±¡å› ä¸ºå¼ºå¼•ç”¨è¢«é›†åˆæŒæœ‰ï¼Œè€Œæ— æ³•æ­£å¸¸è¢« gc å›æ”¶ã€‚</p>
<h3 id="WebView-å¼•å‘çš„å†…å­˜æ³„æ¼"><a href="#WebView-å¼•å‘çš„å†…å­˜æ³„æ¼" class="headerlink" title="WebView å¼•å‘çš„å†…å­˜æ³„æ¼"></a>WebView å¼•å‘çš„å†…å­˜æ³„æ¼</h3><p>WebView è§£æç½‘é¡µæ—¶ä¼šç”³è¯·<strong>Nativeå †å†…å­˜</strong>ç”¨äºä¿å­˜é¡µé¢å…ƒç´ ï¼Œå½“é¡µé¢è¾ƒå¤æ‚æ—¶ä¼šæœ‰å¾ˆå¤§çš„å†…å­˜å ç”¨ã€‚å¦‚æœé¡µé¢åŒ…å«å›¾ç‰‡ï¼Œå†…å­˜å ç”¨ä¼šæ›´ä¸¥é‡ã€‚å¹¶ä¸”æ‰“å¼€æ–°é¡µé¢æ—¶ï¼Œä¸ºäº†èƒ½å¿«é€Ÿå›é€€ï¼Œ<strong>ä¹‹å‰é¡µé¢å ç”¨çš„å†…å­˜ä¹Ÿä¸ä¼šé‡Šæ”¾</strong>ã€‚æœ‰æ—¶æµè§ˆåå‡ ä¸ªç½‘é¡µï¼Œéƒ½ä¼šå ç”¨å‡ ç™¾å…†çš„å†…å­˜ã€‚è¿™æ ·åŠ è½½ç½‘é¡µè¾ƒå¤šæ—¶ï¼Œä¼šå¯¼è‡´ç³»ç»Ÿä¸å ªé‡è´Ÿï¼Œæœ€ç»ˆå¼ºåˆ¶å…³é—­åº”ç”¨ï¼Œä¹Ÿå°±æ˜¯å‡ºç°åº”ç”¨é—ªé€€æˆ–é‡å¯ã€‚</p>
<p>ç”±äºå ç”¨çš„éƒ½æ˜¯ <strong>Native å †å†…å­˜</strong>ï¼Œæ‰€ä»¥<strong>å®é™…å ç”¨çš„å†…å­˜å¤§å°ä¸ä¼šæ˜¾ç¤ºåœ¨å¸¸ç”¨çš„ DDMS Heap å·¥å…·ä¸­</strong>ï¼ˆ DMS Heap å·¥å…·çœ‹åˆ°çš„åªæ˜¯Javaè™šæ‹Ÿæœºåˆ†é…çš„å†…å­˜ï¼Œå³ä½¿Nativeå †å†…å­˜å·²ç»å ç”¨äº†å‡ ç™¾å…†ï¼Œè¿™é‡Œæ˜¾ç¤ºçš„è¿˜åªæ˜¯å‡ å…†æˆ–åå‡ å…†ï¼‰ã€‚åªæœ‰ä½¿ç”¨ adb shell ä¸­çš„ä¸€äº›å‘½ä»¤æ¯”å¦‚ dumpsys meminfo åŒ…åï¼Œæˆ–è€…åœ¨ç¨‹åºä¸­ä½¿ç”¨ <code>Debug.getNativeHeapSize()</code> æ‰èƒ½çœ‹åˆ° Native å †å†…å­˜ä¿¡æ¯ã€‚</p>
<p>æ®è¯´ç”±äº WebView çš„ä¸€ä¸ª BUGï¼Œå³ä½¿å®ƒæ‰€åœ¨çš„ Activity(æˆ–è€…Service) ç»“æŸä¹Ÿå°±æ˜¯ onDestroy() ä¹‹åï¼Œæˆ–è€…ç›´æ¥è°ƒç”¨ WebView.destroy()ä¹‹åï¼Œå®ƒæ‰€å ç”¨è¿™äº›å†…å­˜ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚</p>
<h4 id="è§£å†³-5"><a href="#è§£å†³-5" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><p>æŠŠä½¿ç”¨äº† WebView çš„ Activity (æˆ–è€… Service) æ”¾åœ¨å•ç‹¬çš„è¿›ç¨‹é‡Œã€‚</p>
<ul>
<li>ç³»ç»Ÿåœ¨æ£€æµ‹åˆ°åº”ç”¨å ç”¨å†…å­˜è¿‡å¤§æœ‰å¯èƒ½è¢«ç³»ç»Ÿå¹²æ‰ </li>
<li>ä¹Ÿå¯ä»¥åœ¨å®ƒæ‰€åœ¨çš„ Activity(æˆ–è€… Service) ç»“æŸåï¼Œè°ƒç”¨ <code>System.exit(0)</code>ï¼Œä¸»åŠ¨Killæ‰è¿›ç¨‹ã€‚ç”±äºç³»ç»Ÿçš„å†…å­˜åˆ†é…æ˜¯ä»¥è¿›ç¨‹ä¸ºå‡†çš„ï¼Œè¿›ç¨‹å…³é—­åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶æ‰€æœ‰å†…å­˜ã€‚</li>
</ul>
<p>ä½¿ç”¨ WebView çš„é¡µé¢ï¼ˆActivityï¼‰ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸé¡µé¢é€€å‡ºï¼ˆonDestoryï¼‰çš„æ—¶å€™ï¼Œä¸»åŠ¨è°ƒç”¨<strong>WebView.onPause()==ä»¥åŠ==WebView.destory()</strong>ä»¥ä¾¿è®©ç³»ç»Ÿé‡Šæ”¾ WebView ç›¸å…³èµ„æºã€‚</p>
<h3 id="å…¶ä»–å¸¸è§çš„å¼•èµ·å†…å­˜æ³„æ¼åŸå› "><a href="#å…¶ä»–å¸¸è§çš„å¼•èµ·å†…å­˜æ³„æ¼åŸå› " class="headerlink" title="å…¶ä»–å¸¸è§çš„å¼•èµ·å†…å­˜æ³„æ¼åŸå› "></a>å…¶ä»–å¸¸è§çš„å¼•èµ·å†…å­˜æ³„æ¼åŸå› </h3><ul>
<li>Android 3.0 ä»¥ä¸‹ï¼ŒBitmap åœ¨ä¸ä½¿ç”¨çš„æ—¶å€™æ²¡æœ‰ä½¿ç”¨ recycle() é‡Šæ”¾å†…å­˜ã€‚</li>
<li><strong>éé™æ€å†…éƒ¨ç±»çš„é™æ€å®ä¾‹</strong>å®¹æ˜“é€ æˆå†…å­˜æ³„æ¼ï¼šå³ä¸€ä¸ªç±»ä¸­å¦‚æœä½ ä¸èƒ½å¤Ÿæ§åˆ¶å®ƒå…¶ä¸­å†…éƒ¨ç±»çš„ç”Ÿå‘½å‘¨æœŸï¼ˆè­¬å¦‚Activityä¸­çš„ä¸€äº›ç‰¹æ®ŠHandlerç­‰ï¼‰ï¼Œåˆ™å°½é‡ä½¿ç”¨é™æ€ç±»å’Œå¼±å¼•ç”¨æ¥å¤„ç†ï¼ˆè­¬å¦‚ViewRootçš„å®ç°ï¼‰ã€‚</li>
<li>è­¦æƒ•<strong>çº¿ç¨‹æœªç»ˆæ­¢é€ æˆçš„å†…å­˜æ³„éœ²</strong>ï¼›è­¬å¦‚åœ¨ Activity ä¸­å…³è”äº†ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸè¶…è¿‡ Activity çš„ Threadï¼Œåœ¨é€€å‡º Activity æ—¶åˆ‡è®°ç»“æŸçº¿ç¨‹ã€‚<ul>
<li>ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯ HandlerThread çš„ run æ–¹æ³•ã€‚è¯¥æ–¹æ³•åœ¨è¿™é‡Œæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå®ƒä¸ä¼šè‡ªå·±ç»“æŸï¼Œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸè¶…è¿‡äº† Activity ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨åœ¨ Activity çš„é”€æ¯æ–¹æ³•ä¸­ä¸­è°ƒç”¨ <code>thread.getLooper().quit()</code> æ‰ä¸ä¼šæ³„éœ²ã€‚</li>
</ul>
</li>
<li><strong>å¯¹è±¡çš„æ³¨å†Œä¸åæ³¨å†Œæ²¡æœ‰æˆå¯¹å‡ºç°</strong>é€ æˆçš„å†…å­˜æ³„éœ²ï¼›è­¬å¦‚æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ã€æ³¨å†Œè§‚å¯Ÿè€…ï¼ˆå…¸å‹çš„è­¬å¦‚æ•°æ®åº“çš„ç›‘å¬ï¼‰ç­‰ã€‚</li>
<li><strong>åˆ›å»ºä¸å…³é—­æ²¡æœ‰æˆå¯¹å‡ºç°é€ æˆçš„æ³„éœ²</strong>ï¼›è­¬å¦‚Cursorèµ„æºå¿…é¡»æ‰‹åŠ¨å…³é—­ï¼ŒWebViewå¿…é¡»æ‰‹åŠ¨é”€æ¯ï¼Œæµç­‰å¯¹è±¡å¿…é¡»æ‰‹åŠ¨å…³é—­ç­‰ã€‚</li>
<li>é¿å…ä»£ç è®¾è®¡æ¨¡å¼çš„é”™è¯¯é€ æˆå†…å­˜æ³„éœ²ï¼›è­¬å¦‚å¾ªç¯å¼•ç”¨ï¼ŒA æŒæœ‰ Bï¼ŒB æŒæœ‰ Cï¼ŒC æŒæœ‰ Aï¼Œè¿™æ ·çš„è®¾è®¡è°éƒ½å¾—ä¸åˆ°é‡Šæ”¾ã€‚</li>
</ul>
<h2 id="å†…å­˜æ³„æ¼çš„æ£€æµ‹å·¥å…·"><a href="#å†…å­˜æ³„æ¼çš„æ£€æµ‹å·¥å…·" class="headerlink" title="å†…å­˜æ³„æ¼çš„æ£€æµ‹å·¥å…·"></a>å†…å­˜æ³„æ¼çš„æ£€æµ‹å·¥å…·</h2><ul>
<li>LeakCanary æ˜¯ Apache å¼€æºçš„ä¸€ä¸ªè‡ªåŠ¨æ£€æµ‹å†…å­˜æ³„æ¼çš„æ¡†æ¶ã€‚å…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒ <a href="https://mp.weixin.qq.com/s/0bO5BZ4CMYJbRuY_xf_osw" target="_blank" rel="noopener">LeakCanaryâ€”â€”å¦‚ä½•æ£€æµ‹ Activity æ˜¯å¦æ³„æ¼</a></li>
<li>ä½¿ç”¨ AS Monitor + MAT è‡ªå·±åˆ†æå†…å­˜æ³„æ¼åŸå› ã€‚è™½ç„¶MATä¸ä¼šå‡†ç¡®å‘Šè¯‰ä½ ä½ çš„ä»£ç å“ªæ³„æ¼äº†ï¼Œä½†æ˜¯å®ƒä¼šç»™ä½ å‘ç°å“ªæ³„éœ²çš„æ•°æ®å’Œçº¿ç´¢ã€‚</li>
<li>AS 3.0 ä¸­æä¾›äº† Profiler å·¥å…·ï¼Œè¿™é‡Œç®€è¿°ä¸€ä¸‹ä½¿ç”¨æµç¨‹ï¼šæ‰‹åŠ¨ç‚¹å‡» GC æŒ‰é’®ï¼ˆå›¾æ ‡æ˜¯ä¸€ä¸ªåƒåœ¾æ¡¶ï¼‰â€”&gt; é€‰æ‹© Dump å†…å­˜ï¼ˆç­‰å¾…20ç§’å·¦å³ï¼‰â€”&gt; ä¸‹æ–¹ä¼šå¼¹å‡ºåˆ†æç»“æœçª—å£â€”&gt;  ä¸‹æ‹‰é€‰æ‹© app heap ï¼Œä¸‹æ‹‰é€‰æ‹© Arrange by packageâ€”&gt;åˆ°åŒ…ä¸‹å¯»æ‰¾è‡ªå·±è®¤ä¸ºå¯èƒ½å‘ç”Ÿå†…å­˜æ³„æ¼çš„ç±»ï¼Œå•å‡»é€‰ä¸­ç±» â€”&gt; å³è¾¹å¼¹å‡º Instance View çª—å£ï¼Œæ˜¾ç¤ºè¯¥ç±»çš„æ‰€æœ‰å®ä¾‹ â€”&gt; é€‰ä¸­æŸä¸€ä¸ªå®ä¾‹ â€“&gt; ä¸‹æ–¹ä¼šå¼¹å‡º Reference çª—å£ï¼ˆæ˜¾ç¤ºè¯¥å®ä¾‹çš„æ‰€æœ‰å¼•ç”¨ï¼‰ï¼Œç„¶ååˆ†æä¸€ä¸‹åˆ°åº•æ˜¯è°å¼ºå¼•ç”¨äº†è¯¥å®ä¾‹ï¼Œå¯¼è‡´å†…å­˜æ— æ³•é‡Šæ”¾ã€‚</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://mp.weixin.qq.com/s/XILFalxJsbGJjx-ZOEDi7g" target="_blank" rel="noopener">Android æ€§èƒ½ä¼˜åŒ– è¯¦è§£å†…å­˜ä¼˜åŒ–çš„æ¥é¾™å»è„‰</a></li>
<li><a href="http://www.cnblogs.com/liushilin/p/5900089.html" target="_blank" rel="noopener">å†…å­˜æ³„æ¼å…¨è§£æï¼Œä»æ­¤æ‹’ç»ANRï¼Œè®©OOMè¿œç¦»ä½ çš„èº«è¾¹ï¼Œè·Ÿå†…å­˜æ³„æ¼say byebye</a></li>
<li><a href="https://goo-yao.github.io/2017/02/11/Android%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/#more" target="_blank" rel="noopener">æ˜ç™½åŸç†ï¼Œè½»æ¾åº”å¯¹Androidå†…å­˜æ³„æ¼</a></li>
</ul>
<p>å¦‚æœæœ¬æ–‡ä¸­æœ‰ä¸æ­£ç¡®çš„ç»“è®ºã€è¯´æ³•ï¼Œè¯·å¤§å®¶æå‡ºå’Œæˆ‘è®¨è®ºï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> åŸç†åˆ†æ </category>
            
            <category> æ€§èƒ½ä¼˜åŒ– </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> æ€§èƒ½ä¼˜åŒ– </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Androidæºç ä¸­çš„ä»£ç†æ¨¡å¼]]></title>
      <url>https://timlin-pro.github.io/blog/2017/08/18/Android%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<h2 id="ä»£ç†æ¨¡å¼çš„å®šä¹‰"><a href="#ä»£ç†æ¨¡å¼çš„å®šä¹‰" class="headerlink" title="ä»£ç†æ¨¡å¼çš„å®šä¹‰"></a>ä»£ç†æ¨¡å¼çš„å®šä¹‰</h2><p>ä»£ç†æ¨¡å¼ä¹Ÿç§°ä¸ºå§”æ‰˜æ¨¡å¼ï¼Œä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚</p>
<h2 id="ä»£ç†æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯"><a href="#ä»£ç†æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä»£ç†æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯"></a>ä»£ç†æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯</h2><p>å½“æ— æ³•æˆ–ä¸æƒ³è®¿é—®æŸä¸ªå¯¹è±¡æˆ–è€…è®¿é—®æŸä¸ªå¯¹è±¡å­˜åœ¨å›°éš¾æ—¶å¯ä»¥<strong>é€šè¿‡ä¸€ä¸ªä»£ç†å¯¹è±¡æ¥é—´æ¥è®¿é—®</strong>ã€‚</p>
<p>ä¸ºäº†ä¿è¯å®¢æˆ·ç«¯ä½¿ç”¨çš„é€æ˜æ€§ï¼Œå§”æ‰˜å¯¹è±¡ä¸ä»£ç†å¯¹è±¡éœ€è¦å®ç°ç›¸åŒçš„æ¥å£ï¼ˆæˆ–ç»§æ‰¿ç›¸åŒçš„æŠ½è±¡ç±»ï¼‰</p>
<a id="more"></a>
<h2 id="ä»£ç†æ¨¡å¼çš„UMLç±»å›¾"><a href="#ä»£ç†æ¨¡å¼çš„UMLç±»å›¾" class="headerlink" title="ä»£ç†æ¨¡å¼çš„UMLç±»å›¾"></a>ä»£ç†æ¨¡å¼çš„UMLç±»å›¾</h2><p><img src="https://user-images.githubusercontent.com/16668676/29449202-6aed8b00-842c-11e7-8e3f-362ead423f2d.png" alt="proxy uml"></p>
<p>è§’è‰²ä»‹ç»ï¼š</p>
<ul>
<li>Subject æŠ½è±¡ä¸»é¢˜ç±»<ul>
<li>ä¸»è¦èŒè´£æ˜¯å£°æ˜çœŸå®ä¸»é¢˜ç±»ä¸ä»£ç†çš„å…±åŒæ¥å£æ–¹æ³•ï¼Œè¯¥ç±»å¯ä»¥æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ¥å£</li>
</ul>
</li>
<li>RealSubject çœŸå®ä¸»é¢˜ç±»<ul>
<li>ä¹Ÿç§°ä¸ºè¢«å§”æ‰˜ç±»æˆ–è¢«ä»£ç†ç†ç±»ï¼Œè¯¥ç±»å®šä¹‰äº†ä»£ç†æ‰€è¡¨ç¤ºçš„çœŸå®å¯¹è±¡ï¼Œç”±å…¶æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•ï¼Œè€Œå®¢æˆ·ç±»åˆ™é€šè¿‡ä»£ç†ç±»é—´æ¥åœ°è°ƒç”¨çœŸå®ä¸»é¢˜ç±»ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚</li>
</ul>
</li>
<li>ProxySubject ä»£ç†ç±»<ul>
<li>ä¹Ÿç§°ä¸ºå§”æ‰˜ç±»ï¼ŒæŒæœ‰ä¸€ä¸ªå¯¹çœŸå®ä¸»é¢˜ç±»çš„å¼•ç”¨ï¼Œåœ¨å…¶å®ç°çš„æ¥å£æ–¹æ³•ä¸­è°ƒç”¨çœŸå®ä¸»é¢˜ç±»ä¸­ç›¸åº”çš„æ¥å£æ–¹æ³•æ‰§è¡Œï¼Œä»¥æ­¤èµ·åˆ°ä»£ç†çš„ä½œç”¨ã€‚</li>
</ul>
</li>
<li>Client ä½¿ç”¨ä»£ç†ç±»çš„ç±»</li>
</ul>
<h2 id="ä»£ç†æ¨¡å¼çš„ç®€å•å®ç°"><a href="#ä»£ç†æ¨¡å¼çš„ç®€å•å®ç°" class="headerlink" title="ä»£ç†æ¨¡å¼çš„ç®€å•å®ç°"></a>ä»£ç†æ¨¡å¼çš„ç®€å•å®ç°</h2><p>ä»£ç†æ¨¡å¼å¤§è‡´å¯åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼Œ<strong>é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†</strong>ã€‚</p>
<p><strong>åŠ¨æ€ä»£ç†</strong>é€šè¿‡åå°„æœºåˆ¶åŠ¨æ€åœ°ç”Ÿæˆä»£ç†è€…çš„å¯¹è±¡ï¼Œcode é˜¶æ®µä¸éœ€è¦çŸ¥é“ä»£ç†è°ï¼Œä»£ç†çš„çœŸæ­£å¯¹è±¡ä¼šåœ¨æ‰§è¡Œé˜¶æ®µç¡®å®šã€‚</p>
<p>Java æä¾›ä¸€ä¸ªä¾¿æ·çš„åŠ¨æ€ä»£ç†æ¥å£ InvocationHandlerï¼Œå®ç°è¯¥æ¥å£éœ€è¦é‡å†™å…¶è°ƒç”¨æ–¹æ³• invokeã€‚</p>
<p>åŠ¨æ€ä»£ç†é€šè¿‡ä¸€ä¸ªä»£ç†ç±»æ¥ä»£ç† N å¤šä¸ªè¢«ä»£ç†ç±»ï¼Œå…¶å®è´¨æ˜¯å¯¹ä»£ç†è€…ä¸è¢«ä»£ç†è€…è¿›è¡Œè§£è€¦ï¼Œä½¿ä¸¤è€…ä¹‹é—´æ²¡æœ‰ç›´æ¥çš„çš„è€¦åˆå…³ç³»ã€‚</p>
<p>ä»£ç†å¯ä»¥çœ‹ä½œæ˜¯ å¯¹è°ƒç”¨ç›®æ ‡çš„ä¸€ä¸ªåŒ…è£…ï¼Œè¿™æ ·æˆ‘ä»¬å¯¹ç›®æ ‡ä»£ç çš„è°ƒç”¨ä¸æ˜¯ç›´æ¥å‘ç”Ÿçš„ï¼Œè€Œæ˜¯ä»£ç†å®Œæˆã€‚ï¼ˆè§‚ç‚¹ï¼šå¤§éƒ¨åˆ†åŠ¨æ€ä»£ç†çš„åœºæ™¯å¯ä»¥çœ‹ä½œæ˜¯ è£…é¥°å™¨æ¨¡å¼çš„åº”ç”¨ã€‚ï¼‰</p>
<h3 id="é™æ€ä»£ç†-vs-åŠ¨æ€ä»£ç†"><a href="#é™æ€ä»£ç†-vs-åŠ¨æ€ä»£ç†" class="headerlink" title="é™æ€ä»£ç† vs åŠ¨æ€ä»£ç†"></a>é™æ€ä»£ç† vs åŠ¨æ€ä»£ç†</h3><p>ç›¸å¯¹è€Œè¨€é™æ€ä»£ç†åˆ™åªèƒ½ä¸ºç»™å®šæ¥å£ä¸‹çš„å®ç°ç±»åšä»£ç†ï¼Œå¦‚æœæ¥å£ä¸åŒé‚£ä¹ˆå°±éœ€è¦é‡æ–°å®šä¹‰ä¸åŒä»£ç†ç±»ï¼Œè¾ƒä¸ºå¤æ‚ã€‚</p>
<ul>
<li>ä½†æ˜¯é™æ€ä»£ç†æ›´ç¬¦åˆé¢å‘å¯¹è±¡çš„åŸåˆ™ã€‚</li>
</ul>
<p>å®é™…å¼€å‘ä¸­å…·ä½“ä½¿ç”¨å“ªç§æ–¹å¼æ¥å®ç°ä»£ç†ï¼Œçœ‹è‡ªå·±çš„åå¥½ã€‚</p>
<h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h3><p>é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†æ˜¯ä» code æ–¹é¢æ¥åŒºåˆ†ä»£ç†æ¨¡å¼çš„ã€‚</p>
<p>ä¹Ÿå¯ä»¥<strong>ä»å…¶ä½¿ç”¨èŒƒå›´æ¥åŒºåˆ†</strong>ä¸åŒç±»å‹çš„ä»£ç†å®ç°ï¼š</p>
<ul>
<li><strong>è¿œç¨‹ä»£ç†</strong>ï¼ˆRemote Proxyï¼‰ä¸ºæŸä¸ªå¯¹è±¡<strong>åœ¨ä¸åŒçš„å†…å­˜åœ°å€ç©ºé—´</strong>æä¾›å±€éƒ¨ä»£ç†ã€‚ä½¿ç³»ç»Ÿå¯ä»¥å°† Server éƒ¨åˆ†çš„å®ç°éšè—ï¼Œä»¥ä¾¿ Client å¯ä»¥ä¸è€ƒè™‘ Server çš„å­˜åœ¨ã€‚</li>
<li><strong>è™šæ‹Ÿä»£ç†</strong>ï¼ˆVirtual Proxyï¼‰ä½¿ç”¨ä¸€ä¸ªä»£ç†å¯¹è±¡<strong>è¡¨ç¤ºä¸€ä¸ªååˆ†è€—èµ„æºçš„å¯¹è±¡å¹¶åœ¨çœŸæ­£éœ€è¦æ—¶æ‰åˆ›å»º</strong>ã€‚</li>
<li><strong>ä¿æŠ¤ä»£ç†</strong>(Protection Proxy)ï¼šä½¿ç”¨ä»£ç†<strong>æ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®</strong>ã€‚è¯¥ç±»å‹çš„ä»£ç†å¸¸è¢«<strong>ç”¨äºåŸå§‹å¯¹è±¡å…·æœ‰ä¸åŒè®¿é—®æƒé™</strong>çš„æƒ…å†µã€‚</li>
<li><strong>æ™ºèƒ½å¼•ç”¨</strong>(Smart Reference)ï¼šåœ¨è®¿é—®åŸå§‹å¯¹è±¡æ—¶æ‰§è¡Œä¸€äº›è‡ªå·±çš„<strong>é™„åŠ æ“ä½œå¹¶å¯¹æŒ‡å‘åŸå§‹å¯¹è±¡çš„å¼•ç”¨è®¡æ•°</strong>ã€‚</li>
</ul>
<p>é™åŠ¨æ€ä»£ç†éƒ½å¯ä»¥åº”ç”¨äºä¸Šè¿° 4 ç§æƒ…å½¢ã€‚</p>
<h2 id="Androidæºç ä¸­çš„ä»£ç†æ¨¡å¼å®ç°"><a href="#Androidæºç ä¸­çš„ä»£ç†æ¨¡å¼å®ç°" class="headerlink" title="Androidæºç ä¸­çš„ä»£ç†æ¨¡å¼å®ç°"></a>Androidæºç ä¸­çš„ä»£ç†æ¨¡å¼å®ç°</h2><p>ä»¥ ActivityManager ä¸ºä¾‹ã€‚</p>
<p><img src="https://user-images.githubusercontent.com/16668676/29449446-6771e5ce-842d-11e7-935f-d1e5685d43af.png" alt="source code proxy"></p>
<ul>
<li>æŠ½è±¡æ¥å£: IActivityManager</li>
<li>ä»£ç†ç±» ActivityManagerProxy</li>
<li>è¢«ä»£ç†ç±»<ul>
<li>ActivityManagerNative(æŠ½è±¡ç±»ï¼Œå¹¶ä¸å¤„ç†å¤ªå¤šçš„é€»è¾‘ï¼Œå¤§éƒ¨åˆ†é€»è¾‘ç”±å…¶å­ç±»â€”â€”ActivityManagerService æ‰¿æ‹…)</li>
<li>ActivityManagerService(çœŸå®éƒ¨åˆ†)</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>ActivityManagerService æ˜¯ç³»ç»Ÿçº§çš„ Service å¹¶ä¸”è¿è¡Œäºç‹¬ç«‹çš„è¿›ç¨‹ç©ºé—´ä¸­ï¼Œå¯ä»¥é€šè¿‡ ServiceManger è·å–åˆ°å®ƒã€‚</li>
<li>ActivityManagerProxy è¿è¡Œäºè‡ªå·±æ‰€å¤„çš„è¿›ç¨‹ç©ºé—´ä¸­ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ ActivityManagerService è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼‰</li>
<li>æ‰€ä»¥æ­¤å¤„æºç æ‰€å®ç°çš„ä»£ç†å®è´¨ä¸º==è¿œç¨‹ä»£ç†==ã€‚</li>
</ul>
<p>ActivityManagerProxy åœ¨å®é™…çš„é€»è¾‘å¤„ç†å¹¶<strong>æ²¡æœ‰è¿‡å¤šåœ°è¢«å¤–éƒ¨ç±»</strong>ä½¿ç”¨ï¼ŒAndroid ä¸­ç®¡ç†ä¸ç»´æŠ¤ Activity ç›¸å…³ä¿¡æ¯çš„ç±»æ˜¯å¦ä¸€ä¸ªå«åš ActivityManager çš„ç±»ã€‚ä¸è¿‡å®è´¨ä¸Š ActivityManager å¤§å¤šæ•°é€»è¾‘è¿˜æ˜¯ç”± ActivityManagerProxy æ‰¿æ‹…ã€‚ï¼ˆæ³¨æ„ï¼šActivityManager å¹¶æ²¡æœ‰å®ç° <strong>I</strong>ActivityManager æ¥å£ï¼Œå®ƒç›´æ¥ç»§æ‰¿è‡ª Objectï¼‰</p>
<p>ä»¥ ActivityManager çš„ getAppTasks() æ–¹æ³•ä¸ºä¾‹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> List&lt;ActivityManager.AppTask&gt; getAppTasks() &#123;</div><div class="line">    ArrayList&lt;AppTask&gt; tasks = <span class="keyword">new</span> ArrayList&lt;AppTask&gt;();</div><div class="line">    List&lt;IAppTask&gt; appTasks;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        appTasks = ActivityManagerNative.getDefault().getAppTasks(mContext.getPackageName());</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> numAppTasks = appTasks.size();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numAppTasks; i++) &#123;</div><div class="line">        tasks.add(<span class="keyword">new</span> AppTask(appTasks.get(i)));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> tasks;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>ActivityManagerNative.getDefault();</code>æ–¹æ³• è¿”å›ä¸€ä¸ª <code>IActivityManager</code> ç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡è°ƒç”¨å…¶ getAppTasks æ–¹æ³•<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> gDefault.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>gDefault åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">        IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);<span class="comment">//è·å– AMS</span></div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">        IActivityManager am = asInterface(b);<span class="comment">//å®Œæˆåˆ›å»ºä¸€ä¸ª AMS çš„å®¢æˆ·ç«¯ç«¯ä»£ç†å¯¹è±¡â€”â€” ActivityManagerProxy</span></div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">        <span class="keyword">return</span> am;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>ä¸Šè¿°ä»£ç ä¸­æ„é€ äº†ä¸€ä¸ª <code>Singleton&lt;IActivityManager&gt;</code> ç±»å‹çš„ gDefault å¯¹è±¡ï¼Œå…¶ä¸­é€šè¿‡ <code>ServiceManager.getService(&quot;activity&quot;);</code> è·å–ä¸€ä¸ªç³»ç»Ÿçº§çš„ Serviceï¼Œè€Œè¯¥ Service å®è´¨ä¸Šå°±æ˜¯ AMSï¼Œæ¥ç€è°ƒç”¨ asInterface æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª ActivityManagerProxy å¯¹è±¡ã€‚</p>
<p>ActivityManagerNative.asInterface æ–¹æ³•çš„å…·ä½“å®ç°<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">static public IActivityManager asInterface(IBinder obj) &#123;</div><div class="line">    if (obj == null) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">    IActivityManager in = (IActivityManager)obj.queryLocalInterface(descriptor);</div><div class="line">    if (in != null) &#123;</div><div class="line">        return in;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return new ActivityManagerProxy(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ActivityManagerProxy çš„ <code>getTasks</code> æ–¹æ³•ï¼Œå°†æ•°æ®æ‰“åŒ…è·¨è¿›ç¨‹ä¼ é€’ç»™ Server ç«¯çš„ AMS å¤„ç†<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> List&lt;ActivityManager.RunningTaskInfo&gt; getTasks(<span class="keyword">int</span> maxNum, <span class="keyword">int</span> flags)</div><div class="line">            <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">        Parcel data = Parcel.obtain();</div><div class="line">        Parcel reply = Parcel.obtain();</div><div class="line">        data.writeInterfaceToken(IActivityManager.descriptor);</div><div class="line">        data.writeInt(maxNum);</div><div class="line">        data.writeInt(flags);</div><div class="line">        mRemote.transact(GET_TASKS_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">        reply.readException();</div><div class="line">        ArrayList&lt;ActivityManager.RunningTaskInfo&gt; list = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> N = reply.readInt();</div><div class="line">        <span class="keyword">if</span> (N &gt;= <span class="number">0</span>) &#123;</div><div class="line">            list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            <span class="keyword">while</span> (N &gt; <span class="number">0</span>) &#123;</div><div class="line">                ActivityManager.RunningTaskInfo info =</div><div class="line">                        ActivityManager.RunningTaskInfo.CREATOR</div><div class="line">                                .createFromParcel(reply);</div><div class="line">                list.add(info);</div><div class="line">                N--;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        data.recycle();</div><div class="line">        reply.recycle();</div><div class="line">        <span class="keyword">return</span> list;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>çœ‹çœ‹ AMS ä¸­çš„ getTasks æ–¹æ³•çš„å…·ä½“å®ç°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;IAppTask&gt; <span class="title">getAppTasks</span><span class="params">(String callingPackage)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> callingUid = Binder.getCallingUid();</div><div class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">        ArrayList&lt;IAppTask&gt; list = <span class="keyword">new</span> ArrayList&lt;IAppTask&gt;();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (DEBUG_ALL) Slog.v(TAG, <span class="string">"getAppTasks"</span>);</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mRecentTasks.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">                TaskRecord tr = mRecentTasks.get(i);</div><div class="line">                <span class="comment">// Skip tasks that do not match the caller.  We don't need to verify</span></div><div class="line">                <span class="comment">// callingPackage, because we are also limiting to callingUid and know</span></div><div class="line">                <span class="comment">// that will limit to the correct security sandbox.</span></div><div class="line">                <span class="keyword">if</span> (tr.effectiveUid != callingUid) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                Intent intent = tr.getBaseIntent();</div><div class="line">                <span class="keyword">if</span> (intent == <span class="keyword">null</span> ||</div><div class="line">                        !callingPackage.equals(intent.getComponent().getPackageName())) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                ActivityManager.RecentTaskInfo taskInfo =</div><div class="line">                        createRecentTaskInfoFromTaskRecord(tr);</div><div class="line">                AppTaskImpl taskImpl = <span class="keyword">new</span> AppTaskImpl(taskInfo.persistentId, callingUid);</div><div class="line">                list.add(taskImpl);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            Binder.restoreCallingIdentity(ident);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> list;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Android-ä¸­çš„-Binder-è·¨è¿›ç¨‹é€šä¿¡æœºåˆ¶ä¸-AIDL"><a href="#Android-ä¸­çš„-Binder-è·¨è¿›ç¨‹é€šä¿¡æœºåˆ¶ä¸-AIDL" class="headerlink" title="Android ä¸­çš„ Binder è·¨è¿›ç¨‹é€šä¿¡æœºåˆ¶ä¸ AIDL"></a>Android ä¸­çš„ Binder è·¨è¿›ç¨‹é€šä¿¡æœºåˆ¶ä¸ AIDL</h2><p>å››ä¸ªé‡è¦ç±»ï¼š</p>
<ul>
<li>Binder Client ç±»æ¯” PCã€ç»ˆç«¯è®¾å¤‡</li>
<li>Binder Server ç±»æ¯” æœåŠ¡å™¨</li>
<li>Binder Driverï¼ˆå®ç°åœ¨å†…æ ¸ä¸­ï¼‰ ç±»æ¯” è·¯ç”±å™¨</li>
<li>Binder Manager ç±»æ¯” DNS æœåŠ¡å™¨</li>
</ul>
<p>å› ä¸ºä¾èµ–äºæŠ½è±¡ï¼ŒåŠ ä¸Šæœ¬åœ°ä»£ç†ç±»çš„å­˜åœ¨ï¼Œæ‰€ä»¥è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ï¼Œè¿˜æ˜¯ä¸è°ƒç”¨æœ¬åœ°çš„æ™®é€šçš„æ–¹æ³•ä¸€æ ·ã€‚ä½†æ˜¯ä»£ç†ç±»å†…éƒ¨éœ€è¦å¯¹å‚æ•°ä»€ä¹ˆçš„è¿›è¡Œæ‰“åŒ…å¤„ç†ï¼Œç„¶åå†é€šè¿‡ Binder æœºåˆ¶ï¼Œè·¨è¿›ç¨‹å°†æ•°æ®ä¼ é€’ç»™è¿œç¨‹æ–¹æ³•ï¼Œè¿œç¨‹æ–¹æ³•æ‰§è¡Œå®Œæ¯•å†è¿”å›æ•°æ®ã€‚</p>
<p><img src="https://user-images.githubusercontent.com/16668676/29453380-021cc0ea-843c-11e7-901d-a7490d12f9ea.jpg" alt="binder é€šä¿¡å¤§è‡´æ¨¡å‹å›¾"></p>
<p>Binder Driver å®ç°åœ¨å†…æ ¸ä¸­ï¼Œä¸»è¦è´Ÿè´£ Binder é€šä¿¡çš„å»ºç«‹ï¼Œä»¥åŠ Binderæ•°æ®åœ¨è¿›ç¨‹é—´çš„ä¼ é€’å’Œ Binder å¼•ç”¨è®¡æ•°ç®¡ç†/æ•°æ®åŒ…çš„ä¼ è¾“ç­‰ã€‚</p>
<p>Binder Client å’Œ Binder Server ä¹‹é—´çš„è·¨è¿›ç¨‹é€šä¿¡ç»Ÿä¸€é€šè¿‡ Binder Driver å¤„ç†è½¬å‘ï¼Œ</p>
<ul>
<li>å¯¹äº Binder Client è€Œè¨€ï¼Œå®ƒåªéœ€è¦çŸ¥é“è‡ªå·±è¦ä½¿ç”¨çš„ Binder çš„åå­—ä»¥åŠè¯¥ <strong>Binder å®ä½“</strong>åœ¨ ServerManager ä¸­çš„ 0 å·å¼•ç”¨å³å¯ã€‚<ul>
<li>è®¿é—®åŸç†ï¼š<ul>
<li>é€šè¿‡ 0 å·å¼•ç”¨å»è®¿é—® ServerManager <strong>è·å–è¯¥ Binder çš„å¼•ç”¨</strong>ï¼Œ</li>
<li>å¾—åˆ°å¼•ç”¨åå°±å¯ä»¥åƒæ™®é€šæ–¹æ³•è°ƒç”¨é‚£æ ·è°ƒç”¨ Binder å®ä½“çš„æ–¹æ³•</li>
</ul>
</li>
</ul>
</li>
<li>ServerManager ç”¨æ¥ç®¡ç† Binder Serverï¼ˆAndroid ä¸­é€šå¸¸æ˜¯ä¸€ä¸ª Serviceï¼‰<ul>
<li>Binder Client é€šè¿‡å®ƒæ¥æŸ¥è¯¢ Binder Server çš„å¼•ç”¨</li>
<li>ServerManager <strong>æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Binder Server</strong>ï¼Œå¹¶ä¸”åœ¨ Android ä¸­çº¦å®šå…¶åœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­çš„å”¯ä¸€æ ‡è¯†ï¼ˆç±»ä¼¼äº IP åœ°å€ï¼‰æ°¸è¿œä¸º 0ã€‚<ul>
<li>åœ¨ IServiceManager æ¥å£ä¸­å®šä¹‰æœ‰å¯¹å¤–å¼€æ”¾çš„æ¥å£æ–¹æ³•ï¼Œä¾›å®¢æˆ·ç«¯è®¿é—®ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>åŒ¿å Binder</strong>ã€‚å¾ˆå¤šæ—¶å€™ Binder Server ä¼šå°†ä¸€ä¸ª Binder å®ä½“å°è£…è¿›æ•°æ®åŒ…ä¼ é€’ç»™ Binder Clientï¼Œè€Œæ­¤æ—¶ Binder Server ä¼šåœ¨è¯¥æ•°æ®åŒ…ä¸­æ ‡æ³¨ Binder å®ä½“çš„ä½ç½®ï¼ŒBinder Driver ä¼šä¸ºè¯¥åŒ¿åçš„ Binder ç”Ÿæˆå®ä½“ç»“ç‚¹å’Œå®ä½“å¼•ç”¨ï¼Œå¹¶å°†è¯¥å¼•ç”¨ä¼ é€’ç»™ Binder Clientã€‚</li>
</ul>
<p>IServiceManager æ¥å£(å£°æ˜ ServerManger å¯¹å¤–æä¾›çš„æ–¹æ³•ã€æ•°æ® )<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IServiceManager</span> <span class="keyword">extends</span> <span class="title">IInterface</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">getService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">checkService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException</span>;</div><div class="line"></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String name, IBinder service, <span class="keyword">boolean</span> allowIsolated)</span></span></div><div class="line">                <span class="keyword">throws</span> RemoteException;</div><div class="line">    <span class="keyword">public</span> String[] listServices() <span class="keyword">throws</span> RemoteException;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPermissionController</span><span class="params">(IPermissionController controller)</span></span></div><div class="line">            <span class="keyword">throws</span> RemoteException;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String descriptor = <span class="string">"android.os.IServiceManager"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> GET_SERVICE_TRANSACTION = IBinder.FIRST_CALL_TRANSACTION;</div><div class="line">    <span class="keyword">int</span> CHECK_SERVICE_TRANSACTION = IBinder.FIRST_CALL_TRANSACTION+<span class="number">1</span>;</div><div class="line">    <span class="keyword">int</span> ADD_SERVICE_TRANSACTION = IBinder.FIRST_CALL_TRANSACTION+<span class="number">2</span>;</div><div class="line">    <span class="keyword">int</span> LIST_SERVICES_TRANSACTION = IBinder.FIRST_CALL_TRANSACTION+<span class="number">3</span>;</div><div class="line">    <span class="keyword">int</span> CHECK_SERVICES_TRANSACTION = IBinder.FIRST_CALL_TRANSACTION+<span class="number">4</span>;</div><div class="line">    <span class="keyword">int</span> SET_PERMISSION_CONTROLLER_TRANSACTION = IBinder.FIRST_CALL_TRANSACTION+<span class="number">5</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>ã€ŠAndorid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹</p>
<p>å¦‚æœæœ¬æ–‡ä¸­æœ‰ä¸æ­£ç¡®çš„ç»“è®ºã€è¯´æ³•ï¼Œè¯·å¤§å®¶æå‡ºå’Œæˆ‘è®¨è®ºï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> åŸç†åˆ†æ </category>
            
            <category> Android è¿›é˜¶ </category>
            
            <category> è®¾è®¡æ¨¡å¼ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> Android è¿›é˜¶ </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[æ·±å…¥ç†è§£ LayoutInflater]]></title>
      <url>https://timlin-pro.github.io/blog/2017/08/17/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20LayoutInflater/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h2><p> <code>View rootView  = LayoutInflater.from(getContext()).inflate(R.layout.bitable_grid_view, this, false);</code></p>
<p>Android å¼€å‘è€…å¯¹ä¸Šé¢è¿™è¡Œä»£ç åº”è¯¥ä¸é™Œç”Ÿï¼Œæˆ‘ä»¬é€šå¸¸ç”¨è¿™ä¸ªæ–¹æ³•æ¥æ¸²æŸ“ä¸€ä¸ªå¸ƒå±€ã€‚å…¶ä¸­çš„åŸç†æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ<br>æœ¬æ–‡ä¸»è¦åˆ†æ LayoutInflater çš„åˆ›å»ºè¿‡ç¨‹ä»¥åŠ inflate æ–¹æ³•çš„åŸç†ã€‚</p>
<a id="more"></a>
<h2 id="äºŒã€LayoutInflater-æ˜¯å¦‚ä½•åˆ›å»ºçš„"><a href="#äºŒã€LayoutInflater-æ˜¯å¦‚ä½•åˆ›å»ºçš„" class="headerlink" title="äºŒã€LayoutInflater æ˜¯å¦‚ä½•åˆ›å»ºçš„"></a>äºŒã€LayoutInflater æ˜¯å¦‚ä½•åˆ›å»ºçš„</h2><p>ä» <code>LayoutInflater#from</code> æ–¹æ³•çœ‹èµ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LayoutInflater <span class="title">from</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    LayoutInflater LayoutInflater =</div><div class="line">            (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">    <span class="keyword">if</span> (LayoutInflater == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"LayoutInflater not found."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> LayoutInflater;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œ<code>LayoutInflater</code> æ˜¯é€šè¿‡ <code>Context#getSystemService</code> çš„æ–¹å¼è·å–çš„ã€‚</p>
<p>Context æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒçš„å…·ä½“å®ç°ç±»ä¸º <code>ContextImpl</code>ã€‚æ‰€ä»¥åº”è¯¥çœ‹ ContextImpl çš„ getSystemService æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p><code>ContextImpl#getSystemService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSystemService</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> SystemServiceRegistry.getSystemService(<span class="keyword">this</span>, name);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ContextImpl#getSystemService</code> æ–¹æ³•åˆå§”æ‰˜äº† SystemServiceRegistryã€‚</p>
<p><code>SystemServiceRegistry</code> ä¸­æœ‰ä¸€ä¸ª <code>HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt;</code> ï¼Œè¯¥ HashMap ä»¥æœåŠ¡åç§°ä¸º keyï¼Œä»¥æœåŠ¡ç›¸å¯¹åº”çš„ ServiceFetcher ä½œä¸º valueã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt; SYSTEM_SERVICE_FETCHERS =</div><div class="line">        <span class="keyword">new</span> HashMap&lt;&gt;();</div></pre></td></tr></table></figure>
<p>å…·ä½“çš„è·å–æ–¹æ³•ä¸º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Gets a system service from a given context.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getSystemService</span><span class="params">(ContextImpl ctx, String name)</span> </span>&#123;</div><div class="line">    ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</div><div class="line">    <span class="keyword">return</span> fetcher != <span class="keyword">null</span> ? fetcher.getService(ctx) : <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ ¹æ®æœåŠ¡åç§°å»è·å–ç›¸åº”çš„ ServiceFetcherï¼Œ</p>
<ul>
<li>å¦‚æœ <code>ServiceFetcher</code> ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>ServiceFetcher.getService</code> æ–¹æ³•è·å–ç›¸åº”æœåŠ¡çš„å¼•ç”¨ã€‚<ul>
<li>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ä¼šå…ˆåˆ›å»ºï¼Œç„¶åç›´æ¥è¿”å›</li>
<li>å¦åˆ™ç›´æ¥è¿”å›ç¼“å­˜çš„å€¼</li>
</ul>
</li>
<li>å¦‚æœ <code>ServiceFetcher</code> ä¸ºç©ºï¼Œåˆ™è¿”å› nullã€‚</li>
</ul>
<h3 id="SYSTEM-SERVICE-FETCHER-æ•°æ®åˆå§‹åŒ–"><a href="#SYSTEM-SERVICE-FETCHER-æ•°æ®åˆå§‹åŒ–" class="headerlink" title="SYSTEM_SERVICE_FETCHER æ•°æ®åˆå§‹åŒ–"></a>SYSTEM_SERVICE_FETCHER æ•°æ®åˆå§‹åŒ–</h3><p><code>SYSTEM_SERVICE_FETCHERS</code> æ˜¯ä¸€ä¸ªé”®ä¸º String, å€¼ä¸º <code>ServiceFetcher&lt;?&gt;</code> çš„é™æ€ HashMap å¸¸é‡ï¼Œå…¶ä¸­çš„æ•°æ®æ˜¯åœ¨é™æ€ä»£ç å—ä¸­æ’å…¥çš„ã€‚</p>
<p>LayoutInflater å¯¹åº”çš„ ServiceFetcher å°±æ˜¯åœ¨è¿™ä¸ªæ—¶å€™å­˜å‚¨è¿›å»çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">    registerService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,</div><div class="line">        <span class="keyword">new</span> CachedServiceFetcher&lt;LayoutInflater&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LayoutInflater <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PhoneLayoutInflater(ctx.getOuterContext());</div><div class="line">    &#125;&#125;);</div><div class="line">    <span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ä¸ºä»€ä¹ˆè¦æ”¾åœ¨-CachedServiceFetcher-ä¸­è€Œä¸æ˜¯ç›´æ¥åˆ›å»ºå‘¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦æ”¾åœ¨-CachedServiceFetcher-ä¸­è€Œä¸æ˜¯ç›´æ¥åˆ›å»ºå‘¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æ”¾åœ¨ CachedServiceFetcher ä¸­è€Œä¸æ˜¯ç›´æ¥åˆ›å»ºå‘¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦æ”¾åœ¨ CachedServiceFetcher ä¸­è€Œä¸æ˜¯ç›´æ¥åˆ›å»ºå‘¢ï¼Ÿ</h3><p>ServiceFetcher æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç³»ç»Ÿä½¿ç”¨çš„ä¸€ä¸ªå…·ä½“å®ç°ç±»ä¸º CachedServiceFetcherã€‚ä»åå­—æ¥çœ‹ï¼Œä¸»è¦æ˜¯ä¸ºäº†å®ç°æ‡’åŠ è½½ï¼Œå½“é¦–æ¬¡éœ€è¦ä½¿ç”¨æ‰è§¦å‘åˆå§‹åŒ–ï¼Œé¿å…æµªè´¹èµ„æºã€‚</p>
<p>CachedServiceFetcher#getService æ–¹æ³•çš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> T <span class="title">getService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Object[] cache = ctx.mServiceCache;</div><div class="line">    <span class="keyword">synchronized</span> (cache) &#123;</div><div class="line">        <span class="comment">// Fetch or create the service.</span></div><div class="line">        Object service = cache[mCacheIndex];<span class="comment">//å…ˆä» ContextImpl çš„ç¼“å­˜åˆ—è¡¨ä¸­è·å–ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜å†è°ƒç”¨ CachedServiceFetcher#createService æ–¹æ³•åˆ›å»º PhoneLayoutInflater</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                service = createService(ctx);<span class="comment">//åˆ›å»ºå¯¹åº”çš„ service</span></div><div class="line">                cache[mCacheIndex] = service;<span class="comment">//å­˜å‚¨åˆ°ç¼“å­˜æ•°ç»„ä¸­</span></div><div class="line">            &#125; <span class="keyword">catch</span> (ServiceNotFoundException e) &#123;</div><div class="line">                onServiceNotFound(e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (T)service;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>é€šè¿‡ from çš„æ–¹å¼è·å– LayoutInflaterï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ SystemServiceRegistry çš„ getService æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šä» ContextImpl ä¸­ç»´æŠ¤çš„ç¼“å­˜æ•°ç»„ä¸­è·å–æœåŠ¡ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ createService æ–¹æ³•åˆ›å»ºä¸€ä¸ª PhoneLayoutInflaterã€‚ï¼ˆæ³¨ï¼šLayoutInflater æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç³»ç»Ÿåˆ›å»ºçš„æ˜¯å®ƒçš„å­ç±»â€”â€” <code>PhoneLayoutInflater</code>ï¼‰</p>
<p>onCreateView æ˜¯ PhoneLayoutInflater ä¸­æœ€é‡è¦çš„æ–¹æ³•ã€‚ä¸ºä»€ä¹ˆè¯´å®ƒé‡è¦ï¼Œåé¢ä¼šæåˆ°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Override onCreateView to instantiate names that correspond to the</span></div><div class="line">    widgets known to the Widget factory. If we don't find a match,</div><div class="line">    call through to our super class.</div><div class="line">*/</div><div class="line"><span class="comment">//ä¸ºç³»ç»Ÿå†…ç½®çš„æ§ä»¶æ·»åŠ å‰ç¼€ã€‚æ¯”å¦‚ä¸º TextView æ·»åŠ å‰ç¼€ï¼Œç»“æœä¸º android.widget.TextView</span></div><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> View <span class="title">onCreateView</span><span class="params">(String name, AttributeSet attrs)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</div><div class="line">    <span class="keyword">for</span> (String prefix : sClassPrefixList) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            View view = createView(name, prefix, attrs);</div><div class="line">            <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> view;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">            <span class="comment">// In this case we want to let the base class take a crack</span></div><div class="line">            <span class="comment">// at it.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onCreateView(name, attrs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ä¸‰ã€å¸ƒå±€åˆ›å»ºè¿‡ç¨‹"><a href="#ä¸‰ã€å¸ƒå±€åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="ä¸‰ã€å¸ƒå±€åˆ›å»ºè¿‡ç¨‹"></a>ä¸‰ã€å¸ƒå±€åˆ›å»ºè¿‡ç¨‹</h2><p>ä¸€èˆ¬æˆ‘ä»¬åœ¨æ¸²æŸ“ ListView æˆ–è€… RecyclerView ä¸­çš„åˆ—è¡¨é¡¹æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ <code>inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot)</code> æ–¹æ³•ï¼ˆæœ‰æ—¶ä¹Ÿä¼šä½¿ç”¨ä¸¤ä¸ªå‚æ•°çš„æ–¹æ³•ï¼‰ã€‚å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ <code>inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot)</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(@LayoutRes <span class="keyword">int</span> resource, @Nullable ViewGroup root)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> inflate(resource, root, root != <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(@LayoutRes <span class="keyword">int</span> resource, @Nullable ViewGroup root, <span class="keyword">boolean</span> attachToRoot)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Resources res = getContext().getResources();</div><div class="line">    <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    <span class="comment">//è·å– xml è§£æå™¨</span></div><div class="line">    <span class="keyword">final</span> XmlResourceParser parser = res.getLayout(resource);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> inflate(parser, root, attachToRoot);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        parser.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(XmlPullParser parser, @Nullable ViewGroup root, <span class="keyword">boolean</span> attachToRoot)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (mConstructorArgs) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Context inflaterContext = mContext;</div><div class="line">        <span class="keyword">final</span> AttributeSet attrs = Xml.asAttributeSet(parser);</div><div class="line">        Context lastContext = (Context) mConstructorArgs[<span class="number">0</span>];</div><div class="line">        mConstructorArgs[<span class="number">0</span>] = inflaterContext;</div><div class="line">        <span class="comment">//å­˜å‚¨ä¼ å…¥çš„çˆ¶è§†å›¾</span></div><div class="line">        View result = root;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">int</span> type;</div><div class="line">            <span class="comment">// å˜é‡æŸ¥æ‰¾æ ¹èŠ‚ç‚¹</span></div><div class="line">            <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp;</div><div class="line">                    type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line">                <span class="comment">// Empty</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> String name = parser.getName();</div><div class="line">            <span class="keyword">if</span> (TAG_MERGE.equals(name)) &#123;</div><div class="line">                <span class="comment">//1. è§£æ merge æ ‡ç­¾</span></div><div class="line">                rInflate(parser, root, inflaterContext, attrs, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 2. ä¸æ˜¯ merge å…ƒç´ å°±ç›´æ¥è§£æå¸ƒå±€ä¸­çš„è§†å›¾</span></div><div class="line"> <span class="comment">// Temp is the root view that was found in the xml</span></div><div class="line">                    <span class="keyword">final</span> View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line"></div><div class="line">                    ViewGroup.LayoutParams params = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (root != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// ç”Ÿæˆå¸ƒå±€å‚æ•°</span></div><div class="line">                        params = root.generateLayoutParams(attrs);</div><div class="line">                        <span class="keyword">if</span> (!attachToRoot) &#123;</div><div class="line">                            <span class="comment">//å¦‚æœ attachToRoot ä¸º falseï¼Œå°±ç»™ temp è®¾ç½®å¸ƒå±€å‚æ•°</span></div><div class="line">                            temp.setLayoutParams(params);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// è§£æ temp è§†å›¾ä¸‹çš„æ‰€æœ‰å­ View</span></div><div class="line">                    rInflateChildren(parser, temp, attrs, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">                    <span class="comment">// å¦‚æœ root ä¸ä¸ºç©ºå¹¶ä¸” attachToRoot ä¸º trueï¼Œé‚£ä¹ˆå°† temp æ·»åŠ åˆ° çˆ¶è§†å›¾ä¸­</span></div><div class="line">                    <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; attachToRoot) &#123;</div><div class="line">                        root.addView(temp, params);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">//å¦‚æœ root ä¸ºç©º æˆ–è€… attachToRoot ä¸º falseï¼Œè¿”å› xml ä¸­çš„ rootï¼Œè€Œä¸æ˜¯çˆ¶è§†å›¾</span></div><div class="line">                    <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">                        result = temp;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»¥ä¸Šçš„ inflate æ–¹æ³•ä¸»è¦æœ‰ä»¥ä¸‹å‡ æ­¥</p>
<ol>
<li>è§£æ xml çš„æ ¹æ ‡ç­¾</li>
<li>å¦‚æœæ ¹æ ‡ç­¾æ˜¯ mergeï¼Œè°ƒç”¨ rInflate è¿›è¡Œè§£æï¼ŒrInflate ä¼šå°† merge æ ‡ç­¾ä¸‹çš„æ‰€æœ‰å­ View <strong>ç›´æ¥æ·»åŠ åˆ°æ ¹æ ‡ç­¾ä¸­</strong></li>
<li>å¦‚æœæ ‡ç­¾æ˜¯æ™®é€šå…ƒç´ ï¼Œè°ƒç”¨ createFromTagï¼Œç”Ÿæˆç›¸åº”çš„ viewã€‚</li>
<li>è°ƒç”¨ rInflate è§£æ temp æ ¹å…ƒç´ ä¸‹çš„æ‰€æœ‰å­ Viewï¼Œå¹¶ä¸”å°†è¿™äº›å­ View éƒ½æ·»åŠ åˆ° temp ä¸‹</li>
<li>è¿”å›è§£æåˆ°çš„æ ¹è§†å›¾ã€‚</li>
</ol>
<p>æˆ‘ä»¬å…ˆä»è§£æå•ä¸ªå…ƒç´ çš„ <code>createViewFromTag</code> æ–¹æ³•çœ‹èµ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function">View <span class="title">createViewFromTag</span><span class="params">(View parent, String name, Context context, AttributeSet attrs,</span></span></div><div class="line">        <span class="keyword">boolean</span> ignoreThemeAttr) &#123;</div><div class="line">    <span class="keyword">if</span> (name.equals(<span class="string">"view"</span>)) &#123;</div><div class="line">        name = attrs.getAttributeValue(<span class="keyword">null</span>, <span class="string">"class"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Apply a theme wrapper, if allowed and one is specified.</span></div><div class="line">    <span class="keyword">if</span> (!ignoreThemeAttr) &#123;</div><div class="line">        <span class="keyword">final</span> TypedArray ta = context.obtainStyledAttributes(attrs, ATTRS_THEME);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> themeResId = ta.getResourceId(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (themeResId != <span class="number">0</span>) &#123;</div><div class="line">            context = <span class="keyword">new</span> ContextThemeWrapper(context, themeResId);</div><div class="line">        &#125;</div><div class="line">        ta.recycle();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        View view;</div><div class="line">        <span class="comment">//ç”¨æˆ·å¯ä»¥é€šè¿‡è®¾ç½® LayoutInlflater çš„ factory æ¥è‡ªè¡Œè§£æ Viewï¼Œé»˜è®¤è¿™äº› Factory éƒ½ä¸ºç©ºï¼Œå¯å¿½ç•¥è¿™æ®µ</span></div><div class="line">        <span class="keyword">if</span> (mFactory2 != <span class="keyword">null</span>) &#123;</div><div class="line">            view = mFactory2.onCreateView(parent, name, context, attrs);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFactory != <span class="keyword">null</span>) &#123;</div><div class="line">            view = mFactory.onCreateView(name, context, attrs);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            view = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (view == <span class="keyword">null</span> &amp;&amp; mPrivateFactory != <span class="keyword">null</span>) &#123;</div><div class="line">            view = mPrivateFactory.onCreateView(parent, name, context, attrs);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> Object lastContext = mConstructorArgs[<span class="number">0</span>];</div><div class="line">            mConstructorArgs[<span class="number">0</span>] = context;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (-<span class="number">1</span> == name.indexOf(<span class="string">'.'</span>)) &#123;</div><div class="line">                    <span class="comment">// è§£æå†…ç½® View æ§ä»¶</span></div><div class="line">                    view = onCreateView(parent, name, attrs);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// è§£æè‡ªå®šä¹‰æ§ä»¶</span></div><div class="line">                    view = createView(name, <span class="keyword">null</span>, attrs);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                mConstructorArgs[<span class="number">0</span>] = lastContext;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//ä»£ç çœç•¥</span></div></pre></td></tr></table></figure>
<p><strong>onCreateView æ–¹æ³•å’Œ createView æ–¹æ³•æœ‰ä½•ä¸åŒ</strong>ï¼Ÿ<br>å‰é¢çš„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬æœ‰æåˆ° LayoutInlflater åˆ›å»ºçš„å®é™…ç±»å‹ä¸º <code>PhoneLayoutInlflater</code> ï¼ŒPhoneLayoutInlflater è¦†å†™äº† onCreateView æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯åœ¨ View çš„æ ‡ç­¾åå‰æ·»åŠ ä¸€ä¸ª <code>&quot;android.widget.&quot; æˆ– &quot;android.webkit.&quot; æˆ– &quot;android.app.&quot;</code>å‰ç¼€ã€‚ç„¶åå†ä¼ é€’ç»™ createView è§£æã€‚</p>
<ul>
<li>ä¹Ÿå°±æ˜¯è¯´<strong>å†…ç½® View å’Œè‡ªå®šä¹‰ View æœ€ç»ˆéƒ½è°ƒç”¨äº† createView è¿›è¡Œè§£æ</strong>ã€‚</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡å‘¢</strong>ï¼Ÿ<br>è¿™æ˜¯ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…åœ¨ xml æ–‡ä»¶ä¸­æ›´æ–¹ä¾¿ä½¿ç”¨ç³»ç»Ÿå†…ç½®çš„ Viewï¼ˆåªéœ€è¦å†™ View åç§°è€Œä¸éœ€è¦å†™å®Œæ•´çš„è·¯å¾„ï¼‰ï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰æ§ä»¶æˆ–è€…ç¬¬ä¸‰æ–¹åº“ï¼Œå†™å®Œæ•´è·¯å¾„ã€‚</p>
<p>createView çš„å…·ä½“å®ç°å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ ¹æ®å®Œæ•´è·¯å¾„çš„ç±»åé€šè¿‡åå°„æœºåˆ¶æ„é€  View å¯¹è±¡</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> View <span class="title">createView</span><span class="params">(String name, String prefix, AttributeSet attrs)</span></span></div><div class="line">        <span class="keyword">throws</span> ClassNotFoundException, InflateException &#123;</div><div class="line">    <span class="comment">//ä»ç¼“å­˜ä¸­è·å–æ„é€ å‡½æ•°</span></div><div class="line">    Constructor&lt;? extends View&gt; constructor = sConstructorMap.get(name);</div><div class="line">    <span class="keyword">if</span> (constructor != <span class="keyword">null</span> &amp;&amp; !verifyClassLoader(constructor)) &#123;</div><div class="line">        constructor = <span class="keyword">null</span>;</div><div class="line">        sConstructorMap.remove(name);</div><div class="line">    &#125;</div><div class="line">    Class&lt;? extends View&gt; clazz = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, name);</div><div class="line"></div><div class="line">        <span class="comment">// ç¼“å­˜ä¸­æ‰¾ä¸åˆ°æ„é€ å‡½æ•°</span></div><div class="line">        <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//å¦‚æœå‰ç¼€ï¼ˆprefixï¼‰ä¸ä¸ºç©ºï¼Œæ„é€ å®Œæ•´è·¯å¾„ï¼Œå¹¶ä¸”åŠ è½½è¯¥ç±»</span></div><div class="line">            clazz = mContext.getClassLoader().loadClass(</div><div class="line">                    prefix != <span class="keyword">null</span> ? (prefix + name) : name).asSubclass(View.class);</div><div class="line">            <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">            <span class="comment">//ä» class å¯¹è±¡ä¸­è·å–æ„é€ å‡½æ•°</span></div><div class="line">            constructor = clazz.getConstructor(mConstructorSignature);</div><div class="line">            constructor.setAccessible(<span class="keyword">true</span>);</div><div class="line">            sConstructorMap.put(name, constructor);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Object[] args = mConstructorArgs;</div><div class="line">        args[<span class="number">1</span>] = attrs;</div><div class="line">        <span class="comment">//é€šè¿‡åå°„æ„é€  View</span></div><div class="line">        <span class="keyword">final</span> View view = constructor.newInstance(args);</div><div class="line">        <span class="keyword">if</span> (view <span class="keyword">instanceof</span> ViewStub) &#123;</div><div class="line">            <span class="comment">// Use the same context when inflating ViewStub later.</span></div><div class="line">            <span class="keyword">final</span> ViewStub viewStub = (ViewStub) view;</div><div class="line">            viewStub.setLayoutInflater(cloneInContext((Context) args[<span class="number">0</span>]));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line"></div><div class="line">    &#125; </div><div class="line">    <span class="comment">//çœç•¥å„ç§ catchã€finally ä»£ç </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>createView æ–¹æ³•ä¸­ï¼Œå¦‚æœæ§ä»¶åæœ‰å‰ç¼€å°±å…ˆæ„é€  View çš„å®Œæ•´è·¯å¾„ï¼Œå¹¶ä¸”å°†è¯¥ç±»åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­</p>
<ul>
<li>ç„¶åè·å–è¯¥ç±»çš„æ„é€ å‡½æ•°å¹¶ç¼“å­˜èµ·æ¥ï¼Œå†é€šè¿‡æ„é€ å‡½æ•°æ¥åˆ›å»ºè¯¥ View çš„å¯¹è±¡ï¼Œ</li>
<li>æœ€åå°† View å¯¹è±¡è¿”å›ï¼Œè¿™å°±æ˜¯è§£æå•ä¸ª View çš„è¿‡ç¨‹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">rInflate</span><span class="params">(XmlPullParser parser, View parent, Context context,</span></span></div><div class="line">        AttributeSet attrs, <span class="keyword">boolean</span> finishInflate) <span class="keyword">throws</span> XmlPullParserException, IOException &#123;</div><div class="line">    <span class="comment">//è·å–æ ‘çš„æ·±åº¦</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> depth = parser.getDepth();</div><div class="line">    <span class="keyword">int</span> type;</div><div class="line">    <span class="comment">//é€ä¸ªå…ƒç´ è§£æ</span></div><div class="line">    <span class="keyword">while</span> (((type = parser.next()) != XmlPullParser.END_TAG ||</div><div class="line">            parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> String name = parser.getName();</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (TAG_REQUEST_FOCUS.equals(name)) &#123;</div><div class="line">            parseRequestFocus(parser, parent);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_TAG.equals(name)) &#123;</div><div class="line">            parseViewTag(parser, parent, attrs);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_INCLUDE.equals(name)) &#123;<span class="comment">//è§£æ include æ ‡ç­¾</span></div><div class="line">            <span class="keyword">if</span> (parser.getDepth() == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;include /&gt; cannot be the root element"</span>);</div><div class="line">            &#125;</div><div class="line">            parseInclude(parser, context, parent, attrs);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_MERGE.equals(name)) &#123;è§£æ merge æ ‡ç­¾</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;merge /&gt; must be the root element"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//æ ¹æ®å…ƒç´ åè¿›è¡Œè§£æ</span></div><div class="line">            <span class="keyword">final</span> View view = createViewFromTag(parent, name, context, attrs);</div><div class="line">            <span class="keyword">final</span> ViewGroup viewGroup = (ViewGroup) parent;</div><div class="line">            <span class="keyword">final</span> ViewGroup.LayoutParams params = viewGroup.generateLayoutParams(attrs);</div><div class="line">            <span class="comment">//é€’å½’è°ƒç”¨è¿›è¡Œè§£æï¼Œå³æ·±åº¦ä¼˜å…ˆéå†</span></div><div class="line">            rInflateChildren(parser, view, attrs, <span class="keyword">true</span>);</div><div class="line">            <span class="comment">//å°†è§£æåˆ°çš„ View æ·»åŠ åˆ°å®ƒçš„çˆ¶è§†å›¾ä¸­</span></div><div class="line">            viewGroup.addView(view, params);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (finishInflate) &#123;</div><div class="line">        parent.onFinishInflate();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>rInflate() é€šè¿‡æ·±åº¦ä¼˜å…ˆéå†æ¥æ„é€ è§†å›¾æ ‘ã€‚æ¯è§£æåˆ°ä¸€ä¸ª View å…ƒç´ å°±ä¼šé€’å½’è°ƒç”¨ rInflateï¼Œç›´åˆ°è¿™æ¡è·¯å¾„ä¸‹çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œ<br>ç„¶ååœ¨å›æº¯è¿‡æ¥å°†æ¯ä¸ª View å…ƒç´ æ·»åŠ åˆ°å®ƒä»¬çš„ parent ä¸­ã€‚</p>
<ul>
<li>é€šè¿‡ rInflate çš„è§£æä¹‹åï¼Œæ•´æ£µè§†å›¾æ ‘å°±æ„å»ºå®Œæ¯•ã€‚å½“è°ƒç”¨äº† Activity çš„ onResume ä¹‹åï¼Œä¹‹å‰é€šè¿‡ setContentView è®¾ç½®çš„å†…å®¹å°±ä¼šå‡ºç°åœ¨æˆ‘ä»¬çš„è§†é‡ä¸­ã€‚</li>
</ul>
<h2 id="å››ã€å¸¸è§é—®é¢˜"><a href="#å››ã€å¸¸è§é—®é¢˜" class="headerlink" title="å››ã€å¸¸è§é—®é¢˜"></a>å››ã€å¸¸è§é—®é¢˜</h2><h3 id="inflate-æ–¹æ³•æœ‰å¤šç§é‡è½½ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ"><a href="#inflate-æ–¹æ³•æœ‰å¤šç§é‡è½½ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="inflate æ–¹æ³•æœ‰å¤šç§é‡è½½ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ"></a>inflate æ–¹æ³•æœ‰å¤šç§é‡è½½ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ</h3><p>ä¸‰ä¸ªå‚æ•°çš„ infalte æ–¹æ³•çš„å„ä¸ªå‚æ•°çš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p><code>LayoutInflater#inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot)</code></p>
<p>resource å‚æ•°ä¸ºå¸ƒå±€èµ„æºã€‚æ˜¯ä¸€ä¸ª xml æ–‡ä»¶ã€‚</p>
<p>è‹¥ root ä¸ä¸ºç©ºæ—¶</p>
<ul>
<li>å¦‚æœ attachToRoot ä¸º trueï¼Œåˆ™å®ƒæ˜¯ xml æ–‡ä»¶çš„æ ¹å¸ƒå±€çš„çˆ¶å¸ƒå±€ã€‚ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œæ¸²æŸ“å‡ºæ¥çš„å¸ƒå±€è¢« add root ä¸­ã€‚åŒæ—¶ï¼Œinflate æ–¹æ³•çš„è¿”å›å€¼ä¸º rootï¼‰</li>
<li>å¦‚æœ attachToRoot ä¸º falseï¼Œå®ƒåªæ˜¯ä¸º xml æ–‡ä»¶çš„æ ¹å¸ƒå±€ æä¾›ä¸€ç»„ LayoutParams å€¼ã€‚åŒæ—¶ inflate æ–¹æ³•è¿”å›çš„ xml æ–‡ä»¶çš„æ ¹å¸ƒå±€ã€‚</li>
</ul>
<p>ä¸¤ä¸ªå‚æ•°çš„ inflate æ–¹æ³•ï¼Œå†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨ä¸‰ä¸ªå‚æ•°çš„ infalte æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">inflate</span><span class="params">(@LayoutRes <span class="keyword">int</span> resource, @Nullable ViewGroup root)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> inflate(resource, root, root != <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“ root ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œinflate(@LayoutRes int resource, @Nullable ViewGroup root) æ–¹æ³•é»˜è®¤å°†æ¸²æŸ“åçš„å¸ƒå±€ add åˆ° root ä¸­ã€‚</p>
<p>è¿˜æœ‰å¦å¤–ä¸¤ç§é‡è½½ï¼ŒåŒºåˆ«ä»…åœ¨äºå®ƒä»¬çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯ XmlPullParserï¼Œroot å’Œ attachToRoot å‚æ•°è¡¨ç°ä¸ä¸Šè¿°ä¸€è‡´ã€‚</p>
<h3 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>åˆ›å»ºæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p>é¦–å…ˆæŸ¥æ‰¾æ ¹æ ‡ç­¾</p>
<ul>
<li>å¦‚æœæ˜¯ mergeï¼Œè°ƒç”¨ rInflate</li>
<li>å¦åˆ™ï¼Œè°ƒç”¨ <code>createViewFromTag</code><ul>
<li>å¦‚æœæ˜¯ç³»ç»Ÿå†…ç½®æ§ä»¶ï¼ˆé€šè¿‡åç§°ä¸­æ˜¯å¦å«æœ‰ã€Œ.ã€æ¥åˆ¤æ–­ï¼‰ï¼Œè°ƒç”¨ <code>PhoneLayoutInflater.onCreateView()</code> æ–¹æ³•æ·»åŠ å‰ç¼€ï¼Œ<ul>
<li>å¤„ç†åå°†å®Œæ•´è·¯å¾„ä¼ ç»™ <code>LayoutInflater.createView()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šé€šè¿‡åå°„çš„æ–¹å¼åˆ›å»ºå‡ºå¯¹åº”çš„ view å®ä¾‹ã€‚</li>
</ul>
</li>
<li>å¦åˆ™ï¼Œç›´æ¥è°ƒç”¨ <code>LayoutInflater.createView()</code> è¿›è¡Œè§£æã€‚è¯¥æ–¹æ³•å†…éƒ¨ä¼šé€šè¿‡åå°„çš„æ–¹å¼åˆ›å»ºå‡ºå¯¹åº”çš„ view å®ä¾‹ã€‚</li>
</ul>
</li>
</ul>
<h2 id="äº”ã€æ‹“å±•ç”¨æ³•"><a href="#äº”ã€æ‹“å±•ç”¨æ³•" class="headerlink" title="äº”ã€æ‹“å±•ç”¨æ³•"></a>äº”ã€æ‹“å±•ç”¨æ³•</h2><p>å‰é¢æåˆ°åœ¨å¸ƒå±€åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ createViewFromTag æ–¹æ³•ã€‚</p>
<p>createViewFromTag æ–¹æ³•ä¸­ï¼Œæœ‰ä¸‹ä¸€æ®µä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">View view;</div><div class="line"><span class="comment">//ç”¨æˆ·å¯ä»¥é€šè¿‡è®¾ç½® LayoutInlflater çš„ factory æ¥è‡ªè¡Œè§£æ Viewï¼Œé»˜è®¤è¿™äº› Factory éƒ½ä¸ºç©ºï¼Œå¯å¿½ç•¥è¿™æ®µ</span></div><div class="line"><span class="keyword">if</span> (mFactory2 != <span class="keyword">null</span>) &#123;</div><div class="line">    view = mFactory2.onCreateView(parent, name, context, attrs);<span class="comment">//å¦‚æœFactory2ä¸ä¸ºç©ºï¼Œè°ƒç”¨ mFactory2 åˆ›å»º view</span></div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFactory != <span class="keyword">null</span>) &#123;</div><div class="line">    view = mFactory.onCreateView(name, context, attrs);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    view = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Factory2</span> <span class="keyword">extends</span> <span class="title">Factory</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Version of &#123;<span class="doctag">@link</span> #onCreateView(String, Context, AttributeSet)&#125;</div><div class="line">     * that also supplies the parent that the view created view will be</div><div class="line">     * placed in.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> parent The parent that the created view will be placed</div><div class="line">     * in; &lt;em&gt;note that this may be null&lt;/em&gt;.</div><div class="line">     * <span class="doctag">@param</span> name Tag name to be inflated.</div><div class="line">     * <span class="doctag">@param</span> context The context the view is being created in.</div><div class="line">     * <span class="doctag">@param</span> attrs Inflation attributes as specified in XML file.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> View Newly created view. Return null for the default</div><div class="line">     *         behavior.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(View parent, String name, Context context, AttributeSet attrs)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç° Factory ä¸­çš„  onCreateView æ–¹æ³•ã€‚ç³»ç»Ÿåœ¨å¡«å…… view å‰ä¼šå›è°ƒè¯¥æ–¹æ³•ï¼Œå¯ä»¥è¿”å›ä»€ä¹ˆæ ·çš„ view å·²ç»å…¶ä¸­çš„å±æ€§ã€‚</p>
<h3 id="1-å…¨å±€æ›¿æ¢å­—ä½“å±æ€§"><a href="#1-å…¨å±€æ›¿æ¢å­—ä½“å±æ€§" class="headerlink" title="1.å…¨å±€æ›¿æ¢å­—ä½“å±æ€§"></a>1.å…¨å±€æ›¿æ¢å­—ä½“å±æ€§</h3><p>å› ä¸ºå­—ä½“æ˜¯ TextView çš„ä¸€ä¸ªå±æ€§ï¼Œä¸ºäº†åŠ ä¸€ä¸ªå±æ€§ï¼Œæˆ‘ä»¬å°±æ²¡å¿…è¦å»å…¨éƒ¨çš„å¸ƒå±€ä¸­è¿›è¡Œæ›´æ”¹ï¼Œåªéœ€è¦ä¸Šæˆ‘ä»¬çš„ onCreateView ä¸­ï¼Œå‘ç°æ˜¯ TextViewï¼Œå°±å»è®¾ç½®æˆ‘ä»¬å¯¹åº”çš„å­—ä½“ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> Typeface typeface;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (typeface == <span class="keyword">null</span>)&#123;</div><div class="line">        typeface = Typeface.createFromAsset(getAssets(), <span class="string">"xxxx.ttf"</span>);</div><div class="line">    &#125;</div><div class="line">    LayoutInflaterCompat.setFactory2(LayoutInflater.from(<span class="keyword">this</span>), <span class="keyword">new</span> LayoutInflater.Factory2() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(String name, Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(View parent, String name, Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">            AppCompatDelegate delegate = getDelegate();</div><div class="line">            View view = delegate.createView(parent, name, context, attrs);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ( view!= <span class="keyword">null</span> &amp;&amp; (view <span class="keyword">instanceof</span> TextView))&#123;</div><div class="line">                ((TextView) view).setTypeface(typeface);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> view;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    setContentView(R.layout.activity_main);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-åŠ¨æ€æ¢è‚¤åŠŸèƒ½"><a href="#2-åŠ¨æ€æ¢è‚¤åŠŸèƒ½" class="headerlink" title="2.åŠ¨æ€æ¢è‚¤åŠŸèƒ½"></a>2.åŠ¨æ€æ¢è‚¤åŠŸèƒ½</h3><p>åŸºæœ¬åŸç†å’Œä¸Šé¢çš„æ›´æ¢å­—ä½“ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹åšäº†æ ‡è®°çš„ View è¿›è¡Œè¯†åˆ«ï¼Œç„¶ååœ¨ onCreateView éå†åˆ°å®ƒçš„æ—¶å€™ï¼Œæ›´æ”¹å®ƒçš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚èƒŒæ™¯è‰²ç­‰ï¼Œç„¶åå†äº¤ç»™ç³»ç»Ÿå»ç”Ÿæˆ Viewã€‚</p>
<h3 id="3-æ— éœ€ç¼–å†™-shapeã€selectorï¼Œç›´æ¥åœ¨-xml-è®¾ç½®å€¼"><a href="#3-æ— éœ€ç¼–å†™-shapeã€selectorï¼Œç›´æ¥åœ¨-xml-è®¾ç½®å€¼" class="headerlink" title="3.æ— éœ€ç¼–å†™ shapeã€selectorï¼Œç›´æ¥åœ¨ xml è®¾ç½®å€¼"></a>3.æ— éœ€ç¼–å†™ shapeã€selectorï¼Œç›´æ¥åœ¨ xml è®¾ç½®å€¼</h3><p><a href="https://juejin.im/post/5b9682ebe51d450e543e3495" target="_blank" rel="noopener">æ— éœ€è‡ªå®šä¹‰ Viewï¼Œå½»åº•è§£æ”¾ shapeï¼Œselector å§</a></p>
<p>æ–‡ç« ä¸­è®²åˆ°æˆ‘ä»¬å¦‚æœè¦è®¾ç½®æ§ä»¶çš„è§’åº¦ç­‰å±æ€§å€¼ï¼Œä¸éœ€è¦å†å»å†™ç‰¹å®šçš„ shape æˆ–è€… selector æ–‡ä»¶ï¼Œç›´æ¥åœ¨ xml ä¸­å†™å…¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;Button</div><div class="line">      android:id=&quot;@+id/btn&quot;</div><div class="line">      android:layout_width=&quot;130dp&quot;</div><div class="line">      android:layout_height=&quot;36dp&quot;</div><div class="line">      android:layout_marginTop=&quot;5dp&quot;</div><div class="line">      android:gravity=&quot;center&quot;</div><div class="line">      android:padding=&quot;0dp&quot;</div><div class="line">      android:text=&quot;è·³è½¬åˆ°åˆ—è¡¨&quot;</div><div class="line">      android:textColor=&quot;#4F94CD&quot;</div><div class="line">      android:textSize=&quot;20sp&quot;</div><div class="line">      app:bl_corners_radius=&quot;20dp</div><div class="line">      app:bl_gradient_angle=&quot;0&quot;</div><div class="line">      app:bl_gradient_endColor=&quot;#4F94CD&quot;</div><div class="line">      app:bl_gradient_startColor=&quot;#63B8FF&quot;</div><div class="line">      app:bl_shape=&quot;rectangle&quot; /&gt;</div></pre></td></tr></table></figure>
<p>å…¶åŸç†ä¹Ÿæ˜¯é€šè¿‡è‡ªå®šä¹‰ Factoryï¼Œåœ¨<code>Factory2#onCreateView</code>æ–¹æ³•é‡Œé¢ï¼Œåˆ¤æ–­ attrs çš„å‚æ•°åå­—ï¼Œæ¯”å¦‚å‘ç°åå­—æ˜¯æˆ‘ä»¬åˆ¶å®šçš„ stroke_color å±æ€§ï¼Œå°±å»é€šè¿‡ä»£ç æ‰‹åŠ¨å¸®ä»–å»è®¾ç½®è¿™ä¸ªå€¼,æˆ‘ä»¬æ¥æŸ¥çœ‹ä¸‹å®ƒçš„ onCreateView æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(String name, Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">	<span class="comment">//çœç•¥ä¸€äº›ä»£ç </span></div><div class="line">    <span class="keyword">if</span> (typedArray.getBoolean(R.styleable.background_ripple_enable, <span class="keyword">false</span>) &amp;&amp;</div><div class="line">        typedArray.hasValue(R.styleable.background_ripple_color)) &#123;</div><div class="line">        <span class="keyword">int</span> color = typedArray.getColor(R.styleable.background_ripple_color, <span class="number">0</span>);</div><div class="line">            <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</div><div class="line">                Drawable contentDrawable = (stateListDrawable == <span class="keyword">null</span> ? drawable : stateListDrawable);</div><div class="line">                RippleDrawable rippleDrawable = <span class="keyword">new</span> RippleDrawable(ColorStateList.valueOf(color), contentDrawable, contentDrawable);</div><div class="line">                view.setClickable(<span class="keyword">true</span>);</div><div class="line">                view.setBackground(rippleDrawable);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                StateListDrawable tmpDrawable = <span class="keyword">new</span> StateListDrawable();</div><div class="line">                GradientDrawable unPressDrawable = DrawableFactory.getDrawable(typedArray);</div><div class="line">                unPressDrawable.setColor(color);</div><div class="line">                tmpDrawable.addState(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;-android.R.attr.state_pressed&#125;, drawable);</div><div class="line">                tmpDrawable.addState(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;android.R.attr.state_pressed&#125;, unPressDrawable);</div><div class="line">                view.setClickable(<span class="keyword">true</span>);</div><div class="line">                view.setBackground(tmpDrawable);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å…­ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å…­ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å…­ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å…­ã€å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li>ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹</li>
<li><a href="https://www.jianshu.com/p/8d8ada21ab82" target="_blank" rel="noopener">Android æŠ€èƒ½æ ‘ â€” LayoutInflater Factory å°ç»“</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> åŸç†åˆ†æ </category>
            
            <category> Android è¿›é˜¶ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> Android è¿›é˜¶ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Androidæºç ä¸­çš„è§‚å¯Ÿè€…æ¨¡å¼]]></title>
      <url>https://timlin-pro.github.io/blog/2017/08/09/Android%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<h1 id="è§£å†³ã€è§£è€¦çš„é’¥åŒ™â€”â€”è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§£å†³ã€è§£è€¦çš„é’¥åŒ™â€”â€”è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§£å†³ã€è§£è€¦çš„é’¥åŒ™â€”â€”è§‚å¯Ÿè€…æ¨¡å¼"></a>è§£å†³ã€è§£è€¦çš„é’¥åŒ™â€”â€”è§‚å¯Ÿè€…æ¨¡å¼</h1><h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><p>è§‚å¯Ÿè€…æ¨¡å¼å®šä¹‰äº†å¯¹è±¡é—´ä¸€ç§<strong>ä¸€å¯¹å¤š</strong>çš„ä¾èµ–å…³ç³»ï¼Œä½¿å¾—æ¯å½“ä¸€ä¸ªå¯¹è±¡æ”¹å˜çŠ¶æ€ï¼Œåˆ™æ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½ä¼šå¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚</p>
<h2 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><ul>
<li>å…³è”è¡Œä¸ºåœºæ™¯<ul>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå…³è”è¡Œä¸ºæ˜¯å¯æ‹†åˆ†çš„ï¼Œè€Œä¸æ˜¯â€œç»„åˆâ€å…³ç³»</li>
</ul>
</li>
<li>äº‹ä»¶å¤šçº§è§¦å‘åœºæ™¯</li>
<li>è·¨ç³»ç»Ÿçš„æ¶ˆæ¯äº¤æ¢åœºæ™¯ï¼Œå¦‚æ¶ˆæ¯é˜Ÿåˆ—ã€äº‹ä»¶æ€»çº¿çš„å¤„ç†æœºåˆ¶ã€‚</li>
</ul>
<a id="more"></a>
<h2 id="UML-ç±»å›¾"><a href="#UML-ç±»å›¾" class="headerlink" title="UML ç±»å›¾"></a>UML ç±»å›¾</h2><p>UML ç±»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src="https://user-images.githubusercontent.com/16668676/29015194-a1c0db10-7b7f-11e7-99a0-437680f88188.png" alt="uml"></p>
<p>å››ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>Subject æŠ½è±¡ä¸»é¢˜ï¼ˆæŠ½è±¡çš„è¢«è§‚å¯Ÿè€…ï¼‰ã€‚æŠŠæ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åœ¨ä¸€ä¸ªé›†åˆé‡Œï¼Œæ¯ä¸ªä¸»é¢˜å¯ä»¥æœ‰ä»»æ„æ•°é‡çš„è§‚å¯Ÿè€…ï¼Œæä¾›æ¥å£ä¾›æ·»åŠ å’Œåˆ é™¤è§‚å¯Ÿè€…å¯¹è±¡ã€‚</li>
<li>ConcreteSubject å…·ä½“ä¸»é¢˜ï¼ˆå…·ä½“çš„è¢«è§‚å¯Ÿè€…ï¼‰ã€‚å°†æœ‰å…³çŠ¶æ€å­˜å…¥å…·ä½“è§‚å¯Ÿè€…å¯¹è±¡ï¼Œåœ¨å…·ä½“ä¸»é¢˜çš„å†…éƒ¨å®ç°å‘ç”Ÿæ”¹å˜æ—¶ï¼Œç»™æ‰€æœ‰æ³¨å†Œè¿‡çš„è§‚å¯Ÿè€…å‘å‡ºé€šçŸ¥</li>
<li>Observer æŠ½è±¡è§‚å¯Ÿè€…ã€‚å®šä¹‰ä¸€ä¸ªæ›´æ–°æ¥å£ï¼Œç”¨æ¥æ¥æ”¶ä¸»é¢˜æ›´æ”¹æ—¶åšå‡ºç›¸åº”çš„æ“ä½œï¼ˆæ¯”å¦‚æ›´æ–°è‡ªèº«çš„çŠ¶æ€ï¼‰</li>
<li>ConcreteObserver å…·ä½“è§‚å¯Ÿè€…ï¼ˆå®ç°æŠ½è±¡è§‚å¯Ÿè€…æ‰€å®šä¹‰çš„æ›´æ–°æ¥å£ï¼Œä»¥ä¾¿åœ¨ä¸»é¢˜çŠ¶æ€æ›´æ”¹æ—¶æ›´æ–°è‡ªèº«çš„çŠ¶æ€ï¼‰</li>
</ul>
<h2 id="Android-ListView-çš„è§‚å¯Ÿè€…æ¨¡å¼"><a href="#Android-ListView-çš„è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="Android ListView çš„è§‚å¯Ÿè€…æ¨¡å¼"></a>Android ListView çš„è§‚å¯Ÿè€…æ¨¡å¼</h2><p>ListView å’Œ RecyclerView åœ¨ Android ä¸­éƒ½å æ®ç€å¾ˆé‡è¦çš„åœ°ä½ã€‚</p>
<p>ä½¿ç”¨è¿™ä¸¤ä¸ªç»„ä»¶æ—¶ï¼Œæ€»å…ä¸äº†æ•°æ®æ›´æ–°çš„æƒ…å†µï¼šå½“è¦æ›´æ–°æ•°æ®æ—¶æˆ‘ä»¬é€šå¸¸éƒ½ä¼šè°ƒç”¨ <code>Adapter.notifyDataSetChanged()</code>ï¼Œè¿™å…¶ä¸­çš„åŸç†åˆæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p>
<p>ä¸‹é¢ä»¥ ListView ä½œä¸ºä¸€ä¸ªæ —å­ï¼Œçœ‹çœ‹å…¶ä¸­çš„å…·ä½“å®ç°æ˜¯æ€ä¹ˆæ ·çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void notifyDataSetChanged() &#123;</div><div class="line">    mDataSetObservable.notifyChanged();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public void notifyChanged() &#123;</div><div class="line">    synchronized(mObservers) &#123;</div><div class="line">        // since onChanged() is implemented by the app, it could do anything, including</div><div class="line">        // removing itself from &#123;@link mObservers&#125; - and that could cause problems if</div><div class="line">        // an iterator is used on the ArrayList &#123;@link mObservers&#125;.</div><div class="line">        // to avoid such problems, just march thru the list in the reverse order.</div><div class="line">        for (int i = mObservers.size() - 1; i &gt;= 0; i--) &#123;</div><div class="line">            mObservers.get(i).onChanged();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>notifyDataSetChanged æ–¹æ³•ä¼šè°ƒç”¨  <code>DataSetObservable.notifyChanged()</code> æ–¹æ³•,notifyChanged() å†…éƒ¨ä¼šéå†è°ƒç”¨è§‚å¯Ÿè€…çš„ onChanged() æ–¹æ³•ã€‚é€šçŸ¥æ•°æ®æ›´æ–°ã€‚</li>
<li>ä½†æ˜¯è§‚å¯Ÿè€…åˆæ˜¯ä»€ä¹ˆæ—¶å€™æ³¨å†Œçš„å‘¢ï¼Ÿ</li>
</ul>
<p>ä»¥ä¸‹ä¸º setAdapter çš„æ–¹æ³•çš„å…·ä½“å®ç°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void setAdapter(ListAdapter adapter) &#123;</div><div class="line">    //å¦‚æœ å·²ç»æœ‰ Adapter å­˜åœ¨ï¼Œå…ˆè§£é™¤æ³¨å†Œ</div><div class="line">    if (mAdapter != null &amp;&amp; mDataSetObserver != null) &#123;</div><div class="line">        mAdapter.unregisterDataSetObserver(mDataSetObserver);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    resetList();</div><div class="line">    mRecycler.clear();</div><div class="line"></div><div class="line">    if (mHeaderViewInfos.size() &gt; 0|| mFooterViewInfos.size() &gt; 0) &#123;</div><div class="line">        mAdapter = wrapHeaderListAdapterInternal(mHeaderViewInfos, mFooterViewInfos, adapter);</div><div class="line">    &#125; else &#123;</div><div class="line">        mAdapter = adapter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mOldSelectedPosition = INVALID_POSITION;</div><div class="line">    mOldSelectedRowId = INVALID_ROW_ID;</div><div class="line"></div><div class="line">    // AbsListView#setAdapter will update choice mode states.</div><div class="line">    super.setAdapter(adapter);</div><div class="line"></div><div class="line">    if (mAdapter != null) &#123;</div><div class="line">        mAreAllItemsSelectable = mAdapter.areAllItemsEnabled();</div><div class="line">        mOldItemCount = mItemCount;</div><div class="line">        mItemCount = mAdapter.getCount();</div><div class="line">        checkFocus();</div><div class="line">        // æ„å»ºä¸€ä¸ª AdapterDataSetObserver </div><div class="line">        mDataSetObserver = new AdapterDataSetObserver();</div><div class="line">        mAdapter.registerDataSetObserver(mDataSetObserver);//æ³¨å†Œè§‚å¯Ÿè€…</div><div class="line"></div><div class="line">        mRecycler.setViewTypeCount(mAdapter.getViewTypeCount());</div><div class="line"></div><div class="line">        int position;</div><div class="line">        if (mStackFromBottom) &#123;</div><div class="line">            position = lookForSelectablePosition(mItemCount - 1, false);</div><div class="line">        &#125; else &#123;</div><div class="line">            position = lookForSelectablePosition(0, true);</div><div class="line">        &#125;</div><div class="line">        setSelectedPositionInt(position);</div><div class="line">        setNextSelectedPositionInt(position);</div><div class="line"></div><div class="line">        if (mItemCount == 0) &#123;</div><div class="line">            // Nothing selected</div><div class="line">            checkSelectionChanged();</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        mAreAllItemsSelectable = true;</div><div class="line">        checkFocus();</div><div class="line">        // Nothing selected</div><div class="line">        checkSelectionChanged();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    requestLayout();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ï¼ŒsetAdapter æ–¹æ³•å†…éƒ¨ä¼šæ„å»ºä¸€ä¸ª <code>AdapterDataSetObserver</code> ï¼Œç„¶åæ³¨å†Œä¸ºè§‚å¯Ÿè€…ã€‚æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°æ³¨å†Œçš„æ—¶å€™æ˜¯é€šè¿‡ Adapter æ¥æ³¨å†Œçš„ã€‚</p>
<p>Adapter æ¥å£ä¸­å£°æ˜äº†æ³¨å†Œå’Œè§£æ³¨å†Œçš„æ–¹æ³•ç­¾åã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public interface Adapter &#123;</div><div class="line">    /**</div><div class="line">     * Register an observer that is called when changes happen to the data used by this adapter.</div><div class="line">     *</div><div class="line">     * @param observer the object that gets notified when the data set changes.</div><div class="line">     */</div><div class="line">    void registerDataSetObserver(DataSetObserver observer);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Unregister an observer that has previously been registered with this</div><div class="line">     * adapter via &#123;@link #registerDataSetObserver&#125;.</div><div class="line">     *</div><div class="line">     * @param observer the object to unregister.</div><div class="line">     */</div><div class="line">    void unregisterDataSetObserver(DataSetObserver observer);</div><div class="line">    //ä»£ç çœç•¥</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è€Œ BaseAdapter å®ç°äº† ListAdapter æ¥å£ï¼ŒListAdapter æ¥å£åˆç»§æ‰¿è‡ª Adapter æ¥å£ã€‚<br>BaseAdapter ä¸­æ³¨å†Œæ–¹æ³•å’Œè§£é™¤æ³¨å†Œæ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public void registerDataSetObserver(DataSetObserver observer) &#123;</div><div class="line">    mDataSetObservable.registerObserver(observer);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void unregisterDataSetObserver(DataSetObserver observer) &#123;</div><div class="line">    mDataSetObservable.unregisterObserver(observer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>BaseAdapter ä¸­æ³¨å†Œæ–¹æ³•å’Œè§£é™¤æ³¨å†Œæ–¹æ³•çš„å…·ä½“å®ç°éƒ½æ˜¯é€šè¿‡ mDataSetObservable æ¥å®Œæˆçš„ã€‚æŸ¥çœ‹ä¸€ä¸‹ DataSetObservable çš„å…·ä½“å®ç°ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public class DataSetObservable extends Observable&lt;DataSetObserver&gt; &#123;</div><div class="line">    public void notifyChanged() &#123;</div><div class="line">        synchronized(mObservers) &#123;</div><div class="line">            for (int i = mObservers.size() - 1; i &gt;= 0; i--) &#123;</div><div class="line">                mObservers.get(i).onChanged();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void notifyInvalidated() &#123;</div><div class="line">        synchronized (mObservers) &#123;</div><div class="line">            for (int i = mObservers.size() - 1; i &gt;= 0; i--) &#123;</div><div class="line">                mObservers.get(i).onInvalidated();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¯¥ç±»ç»§æ‰¿äº† <code>android.database</code> åŒ…ä¸‹çš„ Observable ç±»ï¼Œè€Œ Observable ç±»ä¸­å­˜æœ‰æ‰€æœ‰è§‚å¯Ÿè€…çš„å¼•ç”¨ï¼Œä»¥åŠæ³¨å†Œå’Œè§£æ³¨å†Œæ–¹æ³•ã€‚</p>
<p>ListView ä¸­çš„ onChange æ–¹æ³•å…·ä½“å®ç°åˆæ˜¯ä»€ä¹ˆæ ·çš„?</p>
<ul>
<li>è¿˜è®°å¾—å‰é¢æˆ‘ä»¬è¯´ Observer æ˜¯å¦‚ä½•æ³¨å†Œçš„å—ï¼Ÿæ³¨å†Œæ—¶ï¼Œæˆ‘ä»¬æ„å»ºçš„æ˜¯ AdapterDataSetObserverã€‚</li>
<li>è¯¥ç±»æ˜¯ AbsListView çš„å†…éƒ¨ç±»ã€‚<ul>
<li>AbsListView.AdapterDataSetObserver ç»§æ‰¿è‡ª AdapterView<listadapter>.AdapterDataSetObserver </listadapter></li>
<li>onChange æ–¹æ³•çš„ä¸»è¦é€»è¾‘éƒ½åœ¨ AdapterDataSetObserver ä¸­</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">class AdapterDataSetObserver extends DataSetObserver &#123;</div><div class="line">    //ä»£ç çœç•¥ ...</div><div class="line">    @Override</div><div class="line">    public void onChanged() &#123;</div><div class="line">        mDataChanged = true;</div><div class="line">        mOldItemCount = mItemCount;</div><div class="line">        mItemCount = getAdapter().getCount();</div><div class="line"></div><div class="line">        // Detect the case where a cursor that was previously invalidated has</div><div class="line">        // been repopulated with new data.</div><div class="line">        if (AdapterView.this.getAdapter().hasStableIds() &amp;&amp; mInstanceState != null</div><div class="line">                &amp;&amp; mOldItemCount == 0 &amp;&amp; mItemCount &gt; 0) &#123;</div><div class="line">            AdapterView.this.onRestoreInstanceState(mInstanceState);</div><div class="line">            mInstanceState = null;</div><div class="line">        &#125; else &#123;</div><div class="line">            rememberSyncState();</div><div class="line">        &#125;</div><div class="line">        checkFocus();</div><div class="line">        requestLayout();</div><div class="line">    &#125;</div><div class="line">    //ä»£ç çœç•¥ ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>onChange æ–¹æ³•ä¸­ï¼Œä¼šè·å–å½“å‰ Adapter ä¸­çš„æ•°æ®é›†çš„æ–°æ•°é‡ï¼Œæ–¹æ³•çš„æœ€åè°ƒç”¨ ListView çš„ requestLayout() æ–¹æ³•é‡æ–°è¿›è¡Œå¸ƒå±€ã€‚</p>
<p>ä»ä¸Šé¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°</p>
<ul>
<li>AbsListView æ˜¯æŠ½è±¡çš„è§‚å¯Ÿè€…</li>
<li>ListView æ˜¯å…·ä½“çš„è§‚å¯Ÿè€…</li>
<li>Adapter æ¥å£æ˜¯æŠ½è±¡çš„è¢«è§‚å¯Ÿè€…</li>
<li>BaseAdapter æ˜¯å…·ä½“çš„è¢«è§‚å¯Ÿè€…ï¼Œå…¶å†…éƒ¨å®é™…ä¸Šæ˜¯é€šè¿‡ <code>android.database</code> åŒ…ä¸‹çš„ Observerable æ¥å®ç°æ³¨å†Œå’Œç›‘å¬çš„ã€‚</li>
</ul>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ul>
<li>AdapterView ä¸­æœ‰ä¸€ä¸ª AdapterDataSetObserver å†…éƒ¨ç±»ï¼Œ</li>
<li>åœ¨ ListView ä¸­è®¾ç½® Adapterï¼ˆå³è°ƒç”¨ ListView çš„ setAdapter æ–¹æ³•ï¼‰æ—¶ï¼Œå…¶å†…éƒ¨ä¼šæ„å»ºä¸€ä¸ª AdapterDataSetObserverï¼Œå¹¶æ³¨å†Œåˆ° Adapter ä¸­ã€‚å¯è§è¯¥åœºæ™¯ä¸­ ListView æ‰®æ¼”ä¸€ä¸ªè§‚å¯Ÿè€…è§’è‰²ã€‚</li>
<li>è€Œ Adapter ä¸­æœ‰ä¸€ä¸ªæ•°æ®é›†å¯è§‚å¯Ÿè€… DataSetObserableã€‚å³ä¸€ä¸ªè¢«è§‚å¯Ÿè€…ã€‚</li>
<li>æ•°æ®é›†å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¼€å‘è€…æ‰‹åŠ¨è°ƒç”¨ Adapter.notifyDataSetChanged æ–¹æ³•ï¼ŒnotifyDataSetChanged ä¼šè°ƒç”¨ <code>DataSetObserverable.notifyChanged()</code><ul>
<li>notifyChanged() æ–¹æ³•ä¼šéå†æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œå¹¶è°ƒç”¨è§‚å¯Ÿè€…çš„ <code>onChanged</code> æ–¹æ³•ï¼Œ</li>
<li>onChanged ä¼šè·å– Adapter ä¸­æ•°æ®é›†çš„æ–°æ•°é‡ï¼ŒåŒæ—¶ä¼šè°ƒç”¨ View.requestLayout æ–¹æ³•é€šçŸ¥ ListView æ›´æ–°å¸ƒå±€ï¼Œåˆ·æ–°ç”¨æˆ·ç•Œé¢ã€‚</li>
</ul>
</li>
</ul>
<p>è™½ç„¶ RecyclerView ç›´æ¥ç»§æ‰¿è‡ª ViewGroupï¼Œè€Œä¸æ˜¯ AdapterView ï¼Œä½†æ˜¯æ›´æ–°åˆ—è¡¨æ•°æ®é›†æ–¹æ³•çš„å†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡è§‚å¯Ÿè€…æ¨¡å¼æ¥å®ç°çš„ã€‚åªæ˜¯åœ¨å…¶ä¸­å¤šæä¾›äº†å•ä¸ªæ•°æ®æˆ–è€…æŒ‡å®šèŒƒå›´æ•°æ®æ›´æ–°ç­‰å›è°ƒæ¥å£ï¼Œä¾›å¼€å‘è€…ä½¿ç”¨ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹çœ‹ RecyclerView ä¸­è§‚å¯Ÿè€…æ¨¡å¼çš„å®ç°ã€‚</p>
<p>ä½œè€…æ°´å¹³æœ‰é™ï¼Œç–æ¼ä¹‹å¤„ï¼Œæ³è¯·æŒ‡å‡ºã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li>ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹ ç¬¬åäºŒç«  </li>
</ul>
]]></content>
      
        <categories>
            
            <category> åŸç†åˆ†æ </category>
            
            <category> Android è¿›é˜¶ </category>
            
            <category> è®¾è®¡æ¨¡å¼ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> Android è¿›é˜¶ </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Toast åŸç†]]></title>
      <url>https://timlin-pro.github.io/blog/2017/07/28/Toast%20%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/</url>
      <content type="html"><![CDATA[<h2 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h2><p><code>Toast.makeText(context,&quot;msg&quot;,Toast.Length_SHORT).show();</code></p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“è°ƒç”¨äº†è¿™è¡Œä»£ç ï¼Œä¾¿ä¼šè§¦å‘æ˜¾ç¤º Toast ä¿¡æ¯ï¼Œä½†æ˜¯ä»è°ƒç”¨å¼€å§‹åˆ°æ˜¾ç¤ºå‡ºæ¥çš„å…·ä½“è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„ï¼Œé‡Œé¢å…·ä½“å®ç°åˆæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p>
<a id="more"></a>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>åœ¨ Toast å†…éƒ¨æœ‰ä¸¤ç±» IPC è¿‡ç¨‹ã€‚</p>
<ul>
<li>ç¬¬ä¸€ç±»ï¼š Toast è®¿é—® NotificationManagerService</li>
<li>ç¬¬äºŒç±»ï¼šNotificationManagerService å›è°ƒ Toast é‡Œçš„ TN æ¥å£ã€‚</li>
</ul>
<p>Toast å±äºç³»ç»Ÿ Windowï¼Œå®ƒå†…éƒ¨çš„è§†å›¾ç”±ä¸¤ç§æ–¹å¼æŒ‡å®šï¼Œä¸€ç§æ˜¯ç³»ç»Ÿé»˜è®¤çš„æ ·å¼ï¼Œå¦ä¸€ç§æ˜¯è‡ªå®šä¹‰ä¸€ä¸ª view ç„¶åé€šè¿‡ setView æ–¹æ³•å°† view è®¾ç½®è¿›å»ã€‚<br>ä¸ç®¡å“ªä¸€ç§æ–¹å¼ï¼Œå®ƒä»¬éƒ½å¯¹åº” Toast çš„ä¸€ä¸ª View ç±»å‹çš„å†…éƒ¨æˆå‘˜ mNextViewã€‚</p>
<p>Toast æä¾› show å’Œ cancel æ–¹æ³•åˆ†åˆ«ç”¨äºæ˜¾ç¤ºå’Œéšè— viewï¼Œå®ƒä»¬çš„å†…éƒ¨éƒ½æ˜¯ä¸€ä¸ª IPC è¿‡ç¨‹ã€‚</p>
<p>Toast æœ‰å®šæ—¶å–æ¶ˆåŠŸèƒ½ï¼Œæ‰€ä»¥ç³»ç»Ÿé‡‡ç”¨äº† Handlerï¼ˆåˆ©ç”¨å…¶ä¸­çš„ sendMessageDelayed() æ–¹æ³•ï¼‰</p>
<p>Toast.show() è°ƒç”¨æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p><img src="https://user-images.githubusercontent.com/16668676/28705462-7393612a-73a2-11e7-92b0-5d0ebfb237f0.jpg" alt="toast show"></p>
<p>å…ˆæ¥çœ‹çœ‹ Toast.makeText æ–¹æ³•<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public static Toast makeText(Context context, CharSequence text, @Duration int duration) &#123;</div><div class="line">    Toast result = new Toast(context);//åˆ›å»ºä¸€ä¸ªæ–°çš„ Toast å¯¹è±¡</div><div class="line"></div><div class="line">    LayoutInflater inflate = (LayoutInflater)</div><div class="line">            context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);//è·å– LayoutInflater</div><div class="line">    View v = inflate.inflate(com.android.internal.R.layout.transient_notification, null); //æ¸²æŸ“å‡ºç³»ç»Ÿé»˜è®¤çš„å¸ƒå±€</div><div class="line">    TextView tv = (TextView)v.findViewById(com.android.internal.R.id.message);</div><div class="line">    tv.setText(text);//å°†æˆ‘ä»¬çš„ä¿¡æ¯è®¾ç½®åˆ° TextView ä¸­å»</div><div class="line">    </div><div class="line">    result.mNextView = v;//æŠŠ view èµ‹ç»™ Toast å†…éƒ¨çš„View</div><div class="line">    result.mDuration = duration;//è®¾ç½® toast æ—¶é•¿</div><div class="line"></div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å†ç§ä¸€ç§ Toast.show(); æ–¹æ³•<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public void show() &#123;</div><div class="line">    if (mNextView == null) &#123;//åˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½® Toast çš„ viewï¼Œå°±æŠ›å‡ºå¼‚å¸¸</div><div class="line">        throw new RuntimeException(&quot;setView must have been called&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    INotificationManager service = getService();//è·å– INotificationManager </div><div class="line">    String pkg = mContext.getOpPackageName();// è·å–è°ƒç”¨è€…çš„åŒ…å</div><div class="line">    TN tn = mTN;//ç»™ TN èµ‹å€¼</div><div class="line">    tn.mNextView = mNextView;</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">        service.enqueueToast(pkg, tn, mDuration);</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">        // Empty</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œé¢æœ‰å‡ ä¸ªåœ°æ–¹çœ‹èµ·æ¥æ¯”è¾ƒé™Œç”Ÿ INotificationManager æ˜¯ä»€ä¹ˆï¼ŒTN åˆæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>INotificationManager çš„å€¼æ˜¯ä» getService() æ–¹æ³•ä¸­å¾—æ¥çš„ã€‚æˆ‘ä»¬å…ˆæŸ¥çœ‹ä¸‹ getService() çš„å†…éƒ¨å®ç°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">static private INotificationManager getService() &#123;</div><div class="line">    if (sService != null) &#123;</div><div class="line">        return sService;</div><div class="line">    &#125;</div><div class="line">    sService = INotificationManager.Stub.asInterface(ServiceManager.getService(&quot;notification&quot;));</div><div class="line">    return sService;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>äº†è§£ Binder çš„åŒå­¦åº”è¯¥ä¸€çœ‹ä¾¿çŸ¥é“ï¼Œè¿™é‡Œç”¨åˆ°äº† Binderã€‚</li>
<li>INotificationManager çš„å…·ä½“å®ç°åœ¨ NotificationManagerService ä¸­ï¼Œç®€ä¾¿èµ·è§ï¼Œåç»­å†…å®¹å°† NotificationManagerService ç§°ä¸º NMSã€‚</li>
</ul>
<p>TN åˆæ˜¯ä»€ä¹ˆï¼Ÿ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TN</span> <span class="keyword">extends</span> <span class="title">ITransientNotification</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Runnable mHide = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            handleHide();</div><div class="line">            <span class="comment">// Don't do this in handleHide() because it is also invoked by handleShow()</span></div><div class="line">            mNextView = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WindowManager.LayoutParams mParams = <span class="keyword">new</span> WindowManager.LayoutParams();</div><div class="line">    <span class="keyword">final</span> Handler mHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            IBinder token = (IBinder) msg.obj;</div><div class="line">            handleShow(token);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> mGravity;</div><div class="line">    <span class="keyword">int</span> mX, mY;</div><div class="line">    <span class="keyword">float</span> mHorizontalMargin;</div><div class="line">    <span class="keyword">float</span> mVerticalMargin;</div><div class="line"></div><div class="line"></div><div class="line">    View mView;</div><div class="line">    View mNextView;</div><div class="line">    <span class="keyword">int</span> mDuration;</div><div class="line"></div><div class="line">    WindowManager mWM;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SHORT_DURATION_TIMEOUT = <span class="number">5000</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> LONG_DURATION_TIMEOUT = <span class="number">1000</span>;</div><div class="line"></div><div class="line">    TN() &#123;</div><div class="line">        <span class="comment">// XXX This should be changed to use a Dialog, with a Theme.Toast</span></div><div class="line">        <span class="comment">// defined that sets up the layout params appropriately.</span></div><div class="line">        <span class="keyword">final</span> WindowManager.LayoutParams params = mParams;</div><div class="line">        params.height = WindowManager.LayoutParams.WRAP_CONTENT;</div><div class="line">        params.width = WindowManager.LayoutParams.WRAP_CONTENT;</div><div class="line">        params.format = PixelFormat.TRANSLUCENT;</div><div class="line">        params.windowAnimations = com.android.internal.R.style.Animation_Toast;</div><div class="line">        params.type = WindowManager.LayoutParams.TYPE_TOAST;</div><div class="line">        params.setTitle(<span class="string">"Toast"</span>);</div><div class="line">        params.flags = WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON</div><div class="line">                | WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE</div><div class="line">                | WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * schedule handleShow into the right thread</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(IBinder windowToken)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (localLOGV) Log.v(TAG, <span class="string">"SHOW: "</span> + <span class="keyword">this</span>);</div><div class="line">        mHandler.obtainMessage(<span class="number">0</span>, windowToken).sendToTarget();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * schedule handleHide into the right thread</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hide</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (localLOGV) Log.v(TAG, <span class="string">"HIDE: "</span> + <span class="keyword">this</span>);</div><div class="line">        mHandler.post(mHide);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleShow</span><span class="params">(IBinder windowToken)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (localLOGV) Log.v(TAG, <span class="string">"HANDLE SHOW: "</span> + <span class="keyword">this</span> + <span class="string">" mView="</span> + mView</div><div class="line">                + <span class="string">" mNextView="</span> + mNextView);</div><div class="line">        <span class="keyword">if</span> (mView != mNextView) &#123;</div><div class="line">            <span class="comment">// remove the old view if necessary</span></div><div class="line">            handleHide();</div><div class="line">            mView = mNextView;</div><div class="line">            Context context = mView.getContext().getApplicationContext();</div><div class="line">            String packageName = mView.getContext().getOpPackageName();</div><div class="line">            <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</div><div class="line">                context = mView.getContext();</div><div class="line">            &#125;</div><div class="line">            mWM = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">            <span class="comment">// We can resolve the Gravity here by using the Locale for getting</span></div><div class="line">            <span class="comment">// the layout direction</span></div><div class="line">            <span class="keyword">final</span> Configuration config = mView.getContext().getResources().getConfiguration();</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> gravity = Gravity.getAbsoluteGravity(mGravity, config.getLayoutDirection());</div><div class="line">            mParams.gravity = gravity;</div><div class="line">            <span class="keyword">if</span> ((gravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) == Gravity.FILL_HORIZONTAL) &#123;</div><div class="line">                mParams.horizontalWeight = <span class="number">1.0f</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> ((gravity &amp; Gravity.VERTICAL_GRAVITY_MASK) == Gravity.FILL_VERTICAL) &#123;</div><div class="line">                mParams.verticalWeight = <span class="number">1.0f</span>;</div><div class="line">            &#125;</div><div class="line">            mParams.x = mX;</div><div class="line">            mParams.y = mY;</div><div class="line">            mParams.verticalMargin = mVerticalMargin;</div><div class="line">            mParams.horizontalMargin = mHorizontalMargin;</div><div class="line">            mParams.packageName = packageName;</div><div class="line">            mParams.hideTimeoutMilliseconds = mDuration ==</div><div class="line">                Toast.LENGTH_LONG ? LONG_DURATION_TIMEOUT : SHORT_DURATION_TIMEOUT;</div><div class="line">            mParams.token = windowToken;</div><div class="line">            <span class="keyword">if</span> (mView.getParent() != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (localLOGV) Log.v(TAG, <span class="string">"REMOVE! "</span> + mView + <span class="string">" in "</span> + <span class="keyword">this</span>);</div><div class="line">                mWM.removeView(mView);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (localLOGV) Log.v(TAG, <span class="string">"ADD! "</span> + mView + <span class="string">" in "</span> + <span class="keyword">this</span>);</div><div class="line">            mWM.addView(mView, mParams);</div><div class="line">            trySendAccessibilityEvent();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">trySendAccessibilityEvent</span><span class="params">()</span> </span>&#123;</div><div class="line">        AccessibilityManager accessibilityManager =</div><div class="line">                AccessibilityManager.getInstance(mView.getContext());</div><div class="line">        <span class="keyword">if</span> (!accessibilityManager.isEnabled()) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// treat toasts as notifications since they are used to</span></div><div class="line">        <span class="comment">// announce a transient piece of information to the user</span></div><div class="line">        AccessibilityEvent event = AccessibilityEvent.obtain(</div><div class="line">                AccessibilityEvent.TYPE_NOTIFICATION_STATE_CHANGED);</div><div class="line">        event.setClassName(getClass().getName());</div><div class="line">        event.setPackageName(mView.getContext().getPackageName());</div><div class="line">        mView.dispatchPopulateAccessibilityEvent(event);</div><div class="line">        accessibilityManager.sendAccessibilityEvent(event);</div><div class="line">    &#125;        </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleHide</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (localLOGV) Log.v(TAG, <span class="string">"HANDLE HIDE: "</span> + <span class="keyword">this</span> + <span class="string">" mView="</span> + mView);</div><div class="line">        <span class="keyword">if</span> (mView != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// note: checking parent() just to make sure the view has</span></div><div class="line">            <span class="comment">// been added...  i have seen cases where we get here when</span></div><div class="line">            <span class="comment">// the view isn't yet added, so let's try not to crash.</span></div><div class="line">            <span class="keyword">if</span> (mView.getParent() != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (localLOGV) Log.v(TAG, <span class="string">"REMOVE! "</span> + mView + <span class="string">" in "</span> + <span class="keyword">this</span>);</div><div class="line">                mWM.removeViewImmediate(mView);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mView = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>TN æ˜¯ Toast çš„ä¸€ä¸ªç§æœ‰çš„é™æ€å†…éƒ¨ç±»ï¼Œç»§æ‰¿è‡ª ITransientNotification.Stub </p>
<ul>
<li>ä¹Ÿæ˜¯ç”¨åˆ°äº† Binder æœºåˆ¶ã€‚</li>
</ul>
<p>åœ¨å›åˆ° show æ–¹æ³•ã€‚è¯¥æ–¹æ³•æœ€åè°ƒç”¨äº† <code>service.enqueueToast(pkg, tn, mDuration);</code> æ–¹æ³•ã€‚æˆ‘ä»¬åˆ° NMS çœ‹çœ‹è¯¥æ–¹æ³•çš„ä¸»è¦å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"> <span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueToast</span><span class="params">(String pkg, ITransientNotification callback, <span class="keyword">int</span> duration)</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="comment">//....</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isSystemToast = isCallerSystem() || (<span class="string">"android"</span>.equals(pkg));<span class="comment">//æ˜¯å¦æ˜¯ android ç³»ç»Ÿçš„ toast</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isPackageSuspended =</div><div class="line">            isPackageSuspendedForUser(pkg, Binder.getCallingUid());</div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="keyword">synchronized</span> (mToastQueue) &#123;</div><div class="line">        <span class="keyword">int</span> callingPid = Binder.getCallingPid();</div><div class="line">        <span class="keyword">long</span> callingId = Binder.clearCallingIdentity();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ToastRecord record;</div><div class="line">            <span class="keyword">int</span> index = indexOfToastLocked(pkg, callback);<span class="comment">//æ ¹æ®åŒ…åå’Œå›è°ƒæ¥è·å–çš„å¯¹åº”åŒ…åçš„ Toast çš„åœ¨ mToastQueue ä¸­çš„ä½ç½®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</span></div><div class="line">            <span class="comment">//å¦‚æœå¯¹åº”åŒ…åçš„ Toast å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ç›´æ¥åœ¨åŸä½æ›´æ–°ï¼Œä¸ä¼šæŠŠå®ƒæ’åˆ°é˜Ÿå°¾</span></div><div class="line">            <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</div><div class="line">                record = mToastQueue.get(index);</div><div class="line">                record.update(duration);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//é™åˆ¶éç³»ç»Ÿåº”ç”¨çš„æ•°é‡ï¼ˆä¸èƒ½è¶…è¿‡ 50ï¼‰ï¼Œé˜²æ­¢ DOS æ”»å‡»åŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†è§£å†³å†…å­˜æ³„æ¼é—®é¢˜</span></div><div class="line">                <span class="keyword">if</span> (!isSystemToast) &#123;</div><div class="line">                    <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> N = mToastQueue.size();</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">                         <span class="keyword">final</span> ToastRecord r = mToastQueue.get(i);</div><div class="line">                         <span class="keyword">if</span> (r.pkg.equals(pkg)) &#123;</div><div class="line">                             count++;</div><div class="line">                             <span class="keyword">if</span> (count &gt;= MAX_PACKAGE_NOTIFICATIONS) &#123;</div><div class="line">                                 Slog.e(TAG, <span class="string">"Package has already posted "</span> + count</div><div class="line">                                        + <span class="string">" toasts. Not showing more. Package="</span> + pkg);</div><div class="line">                                 <span class="keyword">return</span>;</div><div class="line">                             &#125;</div><div class="line">                         &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Binder token = <span class="keyword">new</span> Binder();</div><div class="line">                mWindowManagerInternal.addWindowToken(token,</div><div class="line">                        WindowManager.LayoutParams.TYPE_TOAST);</div><div class="line">                record = <span class="keyword">new</span> ToastRecord(callingPid, pkg, callback, duration, token);<span class="comment">//å°† Toast åŒ…è£…ä¸º ToastRecord</span></div><div class="line">                mToastQueue.add(record);<span class="comment">//åŠ å…¥ mToastQueue</span></div><div class="line">                index = mToastQueue.size() - <span class="number">1</span>;</div><div class="line">                keepProcessAliveIfNeededLocked(callingPid);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</div><div class="line">                showNextToastLocked();<span class="comment">//æ˜¾ç¤ºä¸‹ä¸€æ¡ Toast</span></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            Binder.restoreCallingIdentity(callingId);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•ä¼šå°† Toast è¯·æ±‚å°è£…ä¸º ToastRecord å¹¶å°†å…¶æ·»åŠ è¿› mToastQueue é˜Ÿåˆ—ä¸­ã€‚</p>
<ul>
<li>mToastQueue æ˜¯ä¸€ä¸ª ArrayList</li>
<li>æ³¨æ„ï¼šæ¯ä¸ªéç³»ç»Ÿåº”ç”¨æœ€å¤šåªèƒ½æœ‰ 50 ä¸ªToastRecordã€‚å¦‚æœè¶…å‡ºäº†æœ€å¤§å€¼ï¼Œå°±ä¼šå‡ºé”™ã€‚<ul>
<li>è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº† é˜²æ­¢ DOSï¼ˆDenial Of Serviceï¼‰</li>
</ul>
</li>
</ul>
<blockquote>
<p>æ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆè‹±è¯­ï¼šdenial-of-service attackï¼Œç¼©å†™ï¼šDoS attackã€DoSï¼‰äº¦ç§°æ´ªæ°´æ”»å‡»ï¼Œæ˜¯ä¸€ç§ç½‘ç»œæ”»å‡»æ‰‹æ³•ï¼Œå…¶ç›®çš„åœ¨äºä½¿ç›®æ ‡ç”µè„‘çš„ç½‘ç»œæˆ–ç³»ç»Ÿèµ„æºè€—å°½ï¼Œä½¿æœåŠ¡æš‚æ—¶ä¸­æ–­æˆ–åœæ­¢ï¼Œå¯¼è‡´å…¶æ­£å¸¸ç”¨æˆ·æ— æ³•è®¿é—®ã€‚</p>
</blockquote>
<p>å°† ToastRecord åŠ å…¥é˜Ÿåˆ—ä¹‹åï¼Œ <code>enqueueToast</code> è¿˜è°ƒç”¨äº† <code>showNextToastLocked();</code> æ–¹æ³•, è¯¥æ–¹æ³•çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">void showNextToastLocked() &#123;</div><div class="line">    ToastRecord record = mToastQueue.get(0);</div><div class="line">    while (record != null) &#123;</div><div class="line">        if (DBG) Slog.d(TAG, &quot;Show pkg=&quot; + record.pkg + &quot; callback=&quot; + record.callback);</div><div class="line">        try &#123;</div><div class="line">            record.callback.show(record.token);//è°ƒç”¨ record å¯¹è±¡ä¸­ callback çš„ show æ–¹æ³•</div><div class="line">            scheduleTimeoutLocked(record); //è¶…æ—¶æé†’ï¼Œæ§åˆ¶æ˜¾ç¤ºæ—¶é—´</div><div class="line">            return;</div><div class="line">        &#125; catch (RemoteException e) &#123;</div><div class="line">            //...ä»£ç çœç•¥</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„ callBack æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>å®ƒæ˜¯åœ¨ ToastRecord ä¸­çš„ï¼Œç…ç… ToastRecord çš„æ„é€ æ–¹æ³•ã€‚<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ToastRecord(<span class="keyword">int</span> pid, String pkg, ITransientNotification callback, <span class="keyword">int</span> duration,</div><div class="line">            Binder token) &#123;</div><div class="line">    <span class="keyword">this</span>.pid = pid;</div><div class="line">    <span class="keyword">this</span>.pkg = pkg;</div><div class="line">    <span class="keyword">this</span>.callback = callback;</div><div class="line">    <span class="keyword">this</span>.duration = duration;</div><div class="line">    <span class="keyword">this</span>.token = token;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>åœ¨ enqueueToast æ–¹æ³•ä¸­ï¼Œå°† Toast åŒ…è£…ä¸º ToastRecord ï¼Œåˆ›å»ºäº† ToastRecord å¯¹è±¡ã€‚</p>
<ul>
<li><code>record = new ToastRecord(callingPid, pkg, callback, duration, token);//å°† Toast åŒ…è£…ä¸º ToastRecord</code> </li>
<li>callBack æ˜¯ enqueueToast ä¸­çš„ä¸€ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬çš„è°ƒç”¨å¦‚ä¸‹ï¼š <code>service.enqueueToast(pkg, tn, mDuration);</code> </li>
<li><p>æ²¡é”™ï¼ŒcallBack å®é™…ä¸Šå°±æ˜¯å‰é¢è®²åˆ°çš„ Toast çš„å†…éƒ¨ç±» TNã€‚</p>
<ul>
<li>å›åˆ°å‰é¢çœ‹çœ‹ï¼ŒTN ç¡®å®ç»§æ‰¿äº† <code>ITransientNotification.Stub</code>ã€‚</li>
</ul>
</li>
<li><p>showNextToastLocked() æ–¹æ³•è°ƒç”¨ callBack çš„ show() æ–¹æ³•æ¥æ˜¾ç¤º Toastã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void show(IBinder windowToken) &#123;</div><div class="line">    if (localLOGV) Log.v(TAG, &quot;SHOW: &quot; + this);</div><div class="line">    mHandler.obtainMessage(0, windowToken).sendToTarget();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">final Handler mHandler = new Handler() &#123;</div><div class="line">    @Override</div><div class="line">    public void handleMessage(Message msg) &#123;</div><div class="line">        IBinder token = (IBinder) msg.obj;</div><div class="line">        handleShow(token);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å…¶å…·ä½“å®ç°åˆæ˜¯åœ¨ handleShow(token);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleShow</span><span class="params">(IBinder windowToken)</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">if</span> (mView != mNextView) &#123;</div><div class="line">        <span class="comment">// å¦‚æœæœ‰å¿…è¦çš„è¯ï¼Œå°†è¿˜åœ¨æ˜¾ç¤ºçš„ toast éšè—æ‰</span></div><div class="line">        handleHide();</div><div class="line">        mView = mNextView;</div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">        mWM = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);<span class="comment">//è·å– windowManager</span></div><div class="line">        <span class="comment">//çœç•¥ä»£ç ï¼Œç»™å¸ƒå±€å‚æ•°èµ‹å€¼</span></div><div class="line">        <span class="keyword">if</span> (mView.getParent() != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (localLOGV) Log.v(TAG, <span class="string">"REMOVE! "</span> + mView + <span class="string">" in "</span> + <span class="keyword">this</span>);</div><div class="line">            mWM.removeView(mView);</div><div class="line">        &#125;</div><div class="line">        mWM.addView(mView, mParams);</div><div class="line">        trySendAccessibilityEvent();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»¥ä¸Šä»£ç æ ¸å¿ƒåœ¨äº<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mWM = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">mWM.addView(mView, mParams);</div></pre></td></tr></table></figure></p>
<p>å°† Toast çš„è§†å›¾æ·»åŠ åˆ° Window ä¸­ã€‚ è¿™æ · View å°±èƒ½é¡ºåˆ©æ˜¾ç¤ºå‡ºæ¥äº†ã€‚</p>
<p>ä½ å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆ TN è°ƒç”¨ show æ–¹æ³•è¦ç”¨åˆ°çš„ Handler ï¼Ÿ</p>
<ul>
<li>å› ä¸ºè¯¥æ–¹æ³•æ˜¯è¢«æ˜¯è¢« NMS ä»¥è·¨è¿›ç¨‹æ–¹å¼è°ƒç”¨çš„ï¼Œå› æ­¤å®ƒä»¬è¿è¡Œåœ¨ Binder çº¿ç¨‹æ± ä¸­ã€‚ä¸ºäº†å°†æ‰§è¡Œç¯å¢ƒåˆ‡æ¢åˆ° Toast è¯·æ±‚æ‰€åœ¨çš„çº¿ç¨‹ï¼Œåœ¨å®ƒä»¬å†…éƒ¨ä½¿ç”¨äº† Handlerã€‚</li>
</ul>
<p>é‚£ä¹ˆæ—¶é—´åˆ°äº† Toast åˆæ˜¯æ€ä¹ˆæ ·å–æ¶ˆçš„å‘¢ï¼Ÿ</p>
<ul>
<li><p>åœ¨ä»¤ Toast æ˜¾ç¤ºæ–¹æ³•è°ƒç”¨è¿‡ç¨‹ä¸­ æˆ‘ä»¬ä¹Ÿè°ƒç”¨äº† <code>scheduleTimeoutLocked(record);</code> æ–¹æ³•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private void scheduleTimeoutLocked(ToastRecord r)&#123;</div><div class="line">    mHandler.removeCallbacksAndMessages(r);</div><div class="line">    Message m = Message.obtain(mHandler, MESSAGE_TIMEOUT, r);</div><div class="line">    long delay = r.duration == Toast.LENGTH_LONG ? LONG_DELAY : SHORT_DELAY;//è®¾ç½® å»¶è¿Ÿæ—¶é—´</div><div class="line">    mHandler.sendMessageDelayed(m, delay);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>SHORT_DELAY ä¸º 2s</p>
</li>
<li>LONG_DELAY ä¸º 3.5s</li>
</ul>
<p>scheduleTimeoutLocked ä¼šå‘å‡ºæ¶ˆæ¯ç»™ hanlder,æ”¶åˆ°ç›¸åº”çš„ä¿¡æ¯å handleMessage æ–¹æ³•ä¼šè°ƒç”¨<code>handleTimeout((ToastRecord)msg.obj);</code>, è¯¥æ–¹æ³•åˆä¼šè°ƒç”¨ <code>cancelToastLocked(index);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelToastLocked</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    ToastRecord record = mToastQueue.get(index);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        record.callback.hide();<span class="comment">//</span></div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    &#125;</div><div class="line">        <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°éšè— Toast çš„å®ç°ä¹Ÿæ˜¯åœ¨ TN ä¸­çš„ã€‚ä¸ handleShow å¯¹åº”ï¼Œæœ‰ä¸€ä¸ª handleHide æ–¹æ³•ã€‚<br>è¯¥æ–¹æ³•ä¼šå°† Toast çš„è§†å›¾ä» Window ä¸­ç§»é™¤ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleHide</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mView != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mView.getParent() != <span class="keyword">null</span>) &#123;</div><div class="line">            mWM.removeViewImmediate(mView);</div><div class="line">        &#125;</div><div class="line">        mView = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Toast-çš„ã€Œä¸€ä¸ª-Bugã€"><a href="#Toast-çš„ã€Œä¸€ä¸ª-Bugã€" class="headerlink" title="Toast çš„ã€Œä¸€ä¸ª Bugã€"></a>Toast çš„ã€Œä¸€ä¸ª Bugã€</h2><p>å…¶å®è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„Bugï¼Œè°·æ­Œä¸ºäº†è®©åº”ç”¨çš„ Toast èƒ½å¤Ÿæ˜¾ç¤ºåœ¨å…¶ä»–åº”ç”¨ä¸Šé¢ï¼Œæ‰€ä»¥ä½¿ç”¨äº†é€šçŸ¥æ ç›¸å…³çš„ APIï¼Œä½†æ˜¯è¿™ä¸ª API éšç€ç”¨æˆ·å±è”½é€šçŸ¥æ è€Œå˜å¾—ä¸å¯ç”¨ï¼Œç³»ç»Ÿé”™è¯¯åœ°è®¤ä¸ºä½ æ²¡æœ‰é€šçŸ¥æ æƒé™ï¼Œä»è€Œé—´æ¥å¯¼è‡´ Toast æœ‰ show è¯·æ±‚æ—¶è¢«ç³»ç»Ÿæ‰€æ‹¦æˆª</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://www.jianshu.com/p/1d64a5ccbc7c" target="_blank" rel="noopener">Toasté€šçŸ¥æ æƒé™å¡«å‘æŒ‡å—</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®è¯·åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> åŸç†åˆ†æ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[åˆ›å»ºå‹æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼]]></title>
      <url>https://timlin-pro.github.io/blog/2017/07/20/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€ä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼ï¼Ÿ"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼ï¼Ÿ" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼ï¼Ÿ"></a>ä¸€ã€ä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼ï¼Ÿ</h2><p><a href="https://zh.wikipedia.org/wiki/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener">wiki</a> ç»™å‡ºçš„å®šä¹‰å¦‚ä¸‹ï¼šå•ä¾‹æ¨¡å¼ï¼Œä¹Ÿå«å•å­æ¨¡å¼ï¼Œæ˜¯ä¸€ç§å¸¸ç”¨çš„è½¯ä»¶è®¾è®¡æ¨¡å¼ã€‚åœ¨åº”ç”¨è¿™ä¸ªæ¨¡å¼æ—¶ï¼Œå•ä¾‹å¯¹è±¡çš„ç±»å¿…é¡»ä¿è¯åªæœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨ã€‚è®¸å¤šæ—¶å€™æ•´ä¸ªç³»ç»Ÿåªéœ€è¦æ‹¥æœ‰ä¸€ä¸ªçš„å…¨å±€å¯¹è±¡ï¼Œè¿™æ ·æœ‰åˆ©äºæˆ‘ä»¬åè°ƒç³»ç»Ÿæ•´ä½“çš„è¡Œä¸ºã€‚</p>
<ul>
<li>æ¯”å¦‚åœ¨æŸä¸ªæœåŠ¡å™¨ç¨‹åºä¸­ï¼Œè¯¥æœåŠ¡å™¨çš„é…ç½®ä¿¡æ¯å­˜æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè¿™äº›é…ç½®æ•°æ®ç”±ä¸€ä¸ªå•ä¾‹å¯¹è±¡ç»Ÿä¸€è¯»å–ï¼Œç„¶åæœåŠ¡è¿›ç¨‹ä¸­çš„å…¶ä»–å¯¹è±¡å†é€šè¿‡è¿™ä¸ªå•ä¾‹å¯¹è±¡è·å–è¿™äº›é…ç½®ä¿¡æ¯ã€‚è¿™ç§æ–¹å¼ç®€åŒ–äº†åœ¨å¤æ‚ç¯å¢ƒä¸‹çš„é…ç½®ç®¡ç†ã€‚</li>
</ul>
<a id="more"></a>
<h2 id="äºŒã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Ÿ"><a href="#äºŒã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Ÿ" class="headerlink" title="äºŒã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Ÿ"></a>äºŒã€ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Ÿ</h2><ul>
<li>æœ‰ä¸€äº›å¯¹è±¡çš„å†…å­˜æ¶ˆè€—æ¯”è¾ƒå¤§ï¼Œåˆ›å»ºå¤šæ¬¡ä¼šé€ æˆå¾ˆå¤§çš„èµ„æºå¼€æ”¯ã€‚</li>
<li>æ–¹ä¾¿é…ç½®ã€‚<ul>
<li>ä¾‹å¦‚ ç½‘ç»œè¯·æ±‚ç»å¸¸è¦ç”¨åˆ° cookieï¼Œå¦‚æœä½¿ç”¨ OkHttp å¯ä»¥å°†å…¶å°è£…ä¸ºä¸€ä¸ªå•ä¾‹å·¥å…·ç±»ï¼Œå†…éƒ¨ä½¿ç”¨ CookJar å¯¹ cookie  è¿›è¡Œç®¡ç†ï¼Œè¿™æ ·åç»­çš„è¯·æ±‚å°±ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚ </li>
</ul>
</li>
<li>å®‰å…¨æ€§ã€‚æ¯”å¦‚ SQLite æ•°æ®åº“çš„å¢åˆ æŸ¥æ”¹ï¼Œé€šè¿‡å•ä¾‹å¯¹è±¡å¯¹å¤–æä¾›å¢åˆ æŸ¥æ”¹åŠŸèƒ½ï¼Œå¯ä»¥é¿å…ä¸€äº›å¹¶å‘é”™è¯¯ã€‚</li>
</ul>
<h2 id="ä¸‰ã€å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼"><a href="#ä¸‰ã€å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼" class="headerlink" title="ä¸‰ã€å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼"></a>ä¸‰ã€å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼</h2><h3 id="1-é¥¿æ±‰æ¨¡å¼"><a href="#1-é¥¿æ±‰æ¨¡å¼" class="headerlink" title="1. é¥¿æ±‰æ¨¡å¼"></a>1. é¥¿æ±‰æ¨¡å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton sInstance = <span class="keyword">new</span> Singleton();</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sInstance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨å£°æ˜é™æ€å¯¹è±¡æ—¶å°±æŠŠå®ƒåˆå§‹åŒ–ã€‚ï¼ˆå› ä¸ºé¥¿ï¼Œæ‰€ä»¥è¿«ä¸åŠå¾…å…ˆæŠŠå®ƒ new å‡ºæ¥ï¼‰</p>
<h3 id="2-æ‡’æ±‰æ¨¡å¼"><a href="#2-æ‡’æ±‰æ¨¡å¼" class="headerlink" title="2. æ‡’æ±‰æ¨¡å¼"></a>2. æ‡’æ±‰æ¨¡å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton sInstance;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">            sInstance = <span class="keyword">new</span> Singleton();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sInstance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ <code>getInstance</code> æ–¹æ³•ä¸­æ·»åŠ äº† <code>synchronized</code> å…³é”®å­—ï¼Œä¹Ÿå°±æ˜¯ </p>
<ul>
<li>ä¸€ä¸ªé—®é¢˜ï¼šå³ä½¿ instance å·²ç»è¢«åˆå§‹åŒ–ï¼Œä¹‹åçš„æ¯æ¬¡è°ƒç”¨è¿˜æ˜¯ä¼š è¿›è¡ŒåŒæ­¥ï¼Œè¿™æ ·ä¼šæ¶ˆè€—ä¸å¿…è¦çš„èµ„æº</li>
</ul>
<p>ä¸ºä»€ä¹ˆå«åšæ‡’æ±‰å‘¢ï¼Ÿå…¶å®å¯ä»¥ç†è§£ä¸ºæ‡’åŠ è½½ï¼Œæœ‰éœ€è¦çš„æ—¶å€™ï¼Œå†æŠŠå®ƒåŠ è½½å‡ºæ¥ã€‚</p>
<p>æ‡’æ±‰å•ä¾‹æ¨¡å¼çš„</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå•ä¾‹åªæœ‰åœ¨ä½¿ç”¨æ—¶æ‰ä¼šè¢«å®ä¾‹åŒ–ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸ŠèŠ‚çº¦äº†èµ„æºã€‚</li>
<li>ç¼ºç‚¹ï¼šç¬¬ä¸€æ¬¡åŠ è½½æ—¶éœ€è¦åŠæ—¶åœ°å®ä¾‹åŒ–ï¼Œååº”ç¨æ…¢ï¼Œæœ€å¤§çš„é—®é¢˜æ˜¯ï¼š<strong>æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¿›è¡ŒåŒæ­¥ï¼Œé€ æˆä¸å¿…è¦çš„åŒæ­¥å¼€é”€</strong>ã€‚</li>
</ul>
<h3 id="3-åŒé‡æ ¡éªŒé”-DCL"><a href="#3-åŒé‡æ ¡éªŒé”-DCL" class="headerlink" title="3. åŒé‡æ ¡éªŒé” ( DCL )"></a>3. åŒé‡æ ¡éªŒé” ( DCL )</h3><p>DCL æ—¢èƒ½å¤Ÿåœ¨éœ€è¦æ—¶æ‰åˆå§‹åŒ–å®ä¾‹ï¼Œåˆèƒ½å¤Ÿä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè€Œä¸”å•ä¾‹å¯¹è±¡åˆå§‹åŒ–åæ‰è°ƒç”¨ getInstance ä¸è¿›è¡ŒåŒæ­¥é”ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (Singleton.class) &#123;</div><div class="line">            <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                sInstance = <span class="keyword">new</span> Singleton();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sInstance;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="ä¸ºä»€ä¹ˆåœ¨åŒæ­¥å—å†…è¿˜è¦å†è¿›è¡Œåˆ¤ç©ºï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆåœ¨åŒæ­¥å—å†…è¿˜è¦å†è¿›è¡Œåˆ¤ç©ºï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆåœ¨åŒæ­¥å—å†…è¿˜è¦å†è¿›è¡Œåˆ¤ç©ºï¼Ÿ"></a>ä¸ºä»€ä¹ˆåœ¨åŒæ­¥å—å†…è¿˜è¦å†è¿›è¡Œåˆ¤ç©ºï¼Ÿ</h4><p>å› ä¸º<strong>å¯èƒ½ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ä¸€èµ·è¿›å…¥åŒæ­¥å—å¤–çš„ ifï¼Œå¦‚æœåœ¨åŒæ­¥å—å†…ä¸è¿›è¡ŒäºŒæ¬¡æ£€éªŒçš„è¯å°±ä¼šç”Ÿæˆå¤šä¸ªå®ä¾‹äº†</strong>ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆè¦åŠ -volitale-å…³é”®å­—ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦åŠ -volitale-å…³é”®å­—ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦åŠ  volitale å…³é”®å­—ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦åŠ  volitale å…³é”®å­—ï¼Ÿ</h4><p><code>sInstance = new Singleton();</code>è¿™å¥ä»£ç ä¼šè¢«ç¼–è¯‘æˆå¤šæ¡æ±‡ç¼–æŒ‡ä»¤ï¼Œå®ƒå¤§è‡´åšäº† 3 ä»¶äº‹æƒ…</p>
<ol>
<li>ç»™ Singleton å®ä¾‹åˆ†é…å†…å­˜</li>
<li>è°ƒç”¨ Singleton çš„æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–æˆå‘˜å­—æ®µ</li>
<li>å°† sInstance å¯¹è±¡æŒ‡å‘åˆ†é…çš„å†…å­˜ç©ºé—´</li>
</ol>
<p>ä½†æ˜¯ç”±äº Java ç¼–è¯‘å™¨å…è®¸å¤„ç†å™¨ä¹±åºæ‰§è¡Œï¼Œä»¥åŠ JDK 1.5 ä¹‹å‰ JMMï¼ˆJava Memory Modelï¼Œ Java å†…å­˜æ¨¡å‹ï¼‰ ä¸­ cacheã€å¯„å­˜å™¨åˆ°ä¸»å†…å­˜å›å†™é¡ºåºçš„è§„å®šï¼Œ<br>ä¸Šé¢çš„ 2 å’Œ 3 çš„é¡ºåºæ˜¯æ— æ³•ä¿è¯çš„ã€‚ å¦‚æœæ˜¯ 1-3-2ï¼Œé‚£ä¹ˆå½“ 3 æ‰§è¡Œå®Œï¼Œå¹¶ä¸” 2 è¿˜æ²¡æœ‰æ‰§è¡Œçš„è¯ï¼Œè¢«åˆ‡æ¢åˆ°åˆ°çº¿ç¨‹ Bï¼Œè¿™æ—¶ sInstance å·²ç»éç©ºï¼ˆå› ä¸º 3 å·²ç»è¢«æ‰§è¡Œäº†å˜›ï¼‰ï¼Œè‹¥ æ­¤æ—¶çº¿ç¨‹ B ç›´æ¥å–èµ° sInstance ä½¿ç”¨æ—¶å°±ä¼šæŠ¥é”™ã€‚</p>
<p>è§£å†³ï¼šJDK 1.5 ä¹‹åï¼ŒSUN å®˜æ–¹è°ƒæ•´äº† JVMï¼Œå…·ä½“åŒ–äº† volatile å…³é”®å­—ï¼ˆç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼‰ã€‚ </p>
<ul>
<li>å¦‚æœæ˜¯åœ¨ JDK 1.5 ä¹‹åï¼Œé‚£ä¹ˆåªéœ€è¦æŠŠ sInstance çš„å£°æ˜ æ”¹ä¸º <code>private volatile static Singleton sInstance;</code> å³å¯</li>
</ul>
<h3 id="4-é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼"><a href="#4-é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼" class="headerlink" title="4. é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼"></a>4. é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼</h3><p>DCL åœ¨æŸäº›æƒ…å†µä¸‹ä¼šå‡ºç°å¤±æ•ˆçš„é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜è¢«ç§°ä¸ºåŒé‡æ£€æŸ¥é”å®šï¼ˆDCLï¼‰å¤±æ•ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123; &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> SingletonHolder.sInstance;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton sInstance = <span class="keyword">new</span> Singleton();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸€æ¬¡è°ƒç”¨ Singleton çš„ getInstance æ–¹æ³•æ—¶æ‰ä¼šå¯¼è‡´ sInstance è¢«åˆå§‹åŒ–ã€‚å› æ­¤ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ getInstance æ–¹æ³•ä¼šå¯¼è‡´è™šæ‹ŸæœºåŠ è½½ SingletonHolder ç±»ï¼Œè¿™ç§æ–¹å¼ä¸ä»…èƒ½å¤Ÿç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œä¹Ÿèƒ½ä¿è¯å•ä¾‹å¯¹è±¡çš„å”¯ä¸€æ€§ã€‚</p>
<p>æ‰€ä»¥è¿™æ˜¯æ¨èä½¿ç”¨çš„å•ä¾‹æ¨¡å¼å®ç°æ–¹å¼</p>
<h3 id="5-æšä¸¾å•ä¾‹"><a href="#5-æšä¸¾å•ä¾‹" class="headerlink" title="5. æšä¸¾å•ä¾‹"></a>5. æšä¸¾å•ä¾‹</h3><p>å¯¹æšä¸¾ä¸äº†è§£å¯ä»¥å…ˆçœ‹çœ‹<a href="https://www.ibm.com/developerworks/cn/java/j-lo-enum/" target="_blank" rel="noopener">æšä¸¾</a>è¿™ç¯‡æ–‡ç« </p>
<p>å†™æ³•ç®€å•æ˜¯æšä¸¾å•ä¾‹ æœ€å¤§çš„ä¼˜ç‚¹ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Singleton&#123;</div><div class="line">    INSTANCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è·å–å¯¹è±¡å¯ä»¥è¿™ä¹ˆå†™ï¼š Singleton singleton = <code>Singleton.INSTANCE</code>;</p>
<p>æšä¸¾åœ¨ Java ä¸­ä¸æ™®é€šçš„ç±»æ˜¯ä¸€æ ·çš„ï¼Œä¸ä»…èƒ½å¤Ÿæœ‰å­—æ®µï¼Œè¿˜èƒ½å®šä¹‰è‡ªå·±çš„æ–¹æ³•ã€‚  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Singleton&#123;</div><div class="line">    INSTANCE;</div><div class="line"></div><div class="line">    <span class="comment">//æšä¸¾å†…éƒ¨å¯ä»¥å®šä¹‰æˆå‘˜ï¼›</span></div><div class="line">    <span class="keyword">private</span> String mString;</div><div class="line">    <span class="comment">//æšä¸¾å†…éƒ¨å¯ä»¥å®šä¹‰æ–¹æ³•ï¼›</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSth</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//do sth</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€é‡è¦çš„æ˜¯<strong>é»˜è®¤æšä¸¾å®ä¾‹çš„åˆ›å»ºæ˜¯çº¿ç¨‹å®‰å…¨çš„</strong>ï¼Œå¹¶ä¸”ä»»ä½•æƒ…å†µä¸‹å®ƒéƒ½æ˜¯ä¸€ä¸ªå•ä¾‹ã€‚</p>
<p>ä¸Šè¿°å‡ ç§æ–¹å¼ä¸­ï¼Œåœ¨ä¸€ä¸ªæƒ…å†µä¸‹éƒ½ä¼šé‡æ–°åˆ›å»ºå¯¹è±¡çš„æƒ…å†µï¼Œé‚£å°±æ˜¯<strong>ååºåˆ—åŒ–</strong>ã€‚</p>
<p>å³ä½¿æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œååºåˆ—åŒ–æ˜¯ä¾ç„¶å¯ä»¥é€šè¿‡ç‰¹æ®Šçš„é€”å¾„å»åˆ›å»ºç±»çš„ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œç›¸å½“äº è°ƒç”¨è¯¥ç±»çš„æ„é€ å‡½æ•°ã€‚</p>
<p>ååºåˆ—åŒ–æ“ä½œæä¾›äº†ä¸€ä¸ªå¾ˆç‰¹åˆ«çš„<strong>é’©å­å‡½æ•°</strong>ï¼Œç±»ä¸­å…·æœ‰ä¸€ä¸ªç§æœ‰çš„ã€è¢«å®ä¾‹åŒ–çš„æ–¹æ³• <code>readResolve()</code>,è¿™ä¸ªæ–¹æ³•å¯ä»¥è®©å¼€å‘äººå‘˜æ§åˆ¶å¯¹è±¡çš„ååºåˆ—åŒ–ã€‚</p>
<p>ä¸Šè¿°å‡ ç§å•ä¾‹æ–¹æ³•ä¸­å¦‚æœè¦æœç»å•ä¾‹å¯¹è±¡åœ¨è¢«ååºåˆ—åŒ–æ—¶é‡æ–°ç”Ÿæˆå¯¹è±¡ï¼Œé‚£å¿…é¡»åŠ å…¥å¦‚ä¸‹æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException </span>&#123;</div><div class="line">    <span class="keyword">return</span> sInstance;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¹Ÿå°±æ˜¯åœ¨ readResolve æ–¹æ³•ä¸­å°† sInstance å¯¹è±¡è¿”å›ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</p>
<p>è€Œ<strong>å¯¹äºæšä¸¾</strong>ï¼Œå¹¶ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸º<strong>å³ä½¿ååºåˆ—åŒ–ä¹Ÿä¸ä¼šé‡æ–°ç”Ÿæˆæ–°çš„å®ä¾‹</strong>ã€‚</p>
<h3 id="6-ä½¿ç”¨å®¹å™¨å®ç°å•ä¾‹æ¨¡å¼"><a href="#6-ä½¿ç”¨å®¹å™¨å®ç°å•ä¾‹æ¨¡å¼" class="headerlink" title="6. ä½¿ç”¨å®¹å™¨å®ç°å•ä¾‹æ¨¡å¼"></a>6. ä½¿ç”¨å®¹å™¨å®ç°å•ä¾‹æ¨¡å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Object&gt; sObjectMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerService</span><span class="params">(String key, Object instance)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!sObjectMap.containsKey(key)) &#123;</div><div class="line">            sObjectMap.put(key, instance);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getService</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sObjectMap.get(key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ç¨‹åºçš„åˆå§‹ï¼Œå°†å¤šç§å•ä¾‹ç±»å‹æ³¨å…¥åˆ°ä¸€ä¸ªç»Ÿä¸€çš„ç®¡ç†ç±»ä¸­ï¼Œä½¿ç”¨æ—¶æ ¼æ ¹æ® key è·å–å¯¹è±¡å¯¹åº”ç±»å‹çš„å¯¹è±¡ã€‚</p>
<ul>
<li>è¿™ç§å®ç°æ–¹å¼ä¸»è¦æ˜¯æ–¹ä¾¿å¯¹å•ä¾‹å¯¹è±¡è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</li>
</ul>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><ul>
<li>ä¸ç®¡ä½¿ç”¨å“ªä¸€ç§å½¢å¼å®ç°å•ä¾‹æ¨¡å¼ï¼Œ<strong>æ ¸å¿ƒåŸç†</strong>éƒ½æ˜¯==å°†æ„é€ å‡½æ•°ç§æœ‰åŒ–==ï¼Œå¹¶ä¸”==é€šè¿‡é™æ€æ–¹æ³•è·å–å”¯ä¸€çš„çš„å®ä¾‹==ã€‚</li>
<li>åœ¨è·å–çš„è¿‡ç¨‹ä¸­å¿…é¡»ä¿è¯<strong>çº¿ç¨‹å®‰å…¨</strong>ã€<strong>é˜²æ­¢ååºåˆ—åŒ–å¯¼è‡´é‡æ–°ç”Ÿæˆå®ä¾‹å¯¹è±¡</strong>ç­‰é—®é¢˜ã€‚</li>
</ul>
<h2 id="ä½¿ç”¨æ—¶çš„æ³¨æ„ç‚¹"><a href="#ä½¿ç”¨æ—¶çš„æ³¨æ„ç‚¹" class="headerlink" title="ä½¿ç”¨æ—¶çš„æ³¨æ„ç‚¹"></a>ä½¿ç”¨æ—¶çš„æ³¨æ„ç‚¹</h2><p>é¿å…å†…å­˜æ³„æ¼</p>
<ul>
<li>Android å¼€å‘ä¸­ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œå¦‚æœè·å–å•ä¾‹å¯¹è±¡éœ€è¦ä½¿ç”¨ Contextï¼Œé‚£ä¹ˆå°½é‡ä½¿ç”¨ ApplicationContext(åªè¦ç”¨ <code>context.getApplicationContext()</code> å³å¯è·å–)ã€‚<br>å› ä¸ºå¦‚æœä½¿ç”¨å…¶ä»– Contextï¼ˆå¦‚ Activity)  å¯èƒ½ä¼šé€ æˆ Activiity ç”Ÿå‘½å‘¨æœŸ æ‰§è¡Œå®Œæˆä¹‹åï¼Œå› ä¸ºå…¶å¼•ç”¨è¢«å•ä¾‹æ‰€æŒæœ‰ï¼Œè€Œæ— æ³•è¢«å›æ”¶ã€‚</li>
<li>å¤šè¿›ç¨‹ç¯å¢ƒä¸‹ï¼Œå•ä¾‹æ¨¡å¼ä¼šå¤±æ•ˆã€‚</li>
</ul>
<h2 id="Android-æºç ä¸­çš„å•ä¾‹æ¨¡å¼ç®€è¿°"><a href="#Android-æºç ä¸­çš„å•ä¾‹æ¨¡å¼ç®€è¿°" class="headerlink" title="Android æºç ä¸­çš„å•ä¾‹æ¨¡å¼ç®€è¿°"></a>Android æºç ä¸­çš„å•ä¾‹æ¨¡å¼ç®€è¿°</h2><p>æˆ‘ä»¬ç»å¸¸ä¼šé€šè¿‡ Context å»è·å–ç³»ç»ŸæœåŠ¡ï¼Œå¦‚ LayoutInflaterã€NetworkStatsManagerï¼Œè¿™äº›æœåŠ¡åœ¨åˆ›å»ºæ—¶ä¼šä»¥é”®å€¼å¯¹çš„å½¢å¼ç¼“å­˜åˆ° HashMap ä¸­ï¼Œä¾¿äºç®¡ç†ã€‚</p>
<p>éœ€è¦æ—¶å°±é€šè¿‡è°ƒç”¨  <code>context.getSystemService(String name)</code> æ–¹æ³•è·å– ã€‚é¦–å…ˆä¼šä»¥ name ä½œä¸º keyï¼Œåˆ° hashMap ä¸­æŸ¥æ‰¾ä¸­ç›¸åº”çš„æœåŠ¡ï¼Œå¦‚æœå¯¹åº”çš„æœåŠ¡ä¸º null å°±åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œå¹¶å°†è¯¥å®ä¾‹ç¼“å­˜åˆ° HashMap ä¸­ï¼›å¦‚æœå¯¹åº”çš„æœåŠ¡å·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="https://zh.wikipedia.org/wiki/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener">wiki å•ä¾‹æ¨¡å¼</a></li>
<li><a href="">Android æºç è®¾è®¡æ¨¡å¼ å•ä¾‹æ¨¡å¼</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> è®¾è®¡æ¨¡å¼ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[IPC æœºåˆ¶]]></title>
      <url>https://timlin-pro.github.io/blog/2017/05/04/Android%20IPC-%E6%9C%BA%E5%88%B6/</url>
      <content type="html"><![CDATA[<h2 id="Android-IPCç®€ä»‹"><a href="#Android-IPCç®€ä»‹" class="headerlink" title="Android IPCç®€ä»‹"></a>Android IPCç®€ä»‹</h2><p>IPC æ˜¯ Inter-Process Communication çš„ç¼©å†™ï¼Œå«ä¹‰ä¸º è¿›ç¨‹é—´é€šä¿¡æˆ–è€…è·¨è¿›ç¨‹é€šä¿¡ï¼Œæ˜¯æŒ‡ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢çš„è¿‡ç¨‹ã€‚<br>a<br>IPC ä¸æ˜¯ Android æ‰€ç‹¬æœ‰çš„ï¼Œä»»ä½•ä¸€ä¸ªæ“ä½œç³»ç»Ÿéƒ½éœ€è¦æœ‰ç›¸åº”çš„ IPC æœºåˆ¶ã€‚</p>
<p>åœ¨ Android ä¸­æœ€æœ‰ç‰¹è‰²çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼å°±æ˜¯ Binder äº†ï¼Œ <strong>é€šè¿‡ Binder å¯ä»¥è½»æ¾å®ç°è¿›ç¨‹é—´é€šä¿¡</strong>ã€‚</p>
<p>é™¤äº† Binder ï¼ŒAndroid è¿˜æ”¯æŒ Socketï¼Œ é€šè¿‡ Socket ä¹Ÿå¯ä»¥å®ç°ä»»æ„<strong>ä¸¤ä¸ªç»ˆç«¯ä¹‹é—´</strong>çš„é€šä¿¡ï¼Œå½“ç„¶ä¸€ä¸ªè®¾å¤‡çš„ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„ä¹Ÿå¯ä»¥é€šè¿‡ Socket è¿›è¡Œé€šä¿¡ã€‚</p>
<p>å¤šè¿›ç¨‹çš„æƒ…å†µåˆ†ä¸¤ç§ï¼š</p>
<ol>
<li>ä¸€ä¸ªåº”ç”¨å› ä¸ºæŸäº›åŸå› è‡ªèº«éœ€è¦é‡‡ç”¨å¤šè¿›ç¨‹æ¨¡å¼æ¥å®ç°<ul>
<li>å¯èƒ½çš„åŸå› å¦‚ä¸‹ï¼š<ul>
<li>æœ‰äº›æ¨¡å—éœ€è¦è¿è¡Œåœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­</li>
<li>åŠ å¤§ä¸€ä¸ªåº”ç”¨å¯ä½¿ç”¨çš„å†…å­˜</li>
</ul>
</li>
</ul>
</li>
<li>å½“å‰åº”ç”¨éœ€è¦å‘å…¶ä»–åº”ç”¨è·å–æ•°æ®ã€‚</li>
</ol>
<a id="more"></a>
<h2 id="2-Androidä¸­çš„å¤šè¿›ç¨‹æ¨¡å¼"><a href="#2-Androidä¸­çš„å¤šè¿›ç¨‹æ¨¡å¼" class="headerlink" title="2 Androidä¸­çš„å¤šè¿›ç¨‹æ¨¡å¼"></a>2 Androidä¸­çš„å¤šè¿›ç¨‹æ¨¡å¼</h2><p>é€šè¿‡ç»™å››å¤§ç»„ä»¶æŒ‡å®š <code>android:process</code>å±æ€§ï¼Œå¯ä»¥è½»æ˜“åœ°å¼€å¯å¤šçº¿ç¨‹æ¨¡å¼ã€‚</p>
<h3 id="1-å¼€å¯å¤šè¿›ç¨‹æ¨¡å¼"><a href="#1-å¼€å¯å¤šè¿›ç¨‹æ¨¡å¼" class="headerlink" title="1 å¼€å¯å¤šè¿›ç¨‹æ¨¡å¼"></a>1 å¼€å¯å¤šè¿›ç¨‹æ¨¡å¼</h3><p>ä¸€èˆ¬åœ°ï¼Œåœ¨ Android ä¸­<strong>å¤šè¿›ç¨‹</strong>æ˜¯æŒ‡ä¸€ä¸ªåº”ç”¨ä¸­å­˜åœ¨å¤šä¸ªè¿›ç¨‹çš„æƒ…å†µï¼ˆæ­¤å¤„ä¸è®¨è®ºä¸¤ä¸ªåº”ç”¨ä¹‹é—´çš„å¤šè¿›ç¨‹æƒ…å†µï¼‰</p>
<p>é¦–å…ˆï¼Œåœ¨ Android ä¸­ä½¿ç”¨å¤šè¿›ç¨‹åªæœ‰ä¸€ç§æ–¹æ³•ï¼Œ åœ¨ manifest æ–‡ä»¶ä¸­ï¼Œç»™å››å¤§ç»„ä»¶ æŒ‡å®š <code>android:process</code> å±æ€§ã€‚</p>
<ul>
<li>å…¶å®è¿˜æœ‰ä¸€ç§éå¸¸è§„çš„å¤šè¿›ç¨‹æ–¹æ³•â€”â€” é€šè¿‡ JNI åœ¨ native å±‚å» fork ä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚</li>
</ul>
<p>æ ¹æ® process çš„å±æ€§å€¼ä¸åŒï¼Œåˆ›å»ºä¸åŒçš„è¿›ç¨‹ã€‚</p>
<h4 id="é—®é¢˜ï¼šä½¿ç”¨-ã€Œï¼šxxxã€ä¸-ä½¿ç”¨-ã€Œxxx-xxx-xxxã€ä¸¤ç§æ–¹å¼æœ‰åŒºåˆ«å—ï¼Ÿ"><a href="#é—®é¢˜ï¼šä½¿ç”¨-ã€Œï¼šxxxã€ä¸-ä½¿ç”¨-ã€Œxxx-xxx-xxxã€ä¸¤ç§æ–¹å¼æœ‰åŒºåˆ«å—ï¼Ÿ" class="headerlink" title="é—®é¢˜ï¼šä½¿ç”¨ ã€Œï¼šxxxã€ä¸ ä½¿ç”¨ ã€Œxxx.xxx.xxxã€ä¸¤ç§æ–¹å¼æœ‰åŒºåˆ«å—ï¼Ÿ"></a>é—®é¢˜ï¼šä½¿ç”¨ ã€Œï¼šxxxã€ä¸ ä½¿ç”¨ ã€Œxxx.xxx.xxxã€ä¸¤ç§æ–¹å¼æœ‰åŒºåˆ«å—ï¼Ÿ</h4><ol>
<li>ã€Œï¼šã€çš„å«ä¹‰æ˜¯æŒ‡åœ¨å½“å‰çš„è¿›ç¨‹åå‰é¢é™„ä¸Šå½“å‰çš„åŒ…åï¼Œå³ è¿™æ˜¯ä¸€ç§ç®€å†™çš„æ–¹æ³•</li>
<li>è¿›ç¨‹åä»¥ã€Œï¼šã€å¼€å¤´çš„è¿›ç¨‹å±äº<strong>å½“å‰åº”ç”¨çš„ç§æœ‰è¿›ç¨‹</strong>ï¼Œå…¶ä»–åº”ç”¨çš„ç»„ä»¶ä¸å¯ä»¥å’Œå®ƒè·‘åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œ<ul>
<li>è€Œè¿›ç¨‹åä¸ä»¥ã€Œï¼šã€å¼€å¤´çš„è¿›ç¨‹å±äº<strong>å…¨å±€è¿›ç¨‹</strong>ï¼Œå…¶ä»–åº”ç”¨é€šè¿‡ ShareUID æ–¹å¼å¯ä»¥å’Œå®ƒè·‘åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ã€‚</li>
</ul>
</li>
</ol>
<p>Android ç³»ç»Ÿä¼šä¸ºæ¯ä¸ªåº”ç”¨åˆ†é…ä¸€ä¸ª å”¯ä¸€çš„ UIDï¼Œå…·æœ‰ç›¸åŒ UID çš„åº”ç”¨æ‰èƒ½å…±äº«æ•°æ®ã€‚</p>
<ul>
<li>ä¸¤ä¸ªåº”ç”¨è·‘åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ éœ€è¦ <ul>
<li>è¿™ä¸¤ä¸ªåº”ç”¨æœ‰ <strong>ç›¸åŒçš„ shareUID</strong></li>
<li>å¹¶ä¸” <strong>ç­¾åç›¸åŒ</strong>ã€‚</li>
</ul>
</li>
<li>è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥äº’ç›¸è®¿é—®å¯¹æ–¹çš„ç§æœ‰ç›®å½•ï¼Œå¦‚ data ç›®å½•ã€‚</li>
</ul>
<h3 id="2-å¤šè¿›ç¨‹æ¨¡å¼çš„è¿è¡Œæœºåˆ¶"><a href="#2-å¤šè¿›ç¨‹æ¨¡å¼çš„è¿è¡Œæœºåˆ¶" class="headerlink" title="2 å¤šè¿›ç¨‹æ¨¡å¼çš„è¿è¡Œæœºåˆ¶"></a>2 å¤šè¿›ç¨‹æ¨¡å¼çš„è¿è¡Œæœºåˆ¶</h3><p>==ä¸€ä¸ªè¿›ç¨‹ = ä¸€ä¸ª è™šæ‹Ÿæœº==</p>
<p>Android ä¸ºæ¯ä¸ªåº”ç”¨åˆ†é…äº†ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºï¼Œæˆ–è€…è¯´ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºï¼Œ<br>ä¸åŒè™šæ‹Ÿæœºåœ¨å†…å­˜åˆ†é…ä¸Šæœ‰ä¸åŒçš„åœ°å€ç©ºé—´ï¼Œè¿™å°±å¯¼è‡´äº†ä¸åŒè™šæ‹ŸæœºèŒƒæ–‡åŒä¸€ä¸ªç±»çš„å¯¹è±¡ä¼šäº§ç”Ÿå¤šä»½å‰¯æœ¬ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨<strong>å¤šè¿›ç¨‹</strong>ä¼šé€ æˆä»¥ä¸‹å‡ æ–¹é¢é—®é¢˜</p>
<ol>
<li>é™æ€æˆå‘˜å’Œå•ä¾‹æ¨¡å¼å®Œå…¨å¤±æ•ˆ</li>
<li>çº¿ç¨‹åŒæ­¥æœºåˆ¶å®Œå…¨å¤±æ•ˆ</li>
<li>SharePreferences çš„å¯é æ€§ä¸‹é™ï¼Œå¥½åƒæœ‰å¤šè¿›ç¨‹æ¨¡å¼ï¼Ÿæœ‰ï¼Œä½†æ˜¯ä¸ç¨³å®šï¼Œæ‰€ä»¥ç³»ç»Ÿå·²ç»ä¸æ¨èä½¿ç”¨äº†ã€‚</li>
<li>Application ä¼šå¤šæ¬¡åˆ›å»º</li>
</ol>
<p>å¯ä»¥è¿™æ ·ç†è§£åŒä¸€ä¸ªåº”ç”¨é—´çš„å¤šè¿›ç¨‹ï¼š</p>
<ul>
<li>å®ƒå°±ç›¸å½“äºä¸¤ä¸ªä¸åŒçš„åº”ç”¨é‡‡ç”¨äº† ShareUID çš„æ¨¡å¼ï¼Œè¿™æ ·èƒ½å¤Ÿæ›´åŠ ç›´æ¥åœ°ç†è§£<strong>å¤šè¿›ç¨‹æ¨¡å¼çš„æœ¬è´¨</strong>ã€‚</li>
</ul>
<h2 id="3-IPCåŸºç¡€æ¦‚å¿µä»‹ç»"><a href="#3-IPCåŸºç¡€æ¦‚å¿µä»‹ç»" class="headerlink" title="3 IPCåŸºç¡€æ¦‚å¿µä»‹ç»"></a>3 IPCåŸºç¡€æ¦‚å¿µä»‹ç»</h2><h3 id="3-1-Serializableæ¥å£"><a href="#3-1-Serializableæ¥å£" class="headerlink" title="3.1 Serializableæ¥å£"></a>3.1 Serializableæ¥å£</h3><p><strong>Serializableæ¥å£</strong> ï¼šJava æ‰€æä¾›çš„ä¸€ä¸ªåºåˆ—åŒ–æ¥å£ï¼Œå®ƒæ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œä¸ºå¯¹è±¡æä¾›æ ‡å‡†çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œã€‚</p>
<h4 id="ä½¿ç”¨ï¼š"><a href="#ä½¿ç”¨ï¼š" class="headerlink" title="ä½¿ç”¨ï¼š"></a>ä½¿ç”¨ï¼š</h4><pre><code>- åªè¦åœ¨ç±»çš„å£°æ˜ä¸­æŒ‡æ˜ä¸€ä¸ªç±»ä¼¼ä¸‹é¢çš„æ ‡è¯†å³å¯è‡ªåŠ¨å®ç° *é»˜è®¤çš„* åºåˆ—åŒ–è¿‡ç¨‹ï¼ˆå¯ä»¥è‡ªå®šä¹‰ï¼‰ã€‚
- `private static final long serialVersionUID = 87138828109787189L;`
</code></pre><p>è¿™ä¸ª <code>serialVersionUID</code> å¯ä»¥æ²¡æœ‰ï¼Œä½†æ˜¯è¿™æ ·ä¼šå¯¹ååºåˆ—åŒ–è¿‡ç¨‹äº§ç”Ÿå½±å“ã€‚</p>
<ul>
<li><code>serialVersionUID</code> æ˜¯ç”¨æ¥è¾…åŠ©åºåˆ—åŒ–è¿‡ç¨‹çš„ï¼ŒåŸåˆ™ä¸Šåºåˆ—åŒ–åçš„æ•°æ®ä¸­çš„ <code>serialVersionUID</code> åªæœ‰å’Œå½“å‰ç±»çš„ <code>serialVersionUID</code> ç›¸åŒæ‰èƒ½æ­£å¸¸åœ°è¢«ååºåˆ—åŒ–ã€‚</li>
</ul>
<h5 id="serialVersionUID-çš„è¯¦ç»†å·¥ä½œæœºåˆ¶ï¼š"><a href="#serialVersionUID-çš„è¯¦ç»†å·¥ä½œæœºåˆ¶ï¼š" class="headerlink" title="serialVersionUID çš„è¯¦ç»†å·¥ä½œæœºåˆ¶ï¼š"></a><strong><code>serialVersionUID</code> çš„è¯¦ç»†å·¥ä½œæœºåˆ¶</strong>ï¼š</h5><ul>
<li>åºåˆ—åŒ–æ˜¯æŠŠå½“å‰ç±»çš„ <code>serialVersionUID</code> å†™å…¥åºåˆ—åŒ–çš„æ–‡ä»¶ä¸­ï¼ˆä¹Ÿå¯èƒ½æ˜¯å…¶ä»–ä¸­ä»‹ï¼‰å½“ååºåˆ—åŒ–æ—¶ä¼šå»æ£€æµ‹æ–‡ä»¶ä¸­çš„<code>serialVersionUID</code>ï¼Œçœ‹å®ƒæ˜¯å¦å’Œå½“å‰ç±»çš„<code>serialVersionUID</code>ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´å°±è¯´æ˜åºåˆ—åŒ–çš„ç‰ˆæœ¬ä¸å½“å‰ç±»çš„ç‰ˆæœ¬æ˜¯ç›¸åŒçš„ï¼Œè¿™æ—¶å¯ä»¥æˆåŠŸååºåˆ—åŒ–ã€‚</li>
<li>å¦åˆ™è¯´æ˜å½“å‰ç±»å’Œåºåˆ—åŒ–çš„ç±»ç›¸æ¯”å‘ç”Ÿäº† æŸäº›å˜åŒ–ï¼Œä¾‹å¦‚ï¼šæˆå‘˜å˜é‡çš„æ•°é‡ã€ç±»å‹å¯èƒ½å‘ç”Ÿäº†æ”¹å˜ï¼Œè¿™æ—¶æ— æ³•æ­£å¸¸åºåˆ—åŒ–ï¼Œä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Exception in thread &quot;main&quot; java.io.InvalidClassException: projectname.clasname; local class incompatible: stream classdesc serialVersionUID = -6009442170907349114, local class serialVersionUID = 6529685098267757690</div></pre></td></tr></table></figure>
</li>
</ul>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬åº”è¯¥æ‰‹åŠ¨æŒ‡å®š <code>serialVersionUID</code> çš„å€¼ï¼Œæ¯”å¦‚ 1Lï¼Œ<br>ä¹Ÿå¯ä»¥è®© Eclipse <strong>æ ¹æ®å½“å‰ç±»çš„çš„ç»“æ„</strong>å»è‡ªåŠ¨ç”Ÿæˆå®ƒçš„ hash å€¼ï¼Œè¿™æ ·åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ä¸¤è€…çš„ <code>serialVersionUID</code>æ˜¯ç›¸åŒçš„ï¼Œå¯ä»¥æ­£å¸¸è¿›è¡Œååºåˆ—åŒ–ã€‚</p>
<p>å¦‚æœç±»çš„ç»“æ„å‘ç”Ÿäº†æ”¹å˜ï¼Œæ¯”å¦‚å¢åŠ /åˆ é™¤äº† æŸäº›æˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¼šé‡æ–°è®¡ç®—å½“å‰ç±»çš„ hash å€¼å¹¶æŠŠå®ƒèµ‹å€¼ç»™ <code>serialVersionUID</code> ï¼Œè¿™ä¸ªæ—¶å€™å½“å‰ç±»çš„ <code>serialVersionUID</code> å°±ä¼šå’Œåºåˆ—åŒ–æ•°æ®ä¸ä¸€è‡´ï¼Œäºæ˜¯ååºåˆ—åŒ–å¤±è´¥ã€‚</p>
<ul>
<li>å¦‚æœæ‰‹åŠ¨æŒ‡å®šäº†<code>serialVersionUID</code> å°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ã€‚</li>
</ul>
<p>ä½†æ˜¯å¦‚æœç±»ç»“æ„å‘ç”Ÿäº† ==éå¸¸è§„æ€§æ”¹å˜==ï¼Œæ¯”å¦‚ä¿®æ”¹äº†ç±»åã€ä¿®æ”¹äº†æˆå‘˜å˜é‡ç±»å‹ï¼Œè¿™ä¸ªæ—¶å€™å°½ç®¡ <code>serialVersionUID</code> éªŒè¯é€šè¿‡äº†ï¼Œä½†æ˜¯ååºåˆ—åŒ–è¿‡ç¨‹è¿˜æ˜¯ä¼šå¤±è´¥ï¼Œå› ä¸ºç±»ç»“æ„å‘ç”Ÿäº†æ¯ç­æ€§å˜åŒ–ï¼Œæ ¹æœ¬æ— æ³•ä»è€ç‰ˆæœ¬çš„æ•°æ®ä¸­è¿˜åŸå‡ºä¸€ä¸ªæ–°çš„ç±»ç»“æ„çš„å¯¹è±¡ã€‚</p>
<p>ç»¼ä¸Šï¼Œç±»ç»“æ„ä¸å˜ä¸”ç±»çš„ç‰ˆæœ¬ä¸å˜ï¼ˆæ²¡æœ‰å¢åŠ æˆ–è€…åˆ é™¤æˆå‘˜å˜é‡ï¼‰çš„æƒ…å†µä¸‹ï¼Œä¸æŒ‡å®š serialVersionUID æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ä¸ºäº†æé«˜ç¨³å®šæ€§ï¼Œè¿˜æ˜¯è¦æŒ‡å®šã€‚</p>
<p><strong>ä¸¤ç‚¹è¦æ³¨æ„çš„</strong>ï¼š</p>
<ol>
<li>é™æ€æˆå‘˜å˜é‡å±äºç±»ä¸å±äºå¯¹è±¡ï¼Œæ‰€ä»¥<strong>ä¸ä¼šå‚ä¸</strong>åºåˆ—åŒ–è¿‡ç¨‹ã€‚</li>
<li>ç”¨ transient å…³é”®å­—æ ‡è®°çš„ æˆå‘˜å˜é‡ä¸å‚ä¸åºåˆ—åŒ–è¿‡ç¨‹ã€‚</li>
</ol>
<p>ç³»ç»Ÿçš„é»˜è®¤åºåˆ—åŒ–è¿‡ç¨‹ä¹Ÿæ˜¯å¯ä»¥æ”¹å˜çš„ã€‚åªè¦é‡æ–°å®ç° <code>writeObject</code> å’Œ <code>readObject</code> æ–¹æ³•å³å¯ã€‚</p>
<h5 id="å¦‚ä½•è¿›è¡Œå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Ÿ"><a href="#å¦‚ä½•è¿›è¡Œå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Ÿ" class="headerlink" title="å¦‚ä½•è¿›è¡Œå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Ÿ"></a>å¦‚ä½•è¿›è¡Œå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Ÿ</h5><p>é‡‡ç”¨ <code>ObjectOutputStream</code>  <code>ObjectInputStream</code> å³å¯è½»æ¾å®ç°ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">User user = new User(name);</div><div class="line">ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;cache.txt&quot;));</div><div class="line">objectOutputStream.writeObject(user);</div><div class="line">objectOutputStream.close();</div><div class="line"></div><div class="line">ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(&quot;cache.txt&quot;));</div><div class="line">User newUser = objectInputStream.readObject();</div><div class="line">objectInputStream.close();</div></pre></td></tr></table></figure></p>
<h3 id="3-2-Parcelableæ¥å£"><a href="#3-2-Parcelableæ¥å£" class="headerlink" title="3.2 Parcelableæ¥å£"></a>3.2 Parcelableæ¥å£</h3><p>é€šè¿‡å®ç°Parcelableæ¥å£åºåˆ—åŒ–å¯¹è±¡çš„æ­¥éª¤ï¼š<br>1ã€å£°æ˜å®ç°æ¥å£Parcelable<br>2ã€å®ç°Parcelableçš„æ–¹æ³• <strong>writeToParcel</strong>ï¼Œå°†ä½ çš„å¯¹è±¡<strong>åºåˆ—åŒ–</strong>ä¸ºä¸€ä¸ªParcelå¯¹è±¡<br>3ã€å®ä¾‹åŒ–é™æ€å†…éƒ¨å¯¹è±¡CREATORå®ç°æ¥å£Parcelable.Creator  ï¼Œå®ç° ååºåˆ—åŒ–</p>
<p>Parcelable çš„æ–¹æ³•è¯´æ˜</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>åŠŸèƒ½</th>
<th>æ ‡è®°ä½</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>createFromParcel</td>
<td>ä»åºåˆ—åŒ–åçš„å¯¹è±¡ä¸­åˆ›å»ºåŸå§‹å¯¹è±¡</td>
<td></td>
<td></td>
</tr>
<tr>
<td>newArray</td>
<td>åˆ›å»ºæŒ‡å®šé•¿åº¦çš„åŸå§‹å¯¹è±¡æ•°ç»„</td>
<td></td>
<td></td>
</tr>
<tr>
<td>User(Parcel in)</td>
<td>ä»åºåˆ—åŒ–åçš„å¯¹è±¡ä¸­åˆ›å»ºåŸå§‹å¯¹è±¡</td>
<td></td>
<td></td>
</tr>
<tr>
<td>writeToParcel(Parcel dest, int flags)</td>
<td>å°†å½“å‰çš„å¯¹è±¡å†™å…¥åºåˆ—åŒ–ç»“æ„ä¸­ï¼Œå…¶ä¸­ flags æ ‡è¯†æœ‰ä¸¤ç§å€¼ï¼Œ0 æˆ–è€… 1ï¼› ä¸º 1 æ—¶æ ‡è¯†å½“å‰å¯¹è±¡éœ€è¦ä½œä¸ºè¿”å›å€¼è¿”å›ï¼Œä¸èƒ½ç«‹å³é‡Šæ”¾èµ„æºï¼Œå‡ ä¹æ‰€æœ‰æƒ…å†µéƒ½ä¸º 0</td>
<td>PARCELABLE_WRITE_RETURN_VALUE</td>
<td></td>
</tr>
<tr>
<td>describeContents</td>
<td>è¿”å›å½“å‰å¯¹è±¡çš„æè¿°ï¼Œä»…å½“å½“å‰å¯¹è±¡ä¸­å­˜åœ¨ æ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰è¿”å› 1ï¼Œå‡ ä¹æ‰€æœ‰æƒ…å†µéƒ½è¿”å› 0</td>
<td>CONTENT_FILE_DESCRIPTOR</td>
</tr>
</tbody>
</table>
<p>æ–°å»ºä¸€ä¸ªç±»ï¼Œå®ç° Parcelable æ¥å£ï¼Œç„¶åå†™å¥½æˆå‘˜å˜é‡ï¼Œå† <code>alt + enter</code> è‡ªåŠ¨è¡¥å…¨ä»£ç ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String mName;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mAge;</div><div class="line">    <span class="keyword">private</span> String mAddress;</div><div class="line">    <span class="keyword">private</span> Book mBook;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">User</span><span class="params">(Parcel in)</span> </span>&#123;<span class="comment">//ä»åºåˆ—åŒ–åçš„å¯¹è±¡ä¸­åˆ›å»ºåŸå§‹å¯¹è±¡</span></div><div class="line">        mName = in.readString();</div><div class="line">        mAge = in.readInt();</div><div class="line">        mAddress = in.readString();</div><div class="line">        mBook = in.readParcelable(Book.class.getClassLoader());<span class="comment">//å› ä¸º book ä¹Ÿæ˜¯ä¸€ä¸ªå¯åºåˆ—åŒ–å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒçš„ååºåˆ—åŒ–è¿‡ç¨‹éœ€è¦ä¼ é€’å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ ç±»åŠ è½½å™¨</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;<span class="comment">//å°†å½“å‰çš„å¯¹è±¡å†™å…¥åºåˆ—åŒ–ç»“æ„ä¸­ï¼Œå…¶ä¸­ flags æ ‡è¯†æœ‰ä¸¤ç§å€¼ï¼Œ0 æˆ–è€… 1ï¼› ä¸º 1 æ—¶æ ‡è¯†å½“å‰å¯¹è±¡éœ€è¦ä½œä¸ºè¿”å›å€¼è¿”å›ï¼Œä¸èƒ½ç«‹å³é‡Šæ”¾èµ„æºï¼Œå‡ ä¹æ‰€æœ‰æƒ…å†µéƒ½ä¸º 0</span></div><div class="line">        dest.writeString(mName);</div><div class="line">        dest.writeInt(mAge);</div><div class="line">        dest.writeString(mAddress);</div><div class="line">        dest.writeParcelable(mBook, flags); </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;<span class="comment">//å¦‚æ— ç‰¹æ®Šæƒ…å†µï¼Œè¿™ä¸ªæ–¹æ³•éƒ½æ˜¯è¿”å› 0ï¼Œä»…å½“å½“å‰å¯¹è±¡ä¸­å­˜åœ¨ æ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰è¿”å› 1</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//ååºåˆ—åŒ–</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Creator&lt;User&gt; CREATOR = <span class="keyword">new</span> Creator&lt;User&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123; </div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> User(in);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> User[] newArray(<span class="keyword">int</span> size) &#123;<span class="comment">//åˆ›å»ºæŒ‡å®šé•¿åº¦çš„åŸå§‹å¯¹è±¡æ•°ç»„</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> User[size];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h4><ul>
<li>Serializable æ˜¯ Java ä¸­çš„åºåˆ—åŒ–æ¥å£ï¼Œä½¿ç”¨èµ·æ¥ç®€å•ä½†æ˜¯==å¼€é”€å¾ˆå¤§==ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–éœ€è¦å¤§é‡çš„ I/O æ“ä½œã€‚</li>
<li>è€Œ Parcelable æ˜¯ Android ä¸­åºåˆ—åŒ–æ–¹å¼ï¼Œæ›´é€‚åˆä½¿ç”¨åœ¨ Android å¹³å°ä¸Šï¼Œ==æ•ˆç‡é«˜==ã€‚ ç¼ºç‚¹ï¼šä½¿ç”¨èµ·æ¥éº»çƒ¦ã€‚<ul>
<li>Parcelable ä¸»è¦ç”¨åœ¨<strong>å†…å­˜åºåˆ—åŒ–</strong>ä¸Š</li>
</ul>
</li>
<li>é€šè¿‡ Parcelable å°†å¯¹è±¡åºåˆ—åŒ–åˆ°<strong>å­˜å‚¨è®¾å¤‡</strong>ä¸­ æˆ–è€…å°†å¯¹è±¡åºåˆ—åŒ–åå­˜å‚¨<strong>é€šè¿‡ç½‘ç»œä¼ è¾“</strong>ä¹Ÿéƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¼šç¨æ˜¾å¤æ‚ï¼Œåœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œå»ºè®®ä½¿ç”¨ Serializable æ¥å£ã€‚</li>
</ul>
<h3 id="3-3-Binder"><a href="#3-3-Binder" class="headerlink" title="3.3 Binder"></a>3.3 Binder</h3><p>ç›´è§‚æ¥è¯´ï¼ŒBinder æ˜¯ Android çš„ä¸€ä¸ªç±»ï¼Œå®ƒå®ç°äº† IBinder æ¥å£ã€‚</p>
<ul>
<li>ä» IPC è§’åº¦æ¥è¯´ï¼Œ Binder æ˜¯ Android ä¸­çš„<strong>ä¸€ç§è·¨è¿›ç¨‹é€šä¿¡æ–¹å¼</strong></li>
<li>Binder è¿˜å¯ä»¥ç†è§£ä¸ºä¸€ç§<strong>è™šæ‹Ÿçš„ç‰©ç†è®¾å¤‡</strong>ï¼Œå®ƒçš„è®¾å¤‡é©±åŠ¨æ˜¯ /dev/binderï¼Œ è¯¥é€šä¿¡æ–¹å¼åœ¨ Linux ä¸Šæ²¡æœ‰ã€‚</li>
<li>ä» Android FrameWork è§’åº¦æ¥çœ‹ï¼Œ Binder æ˜¯ ServiceManager è¿æ¥å„ç§ Manager (ActivityManagerã€ WindowManagerï¼Œ ç­‰ç­‰)å’Œç›¸åº”çš„ ManagerService çš„<strong>æ¡¥æ¢</strong></li>
<li>ä» Android åº”ç”¨å±‚ æ¥è¯´ï¼ŒBinder æ˜¯<strong>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿›è¡Œé€šä¿¡çš„åª’ä»‹</strong>ï¼Œå½“ bindService çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å›ä¸€ä¸ªåŒ…å«äº†æœåŠ¡ç«¯ä¸šåŠ¡è°ƒç”¨çš„ Binder å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ª Binder å¯¹è±¡ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è·å–æœåŠ¡ç«¯æä¾›çš„æ•°æ®æˆ–æœåŠ¡ï¼ˆåŒ…æ‹¬æ™®é€šçš„æœåŠ¡ å’Œ AIDLæœåŠ¡ï¼‰</li>
</ul>
<p>Android å¼€å‘ä¸­ï¼ŒBinder ä¸»è¦ç”¨åœ¨ Service ä¸­ï¼ŒåŒ…æ‹¬ AIDL å’Œ Messengerï¼Œ</p>
<ul>
<li>æ™®é€š Service ä¸­çš„ Binder ä¸æ¶‰åŠè¿›ç¨‹é—´é€šä¿¡ï¼Œæ‰€ä»¥è¾ƒä¸ºç®€å•ï¼Œæ— æ³•æ¶‰åŠæ ¸å¿ƒ</li>
<li>Messenger çš„åº•å±‚å…¶å®æ˜¯ AIDL</li>
</ul>
<p>ç¤ºä¾‹ä¸­ï¼Œç¼–å†™ä»£ç æ—¶ï¼ŒæŸ¥æ‰¾ aidl ç”Ÿæˆçš„æ¥å£ï¼ŒProject ==ã€‹app==ã€‹build ==ã€‹source==ã€‹debug==ã€‹com.xxx.xx.xx==ã€‹ ç›®æ ‡ç±»</p>
<ul>
<li>==æ³¨æ„==ï¼šAIDL çš„ç‰¹æ®Šä¹‹å¤„ï¼šå°½ç®¡ä¸¤ä¸ªç±»éƒ½ä½äºåŒä¸€ä¸ªåŒ…ä¸­ï¼Œè¿˜æ˜¯éœ€è¦å¯¼å…¥ç›¸åº”çš„ç±»ã€‚</li>
</ul>
<p>==æ‰€æœ‰==<strong>å¯ä»¥åœ¨ Binder ä¸­ä¼ è¾“çš„æ¥å£</strong>éƒ½éœ€è¦ç»§æ‰¿è‡ª IInterface æ¥å£ã€‚</p>
<p>æ —å­<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * This file is auto-generated.  DO NOT MODIFY.</div><div class="line"> * Original file: D:\\Android_RDC_project\\AndroidLearning\\app\\src\\main\\aidl\\com\\android\\rdc\\androidlearning\\IBookManager.aidl</div><div class="line"> */</div><div class="line"><span class="keyword">package</span> com.android.rdc.androidlearning;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Local-side IPC implementation stub class.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">android</span>.<span class="title">rdc</span>.<span class="title">androidlearning</span>.<span class="title">IBookManager</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">"com.android.rdc.androidlearning.IBookManager"</span>;<span class="comment">//Binder çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸€èˆ¬ç”¨å½“å‰ Binder çš„å…¨ç±»åè¡¨ç¤º</span></div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Construct the stub at attach it to the interface.</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * å°†ï¼ˆæœåŠ¡ç«¯çš„ Binder å¯¹è±¡ï¼‰è½¬æ¢ä¸ºï¼ˆå®¢æˆ·ç«¯æ‰€éœ€çš„ AIDL ç±»å‹çš„å¯¹è±¡ï¼‰</div><div class="line">         * è‹¥æœåŠ¡ç«¯ä¸ å®¢æˆ·ç«¯å¤„åœ¨åŒä¸€ä¸ªè¿›ç¨‹ï¼Œåˆ™è¿”å›æœåŠ¡ç«¯çš„ Stub å¯¹è±¡æœ¬èº«</div><div class="line">         *                      å¦åˆ™è¿”å›ç³»ç»Ÿå°è£…åçš„ Stub.Proxy</div><div class="line">         * Cast an IBinder object into an com.android.rdc.androidlearning.IBookManager interface,</div><div class="line">         * generating a proxy if needed.</div><div class="line">         */</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> com.android.rdc.androidlearning.<span class="function">IBookManager <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</div><div class="line">            <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> com.android.rdc.androidlearning.IBookManager))) &#123;</div><div class="line">                <span class="keyword">return</span> ((com.android.rdc.androidlearning.IBookManager) iin);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> com.android.rdc.androidlearning.IBookManager.Stub.Proxy(obj);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * è¿”å›å½“å‰çš„ Binder å¯¹è±¡</div><div class="line">         * */</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * è¿è¡Œåœ¨ã€æœåŠ¡ç«¯ã€çš„ Binder çº¿ç¨‹æ± ä¸­ï¼Œå®¢æˆ·ç«¯å‘èµ· ï¼Œå½“å®¢æˆ·ç«¯å‘èµ·è·¨è¿›ç¨‹è¯·æ±‚æ—¶ï¼Œè¿œç¨‹è¯·æ±‚ä¼šé€šè¿‡ç³»ç»Ÿåº•å±‚å°è£…åäº¤ç”±æ­¤æ–¹æ³•æ¥å¤„ç†</div><div class="line">         *  é€šè¿‡code å¯ä»¥ç¡®å®šè¯·æ±‚çš„ç›®æ ‡æ–¹æ³•</div><div class="line">         *  ï¼ˆå¦‚æœç›®æ ‡æ–¹æ³•æœ‰å‚æ•°çš„è¯ï¼‰ ä» data ä¸­å–å‡ºç›®æ ‡æ–¹æ³•æ‰€éœ€çš„å‚æ•°ï¼Œç„¶åæ‰§è¡Œ</div><div class="line">         *  å½“ç›®æ ‡æ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œï¼ˆå¦‚æœæœ‰è¿”å›å€¼çš„è¯ï¼‰å‘ reply ä¸­å†™å…¥è¿”å›å€¼</div><div class="line">         *  å¦‚æœ onTransact è¿”å› false ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯çš„è¯·æ±‚å¤±è´¥ã€‚å› æ­¤å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æ¥åšæƒé™éªŒè¯ã€‚</div><div class="line">         * */</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (code) &#123;</div><div class="line">                <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</div><div class="line">                    reply.writeString(DESCRIPTOR);</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">case</span> TRANSACTION_getBookList: &#123;</div><div class="line">                    data.enforceInterface(DESCRIPTOR);</div><div class="line">                    java.util.List&lt;com.android.rdc.androidlearning.Book&gt; _result = <span class="keyword">this</span>.getBookList();</div><div class="line">                    reply.writeNoException();</div><div class="line">                    reply.writeTypedList(_result);</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">case</span> TRANSACTION_addBook: &#123;</div><div class="line">                    data.enforceInterface(DESCRIPTOR);</div><div class="line">                    com.android.rdc.androidlearning.Book _arg0;</div><div class="line">                    <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</div><div class="line">                        _arg0 = com.android.rdc.androidlearning.Book.CREATOR.createFromParcel(data);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        _arg0 = <span class="keyword">null</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">this</span>.addBook(_arg0);</div><div class="line">                    reply.writeNoException();</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">android</span>.<span class="title">rdc</span>.<span class="title">androidlearning</span>.<span class="title">IBookManager</span> </span>&#123;</div><div class="line">            <span class="keyword">private</span> android.os.IBinder mRemote;</div><div class="line"></div><div class="line">            Proxy(android.os.IBinder remote) &#123;</div><div class="line">                mRemote = remote;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> mRemote;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> DESCRIPTOR;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">/**</span></div><div class="line">             * æ­¤æ–¹æ³•è¿è¡Œåœ¨ã€å®¢æˆ·ç«¯ã€</div><div class="line">             * */</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> java.util.List&lt;com.android.rdc.androidlearning.Book&gt; getBookList() <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</div><div class="line">                android.os.Parcel _reply = android.os.Parcel.obtain();</div><div class="line">                java.util.List&lt;com.android.rdc.androidlearning.Book&gt; _result;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</div><div class="line">                    mRemote.transact(Stub.TRANSACTION_getBookList, _data, _reply, <span class="number">0</span>);<span class="comment">//è°ƒç”¨ transact å‘èµ·è¿œç¨‹è¯·æ±‚ã€‚ç„¶åå½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œ</span></div><div class="line">                    _reply.readException();<span class="comment">// RPC è¿‡ç¨‹è¿”å›åï¼Œå½“å‰çº¿ç¨‹ç»§ç»­æ‰§è¡Œ</span></div><div class="line">                    _result = _reply.createTypedArrayList(com.android.rdc.androidlearning.Book.CREATOR);</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    _reply.recycle();</div><div class="line">                    _data.recycle();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> _result;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/**</span></div><div class="line">             * æ‰§è¡Œè¿‡ç¨‹ä¸ getBookList ä¸€æ ·ï¼Œ</div><div class="line">             * */</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(com.android.rdc.androidlearning.Book book)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</div><div class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</div><div class="line">                android.os.Parcel _reply = android.os.Parcel.obtain();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</div><div class="line">                    <span class="keyword">if</span> ((book != <span class="keyword">null</span>)) &#123;</div><div class="line">                        _data.writeInt(<span class="number">1</span>);</div><div class="line">                        book.writeToParcel(_data, <span class="number">0</span>);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        _data.writeInt(<span class="number">0</span>);</div><div class="line">                    &#125;</div><div class="line">                    mRemote.transact(Stub.TRANSACTION_addBook, _data, _reply, <span class="number">0</span>);</div><div class="line">                    _reply.readException();</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    _reply.recycle();</div><div class="line">                    _data.recycle();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getBookList = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</div><div class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_addBook = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> java.util.List&lt;com.android.rdc.androidlearning.Book&gt; getBookList() <span class="keyword">throws</span> android.os.RemoteException;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(com.android.rdc.androidlearning.Book book)</span> <span class="keyword">throws</span> android.os.RemoteException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="4-Androidä¸­çš„IPCæ–¹å¼"><a href="#4-Androidä¸­çš„IPCæ–¹å¼" class="headerlink" title="4 Androidä¸­çš„IPCæ–¹å¼"></a>4 Androidä¸­çš„IPCæ–¹å¼</h2><h3 id="4-1-ä½¿ç”¨Bundle"><a href="#4-1-ä½¿ç”¨Bundle" class="headerlink" title="4.1 ä½¿ç”¨Bundle"></a>4.1 ä½¿ç”¨Bundle</h3><p>å››å¤§ç»„ä»¶ä¸­çš„ä¸‰å¤§ç»„ä»¶ï¼ˆActivityã€Serviceã€Receiverï¼‰éƒ½æ˜¯<strong>æ”¯æŒåœ¨ Intent ä¸­ä¼ é€’ Bundle æ•°æ®</strong>çš„ï¼ŒBundle å®ç°äº† Parcelable æ¥å£ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ–¹ä¾¿åœ°åœ¨ä¸åŒçš„è¿›ç¨‹é—´ ä¼ è¾“ã€‚</p>
<p>å› æ­¤ï¼Œå½“æˆ‘ä»¬åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­å¯åŠ¨äº†å¦ä¸€ä¸ªè¿›ç¨‹çš„ Activityã€Serviceã€Receiverï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ Bundle ä¸­é™„åŠ æˆ‘ä»¬éœ€è¦ä¼ è¾“ç»™è¿œç¨‹è¿›ç¨‹çš„ä¿¡æ¯å¹¶é€šè¿‡ Intent ä¼ é€’å‡ºå»ã€‚</p>
<ul>
<li>å½“ç„¶æˆ‘ä»¬æ‰€ä¼ è¾“çš„æ•°æ®å¿…é¡»èƒ½å¤Ÿè¢«åºåˆ—åŒ–ï¼Œå¦‚ï¼š<ul>
<li>åŸºæœ¬æ•°æ®ç±»å‹</li>
<li>å®ç°äº† Parcelable æ¥å£çš„å¯¹è±¡ã€‚</li>
<li>å®ç°äº† Serialiable æ¥å£çš„å¯¹è±¡ã€‚</li>
<li>ä¸€äº› Android æ”¯æŒçš„ç‰¹æ®Šå¯¹è±¡ã€‚<ul>
<li>Charserquence</li>
<li>StringArrayList</li>
<li>IntegerArrayList</li>
<li>Size</li>
<li>â€¦</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ç‰¹æ®Šçš„ä½¿ç”¨åœºæ™¯ï¼š"><a href="#ç‰¹æ®Šçš„ä½¿ç”¨åœºæ™¯ï¼š" class="headerlink" title="ç‰¹æ®Šçš„ä½¿ç”¨åœºæ™¯ï¼š"></a>ç‰¹æ®Šçš„ä½¿ç”¨åœºæ™¯ï¼š</h4><p>è¿›ç¨‹ A è¦è¿›è¡Œè®¡ç®—ï¼Œå¹¶å°†è®¡ç®—ç»“æœå‘é€ç»™è¿›ç¨‹ Bï¼Œä½†æ˜¯è¯¥è®¡ç®—ç»“æœä¸æ”¯æŒæ”¾å…¥ Bundle ä¸­ã€‚</p>
<ul>
<li>è§£å†³ï¼šåœ¨ A ä¸­ï¼Œé€šè¿‡ Intent æ¥å¯åŠ¨çº¿ç¨‹ B çš„ä¸€ä¸ª Service ç»„ä»¶ï¼ˆæ¯”å¦‚ IntentServiceï¼‰ï¼Œè®© Service åœ¨åå°è®¡ç®—ï¼Œè®¡ç®—å®Œä»¥åå†å¯åŠ¨ B è¿›ç¨‹ä¸­æƒ³è¦å¯åŠ¨çš„ç›®æ ‡ç»„ä»¶ã€‚</li>
</ul>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šå°†åŸæœ¬éœ€è¦åœ¨ A è¿›ç¨‹çš„è®¡ç®—ä»»åŠ¡è½¬ç§»åˆ° B è¿›ç¨‹çš„æœåŠ¡ä¸­ï¼Œè¿™æ ·å°±é¿å…äº†è¿›ç¨‹é—´é€šä¿¡çš„é—®é¢˜ï¼Œè€Œä¸”ä»£ä»·ä¹Ÿä¸å¤§ã€‚</p>
<h3 id="4-2-ä½¿ç”¨æ–‡ä»¶å…±äº«"><a href="#4-2-ä½¿ç”¨æ–‡ä»¶å…±äº«" class="headerlink" title="4.2 ä½¿ç”¨æ–‡ä»¶å…±äº«"></a>4.2 ä½¿ç”¨æ–‡ä»¶å…±äº«</h3><p>ä¸¤ä¸ªè¿›ç¨‹é€šè¿‡è¯»/å†™åŒä¸€ä¸ªæ–‡ä»¶äº¤æ¢æ•°æ®ã€‚</p>
<ul>
<li>æ¯”å¦‚ï¼Œè¿›ç¨‹ A å†™å…¥ï¼Œè¿›ç¨‹ B è¯»å–ã€‚</li>
</ul>
<p>èƒŒæ™¯çŸ¥è¯†ï¼š</p>
<ul>
<li>Window ä¸Šï¼Œä¸€ä¸ªæ–‡ä»¶å¦‚æœè¢«åŠ äº†<strong>æ’æ–¥é”</strong>å°†ä¼šå¯¼è‡´å…¶ä»–çº¿ç¨‹æ— æ³•å¯¹å…¶è¿›è¡Œè®¿é—®ï¼ˆåŒ…æ‹¬è¯»å’Œå†™ï¼‰ã€‚</li>
<li>Android åŸºäº Linuxï¼Œå…¶è¯»/å†™æ–‡ä»¶å¯ä»¥æ— é™åˆ¶åœ°è¿›è¡Œï¼Œç”šè‡³ä¸¤ä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªæ–‡ä»¶å¹¶è¡Œå†™ä¹Ÿæ˜¯å…è®¸çš„ã€‚ï¼ˆå°½ç®¡è¿™å¯èƒ½ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼‰</li>
</ul>
<p>åº”ç”¨ï¼š</p>
<ul>
<li>åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„åŒæ—¶ï¼Œä»å¦ä¸€ä¸ªè¿›ç¨‹ä¸­æ¢å¤è¿™ä¸ªå¯¹è±¡ã€‚<ul>
<li>å¦ä¸€ä¸ªè¿›ç¨‹æˆåŠŸåœ°æ¢å¤ä¹‹å‰å­˜å‚¨çš„å¯¹è±¡çš„<strong>å†…å®¹</strong>ï¼Œä½†æ˜¯ä»–ä»¬<strong>æœ¬è´¨è¿˜æ˜¯ä¸¤ä¸ªå¯¹è±¡</strong>ã€‚</li>
</ul>
</li>
</ul>
<p>å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼š<br>å¹¶å‘è¯»/å†™ï¼Œè¯»å‡ºçš„å†…å®¹å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ã€‚</p>
<ul>
<li>è§£å†³ï¼š<ol>
<li>è®¾æ³•é¿å…</li>
<li>è€ƒè™‘ä½¿ç”¨çº¿ç¨‹åŒæ­¥æ¥é™åˆ¶ï¼Œå¤šä¸ªçº¿ç¨‹çš„å†™æ“ä½œã€‚ </li>
</ol>
</li>
</ul>
<p>æ–‡ä»¶å…±äº«é€‚åˆ<strong>å¯¹æ•°æ®åŒæ­¥è¦æ±‚ä¸é«˜</strong>çš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚</p>
<h4 id="Sharepreference"><a href="#Sharepreference" class="headerlink" title="Sharepreference"></a>Sharepreference</h4><p>SharePreference æ˜¯ä¸ªç‰¹ä¾‹ </p>
<p>åº•å±‚é€šè¿‡ xml æ–‡ä»¶çš„æ–¹å¼æ¥å­˜å‚¨é”®å€¼å¯¹ï¼Œï¼Œä¸€èˆ¬è€Œè¨€ï¼Œå®ƒä½äº <code>/data/data/å½“å‰åº”ç”¨çš„åŒ…å/share_prefs</code> ç›®å½•ä¸‹ï¼Œ</p>
<p>ç”±äºç³»ç»Ÿå¯¹ SharePreference çš„è¯»å†™æ“ä½œæœ‰ä¸€å®šçš„<strong>ç¼“å­˜ç­–ç•¥</strong>ï¼Œå³<strong>åœ¨å†…å­˜*æœ‰ä¸€ä»½ SharePreferce çš„ç¼“å­˜</strong>ã€‚<strong>åœ¨å¤šè¿›ç¨‹æ¨¡å¼ä¸‹</strong>ï¼Œç³»ç»Ÿå¯¹å®ƒçš„è¯»å†™æ“ä½œå°±å˜å¾—ä¸å¯é ã€‚é«˜å¹¶å‘çŠ¶æ€ä¸‹ï¼ŒSharePreference å¾ˆå¤§å‡ ç‡ä¼šä¸¢å¤±æ•°æ®ã€‚</p>
<ul>
<li>ä¸å»ºè®®åœ¨è¿›ç¨‹é—´é€šä¿¡ä½¿ç”¨ SharePreference</li>
</ul>
<h3 id="4-3-ä½¿ç”¨Messenger"><a href="#4-3-ä½¿ç”¨Messenger" class="headerlink" title="4.3 ä½¿ç”¨Messenger"></a>4.3 ä½¿ç”¨Messenger</h3><p>ã€ä¿¡ä½¿ã€<br>é€šè¿‡å®ƒå¯ä»¥åœ¨ä¸åŒè¿›ç¨‹ä¸­ä¼ é€’ Message å¯¹è±¡ï¼Œåœ¨ Message ä¸­æ”¾å…¥æˆ‘ä»¬éœ€è¦ä¼ é€’çš„æ•°æ®ï¼Œå°±å¯ä»¥å®ç°è¿›ç¨‹é—´çš„æ•°æ®ä¼ é€’äº†ã€‚</p>
<p>Messenger ä¸€æ¬¡å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œæ‰€ä»¥æœåŠ¡ç«¯ä¸ç”¨è€ƒè™‘çº¿ç¨‹åŒæ­¥çš„é—®é¢˜ï¼ˆå› ä¸ºä¸å­˜åœ¨å¹¶å‘æ‰§è¡Œçš„æƒ…å½¢ï¼‰ã€‚</p>
<h4 id="1-æœåŠ¡ç«¯è¿›ç¨‹"><a href="#1-æœåŠ¡ç«¯è¿›ç¨‹" class="headerlink" title="1. æœåŠ¡ç«¯è¿›ç¨‹"></a>1. æœåŠ¡ç«¯è¿›ç¨‹</h4><h4 id="å®¢æˆ·ç«¯è¿›ç¨‹"><a href="#å®¢æˆ·ç«¯è¿›ç¨‹" class="headerlink" title="å®¢æˆ·ç«¯è¿›ç¨‹"></a>å®¢æˆ·ç«¯è¿›ç¨‹</h4><p>åœ¨ Messager ä¸­è¿›è¡Œæ•°æ®ä¼ é€’å¿…é¡»å°†æ•°æ®æ”¾å…¥ Messenger ä¸­ï¼Œ</p>
<ul>
<li>Message ä¸­æ”¯æŒæ•°æ®ç±»å‹å°±æ˜¯ Messenger æ‰€æ”¯æŒçš„ä¼ è¾“ç±»å‹</li>
<li>Message ä¸­æ‰€èƒ½ä½¿ç”¨çš„è½½ä½“åªæœ‰ <ul>
<li>int what;</li>
<li>int ar1</li>
<li>int arg2</li>
<li>Messenger replyTo</li>
<li>Object obj<ul>
<li>2 ä¹‹å‰ obj å­—æ®µä¸æ”¯æŒè·¨è¿›ç¨‹ä¼ è¾“</li>
<li>2 ä¹‹å obj ä¹Ÿä»…<strong>ç³»ç»Ÿæä¾›çš„</strong>å®ç° Parcelable æ¥å£çš„çš„å¯¹è±¡<ul>
<li>å³ FrameWork class</li>
</ul>
</li>
</ul>
</li>
<li>Bundle <ul>
<li>è¿˜å¥½æˆ‘ä»¬æœ‰ Bundle ï¼Œæ”¯æŒæ¯”è¾ƒå¤šçš„æ•°æ®ç±»å‹</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å¦‚æœè¦è®©ã€æœåŠ¡ç«¯ã€èƒ½å¤Ÿå›å¤ä¿¡æ¯ã€‚</p>
<ul>
<li>é‚£ä¹ˆå½“å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œéœ€è¦æŠŠ æ¥æ”¶æœåŠ¡ç«¯å›å¤çš„ Messenger é€šè¿‡ Message çš„ replyTo å‚æ•°ä¼ é€’ç»™æœåŠ¡ç«¯ã€‚<h3 id="4-4-ä½¿ç”¨AIDL"><a href="#4-4-ä½¿ç”¨AIDL" class="headerlink" title="4.4 ä½¿ç”¨AIDL"></a>4.4 ä½¿ç”¨AIDL</h3></li>
</ul>
<p>Android æ¥å£å®šä¹‰è¯­è¨€(Android Interface  Definition Language)</p>
<p>Messenger åªèƒ½ä¼ é€’æ¶ˆæ¯ï¼Œä¸èƒ½è·¨è¿›ç¨‹è°ƒç”¨æ–¹æ³•ã€‚è€Œä¸”åªèƒ½ä¸²è¡Œå¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚ã€‚</p>
<ul>
<li>è™½ç„¶å®ƒåº•å±‚ä¹Ÿæ˜¯ä½¿ç”¨ AIDL å®ç°çš„ã€‚</li>
</ul>
<p>å¯ä»¥ä½¿ç”¨ AIDL æ¥å®ç°è·¨è¿›ç¨‹çš„æ–¹æ³•è°ƒç”¨ã€‚</p>
<p>aidl æ–‡ä»¶çš„ä½œç”¨æ˜¯ sdk æ ¹æ®å®ƒæ¥ç”Ÿæˆç›¸åº”çš„ java ä»£ç ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¼–è¯‘æ—¶æœ‰ç”¨ï¼Œåœ¨ç¼–è¯‘å®Œä¹‹åï¼Œå³ä½¿åˆ é™¤æ‰ aidl æ–‡ä»¶ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™æ ·çš„è¯å¦‚æœé‡æ–°ç¼–è¯‘å°±æ²¡æ³•ç”Ÿæˆ java ä»£ç äº†ã€‚</p>
<p>å°†ç¼–å†™çš„ <code>.aidl</code> æ–‡ä»¶ä¿å­˜åœ¨é¡¹ç›®çš„ <code>src/</code> ç›®å½•å†…ï¼Œå½“ä½ å¼€å‘åº”ç”¨æ—¶ï¼Œ<strong>SDK å·¥å…·</strong>ä¼šåœ¨é¡¹ç›®çš„ <code>gen/</code> ç›®å½•ä¸­ç”Ÿæˆ <code>IBinder</code> æ¥å£æ–‡ä»¶ã€‚ç”Ÿæˆçš„æ–‡ä»¶åä¸ <code>.aidl</code> æ–‡ä»¶åä¸€è‡´ï¼Œåªæ˜¯ä½¿ç”¨äº† <code>.java</code> æ‰©å±•åï¼ˆä¾‹å¦‚ï¼Œ<code>IRemoteService.aidl</code> ç”Ÿæˆçš„æ–‡ä»¶åæ˜¯ <code>IRemoteService.java</code>ï¼‰ã€‚</p>
<p>å¦‚æœ<strong>ä½¿ç”¨ Android Studio</strong>ï¼Œ<strong>å¢é‡ç¼–è¯‘å‡ ä¹ä¼šç«‹å³ç”Ÿæˆ Binder ç±»</strong>ã€‚ å¦‚æœä¸æ˜¯ä½¿ç”¨ Android Studioï¼Œåˆ™ Gradle å·¥å…·ä¼šåœ¨ä¸‹ä¸€æ¬¡å¼€å‘åº”ç”¨æ—¶ç”Ÿæˆ Binder ç±» </p>
<p>é€šå¸¸åº”è¯¥åœ¨ç¼–å†™å®Œ <code>.aidl</code> æ–‡ä»¶åç«‹å³ç”¨ <code>gradle assembleDebug</code> ï¼ˆæˆ– <code>gradle assembleRelease</code>ï¼‰ç¼–è¯‘é¡¹ç›®ï¼Œä»¥ä¾¿æ‚¨çš„ä»£ç èƒ½å¤Ÿé“¾æ¥åˆ°ç”Ÿæˆçš„ç±»ã€‚</p>
<h4 id="1-æœåŠ¡ç«¯"><a href="#1-æœåŠ¡ç«¯" class="headerlink" title="1. æœåŠ¡ç«¯"></a>1. æœåŠ¡ç«¯</h4><p>ç”¨ä¸€ä¸ª Service æ¥ç›‘å¬å®¢æˆ·çš„è¿æ¥è¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ª AIDL æ–‡ä»¶ï¼Œå°†æš´éœ²ç»™å®¢æˆ·ç«¯çš„æ¥å£åœ¨è¿™ä¸ª AIDL æ–‡ä»¶ä¸­å£°æ˜ï¼Œæœ€ååœ¨ Service å®ç°è¯¥æ¥å£ã€‚</p>
<h4 id="2-å®¢æˆ·ç«¯"><a href="#2-å®¢æˆ·ç«¯" class="headerlink" title="2. å®¢æˆ·ç«¯"></a>2. å®¢æˆ·ç«¯</h4><ul>
<li>ç»‘å®šæœåŠ¡ç«¯ Serviceï¼Œ</li>
<li>ç»‘å®šæˆåŠŸåå°†æœåŠ¡ç«¯è¿”å›çš„ IBinder è½¬åŒ–ä¸º AIDL æ¥å£æ‰€å±çš„ç±»å‹<ul>
<li>æ³¨æ„ä¸æ˜¯å¹³æ—¶é‚£æ ·å¼ºè½¬ï¼Œè€Œæ˜¯<ul>
<li><code>IBookManager.Stub.asInterface(iBinder);</code></li>
</ul>
</li>
</ul>
</li>
<li>æ¥ç€å°±å¯ä»¥ä½¿ç”¨ AIDL ä¸­çš„æ–¹æ³•äº†ã€‚</li>
</ul>
<p>AIDL æ”¯æŒçš„æ•°æ®ç±»å‹ï¼š</p>
<ul>
<li>åŸºæœ¬æ•°æ®ç±»å‹</li>
<li>CharSequence </li>
<li>List åªæ”¯æŒ ArrayList</li>
<li>Map åªæ”¯æŒ HashMap</li>
<li>Parcelable </li>
<li><p>AIDLï¼šAIDL æ¥å£æœ¬èº«ä¹Ÿå¯ä»¥åœ¨ AIDL æ–‡ä»¶ä¸­ä½¿ç”¨</p>
<ul>
<li>AIDL ä¸­æ— æ³•ä½¿ç”¨æ™®é€šçš„æ¥å£</li>
</ul>
</li>
<li><p>æ³¨æ„ï¼š</p>
<ul>
<li>è‡ªå®šä¹‰çš„ Parcelableå¯¹è±¡ä¸€å®šè¦æ˜¾å¼åœ° import è¿›æ¥ã€‚ï¼ˆä¸ç®¡å®ƒä»¬æ˜¯å¦ä¸å½“å‰çš„ AIDL æ–‡ä»¶ä½äºåŒä¸€ä¸ªåŒ…ä¸­ï¼‰</li>
<li>å¦‚æœ AIDL æ–‡ä»¶ä¸­ç”¨åˆ°äº†è‡ªå®šä¹‰çš„ Parcelable å¯¹è±¡ï¼Œå¿…é¡»ä½¿ç”¨æ–°å»ºä¸€ä¸ªå’Œå®ƒåŒåçš„ aidl æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­å£°æ˜å®ƒä¸º parcelable ç±»å‹<ul>
<li>å¦‚ Book.java<ul>
<li>Book.aidl<ul>
<li>è¦åœ¨å…¶ä¸­å£°æ˜ pacelable Book;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>åŸºæœ¬æ•°æ®ç±»å‹ä»¥å¤–çš„å‚æ•°éœ€è¦==æ ‡ä¸Šæ–¹å‘==</p>
<ul>
<li>in è¾“å…¥å‹å‚æ•°ï¼Œç±»ä¼¼äºæ™®é€šæ–¹æ³•çš„å‚æ•°</li>
<li>out è¾“å‡ºå‹å‚æ•°ï¼Œ ç±»ä¼¼äºè¿”å›å€¼</li>
<li>inout è¾“å…¥è¾“å…¥å‹å‚æ•°</li>
</ul>
<p>æ‰€ä»¥è¯´ï¼Œè¾“å…¥è¾“å‡ºæ˜¯é’ˆå¯¹è¿™ä¸ªæ–¹æ³•è€Œè¨€çš„ï¼Œè€Œä¸æ˜¯ C/S ç»“æ„ä¸­çš„è¾“å…¥/è¾“å‡ºã€‚</p>
<p>AIDL æ¥å£ä¸­åªæ”¯æŒæ–¹æ³•ï¼Œä¸æ”¯æŒå£°æ˜é™æ€å˜é‡ï¼ˆ==è·Ÿä¼ ç»Ÿçš„æ¥å£æœ‰åŒºåˆ«==ï¼‰</p>
<ul>
<li>AIDL åŒ…ç»“æ„åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¦ä¿æŒä¸€è‡´ï¼Œå¦åˆ™è¿è¡Œä¼šå‡ºé”™ã€‚<ul>
<li>å› ä¸ºå®¢æˆ·ç«¯éœ€è¦ååºåˆ—åŒ–æœåŠ¡ç«¯ä¸­å’Œ  aidl æ¥å£ç›¸å…³çš„ç±»ã€‚</li>
</ul>
</li>
</ul>
<p>AIDL æ¥å£ä¸­æ‰€æ”¯æŒçš„æ˜¯æŠ½è±¡çš„ List ï¼Œè€Œ List åªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œè™½ç„¶æœåŠ¡ç«¯ä½¿ç”¨ CopyOnWriteArrayList ,ä½†æ˜¯åœ¨ Binder ä¸­ä¼šæŒ‰ç…§ List çš„è§„èŒƒå»è®¿é—®æ•°æ®å¹¶æœ€ç»ˆå½¢æˆä¸€ä¸ª ArrayList ä¼ é€’ç»™å®¢æˆ·ç«¯ã€‚</p>
<ul>
<li>ConcurrentHashMap åŒç†</li>
</ul>
<p>åœ¨<strong>æœåŠ¡ç«¯è°ƒç”¨å®¢æˆ·ç«¯</strong>ï¼ˆæ³¨å†Œæ—¶çš„ä½¿ç”¨çš„æ¥å£ä¸­)çš„æ–¹æ³•ï¼Œåœ¨å®¢æˆ·ç«¯çš„ Binder çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚</p>
<p>å¯¹è±¡æ˜¯ä¸èƒ½ç›´æ¥è·¨è¿›ç¨‹ä¼ è¾“çš„ï¼Œ<strong>å¯¹è±¡çš„è·¨è¿›ç¨‹ä¼ è¾“æœ¬è´¨ä¸Šéƒ½æ˜¯ååºåˆ—åŒ–è¿‡ç¨‹</strong></p>
<p>RemoteCallBackList æ˜¯ç³»ç»Ÿä¸“é—¨ç”¨æ¥å‘åˆ é™¤è·¨è¿›ç¨‹çš„ listener çš„æ¥å£ã€‚</p>
<ul>
<li>å®ƒæ˜¯ä¸€ä¸ªæ³›å‹ï¼Œæ”¯æŒç®¡ç†ä»»æ„çš„ AIDL æ¥å£<ul>
<li><code>public class RemoteCallBackList&lt;E extends IInterface&gt;</code></li>
<li>å½“å®¢æˆ·ç«¯è¿›ç¨‹ç»ˆæ­¢ä¹‹åï¼Œ RemoteCallBackList èƒ½å¤Ÿè‡ªåŠ¨æº¢å‡ºå®¢æˆ·ç«¯æ‰€æ³¨å†Œçš„ listener</li>
<li>å…¶å†…éƒ¨æœ‰ä¸€ä¸ª <code>ArrayMap&lt;IBinder,CallBack&gt;</code>ç”¨æ¥ä¸“é—¨ä¿å­˜æ‰€æœ‰çš„ AIDL å›è°ƒ<ul>
<li>CallBack å°è£…äº†çœŸæ­£çš„è¿œç¨‹ listenerã€‚å½“å®¢æˆ·ç«¯æ³¨å†Œ listener çš„æ—¶å€™ï¼Œä¼šå°†å…¶ä¸­çš„ä¿¡æ¯å­˜å…¥ mCallBack ä¸­<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">IBinder key = listener.asBinder();</div><div class="line">callBack value = new Callback(listener,cookie);</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å¤šæ¬¡è·¨è¿›ç¨‹ä¼ è¾“å®¢æˆ·ç«¯çš„åŒä¸€ä¸ªå¯¹è±¡ä¼šåœ¨æœåŠ¡ç«¯ç”Ÿæˆä¸åŒçš„å¯¹è±¡ï¼Œä½†æ˜¯è¿™äº›æ–°ç”Ÿæˆçš„å¯¹è±¡æœ‰ä¸€ä¸ª å…±åŒç‚¹ï¼Œé‚£å°±æ˜¯==å®ƒä»¬åº•å±‚çš„ Binder å¯¹è±¡æ˜¯åŒä¸€ä¸ª==</p>
<p>==æ³¨æ„==:</p>
<ul>
<li>RemoteCallBackList ä½¿ç”¨æ–¹å¼æ¯”è¾ƒç‰¹åˆ«ã€‚å¹¶ä¸åƒ list é‚£æ ·<ul>
<li>beginBroadcast()</li>
<li>finishBroadcast()</li>
<li>è¿™ä¸¤ä¸ªæ–¹æ³•==ä¸€å®šè¦é…å¯¹ä½¿ç”¨==</li>
<li>getBroadcastItem()<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> N = mCallBackList.beginBroadcast();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">    IOnNewBookArrivedListener l = mCallBackList.getBroadcastItem(i);</div><div class="line">    <span class="keyword">if</span> (l != <span class="keyword">null</span>) &#123;</div><div class="line">        l.onNewBookArrived(book);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">mCallBackList.finishBroadcast();</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>å®¢æˆ·ç«¯çš„ <code>onServiceConnected å’Œ  onServiceDisconnected(ComponentName name)</code>éƒ½æ‰§è¡Œåœ¨ UI çº¿ç¨‹ä¸­ï¼Œä¸å¯ä»¥åœ¨é‡Œé¢è°ƒç”¨æœåŠ¡ç«¯è€—æ—¶çš„æ–¹æ³•ã€‚</p>
<p>æœåŠ¡ç«¯æ–¹æ³•æœ¬èº«è¿è¡Œåœ¨æœåŠ¡ç«¯çš„ Binder çº¿ç¨‹æ± ä¸­ï¼Œæ‰€ä»¥æœåŠ¡ç«¯æ–¹æ³•æœ¬èº«å³å¯æ‰§è¡Œå¤§é‡è€—æ—¶æ“ä½œã€‚</p>
<ul>
<li>ä¸è¦åœ¨æœåŠ¡ç«¯æ–¹æ³•ä¸­å¼€çº¿ç¨‹å»æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚</li>
</ul>
<p>æœåŠ¡ç«¯ä¹Ÿæœ‰å¯èƒ½è¿è¡Œåœ¨ UI çº¿ç¨‹ï¼Œè¿™æ—¶è¦å°½é‡é¿å…è°ƒç”¨è€—æ—¶æ–¹æ³•ã€‚</p>
<p>Binder æ­»äº¡å</p>
<p>è¿›ç¨‹ç©ºé—´åˆ†ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´</p>
<ul>
<li>ç”¨æˆ·ç©ºé—´ï¼Œæ•°æ®äº’ç›¸éš”ç¦»</li>
<li>å†…æ ¸ç©ºé—´ æ•°æ®å…±äº«</li>
</ul>
<p>é€šè¿‡å†…æ ¸ å®ç°è·¨è¿›ç¨‹è°ƒç”¨</p>
<p>è¿›ç¨‹ A è°ƒç”¨è¿›ç¨‹ B çš„å‡½æ•°</p>
<ul>
<li>çŸ¥é“è°ƒç”¨çš„æ˜¯å“ªä¸€ä¸ªå¯¹è±¡çš„å“ªä¸€ä¸ªæ–¹æ³•</li>
<li>ä¼ é€’æ–¹æ³•å‚æ•°</li>
<li>è¿›ç¨‹ B æ‰§è¡Œå®Œä¹‹åï¼Œè¿”å›ç›¸åº”çš„æ•°æ®ç»™è¿›ç¨‹ Aã€‚</li>
</ul>
<p>æœ¬è´¨ä¸Šå°±æ˜¯ æ•°æ®çš„ä¼ é€’ã€‚</p>
<p>å®¢æˆ·ç«¯è°ƒç”¨çš„è¿›ç¨‹ Binder å¯¹è±¡çš„å¼•ç”¨ï¼ˆä¸€ä¸ªä»£ç†ï¼‰ï¼Œå®é™…æ‰§è¡Œè¿˜æ˜¯åœ¨æœåŠ¡ç«¯çš„ã€‚</p>
<p>Client è¿›ç¨‹çš„çš„æ“ä½œå®é™…ä¸Šå¯¹ä»£ç†å¯¹è±¡çš„æ“ä½œï¼Œä»£ç†å¯¹è±¡åˆ©ç”¨ Binder é©±åŠ¨æ‰¾åˆ°çœŸæ­£çš„ Binderå¯¹è±¡ï¼Œå¹¶é€šçŸ¥ Server è¿›ç¨‹å®Œæˆæ“ä½œã€‚</p>
<p>é‡‡ç”¨çš„æ˜¯ C/S çš„æ¶æ„ã€‚</p>
<p><img src="http://upload-images.jianshu.io/upload_images/944365-62fdab905e7d2706.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="åŸç†å›¾"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/944365-2f530e964ffab8d7.png?imageMogr2/auto-orient/strip%7CimageView2/2" alt="æµç¨‹å›¾"></p>
<h3 id="4-5-ä½¿ç”¨ContentProvider"><a href="#4-5-ä½¿ç”¨ContentProvider" class="headerlink" title="4.5 ä½¿ç”¨ContentProvider"></a>4.5 ä½¿ç”¨ContentProvider</h3><p>å¾…è¡¥å……</p>
<h3 id="4-6-ä½¿ç”¨Socket"><a href="#4-6-ä½¿ç”¨Socket" class="headerlink" title="4.6 ä½¿ç”¨Socket"></a>4.6 ä½¿ç”¨Socket</h3><p>å¾…è¡¥å……</p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li>ã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹</li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®æ¬¢è¿åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè¯·å¯¹é—®é¢˜æè¿°å°½é‡è¯¦ç»†ï¼Œä»¥å¸®åŠ©æˆ‘å¯ä»¥å¿«é€Ÿæ‰¾åˆ°é—®é¢˜æ ¹æºã€‚è°¢è°¢ï¼</p>
<p>## </p>
]]></content>
      
        <categories>
            
            <category> Android è¿›é˜¶ </category>
            
            <category> IPC </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android è¿›é˜¶ </tag>
            
            <tag> IPC </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Service å…¨é¢æ€»ç»“]]></title>
      <url>https://timlin-pro.github.io/blog/2017/05/03/Service-%E5%85%A8%E9%9D%A2%E6%80%BB%E7%BB%93/</url>
      <content type="html"><![CDATA[<p><br>Service æ˜¯ä¸€ç§è®¡ç®—å‹çš„ç»„ä»¶ã€‚</p>
<h2 id="ä¸€ã€ä½¿ç”¨åœºæ™¯"><a href="#ä¸€ã€ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä¸€ã€ä½¿ç”¨åœºæ™¯"></a>ä¸€ã€ä½¿ç”¨åœºæ™¯</h2><h3 id="çº¿ç¨‹è¿˜æ˜¯æœåŠ¡ï¼Ÿ"><a href="#çº¿ç¨‹è¿˜æ˜¯æœåŠ¡ï¼Ÿ" class="headerlink" title="çº¿ç¨‹è¿˜æ˜¯æœåŠ¡ï¼Ÿ"></a>çº¿ç¨‹è¿˜æ˜¯æœåŠ¡ï¼Ÿ</h3><p>ç®€å•åœ°è¯´ï¼ŒæœåŠ¡æ˜¯ä¸€ç§<strong>ä¸éœ€è¦ç”¨æˆ·äº¤äº’ä¹Ÿå¯åœ¨åå°è¿è¡Œçš„ç»„ä»¶</strong>ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥ä»…åœ¨å¿…è¦æ—¶æ‰åˆ›å»ºæœåŠ¡ã€‚</p>
<p>å¦‚éœ€åœ¨ä¸»çº¿ç¨‹å¤–éƒ¨ï¼ˆä¹Ÿå°±æ˜¯å·¥ä½œçº¿ç¨‹ï¼‰æ‰§è¡Œå·¥ä½œï¼Œå¹¶ä¸”<strong>åªæ˜¯åœ¨ç”¨æˆ·æ­£åœ¨ä¸åº”ç”¨äº¤äº’æ—¶æ‰æœ‰æ­¤éœ€è¦ï¼Œåˆ™åº”åˆ›å»ºæ–°çº¿ç¨‹è€ŒéæœåŠ¡</strong>ã€‚</p>
<p>å¦‚æœç¡®å®è¦ä½¿ç”¨æœåŠ¡ï¼Œåˆ™<strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»ä¼šåœ¨åº”ç”¨çš„ä¸»çº¿ç¨‹ä¸­è¿è¡Œ</strong>ï¼Œå› æ­¤ï¼Œå¦‚æœæœåŠ¡æ‰§è¡Œçš„æ˜¯å¯†é›†å‹æˆ–é˜»å¡æ€§æ“ä½œï¼Œé‚£ä¹ˆåº”è¯¥åœ¨æœåŠ¡å†…åˆ›å»ºæ–°çº¿ç¨‹ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡ä¸æœåŠ¡å£°æ˜æ‰€åœ¨çš„åº”ç”¨è¿è¡ŒäºåŒä¸€è¿›ç¨‹ï¼Œè€Œä¸”è¿è¡Œäºè¯¥åº”ç”¨çš„ä¸»çº¿ç¨‹ä¸­ã€‚<br>ä¸ºäº†é¿å…å½±å“åº”ç”¨æ€§èƒ½ï¼Œæ‚¨åº”åœ¨æœåŠ¡å†…å¯åŠ¨æ–°çº¿ç¨‹ã€‚</p>
</blockquote>
<a id="more"></a>
<p>å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼šåœ¨åº”ç”¨ä¸ç®¡æ˜¯å¦ç”¨æœåŠ¡ï¼Œè€—æ—¶çš„æ“ä½œéƒ½æ˜¯éœ€è¦å¦å¤–èµ·ä¸€ä¸ªçº¿ç¨‹çš„ã€‚</p>
<ol>
<li>ä»æ¦‚å¿µä¸Šçœ‹ï¼ŒæœåŠ¡æ˜¯ä¸€ä¸ª<strong>ç»„ä»¶</strong>ï¼Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿçš„æœ€å°æ‰§è¡Œå•ä½ã€‚</li>
<li>ç›´æ¥èµ· Thread çš„<strong>å¯æ§æ€§</strong>æ²¡é‚£ä¹ˆé«˜ï¼Œå®ƒæ‰€ä¾é™„çš„ Activity finish æ‰ä¹‹åï¼Œå¦‚æœä½ æ²¡æœ‰ä¸»åŠ¨åœæ­¢ Thread æˆ–è€… Thread é‡Œçš„ run æ–¹æ³•æ²¡æœ‰æ‰§è¡Œå®Œæ¯•çš„è¯ï¼ŒThread ä¹Ÿä¼šä¸€ç›´æ‰§è¡Œã€‚ä½ æ²¡æœ‰åŠæ³•åœ¨ä¸åŒçš„ Activity ä¸­å¯¹åŒä¸€ Thread è¿›è¡Œæ§åˆ¶ã€‚</li>
<li>å¯ä»¥<strong>æé«˜è¿›ç¨‹çš„ä¼˜å…ˆçº§</strong>ï¼Œä½¿å¾—<strong>è¿›ç¨‹</strong>æ²¡é‚£ä¹ˆå®¹æ˜“è¢« killã€‚å¦‚æœæ˜¯ä¸€ä¸ªé•¿æœŸçš„ä»»åŠ¡ï¼ˆæ¯”å¦‚è¯´é•¿è½®è¯¢ï¼‰ï¼Œé‚£ä¹ˆç”¨ Service å»åšæ¯”è¾ƒåˆé€‚ã€‚<ul>
<li>é€šè¿‡åœ¨ manifest é‡Œå£°æ˜ Serviceï¼ŒæŠŠéœ€è¦åå°ç›¸å¯¹é•¿æœŸè¿è¡Œçš„é€»è¾‘æ”¾åœ¨ Service é‡Œï¼Œä½ ä¾¿è·å¾—äº†è¿™æ ·çš„ä¿éšœï¼šåªè¦ç³»ç»Ÿå†…å­˜ä¸æ˜¯æç«¯ä¸å¤Ÿç”¨ï¼Œä½ çš„ Service ä¸€å®šä¸ä¼šè¢« kill æ‰ã€‚å¯¹ç³»ç»Ÿè€Œè¨€ï¼Œå½“çœ‹åˆ°ä¸€ä¸ªè¿›ç¨‹é‡Œæœ‰ Service åœ¨è¿è¡Œï¼Œè¿™ä¸ªè¿›ç¨‹å°±å…·æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼Œä¼šåœ¨å†…å­˜ä¸è¶³è¢«æ€çš„è¡Œåˆ—é‡Œæ’å¾—æ¯”è¾ƒé åã€‚</li>
</ul>
</li>
<li>ä»äº¤äº’çš„è§’åº¦çœ‹ï¼Œå¦‚æœæ˜¯<strong>ä¸éœ€è¦ç”¨æˆ·äº¤äº’ä¹Ÿå¯ä»¥åœ¨åå°è¿è¡Œ</strong>ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨æœåŠ¡ã€‚å¦‚æœæ˜¯åœ¨ç”¨æˆ·ä¸åº”ç”¨äº¤äº’æ—¶ï¼ˆæ¯”å¦‚è¯´ï¼šåœ¨è®¾ç½®é¡µé¢ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒæ­¥åˆ°æœåŠ¡å™¨ä¸Šé¢å»ï¼‰é‚£ä¹ˆå¯ä»¥ç”¨çº¿ç¨‹ã€‚å¦‚æœç¡®å®šè¦ç”¨ Threadï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>AsyncTask</code> æˆ– <code>HandlerThread</code>ï¼Œè€Œéä¼ ç»Ÿçš„ <code>Thread</code> ç±»ã€‚</li>
</ol>
<p>æ‰€ä»¥ç›´æ¥ç”¨çº¿ç¨‹è¿˜æ˜¯èµ·ä¸€ä¸ªæœåŠ¡å…³é”®å¾—çœ‹ä»»åŠ¡çš„ç±»å‹ã€‚æ˜¯å¦æ˜¯é•¿æœŸè€—æ—¶çš„ä»»åŠ¡ï¼Œæ˜¯å¦éœ€è¦è·Ÿç”¨æˆ·äº¤äº’ï¼Ÿ</p>
<h2 id="äºŒã€3-ç§å¯åŠ¨æ–¹å¼"><a href="#äºŒã€3-ç§å¯åŠ¨æ–¹å¼" class="headerlink" title="äºŒã€3 ç§å¯åŠ¨æ–¹å¼"></a>äºŒã€3 ç§å¯åŠ¨æ–¹å¼</h2><h3 id="æ–¹å¼ä¸€ã€start-Service"><a href="#æ–¹å¼ä¸€ã€start-Service" class="headerlink" title="æ–¹å¼ä¸€ã€start Service"></a>æ–¹å¼ä¸€ã€start Service</h3><ul>
<li>è°ƒç”¨è€…<strong>åªæ˜¯è´Ÿè´£å¯åŠ¨å®ƒå’Œåœæ­¢å®ƒ</strong>ï¼Œæˆ–è€…åœ¨å¯åŠ¨å®ƒçš„æ—¶å€™é€šè¿‡ Intent ä¼ é€’ä¸€ç‚¹æ•°æ®ç»™å®ƒï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä¸¤è€…æ²¡æœ‰æ•°æ®äº¤æ¢ã€<strong>æ²¡æœ‰å…¶ä»–çš„åŠŸèƒ½è°ƒç”¨</strong>ï¼Œè¿™ä¸¤ä¸ªç»„ä»¶ä¹‹é—´åŸºæœ¬ä¸Šäº’ä¸å½±å“ã€‚<ul>
<li>å¦‚æœå¸Œæœ›æœåŠ¡è¿”å›ç»“æœï¼Œåˆ™å¯åŠ¨æœåŠ¡çš„å®¢æˆ·ç«¯å¯ä»¥<strong>ä¸ºå¹¿æ’­åˆ›å»ºä¸€ä¸ª PendingIntent</strong> ï¼ˆä½¿ç”¨ getBroadcast()ï¼‰ï¼Œå¹¶==é€šè¿‡å¯åŠ¨æœåŠ¡çš„ Intent ä¼ é€’ç»™æœåŠ¡==ã€‚ç„¶åï¼ŒæœåŠ¡å°±å¯ä»¥ä½¿ç”¨å¹¿æ’­ä¼ é€’ç»“æœã€‚å¯ä»¥è·å–åˆ° pendingIntentï¼Œç„¶åå‘¢ï¼Ÿ<ul>
<li>æœåŠ¡å†…éƒ¨ä¹Ÿå¯ä»¥ç›´æ¥æ„é€  PendingIntent å•Šã€‚<ul>
<li>å¦‚æœæ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„ä¼ é€’çš„ï¼Œé‚£ä¹ˆæœ‰å¤šä¸ªå®¢æˆ·ç«¯ï¼Œå¯ä»¥æ ¹æ®ä¼ é€’çš„ intent åˆ†åˆ«å¤„ç†ï¼Ÿ</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>å¦‚æœå› ä¸ºç³»ç»Ÿå†…å­˜ä¸è¶³è¢« killï¼Œä¹‹åçš„å…·ä½“è¡Œä¸ºä¸ onStartCommand æ–¹æ³•çš„è¿”å›å€¼ç›¸åŒ¹é…ã€‚</li>
</ul>
<h4 id="ç”Ÿå‘½å‘¨æœŸï¼š"><a href="#ç”Ÿå‘½å‘¨æœŸï¼š" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸï¼š"></a>ç”Ÿå‘½å‘¨æœŸï¼š</h4><p>å¤šä¸ªæœåŠ¡å¯åŠ¨è¯·æ±‚ä¼šå¯¼è‡´å¤šæ¬¡å¯¹æœåŠ¡çš„ onStartCommand() è¿›è¡Œç›¸åº”çš„è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œ<strong>è¦åœæ­¢æœåŠ¡ï¼Œåªéœ€ä¸€ä¸ªæœåŠ¡åœæ­¢è¯·æ±‚ï¼ˆä½¿ç”¨ stopSelf() æˆ– stopService()ï¼‰å³å¯</strong>ã€‚</p>
<h3 id="æ–¹å¼äºŒã€bind-Service"><a href="#æ–¹å¼äºŒã€bind-Service" class="headerlink" title="æ–¹å¼äºŒã€bind Service"></a>æ–¹å¼äºŒã€bind Service</h3><ul>
<li>å…¶ä»–ç»„ä»¶é€šè¿‡è°ƒç”¨ bindService() ç»‘å®š Serviceï¼Œè®©å®ƒè¿è¡Œèµ·æ¥ï¼›å†é€šè¿‡è°ƒç”¨ unbindService()è§£é™¤ç»‘å®šã€‚</li>
<li>ç»„ä»¶å’Œ Service ä¹‹é—´çš„è°ƒç”¨æ˜¯é€šè¿‡ Binder æ¥è¿›è¡Œçš„ã€‚æˆ‘ä»¬<strong>å¯ä»¥æŠŠ Binder çœ‹ä½œæ˜¯ä¸€ä¸ªè¿æ¥å…¶ä»–ç»„ä»¶å’Œ Service çš„æ¡¥æ¢</strong>ã€‚<ul>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…ï¼Œå¯ä»¥<strong>ç›´æ¥ç»§æ‰¿ Binder</strong>,ç„¶ååœ¨é‡Œé¢å®ç°æä¾›ç»™è°ƒç”¨è€…çš„åŠŸèƒ½ã€‚</li>
<li>å¦‚æœæ˜¯è·¨è¿›ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ aidlã€‚ å°†è¦æä¾›ç»™è°ƒç”¨æ–¹çš„åŠŸèƒ½æ¥å£å†™åœ¨ aidl æ–‡ä»¶ä¸­ã€‚build ä¹‹åï¼Œç»§æ‰¿ Stub ,å®ç°ç›¸åº”çš„åŠŸèƒ½ã€‚<ul>
<li>è°ƒç”¨æ–¹åœ¨ <code>onServiceConnected</code> æ–¹æ³•ä¸­ï¼Œè·å–åˆ°æœåŠ¡ç«¯æä¾›çš„ IBinder å¯¹è±¡å°±å¯ä»¥åƒè°ƒç”¨æ™®é€šå‡½æ•°ä¸€æ ·ï¼Œè°ƒç”¨ç›¸åº”çš„æ–¹æ³•äº†ã€‚<ul>
<li>å¦‚æœæ˜¯è¿œç¨‹è°ƒç”¨çš„è¯ï¼Œå°†å¯¹æ–¹æä¾›çš„ IBinder ç±» é€šè¿‡ asInterface æ–¹æ³•è¿›è¡Œè½¬æ¢ã€‚å¦‚æœæ˜¯åœ¨æœåŠ¡ç«¯ï¼Œè¿”å› binder å®ä½“ï¼Œå¦‚æœæ˜¯åœ¨å®¢æˆ·ç«¯ï¼Œè¿”å› binder Proxyã€‚</li>
</ul>
</li>
</ul>
</li>
<li>å¦‚æœéœ€è¦æä¾›æ¥å£ç»™è°ƒç”¨æ–¹ä½¿ç”¨ï¼Œå¯ä»¥é€šè¿‡ onBind æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªå¯ä¾›è°ƒç”¨è€…ä½¿ç”¨çš„ Binder å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>å¦‚æœç”¨æˆ·ä¸»åŠ¨è§£é™¤ç»‘å®šï¼ŒonServiceDisconnected()æ˜¯ä¸ä¼šè¢«è§¦å‘çš„</strong>ã€‚</p>
<p>å¦‚æœç»„ä»¶æ˜¯é€šè¿‡è°ƒç”¨ bindService() æ¥åˆ›å»ºæœåŠ¡ï¼ˆä¸”æœªè°ƒç”¨ onStartCommand()ï¼Œåˆ™æœåŠ¡åªä¼šåœ¨è¯¥ç»„ä»¶ä¸å…¶ç»‘å®šæ—¶è¿è¡Œã€‚<strong>ä¸€æ—¦è¯¥æœåŠ¡ä¸æ‰€æœ‰å®¢æˆ·ç«¯ä¹‹é—´çš„ç»‘å®šå…¨éƒ¨å–æ¶ˆï¼Œç³»ç»Ÿä¾¿ä¼šé”€æ¯</strong>ã€‚</p>
<p>å³ä½¿ä¸ºæœåŠ¡å¯ç”¨äº†ç»‘å®šï¼Œä¸€æ—¦æœåŠ¡æ”¶åˆ°å¯¹ onStartCommand() çš„è°ƒç”¨ï¼ˆä¹Ÿå°±æ˜¯åœ¨ bind ä¹‹ååˆä½¿ç”¨ start çš„æ–¹å¼å»å¯åŠ¨åº”ç”¨ï¼‰ï¼Œåˆ™å¿…é¡»æ‰‹åŠ¨åœæ­¢æœåŠ¡ã€‚ï¼ˆå†…éƒ¨è°ƒç”¨ stopSelf æˆ–è€… ç”±å¦ä¸€ä¸ªç»„ä»¶é€šè¿‡è°ƒç”¨<code>stopService()</code> æ¥åœæ­¢å®ƒï¼‰</p>
<p><strong>å¤šä¸ªå®¢æˆ·ç«¯å…ˆåè¿›è¡Œ bindService åªæœ‰ç¬¬ä¸€ä¸ªè°ƒç”¨ bindService æ—¶ä¼šè°ƒç”¨ Service#onBind æ–¹æ³•ï¼Œåç»­çš„éƒ½æ˜¯ç›´æ¥åœ¨ ServiceConnection ä¸­è¿”å›</strong>ã€‚</p>
<p><strong>ç»‘å®šæ˜¯å¼‚æ­¥çš„</strong>ã€‚bindService() ä¼šç«‹å³è¿”å›ï¼Œä½†æ˜¯ã€Œä¸ä¼šã€ä½¿ IBinder è¿”å›å®¢æˆ·ç«¯ã€‚è¦æ¥æ”¶ IBinderï¼Œå®¢æˆ·ç«¯å¿…é¡»åˆ›å»ºä¸€ä¸ª ServiceConnection å®ä¾‹ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ bindService()ã€‚ServiceConnection åŒ…æ‹¬ä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼Œç³»ç»Ÿé€šè¿‡è°ƒç”¨å®ƒæ¥ä¼ é€’ IBinderã€‚<br>IBinder è¿”å›æ˜¯å¼‚æ­¥çš„ã€‚</p>
<blockquote>
<p>æ³¨ï¼šåªæœ‰ Activityã€Service å’Œ ContentProvider å¯ä»¥ç»‘å®šåˆ°æœåŠ¡ â€” æ— æ³•ä»å¹¿æ’­æ¥æ”¶å™¨ç»‘å®šåˆ°æœåŠ¡ã€‚</p>
</blockquote>
<p>åˆ›å»ºæ”¯æŒ bindService çš„ Service çš„å…³é”®åœ¨äºï¼Œè‡ªå®šä¹‰ä¸€ä¸ªç›´æ¥/é—´æ¥å®ç°äº† IBinder æ¥å£çš„ç±»ï¼ˆç¼–å†™åŠŸèƒ½ä»£ç æä¾›ç›¸åº”çš„åŠŸèƒ½ï¼‰ç„¶åé€šè¿‡ onBind æ–¹æ³•æŠŠè¯¥ç±»çš„å®ä¾‹ä¼ é€’ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>æ³¨æ„ï¼šService.onBindå¦‚æœè¿”å›nullï¼Œåˆ™è°ƒç”¨ bindService <strong>ä¼šå¯åŠ¨ Serviceï¼Œä½†ä¸ä¼šè¿æ¥ä¸Š Service</strong>ï¼Œå› æ­¤ ServiceConnection.onServiceConnected ä¸ä¼šè¢«è°ƒç”¨ï¼Œä½†ä½ ä»»ç„¶éœ€è¦ä½¿ç”¨ unbindService å‡½æ•°æ–­å¼€å®ƒï¼Œè¿™æ · Service æ‰ä¼šåœæ­¢ã€‚</p>
<h4 id="åˆ›å»ºæä¾›ç»‘å®šçš„-Service"><a href="#åˆ›å»ºæä¾›ç»‘å®šçš„-Service" class="headerlink" title="åˆ›å»ºæä¾›ç»‘å®šçš„ Service"></a>åˆ›å»ºæä¾›ç»‘å®šçš„ Service</h4><p>åˆ›å»ºæä¾›ç»‘å®šçš„æœåŠ¡æ—¶ï¼Œæ‚¨<strong>å¿…é¡»æä¾› IBinder</strong>ï¼Œç”¨ä»¥<strong>æä¾›å®¢æˆ·ç«¯ç”¨æ¥ä¸æœåŠ¡è¿›è¡Œäº¤äº’çš„æ¥å£</strong>ã€‚ æ‚¨å¯ä»¥<strong>é€šè¿‡ä¸‰ç§æ–¹æ³•å®šä¹‰æ¥å£</strong>ï¼š</p>
<h5 id="1-ç›´æ¥ç»§æ‰¿-Binder-ç±»"><a href="#1-ç›´æ¥ç»§æ‰¿-Binder-ç±»" class="headerlink" title="1. ç›´æ¥ç»§æ‰¿ Binder ç±»"></a>1. ç›´æ¥ç»§æ‰¿ Binder ç±»</h5><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š<br>æœåŠ¡æ˜¯<strong>ä¾›å•ä¸ªåº”ç”¨ä¸“ç”¨ï¼Œå¹¶ä¸”åœ¨ä¸å®¢æˆ·ç«¯ç›¸åŒçš„è¿›ç¨‹ä¸­è¿è¡Œ</strong>ï¼ˆå¸¸è§æƒ…å†µï¼‰ï¼Œåˆ™åº”é€šè¿‡æ‰©å±• Binder ç±»å¹¶ä» onBind() è¿”å›å®ƒçš„ä¸€ä¸ªå®ä¾‹æ¥åˆ›å»ºæ¥å£ã€‚å®¢æˆ·ç«¯æ”¶åˆ° Binder åï¼Œå¯åˆ©ç”¨å®ƒ<strong>ç›´æ¥è®¿é—® Binder å®ç°ä¸­ä¹ƒè‡³ Service ä¸­å¯ç”¨çš„å…¬å…±æ–¹æ³•</strong>ã€‚</p>
<p>å¦‚æœæœåŠ¡åªæ˜¯ app çš„åå°å·¥ä½œçº¿ç¨‹ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨è¿™ç§æ–¹æ³•ã€‚ </p>
<h5 id="2-ä½¿ç”¨-Messenger"><a href="#2-ä½¿ç”¨-Messenger" class="headerlink" title="2. ä½¿ç”¨ Messenger"></a>2. ä½¿ç”¨ Messenger</h5><p>å¦‚éœ€<strong>è®©æ¥å£è·¨ä¸åŒçš„è¿›ç¨‹å·¥ä½œ</strong>ï¼Œåˆ™å¯ä½¿ç”¨ Messenger ä¸ºæœåŠ¡åˆ›å»ºæ¥å£ã€‚æœåŠ¡å¯ä»¥è¿™ç§æ–¹å¼å®šä¹‰å¯¹åº”äºä¸åŒç±»å‹ Message å¯¹è±¡çš„ Handlerã€‚æ­¤ Handler æ˜¯ Messenger çš„åŸºç¡€ï¼Œåè€…éšåå¯ä¸å®¢æˆ·ç«¯åˆ†äº«ä¸€ä¸ª IBinderï¼Œä»è€Œè®©å®¢æˆ·ç«¯èƒ½åˆ©ç”¨ Message å¯¹è±¡å‘æœåŠ¡å‘é€å‘½ä»¤ã€‚æ­¤å¤–ï¼Œå®¢æˆ·ç«¯è¿˜å¯å®šä¹‰è‡ªæœ‰ Messengerï¼Œä»¥ä¾¿æœåŠ¡å›ä¼ æ¶ˆæ¯ã€‚</p>
<p>è¿™æ˜¯æ‰§è¡Œè¿›ç¨‹é—´é€šä¿¡ (IPC) çš„æœ€ç®€å•æ–¹æ³•ï¼Œå› ä¸º Messenger ä¼šåœ¨<strong>å•ä¸€çº¿ç¨‹</strong>ä¸­åˆ›å»ºåŒ…å«æ‰€æœ‰è¯·æ±‚çš„é˜Ÿåˆ—ï¼Œè¿™æ„å‘³ç€å¼€å‘è€…æ— éœ€è¿›è¡Œçº¿ç¨‹å®‰å…¨æ§åˆ¶</p>
<h5 id="3-ä½¿ç”¨-AIDL"><a href="#3-ä½¿ç”¨-AIDL" class="headerlink" title="3.ä½¿ç”¨ AIDL"></a>3.ä½¿ç”¨ AIDL</h5><p>AIDLï¼ˆAndroid æ¥å£å®šä¹‰è¯­è¨€ï¼‰æ‰§è¡Œæ‰€æœ‰å°†å¯¹è±¡åˆ†è§£æˆåŸè¯­çš„å·¥ä½œï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥è¯†åˆ«è¿™äº›åŸè¯­å¹¶å°†å®ƒä»¬ç¼–ç»„åˆ°å„è¿›ç¨‹ä¸­ï¼Œä»¥æ‰§è¡Œ IPCã€‚ ä¹‹å‰é‡‡ç”¨ Messenger çš„æ–¹æ³•å®é™…ä¸Šæ˜¯ä»¥ AIDL ä½œä¸ºå…¶åº•å±‚ç»“æ„ã€‚ å¦‚ä¸Šæ‰€è¿°ï¼ŒMessenger ä¼šåœ¨å•ä¸€çº¿ç¨‹ä¸­åˆ›å»ºåŒ…å«æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚çš„é˜Ÿåˆ—ï¼Œä»¥ä¾¿æœåŠ¡ä¸€æ¬¡æ¥æ”¶ä¸€ä¸ªè¯·æ±‚ã€‚ ä¸è¿‡ï¼Œå¦‚æœæ‚¨æƒ³è®©æœåŠ¡åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œåˆ™å¯ç›´æ¥ä½¿ç”¨ AIDLã€‚ åœ¨æ­¤æƒ…å†µä¸‹ï¼Œæ‚¨çš„æœåŠ¡å¿…é¡»<strong>å…·å¤‡å¤šçº¿ç¨‹å¤„ç†èƒ½åŠ›</strong>ï¼Œå¹¶é‡‡ç”¨<strong>çº¿ç¨‹å®‰å…¨</strong>å¼è®¾è®¡ã€‚</p>
<p>å¦‚éœ€ç›´æ¥ä½¿ç”¨ AIDLï¼Œæ‚¨å¿…é¡»åˆ›å»ºä¸€ä¸ªå®šä¹‰ç¼–ç¨‹æ¥å£çš„ .aidl æ–‡ä»¶ã€‚Android SDK å·¥å…·åˆ©ç”¨è¯¥æ–‡ä»¶ç”Ÿæˆä¸€ä¸ªå®ç°æ¥å£å¹¶å¤„ç† IPC çš„æŠ½è±¡ç±»ï¼Œæ‚¨éšåå¯åœ¨æœåŠ¡å†…å¯¹å…¶è¿›è¡Œæ‰©å±•ã€‚</p>
<h3 id="æ–¹å¼ä¸‰ã€æ··åˆå‹ï¼ŒåŒæ—¶ä½¿ç”¨-start-å’Œ-bind"><a href="#æ–¹å¼ä¸‰ã€æ··åˆå‹ï¼ŒåŒæ—¶ä½¿ç”¨-start-å’Œ-bind" class="headerlink" title="æ–¹å¼ä¸‰ã€æ··åˆå‹ï¼ŒåŒæ—¶ä½¿ç”¨ start å’Œ bind"></a>æ–¹å¼ä¸‰ã€æ··åˆå‹ï¼ŒåŒæ—¶ä½¿ç”¨ start å’Œ bind</h3><p>Service å¹¶ä¸æ˜¯åªèƒ½ç»™ä¸€ä¸ªç»„ä»¶ä½¿ç”¨ï¼Œå®ƒ<strong>å¯ä»¥åŒæ—¶æœåŠ¡äºå¤šä¸ªç»„ä»¶</strong>ã€‚<br>æ‰€ä»¥ä¸€ä¸ª Service æ—¢å¯ä»¥æ˜¯ Start Serviceï¼Œä¹Ÿå¯ä»¥æ˜¯ Bind Serviceã€‚åªè¦æŠŠä¸¤è€…éœ€è¦å®ç°çš„åœ°æ–¹éƒ½å®ç°äº†å°±è¡Œã€‚ç»„ä»¶ A å¯ä»¥é€šè¿‡ startService()è¿è¡Œä¸€ä¸ª Serviceï¼Œç»„ä»¶ B å¯ä»¥é€šè¿‡ bindService()å†æ¬¡è¿è¡ŒåŒä¸€ä¸ª Serviceã€‚</p>
<h3 id="ç”Ÿå‘½å‘¨æœŸ"><a href="#ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h3><p>å¯ä»¥ç»‘å®šåˆ°å·²ç»ä½¿ç”¨ startService() å¯åŠ¨çš„æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ Intentï¼ˆæ ‡è¯†è¦æ’­æ”¾çš„éŸ³ä¹ï¼‰è°ƒç”¨ startService() æ¥å¯åŠ¨åå°éŸ³ä¹æœåŠ¡ã€‚éšåï¼Œå¯èƒ½åœ¨ç”¨æˆ·éœ€è¦ç¨åŠ æ§åˆ¶æ’­æ”¾å™¨æˆ–è·å–æœ‰å…³å½“å‰æ’­æ”¾æ­Œæ›²çš„ä¿¡æ¯æ—¶ï¼ŒActivity å¯ä»¥é€šè¿‡è°ƒç”¨ bindService() ç»‘å®šåˆ°æœåŠ¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé™¤éæ‰€æœ‰å®¢æˆ·ç«¯å‡å–æ¶ˆç»‘å®šï¼Œå¦åˆ™ stopService() æˆ– stopSelf() ä¸ä¼šå®é™…åœæ­¢æœåŠ¡ã€‚</p>
<ol>
<li>å…ˆ startService ç„¶å bindSerive</li>
<li>å…ˆ bindService ç„¶å startService </li>
</ol>
<p>åœ¨æ··åˆæ¨¡å¼ä¸‹ï¼Œåªæœ‰ç­‰åˆ°è°ƒç”¨äº† stopSelf æˆ– stopService ä»¥åŠ æ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½å–æ¶ˆç»‘å®šï¼ŒæœåŠ¡æ‰ä¼šåœæ­¢</p>
<p>å®˜æ–¹æµç¨‹å›¾<br><img src="https://user-images.githubusercontent.com/16668676/35767586-324e8d7a-092a-11e8-9e83-088d73808553.png" alt="image"></p>
<p>onRebindï¼ˆIntent intentï¼‰ æ–¹æ³•ä¸ Activity#onNewIntent æ–¹æ³•ç±»ä¼¼ã€‚<br>è¯¥æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨å–å†³äº onUnbind æ–¹æ³•æ˜¯å¦è¿”å› trueã€‚å½“æ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½è°ƒç”¨äº† unBindServiceï¼Œè€Œæ²¡æœ‰è°ƒç”¨ stopService çš„æ—¶å€™ï¼Œå¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚</p>
<ul>
<li>å¦‚æœæ˜¯ trueï¼Œå½“æœ‰æ–°çš„è°ƒç”¨è¿‡æ¥çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨ onReBind æ–¹æ³•ä¸­æ‹¿åˆ° intentã€‚</li>
<li>å¦‚æœä¸º falseï¼Œå½“æœ‰æ–°çš„è°ƒç”¨è¿‡æ¥çš„æ—¶å€™ï¼Œä¼šèµ° onBind<br>onRebind() è¿”å›ç©ºå€¼ï¼Œä½†å®¢æˆ·ç«¯ä»åœ¨å…¶ onServiceConnected() å›è°ƒä¸­æ¥æ”¶ IBinderã€‚</li>
</ul>
<p>å¦‚æœè¦åŒæ—¶æ”¯æŒ start å’Œ bindï¼Œéœ€è¦åŒæ—¶å®ç°ä¸¤å¥—æ–¹æ³•ã€‚</p>
<ul>
<li>onStartCommand</li>
<li>onBind </li>
</ul>
<p>è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å«æœ‰ä¸€ä¸ª Intent å‚æ•°</p>
<h3 id="é™„ï¼š"><a href="#é™„ï¼š" class="headerlink" title="é™„ï¼š"></a>é™„ï¼š</h3><ul>
<li>åº”è¯¥å§‹ç»ˆæ•è· DeadObjectException å¼‚å¸¸ï¼Œå®ƒä»¬æ˜¯åœ¨è¿æ¥ä¸­æ–­æ—¶å¼•å‘çš„ã€‚è¿™æ˜¯è¿œç¨‹æ–¹æ³•å¼•å‘çš„å”¯ä¸€å¼‚å¸¸ã€‚</li>
<li>å¯¹è±¡æ˜¯è·¨è¿›ç¨‹è®¡æ•°çš„å¼•ç”¨ã€‚</li>
<li>é€šå¸¸åº”è¯¥åœ¨å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸçš„åŒ¹é…å¼•å…¥ (bring-up) å’Œé€€å‡º (tear-down) æ—¶åˆ»æœŸé—´é…å¯¹ç»‘å®šå’Œå–æ¶ˆç»‘å®šã€‚ ä¾‹å¦‚ï¼š<br>å¦‚æœæ‚¨åªéœ€è¦åœ¨ Activity å¯è§æ—¶ä¸æœåŠ¡äº¤äº’ï¼Œåˆ™åº”åœ¨ onStart() æœŸé—´ç»‘å®šï¼Œåœ¨ onStop() æœŸé—´å–æ¶ˆç»‘å®šã€‚<br>å¦‚æœæ‚¨å¸Œæœ› Activity åœ¨åå°åœæ­¢è¿è¡ŒçŠ¶æ€ä¸‹ä»å¯æ¥æ”¶å“åº”ï¼Œåˆ™å¯åœ¨ onCreate() æœŸé—´ç»‘å®šï¼Œåœ¨ onDestroy() æœŸé—´å–æ¶ˆç»‘å®šã€‚è¯·æ³¨æ„ï¼Œè¿™æ„å‘³ç€æ‚¨çš„ Activity åœ¨å…¶æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­ï¼ˆç”šè‡³åŒ…æ‹¬åå°è¿è¡ŒæœŸé—´ï¼‰éƒ½éœ€è¦ä½¿ç”¨æœåŠ¡ï¼Œå› æ­¤å¦‚æœæœåŠ¡ä½äºå…¶ä»–è¿›ç¨‹å†…ï¼Œé‚£ä¹ˆå½“æ‚¨æé«˜è¯¥è¿›ç¨‹çš„æƒé‡æ—¶ï¼Œç³»ç»Ÿç»ˆæ­¢è¯¥è¿›ç¨‹çš„å¯èƒ½æ€§ä¼šå¢åŠ ã€‚</li>
</ul>
<blockquote>
<p>æ³¨ï¼šé€šå¸¸æƒ…å†µä¸‹ï¼Œåˆ‡å‹¿åœ¨ Activity çš„ onResume() å’Œ onPause() æœŸé—´ç»‘å®šå’Œå–æ¶ˆç»‘å®šï¼Œå› ä¸ºæ¯ä¸€æ¬¡ç”Ÿå‘½å‘¨æœŸè½¬æ¢éƒ½ä¼šå‘ç”Ÿè¿™äº›å›è°ƒï¼Œæ‚¨åº”è¯¥<strong>ä½¿å‘ç”Ÿåœ¨è¿™äº›è½¬æ¢æœŸé—´çš„å¤„ç†ä¿æŒåœ¨æœ€ä½æ°´å¹³</strong>ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨å†…çš„å¤šä¸ª Activity ç»‘å®šåˆ°åŒä¸€æœåŠ¡ï¼Œå¹¶ä¸”å…¶ä¸­ä¸¤ä¸ª Activity ä¹‹é—´å‘ç”Ÿäº†è½¬æ¢ï¼Œåˆ™å¦‚æœå½“å‰ Activity åœ¨ä¸‹ä¸€ä¸ª Activity ç»‘å®šï¼ˆæ¢å¤æœŸé—´ï¼‰ä¹‹å‰å–æ¶ˆç»‘å®šï¼ˆæš‚åœæœŸé—´ï¼‰ï¼Œç³»ç»Ÿå¯èƒ½ä¼šé”€æ¯æœåŠ¡å¹¶é‡å»ºæœåŠ¡ã€‚ ï¼ˆActivity æ–‡æ¡£ä¸­ä»‹ç»äº†è¿™ç§æœ‰å…³ Activity å¦‚ä½•åè°ƒå…¶ç”Ÿå‘½å‘¨æœŸçš„ Activity è½¬æ¢ã€‚ï¼‰</p>
</blockquote>
<h3 id="manifest-æ–‡ä»¶ä¸­å£°æ˜æœåŠ¡"><a href="#manifest-æ–‡ä»¶ä¸­å£°æ˜æœåŠ¡" class="headerlink" title="manifest æ–‡ä»¶ä¸­å£°æ˜æœåŠ¡"></a>manifest æ–‡ä»¶ä¸­å£°æ˜æœåŠ¡</h3><p>android:name å±æ€§æ˜¯å”¯ä¸€å¿…éœ€çš„å±æ€§ï¼Œç”¨äºæŒ‡å®šæœåŠ¡çš„ç±»åã€‚</p>
<h2 id="ä¸‰ã€åˆ›å»ºæœåŠ¡"><a href="#ä¸‰ã€åˆ›å»ºæœåŠ¡" class="headerlink" title="ä¸‰ã€åˆ›å»ºæœåŠ¡"></a>ä¸‰ã€åˆ›å»ºæœåŠ¡</h2><p>ä»ä¼ ç»Ÿä¸Šè®²ï¼Œæ‚¨å¯ä»¥æ‰©å±•ä¸¤ä¸ªç±»æ¥åˆ›å»ºå¯åŠ¨æœåŠ¡ï¼š</p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>æ‰€æœ‰æœåŠ¡çš„åŸºç±»ã€‚æ‰©å±•æ­¤ç±»æ—¶ï¼Œ<strong>å¿…é¡»åˆ›å»ºä¸€ä¸ªç”¨äºæ‰§è¡Œæ‰€æœ‰æœåŠ¡å·¥ä½œçš„æ–°çº¿ç¨‹</strong>ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡å°†ä½¿ç”¨åº”ç”¨çš„ä¸»çº¿ç¨‹ï¼Œè¿™ä¼šé™ä½åº”ç”¨æ­£åœ¨è¿è¡Œçš„æ‰€æœ‰ Activity çš„æ€§èƒ½ã€‚</p>
<h3 id="IntentService"><a href="#IntentService" class="headerlink" title="IntentService"></a>IntentService</h3><p>Service çš„å­ç±»ï¼Œå®ƒä½¿ç”¨<strong>å·¥ä½œçº¿ç¨‹é€ä¸€å¤„ç†</strong>ï¼ˆ<strong>ä¸²è¡Œ</strong>å¤„ç†ï¼‰æ‰€æœ‰å¯åŠ¨è¯·æ±‚ã€‚å¦‚æœæ‚¨ä¸è¦æ±‚æœåŠ¡åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œè¿™æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚ æ‚¨åªéœ€å®ç° onHandleIntent() æ–¹æ³•å³å¯ï¼Œè¯¥æ–¹æ³•ä¼šæ¥æ”¶æ¯ä¸ªå¯åŠ¨è¯·æ±‚çš„ Intentï¼Œä½¿æ‚¨èƒ½å¤Ÿæ‰§è¡Œåå°å·¥ä½œã€‚</p>
<p>IntentService æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li>è‡ªåŠ¨åˆ›å»ºé»˜è®¤çš„å·¥ä½œçº¿ç¨‹ï¼Œç”¨äºåœ¨åº”ç”¨çš„ä¸»çº¿ç¨‹å¤–æ‰§è¡Œä¼ é€’ç»™ onStartCommand() çš„æ‰€æœ‰ Intentã€‚</li>
<li>åˆ›å»ºå·¥ä½œé˜Ÿåˆ—ï¼Œç”¨äºå°† Intent é€ä¸€ä¼ é€’ç»™ onHandleIntent() å®ç°ï¼Œè¿™æ ·æ‚¨å°±æ°¸è¿œä¸å¿…æ‹…å¿ƒå¤šçº¿ç¨‹é—®é¢˜ã€‚</li>
<li>åœ¨å¤„ç†å®Œ<strong>æ‰€æœ‰å¯åŠ¨è¯·æ±‚ååœæ­¢æœåŠ¡ï¼Œå› æ­¤æ‚¨æ°¸è¿œä¸å¿…è°ƒç”¨ stopSelf()</strong>ã€‚</li>
<li>æä¾› onBind() çš„é»˜è®¤å®ç°ï¼ˆè¿”å› nullï¼‰ã€‚</li>
<li>æä¾› onStartCommand() çš„é»˜è®¤å®ç°ï¼Œå¯å°† Intent ä¾æ¬¡å‘é€åˆ°å·¥ä½œé˜Ÿåˆ—å’Œ onHandleIntent() å®ç°ã€‚</li>
</ul>
<h3 id="åœ¨å‰å°ä¸­æ˜¾ç¤ºã€ç§»é™¤"><a href="#åœ¨å‰å°ä¸­æ˜¾ç¤ºã€ç§»é™¤" class="headerlink" title="åœ¨å‰å°ä¸­æ˜¾ç¤ºã€ç§»é™¤"></a>åœ¨å‰å°ä¸­æ˜¾ç¤ºã€ç§»é™¤</h3><p>è¦ä»å‰å°ç§»é™¤æœåŠ¡ï¼Œè¯·è°ƒç”¨ stopForeground()ã€‚æ­¤æ–¹æ³•é‡‡ç”¨ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºæ˜¯å¦ä¹Ÿç§»é™¤çŠ¶æ€æ é€šçŸ¥ã€‚ æ­¤æ–¹æ³•ä¸ä¼šåœæ­¢æœåŠ¡ã€‚ ä½†æ˜¯ï¼Œå¦‚æœåœ¨æœåŠ¡æ­£åœ¨å‰å°è¿è¡Œæ—¶å°†å…¶åœæ­¢ï¼Œåˆ™é€šçŸ¥ä¹Ÿä¼šè¢«ç§»é™¤</p>
<p><a href="http://www.anddle.com/?p=173" target="_blank" rel="noopener">Start Service å’Œ Bind Service</a></p>
<h2 id="å››ã€LocalService-è¿˜æ˜¯-RemoteServiceï¼Ÿ"><a href="#å››ã€LocalService-è¿˜æ˜¯-RemoteServiceï¼Ÿ" class="headerlink" title="å››ã€LocalService è¿˜æ˜¯ RemoteServiceï¼Ÿ"></a>å››ã€LocalService è¿˜æ˜¯ RemoteServiceï¼Ÿ</h2><p>ä»€ä¹ˆæ—¶å€™é€‰æ‹© local serviceï¼ˆå³ä¸æŒ‡å®šé¢å¤–çš„è¿›ç¨‹ï¼‰ï¼Œä»€ä¹ˆæ—¶å€™é€‰æ‹© remote serviceï¼ˆé¢å¤–çš„è¿›ç¨‹ï¼‰ï¼Ÿ</p>
<p>é€šå¸¸æˆ‘ä»¬ä¼šæŠŠçœŸçš„<strong>éœ€è¦é•¿æœŸè¿è¡Œçš„ Serviceï¼ˆä¾‹å¦‚ IM ä¹‹ç±»ï¼‰æ”¾åœ¨å•ç‹¬çš„è¿›ç¨‹é‡Œ</strong>ï¼Œè¿™æ · UI æ‰€åœ¨çš„è¿›ç¨‹åœ¨å¿…è¦çš„æ—¶å€™ä»ç„¶å¯ä»¥è¢«ç³»ç»Ÿ kill æ‰æ¥è…¾å‡ºå†…å­˜ã€‚</p>
<p>è€Œ local service é€šå¸¸ç”¨æ¥å¤„ç†ä¸€äº›<strong>éœ€è¦çŸ­æœŸè¿è¡Œä½†ä»ç„¶è¶…å‡º activity æ´»åŠ¨å‘¨æœŸçš„ä»»åŠ¡</strong>ï¼Œæ‰“ä¸ªæ¯”æ–¹ï¼Œå‘é€çŸ­ä¿¡æˆ–å½©ä¿¡ã€‚è¿™æ ·çš„ä»»åŠ¡æ‰§è¡Œå®Œä»¥åï¼Œservice å°±å¯ä»¥ stop è‡ªå·±ï¼Œä»ç„¶ä¸å¦¨ç¢æ•´ä¸ª UI è¿›ç¨‹è¢«å›æ”¶æ‰ã€‚</p>
<h2 id="äº”ã€ä½•æ—¶ä¼šè¢«-killï¼Ÿ"><a href="#äº”ã€ä½•æ—¶ä¼šè¢«-killï¼Ÿ" class="headerlink" title="äº”ã€ä½•æ—¶ä¼šè¢« killï¼Ÿ"></a>äº”ã€ä½•æ—¶ä¼šè¢« killï¼Ÿ</h2><ul>
<li>å½“ä¸”ä»…å½“å†…å­˜ä¸è¶³ï¼Œè€Œæ­¤æ—¶æœ‰<strong><em>å…¶ä»–è¿›ç¨‹</em>çš„ Activty å…·æœ‰ç”¨æˆ·ç„¦ç‚¹</strong>ï¼ˆæˆ–è€…è¯´ï¼Œåœ¨äºç”¨æˆ·äº¤äº’ï¼‰æ—¶ï¼Œandroid ç³»ç»Ÿä¼šå¼ºåˆ¶ stop æœåŠ¡ã€‚</li>
<li>å¦‚æœå°†<strong>æœåŠ¡ç»‘å®šåˆ°å…·æœ‰ç”¨æˆ·ç„¦ç‚¹çš„ Activity</strong>ï¼Œåˆ™å®ƒä¸å¤ªå¯èƒ½ä¼šç»ˆæ­¢ï¼›</li>
<li>å¦‚æœ<strong>å°†æœåŠ¡å£°æ˜ä¸ºåœ¨å‰å°è¿è¡Œ</strong>ï¼Œåˆ™å®ƒ<strong>å‡ ä¹æ°¸è¿œä¸ä¼šç»ˆæ­¢</strong>ã€‚</li>
<li>å¦‚æœæœåŠ¡å·²å¯åŠ¨å¹¶è¦é•¿æ—¶é—´è¿è¡Œï¼Œåˆ™ç³»ç»Ÿä¼š<strong>éšç€æ—¶é—´çš„æ¨ç§»é™ä½æœåŠ¡åœ¨åå°ä»»åŠ¡åˆ—è¡¨ä¸­çš„ä½ç½®</strong>ï¼Œè€ŒæœåŠ¡ä¹Ÿå°†éšä¹‹å˜å¾—éå¸¸å®¹æ˜“è¢«ç»ˆæ­¢ï¼›</li>
<li>å¦‚æœæœåŠ¡æ˜¯é€šè¿‡ startService å¯åŠ¨çš„ï¼Œéœ€è¦é€šè¿‡é‡å†™ onStartCommand æ–¹æ³•å¦¥å–„å¤„ç†ç³»ç»Ÿå¯¹å®ƒçš„é‡å¯ã€‚     <ul>
<li>å› ä¸ºå¦‚æœç³»ç»Ÿç»ˆæ­¢æœåŠ¡ï¼Œé‚£ä¹ˆä¸€æ—¦èµ„æºå˜å¾—å†æ¬¡å¯ç”¨ï¼Œç³»ç»Ÿä¾¿ä¼šé‡å¯æœåŠ¡ï¼ˆä¸è¿‡è¿™è¿˜<strong>å–å†³äºä» onStartCommand() è¿”å›çš„å€¼</strong>ï¼‰ã€‚</li>
<li>Q:å¦‚æœä»…é€šè¿‡ bindService å¯åŠ¨ï¼ŒæœåŠ¡è¢« kill ä¹‹åï¼Œæ˜¯å¦é‡å¯ä»ç„¶å–å†³äº onStartCommand çš„è¿”å›å€¼å—ï¼Ÿ<ul>
<li>ä¸ä¼šï¼ŒonStartCommand æ–¹æ³•éƒ½æ²¡æœ‰è¢«è°ƒç”¨ï¼Œæ€ä¹ˆçŸ¥é“å®ƒçš„è¿”å›å€¼å‘¢ï¼Ÿ</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://www.anddle.com/?p=173" target="_blank" rel="noopener">Start Service å’Œ Bind Service</a></li>
<li><a href="https://developer.android.com/guide/components/services.html?hl=zh-cn#Lifecycle" target="_blank" rel="noopener">Service</a></li>
<li><a href="https://developer.android.com/guide/components/bound-services.html?hl=zh-cn" target="_blank" rel="noopener">Bind Service</a></li>
<li><a href="https://www.zhihu.com/question/19591125" target="_blank" rel="noopener">Android ä¸­ Local Service æœ€æœ¬è´¨çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="https://www.cnblogs.com/newcj/archive/2011/05/30/2061370.html" target="_blank" rel="noopener">Android ä¸­çš„ Service å…¨é¢æ€»ç»“</a></li>
</ul>
<p>ç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½å‡ºäºè¯¯è§£æˆ–è€…ç¬”è¯¯éš¾å…å‡ºé”™ï¼Œå¦‚æœå‘ç°æœ‰é—®é¢˜æˆ–è€…å¯¹æ–‡ä¸­å†…å®¹å­˜åœ¨ç–‘é—®æ¬¢è¿åœ¨ä¸‹é¢è¯„è®ºåŒºå‘Šè¯‰æˆ‘ï¼Œè¯·å¯¹é—®é¢˜æè¿°å°½é‡è¯¦ç»†ï¼Œä»¥å¸®åŠ©æˆ‘å¯ä»¥å¿«é€Ÿæ‰¾åˆ°é—®é¢˜æ ¹æºã€‚è°¢è°¢ï¼</p>
]]></content>
      
        <categories>
            
            <category> Android åŸºç¡€ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> Android åŸºç¡€ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android æ¶ˆæ¯æœºåˆ¶è§£æ]]></title>
      <url>https://timlin-pro.github.io/blog/2017/04/28/Android-%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90/</url>
      <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>æèµ· Handlerï¼Œç›¸ä¿¡å¤§å®¶éƒ½ä¸ä¼šé™Œç”Ÿï¼Œæ—¥å¸¸å¼€å‘ä¸­ä¸å¯é¿å…åœ°è¦ä½¿ç”¨åˆ°å®ƒã€‚ä»Šå¤©è¦è®²çš„æ˜¯æ¶ˆæ¯æœºåˆ¶ã€‚æ¶ˆæ¯æœºåˆ¶ï¼Ÿå’‹å¬èµ·æ¥æœ‰ç‚¹æŠ½è±¡ã€‚å…¶å®æˆ‘ä»¬åœ¨ä½¿ç”¨ Handler çš„æ—¶å€™ï¼Œå°±ä½¿ç”¨äº† Android çš„æ¶ˆæ¯æœºåˆ¶ã€‚</p>
<p>ä»å¼€å‘çš„è§’åº¦æ¥çœ‹ï¼ŒHandler æ˜¯ Android æ¶ˆæ¯æœºåˆ¶çš„<strong>ä¸Šå±‚æ¥å£</strong>ï¼Œè¿™ä½¿å¾—å¼€å‘è¿‡ç¨‹ä¸­åªéœ€è¦è®¾è®¡è¿™æ–¹é¢çš„å†…å®¹å³å¯ã€‚ä½†æ˜¯ä½œä¸ºä¸€ååˆæ ¼çš„å¼€å‘è€…ï¼Œå¼„æ¸…å®ƒçš„å®ç°åŸç†æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</p>
<a id="more"></a>
<p>ä¿—è¯è¯´å¾—å¥½ï¼Œä¸€å›¾èƒœåƒè¨€ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ Android æ¶ˆæ¯æœºåˆ¶ç®€å•ç¤ºæ„å›¾ï¼ˆå›¾ç‰‡å‚è€ƒè‡ª<a href="http://blog.csdn.net/iispring/article/details/47180325" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ï¼‰ã€‚</p>
<p><img src="https://user-images.githubusercontent.com/16668676/44624139-24697380-a918-11e8-819a-82c87c7f7566.png" alt="image"></p>
<p>æˆ‘ä»¬æŠŠ Thread æ¯”ä½œæ˜¯ä¸€ä¸ª å‘åŠ¨æœºï¼ŒMessageQueue çœ‹ä½œæ˜¯ä¸€æ¡æµæ°´çº¿ï¼ŒMessage å°±åƒæ˜¯æµæ°´çº¿ä¸Šçš„å·¥äººï¼ŒLooper æ˜¯æµæ°´çº¿ä¸‹çš„æ»šç­’ï¼ŒHandler åƒæ˜¯ä¸€ä¸ªå·¥äººï¼Œå®ƒè´Ÿè´£æŠŠ Message è¿™ä¸ªäº§å“é€åˆ°æµæ°´çº¿ä¸Šï¼Œæœ€ååˆè´Ÿè´£æŠŠå®ƒå–èµ°ã€‚</p>
<p>è¿™å¹…å›¾ä¸­çš„å„ä¸ªç»„ä»¶çš„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li>Looper ==ã€‹ æ»šè½®</li>
<li>MessageQueue ==ã€‹ æµæ°´çº¿</li>
<li>Message ==&gt; æµæ°´çº¿ä¸Šçš„äº§å“</li>
<li>Handler ==ã€‹ æ‰®æ¼”æŠŠã€äº§å“ã€é€è¿›æµæ°´çº¿ï¼Œå®Œäº†ä»¥ååˆæŠŠã€äº§å“ã€å–èµ°çš„è§’è‰²</li>
<li>Thread ==ã€‹ åŠ¨åŠ›</li>
</ul>
<p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªé‡è¦æ¦‚å¿µ â€”â€”ThreadLocal å›¾ä¸­æ²¡æœ‰æ ‡æ˜å‡ºæ¥ã€‚ä¸‹é¢å¯¹å„ä¸ªéƒ¨åˆ†è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚</p>
<h1 id="Android-çš„æ¶ˆæ¯æœºåˆ¶åˆ†æ"><a href="#Android-çš„æ¶ˆæ¯æœºåˆ¶åˆ†æ" class="headerlink" title="Android çš„æ¶ˆæ¯æœºåˆ¶åˆ†æ"></a>Android çš„æ¶ˆæ¯æœºåˆ¶åˆ†æ</h1><h2 id="ä»-Handler-å‡ºå‘"><a href="#ä»-Handler-å‡ºå‘" class="headerlink" title="ä» Handler å‡ºå‘"></a>ä» Handler å‡ºå‘</h2><p>ç›¸ä¿¡å¾ˆå¤šåš Android å¼€å‘çš„åŒå­¦éƒ½å†™è¿‡ä¸ä¸‹é¢ç›¸ä¼¼çš„ä»£ç ã€‚åœ¨å­çº¿ç¨‹ä¸­åšä¸€äº›è€—æ—¶æ“ä½œï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚ï¼Œæ“ä½œå®Œæˆä¹‹åï¼Œå°†è¿”å›çš„æ•°æ®åŒ…è£…ä¸º Message å¯¹è±¡ç„¶åè°ƒç”¨ sendMessageXxx æ–¹æ³•ï¼Œæœ€ååœ¨ handleMessage æ–¹æ³•ä¸­å¯¹ç»“æœè¿›è¡Œå¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Handler mHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">            	<span class="comment">//handle </span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">super</span>.handleMessage(msg);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">do</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">//do sth</span></div><div class="line">            Message message = mHandler.obtainMessage();</div><div class="line">            message.what = <span class="number">1</span>;</div><div class="line">            message.obj = result;</div><div class="line">            mHandler.sendMessage(message);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä» <code>Handler.sendMessage(message)</code>  åˆ° <code>Handler.handlerMessage</code>æ–¹æ³•ç»å†äº†ä»€ä¹ˆæ ·çš„è¿‡ç¨‹ï¼Ÿ</p>
<p>æˆ‘ä»¬å…ˆçœ‹çœ‹ sendMessage æ–¹æ³•å†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">sendMessage</span><span class="params">(Message msg)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> sendMessageDelayed(msg, <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">sendMessageDelayed</span><span class="params">(Message msg, <span class="keyword">long</span> delayMillis)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (delayMillis &lt; <span class="number">0</span>) &#123;</div><div class="line">        delayMillis = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">    MessageQueue queue = mQueue;</div><div class="line">    <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</div><div class="line">        RuntimeException e = <span class="keyword">new</span> RuntimeException(</div><div class="line">                <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</div><div class="line">        Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">    msg.target = <span class="keyword">this</span>;</div><div class="line">  <span class="keyword">if</span> (mAsynchronous) &#123;</div><div class="line">      msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ•´ä¸ªè°ƒç”¨æµç¨‹æ˜¯è¿™æ ·çš„ <code>sendMessage ==ã€‹ sendMessageDelayed ==ã€‹ sendMessageAtTime ==ã€‹ enqueueMessage ==ã€‹  MessageQueue.enqueueMessage</code></p>
<p>æˆ‘ä»¬å¯èƒ½è¿˜ä¼šè°ƒç”¨ <code>Handler.post(Runnable)</code>æ–¹æ³•åˆ°ç›®æ ‡çº¿ç¨‹ä¸­æ‰§è¡Œ run æ–¹æ³•ã€‚post æ–¹æ³•ä¼šå…ˆè°ƒç”¨ <code>getPostMessage</code>æ–¹æ³•å°† Runable åŒ…è£…ä¸º ä¸€ä¸ª Message å¯¹è±¡ï¼Œï¼ˆRunnable å°±å­˜å‚¨åœ¨ callback ä¸­ï¼‰ã€‚å…¶ä»–çš„ <code>postXxx(Runnable)</code>æ–¹æ³•å†…éƒ¨å®ç°ä¹Ÿæ˜¯è¿™æ ·çš„æµç¨‹ï¼Œé¦–å…ˆå°† Runnable åŒ…è£…ä¸ºä¸€ä¸ª Message å¯¹è±¡ç„¶åè°ƒç”¨ç›¸åº”çš„ sendXxx æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">post</span><span class="params">(Runnable r)</span></span>&#123;</div><div class="line">   <span class="keyword">return</span>  sendMessageDelayed(getPostMessage(r), <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Message <span class="title">getPostMessage</span><span class="params">(Runnable r)</span> </span>&#123;<span class="comment">//å°† Runnable åŒ…è£…ä¸ºä¸€ä¸ª Message å¯¹è±¡</span></div><div class="line">    Message m = Message.obtain();</div><div class="line">    m.callback = r;</div><div class="line">    <span class="keyword">return</span> m;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šè¿°çš„è°ƒç”¨æµç¨‹å¯ä»¥çœ‹å‡º sendXxx  æˆ–è€… postXxx æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ MessageQueue çš„ <code>enqueueMessage</code>æ–¹æ³•ï¼Œå°† Message è¿½åŠ åˆ° MessageQueue ä¸­ã€‚</p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ul>
<li>Handler çš„æ¶ˆæ¯çš„å‘é€å¯ä»¥é€šè¿‡ post çš„ä¸€ç³»åˆ—æ–¹æ³•ä»¥åŠ send çš„ä¸€ç³»åˆ—æ–¹æ³•æ¥å®ç°ã€‚<ul>
<li>post ç³»åˆ—æ–¹æ³•æœ€ç»ˆæ˜¯é€šè¿‡ send çš„ä¸€ç³»åˆ—æ–¹æ³•æ¥å®ç°çš„ã€‚</li>
</ul>
</li>
</ul>
<p><strong>Handler çš„å‘é€æ¶ˆæ¯çš„è¿‡ç¨‹ä»…ä»…æ˜¯å‘æ¶ˆæ¯é˜Ÿåˆ—æ’å…¥äº†ä¸€æ¡æ¶ˆæ¯</strong>ã€‚</p>
<h3 id="MessageQueue-å¯¹è±¡æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ"><a href="#MessageQueue-å¯¹è±¡æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ" class="headerlink" title="MessageQueue å¯¹è±¡æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ"></a>MessageQueue å¯¹è±¡æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ</h3><p>mQueue æ˜¯ Handler çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œå®ƒæ˜¯åœ¨å“ªé‡Œåˆå§‹åŒ–çš„å‘¢ï¼Ÿå…ˆçœ‹çœ‹ Handler çš„æ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">	<span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    mLooper = Looper.myLooper();<span class="comment">//è·å–å½“å‰çº¿ç¨‹çš„ Looper </span></div><div class="line">    <span class="keyword">if</span> (mLooper == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="comment">//æŠ›å‡ºå¼‚å¸¸ï¼Œä¸èƒ½åœ¨æ²¡æœ‰ Looper çš„çº¿ç¨‹åˆ›å»º Handler </span></div><div class="line">            <span class="string">"Can't create handler inside thread that has not called Looper.prepare()"</span>);</div><div class="line">    &#125;</div><div class="line">    mQueue = mLooper.mQueue;<span class="comment">//ä»æœ¬çº¿ç¨‹çš„ Looper ä¸­è·å– MessageQueue</span></div><div class="line">    mCallback = callback;<span class="comment">//å›è°ƒ</span></div><div class="line">    mAsynchronous = async;<span class="comment">//æ˜¯å¦å¼‚æ­¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ° mQueue æ˜¯ä» Looper ä¸­å–å‡ºçš„ã€‚åœ¨è§£è¯´ Looper ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å‰é¢æåˆ°çš„ MessageQueue ã€‚</p>
<h2 id="MessageQueue-çš„å·¥ä½œåŸç†"><a href="#MessageQueue-çš„å·¥ä½œåŸç†" class="headerlink" title="MessageQueue çš„å·¥ä½œåŸç†"></a>MessageQueue çš„å·¥ä½œåŸç†</h2><p>MessageQueue ä¸»è¦åŒ…å«ä¸¤ä¸ªæ“ä½œï¼šæ’å…¥å’Œè¯»å–ï¼ˆåˆ†åˆ«å¯¹åº” enqueueMessage å’Œ next æ–¹æ³•ï¼‰ã€‚</p>
<ul>
<li>é¡¾åæ€ä¹‰ï¼ŒenqueueMessage çš„ä½œç”¨æ˜¯å¾€é˜Ÿåˆ—ä¸­æ’å…¥ä¸€æ¡ä¿¡æ¯ã€‚</li>
<li>next() çš„ä½œç”¨æ˜¯ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€æ¡ä¿¡æ¯å¹¶å°†å…¶ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚</li>
</ul>
<p>è™½ç„¶ MessageQueue åä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†æ˜¯å®ƒçš„<strong>å†…éƒ¨å®ç°å¹¶ä¸æ˜¯ç”¨é˜Ÿåˆ—</strong>ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ª<strong>å•é“¾è¡¨çš„æ•°æ®ç»“æ„</strong>æ¥ç»´æŠ¤æ¶ˆæ¯åˆ—è¡¨ã€‚</p>
<ul>
<li>ä¸ºä»€ä¹ˆé€‰æ‹©ä½¿ç”¨å•é“¾è¡¨ç»“æ„ï¼Ÿ å› ä¸º Message æ˜¯å¯ä»¥å®šæ—¶å‘é€çš„ï¼Œè‹¥ä½¿ç”¨æ™®é€šçš„é˜Ÿåˆ—ï¼Œå½“æ’å…¥ä¸€ä¸ªå‘é€æ—¶é—´æ™šäºé˜Ÿé¦– Message  å‘é€æ—¶é—´çš„æ–° Messageï¼Œé‚£ä¹ˆå°±éœ€è¦æ’é˜Ÿï¼Œå®ç°èµ·æ¥ä¸æ–¹ä¾¿ï¼Œè€Œä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—åˆæ˜¾å¾—æ¯”è¾ƒå¤æ‚ã€‚å› æ­¤å°±é‡‡ç”¨äº†å•é“¾è¡¨å®ç°ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹ enqueueMessage æ–¹æ³•å’Œ next æ–¹æ³•ã€‚</p>
<h3 id="enqueueMessage-æ–¹æ³•ï¼š"><a href="#enqueueMessage-æ–¹æ³•ï¼š" class="headerlink" title="enqueueMessage æ–¹æ³•ï¼š"></a>enqueueMessage æ–¹æ³•ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (msg.target == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// è¦è¿›å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯å¯¹è±¡çš„ç›®æ ‡ handler ä¸èƒ½ä¸ºç©º</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Message must have a target."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (msg.isInUse()) &#123;</div><div class="line">        <span class="comment">// è¦è¿›å…¥é˜Ÿçš„æ¶ˆæ¯ä¸èƒ½å¤„åœ¨ä½¿ç”¨çŠ¶æ€</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg + <span class="string">" This message is already in use."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;<span class="comment">//å…¥é˜Ÿéœ€è¦å…ˆè·å–å†…ç½®é”</span></div><div class="line">        <span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">            <span class="comment">// å·²ç»è°ƒç”¨è¿‡ Looper.quit / Looper.quitSafely æ–¹æ³•ã€‚ MessageQueue ä¸­ä¸èƒ½å†è¿½åŠ  Message å¯¹è±¡</span></div><div class="line">            IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    msg.target + <span class="string">" sending message to a Handler on a dead thread"</span>);</div><div class="line">            Log.w(TAG, e.getMessage(), e);</div><div class="line">            msg.recycle();<span class="comment">//å›æ”¶æ¶ˆæ¯</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;<span class="comment">//è¿”å› false è¡¨ç¤ºå…¥é˜Ÿå¤±è´¥</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ ‡è®°æ¶ˆæ¯ä¸ºä½¿ç”¨çŠ¶æ€ï¼›è®¾ç½®æ¶ˆæ¯å‘é€çš„æ—¶é—´ï¼›æ˜¯å¦éœ€è¦å”¤é†’</span></div><div class="line">        msg.markInUse();</div><div class="line">        msg.when = when;</div><div class="line">        Message p = mMessages;</div><div class="line">        <span class="keyword">boolean</span> needWake;</div><div class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</div><div class="line">            <span class="comment">//å°†æ¶ˆæ¯æ’å…¥åˆ°é˜Ÿé¦–</span></div><div class="line">            msg.next = p;</div><div class="line">            mMessages = msg;</div><div class="line">            needWake = mBlocked;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            needWake = mBlocked &amp;&amp; p.target == <span class="keyword">null</span> &amp;&amp; msg.isAsynchronous();</div><div class="line">            Message prev;</div><div class="line">          	<span class="comment">//é€šè¿‡è¯¥å¾ªç¯æ‰¾åˆ°åˆé€‚çš„æ’å…¥ä½ç½®ï¼ˆä»¥å‘é€çš„æ—¶é—´ä½œä¸ºæ’åºçš„æ ‡å‡†ï¼‰</span></div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                prev = p;</div><div class="line">                p = p.next;</div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span> || when &lt; p.when) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</div><div class="line">                    needWake = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">          	<span class="comment">//æ’å…¥é˜Ÿåˆ—çš„æŒ‡å®šä½ç½®ä¸­</span></div><div class="line">            msg.next = p; </div><div class="line">            prev.next = msg;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></div><div class="line">        <span class="keyword">if</span> (needWake) &#123;</div><div class="line">            nativeWake(mPtr);<span class="comment">//å½“å‰å¤„äºé˜»å¡çŠ¶æ€ï¼Œé€šè¿‡ã€Œå†™æè¿°ç¬¦ã€å”¤é†’çº¿ç¨‹ï¼Œä»è€Œä½¿å¾— MessageQueue#next æ–¹æ³•ä¸­çš„ nativePollOnce èƒ½å¤Ÿè¿”å›ã€‚ï¼ˆå®é™…ä¸Šè¿ç”¨äº† Linux çš„ epoll æœºåˆ¶ï¼‰</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä»£ç ä¸­ä¸éš¾çœ‹å‡ºï¼ŒenqueueMessaege è™½ç„¶æœ‰ç‚¹é•¿ï¼Œä½†æ˜¯é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚å®ƒå…ˆåšäº†ä¸€äº›çŠ¶æ€åˆ¤æ–­ä»¥åŠä¸€äº›è¾¹ç•Œæ£€æµ‹ï¼Œå®Œäº†ä»¥åå†è¿›è¡Œå•é“¾è¡¨çš„æ’å…¥æ“ä½œã€‚</p>
<h3 id="next-æ–¹æ³•"><a href="#next-æ–¹æ³•" class="headerlink" title="next æ–¹æ³•"></a>next æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> <span class="keyword">long</span> ptr = mPtr;</div><div class="line">      <span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">null</span>; </div><div class="line">      &#125; </div><div class="line"><span class="comment">//ä»£ç çœç•¥</span></div><div class="line">      <span class="keyword">for</span> (;;) &#123; </div><div class="line">          <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</div><div class="line">              Binder.flushPendingCommands();</div><div class="line">          &#125; </div><div class="line">		<span class="comment">//å¤„ç† native å±‚äº‹ä»¶ï¼ˆå†…éƒ¨ä½¿ç”¨ Linux çš„ epoll æœºåˆ¶ï¼‰ï¼Œå¯èƒ½ä¼šé˜»å¡</span></div><div class="line">          nativePollOnce(ptr, nextPollTimeoutMillis);</div><div class="line"> </div><div class="line">          <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">              <span class="comment">// Try to retrieve the next message.  Return if found. </span></div><div class="line">              <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">              Message prevMsg = <span class="keyword">null</span>;</div><div class="line">              Message msg = mMessages;</div><div class="line">              <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚æœæ¶ˆæ¯çš„ç›®æ ‡ Handler ä¸ºç©º</span></div><div class="line">                  <span class="keyword">do</span> &#123; <span class="comment">// æ‰¾å‡ºé˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªå¼‚æ­¥ Message å¯¹è±¡</span></div><div class="line">                      prevMsg = msg;</div><div class="line">                      msg = msg.next;</div><div class="line">                  &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</div><div class="line">              &#125; </div><div class="line">              <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="keyword">if</span> (now &lt; msg.when) &#123;</div><div class="line">                      <span class="comment">// è®¡ç®—ä¸‹ä¸€æ¡æ¶ˆæ¯çš„æ‰§è¡Œæ—¶é—´ï¼Œè®¾ç½®ä¸€ä¸ªå”¤é†’çš„å»¶è¿Ÿ</span></div><div class="line">                      nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</div><div class="line">                  &#125; <span class="keyword">else</span> &#123; </div><div class="line">                      <span class="comment">// é˜Ÿé¦– Message æ‰§è¡Œçš„æ—¶æœºåˆ°äº†ï¼Œè·å–ä¸€æ¡æ¶ˆæ¯ </span></div><div class="line">                      mBlocked = <span class="keyword">false</span>; </div><div class="line">                      <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</div><div class="line">                          prevMsg.next = msg.next;</div><div class="line">                      &#125; <span class="keyword">else</span> &#123; </div><div class="line">                          mMessages = msg.next;</div><div class="line">                      &#125; </div><div class="line">                      msg.next = <span class="keyword">null</span>;</div><div class="line">                      <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Returning message: "</span> + msg);</div><div class="line">                      msg.markInUse();<span class="comment">//æ ‡è®° Message ä¸ºæ­£åœ¨ä½¿ç”¨çŠ¶æ€</span></div><div class="line">                      <span class="keyword">return</span> msg;<span class="comment">//è¿”å›æ¶ˆæ¯</span></div><div class="line">                  &#125; </div><div class="line">              &#125; <span class="keyword">else</span> &#123; </div><div class="line">                  <span class="comment">// é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯äº†</span></div><div class="line">                  nextPollTimeoutMillis = -<span class="number">1</span>;</div><div class="line">              &#125; </div><div class="line"> </div><div class="line">              <span class="comment">// å¤–éƒ¨è°ƒç”¨äº† quit æ–¹æ³•ã€‚é€€å‡º</span></div><div class="line">              <span class="keyword">if</span> (mQuitting) &#123; </div><div class="line">                  dispose(); <span class="comment">//å¤„ç†åº•å±‚æ¶ˆæ¯é˜Ÿåˆ—ã€‚å®é™…ä¸Šç§»é™¤äº† native å±‚çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line">                  <span class="keyword">return</span> <span class="keyword">null</span>; </div><div class="line">              &#125; </div><div class="line"> </div><div class="line"></div><div class="line">              <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></div><div class="line">                      &amp;&amp; (mMessages == <span class="keyword">null</span> || now &lt; mMessages.when)) &#123;</div><div class="line">                  pendingIdleHandlerCount = mIdleHandlers.size();</div><div class="line">              &#125; </div><div class="line">              <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</div><div class="line">                  <span class="comment">// æ²¡æœ‰å¯è¿è¡Œçš„é—²ç½® handlerã€‚è·³å‡ºæœ¬æ¬¡å¾ªç¯å†ç­‰å¾…ã€‚</span></div><div class="line">                  mBlocked = <span class="keyword">true</span>; </div><div class="line">                  <span class="keyword">continue</span>; </div><div class="line">              &#125; </div><div class="line">		<span class="comment">//ä»£ç çœç•¥</span></div><div class="line">          &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>next æ–¹æ³•ä¸­æœ‰ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå…¶ä¸»è¦é€»è¾‘å¦‚ä¸‹:</p>
<ul>
<li>å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œé‚£ä¹ˆ next ä¼šä¸€ç›´é˜»å¡åœ¨é‚£é‡Œã€‚<ul>
<li>å½“é˜Ÿé¦–çš„æ¶ˆæ¯è®¾ç½®äº†å»¶è¿Ÿæ‰§è¡Œæ—¶ï¼Œä¼šé€ æˆçŸ­æ—¶é—´çš„é˜»å¡ã€‚</li>
</ul>
</li>
<li>å½“æœ‰æ–°æ¶ˆæ¯åˆ°æ¥æ—¶ï¼Œnext æ–¹æ³•ä¼šè¿”å›è¿™æ¡ä¿¡æ¯å¹¶å°†å…¶ä»å•é“¾è¡¨ä¸­ç§»é™¤ã€‚</li>
</ul>
<p>å½“è°ƒç”¨äº† quit æ–¹æ³•ä¹‹åï¼ŒmQuitting ä¸º true ï¼Œnext æ–¹æ³•ä¼šç§»é™¤ native å±‚çš„æ¶ˆæ¯é˜Ÿåˆ—å¹¶è¿”å› nullã€‚</p>
<p>æ•´ä¸ª next æ–¹æ³•çš„é€»è¾‘å¦‚ä¸‹ï¼š ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¾æ¬¡å–å‡ºæ¶ˆæ¯ã€‚å¦‚æœè¿™ä¸ªæ¶ˆæ¯åˆ°äº†æ‰§è¡Œæ—¶é—´ï¼Œé‚£ä¹ˆå°±å°†è¯¥æ¶ˆæ¯è¿”å›ç»™ Looperï¼Œå¹¶ä¸”å°†æ¶ˆæ¯é˜Ÿåˆ—é“¾è¡¨çš„æŒ‡é’ˆåç§»ã€‚å®é™…ä¸Šæ¶ˆæ¯é˜Ÿåˆ—ç»´æŠ¤ç€ä¸€ä¸ª<strong>åˆ†å‘å±éšœ</strong>(dispatch barrier)ï¼Œå½“ä¸€ä¸ª Message çš„æ—¶é—´æˆ³ä½äºè¿™ä¸ªå€¼çš„æ—¶å€™ï¼Œæ¶ˆæ¯å°±ä¼šè¢«åˆ†å‘ç»™ Handler è¿›è¡Œå¤„ç†ã€‚å½¢è±¡ä¸€ç‚¹ï¼Ÿçœ‹çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼ˆå›¾ç‰‡æ¥è‡ª <a href="https://medium.com/@jagsaund/android-handler-internals-b5d49eba6977" target="_blank" rel="noopener">Android Handler Internals</a>ï¼Œä¾µåˆ ï¼‰</p>
<p><img src="https://user-images.githubusercontent.com/16668676/32033334-a880e7ee-ba3e-11e7-8294-da929cc7bea0.png" alt="image"></p>
<p>ä½äº dispatch barrier å·¦è¾¹çš„ Message éƒ½è¢«é˜»å¡ç€ï¼Œä½äºå…¶å³è¾¹çš„æ˜¯å³å°†åˆ†å‘çš„ Messageã€‚</p>
<p>æˆ‘ä»¬æ˜¯ä¸æ˜¯è¯¥è¯´ä¸‹ Looper äº†ï¼Œä¸‹ä¸‹ä¸ªå°±åˆ°å®ƒäº†ï¼Œåœ¨æ­¤ä¹‹å‰éœ€è¦å…ˆçœ‹çœ‹ ThreadLocal ç›¸å…³çŸ¥è¯†ã€‚</p>
<h2 id="ThreadLocal-ç®€ä»‹"><a href="#ThreadLocal-ç®€ä»‹" class="headerlink" title="ThreadLocal ç®€ä»‹"></a>ThreadLocal ç®€ä»‹</h2><p>ThreadLocal  æ˜¯ä¸€ä¸ª<strong>çº¿ç¨‹å†…éƒ¨çš„æ•°æ®å­˜å‚¨ç±»</strong>ï¼Œé€šè¿‡å®ƒå¯ä»¥åœ¨æŒ‡å®šçš„çº¿ç¨‹ä¸­å­˜å‚¨æ•°æ®ï¼Œæ•°æ®å­˜å‚¨åï¼Œåªæœ‰åœ¨æŒ‡å®šçº¿ç¨‹ä¸­æ‰èƒ½è·å–åˆ°å­˜å‚¨çš„æ•°æ®ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹æ¥è¯´åˆ™æ— æ³•è·å–åˆ°æ•°æ®ã€‚</p>
<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<ol>
<li>å½“æŸäº›æ•°æ®æ˜¯ä»¥çº¿ç¨‹ä¸ºä½œç”¨åŸŸå¹¶ä¸”ä¸åŒçº¿ç¨‹å…·æœ‰ä¸åŒçš„æ•°æ®å‰¯æœ¬çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨ ThrradLocalã€‚<ul>
<li>åœ¨ Android ä¸­ï¼ŒLooper ç±»å°±æ˜¯åˆ©ç”¨äº† ThreadLocal çš„ç‰¹æ€§ï¼Œä¿è¯<strong>æ¯ä¸ªçº¿ç¨‹åªå­˜åœ¨ä¸€ä¸ª Looper å¯¹è±¡</strong>ã€‚</li>
</ul>
</li>
<li>å¤æ‚é€»è¾‘ä¸‹çš„å¯¹è±¡ä¼ é€’ã€‚<ul>
<li>æ¯”å¦‚ç›‘å¬å™¨çš„ä¼ é€’ã€‚</li>
</ul>
</li>
</ol>
<p>ä» ThreadLocal çš„ set å’Œ get æ–¹æ³• å¯ä»¥çœ‹å‡ºï¼Œå®ƒä»¬æ‰€æ“ä½œçš„å¯¹è±¡éƒ½æ˜¯<strong>å½“å‰çº¿ç¨‹çš„ localValues å¯¹è±¡çš„ table æ•°ç»„</strong>ï¼Œå› æ­¤åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è®¿é—®åŒä¸€ä¸ª ThreadLocal çš„ get å’Œ set æ–¹æ³•ï¼Œä»–ä»¬å¯¹ ThreadLocal æ‰€åšçš„è¯»/å†™æ“ä½œä»…é™äºå„è‡ªçº¿ç¨‹çš„å†…éƒ¨ã€‚</p>
<p>å…³äº ThreadLocal çš„å…·ä½“ä»‹ç»è¯·è§ <a href="https://ivanljt.github.io/blog/2017/08/21/è°ˆè°ˆ-ThreadLocal/#more" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a></p>
<p>ç†è§£ ThreadLocal å¯¹åé¢ç†è§£ Looper æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œå»ºè®®å…ˆç»†çœ‹ ThreadLocal  çš„å†…å®¹å†çœ‹åé¢çš„å†…å®¹ã€‚</p>
<h2 id="Looper-çš„å·¥ä½œåŸç†"><a href="#Looper-çš„å·¥ä½œåŸç†" class="headerlink" title="Looper çš„å·¥ä½œåŸç†"></a>Looper çš„å·¥ä½œåŸç†</h2><p>Android çš„å®˜æ–¹æ–‡æ¡£ä¸­æ˜¯è¿™ä¹ˆä»‹ç» Looper çš„ï¼š</p>
<blockquote>
<p>  Looper æ˜¯ä¸€ä¸ªç”¨æ¥ä¸ºå•ä¸ªçº¿ç¨‹è¿è¡Œæ¶ˆæ¯å¾ªç¯çš„ç±»ã€‚<strong>é»˜è®¤æƒ…å†µä¸‹çº¿ç¨‹æ˜¯æ²¡æœ‰ä¸€ä¸ª Looper è·Ÿä»–ä»¬ç›¸å…³è”çš„</strong>ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦ looper çš„è¯ï¼Œå¯ä»¥é€šè¿‡å…ˆè°ƒç”¨ prepare() æ–¹æ³•åˆå§‹åŒ–ä¸€ä¸ªæœ¬çº¿ç¨‹çš„ Looper å®ä¾‹ã€‚ç„¶åè°ƒç”¨ loop æ–¹æ³•è®©å®ƒå¼€å§‹å¤„ç†ä¿¡æ¯ï¼Œä¸€ç›´åˆ°å¾ªç¯ç»“æŸã€‚</p>
<p>  æˆ‘ä»¬é€šå¸¸é€šè¿‡ Handler ç±»ä¸ Looper çš„æ‰“äº¤é“ã€‚</p>
</blockquote>
<p>ä¸€ä¸ª çº¿ç¨‹æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ª Looperï¼Œä¸€ä¸ª Looper ä¸­æœ‰ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå‰é¢ Hanlder ä¸­çš„ MessageQueue å¯¹è±¡å°±æ˜¯ä» Looper ä¸­å–å‡ºçš„ï¼‰ï¼Œå¹¶ä¸”æŒæœ‰å®ƒæ‰€åœ¨çº¿ç¨‹çš„å¼•ç”¨ã€‚Looper å°±åƒä¸€ä¸ªã€Œæ­»å¾ªç¯ã€ï¼ˆé€šè¿‡ quit æˆ–è€… quitSafely æ–¹æ³•å¯ä»¥é€€å‡ºï¼‰ï¼Œå®ƒä¼šä¸æ–­åœ°ä» MessageQueue ä¸­æŸ¥çœ‹æ˜¯å¦æœ‰æ–°æ¶ˆæ¯ã€‚å¦‚æœæœ‰ï¼Œå°±è°ƒç”¨ handler.dispatchMessage æ–¹æ³•è¿›è¡Œå¤„ç†ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±ä¸€ç›´é˜»å¡åœ¨é‚£é‡Œã€‚</p>
<h3 id="åˆ›å»º-Looper"><a href="#åˆ›å»º-Looper" class="headerlink" title="åˆ›å»º Looper"></a>åˆ›å»º Looper</h3><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ Looper çš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">    mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);<span class="comment">//åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line">    mThread = Thread.currentThread(); <span class="comment">//æŠŠå½“å‰çº¿ç¨‹çš„å¯¹è±¡ä¿å­˜èµ·æ¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Looper æ„é€ æ–¹æ³•ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶ä¸”ä¼šä¿å­˜å½“å‰çº¿ç¨‹å¯¹è±¡ã€‚</p>
<h4 id="åˆ›å»ºæ™®é€šçº¿ç¨‹ä¸Šçš„-Looper"><a href="#åˆ›å»ºæ™®é€šçº¿ç¨‹ä¸Šçš„-Looper" class="headerlink" title="åˆ›å»ºæ™®é€šçº¿ç¨‹ä¸Šçš„ Looper"></a>åˆ›å»ºæ™®é€šçº¿ç¨‹ä¸Šçš„ Looper</h4><p>Looper çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œé‚£ä¹ˆè¦åˆ›å»ºä¸€ä¸ª Looperã€‚ï¼Ÿ<br><strong>è°ƒç”¨ <code>Looper.prepare()</code>å³å¯ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºä¸€ä¸ª Looper å¯¹è±¡ï¼Œæ¥ç€é€šè¿‡ <code>Looper.loop()</code> æ–¹æ³•å¼€å¯æ¶ˆæ¯å¾ªç¯</strong>ã€‚è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨å­çº¿ç¨‹ä¸­ï¼Œå¦‚æœæ‰‹åŠ¨ä¸ºå…¶åˆ›å»ºäº† Looperï¼Œé‚£ä¹ˆåœ¨æ‰€æœ‰çš„ä»»åŠ¡å®Œæˆä¹‹åï¼Œéœ€è¦è°ƒç”¨ quit æ–¹æ³•æ¥ç»ˆæ­¢æ¶ˆæ¯å¾ªç¯ï¼Œå¦åˆ™è¿™ä¸ªå­çº¿ç¨‹å°±ä¼šä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚</p>
<p>æˆ‘ä»¬çœ‹ä¸‹ prepare æ–¹æ³•å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</div><div class="line">    prepare(<span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);<span class="comment">//ä¸€ä¸ªçº¿ç¨‹æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ª Looper</span></div><div class="line">    &#125;</div><div class="line">    sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));<span class="comment">//ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºä¸€ä¸ª Looper </span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;<span class="comment">//è·å–å½“å‰çº¿ç¨‹çš„ Looper å¯¹è±¡</span></div><div class="line">    <span class="keyword">return</span> sThreadLocal.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºä¸»çº¿ç¨‹ä¸Šçš„-Looper"><a href="#åˆ›å»ºä¸»çº¿ç¨‹ä¸Šçš„-Looper" class="headerlink" title="åˆ›å»ºä¸»çº¿ç¨‹ä¸Šçš„ Looper"></a>åˆ›å»ºä¸»çº¿ç¨‹ä¸Šçš„ Looper</h4><p>æœ‰ä¸€ä¸ªè¦æ³¨æ„çš„åœ°æ–¹å°±æ˜¯ Looper çš„å¦ä¸€ä¸ªåˆ›å»ºæ–¹æ³• â€”â€” prepareMainLooperã€‚</p>
<p>prepareMainLooper åœ¨åº”ç”¨çš„å…¥å£æ–¹æ³•ï¼ˆActivityThread.main() ï¼‰ä¸­è¢«è°ƒç”¨ï¼Œç”¨æ¥å¯åŠ¨ä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    <span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</div><div class="line"></div><div class="line">    Looper.prepareMainLooper();<span class="comment">//åˆ›å»ºä¸»çº¿ç¨‹çš„ Looper</span></div><div class="line"></div><div class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</div><div class="line">    thread.attach(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</div><div class="line">        sMainThreadHandler = thread.getHandler();<span class="comment">//åˆ›å»ºä¸»çº¿ç¨‹çš„ Handler</span></div><div class="line">    &#125;</div><div class="line">	<span class="comment">//ä»£ç çœç•¥</span></div><div class="line">    Looper.loop();<span class="comment">//å¼€å¯ä¸»çº¿ç¨‹æ¶ˆæ¯å¾ªç¯</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">    prepare(<span class="keyword">false</span>);</div><div class="line">    <span class="keyword">synchronized</span> (Looper.class) &#123;</div><div class="line">        <span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The main Looper has already been prepared."</span>);</div><div class="line">        &#125;</div><div class="line">        sMainLooper = myLooper();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Looper <span class="title">getMainLooper</span><span class="params">()</span> </span>&#123;<span class="comment">//è¯¥æ–¹æ³•ä½¿å¾—åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è·å¾—ä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯</span></div><div class="line">    <span class="keyword">synchronized</span> (Looper.class) &#123;</div><div class="line">        <span class="keyword">return</span> sMainLooper;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>åœ¨åº”ç”¨å¯åŠ¨æ—¶ä¼šå¼€å¯ä¸€ä¸ªä¸»çº¿ç¨‹ï¼ˆUI çº¿ç¨‹ï¼‰ï¼Œå¹¶ä¸”<strong>å¼€å¯æ¶ˆæ¯å¾ªç¯</strong>ï¼Œåº”ç”¨ä¸æ–­åœ°ä»è¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºã€å¤„ç†æ¶ˆæ¯è¾¾åˆ°ç¨‹åºè¿è¡Œçš„ç»“æœã€‚</p>
<h3 id="loop-æ–¹æ³•"><a href="#loop-æ–¹æ³•" class="headerlink" title="loop æ–¹æ³•"></a>loop æ–¹æ³•</h3><p>å‰é¢æ‰€è®²éƒ½æ˜¯ Looper è‡ªèº«çš„ä¸€äº›ç‰¹æ€§ï¼Œæ²¡æœ‰æåˆ°å®ƒæ˜¯æ€ä¹ˆè·Ÿå…¶ä»–éƒ¨åˆ†äº¤äº’çš„ã€‚Looper ä¸å…¶ä»– MessageQueue ã€Hanlder çš„äº¤äº’ä¸»è¦åœ¨ loop æ–¹æ³•ä¸­ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ loop æ–¹æ³•çš„æºç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Looper me = myLooper();<span class="comment">//è·å–æœ¬çº¿ç¨‹çš„ Looper</span></div><div class="line">    <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);<span class="comment">//è°ƒç”¨ loop æ–¹æ³•ä¹‹å‰å¿…é¡»å…ˆè°ƒç”¨ Looper.prepare() æ–¹æ³•åˆ›å»º Looper</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;<span class="comment">//è·å–æ‰€åœ¨çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"></div><div class="line">    <span class="comment">// Make sure the identity of this thread is that of the local process,</span></div><div class="line">    <span class="comment">// and keep track of what that identity token actually is.</span></div><div class="line">    Binder.clearCallingIdentity();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (;;) &#123; </div><div class="line">        Message msg = queue.next(); <span class="comment">// é˜»å¡æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°æ¶ˆæ¯ï¼Œå°±ä¸€ç›´é˜»å¡åœ¨è¿™é‡Œ</span></div><div class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;  <span class="comment">//åªæœ‰å½“ msg == null æ—¶æ‰ä¼šé€€å‡ºå¾ªç¯</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// ä»£ç çœç•¥</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            msg.target.dispatchMessage(msg);<span class="comment">// è¿™é‡Œçš„ msg.target æ˜¯å‘é€è¿™æ¡ä¿¡æ¯çš„ Handler å¯¹è±¡ï¼Œè¿™æ · Handler å‘é€çš„æ¶ˆæ¯æœ€ç»ˆåˆäº¤ç»™å®ƒçš„ dispatchMessage æ–¹æ³•æ¥å¤„ç†äº†ã€‚</span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// ä»£ç çœç•¥</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// ä»£ç çœç•¥</span></div><div class="line"></div><div class="line">        <span class="comment">// Make sure that during the course of dispatching the</span></div><div class="line">        <span class="comment">// identity of the thread wasn't corrupted.</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</div><div class="line">        <span class="comment">// ä»£ç çœç•¥</span></div><div class="line"></div><div class="line">        msg.recycleUnchecked();<span class="comment">//è°ƒç”¨ Message çš„å›æ”¶æ–¹æ³•</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”±æºç å¯è§ loop æ–¹æ³•æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œ<strong>å”¯ä¸€è·³å‡ºå¾ªç¯çš„æ–¹å¼æ˜¯ MessageQueue çš„ next æ–¹æ³•è¿”å›äº† null</strong>ã€‚</p>
<p>å½“æˆ‘ä»¬è°ƒç”¨ Looper çš„ quit æ–¹æ³•æ—¶ï¼ŒLooper ä¼šè°ƒç”¨ MessageQueue çš„ quit æˆ– quitSafely æ–¹æ³•æ¥é€šçŸ¥æ¶ˆæ¯é˜Ÿåˆ—é€€å‡ºï¼Œå¦åˆ™ loop æ–¹æ³•ä¼šä¸€ç›´å¾ªç¯ä¸‹å»ã€‚</p>
<p>å¦å¤–ï¼Œä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œloop è°ƒç”¨äº† MessageQueue çš„ next æ–¹æ³•æ¥è·å–æ–°æ¶ˆæ¯ï¼Œè€Œ next æ˜¯ä¸€ä¸ªé˜»å¡æ“ä½œï¼Œå½“æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œnext æ–¹æ³•ä¼šä¸€ç›´é˜»å¡åœ¨é‚£é‡Œï¼Œè¿™ä¹Ÿå¯¼è‡´äº† loop æ–¹æ³•ä¸€ç›´é˜»å¡åœ¨é‚£é‡Œã€‚</p>
<p><code>msg.target.dispatchMessage(msg);</code>// è¿™é‡Œçš„ msg.target æ˜¯å‘é€è¿™æ¡ä¿¡æ¯çš„ Handler å¯¹è±¡ï¼Œè¿™æ · <strong>Handler å‘é€çš„æ¶ˆæ¯æœ€ç»ˆåˆäº¤ç»™å®ƒçš„ dispatchMessage æ–¹æ³•æ¥å¤„ç†</strong>äº†ã€‚</p>
<p>ç»•äº†è¿™ä¹ˆä¸€ä¸ªå¤§åœˆæ„ä¹‰ä½•åœ¨ï¼Ÿ<br>é€šå¸¸æˆ‘ä»¬éƒ½ä¼šåœ¨å­çº¿ç¨‹ä¸­è°ƒç”¨ Handler.sendMessageXxx æˆ–è€… Handler.postXxx æ–¹æ³•ï¼Œ è€Œ<strong>Handler çš„ dispatchMessage æ–¹æ³•æ˜¯åœ¨åˆ›å»º Handler çš„é‚£ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œè¿™æ ·å°±é¡ºåˆ©åœ°å°†ä»£ç åˆ‡æ¢åˆ°ç›®æ ‡çº¿ç¨‹ä¸­å»æ‰§è¡Œäº†</strong>ã€‚</p>
<h3 id="é€€å‡º-Looper"><a href="#é€€å‡º-Looper" class="headerlink" title="é€€å‡º Looper"></a>é€€å‡º Looper</h3><p>Looper ä¹Ÿæ˜¯å¯ä»¥é€€å‡ºçš„ï¼ˆè¿™é‡Œçš„é€€å‡º Looper ä¸»è¦æ˜¯æŒ‡è·³å‡º loop æ–¹æ³•ä¸­çš„æ­»å¾ªç¯ï¼‰ã€‚é€šè¿‡è°ƒç”¨ Looper çš„ quit æ–¹æ³•æˆ–è€… quitSafely æ–¹æ³•å³å¯ã€‚é‚£ä¹ˆè¿™äºŒè€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<ul>
<li>è°ƒç”¨ Looper çš„ quit æ–¹æ³•å¯ä»¥<strong>ç›´æ¥é€€å‡º</strong>Looperã€‚</li>
<li>è°ƒç”¨ Looper çš„ quitSafely æ–¹æ³•åªæ˜¯è®¾å®šäº†ä¸€ä¸ª<strong>é€€å‡ºæ ‡è®°</strong>ï¼Œç„¶åæŠŠæ¶ˆæ¯é˜Ÿåˆ—ä¸­<strong>å·²æœ‰çš„æ¶ˆæ¯å¤„ç†å®Œæ‰é€€å‡º</strong> Looperã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Looper.quit</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</div><div class="line">    mQueue.quit(<span class="keyword">false</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">//Looper.quitSafely</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quitSafely</span><span class="params">()</span> </span>&#123;</div><div class="line">    mQueue.quit(<span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mQueue çš„å®é™…ç±»å‹ä¸º MessageQueueï¼ŒLooper çš„ä¸¤ä¸ª quit æ–¹æ³•éƒ½æ˜¯é€šè¿‡è°ƒç”¨ MessageQueue çš„ quit æ–¹æ³•æ¥å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">quit</span><span class="params">(<span class="keyword">boolean</span> safe)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!mQuitAllowed) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Main thread not allowed to quit."</span>);<span class="comment">//ä¸»çº¿ç¨‹çš„  Looper æ— æ³•é€€å‡ºã€‚ä¸»çº¿ç¨‹çš„ Looper æ˜¯é€šè¿‡ prepareMainLooper æ–¹æ³•åˆ›å»ºçš„ï¼Œåˆ›å»ºæ—¶è°ƒç”¨äº† prepareï¼ˆfalseï¼‰ï¼Œä¹Ÿå°±æ˜¯ä»¤ mQuitAllowed = false</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mQuitting) &#123;<span class="comment">//æ˜¯å¦æ­£åœ¨é€€å‡º</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        mQuitting = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (safe) &#123;</div><div class="line">          	<span class="comment">//å®‰å…¨é€€å‡º,ä¸ä¼šå–æ¶ˆæ‰§è¡Œæ—¶æœºæ—©äºæˆ–ç­‰äºå½“å‰æ—¶é—´çš„ Message</span></div><div class="line">            removeAllFutureMessagesLocked();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            removeAllMessagesLocked();<span class="comment">//ç§»é™¤ MessageQueue ä¸­æ‰€æœ‰çš„æ¶ˆæ¯</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting was previously false.</span></div><div class="line">        nativeWake(mPtr);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>MessageQueue.next()</code> æ–¹æ³•ç‰‡æ®µã€‚å½“è°ƒç”¨äº† quit æ–¹æ³•ä¹‹åä¼šä½¿å¾— mQuitting ä¸º trueï¼Œä»è€Œå¯¼è‡´  next æ–¹æ³•è¿”å› nullï¼Œä¸€æ—¦ next æ–¹æ³•è¿”å› nullï¼Œ <code>Looper.loop</code> å°±è·³å‡ºäº†æ­»å¾ªç¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">    dispose();<span class="comment">//é”€æ¯ native å±‚çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <code>MessageQueue.enqueueMessage</code> æ–¹æ³•ç‰‡æ®µ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">    IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</div><div class="line">            msg.target + <span class="string">" sending message to a Handler on a dead thread"</span>);</div><div class="line">    Log.w(TAG, e.getMessage(), e);</div><div class="line">    msg.recycle();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»è¿™é‡Œå®ç°å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨äº† Looper.quit / quitSafely æ–¹æ³•ä¹‹åï¼Œå†é€šè¿‡ Handler å‘é€çš„æ¶ˆæ¯æ— æ³•æ·»åŠ åˆ° MessageQueue ä¸­ï¼Œæ­¤æ—¶ Handler çš„ send æ–¹æ³•ä¼šè¿”å› falseã€‚</p>
<p><code>android.os.MessageQueue#dispose</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é”€æ¯åº•å±‚çš„æ¶ˆæ¯é˜Ÿåˆ—</span></div><div class="line"><span class="comment">// Must only be called on the looper thread or the finalizer.</span></div><div class="line"><span class="comment">//åªèƒ½åœ¨ä¸ looper çº¿ç¨‹æˆ–è€… finalizer ä¸­è°ƒç”¨</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mPtr != <span class="number">0</span>) &#123;</div><div class="line">        nativeDestroy(mPtr);</div><div class="line">        mPtr = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å›åˆ°-Handler"><a href="#å›åˆ°-Handler" class="headerlink" title="å›åˆ° Handler"></a>å›åˆ° Handler</h2><p> Looper çš„ loop æ–¹æ³•ä¸­æœ‰è¿™æ ·ä¸€è¡Œä»£ç  <code>msg.target.dispatchMessage(msg);</code>è¯¥æ–¹æ³•è°ƒç”¨çš„å°±æ˜¯ Handler.dispatchMessage æ–¹æ³•ã€‚dispatchMessage æ–¹æ³•ä¼šæ ¹æ®æƒ…å†µå¯¹ Message è¿›è¡Œåˆ†å‘ã€‚</p>
<p><code>Handler.class</code> ä»£ç ç‰‡æ®µ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Handle system messages here.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</div><div class="line">        handleCallback(msg);<span class="comment">//å›è°ƒæ‰§è¡Œ Runnable çš„ run æ–¹æ³•</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;<span class="comment">//æ‰§è¡Œåˆ›å»º Handler æ—¶æŒ‡å®šçš„ Callback#handleMessage æ–¹æ³•ã€‚</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        handleMessage(msg);<span class="comment">//æ‰§è¡Œ handleMessage(msg) æ–¹æ³•</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;<span class="comment">//ç©ºå®ç°ï¼Œéœ€è¦ç”±å­ç±»è¦†å†™</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleCallback</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">    message.callback.run(); <span class="comment">// callback çš„å®é™…ç±»å‹ä¸º Runnableï¼Œè¿™è¡Œä»£ç çš„ä½œç”¨å°±æ˜¯å›è°ƒ Runnable çš„ run æ–¹æ³•</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Callback interface you can use when instantiating a Handler to avoid</div><div class="line"> * having to implement your own subclass of Handler.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> msg A &#123;<span class="doctag">@link</span> android.os.Message Message&#125; object</div><div class="line">     * <span class="doctag">@return</span> True if no further handling is desired</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>dispatchMessage æ–¹æ³•çš„é€»è¾‘ï¼šå¦‚æœ <strong>Message è‡ªèº«</strong>è®¾ç½®äº† callbackï¼Œé‚£ä¹ˆäº‹ä»¶ä¼šç›´æ¥åˆ†æ´¾ç»™ msg#callback#run  æ–¹æ³•å¤„ç†ã€‚å¦åˆ™ï¼Œå¦‚æœç»™ Handler è®¾ç½®äº† Callback çš„è¯ï¼Œä¼šå…ˆå°†äº‹ä»¶åˆ†æ´¾ç»™ Callback#handleMessage æ–¹æ³•å¤„ç†ï¼Œå¦‚æœè¿”å›å€¼ä¸º trueï¼Œè¯´æ˜ä¸éœ€è¦å†åšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œå¦‚æœè¿”å› falseæˆ–è€…æ˜¯æ²¡æœ‰ç»™ Handler è®¾ç½®callback çš„ è¯ï¼Œåˆ™ä¼šæ‰§è¡Œ Handler#handleMessage æ–¹æ³•ã€‚</p>
<p>Handler çš„ Callback æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ</p>
<ol>
<li>æä¾›äº†å¦ä¸€ç§ä½¿ç”¨ handler å¤„ç†æ¶ˆæ¯çš„æ–¹å¼ï¼Œåœ¨å®ä¾‹åŒ– Handler æ—¶å¯ä»¥ä½¿ç”¨Callback ï¼Œè€Œä¸æ˜¯è‡ªå·±å®ç°ä¸€ä¸ª handler å­ç±»ã€‚</li>
<li>å¯ä»¥åšä¸€äº›æ¶ˆæ¯è¿‡æ»¤ã€‚</li>
</ol>
<h3 id="Handler-å°ç»“"><a href="#Handler-å°ç»“" class="headerlink" title="Handler å°ç»“"></a>Handler å°ç»“</h3><p>Handler çš„å·¥ä½œä¸»è¦åŒ…å«<strong>æ¶ˆæ¯çš„å‘é€</strong>å’Œ<strong>æ¥æ”¶</strong>è¿‡ç¨‹ï¼ˆè¿˜æœ‰ä¸€ä¸ªã€Œåˆ†å‘è¿‡ç¨‹ã€ï¼‰ã€‚  </p>
<ul>
<li>æ¶ˆæ¯çš„å‘é€å¯ä»¥é€šè¿‡ post çš„ä¸€ç³»åˆ—æ–¹æ³•ä»¥åŠ send çš„ä¸€ç³»åˆ—æ–¹æ³•æ¥å®ç°ã€‚<ul>
<li>post ç³»åˆ—æ–¹æ³•æœ€ç»ˆæ˜¯é€šè¿‡ send çš„ä¸€ç³»åˆ—æ–¹æ³•æ¥å®ç°çš„ã€‚</li>
</ul>
</li>
</ul>
<p>æŸ¥çœ‹æºç ä¸éš¾å‘ç°ï¼ŒHandler çš„å‘é€æ¶ˆæ¯çš„è¿‡ç¨‹ä»…ä»…æ˜¯å‘ MessageQueue æ’å…¥äº†ä¸€æ¡ Messageï¼ŒMessageQueue çš„ next æ–¹æ³•å°±ä¼šè¿”å›æ­¤ Message ç»™ Looperï¼Œ Looper åœ¨ loop æ–¹æ³•ä¸­å¯¹ Message è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆç”± Looper äº¤å›ç»™ Handler å¤„ç†ï¼ˆè°ƒç”¨ Handler çš„ dispatchMessage æ–¹æ³•ï¼‰ã€‚</p>
<h2 id="æ•°é‡å…³ç³»"><a href="#æ•°é‡å…³ç³»" class="headerlink" title="æ•°é‡å…³ç³»"></a>æ•°é‡å…³ç³»</h2><p>ä¸€ä¸ªçº¿ç¨‹æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ª Looper ï¼Œä¸€ä¸ª MessageQueueï¼Œå¯ä»¥æœ‰å¤šä¸ª Handlerã€‚</p>
<p>MessageQueue å°è£…åœ¨ Looper ä¸­ã€‚</p>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><h3 id="ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸º-Looper-loop-é‡Œçš„æ­»å¾ªç¯å¡æ­»ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸º-Looper-loop-é‡Œçš„æ­»å¾ªç¯å¡æ­»ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸º Looper.loop()é‡Œçš„æ­»å¾ªç¯å¡æ­»ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸º Looper.loop()é‡Œçš„æ­»å¾ªç¯å¡æ­»ï¼Ÿ</h3><p>é˜»å¡æ˜¯æœ‰çš„ï¼Œä½†æ˜¯ä¸ä¼šå¡ä½<br>ä¸»è¦åŸå› æœ‰ 2 ä¸ªï¼š</p>
<h4 id="1-Linux-çš„-epoll-æœºåˆ¶"><a href="#1-Linux-çš„-epoll-æœºåˆ¶" class="headerlink" title="1.Linux çš„ epoll æœºåˆ¶"></a>1.Linux çš„ epoll æœºåˆ¶</h4><p>å½“<strong>æ²¡æœ‰æ¶ˆæ¯</strong>çš„æ—¶å€™ä¼š <strong>epoll.wait</strong>ï¼Œ<strong>ç­‰å¾…å¥æŸ„å†™çš„æ—¶å€™å†å”¤é†’</strong>ï¼Œè¿™ä¸ªæ—¶å€™å…¶å®æ˜¯é˜»å¡çš„ã€‚</p>
<h4 id="2-æ‰€æœ‰çš„-ui-æ“ä½œéƒ½é€šè¿‡-handler-æ¥å‘æ¶ˆæ¯æ“ä½œã€‚"><a href="#2-æ‰€æœ‰çš„-ui-æ“ä½œéƒ½é€šè¿‡-handler-æ¥å‘æ¶ˆæ¯æ“ä½œã€‚" class="headerlink" title="2.æ‰€æœ‰çš„ ui æ“ä½œéƒ½é€šè¿‡ handler æ¥å‘æ¶ˆæ¯æ“ä½œã€‚"></a>2.æ‰€æœ‰çš„ ui æ“ä½œéƒ½é€šè¿‡ handler æ¥å‘æ¶ˆæ¯æ“ä½œã€‚</h4><p>æ¯”å¦‚å±å¹•åˆ·æ–° 16ms ä¸€ä¸ªæ¶ˆæ¯ï¼Œä½ çš„å„ç§ç‚¹å‡»äº‹ä»¶ï¼Œå°±ä¼šæœ‰<strong>å¥æŸ„å†™æ“ä½œ</strong>ï¼Œ<strong>å”¤é†’ä¸Šæ–‡çš„ wait æ“ä½œ</strong>ï¼Œæ‰€ä»¥ä¸ä¼šè¢«å¡æ­»äº†ã€‚</p>
<h4 id="ä¸€ä¸ªæ¯”è¾ƒå½¢è±¡çš„æ¯”å–»ï¼š"><a href="#ä¸€ä¸ªæ¯”è¾ƒå½¢è±¡çš„æ¯”å–»ï¼š" class="headerlink" title="ä¸€ä¸ªæ¯”è¾ƒå½¢è±¡çš„æ¯”å–»ï¼š"></a>ä¸€ä¸ªæ¯”è¾ƒå½¢è±¡çš„æ¯”å–»ï¼š</h4><blockquote>
<p>  å°±åƒä¸€è¾†è½¦åœ¨åœ†å½¢èµ›è½¦é“ä¸Šè·‘ï¼Œä¸€è¾¹è·‘(ä¸€è¾¹æ‰§è¡Œä»»åŠ¡)ï¼Œæ¯”å¦‚å¼€åˆ°å¸‚ä¸­å¿ƒä¹°ç“¶æ°´ï¼Œä»»åŠ¡å®Œæˆåˆå›åˆ°åˆšåˆšç¦»å¼€çš„åœ°æ–¹ï¼Œç»§ç»­å„ç§æ‰§è¡Œä¹°æ°´çš„ä»»åŠ¡ï¼Œç›´åˆ°æ²¡æœ‰ä»»åŠ¡äº†ï¼ˆmsg ä¸ºç©ºï¼‰ï¼Œè¡Œäº†ï¼Œè·‘ä¸€åœˆå›åˆ°èµ·ç‚¹ã€‚ç¡è§‰ï¼ˆepoll_waitï¼‰ï¼Œæœ‰ä»»åŠ¡å«é†’ä½ ï¼ˆå”¤é†’ waitï¼‰ï¼Œä½ åˆå¼€å§‹è·‘ä¸€åœˆã€‚è¾¹è·‘è¾¹æ¥å•ã€‚</p>
</blockquote>
<p>æƒ³è¿›ä¸€æ­¥äº†è§£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹çŸ¥ä¹ä¸Šå¯¹è¯¥é—®é¢˜çš„<a href="https://www.zhihu.com/question/34652589" target="_blank" rel="noopener">è®¨è®º</a></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Looper å¯¹è±¡å°è£…äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒLooper å¯¹è±¡è¢«å°è£…åœ¨ ThreadLocal ä¸­ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„ Looper æ— æ³•å…±äº«ã€‚Handler é€šè¿‡ä¸ Looper ä¹‹é—´çš„ç»‘å®šæ¥å®ç°ä¸æ‰§è¡Œçº¿ç¨‹ä¹‹é—´çš„ç»‘å®šï¼Œhandler å‘é€æ¶ˆæ¯æ—¶ä¼šå°† Message å¯¹è±¡è¿½åŠ åˆ°ä¸çº¿ç¨‹ç›¸å…³çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åç”± Looper å›è°ƒå®ƒçš„åˆ†å‘æ¶ˆæ¯æ–¹æ³•ï¼Œæ ¹æ®æƒ…å†µå¤„ç†æ¶ˆæ¯ã€‚</p>
<p>æœ€åæˆ‘ä»¬çœ‹ä¸€å¼ å®Œæ•´çš„æµç¨‹å›¾ï¼ˆå›¾ç‰‡å‚è€ƒè‡ª<a href="http://www.jianshu.com/p/9fe944ee02f7" target="_blank" rel="noopener">Handler å¼‚æ­¥é€šä¿¡æœºåˆ¶å…¨é¢è§£æ</a>ï¼‰ï¼Œç¬”è€…ä¿®æ”¹äº†åŸå›¾ä¸­çš„ Handler dispatchMessage  æ–¹æ³•æè¿°ã€‚</p>
<p><img src="https://user-images.githubusercontent.com/16668676/29739304-0513811c-8a6d-11e7-8a78-510d3c98feb7.png" alt=""></p>
<h2 id="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"><a href="#å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è"></a>å‚è€ƒèµ„æ–™ä¸å­¦ä¹ èµ„æºæ¨è</h2><ul>
<li><a href="http://droidyue.com/blog/2016/03/13/learning-threadlocal-in-java/index.html" target="_blank" rel="noopener">ç†è§£ Java ä¸­çš„ ThreadLocal </a></li>
<li><a href="https://ivanljt.github.io/blog/2017/08/21/%E8%B0%88%E8%B0%88-ThreadLocal/#more" target="_blank" rel="noopener">è°ˆè°ˆ ThreadLocal</a></li>
<li><a href="http://blog.csdn.net/iispring/article/details/47115879" target="_blank" rel="noopener">Android ä¸­ Handler çš„ä½¿ç”¨</a></li>
<li><a href="http://www.jianshu.com/p/9fe944ee02f7" target="_blank" rel="noopener">Handler å¼‚æ­¥é€šä¿¡æœºåˆ¶å…¨é¢è§£æ</a></li>
<li><a href="http://blog.csdn.net/iispring/article/details/47180325" target="_blank" rel="noopener">æ·±å…¥æºç è§£æ Android ä¸­çš„ Handler,Message,MessageQueue,Looper</a></li>
<li><a href="https://github.com/xitu/gold-miner/blob/master/TODO/android-handler-internals.md" target="_blank" rel="noopener">æ¢ç´¢ Android å¤§æ€å™¨â€”â€” Handler</a></li>
<li>ã€ŠAndroid å¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹</li>
<li>ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹</li>
</ul>
<p>å¦‚æœæœ¬æ–‡ä¸­æœ‰ä¸æ­£ç¡®çš„ç»“è®ºã€è¯´æ³•æˆ–è€…è¡¨è¿°ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œæ³è¯·å¤§å®¶æŒ‡å‡ºï¼Œå…±åŒæ¢è®¨ï¼Œå…±åŒè¿›æ­¥ï¼Œè°¢è°¢!</p>
]]></content>
      
        <categories>
            
            <category> åŸç†åˆ†æ </category>
            
            <category> Android è¿›é˜¶ </category>
            
        </categories>
        
        
        <tags>
            
            <tag> åŸç†åˆ†æ </tag>
            
            <tag> Android è¿›é˜¶ </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
